<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>Java-Concurrent | Hexo</title>

  <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://cdn.jsdelivr.net/gh/inkss/fontawesome@5.15.3/css/all.min.css" rel="stylesheet">

  
    <script>
        var themeModelId = '';
        if (themeModelId) {
            localStorage.setItem('modelId', themeModelId);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/gh/yuang01/live2d-widget@latest/autoload.js"></script>
    <script>
        var live2dOpen = eval('true') || false;
        if (!live2dOpen) {
            localStorage.setItem('waifu-display', 1609323474481);
        }
    </script>
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    
<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 6.0.0"></head>

  
  <!-- ä¾èµ–äºjqueryå’Œvue -->
  <script src="/js/jquery3.5.1.js"></script>
  <script src="/js/vue2.6.11.js"></script>
  
  <body>
    <!-- é¢„åŠ è½½åŠ¨ç”» -->
    <!-- é¡µé¢é¢„åŠ è½½åŠ¨ç”» -->

    
    <!-- åˆ¤æ–­æ˜¯å¦ä¸ºæš—é»‘é£æ ¼ -->
    <!-- åˆ¤æ–­æ˜¯å¦ä¸ºé»‘å¤œæ¨¡å¼ -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- å¤´éƒ¨å¯¼èˆªç­‰ -->
    
<header class="header " id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="logo">
      <h3 class="drawer-box-head_title">Hexo</h3>
      <h5 class="drawer-box-head_desc"></h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">é¦–é¡µ</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">å½’æ¡£</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">æ ‡ç­¾</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">åˆ†ç±»</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/about" class="drawer-menu-item-link">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">å…³äº</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                  <span class="name">å‹æƒ…é“¾æ¥</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="javascript:;" class="drawer-menu-item-link has-children" @click="openOrCloseMenu(6)">
                  <span>
                    
                    <span class="name">ğŸ±æ›´å¤š</span>
                  </span>
                  <i class="fas fa-chevron-left arrow " :class="{'icon-rotate': isOpen(6)}" aria-hidden="true"></i>
                </a>
                <ul class="drawer-sub-menu" v-if="isOpen(6)">
                  
                  <li>
                    <a href="/gallery">
                      
                      <span>ğŸ“·å›¾åº“</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/me">
                      
                      <span>ğŸ§’ğŸ»å…³äºæˆ‘</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://github.com/ctrl-github">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // é˜²æ­¢é¡µé¢æ»šåŠ¨ï¼Œåªèƒ½è®©å¼¹æ¡†æ»šåŠ¨
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="logo">
        </div>
      
      <a href="/" class="logo">Hexo</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="é¦–é¡µ">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">é¦–é¡µ</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="å½’æ¡£">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">å½’æ¡£</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="æ ‡ç­¾">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">æ ‡ç­¾</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="åˆ†ç±»">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">åˆ†ç±»</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/about" class="menu-item-link" title="å…³äº">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">å…³äº</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link" title="å‹æƒ…é“¾æ¥">
                  
                  <span class="name">å‹æƒ…é“¾æ¥</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="javascript:;" class="menu-item-link" title="ğŸ±æ›´å¤š">
                  
                  <span class="name">ğŸ±æ›´å¤š</span>
                  <i class="fas fa-chevron-down arrow" aria-hidden="true"></i>
                </a>
                <ul class="sub-menu">
                  
                  <li>
                    <a href="/gallery">
                      
                      <span>ğŸ“·å›¾åº“</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/me">
                      
                      <span>ğŸ§’ğŸ»å…³äºæˆ‘</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">æœ¬åœ°æœç´¢</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="è¯·è¾“å…¥å…³é”®å­—"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // é˜²æ­¢é¡µé¢æ»šåŠ¨ï¼Œåªèƒ½è®©å¼¹æ¡†æ»šåŠ¨
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- è§£å†³åˆ·æ–°é¡µé¢é—ªçƒé—®é¢˜ï¼Œå¯ä»¥åœ¨å…ƒç´ ä¸Šæ·»åŠ display: none, æˆ–è€…ç”¨vue.extendæ–¹æ³•ï¼Œè¯¦æƒ…ï¼šhttps://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- ä¸‹é¢æ˜¯æœç´¢åŸºæœ¬å†™æ³• -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://github.com/ctrl-github" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    

    <!-- å½“å¤´éƒ¨å¯¼èˆªè®¾ç½®ä¸ºèƒŒæ™¯é€æ˜çš„æ—¶å€™  -->
    
      <script src="/js/header/index.js" data-pjax></script>
    
</header>

    <!-- éœ€è¦åœ¨ä¸Šé¢åŠ è½½çš„js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (href, before, media, attributes) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- è½®æ’­å›¾æ‰€éœ€è¦çš„js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- é¦–é¡µçš„å…¬å‘Šæ»šåŠ¨æ’ä»¶çš„jséœ€è¦é‡æ–°åŠ è½½ -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- æ‰“å­—æœºæ•ˆæœjs -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>


    <!-- å†…å®¹åŒºåŸŸ -->
    <div id="safearea">
      <main class="main" id="pjax-container" style="margin-top: 0;">
        
 <!-- prismjs ä»£ç é«˜äº® -->
 
    
    <link href="/js/prism/prism-line-numbers.css" rel="stylesheet">
    
        <link href="/js/prism/prism.min.css" rel="stylesheet">
    

    <style>
        pre[class*="language-"] {
            overflow-y: hidden;
        }
        .line-numbers .line-numbers-rows {
            border: none;
        }
    </style>
  


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>

<!-- æ–‡ç« è¯¦æƒ…é¡µé¡¶éƒ¨å›¾ç‰‡å’Œæ ‡é¢˜ -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('/medias/7.jpg')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        Java-Concurrent
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> å‘è¡¨äºï¼š2022-11-23 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> åˆ†ç±»ï¼š
          
            <a href="/categories/Java-Concurrent/" class="post-detail-header_category">
              Java-Concurrent
            </a>
          
        </span>
      

      
        <div class="post-detail-header_wordcount">
          <span class="totalcount">
            <i class="fas fa-file-text-o"></i> å­—æ•°ç»Ÿè®¡: 95.7k |
          </span>
  
          <span class="min2read">
            <i class="fas fa-clock"></i> é˜…è¯»æ—¶é•¿: 380åˆ†é’Ÿ |
          </span>
  
          
            <span class="reading">
              <i class="fas fa-eye"></i> é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>
            </span>
          
        </div>
      
    
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>



<div class="row justify-position">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <h1 id="Javaå¹¶å‘ç¼–ç¨‹"><a href="#Javaå¹¶å‘ç¼–ç¨‹" class="headerlink" title="Javaå¹¶å‘ç¼–ç¨‹"></a>Javaå¹¶å‘ç¼–ç¨‹</h1><h1 id="çº¿ç¨‹å¹¶å‘åŸºç¡€"><a href="#çº¿ç¨‹å¹¶å‘åŸºç¡€" class="headerlink" title="çº¿ç¨‹å¹¶å‘åŸºç¡€"></a>çº¿ç¨‹å¹¶å‘åŸºç¡€</h1><h2 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><h3 id="CPUæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»"><a href="#CPUæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»" class="headerlink" title="CPUæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»"></a>CPUæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»</h3><p>æ ¸å¿ƒæ•°:çº¿ç¨‹æ•°&#x3D;1:1 ;ä½¿ç”¨äº†è¶…çº¿ç¨‹æŠ€æœ¯åâ€”&gt; 1:2</p>
<h3 id="CPUæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶"><a href="#CPUæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶" class="headerlink" title="CPUæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶"></a>CPUæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶</h3><p>åˆç§°RRè°ƒåº¦ï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<blockquote>
<h3 id="æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶-RR-è°ƒåº¦"><a href="#æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶-RR-è°ƒåº¦" class="headerlink" title="æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶(RR è°ƒåº¦)"></a>æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶(RR è°ƒåº¦)</h3><p>æ—¶é—´ç‰‡è½®è½¬æ³•ï¼ˆRound-Robinï¼ŒRRï¼‰ä¸»è¦ç”¨äºåˆ†æ—¶ç³»ç»Ÿä¸­çš„è¿›ç¨‹è°ƒåº¦ã€‚ä¸ºäº†å®ç°è½®è½¬è°ƒåº¦ï¼Œç³»ç»ŸæŠŠæ‰€æœ‰å°±ç»ªè¿›ç¨‹æŒ‰å…ˆå…¥å…ˆå‡ºçš„åŸåˆ™æ’æˆä¸€ä¸ªé˜Ÿåˆ—ã€‚æ–°æ¥çš„è¿›ç¨‹åŠ åˆ°å°±ç»ªé˜Ÿåˆ—æœ«å°¾ã€‚æ¯å½“æ‰§è¡Œè¿›ç¨‹è°ƒåº¦æ—¶ï¼Œè¿›ç¨‹è°ƒåº¦ç¨‹åºæ€»æ˜¯é€‰å‡ºå°±ç»ªé˜Ÿåˆ—çš„é˜Ÿé¦–è¿›ç¨‹ï¼Œè®©å®ƒåœ¨ CPU ä¸Šè¿è¡Œä¸€ä¸ªæ—¶é—´ç‰‡çš„æ—¶é—´ã€‚æ—¶é—´ç‰‡æ˜¯ä¸€ä¸ªå°çš„æ—¶é—´å•ä½ï¼Œé€šå¸¸ä¸º 10~100ms æ•°é‡çº§ã€‚å½“è¿›ç¨‹ç”¨å®Œåˆ†ç»™å®ƒçš„æ—¶é—´ç‰‡åï¼Œç³»ç»Ÿçš„è®¡æ—¶å™¨å‘å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œè°ƒåº¦ç¨‹åºä¾¿åœæ­¢è¯¥è¿›ç¨‹çš„è¿è¡Œï¼ŒæŠŠå®ƒæ”¾å…¥å°±ç»ªé˜Ÿåˆ—çš„æœ«å°¾ï¼›ç„¶åï¼ŒæŠŠ CPU åˆ†ç»™å°±ç»ªé˜Ÿåˆ—çš„é˜Ÿé¦–è¿›ç¨‹ï¼ŒåŒæ ·ä¹Ÿè®©å®ƒè¿è¡Œä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œå¦‚æ­¤å¾€å¤ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%97%B6%E9%97%B4%E7%89%87%E8%BD%AE%E8%BD%AC%E8%B0%83%E5%BA%A6/3059054">æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦</a>æ˜¯ä¸€ç§æœ€å¤è€ï¼Œæœ€ç®€å•ï¼Œæœ€å…¬å¹³ä¸”ä½¿ç”¨æœ€å¹¿çš„ç®—æ³•ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€æ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ï¼Œå³è¯¥è¿›ç¨‹å…è®¸è¿è¡Œçš„æ—¶é—´ã€‚</p>
<p>æ—¶é—´ç‰‡è®¾å¾—å¤ªçŸ­ä¼šå¯¼è‡´è¿‡å¤šçš„è¿›ç¨‹åˆ‡æ¢ï¼Œé™ä½äº†CPUæ•ˆç‡ï¼›è€Œè®¾å¾—å¤ªé•¿åˆå¯èƒ½å¼•èµ·å¯¹çŸ­çš„äº¤äº’è¯·æ±‚çš„å“åº”å˜å·®ã€‚å°†æ—¶é—´ç‰‡è®¾ä¸º100æ¯«ç§’é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æŠ˜ä¸­ã€‚</p>
</blockquote>
<h3 id="ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹"><a href="#ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹"></a>ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹</h3><p>è¿›ç¨‹ï¼šç¨‹åºè¿è¡Œèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œè¿›ç¨‹å†…éƒ¨æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä¼šå…±äº«è¿™ä¸ªè¿›ç¨‹çš„èµ„æº</p>
<p>çº¿ç¨‹ï¼šCPUè°ƒåº¦çš„æœ€å°å•ä½ï¼Œå¿…é¡»ä¾èµ–è¿›ç¨‹è€Œå­˜åœ¨ã€‚</p>
<h3 id="æ¾„æ¸…å¹¶è¡Œå’Œå¹¶å‘"><a href="#æ¾„æ¸…å¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="æ¾„æ¸…å¹¶è¡Œå’Œå¹¶å‘"></a>æ¾„æ¸…å¹¶è¡Œå’Œå¹¶å‘</h3><p>å¹¶è¡Œï¼šåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥åŒæ—¶å¤„ç†äº‹æƒ…çš„èƒ½åŠ›</p>
<p>å¹¶å‘ï¼šä¸å•ä½æ—¶é—´ç›¸å…³ï¼Œåœ¨å•ä½æ—¶é—´å†…å¯ä»¥å¤„ç†äº‹æƒ…çš„èƒ½åŠ›</p>
<h3 id="é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰ã€å¥½å¤„å’Œæ³¨æ„äº‹é¡¹"><a href="#é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰ã€å¥½å¤„å’Œæ³¨æ„äº‹é¡¹" class="headerlink" title="é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰ã€å¥½å¤„å’Œæ³¨æ„äº‹é¡¹"></a>é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰ã€å¥½å¤„å’Œæ³¨æ„äº‹é¡¹</h3><p>å¥½å¤„ï¼šå……åˆ†åˆ©ç”¨cpuçš„èµ„æºã€åŠ å¿«ç”¨æˆ·å“åº”çš„æ—¶é—´ï¼Œç¨‹åºæ¨¡å—åŒ–ï¼Œå¼‚æ­¥åŒ–</p>
<p>é—®é¢˜ï¼š</p>
<p>çº¿ç¨‹å…±äº«èµ„æºï¼Œå­˜åœ¨å†²çªï¼›</p>
<p>å®¹æ˜“å¯¼è‡´æ­»é”ï¼›</p>
<p>å¯ç”¨å¤ªå¤šçš„çº¿ç¨‹ï¼Œå°±æœ‰æå®æœºå™¨çš„å¯èƒ½</p>
<h2 id="è®¤è¯†Javaé‡Œé¢çš„Thread"><a href="#è®¤è¯†Javaé‡Œé¢çš„Thread" class="headerlink" title="è®¤è¯†Javaé‡Œé¢çš„Thread"></a>è®¤è¯†Javaé‡Œé¢çš„Thread</h2><h3 id="Javaé‡Œçš„ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„"><a href="#Javaé‡Œçš„ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„" class="headerlink" title="Javaé‡Œçš„ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„"></a><strong>Javaé‡Œçš„ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„</strong></h3><h4 id="No1-OnlyMain-java"><a href="#No1-OnlyMain-java" class="headerlink" title="No1_OnlyMain.java"></a>No1_OnlyMain.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ManagementFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ThreadInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ThreadMXBean</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ctrl
 * javaçš„å¤šçº¿ç¨‹æ— å¤„ä¸åœ¨
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnlyMain</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// è·å– Java çº¿ç¨‹ç®¡ç† MXBean è™šæ‹Ÿæœºçº¿ç¨‹ç®¡ç†çš„æ¥å£</span>
        <span class="token class-name">ThreadMXBean</span> threadMXBean <span class="token operator">=</span> <span class="token class-name">ManagementFactory</span><span class="token punctuation">.</span><span class="token function">getThreadMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸éœ€è¦è·å–åŒæ­¥çš„ monitor å’Œ synchronizer ä¿¡æ¯ï¼Œä»…è·å–çº¿ç¨‹å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯</span>
        <span class="token class-name">ThreadInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> threadInfos <span class="token operator">=</span> threadMXBean<span class="token punctuation">.</span><span class="token function">dumpAllThreads</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// éå†çº¿ç¨‹ä¿¡æ¯ï¼Œä»…æ‰“å°çº¿ç¨‹ ID å’Œçº¿ç¨‹åç§°ä¿¡æ¯</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ThreadInfo</span> threadInfo <span class="token operator">:</span> threadInfos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"["</span> <span class="token operator">+</span> threadInfo<span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> threadInfo<span class="token punctuation">.</span><span class="token function">getThreadName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šè¿°ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼ˆè¾“å‡ºå†…å®¹å¯èƒ½ä¸åŒï¼Œä¸ç”¨å¤ªçº ç»“ä¸‹é¢æ¯ä¸ªçº¿ç¨‹çš„ä½œç”¨ï¼Œåªç”¨çŸ¥é“ main çº¿ç¨‹æ‰§è¡Œ main æ–¹æ³•å³å¯ï¼‰ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//[6] Monitor Ctrl-Break //ç›‘å¬ä¸­æ–­</span>
<span class="token comment">//[5] Attach Listener //æ·»åŠ äº‹ä»¶</span>
<span class="token comment">//[4] Signal Dispatcher // åˆ†å‘å¤„ç†ç»™ JVM ä¿¡å·çš„çº¿ç¨‹</span>
<span class="token comment">//[3] Finalizer //è°ƒç”¨å¯¹è±¡ finalize æ–¹æ³•çš„çº¿ç¨‹</span>
<span class="token comment">//[2] Reference Handler //æ¸…é™¤ reference çº¿ç¨‹</span>
<span class="token comment">//[1] main //main çº¿ç¨‹,ç¨‹åºå…¥å£</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p> <strong>ä»ä¸Šé¢çš„è¾“å‡ºå†…å®¹å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ª Java ç¨‹åºçš„è¿è¡Œæ˜¯ main çº¿ç¨‹å’Œå¤šä¸ªå…¶ä»–çº¿ç¨‹åŒæ—¶è¿è¡Œã€‚</strong></p>
</blockquote>
<h3 id="çº¿ç¨‹ç®€å•å®ç°çš„ä¸‰ç§æ–¹æ³•"><a href="#çº¿ç¨‹ç®€å•å®ç°çš„ä¸‰ç§æ–¹æ³•" class="headerlink" title="çº¿ç¨‹ç®€å•å®ç°çš„ä¸‰ç§æ–¹æ³•"></a>çº¿ç¨‹ç®€å•å®ç°çš„ä¸‰ç§æ–¹æ³•</h3><p>â€‹        çº¿ç¨‹æ˜¯ç¨‹åºä¸­çš„æ‰§è¡Œçº¿ç¨‹ã€‚Java è™šæ‹Ÿæœºå…è®¸åº”ç”¨ç¨‹åºå¹¶å‘åœ°è¿è¡Œå¤šä¸ªæ‰§è¡Œçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§çº¿ç¨‹çš„æ‰§è¡Œä¼˜å…ˆäºä½ä¼˜å…ˆçº§çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æˆ–ä¸å¯ä»¥æ ‡è®°ä¸ºä¸€ä¸ªå®ˆæŠ¤ç¨‹åºã€‚å½“æŸä¸ªçº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç åˆ›å»ºä¸€ä¸ªæ–°Threadå¯¹è±¡æ—¶ï¼Œè¯¥æ–°çº¿ç¨‹çš„åˆå§‹ä¼˜å…ˆçº§è¢«è®¾å®šä¸ºåˆ›å»ºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”å½“ä¸”ä»…å½“åˆ›å»ºçº¿ç¨‹æ˜¯å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œæ–°çº¿ç¨‹æ‰æ˜¯å®ˆæŠ¤ç¨‹åºã€‚å½“Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œé€šå¸¸éƒ½ä¼šæœ‰å•ä¸ªéå®ˆæŠ¤çº¿ç¨‹ï¼ˆå®ƒé€šå¸¸ä¼šè°ƒç”¨æŸä¸ªæŒ‡å®šç±»çš„ mainæ–¹æ³•)ã€‚Javaè™šæ‹Ÿæœºä¼šç»§ç»­æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°ä¸‹åˆ—ä»»ä¸€æƒ…å†µå‡ºç°æ—¶ä¸ºæ­¢:è°ƒç”¨äº† Runtimeç±»çš„ exitæ–¹æ³•ï¼Œå¹¶ä¸”å®‰å…¨ç®¡ç†å™¨å…è®¸é€€å‡ºæ“ä½œå‘ç”Ÿã€‚éå®ˆæŠ¤çº¿ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½å·²åœæ­¢è¿è¡Œï¼Œæ— è®ºæ˜¯é€šè¿‡ä»å¯¹runæ–¹æ³•çš„è°ƒç”¨ä¸­è¿”å›ï¼Œè¿˜æ˜¯é€šè¿‡æŠ›å‡ºä¸€ä¸ªä¼ æ’­åˆ° runæ–¹æ³•ä¹‹å¤–çš„å¼‚å¸¸ã€‚</p>
<p>ä¸‰ç§</p>
<ul>
<li>ç±»Thread</li>
<li>æ¥å£Runnable</li>
<li>æ¥å£Callable</li>
</ul>
<h4 id="No2-CreateThread-java"><a href="#No2-CreateThread-java" class="headerlink" title="No2_CreateThread.java"></a>No2_CreateThread.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Callable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">FutureTask</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ctrl
 * javaæ–°å¯çº¿ç¨‹çš„æ–¹å¼
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_CreateThread</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/*æ‰©å±•è‡ªThreadç±»*/</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"I am extends Thread!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*å®ç°Runnableæ¥å£*/</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"I am implements Runnable!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/*å®ç°Callableæ¥å£ï¼Œå…è®¸æœ‰è¿”å›å€¼*/</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyCallable</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"I am implements Callable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"CallResult"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//çº¿ç¨‹æ˜¯ç¨‹åºä¸­æ‰§è¡Œçš„çº¿ç¨‹ã€‚</span>
    <span class="token comment">//Javaè™šæ‹Ÿæœºå…è®¸åº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªæ‰§è¡Œçº¿ç¨‹ã€‚</span>
    <span class="token comment">//æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¼˜å…ˆæƒã€‚</span>
    <span class="token comment">//å…·æœ‰è¾ƒé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¼˜å…ˆäºä¼˜å…ˆçº§è¾ƒä½çš„çº¿ç¨‹æ‰§è¡Œã€‚ æ¯ä¸ªçº¿ç¨‹å¯èƒ½ä¹Ÿå¯èƒ½ä¸ä¼šè¢«æ ‡è®°ä¸ºå®ˆæŠ¤ç¨‹åºã€‚</span>
    <span class="token comment">//å½“åœ¨æŸä¸ªçº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç åˆ›å»ºä¸€ä¸ªæ–°çš„Threadå¯¹è±¡æ—¶ï¼Œæ–°çº¿ç¨‹çš„ä¼˜å…ˆçº§æœ€åˆè®¾ç½®ä¸ºç­‰äºåˆ›å»ºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”å½“ä¸”ä»…å½“åˆ›å»ºçº¿ç¨‹æ˜¯å®ˆæŠ¤è¿›ç¨‹æ—¶æ‰æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</span>

    <span class="token comment">//å½“Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œé€šå¸¸æœ‰ä¸€ä¸ªéå®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹ï¼ˆé€šå¸¸è°ƒç”¨æŸäº›æŒ‡å®šç±»çš„åä¸ºmainçš„æ–¹æ³•ï¼‰ã€‚</span>
    <span class="token comment">//Javaè™šæ‹Ÿæœºå°†ç»§ç»­æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š</span>
    <span class="token comment">// - å·²ç»è°ƒç”¨äº†Runtimeç±»çš„exitæ–¹æ³•ï¼Œå¹¶ä¸”å®‰å…¨ç®¡ç†å™¨å·²ç»å…è®¸è¿›è¡Œé€€å‡ºæ“ä½œã€‚</span>
    <span class="token comment">// - æ‰€æœ‰ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹çº¿ç¨‹çš„çº¿ç¨‹éƒ½å·²ç»æ­»äº¡ï¼Œæ— è®ºæ˜¯ä»è°ƒç”¨è¿”å›åˆ°runæ–¹æ³•è¿˜æ˜¯æŠ›å‡ºè¶…å‡ºrunæ–¹æ³•çš„run</span>

    <span class="token comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ‰§è¡Œçº¿ç¨‹æœ‰ä¸¤ç§æ–¹æ³•ã€‚ ä¸€ä¸ªæ˜¯å°†ä¸€ä¸ªç±»å£°æ˜ä¸ºThreadçš„å­ç±»ã€‚ è¿™ä¸ªå­ç±»åº”è¯¥é‡å†™runç±»çš„æ–¹æ³•Thread ã€‚ ç„¶åå¯ä»¥åˆ†é…å¹¶å¯åŠ¨å­ç±»çš„å®ä¾‹ã€‚</span>
    <span class="token comment">//å¦ä¸€ç§æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯å£°æ˜å®ç°ç±»Runnableæ¥å£ã€‚ é‚£ä¸ªç±»ç„¶åå®ç°äº†runæ–¹æ³•ã€‚ ç„¶åå¯ä»¥åˆ†é…ç±»çš„å®ä¾‹ï¼Œåœ¨åˆ›å»ºThreadæ—¶ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå¹¶å¯åŠ¨</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//start() å¯¼è‡´è¯¥çº¿ç¨‹å¼€å§‹æ‰§è¡Œ;Javaè™šæ‹Ÿæœºè°ƒç”¨è¯¥çº¿ç¨‹çš„runæ–¹æ³•ã€‚</span>
        <span class="token comment">//ç»“æœæ˜¯ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘è¿è¡Œ:å½“å‰çº¿ç¨‹(ä»è°ƒç”¨startæ–¹æ³•è¿”å›)å’Œå¦ä¸€ä¸ªçº¿ç¨‹(æ‰§è¡Œå®ƒçš„runæ–¹æ³•)ã€‚</span>
        <span class="token comment">//å¤šæ¬¡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸åˆæ³•çš„ã€‚ç‰¹åˆ«æ˜¯ï¼Œçº¿ç¨‹ä¸€æ—¦å®Œæˆæ‰§è¡Œï¼Œå°±ä¸èƒ½é‡æ–°å¯åŠ¨ã€‚</span>
        <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello Lambda!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MyCallable</span> useCallable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCallable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>useCallable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Thread-é‡Œé¢çš„å±æ€§å’Œæ–¹æ³•"><a href="#Thread-é‡Œé¢çš„å±æ€§å’Œæ–¹æ³•" class="headerlink" title="Thread é‡Œé¢çš„å±æ€§å’Œæ–¹æ³•"></a>Thread é‡Œé¢çš„å±æ€§å’Œæ–¹æ³•</h3><p>ç¬¬ä¸€æ­¥:å…ˆçœ‹ä¸€ä¸‹ Threadçš„APIæœ‰å“ªäº›å¸¸ç”¨çš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾å‡ ä¸ªæ–¹æ³•åšä¸€ä¸‹æµ‹è¯•ã€‚ã€‚<br>æ„é€ æ–¹æ³•å¸¸ç”¨çš„æœ‰:</p>
<p>1ã€Thread() åˆ†é…æ–°çš„Threadå¯¹è±¡ã€‚<br>2ã€Thread(Runnable target) åˆ†é…æ–°çš„ Threadå¯¹è±¡ã€‚<br>3ã€Thread(Runnable target,String name) åˆ†é…æ–°çš„ Threadå¯¹è±¡ã€‚<br>4ã€Thread(String name) åˆ†é…æ–°çš„ Threadå¯¹è±¡ã€‚<br>5ã€Thread(ThreadGroup group, String name) åˆ†é…æ–°çš„Threadå¯¹è±¡ã€‚</p>
<p>ä¸»è¦çš„æ–¹æ³•æœ‰å¦‚ä¸‹è¡¨æ‰€ç¤º:</p>
<p><img src="/image/Concurrent/Concurrent0.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent0.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p><img src="/image/Concurrent/Concurrent1.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent1.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<blockquote>
<p><strong>å•ç‹¬è¯´ä¸€ä¸‹çº¿ç¨‹çš„ä¼˜å…ˆçº§:å¯ä»¥è°ƒç”¨ Threadç±»çš„æ–¹æ³• getPriority() å’Œ setPriority()æ¥å­˜å–çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚çº¿ç¨‹çš„ä¼˜å…ˆçº§ä»£è¡¨è¯¥çº¿ç¨‹çš„é‡è¦ç¨‹åº¦ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¤„äºå¯æ‰§è¡ŒçŠ¶æ€å¹¶ç­‰å¾…è·å¾—CPUæ—¶é—´æ—¶ï¼Œçº¿ç¨‹è°ƒåº¦ç³»ç»Ÿæ ¹æ®å„ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§æ¥å†³å®šç»™è°åˆ†é… CPUæ—¶é—´ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹æœ‰æ›´å¤§çš„æœºä¼šè·å¾—CPU æ—¶é—´ï¼Œä¼˜å…ˆçº§ä½çš„çº¿ç¨‹ä¹Ÿä¸æ˜¯æ²¡æœ‰æœºä¼šï¼Œåªæ˜¯æœºä¼šè¦å°ä¸€äº›ç½¢äº†ã€‚ä½ å¯ä»¥è°ƒç”¨Threadç±»çš„æ–¹æ³• getPriority()å’ŒsetPriority()æ¥å­˜å–çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œçº¿ç¨‹çš„ä¼˜å…ˆçº§ç•Œäº1(MIN_PRIORITY)å’Œ 10(MAX_PRIORITY)ä¹‹é—´,ç¼ºçœæ˜¯5(NORM_PRIORITY).</strong></p>
</blockquote>
<p>ç¬¬äºŒæ­¥:æˆ‘ä»¬æ–°å»º5ä¸ªçº¿ç¨‹å®ä¾‹æ¥ä½“ä¼šä¸€ä¸‹å„ä¸ªçº¿ç¨‹çš„å±æ€§:</p>
<h4 id="No3-Thread-PropertiesAndMethods-java"><a href="#No3-Thread-PropertiesAndMethods-java" class="headerlink" title="No3_Thread_PropertiesAndMethods.java"></a>No3_Thread_PropertiesAndMethods.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_Thread_PropertiesAndMethods</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Thread_PropertiesAndMethods</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//æ¨¡æ‹Ÿåšäº‹æƒ…æ‰§è¡Œäº†30s,ä»¥ä¾¿ä¸€ä¼šæˆ‘ä»¬çš„ç›‘æ§å·¥å…·ç›‘æ§åˆ°!</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">Thread</span> currentThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> currentThreadName <span class="token operator">=</span> currentThread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯çº¿ç¨‹çš„åç§°:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›å½“å‰çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®:"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"çš„æ ‡è¯†ç¬¦:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"çš„ä¼˜å…ˆçº§:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹ "</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"çš„çŠ¶æ€:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"æ‰€å±çš„çº¿ç¨‹ç»„:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æµ‹è¯•çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æµ‹è¯•çº¿ç¨‹"</span> <span class="token operator">+</span> currentThreadName <span class="token operator">+</span> <span class="token string">"æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹:"</span> <span class="token operator">+</span> currentThread<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread_PropertiesAndMethods</span> threadb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread_PropertiesAndMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadb<span class="token punctuation">,</span> <span class="token string">"çº¿ç¨‹åç§°:("</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//è¿”å›å¯¹å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚æ­¤å¤„è·å¾—æˆ‘ä»¬çš„ä¸»çº¿ç¨‹</span>
        <span class="token class-name">Thread</span> threadMain <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯ä¸»çº¿ç¨‹:threadMain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®:"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹çš„åç§°:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹çš„æ ‡è¯†ç¬¦:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›çº¿ç¨‹çš„ä¼˜å…ˆçº§:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹çš„çŠ¶æ€:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è¿”å›è¯¥çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹ç»„:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹:"</span> <span class="token operator">+</span> threadMain<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¼‘æ¯10sä»¥ä¾¿æˆ‘ä»¬çš„ç›‘æ§å·¥å…·èƒ½ç›‘æ§åˆ°</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰“å°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">è¿™æ˜¯ä¸»çº¿ç¨‹<span class="token operator">:</span>threadMain
è¿”å›å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
ä¸»çº¿ç¨‹çš„åç§°<span class="token operator">:</span>main
è¿”å›è¯¥çº¿ç¨‹çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">1</span>
è¿”å›çº¿ç¨‹çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›è¯¥çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">true</span>
è¿™æ˜¯çº¿ç¨‹çš„åç§°<span class="token operator">:</span>çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
è¿™æ˜¯çº¿ç¨‹çš„åç§°<span class="token operator">:</span>çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
è¿™æ˜¯çº¿ç¨‹çš„åç§°<span class="token operator">:</span>çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
è¿™æ˜¯çº¿ç¨‹çš„åç§°<span class="token operator">:</span>çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
è¿™æ˜¯çº¿ç¨‹çš„åç§°<span class="token operator">:</span>çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
è¿”å›å½“å‰çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
è¿”å›å½“å‰çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">12</span>
è¿”å›å½“å‰çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
è¿”å›å½“å‰çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">14</span>
è¿”å›çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">15</span>
è¿”å›çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹ çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">16</span>
è¿”å›çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹ çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›å½“å‰çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>çš„çº¿ç¨‹ç»„ä¸­æ´»åŠ¨çº¿ç¨‹çš„æ•°ç›®<span class="token operator">:</span><span class="token number">7</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>çš„æ ‡è¯†ç¬¦<span class="token operator">:</span><span class="token number">13</span>
è¿”å›çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>çš„ä¼˜å…ˆçº§<span class="token operator">:</span><span class="token number">5</span>
è¿”å›è¯¥çº¿ç¨‹ çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€<span class="token operator">:</span><span class="token boolean">true</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">false</span>
è¿”å›è¯¥çº¿ç¨‹ çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€<span class="token operator">:</span><span class="token boolean">true</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">false</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€<span class="token operator">:</span><span class="token boolean">true</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">false</span>
è¿”å›è¯¥çº¿ç¨‹ çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>çš„çŠ¶æ€<span class="token operator">:</span>RUNNABLE
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
è¿”å›è¯¥çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>æ‰€å±çš„çº¿ç¨‹ç»„<span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ThreadGroup</span><span class="token punctuation">[</span>name<span class="token operator">=</span>main<span class="token punctuation">,</span>maxpri<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">]</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€<span class="token operator">:</span><span class="token boolean">true</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">false</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€<span class="token operator">:</span><span class="token boolean">true</span>
æµ‹è¯•çº¿ç¨‹çº¿ç¨‹åç§°<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>æ˜¯å¦æµ‹è¯•è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹<span class="token operator">:</span><span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>ç¬¬ä¸‰æ­¥ï¼Œçœ‹ä¸€ä¸‹æˆ‘ä»¬ç›‘æ§çš„ç»“æœï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†æ—¶é—´æˆ³ä¼šçœ‹åˆ°ä¸åŒçš„ç›‘æ§ç»“æœã€‚<br>åœ¨ä¸Šé¢5ä¸ªçº¿ç¨‹å’Œä¸€ä¸ªmainä¸»çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸»çº¿ç¨‹å…ˆäºå¦å¤–5ä¸ªçº¿ç¨‹å…ˆç»“æŸäº†,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå¤§å®¶ä»”ç»†çœ‹çœ‹ä»£ç å°±èƒ½ä½“ä¼šå‡ºæ¥äº†ï¼Œè¿™æ˜¯æ—¶é—´ä¸Šæ§åˆ¶çš„ï¼Œè¿™é‡Œå…ˆæœ‰ä¸ªå°è±¡ï¼Œåé¢ä¼šè®²çº¿ç¨‹çš„å…·ä½“ç›‘æ§æ–¹æ³•ã€‚</p>
<p><img src="/image/Concurrent/Concurrent2.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent2.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>Threadä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹å¦‚ä¸‹:<br>(1ï¼‰å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹çš„æ—¶å€™ï¼Œä¸€å®šè¦ç»™å®ƒä¸€ä¸ªåå­—,é€šè¿‡ä¸Šé¢çš„å›¾æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼Œæ–¹ä¾¿æˆ‘ä»¬è·Ÿè¸ªè§‚å¯Ÿçº¿ç¨‹ï¼Œå¯¹å·å…¥åº§ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚å¦åˆ™ç›‘æ§çš„æ—¶å€™å°±æ²¡æœ‰åŠæ³•å¾ˆç›´è§‚åœ°çŸ¥é“æŸä¸ªçº¿ç¨‹çš„ç”¨é€”ã€‚<br>(2ï¼‰éœ€è¦æ³¨æ„çš„æ˜¯,<code>thread.stop()</code>ï¼Œ<code>thread.resume()</code>,<code>thread.suspend()</code>å·²ç»è¢«åºŸé™¤ã€ä¸å»ºè®®ä½¿ç”¨ï¼Œ<code>thread.stop()</code>ä¼šå¯¼è‡´çº¿ç¨‹ä¸ä¼šæ­£ç¡®é‡Šæ”¾èµ„æºï¼Œ<code>thread.suspend()</code>å®¹æ˜“å¯¼è‡´æ­»é”ã€‚å»ºè®®ä½¿ç”¨ä¿¡å·é‡ï¼ˆå…±äº«å˜é‡)æˆ–interruptæ–¹æ³•æ¥ä»£æ›¿stopæ–¹æ³•ç­‰ã€‚<br>(3ï¼‰mainæ–¹æ³•ä¸»çº¿ç¨‹ç»“æŸäº†,æ–°å¼€å¯çš„å­çº¿ç¨‹ä¸ä¸€å®šç»“æŸã€‚</p>
<blockquote>
<p><strong>å®ˆæŠ¤çº¿ç¨‹</strong></p>
<p>å’Œä¸»çº¿ç¨‹å…±æ­»ï¼Œfinallyä¸èƒ½ä¿è¯ä¸€å®šæ‰§è¡Œ</p>
</blockquote>
<h3 id="å…³äºçº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶"><a href="#å…³äºçº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶" class="headerlink" title="å…³äºçº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶"></a>å…³äºçº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶</h3><p><strong>æ€ä¹ˆæ ·æ‰èƒ½è®©Javaé‡Œçš„çº¿ç¨‹å®‰å…¨åœæ­¢å·¥ä½œå‘¢</strong></p>
<p>çº¿ç¨‹è‡ªç„¶ç»ˆæ­¢ï¼šè‡ªç„¶æ‰§è¡Œå®Œæˆ–æŠ›å‡ºæœªå¤„ç†å¼‚å¸¸</p>
<p><strong>javaçº¿ç¨‹æ˜¯åä½œå¼ï¼Œè€ŒéæŠ¢å å¼</strong></p>
<p>è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„<code>thread.interrupt()</code> æ–¹æ³•ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸æ˜¯å¼ºè¡Œå…³é—­è¿™ä¸ªçº¿ç¨‹ï¼Œåªæ˜¯è·Ÿè¿™ä¸ªçº¿ç¨‹æ‰“ä¸ªæ‹›å‘¼ï¼Œå°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ç½®ä¸ºtrueï¼Œçº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œç”±çº¿ç¨‹æœ¬èº«å†³å®šã€‚</p>
<p><code>isInterrupted()</code> åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ã€‚</p>
<p>staticæ–¹æ³•<code>thread.interrupted()</code> åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼ŒåŒæ—¶ä¸­æ–­æ ‡å¿—ä½æ”¹ä¸ºfalseã€‚</p>
<p>æ–¹æ³•é‡Œå¦‚æœæŠ›å‡º<code>thread.InterruptedException</code>ï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«å¤ä½æˆfalseï¼Œå¦‚æœç¡®å®æ˜¯éœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œè¦æ±‚æˆ‘ä»¬è‡ªå·±åœ¨catchè¯­å¥å—é‡Œå†æ¬¡è°ƒç”¨<code>thread.interrupt()</code>ã€‚</p>
<p>â€‹        è¦ä½¿ä»»åŠ¡å’Œçº¿ç¨‹èƒ½å®‰å…¨ã€å¿«é€Ÿã€å¯é åœ°åœæ­¢ä¸‹æ¥ï¼Œå¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚Javaæ²¡æœ‰æä¾›ä»»ä½•æœºåˆ¶æ¥å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆè¯¥å¦‚ä½•ä½¿ç”¨çº¿ç¨‹çš„åœæ­¢æˆ–è€…ä¸­æ–­å‘¢?</p>
<h4 id="ç¬¬ä¸€ç§æ–¹å¼-è°ƒç”¨Thread-stop"><a href="#ç¬¬ä¸€ç§æ–¹å¼-è°ƒç”¨Thread-stop" class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼:è°ƒç”¨Thread.stop()"></a>ç¬¬ä¸€ç§æ–¹å¼:è°ƒç”¨Thread.stop()</h4><p>â€‹        è¯¥æ–¹æ³•å¼ºè¿«åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªæ–°åˆ›å»ºçš„ ThreadDeathå¯¹è±¡ä½œä¸ºå¼‚å¸¸ã€‚åœæ­¢ä¸€ä¸ªå°šæœªå¯åŠ¨çš„çº¿ç¨‹æ˜¯å…è®¸çš„ï¼Œå¦‚æœç¨åå¯åŠ¨è¯¥çº¿ç¨‹ï¼Œå®ƒä¼šç«‹å³ç»ˆæ­¢ã€‚é€šå¸¸ä¸åº”è¯•å›¾æ•è·ThreadDeathï¼Œé™¤éå®ƒå¿…é¡»æ‰§è¡ŒæŸäº›å¼‚å¸¸çš„æ¸…é™¤æ“ä½œã€‚å¦‚æœcatchå­å¥æ•è·äº†ä¸€ä¸ªThreadDeathå¯¹è±¡,åˆ™å¿…é¡»é‡æ–°æŠ›å‡ºè¯¥å¯¹è±¡ï¼Œè¿™æ ·è¯¥çº¿ç¨‹æ‰ä¼šçœŸæ­£ç»ˆæ­¢ã€‚<br>â€‹        ç„¶è€Œï¼ŒThread.stop()ä¸å®‰å…¨ï¼Œå·²ä¸å†å»ºè®®ä½¿ç”¨,è¿™æ„å‘³ç€åœ¨æœªæ¥çš„JAVAç‰ˆæœ¬ä¸­,å®ƒå°†ä¸å¤å­˜åœ¨ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸å¤šè¯´äº†ã€‚</p>
<h4 id="ç¬¬äºŒç§æ–¹å¼-åˆ©ç”¨Thread-interrupt-æ–¹æ³•å’Œæœºåˆ¶"><a href="#ç¬¬äºŒç§æ–¹å¼-åˆ©ç”¨Thread-interrupt-æ–¹æ³•å’Œæœºåˆ¶" class="headerlink" title="ç¬¬äºŒç§æ–¹å¼:åˆ©ç”¨Thread.interrupt()æ–¹æ³•å’Œæœºåˆ¶"></a>ç¬¬äºŒç§æ–¹å¼:åˆ©ç”¨Thread.interrupt()æ–¹æ³•å’Œæœºåˆ¶</h4><p>â€‹        Javaä¸­æ–­æœºåˆ¶æ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡ä¸­æ–­å¹¶ä¸èƒ½ç›´æ¥ç»ˆæ­¢å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œéœ€è¦è¢«ä¸­æ–­çš„çº¿ç¨‹è‡ªå·±å¤„ç†ä¸­æ–­ã€‚<br>â€‹        Javaä¸­æ–­æ¨¡å‹ä¹Ÿå¯ä»¥ç®€å•åšå¦‚ä¸‹ç†è§£ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è±¡é‡Œéƒ½æœ‰ä¸€ä¸ªbooleanç±»å‹çš„æ ‡è¯†(ä¸ä¸€å®šå°±è¦æ˜¯Threadç±»çš„å­—æ®µ,å®é™…ä¸Šä¹Ÿçš„ç¡®ä¸æ˜¯,è¿™å‡ ä¸ªæ–¹æ³•æœ€ç»ˆéƒ½æ˜¯é€šè¿‡nativeæ–¹æ³•æ¥å®Œæˆçš„)ï¼Œä»£è¡¨ç€æ˜¯å¦æœ‰ä¸­æ–­è¯·æ±‚(è¯¥è¯·æ±‚å¯ä»¥æ¥è‡ªæ‰€æœ‰çº¿ç¨‹,åŒ…æ‹¬è¢«ä¸­æ–­çš„çº¿ç¨‹æœ¬èº«)ã€‚ä¾‹å¦‚ï¼Œå½“çº¿ç¨‹t1æƒ³ä¸­æ–­çº¿ç¨‹t2ï¼Œåªéœ€è¦åœ¨çº¿ç¨‹t1ä¸­å°†çº¿ç¨‹t2å¯¹è±¡çš„ä¸­æ–­æ ‡è¯†ç½®ä¸ºtrueï¼Œç„¶åçº¿ç¨‹2å¯ä»¥é€‰æ‹©åœ¨åˆé€‚çš„æ—¶å€™å¤„ç†è¯¥ä¸­æ–­è¯·æ±‚,ç”šè‡³å¯ä»¥ä¸ç†ä¼šè¯¥è¯·æ±‚ï¼Œå°±åƒè¿™ä¸ªçº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ä¸€æ ·ã€‚<br>â€‹        æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¾‹å­æ…¢æ…¢è¯´æ˜ã€‚</p>
<blockquote>
<p>â€‹        Threadç±»ä¸­æä¾›äº†ä¸‰ä¸ªä¸­æ–­æ–¹æ³•å¦‚ä¸‹:</p>
<ul>
<li>public static boolean interrupted(); æµ‹è¯•å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­ã€‚çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ç”±è¯¥æ–¹æ³•æ¸…é™¤ã€‚æ¢å¥è¯è¯´,å¦‚æœè¿ç»­ä¸¤æ¬¡è°ƒç”¨è¯¥æ–¹æ³•,åˆ™ç¬¬äºŒæ¬¡è°ƒç”¨å°†è¿”å› false(åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨å·²æ¸…é™¤äº†å…¶ä¸­æ–­çŠ¶æ€ä¹‹åï¼Œä¸”ç¬¬äºŒæ¬¡è°ƒç”¨æ£€éªŒå®Œä¸­æ–­çŠ¶æ€å‰,å½“å‰çº¿ç¨‹å†æ¬¡ä¸­æ–­çš„æƒ…å†µé™¤å¤–ï¼‰ã€‚</li>
<li>public boolean isInterrupted(); æµ‹è¯•çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸å—è¯¥æ–¹æ³•çš„å½±å“ã€‚</li>
<li>public void interrupt(): ä¸­æ–­çº¿ç¨‹ï¼Œä½†æ˜¯æ²¡æœ‰è¿”å›ç»“æœã€‚æ˜¯å”¯ä¸€èƒ½å°†ä¸­æ–­çŠ¶æ€è®¾ç½®ä¸ºtrueçš„æ–¹æ³•ã€‚</li>
</ul>
</blockquote>
<p>â€‹        ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œçº¿ç¨‹t1é€šè¿‡è°ƒç”¨interruptæ–¹æ³•å°†çº¿ç¨‹t2çš„ä¸­æ–­çŠ¶æ€ç½®ä¸ºtrueï¼Œt2å¯ä»¥åœ¨åˆé€‚çš„æ—¶å€™è°ƒç”¨interrupted æˆ–isInterruptedæ¥æ£€æµ‹çŠ¶æ€å¹¶åšç›¸åº”çš„å¤„ç†ã€‚<br>â€‹        æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‹é¢çš„å®ä¾‹ã€‚<br>â€‹        <strong>éœ€æ±‚:æˆ‘ä»¬ç”¨mainçº¿ç¨‹1æ¥ä¸­æ–­InterruptDemoçº¿ç¨‹2ï¼Œ</strong>ä»£ç å¦‚ä¸‹:</p>
<h5 id="No4-ThreadInterruptDemoOne-java"><a href="#No4-ThreadInterruptDemoOne-java" class="headerlink" title="No4_ThreadInterruptDemoOne.java"></a>No4_ThreadInterruptDemoOne.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_ThreadInterruptDemoOne</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">No4_ThreadInterruptDemoOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"InterruptDemo Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Starting thread..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Interrupting thread..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼š"</span> <span class="token operator">+</span> thread<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Stopping application..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> stop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"My Thread is running..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// è®©è¯¥å¾ªç¯æŒç»­ä¸€æ®µæ—¶é—´ï¼Œä½¿ä¸Šé¢çš„è¯æ‰“å°æ¬¡æ•°å°‘ç‚¹</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"My Thread exiting under request..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Starting thread<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Interrupting thread<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼štrue
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Stopping application<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
My Thread is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»è¿è¡Œç»“æœä¸Šçœ‹åˆ°ï¼ŒInterruptDemoçº¿ç¨‹2æ°¸è¿œæ²¡æœ‰ç»“æŸã€‚å°±åƒæˆ‘ä»¬å‰é¢æ‰€æè¿°çš„ä¸€æ ·,çº¿ç¨‹2æ²¡æœ‰å¤„ç†è¯¥ä¸­æ–­è¯·æ±‚ï¼Œå°±åƒè¿™ä¸ªçº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ä¸€æ ·ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä¾‹å­ç¨ä½œæ”¹è¿›ï¼Œè®©çº¿ç¨‹2å¤„ç†ç»ˆæ­¢è¯·æ±‚ã€‚<br>æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"My Thread is running..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// è®©è¯¥å¾ªç¯æŒç»­ä¸€æ®µæ—¶é—´ï¼Œä½¿ä¸Šé¢çš„è¯æ‰“å°æ¬¡æ•°å°‘ç‚¹</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// éœ€è¦çº¿ç¨‹æœ¬èº«å»å¤„ç†ä¸€ä¸‹å®ƒçš„ç»ˆæ­¢çŠ¶æ€</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Starting</span> thread<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">My</span> <span class="token class-name">Thread</span> is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">My</span> <span class="token class-name">Thread</span> is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">My</span> <span class="token class-name">Thread</span> is running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Interrupting</span> thread<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼š<span class="token boolean">true</span>
<span class="token class-name">My</span> <span class="token class-name">Thread</span> exiting under request<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Stopping</span> application<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»è¿è¡Œç»“æœä¸Šçœ‹åˆ°ï¼ŒInterruptDemoçº¿ç¨‹2çœŸæ­£çš„ç»ˆæ­¢ç»“æŸäº†ã€‚å°±åƒæˆ‘ä»¬å‰é¢æ‰€æè¿°çš„ä¸€æ ·ï¼Œçº¿ç¨‹2å¤„ç†äº†è¯¥ä¸­æ–­è¯·æ±‚,ä»è€Œå°±ä¼šçœŸæ­£çš„ä¸­æ–­ã€‚<br>â€‹        å…¶å® interruptè¿˜å¯ä»¥å¤„ç†ä¸€äº›æ›´ä¸ºå¤æ‚çš„é€»è¾‘ï¼Œå½“å¤–éƒ¨çº¿ç¨‹å¯¹æŸçº¿ç¨‹è°ƒç”¨äº†thread.interrupt()æ–¹æ³•åï¼ŒJavaè¯­è¨€çš„å¤„ç†æœºåˆ¶æ˜¯è¿™æ ·çš„ï¼š<br>â€‹        å¦‚æœè¯¥çº¿ç¨‹å¤„åœ¨å¯ä¸­æ–­çŠ¶æ€ä¸‹ï¼ˆè°ƒç”¨äº† Thread.wait(0æˆ–è€… Thread.sleep()ç­‰ç‰¹å®šä¼šå‘ç”Ÿé˜»å¡çš„api)ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šç«‹å³è¢«å”¤é†’ï¼ŒåŒæ—¶ä¼šå—åˆ°ä¸€ä¸ªInterruptedExceptionï¼ŒåŒæ—¶ï¼Œå¦‚æœæ˜¯é˜»å¡åœ¨IOä¸Šï¼Œå¯¹åº”çš„èµ„æºä¼šè¢«å…³é—­ã€‚å¦‚æœè¯¥çº¿ç¨‹æ¥ä¸‹æ¥ä¸æ‰§è¡ŒThread.interrupted()æ–¹æ³•(ä¸æ˜¯ interrupt),é‚£ä¹ˆè¯¥çº¿ç¨‹å¤„ç†ä»»ä½•IOèµ„æºçš„æ—¶å€™ï¼Œéƒ½ä¼šå¯¼è‡´è¿™äº›èµ„æºå…³é—­ã€‚å½“ç„¶ï¼Œè§£å†³çš„åŠæ³•å°±æ˜¯è°ƒç”¨ä¸€ä¸‹interrupted()ï¼Œä¸è¿‡è¿™é‡Œéœ€è¦ç¨‹åºå‘˜è‡ªè¡Œæ ¹æ®ä»£ç çš„é€»è¾‘æ¥è®¾å®šï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¡®è®¤æ˜¯å¦å¯ä»¥ç›´æ¥å¿½ç•¥è¯¥ä¸­æ–­,è¿˜æ˜¯åº”è¯¥é©¬ä¸Šé€€å‡ºã€‚<br>ç®€å•çš„å¼‚å¸¸å¤„ç†æ–¹å¼å¦‚ä¸‹:</p>
<pre class="line-numbers language-ja" data-language="ja"><code class="language-ja">@Override
    public void run() &#123;
        boolean stop &#x3D; false;
        while (!stop) &#123;
&#x2F;&#x2F;            System.out.println(&quot;My Thread is running...&quot;);
&#x2F;&#x2F;
&#x2F;&#x2F;            long time &#x3D; System.currentTimeMillis();
&#x2F;&#x2F;            while (System.currentTimeMillis() - time &lt; 1000) &#123;
&#x2F;&#x2F;                &#x2F;&#x2F; è®©è¯¥å¾ªç¯æŒç»­ä¸€æ®µæ—¶é—´ï¼Œä½¿ä¸Šé¢çš„è¯æ‰“å°æ¬¡æ•°å°‘ç‚¹
&#x2F;&#x2F;            &#125;
&#x2F;&#x2F;            if (Thread.currentThread().isInterrupted()) &#123;
&#x2F;&#x2F;                &#x2F;&#x2F; éœ€è¦çº¿ç¨‹æœ¬èº«å»å¤„ç†ä¸€ä¸‹å®ƒçš„ç»ˆæ­¢çŠ¶æ€
&#x2F;&#x2F;                break;
&#x2F;&#x2F;            &#125;
            try &#123;
                Thread.sleep(3L);
            &#125; catch (InterruptedException e) &#123;
                &#x2F;&#x2F; éœ€è¦çº¿ç¨‹æœ¬èº«å»å¤„ç†ä¸€ä¸‹å®ƒçš„ç»ˆæ­¢çŠ¶æ€
                &#x2F;&#x2F;InterruptedExceptionâ€”â€”å¦‚æœæœ‰çº¿ç¨‹ä¸­æ–­äº†å½“å‰çº¿ç¨‹ã€‚å½“æŠ›å‡ºæ­¤å¼‚å¸¸æ—¶ï¼Œå½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«æ¸…é™¤ã€‚
                break;
            &#125;
        &#125;
        System.out.println(&quot;My Thread exiting under request...&quot;);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿è¡Œå®Œä¹‹å,è¿è¡Œç»“æœå¯ä»¥è¾¾åˆ°ä¸å˜çš„æ•ˆæœã€‚<br>â€‹        æœ€åï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¢«ç»ˆæ­¢çš„çº¿ç¨‹ä¸€å®šè¦å¯¹ isInterrupted çŠ¶æ€è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™å¦‚æœä»£ç æ˜¯æ­»å¾ªç¯çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å°†æ°¸è¿œéƒ½ä¸ä¼šç»“æŸã€‚</p>
<p>è‹¥ä»¥ä¸Šä¾‹å­çœ‹çš„ç¹çè¯·çœ‹ä¸€ä¸‹ä»£ç </p>
<h5 id="No4-ThreadInterruptDemoTwo-java"><a href="#No4-ThreadInterruptDemoTwo-java" class="headerlink" title="No4_ThreadInterruptDemoTwo.java"></a>No4_ThreadInterruptDemoTwo.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_ThreadInterruptDemoTwo</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span>

        <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" interrput flag is "</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" is run!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" interrput flag is "</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" interrput flag is "</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" is run!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" interrput flag is "</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> endThreadOne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token string">"endThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThreadOne<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThreadOne<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">UseRunnable</span> useRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> endThreadTwo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>useRunnable<span class="token punctuation">,</span><span class="token string">"endThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThreadTwo<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThreadTwo<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<blockquote>
<ul>
<li>ç»­ No4_ThreadInterruptDemoOne.java çš„å¼‚å¸¸é—®é¢˜</li>
</ul>
<blockquote>
<p><strong>æŠ›å‡ºInterruptedExceptionå¼‚å¸¸çš„æ—¶å€™ï¼Œè¦æ³¨æ„ä¸­æ–­æ ‡å¿—ä½</strong></p>
</blockquote>
<p> å¼•ç”¨ä¸Šæ–‡    <code>  å¦‚æœè¯¥çº¿ç¨‹å¤„åœ¨å¯ä¸­æ–­çŠ¶æ€ä¸‹ï¼ˆè°ƒç”¨äº† Thread.wait(0æˆ–è€… Thread.sleep()ç­‰ç‰¹å®šä¼šå‘ç”Ÿé˜»å¡çš„api)ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šç«‹å³è¢«å”¤é†’ï¼ŒåŒæ—¶ä¼šå—åˆ°ä¸€ä¸ªInterruptedExceptionï¼ŒåŒæ—¶ï¼Œå¦‚æœæ˜¯é˜»å¡åœ¨IOä¸Šï¼Œå¯¹åº”çš„èµ„æºä¼šè¢«å…³é—­ã€‚å¦‚æœè¯¥çº¿ç¨‹æ¥ä¸‹æ¥ä¸æ‰§è¡ŒThread.interrupted()æ–¹æ³•(ä¸æ˜¯ interrupt),é‚£ä¹ˆè¯¥çº¿ç¨‹å¤„ç†ä»»ä½•IOèµ„æºçš„æ—¶å€™ï¼Œéƒ½ä¼šå¯¼è‡´è¿™äº›èµ„æºå…³é—­ã€‚å½“ç„¶ï¼Œè§£å†³çš„åŠæ³•å°±æ˜¯è°ƒç”¨ä¸€ä¸‹interrupted()ï¼Œä¸è¿‡è¿™é‡Œéœ€è¦ç¨‹åºå‘˜è‡ªè¡Œæ ¹æ®ä»£ç çš„é€»è¾‘æ¥è®¾å®šï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¡®è®¤æ˜¯å¦å¯ä»¥ç›´æ¥å¿½ç•¥è¯¥ä¸­æ–­,è¿˜æ˜¯åº”è¯¥é©¬ä¸Šé€€å‡ºã€‚</code></p>
</blockquote>
<h5 id="No4-ThreadHasInterruptedExceptionDemo-java"><a href="#No4-ThreadHasInterruptedExceptionDemo-java" class="headerlink" title="No4_ThreadHasInterruptedExceptionDemo.java"></a>No4_ThreadHasInterruptedExceptionDemo.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_ThreadHasInterruptedExceptionDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span>

        <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> threadName <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UseThread:"</span><span class="token operator">+</span>threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//å¦‚æœæœ‰ä»»ä½•çº¿ç¨‹ä¸­æ–­äº†å½“å‰çº¿ç¨‹ã€‚å½“æŠ›å‡ºæ­¤å¼‚å¸¸æ—¶ï¼Œå½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«æ¸…é™¤</span>
                    <span class="token comment">//çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«å¤ä½æˆfalseï¼Œå¦‚æœç¡®å®æ˜¯éœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œè¦æ±‚æˆ‘ä»¬è‡ªå·±åœ¨catchè¯­å¥å—é‡Œå†æ¬¡è°ƒç”¨`thread.interrupt()`ã€‚</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" catch interrput flag is "</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadName<span class="token operator">+</span><span class="token string">" interrput flag is "</span><span class="token operator">+</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> endThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token string">"HasInterruptedException"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰“å°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent3.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent3.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">UseThread</span><span class="token operator">:</span><span class="token class-name">HasInterruptedException</span>
<span class="token class-name">HasInterruptedException</span> <span class="token keyword">catch</span> interrput flag is <span class="token boolean">false</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>InterruptedException</span><span class="token operator">:</span> sleep interrupted
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>No4_ThreadHasInterruptedExceptionDemo</span>$<span class="token class-name">UseThread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">No4_ThreadHasInterruptedExceptionDemo</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token class-name">HasInterruptedException</span>
<span class="token class-name">HasInterruptedException</span> interrput flag is <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><strong>å¦‚æœæœ‰ä»»ä½•çº¿ç¨‹ä¸­æ–­äº†å½“å‰çº¿ç¨‹ã€‚å½“æŠ›å‡ºæ­¤å¼‚å¸¸æ—¶ï¼Œå½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«æ¸…é™¤</strong><br><strong>çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«å¤ä½æˆfalseï¼Œå¦‚æœç¡®å®æ˜¯éœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œè¦æ±‚æˆ‘ä»¬è‡ªå·±åœ¨catchè¯­å¥å—é‡Œå†æ¬¡è°ƒç”¨<code>thread.interrupt()</code>ã€‚</strong></p>
</blockquote>
<h3 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3><h4 id="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€"><a href="#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€" class="headerlink" title="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€"></a>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€</h4><blockquote>
<p> **6 ç§æˆ–è€…5ç§ **</p>
<p><strong>NEW RUNNABLE (running) BLOCKED WAITING|TIMED_WAITING TERMINATED</strong></p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ã€‚çº¿ç¨‹å¯ä»¥å¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€<span class="token operator">:</span>
   NEW                æœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
   <span class="token operator">--</span>å°šæœªå¯åŠ¨çš„çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚   å½“åˆ›å»º<span class="token class-name">Thread</span>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼ˆå¯¹è±¡ï¼‰æ—¶ï¼Œæ­¤çº¿ç¨‹è¿›å…¥æ–°å»ºçŠ¶æ€<span class="token operator">-</span>æœªè¢«å¯åŠ¨<span class="token punctuation">,</span>ä¹Ÿå°±è¯´å¤„äºæ–°ç”ŸçŠ¶æ€çš„çº¿ç¨‹æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ï¼Œä½†è¯¥çº¿ç¨‹å¹¶æ²¡æœ‰è¿è¡Œã€‚æ­¤æ—¶çº¿ç¨‹è¿˜ä¸æ˜¯æ´»ç€çš„ï¼ˆnot alive<span class="token punctuation">)</span>ã€‚

   RUNNABLE           åœ¨<span class="token class-name">Java</span>è™šæ‹Ÿæœºä¸­æ‰§è¡Œçš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€
   <span class="token operator">--</span>å¯è¿è¡Œçº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨<span class="token class-name">Java</span>è™šæ‹Ÿæœºä¸­æ‰§è¡Œï¼Œä½†å®ƒå¯èƒ½æ­£åœ¨ç­‰å¾…æ“ä½œç³»ç»Ÿçš„å…¶ä»–èµ„æºï¼Œå¦‚å¤„ç†å™¨ã€‚				 çº¿ç¨‹å·²ç»è¢«å¯åŠ¨ï¼Œæ­£åœ¨ç­‰å¾…è¢«åˆ†é…ç»™CPUæ—¶é—´ç‰‡ã€‚å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹å·²ç»å…·å¤‡äº†è¿è¡Œæ¡ä»¶ï¼Œä½†è¿˜æ²¡æœ‰è¢«åˆ†é…åˆ°CPU<span class="token punctuation">,</span>ä¸å®šä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œæ­¤æ—¶å¤„äºçº¿ç¨‹å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…ç³»ç»Ÿä¸ºå…¶åˆ†é…CPUï¼Œç­‰å¾…çŠ¶æ€å¹¶ä¸æ˜¯æ‰§è¡ŒçŠ¶æ€ã€‚æ­¤æ—¶çº¿ç¨‹æ˜¯æ´»ç€çš„ï¼ˆaliveï¼‰ã€‚
       
       é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ç§çŠ¶æ€<span class="token operator">--</span>è¿è¡Œï¼ˆrunning<span class="token punctuation">)</span><span class="token operator">:</span>çº¿ç¨‹è·å¾—CPUèµ„æºæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼ˆ<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>æ–¹æ³•<span class="token punctuation">)</span><span class="token punctuation">,</span>æ­¤æ—¶é™¤éæ­¤çº¿ç¨‹è‡ªåŠ¨æ”¾å¼ƒCPUèµ„æºæˆ–è€…æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹è¿›å…¥ï¼Œçº¿ç¨‹å°†ä¸€ç›´è¿è¡Œåˆ°ç»“æŸã€‚æ­¤æ—¶çº¿ç¨‹æ˜¯æ´»ç€çš„ï¼ˆaliveï¼‰ã€‚


   BLOCKED            ç­‰å¾…ç›‘è§†å™¨é”å®šè€Œé˜»å¡çš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€
   <span class="token operator">--</span>ç­‰å¾…ç›‘è§†å™¨é”å®šè€Œé˜»å¡çš„çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œç­‰å¾…ç›‘è§†å™¨é”è¿›å…¥åŒæ­¥å—<span class="token operator">/</span>æ–¹æ³•ï¼Œæˆ–è€…åœ¨è°ƒç”¨<span class="token class-name">Object</span><span class="token punctuation">.</span>waitåé‡æ–°è¿›å…¥åŒæ­¥å—<span class="token operator">/</span>æ–¹æ³•ã€‚
           å¤„äºBLOCKEDçŠ¶æ€çš„çº¿ç¨‹ä»ç„¶æ˜¯æ´»ç€çš„ï¼ˆaliveï¼‰ã€‚


   WAITING    ç­‰å¾…çŠ¶æ€        ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ— é™æœŸåœ°ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªç‰¹å®šçš„åŠ¨ä½œå°±æ˜¯åœ¨è¿™ä¸ªçŠ¶æ€
   <span class="token operator">--</span>ç­‰å¾…çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚çº¿ç¨‹ç”±äºè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€è€Œå¤„äºç­‰å¾…çŠ¶æ€<span class="token operator">:</span>
        <span class="token class-name">Object</span><span class="token punctuation">.</span>wait <span class="token keyword">with</span> <span class="token namespace">no</span> timeout
        <span class="token class-name">Thread</span><span class="token punctuation">.</span>join <span class="token keyword">with</span> <span class="token namespace">no</span> timeout
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span>park

        å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚
        ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šè°ƒç”¨object<span class="token punctuation">.</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åœ¨è¯¥å¯¹è±¡ä¸Šè°ƒç”¨object<span class="token punctuation">.</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>æˆ–object<span class="token punctuation">.</span> <span class="token function">notifyall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ã€‚   
        <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> æ˜¯éšæœºå”¤é†’çš„ï¼Œä¸åŒçš„ JDK ç‰ˆæœ¬ï¼Œåœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­å”¤é†’çš„çº¿ç¨‹ï¼Œå…¶ä½ç½®åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ä¸åŒã€‚JDK1<span class="token punctuation">.</span><span class="token number">8</span> ä¸­ <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> å”¤é†’çš„æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹ï¼ˆç­‰å¾…æ—¶é—´æœ€é•¿çš„é‚£ä¸ªçº¿ç¨‹ï¼‰    
        è°ƒç”¨äº†thread <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…æŒ‡å®šçš„çº¿ç¨‹ç»ˆæ­¢ã€‚

   TIMED_WAITING  å…·æœ‰æŒ‡å®šæ—¶é—´çš„ç­‰å¾…çŠ¶æ€    ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ“ä½œçš„çº¿ç¨‹åœ¨æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å†…å¤„äºæ­¤çŠ¶æ€
   <span class="token operator">--</span>å…·æœ‰æŒ‡å®šç­‰å¾…æ—¶é—´çš„ç­‰å¾…çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚çº¿ç¨‹ç”±äºè°ƒç”¨äº†ä»¥ä¸‹æ–¹æ³•ä¸­çš„ä¸€ä¸ªï¼Œå¹¶ä¸”æŒ‡å®šäº†æ­£ç­‰å¾…æ—¶é—´è€Œå¤„äºå®šæ—¶ç­‰å¾…çŠ¶æ€<span class="token operator">:</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span>sleep
        <span class="token class-name">Object</span><span class="token punctuation">.</span>wait <span class="token keyword">with</span> <span class="token namespace">timeout</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span>join <span class="token keyword">with</span> <span class="token namespace">timeout</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span>parkNanos
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span>parkUntil

   TERMINATED  å·²ç»ˆæ­¢çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€æˆ–çº¿ç¨‹å·²å®Œæˆæ‰§è¡Œ       å·²é€€å‡ºçš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€
   <span class="token operator">--</span>ç»ˆæ­¢çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚çº¿ç¨‹å·²ç»å®Œæˆæ‰§è¡Œã€‚  æ­¤æ—¶çº¿ç¨‹è¿˜ä¸æ˜¯æ´»ç€çš„ï¼ˆnot aliveï¼‰ã€‚

   çº¿ç¨‹åœ¨ç»™å®šçš„æ—¶é—´ç‚¹åªèƒ½å¤„äºä¸€ç§çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€æ˜¯ä¸åæ˜ çš„è™šæ‹ŸæœºçŠ¶æ€ä»»ä½•æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹çŠ¶æ€ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="No5-ThreadState-java"><a href="#No5-ThreadState-java" class="headerlink" title="No5_ThreadState.java"></a>No5_ThreadState.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_ThreadState</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–å½“å‰çº¿ç¨‹çŠ¶æ€ã€‚è¯¥æ–¹æ³•ç”¨äºç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”¨äºåŒæ­¥æ§åˆ¶ã€‚</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰“å°å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">NEW
RUNNABLE
<span class="token number">0</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token number">5</span>
<span class="token number">6</span>
<span class="token number">7</span>
<span class="token number">8</span>
<span class="token number">9</span>
TERMINATED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="çº¿ç¨‹å¸¸ç”¨æ–¹æ³•"><a href="#çº¿ç¨‹å¸¸ç”¨æ–¹æ³•" class="headerlink" title="çº¿ç¨‹å¸¸ç”¨æ–¹æ³•"></a>çº¿ç¨‹å¸¸ç”¨æ–¹æ³•</h4><p>â€‹        ä¸çº¿ç¨‹çŠ¶æ€å¯¹åº”çš„å¸¸ç”¨æ–¹æ³•æœ‰:</p>
<ul>
<li><code>void run()</code>:åˆ›å»ºè¯¥ç±»çš„å­ç±»æ—¶å¿…é¡»å®ç°çš„æ–¹æ³•ã€‚</li>
<li><code>void start()</code>:å¼€å¯çº¿ç¨‹çš„æ–¹æ³•ã€‚</li>
<li><code>static void sleep(long t)</code> <strong>&#x2F;</strong> <code>static void sleep(long millis,int nanos)</code>ï¼š<strong>é‡Šæ”¾CPUçš„æ‰§è¡Œæƒï¼Œä½†ä¸é‡Šæ”¾é”ã€‚</strong>å½“å‰çº¿ç¨‹ç¡çœ  <strong>X</strong> <strong>millis</strong> çš„æ—¶é—´ï¼ˆ millis æŒ‡å®šç¡çœ æ—¶é—´æ˜¯å…¶æœ€å°çš„ä¸æ‰§è¡Œæ—¶é—´ï¼Œå› ä¸ºsleep(millis)ä¼‘çœ åˆ°è¾¾åï¼Œæ— æ³•ä¿è¯ä¼šè¢«JVMç«‹å³è°ƒåº¦)ï¼Œsleep()æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•(static method)ï¼Œæ‰€ä»¥å®ƒä¸ä¼šåœæ­¢å…¶ä»–çš„çº¿ç¨‹ä¹Ÿå¤„äºä¼‘çœ çŠ¶æ€ã€‚<strong>çº¿ç¨‹sleep()æ—¶ä¸ä¼šå¤±å»æ‹¥æœ‰çš„å¯¹è±¡é”ã€‚</strong>ä½œç”¨æ˜¯:ä¿æŒå¯¹è±¡é”ï¼Œè®©å‡º CPUï¼Œè°ƒç”¨ç›®çš„æ˜¯ä¸è®©å½“å‰çº¿ç¨‹ç‹¬è‡ªéœ¸å è¯¥è¿›ç¨‹æ‰€è·å–çš„CPUèµ„æºï¼Œä»¥ç•™ä¸€å®šçš„æ—¶é—´ç»™å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„æœºä¼šã€‚</li>
<li><code>final void wait()</code>ï¼š<strong>é‡Šæ”¾CPUçš„æ‰§è¡Œæƒï¼Œé‡Šæ”¾é”</strong>ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°wait()æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥åˆ°ä¸€ä¸ªå’Œè¯¥å¯¹è±¡ç›¸å…³çš„ç­‰å¾…æ± (Waiting Poolï¼‰)ä¸­ï¼ŒåŒæ—¶å¤±å»äº†å¯¹è±¡çš„æœºé”â€”æš‚æ—¶çš„ï¼Œwaitåè¿˜è¦è¿”è¿˜å¯¹è±¡é”ã€‚<strong>å½“å‰çº¿ç¨‹å¿…é¡»æ‹¥æœ‰å½“å‰å¯¹è±¡çš„é”,å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æ­¤é”çš„æ‹¥æœ‰è€…ï¼Œä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼Œæ‰€ä»¥ wait()å¿…é¡»åœ¨synchronized blockä¸­è°ƒç”¨ã€‚</strong></li>
<li><code>final void notify()</code> <strong>&#x2F;</strong> <code>notifyAll()</code>ï¼šå”¤é†’åœ¨å½“å‰å¯¹è±¡ç­‰å¾…æ± ä¸­ç­‰å¾…çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹**&#x2F;<strong>æ‰€æœ‰çº¿ç¨‹ã€‚</strong><code>notify()</code> &#x2F; <code>notifyAll()</code>ä¹Ÿå¿…é¡»æ‹¥æœ‰ç›¸åŒå¯¹è±¡é”ï¼Œå¦åˆ™ä¹Ÿä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚**</li>
<li><code>static void yied()</code>ï¼šå¯ä»¥å¯¹å½“å‰çº¿ç¨‹è¿›è¡Œä¸´æ—¶æš‚åœï¼Œè®©å‡ºCPUçš„ä½¿ç”¨æƒï¼Œç»™å…¶ä»–çº¿ç¨‹æ‰§è¡Œæœºä¼šã€è®©åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹è¿è¡Œ(ä½†å¹¶ä¸ä¿è¯å½“å‰çº¿ç¨‹ä¼šè¢«JVMå†æ¬¡è°ƒåº¦ã€ä½¿è¯¥çº¿ç¨‹é‡æ–°è¿›å…¥ Running çŠ¶æ€)ï¼Œå¦‚æœæ²¡æœ‰åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆ <code>yield()</code>æ–¹æ³•å°†ä¸ä¼šèµ·ä½œç”¨ã€‚</li>
<li><code>final void join()</code>ï¼šæŒ‡å®šæ—¶é—´å†…ç­‰å¾…æ­¤çº¿ç¨‹æ­»äº¡ã€‚æ­¤æ–¹æ³•çš„è°ƒç”¨è¡Œä¸ºä¸è°ƒç”¨join(0)å®Œå…¨ç›¸åŒ</li>
</ul>
<h5 id="No5-ThreadState-Sleep-Yield-Join-Method-java"><a href="#No5-ThreadState-Sleep-Yield-Join-Method-java" class="headerlink" title="No5_ThreadState_Sleep_Yield_Join_Method.java"></a>No5_ThreadState_Sleep_Yield_Join_Method.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_ThreadState_Sleep_Yield_Join_Method</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        testSleep();</span>
<span class="token comment">//        testYield();</span>
<span class="token comment">//        testJoin();</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//Thread.sleep()æ–¹æ³•ï¼š</span>
    <span class="token comment">// ä½¿å½“å‰æ‰§è¡Œçš„çº¿ç¨‹åœ¨æŒ‡å®šçš„æ¯«ç§’æ•°å†…ä¼‘çœ (æš‚æ—¶åœæ­¢æ‰§è¡Œ)ï¼Œè¿™å–å†³äºç³»ç»Ÿè®¡æ—¶å™¨å’Œè°ƒåº¦å™¨çš„ç²¾åº¦å’Œå‡†ç¡®æ€§ã€‚çº¿ç¨‹ä¸ä¼šå¤±å»ä»»ä½•ç›‘è§†å™¨çš„æ‰€æœ‰æƒã€‚</span>
    <span class="token comment">// å‚æ•°:æ¯«ç§’-ä¼‘çœ æ—¶é—´çš„é•¿åº¦ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//TimeUnit.Milliseconds.sleep(500)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//Thread.yield( )æ–¹æ³•ï¼š</span>
    <span class="token comment">// ä½¿å½“å‰çº¿ç¨‹ä»æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰å˜ä¸ºå¯æ‰§è¡Œæ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰ã€‚</span>
    <span class="token comment">// cpuä¼šä»ä¼—å¤šçš„å¯æ‰§è¡Œæ€é‡Œé€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰ä¹Ÿå°±æ˜¯åˆšåˆšçš„é‚£ä¸ªçº¿ç¨‹è¿˜æ˜¯æœ‰å¯èƒ½ä¼šè¢«å†æ¬¡æ‰§è¡Œåˆ°çš„ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€å®šä¼šæ‰§è¡Œå…¶ä»–çº¿ç¨‹è€Œè¯¥çº¿ç¨‹åœ¨ä¸‹ä¸€æ¬¡ä¸­ä¸ä¼šæ‰§è¡Œåˆ°äº†ã€‚</span>
    <span class="token comment">//</span>
    <span class="token comment">// Javaçº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªThread.yield( )æ–¹æ³•ï¼Œå¾ˆå¤šäººç¿»è¯‘æˆçº¿ç¨‹è®©æ­¥ã€‚</span>
    <span class="token comment">// é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è¯´å½“ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ä¹‹åï¼Œå®ƒå°±ä¼šæŠŠè‡ªå·±CPUæ‰§è¡Œçš„æ—¶é—´è®©æ‰ï¼Œè®©è‡ªå·±æˆ–è€…å…¶å®ƒçš„çº¿ç¨‹è¿è¡Œã€‚</span>
    <span class="token comment">//</span>
    <span class="token comment">// æ‰“ä¸ªæ¯”æ–¹ï¼šç°åœ¨æœ‰å¾ˆå¤šäººåœ¨æ’é˜Ÿä¸Šå•æ‰€ï¼Œå¥½ä¸å®¹æ˜“è½®åˆ°è¿™ä¸ªäººä¸Šå•æ‰€äº†ï¼Œçªç„¶è¿™ä¸ªäººè¯´ï¼šâ€œæˆ‘è¦å’Œå¤§å®¶æ¥ä¸ªç«èµ›ï¼Œçœ‹è°å…ˆæŠ¢åˆ°å•æ‰€ï¼â€ï¼Œ</span>
    <span class="token comment">// ç„¶åæ‰€æœ‰çš„äººåœ¨åŒä¸€èµ·è·‘çº¿å†²å‘å•æ‰€ï¼Œæœ‰å¯èƒ½æ˜¯åˆ«äººæŠ¢åˆ°äº†ï¼Œä¹Ÿæœ‰å¯èƒ½ä»–è‡ªå·±æœ‰æŠ¢åˆ°äº†ã€‚</span>
    <span class="token comment">// æˆ‘ä»¬è¿˜çŸ¥é“çº¿ç¨‹æœ‰ä¸ªä¼˜å…ˆçº§çš„é—®é¢˜ï¼Œé‚£ä¹ˆæ‰‹é‡Œæœ‰ä¼˜å…ˆæƒçš„è¿™äº›äººå°±ä¸€å®šèƒ½æŠ¢åˆ°å•æ‰€çš„ä½ç½®å—? ä¸ä¸€å®šçš„ï¼Œä»–ä»¬åªæ˜¯æ¦‚ç‡ä¸Šå¤§äº›ï¼Œä¹Ÿæœ‰å¯èƒ½æ²¡ç‰¹æƒçš„æŠ¢åˆ°äº†ã€‚</span>

    <span class="token comment">// æºç </span>
    <span class="token comment">// ç»™è°ƒåº¦å™¨çš„æç¤ºï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒå½“å‰å¯¹å¤„ç†å™¨çš„ä½¿ç”¨ã€‚è°ƒåº¦ç¨‹åºå¯ä»¥å¿½ç•¥è¿™ä¸ªæç¤ºã€‚</span>
    <span class="token comment">// Yieldæ˜¯ä¸€ç§å¯å‘å¼çš„å°è¯•ï¼Œæ—¨åœ¨æé«˜çº¿ç¨‹ä¹‹é—´çš„ç›¸å¯¹è¿›ç¨‹ï¼Œå¦åˆ™å°±ä¼šè¿‡åº¦ä½¿ç”¨CPUã€‚å®ƒçš„ä½¿ç”¨åº”è¯¥ä¸è¯¦ç»†çš„åˆ†æå’ŒåŸºå‡†æµ‹è¯•ç›¸ç»“åˆï¼Œä»¥ç¡®ä¿å®ƒå®é™…ä¸Šå…·æœ‰é¢„æœŸçš„æ•ˆæœã€‚</span>
    <span class="token comment">// ä½¿ç”¨è¿™ç§æ–¹æ³•å¾ˆå°‘åˆé€‚ã€‚å®ƒå¯èƒ½å¯¹è°ƒè¯•æˆ–æµ‹è¯•æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½æœ‰åŠ©äºç”±äºç«äº‰æ¡ä»¶è€Œäº§ç”Ÿé”™è¯¯ã€‚åœ¨è®¾è®¡å¹¶å‘æ§åˆ¶ç¼ºç‚¹æ—¶ï¼Œå®ƒå¯èƒ½ä¹Ÿå¾ˆæœ‰ç”¨</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//å½“i % 10 ä¸º0æ—¶ï¼Œè¯¥çº¿ç¨‹å°±ä¼šæŠŠCPUæ—¶é—´è®©æ‰ï¼Œè®©å…¶ä»–æˆ–è€…è‡ªå·±çš„çº¿ç¨‹æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯è°å…ˆæŠ¢åˆ°è°æ‰§è¡Œï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//Yield is a heuristic attempt to improve relative progression between threads that would otherwise over-utilise a CPU.</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------B"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"============c"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·D"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//Thread.join()æ–¹æ³•ï¼š</span>
    <span class="token comment">// æŒ‡å®šæ—¶é—´å†…ç­‰å¾…æ­¤çº¿ç¨‹æ­»äº¡ã€‚æ­¤æ–¹æ³•çš„è°ƒç”¨è¡Œä¸ºä¸è°ƒç”¨join(0)å®Œå…¨ç›¸åŒ</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//TimeUnit.Milliseconds.sleep(100)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"B"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//TimeUnit.Milliseconds.sleep(500)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€ä¸‹æ‰“å°è¯æ˜äº† </p>
<blockquote>
<p><strong>Thread.yield( )æ–¹æ³•ï¼š</strong></p>
<ul>
<li><strong>ä½¿å½“å‰çº¿ç¨‹ä»æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰å˜ä¸ºå¯æ‰§è¡Œæ€ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰ã€‚</strong></li>
<li><strong>cpuä¼šä»ä¼—å¤šçš„å¯æ‰§è¡Œæ€é‡Œé€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰ä¹Ÿå°±æ˜¯åˆšåˆšçš„é‚£ä¸ªçº¿ç¨‹è¿˜æ˜¯æœ‰å¯èƒ½ä¼šè¢«å†æ¬¡æ‰§è¡Œåˆ°çš„ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€å®šä¼šæ‰§è¡Œå…¶ä»–çº¿ç¨‹è€Œè¯¥çº¿ç¨‹åœ¨ä¸‹ä¸€æ¬¡ä¸­ä¸ä¼šæ‰§è¡Œåˆ°äº†ã€‚</strong></li>
</ul>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">A0
A1
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B0
A2
A3
A4
A5
A6
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B1
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B2
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B3
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B4
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B5
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B6
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B7
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B8
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B9
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token class-name">B10</span>
A7
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c0
A8
A9
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B11
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B12
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B13
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B14
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B15
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B16
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B17
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B18
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c1
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c2
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c3
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c4
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c5
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c6
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c7
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c8
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c9
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c10
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c11
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c12
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c13
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c14
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c15
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c16
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c17
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c18
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c19
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c20
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c21
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c22
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c23
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c24
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c25
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c26
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c27
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c28
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c29
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c30
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c31
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c32
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c33
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>c34
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B19
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>B20
Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·D0
    
    <span class="token operator">--</span><span class="token operator">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºçš„è¯å°±æ˜¯:</p>
<p><img src="/image/Concurrent/Concurrent4.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent4.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p><img src="/image/Concurrent/Concurrent5.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent5.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<blockquote>
<p><strong>ç­‰å¾…å’Œé€šçŸ¥çš„æ ‡å‡†èŒƒå¼</strong></p>
<p><strong>ç­‰å¾…(wait)æ–¹ï¼š</strong></p>
<p>1ã€ è·å–å¯¹è±¡çš„é”ï¼›</p>
<p>2ã€ å¾ªç¯é‡Œåˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¸æ»¡è¶³è°ƒç”¨waitæ–¹æ³•ï¼Œ</p>
<p>3ã€ æ¡ä»¶æ»¡è¶³æ‰§è¡Œä¸šåŠ¡é€»è¾‘</p>
<p><strong>é€šçŸ¥(notify)æ–¹</strong></p>
<p>1ã€ è·å–å¯¹è±¡çš„é”ï¼›</p>
<p>2ã€ æ”¹å˜æ¡ä»¶</p>
<p>3ã€ é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨å¯¹è±¡çš„çº¿ç¨‹</p>
<p><strong>notifyå’ŒnotifyAllåº”è¯¥ç”¨è°ï¼Ÿ</strong></p>
<p>åº”è¯¥å°½é‡ä½¿ç”¨notifyAllï¼Œä½¿ç”¨notifyå› ä¸ºæœ‰å¯èƒ½å‘ç”Ÿ<strong>ä¿¡å·ä¸¢å¤±</strong>çš„çš„æƒ…å†µã€‚åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œnotifyåªèƒ½å”¤é†’éšæœºçš„ä¸€ä¸ªä¼‘çœ çº¿ç¨‹ï¼Œå…¶ä»–å·²ä¼‘çœ çš„çº¿ç¨‹ä¸èƒ½å”¤é†’ï¼Œé€ æˆä¿¡å·ä¸èƒ½ä¼ è¾¾è€Œä¸¢å¤±ï¼Œè€ŒnotifyAllå¯ä»¥å”¤é†’æ‰€æœ‰çš„ã€‚</p>
</blockquote>
<p><strong>è°ƒç”¨ join()ã€yield() ã€sleep()ã€wait()ã€notify()ç­‰æ–¹æ³•å¯¹é”æœ‰ä½•å½±å“ï¼Ÿ</strong></p>
<p>é¢è¯•ç‚¹</p>
<ul>
<li>çº¿ç¨‹åœ¨æ‰§è¡Œjoin()ä»¥åï¼ŒæŒæœ‰çš„é”æ˜¯ä¸é‡Šæ”¾çš„</li>
<li>çº¿ç¨‹åœ¨æ‰§è¡Œyield()ä»¥åï¼ŒæŒæœ‰çš„é”æ˜¯ä¸é‡Šæ”¾çš„</li>
<li>sleep()æ–¹æ³•è¢«è°ƒç”¨ä»¥åï¼ŒæŒæœ‰çš„é”æ˜¯ä¸é‡Šæ”¾çš„</li>
<li>è°ƒåŠ¨wait()æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è¦æŒæœ‰é”ã€‚è°ƒç”¨äº†wait()æ–¹æ³•ä»¥åï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ï¼Œå½“waitæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šé‡æ–°æŒæœ‰é”</li>
<li>è°ƒåŠ¨notify()&#x2F;notifyAll()æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è¦æŒæœ‰é”ï¼Œè°ƒç”¨notify()&#x2F;notifyAll()æ–¹æ³•æœ¬èº«ä¸ä¼šé‡Šæ”¾é”çš„ã€‚è¿™ä¸¤ä¸ªéƒ½èƒ½è¢«interruptæ–¹æ³•ä¸­æ–­å½“å‰çŠ¶æ€</li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹"><a href="#ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹"></a>ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹</h3><p>â€‹        (1ï¼‰å®ˆæŠ¤çº¿ç¨‹,å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºåå°è¿è¡Œçº¿ç¨‹ã€‚è¿›ç¨‹ç»“æŸï¼Œå®ˆæŠ¤çº¿ç¨‹è‡ªç„¶è€Œç„¶åœ°å°±ä¼šç»“æŸï¼Œä¸éœ€è¦æ‰‹åŠ¨çš„å»å…³å¿ƒå’Œé€šçŸ¥å…¶çŠ¶æ€ã€‚ä¾‹å¦‚:åœ¨ä½ çš„åº”ç”¨ç¨‹åºè¿è¡Œæ—¶æ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼Œåœ¨æ–‡å­—ç¼–è¾‘å™¨é‡Œåšè‡ªåŠ¨è¯­æ³•æ£€æŸ¥ã€è‡ªåŠ¨ä¿å­˜ç­‰åŠŸèƒ½ã€‚Javaçš„åƒåœ¾å›æ”¶ä¹Ÿæ˜¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ã€‚å®ˆæŠ¤çº¿ç¨‹çš„å¥½å¤„å°±æ˜¯ä½ ä¸éœ€è¦å…³å¿ƒå®ƒçš„ç»“æŸé—®é¢˜ã€‚ä¾‹å¦‚ä½ åœ¨ä½ çš„åº”ç”¨ç¨‹åºè¿è¡Œçš„æ—¶å€™å¸Œæœ›æ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼Œå¦‚æœå°†è¿™ä¸ªæ’­æ”¾èƒŒæ™¯éŸ³ä¹çš„çº¿ç¨‹è®¾å®šä¸ºéå®ˆæŠ¤çº¿ç¨‹ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·è¯·æ±‚é€€å‡ºçš„æ—¶å€™ï¼Œä¸ä»…è¦é€€å‡ºä¸»çº¿ç¨‹ï¼Œè¿˜è¦é€šçŸ¥æ’­æ”¾èƒŒæ™¯éŸ³ä¹çš„çº¿ç¨‹é€€å‡ºï¼›å¦‚æœè®¾å®šä¸ºå®ˆæŠ¤çº¿ç¨‹åˆ™ä¸éœ€è¦äº†ã€‚<br>â€‹        (2ï¼‰å®ˆæŠ¤çº¿ç¨‹ä¸æ™®é€šçº¿ç¨‹å†™æ³•ä¸ŠåŸºæœ¬æ²¡å•¥åŒºåˆ«ï¼Œè°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„æ–¹æ³•setDaemon(true)ï¼Œåˆ™å¯ä»¥å°†å…¶è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚è¯¥æ–¹æ³•å¿…é¡»åœ¨å¯åŠ¨çº¿ç¨‹å‰è°ƒç”¨:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> setDaemon <span class="token punctuation">(</span><span class="token keyword">boolean</span> on<span class="token punctuation">)</span><span class="token comment">//è¯¥æ–¹æ³•å¿…é¡»åœ¨å¯åŠ¨çº¿ç¨‹å‰è°ƒç”¨</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹        å°†è¯¥çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹ã€‚å½“æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹æ—¶, Javaè™šæ‹Ÿæœºé€€å‡ºã€‚è¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨è¯¥çº¿ç¨‹çš„ checkAccess æ–¹æ³•ä¸”ä¸å¸¦ä»»ä½•å‚æ•°ã€‚è¿™å¯èƒ½æŠ›å‡º SecurityException(åœ¨å½“å‰çº¿ç¨‹ä¸­)ã€‚</p>
<ul>
<li>å‚æ•°ï¼šon - å¦‚æœä¸ºtrueï¼Œåˆ™å°†è¯¥çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚</li>
<li>æŠ›å‡ºï¼šIllegalThreadStateException -å¦‚æœè¯¥çº¿ç¨‹å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚SecurityException-å¦‚æœå½“å‰çº¿ç¨‹æ— æ³•ä¿®æ”¹è¯¥çº¿ç¨‹ã€‚</li>
</ul>
<p>â€‹        (3ï¼‰å®ˆæŠ¤çº¿ç¨‹ä¸»åŠ¨ç¨‹åºå»ä½¿ç”¨çš„æƒ…å†µè¾ƒå°‘ï¼Œä½†åœ¨ï¼ŒJVM çš„åƒåœ¾å›æ”¶ã€å†…å­˜ç®¡ç†ç­‰çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚è¿˜æœ‰å°±æ˜¯åœ¨åšæ•°æ®åº“åº”ç”¨æ—¶å€™ï¼Œä½¿ç”¨çš„æ•°æ®åº“è¿æ¥æ± ï¼Œè¿æ¥æ± æœ¬èº«ä¹ŸåŒ…å«ç€å¾ˆå¤šåå°çº¿ç¨‹,ç›‘æ§è¿æ¥ä¸ªæ•°ã€è¶…æ—¶æ—¶é—´ã€çŠ¶æ€ç­‰ç­‰ä½¿ç”¨æƒ…å†µã€‚</p>
<h4 id="No6-ThreadDeamon-java"><a href="#No6-ThreadDeamon-java" class="headerlink" title="No6_ThreadDeamon.java"></a>No6_ThreadDeamon.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No6_ThreadDeamon</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadA</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9999999L</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"åå°çº¿ç¨‹Aç¬¬"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"æ¬¡æ‰§è¡Œï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹B finally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadB</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹Bç¬¬"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"æ¬¡æ‰§è¡Œï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹B finally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> tA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> tB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tA<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹,æ³¨æ„ä¸€å®šè¦åœ¨å¼€å§‹ä¹‹å‰è°ƒç”¨</span>

        tB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> mainThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹Aæ˜¯ä¸æ˜¯å®ˆæŠ¤çº¿ç¨‹"</span> <span class="token operator">+</span> tA<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹bæ˜¯ä¸æ˜¯å®ˆæŠ¤çº¿ç¨‹"</span> <span class="token operator">+</span> tB<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹mainæ˜¯ä¸æ˜¯å®ˆæŠ¤çº¿ç¨‹"</span> <span class="token operator">+</span> mainThread<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢çš„æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡º:å‰å°çº¿ç¨‹æ˜¯ä¿è¯æ‰§è¡Œå®Œæ¯•çš„ï¼Œåå°çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•å°±é€€å‡ºäº†ã€‚</p>
<blockquote>
<p> <strong>å®ˆæŠ¤çº¿ç¨‹</strong>å’Œä¸»çº¿ç¨‹å…±æ­»ï¼Œçº¿ç¨‹ä¸­çš„finallyä¸èƒ½ä¿è¯ä¸€å®šæ‰§è¡Œ</p>
</blockquote>
<h3 id="çº¿ç¨‹ç»„"><a href="#çº¿ç¨‹ç»„" class="headerlink" title="çº¿ç¨‹ç»„"></a>çº¿ç¨‹ç»„</h3><p>â€‹        åœ¨Javaçš„å¤šçº¿ç¨‹å¤„ç†ä¸­æœ‰çº¿ç¨‹ç»„ ThreadGroup çš„æ¦‚å¿µ,ThreadGroupæ˜¯ä¸ºäº†æ–¹ä¾¿çº¿ç¨‹ç®¡ç†å‡ºç°çš„ã€‚æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¾å®šçº¿ç¨‹ç»„çš„ä¸€äº›å±æ€§,æ¯”å¦‚ setDaemonï¼Œè®¾ç½®æœªå¤„ç†å¼‚å¸¸çš„å¤„ç†æ–¹æ³•ï¼Œè®¾ç½®ç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥ç­‰ç­‰,ä¹Ÿå¯ä»¥é€šè¿‡çº¿ç¨‹ç»„æ–¹ä¾¿åœ°è·å¾—çº¿ç¨‹çš„ä¸€äº›ä¿¡æ¯ã€‚<br>â€‹        æ¯ä¸€ä¸ªThreadGroupéƒ½å¯ä»¥åŒ…å«ä¸€ç»„çš„å­çº¿ç¨‹å’Œä¸€ç»„å­çº¿ç¨‹ç»„ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­çº¿ç¨‹ç»„æ˜¯ä»¥æ ‘å½¢çš„æ–¹å¼å­˜åœ¨ï¼Œé€šå¸¸æƒ…å†µä¸‹æ ¹çº¿ç¨‹ç»„æ˜¯systemçº¿ç¨‹ç»„ã€‚system çº¿ç¨‹ç»„ä¸‹æ˜¯mainçº¿ç¨‹ç»„ï¼Œé»˜è®¤æƒ…å†µä¸‹ç¬¬ä¸€çº§åº”ç”¨è‡ªå·±çš„çº¿ç¨‹ç»„æ˜¯é€šè¿‡mainçº¿ç¨‹ç»„åˆ›å»ºå‡ºæ¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´systemçº¿ç¨‹ç»„æ˜¯æ‰€æœ‰çº¿ç¨‹æœ€é¡¶çº§çš„çˆ¶çº¿ç¨‹ç»„ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯ä»¥è·å¾—å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç»„ã€‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹        Javaå…è®¸æˆ‘ä»¬å¯¹ä¸€ä¸ªçº¿ç¨‹ç»„ä¸­çš„æ‰€æœ‰çº¿ç¨‹åŒæ—¶è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨çº¿ç¨‹ç»„çš„ç›¸åº”æ–¹æ³•æ¥è®¾ç½®å…¶ä¸­æ‰€æœ‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ä»¥å¯åŠ¨æˆ–é˜»å¡å…¶ä¸­çš„æ‰€æœ‰çº¿ç¨‹ã€‚<br>â€‹        Javaçš„å¤šçº¿ç¨‹ç»„æœºåˆ¶çš„å¦ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯çº¿ç¨‹å®‰å…¨ã€‚çº¿ç¨‹ç»„æœºåˆ¶å…è®¸æˆ‘ä»¬é€šè¿‡åˆ†ç»„æ¥åŒºåˆ†æœ‰ä¸åŒå®‰å…¨ç‰¹æ€§çš„çº¿ç¨‹ï¼Œå¯¹ä¸åŒç»„çš„çº¿ç¨‹è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œè¿˜å¯ä»¥é€šè¿‡çº¿ç¨‹ç»„çš„åˆ†å±‚ç»“æ„æ¥æ”¯æŒä¸å¯¹ç­‰å®‰å…¨æªæ–½çš„é‡‡ç”¨ã€‚Javaçš„ ThreadGroupç±»æä¾›äº†å¤§é‡çš„æ–¹æ³•æ¥æ–¹ä¾¿æˆ‘ä»¬å¯¹çº¿ç¨‹ç»„æ ‘ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹ç»„ä»¥åŠçº¿ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ“ä½œã€‚<br>â€‹        çº¿ç¨‹ç»„å’Œçº¿ç¨‹æ± çš„åŒºåˆ«ï¼šçº¿ç¨‹ç»„å’Œçº¿ç¨‹æ± æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œä»–ä»¬çš„ä½œç”¨å®Œå…¨ä¸åŒï¼Œå‰è€…æ˜¯ä¸ºäº†æ–¹ä¾¿çº¿ç¨‹çš„ç®¡ç†ï¼Œåè€…æ˜¯ä¸ºäº†ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¤ç”¨çº¿ç¨‹ï¼Œå‡å°‘åˆ›å»ºé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚</p>
<h4 id="å½“å‰çº¿ç¨‹å‰¯æœ¬-ThreadLocal"><a href="#å½“å‰çº¿ç¨‹å‰¯æœ¬-ThreadLocal" class="headerlink" title="å½“å‰çº¿ç¨‹å‰¯æœ¬:ThreadLocal"></a>å½“å‰çº¿ç¨‹å‰¯æœ¬:ThreadLocal</h4><p>â€‹        (1)å½“ä½¿ç”¨ThreadLocalç»´æŠ¤å˜é‡æ—¶ï¼ŒThreadLocalä¸ºæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„çº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚ä»çº¿ç¨‹çš„è§’åº¦çœ‹ï¼Œç›®æ ‡å˜é‡å°±åƒæ˜¯çº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ç±»åä¸­Localæ‰€è¦è¡¨è¾¾çš„æ„æ€ã€‚<br>â€‹        (2ï¼‰ThreadLocal<T>ç±»æ¥å£å¾ˆç®€å•,åªæœ‰4ä¸ªæ–¹æ³•:</p>
<ul>
<li><p><code>void set(T value)</code>,è®¾ç½®å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚</p>
</li>
<li><p><code>public T get()</code>ï¼Œè¯¥æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚</p>
</li>
<li><p><code>public void remove()</code>ï¼Œå°†å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼åˆ é™¤ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜çš„å ç”¨ï¼Œè¯¥æ–¹æ³•æ˜¯JDK5.0æ–°å¢çš„æ–¹æ³•ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå½“çº¿ç¨‹ç»“æŸåï¼Œå¯¹åº”è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡å°†è‡ªåŠ¨è¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•æ¸…é™¤çº¿ç¨‹çš„å±€éƒ¨å˜é‡å¹¶ä¸æ˜¯å¿…é¡»çš„æ“ä½œï¼Œä½†å®ƒå¯ä»¥åŠ å¿«å†…å­˜å›æ”¶çš„é€Ÿåº¦ã€‚</p>
</li>
<li><p><code>protected T initialValue()</code>,è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªprotected çš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•,åœ¨çº¿ç¨‹ç¬¬1æ¬¡è°ƒç”¨get()æˆ–set(Object)æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚ThreadLocalä¸­çš„ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ªnullã€‚</p>
<p>(3ï¼‰ç®€å•çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:</p>
</li>
</ul>
<h5 id="No7-ThreadLocalDemo-java"><a href="#No7-ThreadLocalDemo-java" class="headerlink" title="No7_ThreadLocalDemo.java"></a>No7_ThreadLocalDemo.java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No7_ThreadLocalDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// â‘ é€šè¿‡åŒ¿åå†…éƒ¨ç±»è¦†ç›–ThreadLocalçš„initialValue()æ–¹æ³•ï¼ŒæŒ‡å®šåˆå§‹å€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> seqNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">getThreadLocl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> seqNum<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// â‘¡è·å–ä¸‹ä¸€ä¸ªåºåˆ—å€¼</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNextNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        seqNum<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>seqNum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> seqNum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">No7_ThreadLocalDemo</span> sn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">No7_ThreadLocalDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// â‘¢ 3ä¸ªçº¿ç¨‹å…±äº« snï¼Œå„è‡ªäº§ç”Ÿåºåˆ—å·</span>
        <span class="token class-name">TestClient</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestClient</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TestClient</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestClient</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TestClient</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestClient</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestClient</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">No7_ThreadLocalDemo</span> sn<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">TestClient</span><span class="token punctuation">(</span><span class="token class-name">No7_ThreadLocalDemo</span> sn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sn <span class="token operator">=</span> sn<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// â‘£æ¯ä¸ªçº¿ç¨‹æ‰“å‡º3ä¸ªåºåˆ—å€¼</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread["</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] --> sn["</span> <span class="token operator">+</span> sn<span class="token punctuation">.</span><span class="token function">getNextNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            sn<span class="token punctuation">.</span><span class="token function">getThreadLocl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¯ä¸ªçº¿ç¨‹ç”¨å®Œçš„æ—¶å€™è¦è®°å¾—åˆ é™¤</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é€šå¸¸æˆ‘ä»¬é€šè¿‡åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼æ¥å®šä¹‰ThreadLocal çš„å­ç±»ï¼Œæä¾›åˆå§‹çš„å˜é‡å€¼,å¦‚ä¾‹å­ä¸­æ³¨é‡Š1å¤„æ‰€ç¤ºã€‚TestClientçº¿ç¨‹äº§ç”Ÿä¸€ç»„åºåˆ—å·ï¼Œåœ¨æ³¨é‡Š3å¤„ï¼Œæˆ‘ä»¬ç”Ÿæˆ3ä¸ªTestClientï¼Œå®ƒä»¬å…±äº«åŒä¸€ä¸ªTestNum å®ä¾‹ã€‚è¿è¡Œä»¥ä¸Šä»£ç ,åœ¨æ§åˆ¶å°ä¸Šè¾“å‡ºä»¥ä¸‹çš„ç»“æœ:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
thread<span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> sn<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è€ƒå¯Ÿè¾“å‡ºçš„ç»“æœä¿¡æ¯ï¼Œæˆ‘ä»¬å‘ç°æ¯ä¸ªçº¿ç¨‹æ‰€äº§ç”Ÿçš„åºå·è™½ç„¶éƒ½å…±äº«åŒä¸€ä¸ªTestNumå®ä¾‹,ä½†å®ƒä»¬å¹¶æ²¡æœ‰å‘ç”Ÿç›¸äº’å¹²æ‰°çš„æƒ…å†µ,è€Œæ˜¯å„è‡ªäº§ç”Ÿç‹¬ç«‹çš„åºåˆ—å·,è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é€šè¿‡ThreadLocalä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›äº†å•ç‹¬çš„å‰¯æœ¬ã€‚<br>â€‹        (4) ThreadLocalçš„å®ç°åŸç†:é‚£ä¹ˆåˆ°åº•ThreadLocalç±»æ˜¯å¦‚ä½•å®ç°è¿™ç§â€œä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ä¸åŒçš„å˜é‡é“‚è´â€çš„å‘¢?<br>â€‹        å…ˆæ¥çœ‹ä¸€ä¸‹ThreadLocalçš„set()æ–¹æ³•çš„æºç æ˜¯å¦‚ä½•å®ç°çš„:</p>
<p><img src="/image/Concurrent/Concurrent6.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent6.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨æˆ‘ä»¬çœ‹åˆ°ï¼Œé¦–å…ˆé€šè¿‡ <code>getMap(Thread t)</code>æ–¹æ³•è·å–ä¸€ä¸ªå’Œå½“å‰çº¿ç¨‹ç›¸å…³çš„<code>ThreadLocalMap</code>ï¼Œç„¶åå°†å˜é‡çš„å€¼è®¾ç½®åˆ°è¿™ä¸ª <code>ThreadLocalMap</code>å¯¹è±¡ä¸­ï¼Œå½“ç„¶å¦‚æœè·å–åˆ°çš„<code>ThreadLocalMap</code>å¯¹è±¡ä¸ºç©º,å°±é€šè¿‡<code>createMap</code>æ–¹æ³•åˆ›å»ºã€‚<br>â€‹        çº¿ç¨‹éš”ç¦»çš„ç§˜å¯†ï¼Œå°±åœ¨äº<code>ThreadLocalMap</code>è¿™ä¸ªç±»ã€‚<code>ThreadLocalMap</code>æ˜¯<code>ThreadLocal</code>ç±»çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†é”®å€¼å¯¹çš„è®¾ç½®å’Œè·å–(å¯¹æ¯” Mapå¯¹è±¡æ¥ç†è§£)ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„<code>ThreadLocalMap</code>å‰¯æœ¬ï¼Œå®ƒæ‰€å­˜å‚¨çš„å€¼ï¼Œåªèƒ½è¢«å½“å‰çº¿ç¨‹è¯»å–å’Œä¿®æ”¹ã€‚<code>ThreadLocal</code>ç±»é€šè¿‡æ“ä½œæ¯ä¸€ä¸ªçº¿ç¨‹ç‰¹æœ‰çš„<code>ThreadLocalMap</code>å‰¯æœ¬ï¼Œä»è€Œå®ç°äº†å˜é‡è®¿é—®åœ¨ä¸åŒçº¿ç¨‹ä¸­çš„éš”ç¦»ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯è‡ªå·±ç‰¹æœ‰çš„ï¼Œå®Œå…¨ä¸ä¼šæœ‰å¹¶å‘é”™è¯¯ã€‚è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œ<code>ThreadLocalMap</code>å­˜å‚¨çš„é”®å€¼å¯¹ä¸­çš„é”®æ˜¯<code>this</code>å¯¹è±¡æŒ‡å‘çš„<code>ThreadLocal</code>å¯¹è±¡ï¼Œè€Œå€¼å°±æ˜¯ä½ æ‰€è®¾ç½®çš„å¯¹è±¡äº†ã€‚<br>â€‹        ä¸ºäº†åŠ æ·±ç†è§£,æˆ‘ä»¬æ¥ç€çœ‹ä¸Šé¢ä»£ç ä¸­å‡ºç°çš„<code>getMap</code>å’Œ <code>createMap</code>æ–¹æ³•çš„å®ç°:</p>
<p><img src="/image/Concurrent/Concurrent7.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent7.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹ <code>ThreadLocal</code>ç±»ä¸­çš„<code>get()</code>æ–¹æ³•:</p>
<p><img src="/image/Concurrent/Concurrent8.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent8.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å†æ¥çœ‹<code>setInitialValue()</code>æ–¹æ³•:</p>
<p><img src="/image/Concurrent/Concurrent9.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent9.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        è·å–å’Œå½“å‰çº¿ç¨‹ç»‘å®šçš„å€¼æ—¶,<code>ThreadLocalMap</code>å¯¹è±¡æ˜¯ä»¥ <code>this</code> æŒ‡å‘çš„<code>ThreadLocal</code>å¯¹è±¡ä¸ºé”®è¿›è¡ŒæŸ¥æ‰¾çš„ï¼Œè¿™å½“ç„¶å’Œå‰é¢set(æ–¹æ³•çš„ä»£ç æ˜¯ç›¸å‘¼åº”çš„ã€‚<br>â€‹        è¿›ä¸€æ­¥åœ°,æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸åŒçš„<code>ThreadLocal</code>å®ä¾‹æ¥å®ç°å¤šä¸ªå˜é‡åœ¨ä¸åŒçº¿ç¨‹é—´çš„è®¿é—®éš”ç¦»ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåšï¼Ÿå› ä¸ºä¸åŒçš„<code>ThreadLocal</code>å¯¹è±¡ä½œä¸ºä¸åŒé”®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹çš„<code>ThreadLocalMap</code>å¯¹è±¡ä¸­è®¾ç½®ä¸åŒçš„å€¼äº†ã€‚é€šè¿‡<code>ThreadLocal</code>å¯¹è±¡ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­å…±äº«ä¸€ä¸ªå€¼å’Œå¤šä¸ªå€¼çš„åŒºåˆ«ï¼Œå°±åƒä½ åœ¨ä¸€ä¸ª<code>HashMap</code>å¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹å’Œå¤šä¸ªé”®å€¼å¯¹ä¸€æ ·ï¼Œä»…æ­¤è€Œå·²ã€‚<br>â€‹        (5) <code>ThreadLocal</code> åœ¨å¤„ç†çº¿ç¨‹çš„å±€éƒ¨å˜é‡çš„æ—¶å€™æ¯”åé¢è¦è®²çš„ <code>synchronized</code>åŒæ­¥æœºåˆ¶è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜æ›´ç®€å•,æ›´æ–¹ä¾¿,ä¸”ç»“æœç¨‹åºæ‹¥æœ‰æ›´é«˜çš„å¹¶å‘æ€§ã€‚<br>â€‹        (6ï¼‰æ³¨æ„äº‹é¡¹:<strong>ä½¿ç”¨ <code>ThreadLocal</code>ï¼Œä¸€èˆ¬éƒ½æ˜¯å£°æ˜åœ¨é™æ€å˜é‡ä¸­ï¼Œå¦‚æœä¸æ–­åœ°åˆ›å»º<code>ThreadLocal</code>è€Œä¸”æ²¡æœ‰è°ƒç”¨å…¶<code>remove</code>æ–¹æ³•ï¼Œå°†ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘çš„Webå®¹å™¨å½“ä¸­è¿™ä¹ˆåšçš„æ—¶å€™ã€‚</strong></p>
<h3 id="çº¿ç¨‹å¼‚å¸¸çš„å¤„ç†"><a href="#çº¿ç¨‹å¼‚å¸¸çš„å¤„ç†" class="headerlink" title="çº¿ç¨‹å¼‚å¸¸çš„å¤„ç†"></a>çº¿ç¨‹å¼‚å¸¸çš„å¤„ç†</h3><p>â€‹        <code>run()</code>æ–¹æ³•ä¸å…è®¸ <code>throw exception</code>ï¼Œæ‰€æœ‰çš„å¼‚å¸¸å¿…é¡»åœ¨<code>run()</code>æ–¹æ³•å†…è¿›è¡Œå¤„ç†ã€‚<br>â€‹        åœ¨Javaå¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å…è®¸æŠ›å‡ºæœªæ•è·çš„<code>checked exception</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å„ä¸ªçº¿ç¨‹éœ€è¦è‡ªå·±æŠŠè‡ªå·±çš„<code>checked exception</code>å¤„ç†æ‰ã€‚è¿™ä¸€ç‚¹æ˜¯é€šè¿‡<code>java.lang.Runnable.run()</code>æ–¹æ³•å£°æ˜(å› ä¸ºæ­¤æ–¹æ³•å£°æ˜ä¸Šæ²¡æœ‰ <code>throw exception</code>éƒ¨åˆ†ï¼‰è¿›è¡Œäº†çº¦æŸã€‚ä½†æ˜¯çº¿ç¨‹ä¾ç„¶æœ‰å¯èƒ½æŠ›å‡º <code>uncheckedexception</code>ï¼Œå½“æŠ›å‡ºæ­¤ç±»å¼‚å¸¸æ—¶ï¼Œçº¿ç¨‹å°±ä¼šç»ˆç»“,è€Œå¯¹äºä¸»çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹å®Œå…¨ä¸å—å½±å“ï¼Œä¸”å®Œå…¨æ„ŸçŸ¥ä¸åˆ°æŸä¸ªçº¿ç¨‹æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¹Ÿæ˜¯è¯´å®Œå…¨æ— æ³• <code>catch</code>åˆ°è¿™ä¸ªå¼‚å¸¸ã€‚JVMçš„è¿™ç§è®¾è®¡æºè‡ªäºè¿™æ ·ä¸€ç§ç†å¿µ:â€œçº¿ç¨‹æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„ä»£ç ç‰‡æ–­ï¼Œçº¿ç¨‹çš„é—®é¢˜åº”è¯¥ç”±çº¿ç¨‹è‡ªå·±æ¥è§£å†³ï¼Œè€Œä¸è¦å§”æ‰˜åˆ°å¤–éƒ¨ã€‚â€åŸºäºè¿™æ ·çš„è®¾è®¡ç†å¿µ,åœ¨Javaä¸­,çº¿ç¨‹æ–¹æ³•çš„å¼‚å¸¸(æ— è®ºæ˜¯<code>checked</code>è¿˜æ˜¯<code>unchecked exception</code>),éƒ½åº”è¯¥åœ¨çº¿ç¨‹ä»£ç è¾¹ç•Œä¹‹å†…ï¼ˆ<code>run()</code>æ–¹æ³•å†…)è¿›è¡Œ<code>try</code> <code>catch</code>å¹¶å¤„ç†æ‰ã€‚<br>â€‹        å› æ­¤ï¼Œåœ¨threadé‡Œé¢ï¼Œå¦‚æœè¦å¤„ç†<code>checked exception</code>ï¼Œç®€å•çš„ä¸€ä¸ª <code>try/catch</code>å—å°±å¯ä»¥äº†ã€‚å¯¹äºè¿™ç§<code>unchecked exception</code>ï¼Œç›¸å¯¹æ¥è¯´å°±ä¼šæœ‰ç‚¹ä¸ä¸€æ ·ã€‚<br>è¿™æ—¶å°±è¦ç”¨åˆ° Thread é‡Œé¢çš„<code>setUncaughtExceptionHandler(UncaughtExceptionHandler)</code>ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥å¤„ç†ä¸€äº›<code>unchecked exception</code>ã€‚<code>setUncaughtExceptionHandler()</code>æ–¹æ³•ç›¸å½“äºä¸€ä¸ªäº‹ä»¶æ³¨å†Œçš„å…¥å£ã€‚åœ¨Threadç±»é‡Œé¢çš„æºç å¦‚ä¸‹:</p>
<p><img src="/image/Concurrent/Concurrent10.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent10.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>è€ŒUncaughtExceptionHandleråˆ™æ˜¯ä¸€ä¸ªæ¥å£,å®ƒçš„å£°æ˜å¦‚ä¸‹:</p>
<p><img src="/image/Concurrent/Concurrent11.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent11.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        åœ¨å¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼ å…¥çš„<code>UncaughtExceptionHandler</code>å‚æ•°çš„<code>uncaughtException</code>æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚<br>â€‹        ç»¼åˆå‰é¢çš„è®¨è®ºï¼Œæˆ‘ä»¬æŠŠè¦å®ç° <code>handle unchecked exception</code> çš„æ–¹æ³•çš„å…·ä½“æ­¥éª¤æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å®šä¹‰ä¸€ä¸ªç±»å®ç°<code>UncaughtExceptionHandler</code>æ¥å£ã€‚åœ¨å®ç°çš„æ–¹æ³•é‡ŒåŒ…å«å¯¹å¼‚å¸¸å¤„ç†çš„é€»è¾‘å’Œæ­¥éª¤ã€‚</li>
<li>å®šä¹‰çº¿ç¨‹æ‰§è¡Œç»“æ„å’Œé€»è¾‘ã€‚è¿™ä¸€æ­¥å’Œæ™®é€šçº¿ç¨‹å®šä¹‰ä¸€æ ·ã€‚</li>
<li>åœ¨åˆ›å»ºå’Œæ‰§è¡Œè¯¥å­çº¿ç¨‹çš„æ–¹æ³•ä¸­,åœ¨ <code>thread.start()</code>è¯­å¥å‰å¢åŠ ä¸€ä¸ª<code>thread.setUncaughtExceptionHandler</code>è¯­å¥æ¥å®ç°å¤„ç†é€»è¾‘çš„æ³¨å†Œã€‚</li>
</ul>
<p>â€‹        ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æŒ‰ç…§è¿™ä¸ªæ­¥éª¤æ¥å®ç°ä¸€ä¸ªç¤ºä¾‹ã€‚<br>â€‹        é¦–å…ˆæ˜¯å®ç°<code>UncaughtExceptionHandler</code>æ¥å£éƒ¨åˆ†:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No8_ExceptionHandlerThread</span> <span class="token keyword">implements</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"An exception has been captured\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread: %s\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Exception: %s: %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stack Trace: \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread status: %s\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œæˆ‘ä»¬æ·»åŠ çš„å¼‚å¸¸å¤„ç†é€»è¾‘å¾ˆç®€å•ï¼Œåªæ˜¯æŠŠçº¿ç¨‹çš„ä¿¡æ¯å’Œå¼‚å¸¸ä¿¡æ¯éƒ½æ‰“å°å‡ºæ¥ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰çº¿ç¨‹çš„å†…å®¹ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬æ•…æ„è®©è¯¥çº¿ç¨‹äº§ç”Ÿä¸€ä¸ªunchecked exception:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> number0 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">"TTT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Integer.parseInt)é‡Œé¢çš„å‚æ•°æ˜¯é”™è¯¯çš„,è‚¯å®šä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸æ¥ã€‚ç°åœ¨,æˆ‘ä»¬å†æŠŠåˆ›å»ºçº¿ç¨‹å’Œæ³¨å†Œå¤„ç†é€»è¾‘çš„éƒ¨åˆ†è¡¥ä¸Šæ¥:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">No8_ExceptionHandlerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨æˆ‘ä»¬æ‰§è¡Œæ•´ä¸ªç¨‹åº,ä¼šå‘ç°æœ‰å¦‚ä¸‹çš„ç»“æœï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">An</span> exception has been captured
<span class="token class-name">Thread</span><span class="token operator">:</span> <span class="token number">12</span>
<span class="token class-name">Exception</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NumberFormatException</span><span class="token operator">:</span> <span class="token class-name">For</span> input string<span class="token operator">:</span> <span class="token string">"TTT"</span>
<span class="token class-name">Stack</span> <span class="token class-name">Trace</span><span class="token operator">:</span> 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NumberFormatException</span><span class="token operator">:</span> <span class="token class-name">For</span> input string<span class="token operator">:</span> <span class="token string">"TTT"</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NumberFormatException</span><span class="token punctuation">.</span><span class="token function">forInputString</span><span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">65</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">580</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">615</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread<span class="token punctuation">.</span></span>No8_ExceptionHandlerThread</span>$<span class="token class-name">UseThread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">No8_ExceptionHandlerThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span class="token class-name">Thread</span> status<span class="token operator">:</span> RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿™éƒ¨åˆ†çš„è¾“å‡ºæ­£å¥½å°±æ˜¯æˆ‘ä»¬å‰é¢å®ç° UncaughtExceptionHandleræ¥å£çš„å®šä¹‰ã€‚<br>â€‹        å› æ­¤ï¼Œå¯¹äºunchecked exceptionï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼äº‹ä»¶æ³¨å†Œçš„æœºåˆ¶åšä¸€å®šç¨‹åº¦çš„å¤„ç†ã€‚å½“ç„¶ä¹Ÿå¯ä¸å¤„ç†æ”¾ä»»è‡ªç”±,è¯»è€…å¯ä»¥è¯•è¯•æ•ˆæœä»€ä¹ˆæ€ä¹ˆæ ·çš„,è¿™é‡Œä¸å®éªŒäº†ã€‚<br>â€‹        æ€»ä¹‹ï¼ŒJava thread é‡Œé¢å…³äºå¼‚å¸¸çš„éƒ¨åˆ†æ¯”è¾ƒå¥‡ç‰¹ã€‚ä½ ä¸èƒ½ç›´æ¥åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œå»æŠ›å‡ºå¼‚å¸¸ã€‚ä¸€èˆ¬åœ¨çº¿ç¨‹é‡Œç¢°åˆ°checked exceptionï¼Œæ¨èçš„åšæ³•æ˜¯é‡‡ç”¨ try&#x2F;catch å—æ¥å¤„ç†ã€‚è€Œå¯¹äºuncheckedexceptionï¼Œæ¯”è¾ƒåˆç†çš„æ–¹å¼æ˜¯æ³¨å†Œä¸€ä¸ªå®ç° UncaughtExceptionHandleræ¥å£çš„å¯¹è±¡å®ä¾‹æ¥å¤„ç†ã€‚</p>
<h4 id="No8-ExceptionHandlerThread-java"><a href="#No8-ExceptionHandlerThread-java" class="headerlink" title="No8_ExceptionHandlerThread.java"></a>No8_ExceptionHandlerThread.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No8_ExceptionHandlerThread</span> <span class="token keyword">implements</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"An exception has been captured\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread: %s\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Exception: %s: %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stack Trace: \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread status: %s\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> number0 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">"TTT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">No8_ExceptionHandlerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="Threadå®‰å…¨"><a href="#Threadå®‰å…¨" class="headerlink" title="Threadå®‰å…¨"></a>Threadå®‰å…¨</h2><p>å®‰å…¨ä¸¤å­—å¾ˆé‡è¦ï¼Œä¸èƒ½å¿˜è®°ä¹Ÿä¸èƒ½ä¸¢ã€‚ä¸‡ä¸€ä½ æŠŠå®ƒå¿˜äº†,ç¨‹åºå°±ä¼šå‡º Bug.<br><strong>é«˜å¹¶å‘ã€å¤šçº¿ç¨‹å¼€å‘çš„æ—¶å€™å¦‚ä½•ä¿è¯å®‰å…¨å’Œç¨‹åºçš„å‡†ç¡®æ€§?</strong></p>
<h3 id="åˆè¯†Javaå†…å­˜æ¨¡å‹ä¸å¤šçº¿ç¨‹"><a href="#åˆè¯†Javaå†…å­˜æ¨¡å‹ä¸å¤šçº¿ç¨‹" class="headerlink" title="åˆè¯†Javaå†…å­˜æ¨¡å‹ä¸å¤šçº¿ç¨‹"></a>åˆè¯†Javaå†…å­˜æ¨¡å‹ä¸å¤šçº¿ç¨‹</h3><p>â€‹        æƒ³è§£å†³å’Œè®¤è¯†å®‰å…¨æ€§é—®é¢˜ï¼Œå…ˆä»åŸç†ä¸Šæœ‰ä¸ªåˆæµ…çš„è®¤è¯†ã€‚<br>â€‹        ç°ä»£è®¡ç®—æœºï¼Œ<strong>CPUåœ¨è®¡ç®—çš„æ—¶å€™ï¼Œå¹¶ä¸æ€»æ˜¯ä»å†…å­˜è¯»å–æ•°æ®ï¼Œå®ƒçš„æ•°æ®è¯»å–é¡ºåºä¼˜å…ˆçº§æ˜¯:å¯„å­˜å™¨â†’é«˜é€Ÿç¼“å­˜â†’å†…å­˜</strong>ï¼Œçº¿ç¨‹è®¡ç®—çš„æ—¶å€™ï¼ŒåŸå§‹çš„æ•°æ®æ¥è‡ªå†…å­˜,åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›æ•°æ®å¯èƒ½è¢«é¢‘ç¹è¯»å–ï¼Œè¿™äº›æ•°æ®è¢«å­˜å‚¨åœ¨å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ï¼Œå½“çº¿ç¨‹è®¡ç®—å®Œåï¼Œè¿™äº›ç¼“å­˜çš„æ•°æ®åœ¨é€‚å½“çš„æ—¶å€™åº”è¯¥å†™å›å†…å­˜ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™æŸä¸ªå†…å­˜æ•°æ®æ—¶ï¼Œç”±äºæ¶‰åŠæ•°æ®çš„å¯è§æ€§ã€æ“ä½œçš„æœ‰åºæ€§ï¼Œæ‰€ä»¥å°±ä¼šäº§ç”Ÿå¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ã€‚<br>â€‹        <strong>Javaä½œä¸ºå¹³å°æ— å…³æ€§è¯­è¨€ï¼ŒJLS (Javaè¯­è¨€è§„èŒƒ)å®šä¹‰äº†ä¸€ä¸ªç»Ÿä¸€çš„å†…å­˜ç®¡ç†æ¨¡å‹<code>JMM</code> (<code>Java Memory Model</code>)ï¼Œ<code>JMM</code>å±è”½äº†åº•å±‚å¹³å°å†…å­˜ç®¡ç†ç»†èŠ‚,åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¿…é¡»è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§çš„é—®é¢˜ã€‚<code>JMM</code>è§„å®šäº†jvmæœ‰ä¸»å†…å­˜(<code>Main Memory</code>)å’Œå·¥ä½œå†…å­˜ï¼ˆ<code>Working Memory</code>)ï¼Œä¸»å†…å­˜å…¶å®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è¯´çš„Javaå †å†…å­˜ï¼Œå­˜æ”¾ç¨‹åºä¸­æ‰€æœ‰çš„ç±»å®ä¾‹ã€é™æ€æ•°æ®ç­‰å˜é‡ï¼Œæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„,è€Œå·¥ä½œå†…å­˜å­˜æ”¾çš„æ˜¯è¯¥çº¿ç¨‹ä»ä¸»å†…å­˜ä¸­æ‹·è´è¿‡æ¥çš„å˜é‡ä»¥åŠè®¿é—®æ–¹æ³•æ‰€å–å¾—çš„å±€éƒ¨å˜é‡ï¼Œæ˜¯æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„å…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œéƒ½æ˜¯ä»¥å…ˆä»ä¸»å†…å­˜å°†å…¶æ‹·è´åˆ°å·¥ä½œå†…å­˜å†å¯¹å…¶è¿›è¡Œæ“ä½œçš„æ–¹å¼è¿›è¡Œï¼Œå¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¸èƒ½ç›´æ¥äº’ç›¸ä¼ é€’æ•°æ®é€šä¿¡ï¼Œåªèƒ½é€šè¿‡å…±äº«å˜é‡æ¥è¿›è¡Œ</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent12.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent12.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        é—®é¢˜ä¸€:ç”±äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´æ˜¯ä¸èƒ½äº’ç›¸ä¼ é€’æ•°æ®é€šä¿¡çš„,å®ƒä»¬ä¹‹é—´çš„æ²Ÿé€šåªèƒ½é€šè¿‡å…±äº«å˜é‡æ¥è¿›è¡Œã€‚Javaå†…å­˜æ¨¡å‹(<code>JMM</code>ï¼‰è§„å®šäº†jvmæœ‰ä¸»å†…å­˜ï¼Œä¸»å†…å­˜æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ã€‚å½“<code>new</code>ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è¢«åˆ†é…åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜å­˜å‚¨äº†ä¸»å­˜çš„æŸäº›å¯¹è±¡çš„å‰¯æœ¬ï¼Œå½“ç„¶çº¿ç¨‹çš„å·¥ä½œå†…å­˜å¤§å°æ˜¯æœ‰é™åˆ¶çš„ã€‚å½“çº¿ç¨‹æ“ä½œæŸä¸ªå¯¹è±¡æ—¶,æ‰§è¡Œé¡ºåºå¦‚ä¸‹:</p>
<ul>
<li><strong>(1ï¼‰ä»ä¸»å­˜å¤åˆ¶å˜é‡åˆ°å½“å‰å·¥ä½œå†…å­˜ï¼ˆread and load)</strong></li>
<li><strong>(2ï¼‰æ‰§è¡Œä»£ç ,æ”¹å˜å…±äº«å˜é‡å€¼ ï¼ˆ(use and assign)</strong></li>
<li><strong>(3ï¼‰ç”¨å·¥ä½œå†…å­˜æ•°æ®åˆ·æ–°ä¸»å­˜ç›¸å…³å†…å®¹(store and writeï¼‰</strong></li>
</ul>
<p>â€‹        æ‰€ä»¥å•ä¸ªçº¿ç¨‹ä¸çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¹‹é—´å°±æœ‰äº†ç›¸äº’çš„éš”ç¦»æ•ˆæœï¼Œä¸“ä¸šæœ¯è¯­ä¸Šå°±ç§°ä¹‹ä¸ºâ€œ<strong>å¯è§æ€§é—®é¢˜</strong>â€ã€‚<br>â€‹        é—®é¢˜äºŒ:çº¿ç¨‹åœ¨å¼•ç”¨å˜é‡æ—¶ä¸èƒ½ç›´æ¥ä»ä¸»å†…å­˜ä¸­å¼•ç”¨ï¼Œå¦‚æœçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­æ²¡æœ‰è¯¥å˜é‡ï¼Œåˆ™ä¼šä»ä¸»å†…å­˜ä¸­æ‹·è´ä¸€ä¸ªå‰¯æœ¬åˆ°å·¥ä½œå†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸º<code>read-load</code>ï¼Œå®Œæˆåçº¿ç¨‹ä¼šå¼•ç”¨è¯¥å‰¯æœ¬ã€‚å½“åŒä¸€çº¿ç¨‹å†åº¦å¼•ç”¨è¯¥å­—æ®µæ—¶ï¼Œæœ‰å¯èƒ½é‡æ–°ä»ä¸»å­˜ä¸­è·å–å˜é‡å‰¯æœ¬(<code>read-load-use</code>)ï¼Œä¹Ÿæœ‰å¯èƒ½ç›´æ¥å¼•ç”¨åŸæ¥çš„å‰¯æœ¬ï¼ˆ<code>use</code>)ï¼Œä¹Ÿå°±æ˜¯è¯´<code>read</code>ã€<code>load</code>ã€<code>use</code>é¡ºåºå¯ä»¥ç”±<code>JVM</code>å®ç°ç³»ç»Ÿå†³å®šã€‚è¿™ä¸ªæ—¶å€™çº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„æ“ä½œçš„å…ˆåé¡ºåºï¼Œå°±ä¼šå†³å®šäº†ä½ ç¨‹åºå¯¹ä¸»å†…å­˜åŒºæœ€åçš„ä¿®æ”¹æ˜¯ä¸æ˜¯æ­£ç¡®çš„ï¼Œä¸“ä¸šæœ¯è¯­ä¸Šå°±ç§°ä¹‹ä¸ºâ€œ<strong>æ—¶åºæ€§é—®é¢˜</strong>â€ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯ä¸å®‰å…¨"><a href="#ä»€ä¹ˆæ˜¯ä¸å®‰å…¨" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸å®‰å…¨"></a>ä»€ä¹ˆæ˜¯ä¸å®‰å…¨</h3><p>â€‹        å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªæ•°æ®ç»“æ„çš„æ—¶å€™äº§ç”Ÿäº†ç›¸äº’ä¿®æ”¹å’Œä¸²è¡Œçš„æƒ…å†µï¼Œæ²¡æœ‰ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§,æˆ‘ä»¬é€šå¸¸ç§°è¿™ç§è®¾è®¡çš„ä»£ç ä¸ºâ€œ<strong>çº¿ç¨‹ä¸å®‰å…¨çš„</strong>â€ã€‚<br>â€‹        æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œå‡è®¾5ä¸ªç”¨æˆ·ï¼Œéƒ½æ¥ç»™ä¸€ä¸ªæ•°å­—åŠ 1çš„å·¥ä½œï¼Œé‚£ä¹ˆæœ€ååº”è¯¥æ˜¯å¾—åˆ°åŠ 5çš„ç»“æœï¼›çœ‹ä¸€ä¸‹ä¸‹é¢çš„äº‹ä¾‹ã€‚<br>â€‹        å•ä¸ªç”¨æˆ·å¹²æ´»ç±»ï¼šCount ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
            num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ç”¨æˆ·ç±»ï¼Œå¹²Countçš„æ´»ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        count<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        5ä¸ªäººå¹²å®Œæ´»:æœ€åçš„å€¼ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Count</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰5ä¸ªäººå¹²å®Œæ´»</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"5ä¸ªäººå¹²å®Œæ´»:æœ€åçš„å€¼"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿è¡Œç»“æœ-ç”±äºå¤šçº¿ç¨‹ï¼Œæœ‰ä¸å®‰å…¨é—®é¢˜ï¼Œå…¶å®æ¯æ¬¡è¿è¡Œä¸‹é¢çš„ç»“æœéƒ½æ˜¯ä¸ä¸€æ ·çš„ ):</p>
<p>â€‹        <strong>å¯è§ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œè¿™å°±æ˜¯å…¸å‹çš„çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ã€‚</strong>åœ¨æˆ‘ä»¬å®é™…å·¥ä½œä¸­ï¼Œç‰¹åˆ«æ˜¯Webé¡¹ç›®Serviceå’Œ servletä¸€èˆ¬éƒ½æ˜¯å•ä¾‹å…±äº«å˜é‡çš„æƒ…å†µä¸‹æå…¶å®¹æ˜“å‡ºç°ï¼Œå¤šä¸ªç”¨æˆ·ä¹‹é—´çš„æ•°æ®ä¸²æ‰äº†ï¼Œä»è€Œå¯¼è‡´æœ€ç»ˆæ•°æ®åº“é‡Œé¢æ‰€éœ€è¦ç»Ÿè®¡çš„æ•°æ®ä¸å¯¹ã€‚</p>
<h4 id="No1-ThreadSecurityDemo-java"><a href="#No1-ThreadSecurityDemo-java" class="headerlink" title="No1_ThreadSecurityDemo.java"></a>No1_ThreadSecurityDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_ThreadSecurityDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
            num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Count</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰5ä¸ªäººå¹²å®Œæ´»</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"5ä¸ªäººå¹²å®Œæ´»:æœ€åçš„å€¼"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="ä»€ä¹ˆæ˜¯å®‰å…¨"><a href="#ä»€ä¹ˆæ˜¯å®‰å…¨" class="headerlink" title="ä»€ä¹ˆæ˜¯å®‰å…¨"></a>ä»€ä¹ˆæ˜¯å®‰å…¨</h3><p>æˆ‘ä»¬æŠŠä¸Šä¸€èŠ‚çš„ä¾‹å­å•ä¸ªç”¨æˆ·å¹²æ´»ç±» Count çš„ <code>add()</code> æ–¹æ³•,æ·»åŠ  <code>synchronized</code>å…³é”®å­—ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
            num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">3</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">4</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>
<span class="token number">5</span>ä¸ªäººå¹²å®Œæ´»<span class="token operator">:</span>æœ€åçš„å€¼<span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è€Œè¿™æ¬¡ï¼Œæ¯æ¬¡å¹²æ´»éƒ½æ˜¯ä¸€æ ·çš„ç»“æœï¼Œè¿™å°±å«çº¿ç¨‹å®‰å…¨ï¼Œå°±æ˜¯ä¸ç®¡å¤šå°‘ä¸ªç”¨æˆ·è¿‡æ¥ï¼Œéƒ½ä¿è¯æˆ‘ä»¬çš„æ•°æ®çš„é«˜åº¦ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§å°±å«çº¿ç¨‹å®‰å…¨çš„ï¼›è¿™é‡Œæˆ‘ä»¬å¼•ç”¨äº†<code>synchronized</code> çš„åŒæ­¥é”çš„æœºåˆ¶,è¿™ä¸ªåé¢ä¼šè®²åˆ°ï¼Œå®ƒä¿è¯äº†æˆ‘ä»¬çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚<br>â€‹        ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨æ€§å‘¢ï¼Ÿæ˜¯ä¸æ˜¯ä¸€å®šè¦åŠ é”æ‰æ˜¯çº¿ç¨‹å®‰å…¨æ€§çš„å‘¢ï¼Ÿä¸ªäººæ„Ÿè§‰åªè¦ä½ ä»£ç é‡Œé¢æ²¡æœ‰å˜é‡äº’ä¸²ï¼Œçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ï¼Œä¾‹å¦‚ server çš„è®¾è®¡æ–¹æ³•,å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„,ä¾‹å¦‚ä¸Šé¢5ä¸ªäººå¹²äº†åŒä¸€ä»¶äº‹æƒ…ï¼Œå¦‚æœè®©5ä¸ªäººå¹²5ä»¶ä¸ä¸€æ ·çš„äº‹æƒ…ï¼Œæˆ–è€…1ä¸ªäººå¹²5ä»¶äº‹æƒ…ï¼Œé‚£ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚è€Œä¸å®‰å…¨åœ¨Java å·¥ä½œä¸­ä¸»è¦é’ˆå¯¹å•ä¾‹æ¨¡å¼çš„åº”ç”¨è€Œè¨€çš„ï¼Œæ€ä¹ˆä¿è¯ä¸€ä»¶äº‹æƒ…è¢«ä¸€ç¾¤äººå¹²å®Œï¼Œåˆå¿«åˆæ­£ç¡®ã€‚<br>â€‹        æƒ³å®ç°çº¿ç¨‹å®‰å…¨å¤§è‡´æœ‰ä¸‰ç§æ–¹æ³•ã€‚</p>
<ul>
<li>å¤šå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨å•ä¾‹æ¨¡å¼äº†ã€‚</li>
<li>ä½¿ç”¨<code>java.util.concurrent</code>ä¸‹é¢çš„ç±»åº“ã€‚</li>
<li>ä½¿ç”¨é”æœºåˆ¶<code>synchronized</code>ã€<code>lock</code>æ–¹å¼ã€‚</li>
</ul>
<h3 id="éšå¼é”-å†…ç½®é”-ï¼Œåˆç§°çº¿ç¨‹åŒæ­¥-synchronized"><a href="#éšå¼é”-å†…ç½®é”-ï¼Œåˆç§°çº¿ç¨‹åŒæ­¥-synchronized" class="headerlink" title="éšå¼é”(å†…ç½®é”)ï¼Œåˆç§°çº¿ç¨‹åŒæ­¥ synchronized"></a>éšå¼é”(å†…ç½®é”)ï¼Œåˆç§°çº¿ç¨‹åŒæ­¥ synchronized</h3><p>â€‹        <code>synchronized</code>æ˜¯Javaè¯­è¨€çš„å…³é”®å­—ï¼Œå½“å®ƒç”¨æ¥ä¿®é¥°ä¸€ä¸ªæ–¹æ³•æˆ–è€…ä¸€ä¸ªä»£ç å—çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¿è¯åœ¨åŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ®µä»£ç ã€‚å…¶å®ç®€å•ä¸€ç‚¹ç†è§£ï¼Œæˆ‘æ„Ÿè§‰å°±æ˜¯è¦è§£å†³æˆ‘ä»¬å‰é¢è¯´çš„å¤šçº¿ç¨‹å¹¶å‘æ—¶å€™çš„â€œ<strong>æ—¶åºæ€§é—®é¢˜</strong>â€ï¼Œå³è®¿é—®è¦æœ‰ä¸€ä¸ªé¡ºåºï¼Œè®²ç©¶å…ˆæ¥ååˆ°ï¼Œå°±çœ‹è°å…ˆèƒ½æ‹¿åˆ°è¿™ä¸ªé”å¯¹è±¡ã€‚<br>â€‹        <code>synchronized</code>çš„ç”¨æ³•,ä¿®é¥°åœ°æ–¹æœ‰åªæœ‰ä¸¤ä¸ªï¼š<br>â€‹        ä¸€æ˜¯åœ¨æ–¹æ³•å£°æ˜æ—¶ä½¿ç”¨ï¼Œæ”¾åœ¨èŒƒå›´æ“ä½œç¬¦(public ç­‰)ä¹‹åï¼Œè¿”å›ç±»å‹å£°æ˜(voidç­‰)ä¹‹å‰çš„æ–¹æ³•åä¸Šé¢,ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">synMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//æ–¹æ³•ä½“</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        äºŒæ˜¯ä¿®é¥°åœ¨ä»£ç å—ä¸Šé¢çš„ï¼Œå¯¹æŸä¸€ä»£ç å—ä½¿ç”¨<code>synchronized(Object)</code>ï¼ŒæŒ‡å®šåŠ é”å¯¹è±¡ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> synMethod <span class="token punctuation">(</span><span class="token keyword">int</span> al<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å…¶ä¸­ synchronized(Object)ä¸­çš„ Object å¯ä»¥æ˜¯ä»»æ„å¯¹è±¡,å¯ä»¥æ˜¯å‚æ•°æœ¬èº«ï¼Œå¯ä»¥æ˜¯å½“å‰å¯¹è±¡this,ä¹Ÿå¯ä»¥æ˜¯æŒ‡å®šçš„å¯¹è±¡ï¼›ä½œè€…ä¸å»ºè®®ä½¿ç”¨æ–¹æ³•å‚æ•°ï¼Œä¹Ÿä¸å»ºè®®ä½¿ç”¨thiså¯¹è±¡ï¼Œè€Œæ˜¯å¦å¤–æŒ‡å®šä¸€ä¸ªå°çš„å¯¹è±¡å€¼ã€‚å¾ˆå¤šèµ„æ–™å’Œæ–‡æ¡£éƒ½ç§°å®ƒä¸ºåŒæ­¥é”ï¼Œè€Œæˆ‘æ›´æ„¿æ„å«å®ƒéšå¼é”ã€‚å› ä¸ºå°½ç®¡å®ƒä¿®é¥°çš„åœ°æ–¹ä¸å°½ç›¸åŒï¼Œä½†æ˜¯æœ€ç»ˆå®ƒçš„é”éƒ½åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šé¢ï¼›ä¿®é¥°åœ¨æ–¹æ³•ä½“ä¸Šçš„synchronized é»˜è®¤é”çš„å¯¹è±¡å°±æ˜¯å½“å‰å¯¹è±¡æœ¬èº«ï¼›ç­‰åŒäºsynchronized (this)(}ä¿®é¥°ä»£ç å—çš„ç”¨æ³•ï¼›æˆ–è€…æ˜¯ä½ æŒ‡å®šçš„ Objectå¯¹è±¡ä½œä¸ºé”ï¼Œå› ä¸ºå’Œå®ƒæŒæœ‰ç›¸åŒå¯¹è±¡é”çš„åœ°æ–¹å°†äº§ç”Ÿäº’æ–¥æ€§ï¼Œè€Œä¸æ˜¯åªæœ‰å½“å‰æ‰€æŒ‡çš„ä»£ç å—æˆ–è€…æ–¹æ³•ä½“ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ç›¸å¯¹æ˜¾ç¤ºé”ä¸éœ€è¦åŠ é”å’Œè§£é”çš„æ“ä½œï¼Œæ‰€ä»¥ç§°å®ƒä¸ºéšå¼çš„ã€‚<br>â€‹        æœ‰ä¸€äº›éšå¼è§„åˆ™å¦‚ä¸‹:<br>â€‹        (1)å½“ä¸¤ä¸ªå¹¶å‘çº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡objectä¸­çš„è¿™ä¸ªsynchronized(this)åŒæ­¥ä»£ç å—æ—¶ï¼Œä¸€ä¸ªæ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°æ‰§è¡Œã€‚å¦ä¸€ä¸ªçº¿ç¨‹å¿…é¡»ç­‰å¾…å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œè¿™ä¸ªä»£ç å—ä»¥åæ‰èƒ½æ‰§è¡Œè¯¥ä»£ç å—ã€‚<br>â€‹        (2ï¼‰ç„¶è€Œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®object çš„ä¸€ä¸ªsynchronized(this)åŒæ­¥ä»£ç å—æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»ç„¶å¯ä»¥è®¿é—®è¯¥object ä¸­çš„ésynchronized(this)åŒæ­¥ä»£ç å—ã€‚<br>â€‹        (3ï¼‰å°¤å…¶å…³é”®çš„æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®objectçš„ä¸€ä¸ªsynchronized(this)åŒæ­¥ä»£ç å—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯¹objectä¸­æ‰€æœ‰å…¶ä»–synchronized(this)åŒæ­¥ä»£ç å—çš„è®¿é—®å°†è¢«é˜»å¡ã€‚<br>â€‹        (4ï¼‰ç¬¬ä¸‰ä¸ªè§„åˆ™åŒæ ·é€‚ç”¨å…¶ä»–åŒæ­¥ä»£ç å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®object çš„ä¸€ä¸ªsynchronized(this)åŒæ­¥ä»£ç å—æ—¶ï¼Œå®ƒå°±è·å¾—äº†è¿™ä¸ªobject çš„å¯¹è±¡é”ã€‚ç»“æœï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥objectå¯¹è±¡æ‰€æœ‰åŒæ­¥ä»£ç éƒ¨åˆ†çš„è®¿é—®éƒ½è¢«æš‚æ—¶é˜»å¡ã€‚<br>â€‹        (5)ä»¥ä¸Šè§„åˆ™å¯¹å…¶ä»–å¯¹è±¡é”åŒæ ·é€‚ç”¨ã€‚</p>
<p>â€‹        ä¸‹é¢ä¸¾ä¾‹åŠ ä»¥è¯´æ˜:<br>â€‹        çœ‹ä¸€ä¸ªæ­£ç¡®çš„ä¾‹å­:å°½ç®¡<code>synchronized</code>çš„å†™æ³•ä¸ä¸€æ ·,ä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•å¯¹äºå¤šçº¿ç¨‹æ¥è¯´æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h4 id="No2-SynchronizedExampleOne-java"><a href="#No2-SynchronizedExampleOne-java" class="headerlink" title="No2_SynchronizedExampleOne.java"></a>No2_SynchronizedExampleOne.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_SynchronizedExampleOne</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
            num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">&#125;</span>
                num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count<span class="token punctuation">.</span><span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Count</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰5ä¸ªäººå¹²å®Œæ´»</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"5ä¸ªäººå¹²å®Œæ´»:æœ€åçš„å€¼"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        çœ‹ä¸€ä¸ªé”™è¯¯çš„ä¾‹å­:</p>
<h4 id="No2-SynchronizedExampleTwo-java"><a href="#No2-SynchronizedExampleTwo-java" class="headerlink" title="No2_SynchronizedExampleTwo.java"></a>No2_SynchronizedExampleTwo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_SynchronizedExampleTwo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
            num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ³¨æ„è¿™ä¸ªé”çš„å¯¹è±¡ä¸ä¸€æ ·</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">&#125;</span>
                num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UseThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count<span class="token punctuation">.</span><span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Count</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UseThread</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UseThread</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰5ä¸ªäººå¹²å®Œæ´»</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"5ä¸ªäººå¹²å®Œæ´»:æœ€åçš„å€¼"</span> <span class="token operator">+</span> count<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <strong>ä¸ºä»€ä¹ˆè¯´è¿™ä¸¤ä¸ªæ–¹æ³•å¯¹äºå¤šçº¿ç¨‹æ¥è¯´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„å‘¢?å› ä¸ºå®ƒé”å®šçš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä½œè€…ä¸å»ºè®®ç”¨å‚æ•°ä½œä¸ºé”çš„å¯¹è±¡ï¼Œé‚£æ ·å­,ä½ çš„åŒæ­¥é”åªä¼šå¯¹è¿™ä¸ªæ–¹æ³•æœ‰ç”¨ï¼Œè€Œå¤±å»äº†<code>synchronized</code>é”å®šå¯¹è±¡çš„æ„ä¹‰äº†ã€‚</strong><br>â€‹        ä¸ºé€‚ç”¨é«˜å¹¶å‘å¯¹æ€§èƒ½ä»¥åŠå¿«é€Ÿå“åº”çš„è¦æ±‚ï¼Œ<code>synchronized</code>ä¸åŒçš„å†™æ³•ç¨‹åºå“åº”çš„å¿«æ…¢å’Œå¯¹CPUç­‰èµ„æºé«˜å¹¶å‘çš„åˆ©ç”¨ç¨‹åº¦åˆä¸ä¸€æ ·ï¼›æ€§èƒ½å’Œæ‰§è¡Œæ•ˆç‡çš„ä¼˜åŠ£ç¨‹åº¦ä»å·®åˆ°ä¼˜æœ‰å¦‚ä¸‹æ’åº:<br>â€‹        åŒæ­¥æ–¹æ³•ä½“</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">synMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//æ–¹æ³•ä½“</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å°äº</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">synMethod</span><span class="token punctuation">(</span><span class="token keyword">int</span> al<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å› ä¸ºä¸€ä¸ªæ˜¯è¿›å…¥æ–¹æ³•ä½“å†…åŠ é”çš„ï¼Œä¸€ä¸ªæ˜¯æ’é˜Ÿåœ¨æ–¹æ³•ä½“å¤–ï¼Œè¿™æ ·å³ä½¿è·å¾—äº†é”ï¼Œè¿›å…¥æ–¹æ³•ä½“è¿˜å¾—åˆ†é…èµ„æºéœ€è¦ä¸€å®šçš„æ—¶é—´ã€‚<br>â€‹        è€Œè¿™ç§æ–¹æ³•å—é”åˆå°äºä¸‹é¢çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">byte</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> lock <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//æ³¨æ„è¿™ä¸ªé”çš„å¯¹è±¡ä¸ä¸€æ ·</span>
    <span class="token comment">//TODO</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å› ä¸ºé”çš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œé”æ˜¯å¯¹è±¡ï¼ŒåŠ é”å’Œé‡Šæ”¾é”éƒ½éœ€è¦æ­¤å¯¹è±¡çš„èµ„æºï¼Œé‚£è‚¯å®šå¯¹è±¡è¶Šå°è¶Šå¥½å•Šï¼Œæ‰€ä»¥é€ ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„byteå¯¹è±¡æœ€å°ï¼›æ‰€ä»¥å·¥ä½œä¸­è¿™ç§å†™æ³•æœ€å¸¸è§ã€‚</p>
<blockquote>
<h4 id="synchronizedå†…ç½®é”"><a href="#synchronizedå†…ç½®é”" class="headerlink" title="synchronizedå†…ç½®é”"></a>synchronizedå†…ç½®é”</h4><p>å¯¹è±¡é”ï¼Œé”çš„æ˜¯ç±»çš„å¯¹è±¡å®ä¾‹ã€‚</p>
<p>ç±»é” ï¼Œé”çš„æ˜¯æ¯ä¸ªç±»çš„çš„Classå¯¹è±¡ï¼Œæ¯ä¸ªç±»çš„çš„Classå¯¹è±¡åœ¨ä¸€ä¸ªè™šæ‹Ÿæœºä¸­åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ç±»é”ä¹Ÿåªæœ‰ä¸€ä¸ªã€‚</p>
</blockquote>
<h3 id="æ˜¾ç¤ºé”Lockå’ŒReentrantLock"><a href="#æ˜¾ç¤ºé”Lockå’ŒReentrantLock" class="headerlink" title="æ˜¾ç¤ºé”Lockå’ŒReentrantLock"></a>æ˜¾ç¤ºé”Lockå’ŒReentrantLock</h3><p>â€‹        Lockæ˜¯ä¸€ä¸ªæ¥å£æä¾›äº†æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ã€å®šæ—¶çš„ã€å¯ä¸­æ–­çš„é”è·å–æ“ä½œï¼Œæ‰€æœ‰åŠ é”å’Œè§£é”çš„æ–¹æ³•éƒ½æ˜¯æ˜¾å¼çš„ã€‚åŒ…è·¯å¾„æ˜¯:<code> java.util.concurrent.locks.Lock</code>ã€‚æ ¸å¿ƒæ–¹æ³•æ˜¯<code>lock()</code>ã€<code>unlock()</code>ã€<code>tryLock()</code>,å®ç°ç±»æœ‰<code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock.ReadLock</code>ã€ <code>ReentrantReadWriteLock.WriteLock</code><br>â€‹        çœ‹ä¸€ä¸‹Lockæ¥å£æœ‰å¦‚ä¸‹æ–¹æ³•:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 æ²¡æœ‰å—ç»“æ„åŒ–é”å®šä¼šåˆ é™¤ä½¿ç”¨synchronizedæ–¹æ³•å’Œè¯­å¥å‘ç”Ÿçš„é”çš„è‡ªåŠ¨é‡Šæ”¾ã€‚ 
 åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ä½¿ç”¨ä»¥ä¸‹æƒ¯ç”¨è¯­ï¼š
   Lock l = ...; 
   l.lock(); 
   try &#123; 
   		// access the resource protected by this lock 
   &#125; finally &#123;
    	l.unlock(); 
   &#125; 
å½“åœ¨ä¸åŒèŒƒå›´å†…å‘ç”Ÿé”å®šå’Œè§£é”æ—¶ï¼Œå¿…é¡»æ³¨æ„ç¡®ä¿åœ¨é”å®šæ—¶æ‰§è¡Œçš„æ‰€æœ‰ä»£ç ç”±try-finallyæˆ–try-catchä¿æŠ¤ï¼Œä»¥ç¡®ä¿åœ¨å¿…è¦æ—¶é‡Šæ”¾é”å®šã€‚
Lockå®ç°æä¾›äº†ä½¿ç”¨synchronizedæ–¹æ³•å’Œè¯­å¥çš„é™„åŠ åŠŸèƒ½ï¼Œ
é€šè¿‡æä¾›éé˜»å¡å°è¯•æ¥è·å–é”ï¼ˆtryLock()ï¼‰ï¼Œ
å°è¯•è·å–å¯è¢«ä¸­æ–­çš„é”ï¼ˆlockInterruptibly()ï¼‰ï¼Œ
ä»¥åŠå°è¯•è·å–å¯ä»¥è¶…æ—¶ï¼ˆtryLock(long, TimeUnit)ï¼‰ã€‚
*/</span>
<span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Lock</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//è·å¾—é”ã€‚ å¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ä»¥è¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å–é”ã€‚</span>
    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è·å–é”å®šï¼Œé™¤éå½“å‰çº¿ç¨‹æ˜¯ interrupted ã€‚</span>
    <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token comment">/*åªæœ‰åœ¨è°ƒç”¨æ—¶æ‰å¯ä»¥è·å¾—é”ã€‚åªæœ‰åœ¨è°ƒç”¨æ—¶æ‰å¯ä»¥è·å¾—é”ã€‚
   å¦‚æœå¯ç”¨ï¼Œåˆ™è·å–é”å®šï¼Œå¹¶ç«‹å³è¿”å›å€¼ä¸ºtrue ã€‚ å¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™æ­¤æ–¹æ³•å°†ç«‹å³è¿”å›å€¼ä¸ºfalse ã€‚
æ­¤æ–¹æ³•çš„å…¸å‹ç”¨æ³•æ˜¯ï¼š
   Lock lock = ...; 
   if (lock.tryLock()) &#123;
   		try &#123; 
   			// manipulate protected state 
   		&#125; finally &#123; 
   		lock.unlock(); 
   		&#125; 
   	&#125; else &#123; // perform alternative actions &#125; 
æ­¤ç”¨æ³•å¯ç¡®ä¿é”å®šå·²è¢«å–æ¶ˆï¼Œå¦‚æœæœªè·å–é”å®šï¼Œåˆ™ä¸ä¼šå°è¯•è§£é”*/</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å¦‚æœåœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´å†…æ˜¯ç©ºé—²çš„ï¼Œå¹¶ä¸”å½“å‰çš„çº¿ç¨‹å°šæœªå¾—åˆ° interruptedï¼Œåˆ™è·å–è¯¥é”ã€‚</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token comment">//é‡Šæ”¾é”ã€‚</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è¿”å›ä¸€ä¸ªæ–°Conditionç»‘å®šåˆ°è¯¥å®ä¾‹Lockå®ä¾‹ã€‚è¿”å›ä¸€ä¸ªæ–°Conditionç»‘å®šåˆ°è¯¥å®ä¾‹Lockå®ä¾‹ã€‚</span>
	<span class="token comment">//åœ¨ç­‰å¾…æ¡ä»¶ä¹‹å‰ï¼Œé”å¿…é¡»ç”±å½“å‰çº¿ç¨‹ä¿æŒã€‚ å‘¼å«Condition.await()å°†åœ¨ç­‰å¾…ä¹‹å‰å°†åŸå­é‡Šæ”¾é”ï¼Œå¹¶åœ¨ç­‰å¾…è¿”å›ä¹‹å‰é‡æ–°è·å–é”ã€‚</span>
    <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯¹åº”çš„è§£è¯´å¦‚ä¸‹:<br>        <code>void lock()</code>;è·å–é”ã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œå‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„,å°†ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨è·å¾—é”ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å°†ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€ã€‚<br>        <code>void lockInterruptibly( throws InterruptedException</code>;å¦‚æœå½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™è·å–é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œåˆ™è·å–é”ï¼Œå¹¶ç«‹å³è¿”å›ã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œå‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå°†ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ä»¥å‰ï¼Œè¯¥çº¿ç¨‹å°†ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€:é”ç”±å½“å‰çº¿ç¨‹è·å¾—;æˆ–è€…å…¶ä»–æŸä¸ªçº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”æ”¯æŒå¯¹é”è·å–çš„ä¸­æ–­ã€‚å¦‚æœå½“å‰çº¿ç¨‹:åœ¨è¿›å…¥æ­¤æ–¹æ³•æ—¶å·²ç»è®¾ç½®äº†è¯¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€;æˆ–è€…åœ¨è·å–é”æ—¶è¢«ä¸­æ–­,å¹¶ä¸”æ”¯æŒå¯¹é”è·å–çš„ä¸­æ–­ï¼Œåˆ™å°†æŠ›å‡º <code>InterruptedException</code> ,å¹¶æ¸…é™¤å½“å‰çº¿ç¨‹çš„å·²ä¸­æ–­çŠ¶æ€ã€‚<br>        <code>boolean tryLock()</code>;ä»…åœ¨è°ƒç”¨æ—¶é”ä¸ºç©ºé—²çŠ¶æ€æ‰è·å–è¯¥é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œåˆ™è·å–é”ï¼Œå¹¶ç«‹å³è¿”å›å€¼ trueã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™æ­¤æ–¹æ³•å°†ç«‹å³è¿”å›å€¼ falseã€‚é€šå¸¸å¯¹äºé‚£äº›ä¸æ˜¯å¿…é¡»è·å–é”çš„æ“ä½œå¯èƒ½æœ‰ç”¨ã€‚<br>        <code>boolean tryLock(long ParamLong, TimeUnit ParamTimeUnit) throws InterruptedException</code>;å¦‚æœé”åœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´å†…ç©ºé—²ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™è·å–é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œåˆ™æ­¤æ–¹æ³•å°†ç«‹å³è¿”å›å€¼true ã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œå‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå°†ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿä»¥ä¸‹ä¸‰ç§æƒ…å†µçš„ä»»ä¸€ç§ä¹‹å‰,è¯¥çº¿ç¨‹å°†ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€:<br>        <code>void unlock()</code>;é‡Šæ”¾é”ã€‚å¯¹åº”äº<code>lock()</code>ã€<code>tryLock()</code>ã€<code>tryLock(xx)</code>ã€<code>lockInterruptibly()</code>ç­‰æ“ä½œï¼Œå¦‚æœæˆåŠŸçš„è¯åº”è¯¥å¯¹åº”ç€ä¸€ä¸ªunlock()ï¼Œè¿™æ ·å¯ä»¥é¿å…æ­»é”æˆ–è€…èµ„æºæµªè´¹ã€‚<br>        <code>new Condition()</code>;è¿”å›ç”¨æ¥ä¸æ­¤<code>Lock</code> å®ä¾‹ä¸€èµ·ä½¿ç”¨çš„ <code>Condition</code>å®ä¾‹ã€‚</p>
<p>â€‹       <code>ReentrantLock</code>æ˜¯<code>Lock</code>çš„å®ç°ç±»,æ˜¯ä¸€ä¸ªäº’æ–¥çš„åŒæ­¥å™¨ï¼Œå®ƒå…·æœ‰æ‰©å±•çš„èƒ½åŠ›ã€‚åœ¨ç«äº‰æ¡ä»¶ä¸‹ï¼Œ<code>ReentrantLock</code> çš„å®ç°è¦æ¯”ç°åœ¨çš„<code>synchronized</code>å®ç°æ›´å…·æœ‰å¯ä¼¸ç¼©æ€§ã€‚(æœ‰å¯èƒ½åœ¨JVM çš„å°†æ¥ç‰ˆæœ¬ä¸­æ”¹è¿› synchronized çš„ç«äº‰æ€§èƒ½ï¼‰è¿™æ„å‘³ç€å½“è®¸å¤šçº¿ç¨‹éƒ½ç«äº‰ç›¸åŒé”å®šæ—¶,ä½¿ç”¨<code>ReentrantLock</code>çš„ååé‡é€šå¸¸è¦æ¯”synchronized å¥½ã€‚æ¢å¥è¯è¯´ï¼Œå½“è®¸å¤šçº¿ç¨‹è¯•å›¾è®¿é—®<code>ReentrantLock</code> ä¿æŠ¤çš„å…±äº«èµ„æºæ—¶ï¼Œ<code>JVM</code> å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œè€Œç”¨æ›´å¤šä¸ªæ—¶é—´æ‰§è¡Œçº¿ç¨‹ã€‚è™½ç„¶<code>ReentrantLock</code>ç±»æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œä½†æ˜¯ä¸åŒæ­¥ç›¸æ¯”ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸»è¦ç¼ºç‚¹ï¼šå®ƒå¯èƒ½å¿˜è®°é‡Šæ”¾é”å®šã€‚<code>ReentrantLock</code>æ˜¯åœ¨å·¥ä½œä¸­å¯¹æ–¹æ³•å—åŠ é”ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„ã€‚<br>â€‹        ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">X</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—é”</span>
		<span class="token keyword">try</span><span class="token punctuation">&#123;</span>
			<span class="token comment">// ...æ–¹æ³•ä½“</span>
		<span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
			lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§£é”</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <code>Lock</code> ä¸ <code>synchronized</code> çš„æ¯”è¾ƒ:</p>
<p>â€‹        (1)<code>Lock</code>ä½¿ç”¨èµ·æ¥æ¯”è¾ƒçµæ´»ï¼Œä½†æ˜¯å¿…é¡»æœ‰é‡Šæ”¾é”çš„åŠ¨ä½œé…åˆã€‚<br>â€‹        (2)<code>Lock</code>å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾å’Œå¼€å¯é”,è€Œ<code>synchronized</code>ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å’Œå¼€å¯é”ã€‚<br>â€‹        (3)<code>Lock</code> åªé€‚ç”¨ä¸ä»£ç å—é”,è€Œ<code>synchronized</code>å¯¹è±¡ä¹‹é—´æ˜¯äº’æ–¥å…³ç³»ã€‚</p>
<p>â€‹        è¯·æ³¨æ„ä»¥ä¸‹ä¸¤ç§æ–¹å¼çš„åŒºåˆ«:<br>â€‹        ç¬¬ä¸€ç§æ–¹å¼:ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´çš„é”æ˜¯ç‹¬ç«‹çš„ã€‚ä»£ç å¦‚ä¸‹:</p>
<h4 id="No3-ReentrantLockDemo-java"><a href="#No3-ReentrantLockDemo-java" class="headerlink" title="No3_ReentrantLockDemo.java"></a>No3_ReentrantLockDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_ReentrantLockDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Countx</span> ct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Countx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Countx</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        final ReentrantLock lock = new ReentrantLock();</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åŠ é”</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"get begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿å¹²æ´»</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"get end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è§£é”</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åŠ é”</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"put begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿å¹²æ´»</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"put end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è§£é”</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿è¡Œç»“æœå¦‚ä¸‹(æ¯æ¬¡è¿è¡Œç»“æœéƒ½æ˜¯ä¸ä¸€æ ·çš„,ä»”ç»†ä½“ä¼šä¸€ä¸‹):</p>
<p>â€‹        ç¬¬äºŒç§æ–¹å¼,ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´ä½¿ç”¨ç›¸åŒçš„é”ã€‚<br>â€‹        <code>ReentrantLockDemo</code>ç±»çš„å†…å®¹ä¸å˜,å°†<code>Count </code>ä¸­çš„<code>ReentrantLock</code> æ”¹æˆå…¨å±€å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/image/Concurrent/Concurrent13.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent13.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹(æ¯æ¬¡è¿è¡Œç»“æœæ˜¯ä¸€æ ·çš„,ä»”ç»†ä½“ä¼šä¸€ä¸‹):</p>
<h3 id="æ˜¾ç¤ºé”ReadWriteLockå’Œ-ReentrantReadWriteLock"><a href="#æ˜¾ç¤ºé”ReadWriteLockå’Œ-ReentrantReadWriteLock" class="headerlink" title="æ˜¾ç¤ºé”ReadWriteLockå’Œ ReentrantReadWriteLock"></a>æ˜¾ç¤ºé”ReadWriteLockå’Œ ReentrantReadWriteLock</h3><p>â€‹        <code>ReadWriteLock</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†<code>readLock</code>å’Œ <code>writeLock</code>ä¸¤ç§é”çš„æ“ä½œæœºåˆ¶,ä¹Ÿå°±æ˜¯ä¸€ä¸ªèµ„æºèƒ½å¤Ÿè¢«å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œæˆ–è€…è¢«ä¸€ä¸ªå†™çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯ä¸èƒ½åŒæ—¶å­˜åœ¨è¯»å†™çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´è¯»å†™é”ä½¿ç”¨çš„åœºåˆæ˜¯ä¸€ä¸ªå…±äº«èµ„æºè¢«å¤§é‡è¯»å–æ“ä½œï¼Œè€Œåªæœ‰å°‘é‡çš„å†™æ“ä½œã€‚åŒ…è·¯å¾„æ˜¯<code>java.util.concurrent.locks.ReadWriteLock</code>ã€‚<br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>ReadWriteLock</code>çš„æºç ;</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReadWriteLock</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">Lock</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Lock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»æºç ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥<code>ReadWriteLock</code>å¹¶ä¸æ˜¯<code>Lock</code> çš„å­æ¥å£,åªä¸è¿‡<code>ReadWriteLock</code>å€ŸåŠ©<code>Lock</code>æ¥å®ç°è¯»å†™ä¸¤ä¸ªé”å¹¶å­˜ã€äº’æ–¥çš„æ“ä½œæœºåˆ¶ã€‚åœ¨<code>ReadWriteLock</code>ä¸­æ¯æ¬¡è¯»å–å…±äº«æ•°æ®å°±éœ€è¦è¯»å–é”ï¼Œå½“éœ€è¦ä¿®æ”¹å…±äº«æ•°æ®æ—¶å°±éœ€è¦å†™å…¥é”ã€‚çœ‹èµ·æ¥å¥½åƒæ˜¯ä¸¤ä¸ªé”ï¼Œä½†æ˜¯å¹¶éå¦‚æ­¤ã€‚<br>â€‹        <code>ReentrantReadWriteLock</code>æ˜¯<code>ReadWriteLock</code>åœ¨<code>java.util</code>é‡Œé¢çš„å”¯ä¸€çš„å®ç°ç±»ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯å½“æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½ä»æŸä¸ªæ•°æ®ç»“æ„ä¸­è¯»å–æ•°æ®ï¼Œè€Œå¾ˆå°‘æœ‰çº¿ç¨‹å¯¹å…¶è¿›è¡Œä¿®æ”¹æ—¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…è®¸è¯»å–å™¨çº¿ç¨‹å…±äº«è®¿é—®æ˜¯åˆé€‚çš„,å†™å…¥å™¨çº¿ç¨‹ä¾ç„¶å¿…é¡»æ˜¯äº’æ–¥è®¿é—®çš„ã€‚</p>
<p>â€‹        <code>ReentrantReadWriteLock</code>çš„å®ç°é‡Œé¢æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š<br>â€‹        (1) å…¬å¹³æ€§ï¼šéå…¬å¹³é”(é»˜è®¤ï¼‰ã€‚è¿™ä¸ªå’Œç‹¬å é”çš„éå…¬å¹³æ€§ä¸€æ ·ï¼Œç”±äºè¯»çº¿ç¨‹ä¹‹é—´æ²¡æœ‰é”ç«äº‰ï¼Œæ‰€ä»¥è¯»æ“ä½œæ²¡æœ‰å…¬å¹³æ€§å’Œéå…¬å¹³æ€§ï¼Œå†™æ“ä½œæ—¶ï¼Œç”±äºå†™æ“ä½œå¯èƒ½ç«‹å³è·å–åˆ°é”ï¼Œæ‰€ä»¥ä¼šæ¨è¿Ÿä¸€ä¸ªæˆ–å¤šä¸ªè¯»æ“ä½œæˆ–è€…å†™æ“ä½œã€‚å› æ­¤,éå…¬å¹³é”çš„ååé‡è¦é«˜äºå…¬å¹³é”ã€‚å…¬å¹³é”åˆ©ç”¨<code>AQS</code>çš„<code>CLH</code>é˜Ÿåˆ—ï¼Œé‡Šæ”¾å½“å‰ä¿æŒçš„é”(è¯»é”æˆ–è€…å†™é”)æ—¶ï¼Œä¼˜å…ˆä¸ºç­‰å¾…æ—¶é—´æœ€é•¿çš„é‚£ä¸ªå†™çº¿ç¨‹åˆ†é…å†™å…¥é”ï¼Œå½“å‰å‰ææ˜¯å†™çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´è¦æ¯”æ‰€æœ‰è¯»çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´è¦é•¿ã€‚åŒæ ·ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™å…¥é”æˆ–è€…æœ‰ä¸€ä¸ªå†™çº¿ç¨‹å·²ç»åœ¨ç­‰å¾…äº†ï¼Œé‚£ä¹ˆè¯•å›¾è·å–å…¬å¹³é”çš„ï¼ˆéé‡å…¥ï¼‰æ‰€æœ‰çº¿ç¨‹ï¼ˆåŒ…æ‹¬è¯»å†™çº¿ç¨‹ï¼‰éƒ½å°†è¢«é˜»å¡ï¼Œç›´åˆ°æœ€å…ˆçš„å†™çº¿ç¨‹é‡Šæ”¾é”ã€‚å¦‚æœè¯»çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´æ¯”å†™çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´è¿˜è¦é•¿ï¼Œé‚£ä¹ˆä¸€æ—¦ä¸Šä¸€ä¸ªå†™çº¿ç¨‹é‡Šæ”¾é”,è¿™ä¸€ç»„è¯»çº¿ç¨‹å°†è·å–é”ã€‚<br>â€‹        (2) é‡å…¥æ€§ï¼šè¯»å†™é”å…è®¸è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹æŒ‰ç…§è¯·æ±‚é”çš„é¡ºåºé‡æ–°è·å–è¯»å–é”æˆ–è€…å†™å…¥é”ã€‚å½“ç„¶äº†ï¼Œåªæœ‰å†™çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œè¯»çº¿ç¨‹æ‰èƒ½è·å–é‡å…¥é”ã€‚å†™çº¿ç¨‹è·å–å†™å…¥é”åå¯ä»¥å†æ¬¡è·å–è¯»å–é”,ä½†æ˜¯è¯»çº¿ç¨‹è·å–è¯»å–é”åå´ä¸èƒ½è·å–å†™å…¥é”ã€‚å¦å¤–è¯»å†™é”æœ€å¤šæ”¯æŒ<code>65535</code>ä¸ªé€’å½’å†™å…¥é”å’Œ<code>65535</code>ä¸ªé€’å½’è¯»å–é”ã€‚<br>â€‹        (3) é”é™çº§ï¼šå†™çº¿ç¨‹è·å–å†™å…¥é”åå¯ä»¥è·å–è¯»å–é”ï¼Œç„¶åé‡Šæ”¾å†™å…¥é”ï¼Œè¿™æ ·å°±ä»å†™å…¥é”å˜æˆäº†è¯»å–é”ï¼Œä»è€Œå®ç°é”é™çº§çš„ç‰¹æ€§ã€‚<br>â€‹        (4) é”å‡çº§ï¼šè¯»å–é”æ˜¯ä¸èƒ½ç›´æ¥å‡çº§ä¸ºå†™å…¥é”çš„ã€‚å› ä¸ºè·å–ä¸€ä¸ªå†™å…¥é”éœ€è¦é‡Šæ”¾æ‰€æœ‰è¯»å–é”ï¼Œæ‰€ä»¥å¦‚æœæœ‰ä¸¤ä¸ªè¯»å–é”è§†å›¾è·å–å†™å…¥é”ï¼Œä¸”éƒ½ä¸é‡Šæ”¾è¯»å–é”æ—¶å°±ä¼šå‘ç”Ÿæ­»é”ã€‚<br>â€‹        (5) é”è·å–ä¸­æ–­ï¼šè¯»å–é”å’Œå†™å…¥é”éƒ½æ”¯æŒè·å–é”æœŸé—´è¢«ä¸­æ–­ã€‚è¿™ä¸ªå’Œç‹¬å é”ä¸€è‡´ã€‚<br>â€‹        (6) æ¡ä»¶å˜é‡ï¼šå†™å…¥é”æä¾›äº†æ¡ä»¶å˜é‡(<code>Condition</code>)çš„æ”¯æŒï¼Œè¿™ä¸ªå’Œç‹¬å é”ä¸€è‡´ï¼Œä½†æ˜¯è¯»å–é”å´ä¸å…è®¸è·å–æ¡ä»¶å˜é‡,å¦åˆ™ä¼šå¾—åˆ°ä¸€ä¸ª<code>UnsupportedOperationException</code>å¼‚å¸¸ã€‚<br>â€‹        (7) é‡å…¥æ•°ï¼šè¯»å–é”å’Œå†™å…¥é”çš„æ•°é‡æœ€å¤§åˆ†åˆ«åªèƒ½æ˜¯<code>65535</code>ã€‚</p>
<p>æ¦‚æ‹¬èµ·æ¥å…¶å®å°±æ˜¯è¯»å†™é”çš„æœºåˆ¶:</p>
<ul>
<li>(1)è¯»-è¯»ä¸äº’æ–¥ï¼Œæ¯”å¦‚å½“å‰æœ‰10ä¸ªçº¿ç¨‹å»è¯»ï¼ˆæ²¡æœ‰çº¿ç¨‹å»å†™)ï¼Œè¿™ä¸ª10ä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘è¯»ï¼Œè€Œä¸ä¼šå µå¡ã€‚</li>
<li>(2)è¯»-å†™äº’æ–¥ï¼Œå½“å‰æœ‰å†™çš„çº¿ç¨‹çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯»å–çº¿ç¨‹å°±ä¼šå µå¡ï¼Œåè¿‡æ¥ï¼Œæœ‰è¯»çš„çº¿ç¨‹åœ¨ä½¿ç”¨çš„æ—¶å€™,å†™çš„çº¿ç¨‹ä¹Ÿä¼šå µå¡,å°±çœ‹è°å…ˆæ‹¿åˆ°é”äº†ã€‚</li>
<li>(3)å†™-å†™äº’æ–¥ï¼Œå†™çº¿ç¨‹éƒ½æ˜¯äº’æ–¥çš„ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹å»å†™ï¼ŒAçº¿ç¨‹å…ˆæ‹¿åˆ°é”å°±å…ˆå†™,Bçº¿ç¨‹å°±å µå¡ç›´åˆ°Açº¿ç¨‹é‡Šæ”¾é”ã€‚</li>
</ul>
<p>â€‹        ä½¿ç”¨è¯»&#x2F;å†™é”çš„æ–¹æ³•å’Œæ­¥éª¤;</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä¸€ä¸ªReentrantReadwriteLockå¯¹è±¡</span>
<span class="token keyword">private</span> <span class="token class-name">ReentrantReadwriteLock</span> rwl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentLantReadwriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠ½å–è¯»é”å’Œå†™é”</span>
<span class="token keyword">private</span> <span class="token class-name">Lock</span> readLock <span class="token operator">=</span> rwl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°ä¸€ä¸ªå¯è¢«å¤šä¸ªè¯»æ“ä½œå…±ç”¨çš„è¯»é”ï¼Œä½†å®ƒä¼šæ’æ–¥æ‰€æœ‰å†™æ“ä½œ</span>
<span class="token keyword">private</span> <span class="token class-name">Lock</span> writeLock<span class="token operator">=</span> rwl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°ä¸€ä¸ªå†™é”,å®ƒä¼šæ’æ–¥æ‰€æœ‰å…¶ä»–çš„è¯»æ“ä½œå’Œå†™æ“ä½œ</span>

<span class="token comment">//å¯¹æ‰€æœ‰è®¿é—®è€…åŠ è¯»é”</span>
<span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getTotalBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">finally</span><span class="token punctuation">&#123;</span>readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span>

<span class="token comment">//å¯¹æ‰€æœ‰ä¿®æ”¹è€…åŠ å†™é”</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">finally</span><span class="token punctuation">&#123;</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å®ä¾‹ä½“ä¼š:<br>â€‹        ç¬¬ä¸€ç§æƒ…å†µï¼Œå…ˆä½“éªŒä¸€ä¸‹<code>ReadLock</code>å’Œ <code>WriteLock</code>å•ç‹¬ä½¿ç”¨çš„æƒ…å†µã€‚</p>
<h4 id="No4-ReadWriteLockDemo-java"><a href="#No4-ReadWriteLockDemo-java" class="headerlink" title="No4_ReadWriteLockDemo.java"></a>No4_ReadWriteLockDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_ReadWriteLockDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock</span> rwl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rwl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸Šè¯»é”ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½è¯»ä¸èƒ½å†™ï¼Œå…·æœ‰é«˜å¹¶å‘æ€§</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" read start."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿå¹²æ´»</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-read-end."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                rwl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾å†™é”ï¼Œæœ€å¥½æ”¾åœ¨finnalyé‡Œé¢</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rwl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¸Šå†™é”ï¼Œå…·æœ‰é˜»å¡æ€§</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" write start."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡æ‹Ÿå¹²æ´»</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-write-end."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                rwl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾å†™é”ï¼Œæœ€å¥½æ”¾åœ¨finnalyé‡Œé¢</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Count</span> ct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿è¡Œç»“æœå¦‚ä¸‹(ä»ç»“æœä¸Šé¢å¯ä»¥çœ‹çš„å‡ºæ¥ï¼Œè¯»çš„æ—¶å€™æ˜¯å¹¶å‘çš„,å†™çš„æ—¶å€™æ˜¯æœ‰é¡ºåºçš„å¸¦é˜»å¡æœºåˆ¶çš„):</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span> read <span class="token class-name"><span class="token namespace">start<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">1</span> read <span class="token class-name"><span class="token namespace">start<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>read<span class="token operator">-</span><span class="token class-name"><span class="token namespace">end<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>read<span class="token operator">-</span><span class="token class-name"><span class="token namespace">end<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">3</span> write <span class="token class-name"><span class="token namespace">start<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>write<span class="token operator">-</span><span class="token class-name"><span class="token namespace">end<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">2</span> write <span class="token class-name"><span class="token namespace">start<span class="token punctuation">.</span></span>
Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>write<span class="token operator">-</span>end<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ç¬¬äºŒç§æƒ…å†µï¼Œæˆ‘ä»¬ä½“ä¼šä¸€ä¸ª<code>ReadLock</code> å’Œ <code>WriteLock</code> çš„å¤æ‚ä½¿ç”¨æƒ…å†µï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæœ‰è¯»å†™æ•°æ®çš„åœºæ™¯,ä»”ç»†ä½“ä¼šä¸€ä¸‹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å‡è®¾è¿™é‡Œé¢å­˜äº†æ•°æ®ç¼“å­˜</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock</span> rwlock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">readWrite</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é¦–å…ˆå¼€å¯è¯»é”ï¼Œä»ç¼“å­˜ä¸­å»å–</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰é‡Šæ”¾è¯»é”ï¼Œä¸Šå†™é”</span>
                    rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            value <span class="token operator">=</span> <span class="token string">"aaa"</span><span class="token operator">+</span>id<span class="token punctuation">;</span> <span class="token comment">// æ­¤æ—¶å¯ä»¥å»æ•°æ®åº“ä¸­æŸ¥æ‰¾ï¼Œè¿™é‡Œç®€å•çš„æ¨¡æ‹Ÿä¸€ä¸‹</span>
                        <span class="token punctuation">&#125;</span>
                        rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç„¶åå†ä¸Šè¯»é”</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                        rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾å†™é”</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æœ€åé‡Šæ”¾è¯»é”</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>main</code>æ–¹æ³•</p>
<pre class="line-numbers language-none"><code class="language-none">public static void main(String[] args) &#123;
        final Count ct &#x3D; new Count();
&#x2F;&#x2F;        for (int i &#x3D; 0; i &lt; 2; i++) &#123;
&#x2F;&#x2F;            new Thread() &#123;
&#x2F;&#x2F;                @Override
&#x2F;&#x2F;                public void run() &#123;
&#x2F;&#x2F;                    ct.get();
&#x2F;&#x2F;                &#125;
&#x2F;&#x2F;            &#125;.start();
&#x2F;&#x2F;        &#125;
&#x2F;&#x2F;        for (int i &#x3D; 0; i &lt; 2; i++) &#123;
&#x2F;&#x2F;            new Thread() &#123;
&#x2F;&#x2F;                @Override
&#x2F;&#x2F;                public void run() &#123;
&#x2F;&#x2F;                    ct.put();
&#x2F;&#x2F;                &#125;
&#x2F;&#x2F;            &#125;.start();
&#x2F;&#x2F;        &#125;

        for (int i &#x3D; 0; i &lt; 9; i++) &#123;
            int num &#x3D; i;
            new Thread() &#123;
                @Override
                public void run() &#123;
                    Object o &#x3D; ct.readWrite(String.valueOf(num));
                    System.out.println(Thread.currentThread().getName()+&quot;--&quot;+o);

                &#125;
            &#125;.start();
        &#125;
        System.out.println(&quot;---&quot;);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰“å°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">--</span>aaa1
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">--</span>aaa0
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">--</span>aaa2
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">--</span>aaa3
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">--</span>aaa4
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">--</span>aaa8
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">--</span>aaa5
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">6</span><span class="token operator">--</span>aaa6
<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">7</span><span class="token operator">--</span>aaa7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ReentrantReadWriteLock</code> ä¸ <code>ReentrantLock</code>çš„æ¯”è¾ƒ:<br>(1ï¼‰ç›¸åŒç‚¹:å…¶å®éƒ½æ˜¯ä¸€ç§æ˜¾ç¤ºé”ï¼Œæ‰‹åŠ¨åŠ é”å’Œè§£é”ï¼Œéƒ½å¾ˆé€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚<br>(2ï¼‰ä¸åŒç‚¹: <code>ReentrantReadWriteLock</code>æ˜¯å¯¹<code>ReentrantLock</code> çš„å¤æ‚æ‰©å±•ï¼Œèƒ½é€‚åˆæ›´åŠ å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œ<code>ReentrantReadWriteLock</code>å¯ä»¥å®ç°ä¸€ä¸ªæ–¹æ³•ä¸­è¯»å†™åˆ†ç¦»çš„é”çš„æœºåˆ¶ã€‚è€Œ <code>ReentrantLock</code> åŠ é”è§£é”åªæœ‰ä¸€ç§æœºåˆ¶ã€‚</p>
<p>ä½¿ç”¨<code>ReadWriteLock</code>å¯ä»¥æé«˜è¯»å–æ•ˆç‡ï¼š</p>
<ul>
<li><code>ReadWriteLock</code>åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥ï¼›</li>
<li><code>ReadWriteLock</code>å…è®¸å¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰å†™å…¥æ—¶åŒæ—¶è¯»å–ï¼›</li>
<li><code>ReadWriteLock</code>é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="æ˜¾ç¤ºé”-StampedLock"><a href="#æ˜¾ç¤ºé”-StampedLock" class="headerlink" title="æ˜¾ç¤ºé” StampedLock"></a>æ˜¾ç¤ºé” StampedLock</h3><p>â€‹        å‰é¢ä»‹ç»çš„<code>ReadWriteLock</code>å¯ä»¥è§£å†³å¤šçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™çš„é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬æ·±å…¥åˆ†æ<code>ReadWriteLock</code>ï¼Œä¼šå‘ç°å®ƒæœ‰ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼šå¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨è¯»ï¼Œå†™çº¿ç¨‹éœ€è¦ç­‰å¾…è¯»çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½è·å–å†™é”ï¼Œå³è¯»çš„è¿‡ç¨‹ä¸­ä¸å…è®¸å†™ï¼Œè¿™æ˜¯ä¸€ç§æ‚²è§‚çš„è¯»é”ã€‚</p>
<p>â€‹        è¦è¿›ä¸€æ­¥æå‡å¹¶å‘æ‰§è¡Œæ•ˆç‡ï¼ŒJava 8å¼•å…¥äº†æ–°çš„è¯»å†™é”ï¼š<code>StampedLock</code>ã€‚</p>
<p>â€‹        <code>StampedLock</code>å’Œ<code>ReadWriteLock</code>ç›¸æ¯”ï¼Œæ”¹è¿›ä¹‹å¤„åœ¨äºï¼šè¯»çš„è¿‡ç¨‹ä¸­ä¹Ÿå…è®¸è·å–å†™é”åå†™å…¥ï¼è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¯»çš„æ•°æ®å°±å¯èƒ½ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä¸€ç‚¹é¢å¤–çš„ä»£ç æ¥åˆ¤æ–­è¯»çš„è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å†™å…¥ï¼Œè¿™ç§è¯»é”æ˜¯ä¸€ç§ä¹è§‚é”ã€‚</p>
<p>â€‹        ä¹è§‚é”çš„æ„æ€å°±æ˜¯ä¹è§‚åœ°ä¼°è®¡è¯»çš„è¿‡ç¨‹ä¸­å¤§æ¦‚ç‡ä¸ä¼šæœ‰å†™å…¥ï¼Œå› æ­¤è¢«ç§°ä¸ºä¹è§‚é”ã€‚åè¿‡æ¥ï¼Œæ‚²è§‚é”åˆ™æ˜¯è¯»çš„è¿‡ç¨‹ä¸­æ‹’ç»æœ‰å†™å…¥ï¼Œä¹Ÿå°±æ˜¯å†™å…¥å¿…é¡»ç­‰å¾…ã€‚æ˜¾ç„¶ä¹è§‚é”çš„å¹¶å‘æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸€æ—¦æœ‰å°æ¦‚ç‡çš„å†™å…¥å¯¼è‡´è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦èƒ½æ£€æµ‹å‡ºæ¥ï¼Œå†è¯»ä¸€éå°±è¡Œã€‚</p>
<p>â€‹        åœ¨ç†è§£StampedLockä¹‹å‰ï¼Œä¸çŸ¥é“å¤§å®¶ä¹‹å‰æ¥è§¦è¿‡æ‚²è§‚é”å’Œä¹è§‚é”æ²¡æœ‰ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆåšä¸€ä¸ªç®€å•è¯´æ˜:</p>
<p>â€‹        â—æ‚²è§‚é”ï¼šå‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå±è”½ä¸€åˆ‡å¯èƒ½è¿åæ•°æ®å®Œæ•´æ€§çš„æ“ä½œã€‚<br>â€‹        â—è¯»å–æ‚²è§‚é”ï¼šåœ¨è¯»å–ä¹‹å‰ä¸€å®šè¦åˆ¤æ–­ä¸€ä¸‹ï¼Œæ•°æ®åˆæ²¡æœ‰æ­£åœ¨è¢«æ›´æ”¹ã€‚<br>â€‹        â—ä¹è§‚é”ï¼šå‡è®¾ä¸ä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œåªåœ¨æäº¤æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦è¿åæ•°æ®å®Œæ•´æ€§ã€‚<br>â€‹        â—è¯»å–ä¹è§‚é”ï¼šåœ¨è¯»å–ä¹‹å‰å°±ä¸éœ€è¦æ¥åˆ¤æ–­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘åªç®¡è¯»æˆ‘è‡ªå·±çš„å°±å¯ä»¥äº†ã€‚</p>
<p>â€‹        <code>StampedLock</code>æ˜¯åŸºäºèƒ½åŠ›çš„é”ï¼Œå¯ä»¥å¾ˆå¥½åœ°å®ç°æ‚²è§‚é”å’Œä¹è§‚é”çš„é€»è¾‘ã€‚å®ƒä½¿ç”¨ä¸‰ç§æ¨¡å¼æ¥æ§åˆ¶è¯»&#x2F;å†™è®¿é—®ã€‚<code>StampedLock</code>çš„çŠ¶æ€åŒ…å«äº†ç‰ˆæœ¬å’Œæ¨¡å¼ã€‚é”è·å–æ–¹æ³•æ ¹æ®é”çš„çŠ¶æ€è¿”å›ä¸€ä¸ªè¡¨ç¤ºå’Œæ§åˆ¶è®¿é—®çš„æ ‡å¿—(<code>stamp</code>),â€œ<code>try</code>â€œ ç‰ˆæœ¬çš„è¿™äº›æ–¹æ³•å¯èƒ½è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å€¼<code>0</code>æ¥è¡¨ç¤ºè·å–å¤±è´¥ã€‚é”é‡Šæ”¾å’Œå®ƒçš„å˜æ¢æ–¹æ³•è¦æ±‚ä¸€ä¸€ä¸ªæ ‡å¿—ä½œä¸ºå‚æ•°ï¼Œ å¦‚æœå®ƒä»¬ä¸ç¬¦åˆé”çš„çŠ¶æ€å°±å¤±è´¥ã€‚è¿™ä¸‰ç§æ¨¡å¼åˆ†åˆ«æ˜¯:</p>
<blockquote>
<p>å†™é”ã€æ‚²è§‚è¯»é”å’Œä¹è§‚è¯»ã€‚</p>
</blockquote>
<p>â€‹        â—å†™:æ–¹æ³•<code>writeLock</code>å¯èƒ½é˜»å¡ç­‰å¾…ç‹¬å è®¿é—®ï¼Œè¿”å›ä¸€ä¸ªæ ‡å¿—ï¼Œå¯ç”¨æ–¹æ³•<code>unlockWrite</code> ä»¥é‡Šæ”¾é”ã€‚ä¹Ÿæä¾›äº†æ— æ—¶é—´å’Œå¸¦æ—¶é—´ç‰ˆæœ¬çš„<code>tryWriteLock</code> æ–¹æ³•ã€‚å½“é”ä»¥å†™æ¨¡å¼æŒæœ‰æ—¶ï¼Œæ²¡æœ‰è¯»é”å¯ä»¥è·å–ï¼Œæ‰€æœ‰ä¹è§‚æ€§è¯»ç¡®è®¤å°†å¤±è´¥ã€‚<br>â€‹        â—è¯»æ–¹æ³•<code>readLock</code>å¯èƒ½ä¸ºéç‹¬å è®¿é—®è€Œé˜»å¡ç­‰å¾…è¿”å›ä¸€ä¸ªæ ‡å¿—ç”¨äºæ–¹æ³•<code>unlockRead</code>ä»¥é‡Šæ”¾é”ã€‚ä¹Ÿæä¾›äº†æ— æ—¶é—´å’Œå¸¦æ—¶é—´ç‰ˆæœ¬çš„<code>tryWriteLock</code> æ–¹æ³•ã€‚<br>â€‹        â—ä¹è§‚è¯»:åªæœ‰åœ¨é”å½“å‰æ²¡æœ‰ä»¥å†™æ¨¡å¼æŒæœ‰æ—¶ï¼Œæ–¹æ³•<code>tryopimisticRead</code> è¿”å›ä¸€ä¸ªé0æ ‡å¿—ã€‚å¦‚æœé”è‡ªç»™å®šæ ‡å¿—ä»¥æ¥æ²¡æœ‰ä»¥å†™æ¨¡å¼æŒæœ‰ï¼Œæ–¹æ³•<code>validate</code> è¿”å›<code>true</code>. è¿™ç§æ¨¡å¼å¯ä»¥è®¤ä¸ºæ˜¯ä¸€-ç§æå¼±ç‰ˆæœ¬çš„è¯»é”ï¼Œå¯ä»¥åœ¨ä»»æ„æ—¶é—´è¢«å†™è€…æ‰“ç ´åœ¨çŸ­çš„åªè¯»ä»£ç æ®µä½¿ç”¨ä¹è§‚æ¨¡å¼å¸¸å¸¸å¯ä»¥å‡å°‘ç«äº‰å¹¶æå‡ååé‡ã€‚ç„¶è€Œï¼Œå®ƒçš„ä½¿ç”¨å¤©ç”Ÿæ˜¯è„†å¼±çš„ã€‚ä¹è§‚è¯»ç‰‡æ®µ<code>section</code>åº”è¯¥åªè¯»å­—æ®µå¹¶æŒæœ‰åˆ°æœ¬åœ°å˜é‡ï¼Œç”¨äºä»¥åä½¿ç”¨ï¼Œåœ¨ç¡®è®¤ä»¥åã€‚ä¹è§‚è¯»æ¨¡å¼é‡Œçš„å­—æ®µè¯»å–å¯èƒ½å¾ˆä¸ä¸€è‡´ï¼Œæ‰€ä»¥æƒ¯ä¾‹åªç”¨äºå½“ä½ å¯¹æ•°æ®è¡¨ç¤ºè¶³å¤Ÿç†Ÿæ‚‰ï¼Œå¯ä»¥æ£€æŸ¥ä¸€è‡´æ€§å’Œ&#x2F;æˆ–é‡ å¤è°ƒç”¨<code>validate()</code> æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè¿™äº›æ­¥éª¤å…¸å‹åœ°åœ¨ç¬¬ä¸€æ¬¡è¯»å–å¯¹è±¡æˆ–æ•°ç»„å¼•ç”¨ï¼Œç„¶åè®¿é—®å…¶ä¸­å­—æ®µã€å…ƒç´ æˆ–æ–¹æ³•æ—¶è¦æ±‚ã€‚</p>
<p>â€‹        æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>StampedLock</code>çš„éƒ¨åˆ†æºç :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StampedLock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
	
	<span class="token comment">/** Lock sequence/state */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> state<span class="token punctuation">;</span><span class="token comment">//æ ‡å¿—(`stamp`);</span>
	<span class="token comment">// views</span>
    <span class="token keyword">transient</span> <span class="token class-name">ReadLockView</span> readLockView<span class="token punctuation">;</span>
    <span class="token keyword">transient</span> <span class="token class-name">WriteLockView</span> writeLockView<span class="token punctuation">;</span>
    <span class="token keyword">transient</span> <span class="token class-name">ReadWriteLockView</span> readWriteLockView<span class="token punctuation">;</span>
	
	<span class="token comment">// view classes</span>

    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReadLockView</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token function">readLockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">tryReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">tryReadLock</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">unstampedUnlockRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WriteLockView</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token function">writeLockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">tryWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">tryWriteLock</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">unstampedUnlockWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockView</span> <span class="token keyword">implements</span> <span class="token class-name">ReadWriteLock</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">Lock</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">asReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token class-name">Lock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">asWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ç”±æ­¤å¯ä»¥çœ‹å¾—å‡ºæ¥<code>StampedLock</code>ä¹Ÿæ˜¯åˆ©ç”¨<code>Lock</code>æœºåˆ¶å†åŠ ä¸Š<code>stamp</code>ä½œä¸ºé”çš„æ ‡å¿—çŠ¶æ€ï¼Œå®ç°äº†é”ä¸é”ä¹‹é—´çš„æ‚²è§‚å’Œä¹è§‚ã€‚<br>â€‹        è¿™ä¸ªç±»ä¹Ÿæ”¯æŒæ–¹æ³•ä»¥æœ‰æ¡ä»¶åœ°æä¾›ä¸‰ç§æ¨¡å¼ä¹‹é—´çš„è½¬æ¢ã€‚ä¾‹å¦‚ï¼Œæ–¹æ³•<code>tryConvertToWriteLock</code>å°è¯•â€œå‡çº§â€æ¨¡å¼ï¼Œè¿”å›ä¸€ä¸€ä¸ªæœ‰æ•ˆçš„å†™æ ‡å¿—ã€‚</p>
<blockquote>
<p> [1]è¡¨ç¤ºå·²ç»æ˜¯å†™æ¨¡å¼ï¼Œ</p>
<p>[2]è¡¨ç¤ºåœ¨è¯»æ¨¡å¼ä¸”æ²¡æœ‰å…¶ä»–è¯»è€…ï¼Œ</p>
<p>[3]è¡¨ç¤ºåœ¨ä¹è§‚æ¨¡å¼ä¸”é”å¯å¾—ã€‚è¿™äº›æ–¹æ³•çš„å½¢å¼æ˜¯è®¾è®¡ç”¨äºå¸®åŠ©å‡å°‘ä¸€äº›ä»£ç è†¨èƒ€ï¼Œ å¦åˆ™å°†å‡ºç°åœ¨åŸºäºé‡è¯•çš„è®¾è®¡ã€‚</p>
</blockquote>
<p><code>StampedLock</code>è®¾è®¡ç”¨ä½œå¼€å‘çº¿ç¨‹å®‰å…¨ç»„ä»¶çš„å†…éƒ¨å·¥å…·ã€‚å®ƒä»¬çš„ä½¿ç”¨ä¾èµ–äºå¯¹æ•°æ®ã€å¯¹è±¡å’Œå®ƒä»¬æ‰€ä¿æŠ¤æ–¹æ³•çš„å†…åœ¨å±æ€§çš„çŸ¥è¯†ã€‚å®ƒä»¬ä¸æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥é”ä¿æŠ¤å—ä¸åº”è¯¥è°ƒç”¨å…¶ä»–å¯èƒ½å°è¯•å†æ¬¡è·å–é”(è™½ç„¶ä½ å¯ä»¥ä¼ é€’æ ‡å¿—ç»™å…¶ä»–æ–¹æ³•ï¼Œç„¶åä½¿ç”¨æˆ–è½¬æ¢å®ƒ)çš„æœªçŸ¥æ–¹æ³•ã€‚ä½¿ç”¨è¯»é”æ¨¡å¼ä¾èµ–äºå…³è”çš„ä»£ç ç‰‡æ®µæ˜¯æ— è¾¹é™…æ•ˆåº”çš„( ä¹Ÿå°±æ˜¯æ— å‰¯ä½œç”¨)ã€‚æ— æ•ˆçš„ä¹è§‚è¯»ç‰‡æ®µä¸èƒ½è°ƒç”¨é‚£äº›ä¸çŸ¥é“å¿å—æ½œåœ¨ä¸ä¸€è‡´çš„æ–¹æ³•ã€‚æ ‡å¿—ä½¿ç”¨æœ‰é™çš„è¡¨ç¤ºï¼Œä¸”ä¸æ˜¯å¯†ç åŠ å¯†å®‰å…¨çš„( ä¾‹å¦‚ï¼Œä¸€ä¸€ä¸ªæœ‰æ•ˆçš„æ ‡å¿—æ˜¯å¯çŒœæµ‹çš„)ã€‚åœ¨(ä¸æ—©äº) -ä¸€å¹´çš„æŒç»­æ“ä½œåï¼Œæ ‡å¿—çš„å€¼å¯èƒ½ä¼šå¾ªç¯ã€‚æŒæœ‰æ ‡å¿—è€Œä¸ä½¿ç”¨æˆ–<br>ç¡®è®¤ï¼Œåœ¨å¤§äºè¿™ä¸ªå‘¨æœŸå¯èƒ½å°†ä¸èƒ½æ­£ç¡®ç¡®è®¤ã€‚<code>StampedLock</code> æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œä½†æ€»æ˜¯ååºåˆ—åŒ–ä¸ºåˆå§‹æœªé”å®šçŠ¶æ€ï¼Œæ‰€ä»¥å¯¹äºè¿œç¨‹é”å®šæ²¡æœ‰å¸®åŠ©ã€‚<br>        <code>StampedLock</code>çš„è°ƒåº¦ç­–ç•¥ä¸æ˜¯ä¸€æƒ¯åœ°å€¾å‘äºé€‰æ‹©è¯»è€Œä¸æ˜¯å†™ï¼Œ æˆ–ç›¸åã€‚æ‰€æœ‰â€œ<code>try</code>â€œ æ–¹æ³•éƒ½æ˜¯å°½æœ€å¤§åŠªåŠ›çš„ï¼Œä¸å¿…å‘ä»»ä½•è°ƒåº¦æˆ–å…¬å¹³ç­–ç•¥ç¡®è®¤ã€‚ä»»ä½•ç”¨äºè·å–çš„â€œ<code>try</code>â€œ æ–¹æ³•æˆ–ä¸å¸¦ä»»ä½•å…³äºé”çŠ¶æ€çš„ä¿¡æ¯çš„è½¬æ¢é”æ¨¡å¼çš„æ–¹æ³•è¿”å›0 ;åç»­çš„è°ƒç”¨å¯èƒ½æˆåŠŸã€‚<br>        å› ä¸ºå®ƒæ”¯æŒåè°ƒè·¨å¤šç§é”æ¨¡å¼ä½¿ç”¨ï¼Œè¿™ä¸ªç±»ä¸ç›´æ¥ä½¿ç”¨Lock æˆ–ReadWriteLockæ¥å£ã€‚ç„¶è€Œï¼Œåœ¨è¦æ±‚è¿™æ ·- - ç»„å…³è”åŠŸèƒ½çš„åº”ç”¨é‡Œï¼Œ<code>StampedLock</code> å¯ä»¥çœ‹ä½œ<code>asReadLock()</code>ã€ <code>asWriteLock()</code>æˆ–<code>asReadWriteLock()</code>ã€‚</p>
<p>â€‹        ä¸‹é¢æ˜¯Javaçš„docä¸­æä¾›çš„ä¸€ä¸€ä¸ªä¾‹å­: </p>
<h4 id="No5-StampedLockDemo-java"><a href="#No5-StampedLockDemo-java" class="headerlink" title="No5_StampedLockDemo.java"></a>No5_StampedLockDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">StampedLock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_StampedLockDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Point</span> ct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    ct<span class="token punctuation">.</span><span class="token function">distanceFromOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> sl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">double</span> deltaX<span class="token punctuation">,</span> <span class="token keyword">double</span> deltaY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// an exclusively locked method</span>
            <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"get writeLock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                x <span class="token operator">+=</span> deltaX<span class="token punctuation">;</span>
                y <span class="token operator">+=</span> deltaY<span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"write  OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"unlockWrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sl<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//ä¸‹é¢çœ‹çœ‹ä¹è§‚è¯»é”æ¡ˆä¾‹</span>
        <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">distanceFromOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// A read-only method</span>
            <span class="token comment">//å°è¯•ä¹è§‚è¯»</span>
            <span class="token comment">//è¿”å›ä¸€ä¸ªå¯ä»¥ç¨åéªŒè¯çš„æˆ³è®°ï¼Œå¦‚æœæ’ä»–æ€§é”å®šï¼Œåˆ™è¿”å›0ã€‚</span>
            <span class="token comment">//è¿”å›:ä¸€ä¸ªæˆ³è®°ï¼Œå¦‚æœè¢«æ’ä»–æ€§é”å®šï¼Œåˆ™è¿”å›0</span>
            <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å¾—ä¸€ä¸ªä¹è§‚è¯»é”</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"è·å¾—ä¸€ä¸ªä¹è§‚è¯»é”"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">double</span> currentX <span class="token operator">=</span> x<span class="token punctuation">,</span> currentY <span class="token operator">=</span> y<span class="token punctuation">;</span><span class="token comment">//å°†ä¸¤ä¸ªå­—æ®µè¯»å…¥æœ¬åœ°å±€éƒ¨å˜é‡</span>
            <span class="token comment">// å¦‚æœè‡ªç»™å®šçš„æˆ³è®°å‘å‡ºåé”è¿˜æ²¡æœ‰è¢«ç‹¬å è·å–ï¼Œåˆ™è¿”å›trueã€‚</span>
            <span class="token comment">// å¦‚æœæˆ³è®°ä¸ºé›¶ï¼Œåˆ™æ€»æ˜¯è¿”å›falseã€‚å¦‚æœæˆ³è®°è¡¨ç¤ºå½“å‰æŒæœ‰çš„é”ï¼Œåˆ™å§‹ç»ˆè¿”å›trueã€‚</span>
            <span class="token comment">// ä½¿ç”¨æœªä»tryOptimisticReadè·å¾—çš„å€¼æˆ–æ­¤é”çš„é”å®šæ–¹æ³•è°ƒç”¨æ­¤æ–¹æ³•æ²¡æœ‰å®šä¹‰ä»»ä½•æ•ˆæœæˆ–ç»“æœã€‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ£€æŸ¥å‘å‡ºä¹è§„è¯»é”ååŒæ—¶æ˜¯å¦æœ‰å…¶ä»–å†™é”å‘ç”Ÿ?</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å†æ¬¡è·å¾—ä¸€ä¸ªè¯»æ‚²è§‚é”</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"å†æ¬¡è·å¾—ä¸€ä¸ªè¯»æ‚²è§‚é”"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//å°†ä¸¤ä¸ªå­—æ®µè¯»å…¥æœ¬åœ°å±€éƒ¨å˜é‡</span>
                    currentX <span class="token operator">=</span> x<span class="token punctuation">;</span>
                    currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"unlockRead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>currentX <span class="token operator">*</span> currentX <span class="token operator">+</span> currentY <span class="token operator">*</span> currentY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//ä¸‹é¢æ˜¯æ‚²è§‚è¯»é”æ¡ˆä¾‹</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">moveIfAtOrigin</span><span class="token punctuation">(</span><span class="token keyword">double</span> newX<span class="token punctuation">,</span> <span class="token keyword">double</span> newY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// upgrade</span>
            <span class="token comment">// Could instead start with optimistic, not read mode</span>
            <span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¾ªç¯ï¼Œæ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦ç¬¦åˆ</span>
                    <span class="token keyword">long</span> ws <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">tryConvertToWriteLock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°è¯•å°†è¯»é”è½¬ä¸ºå†™é”</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿™æ˜¯ç¡®è®¤è½¬ä¸ºå†™é”æ˜¯å¦æˆåŠŸ</span>
                        stamp <span class="token operator">=</span> ws<span class="token punctuation">;</span><span class="token comment">//å¦‚æœæˆåŠŸ è½¬æ¢ç¥¨æ®</span>
                        <span class="token comment">//è¿›è¡ŒçŠ¶æ€æ”¹å˜</span>
                        x <span class="token operator">=</span> newX<span class="token punctuation">;</span>
                        y <span class="token operator">=</span> newY<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœä¸èƒ½æˆåŠŸè½¬ä¸ºå†™é”</span>
                        sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æˆ‘ä»¬æ˜¾ç¤ºçš„é‡Šæ”¾è¯»é”</span>
                        stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ˜¾ç¤ºç›´æ¥è¿›è¡Œå†™é”,ç„¶åå†é€šè¿‡å¾ªç¯å†å°è¯•</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                sl<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡Šæ”¾è¯»é”æˆ–è€…å†™é”</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <code>StampedLock</code>æ˜¯JDK 1.8ä¹‹åæ–°æ¨å‡ºçš„ä¸€ä¸ª APLå¯å¤§å¹…åº¦æé«˜ç¨‹åºçš„è¯»å–é”çš„ååé‡ã€‚åœ¨å¤§å¤šæ•°éƒ½æ˜¯è¯»å–ã€å¾ˆå°‘å†™å…¥çš„æƒ…å†µä¸‹ï¼Œä¹è§‚è¯»é”æ¨¡å¼å¯ä»¥æå¤§æä¾›ååé‡ï¼Œä¹Ÿå¯ä»¥å‡å°‘è¿™ç§æƒ…å†µä¸‹å†™é¥¥é¥¿çš„ç°è±¡(ç”±äºè¯»è€…ä¸€èˆ¬ä¸åŠ è¯»é”ï¼Œ å†™å¯ä»¥é©¬ä¸Šè·å–åˆ°é”)ã€‚<br>â€‹        æœ€å<code>Synchronized</code>ã€<code>ReentrantLock</code>ã€ <code>ReentrantReadWritelock</code>ã€<code>StampedLock</code>ç®€å•å¯¹æ¯”å¦‚ä¸‹:<br>â€‹        (1)<code> Synchronized</code> æ˜¯åœ¨<code>JVM</code>å±‚é¢ä¸Šå®ç°çš„ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›ç›‘æ§å·¥å…·ç›‘æ§<code>synchronized</code>çš„é”å®šï¼Œå½“ä»£ç æ‰§è¡Œæ—¶å‡ºç°å¼‚å¸¸ï¼Œ<code>JVM</code>ä¼šè‡ªåŠ¨é‡Šæ”¾é”å®šã€‚å½“åªæœ‰å°‘é‡ç«äº‰è€…çš„æ—¶å€™ï¼Œ<code>synchronized</code> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€šç”¨çš„é”å®ç°ã€‚<code>Synchronized</code> çš„é”æ˜¯é’ˆå¯¹ä¸€ä¸€ä¸ªå¯¹è±¡çš„ã€‚<br>â€‹        (2) <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ã€ <code>StampedLock</code> éƒ½æ˜¯ä»£ç å—å±‚é¢çš„é”å®šï¼Œè¦ä¿è¯é”å®šä¸€å®šä¼šè¢«é‡Šæ”¾ï¼Œ å°±å¿…é¡»å°†<code>unLock()</code>æ”¾åˆ°<code>finally&#123;&#125;</code>ä¸­ã€‚<br>â€‹        (3) <code>ReentrantLock</code>æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€šç”¨çš„é”å®ç°ï¼Œä½¿ç”¨äºæ¯”è¾ƒç®€å•çš„åŠ é”ã€è§£é”çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœå®ç°å¤æ‚çš„é”æœºåˆ¶ï¼Œå½“çº¿ç¨‹å¢é•¿èƒ½å¤Ÿé¢„ä¼°æ—¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚<br>â€‹        (4) <code>ReentrantReadWrteLock</code> å¯¹<code>Lock</code>åˆè¿›è¡Œäº†æ‰©å±•ï¼Œå¼•å…¥äº†<code>read</code> å’Œ <code>write</code>é˜»å¡å’Œå¹¶å‘æœºåˆ¶ï¼Œç›¸å¯¹äº<code>ReentrantLock</code>å®ƒå¯ä»¥å®ç°æ›´å¤æ‚çš„é”æœºåˆ¶ï¼Œä¸”å¹¶å‘æ€§ä¹Ÿæ›´é«˜äº›ã€‚<br>â€‹        (5) <code>StampedLock</code>åˆåœ¨<code>Lock</code>çš„åŸºç¡€ä¸Š,å®ç°äº†å¯ä»¥æ»¡è¶³ä¹è§‚é”å’Œæ‚²è§‚é”ç­‰ä¸€ä¸€äº›åœ¨è¯»çº¿ç¨‹è¶Šæ¥è¶Šå¤šçš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯¹ååé‡æœ‰å·¨å¤§çš„æ”¹è¿›ï¼Œä½†å¹¶ä¸æ˜¯è¯´è¦æ›¿ä»£ä¹‹å‰çš„<code>Lock</code>, æ¯•ç«Ÿå®ƒè¿˜æ˜¯æœ‰äº›åº”ç”¨åœºæ™¯çš„ã€‚<br>â€‹        (6) <code>StampedLock</code> æœ‰ä¸€ä¸ªå¤æ‚çš„APIç›¸å¯¹äºå‰é¢ä¸¤ç§<code>Lock</code>é”ï¼Œå¯¹äºåŠ é”æ“ä½œï¼Œå¾ˆå®¹æ˜“è¯¯ç”¨å…¶ä»–æ–¹æ³•ï¼Œå¦‚æœç†è§£ä¸æ·±å…¥ä¹Ÿæ›´å®¹æ˜“å‡ºç°æ­»é”å’Œä¸å¿…è¦çš„éº»çƒ¦ã€‚<br>â€‹        (7)æ¨èå¦‚æœä¸æ˜¯ä¸šåŠ¡éå¾—éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨<code>ReentrantLock</code>å’Œ<code>ReentrantReadWriteLock</code>å³å¯<br>æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯çš„éœ€è¦ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯æ­»é”"><a href="#ä»€ä¹ˆæ˜¯æ­»é”" class="headerlink" title="ä»€ä¹ˆæ˜¯æ­»é”"></a>ä»€ä¹ˆæ˜¯æ­»é”</h3><p>â€‹        åœ¨ä¸¤æ®µä¸åŒçš„é€»è¾‘éƒ½åœ¨ç­‰å¾…å¯¹æ–¹çš„é”é‡Šæ”¾æ‰èƒ½ç»§ç»­å¾€ä¸‹å·¥ä½œæ—¶ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šäº§ç”Ÿæ­»é”ï¼Œè¡¨é¢ç°è±¡å°±æ˜¯ç¨‹åºå†ä¹Ÿæ‰§è¡Œä¸ä¸‹å»äº†ã€‚<br>â€‹        è¯·çœ‹å¦‚ä¸‹äº‹ä¾‹:æ–°å»ºä¸€ä¸ªå¹²æ´»ç±»çš„ä¸¤ä¸ªä¸åŒæ–¹æ³•åœ¨ç­‰å¾…é”ã€‚</p>
<h4 id="No6-Deadlock-java"><a href="#No6-Deadlock-java" class="headerlink" title="No6_Deadlock.java"></a>No6_Deadlock.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No6_Deadlock</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Count</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lock2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ³¨æ„è¿™ä¸ªé”çš„å¯¹è±¡ä¸ä¸€æ ·</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// äº§ç”Ÿæ­»é”ç­‰å¾…lock2å¯¹è±¡é‡Šæ”¾é”</span>
                    num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// æ³¨æ„è¿™ä¸ªé”çš„å¯¹è±¡ä¸ä¸€æ ·</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¨¡ä»¿ç”¨æˆ·å¹²æ´»</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// äº§ç”Ÿæ­»é”ç­‰å¾…lock1å¯¹è±¡é‡Šæ”¾é”</span>
                    num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadA</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">ThreadA</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span>count<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ThreadA run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadB</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Count</span> count<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">ThreadB</span><span class="token punctuation">(</span><span class="token class-name">Count</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span>count<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ThreadB run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count<span class="token punctuation">.</span><span class="token function">lockMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Count</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadA</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadA</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadB</span> taskB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadB</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskB<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é€šè¿‡å·¥å…·æ¥ç›‘æ§çº¿ç¨‹Aå’Œçº¿ç¨‹Bæ°¸è¿œåœ¨è¿™é‡Œ:</p>
<p><img src="/image/Concurrent/Concurrent14.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent14.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>é€šè¿‡æ‰§è¡Œä¸Šé¢çš„mainæ–¹æ³•ä½ ä¼šå‘ç°ï¼Œç¨‹åºæ­»åœ¨é‚£é‡Œï¼Œæ°¸è¿œä¸ä¼šæ‰§è¡Œä¸‹å»äº†ï¼Œè€Œå®é™…å·¥ä½œä¸­åº”è¯¥æ³¨æ„çš„æ˜¯æ–¹æ³•ä¹‹é—´åµŒå¥—è°ƒç”¨ä¸Šä¸èƒ½äº§ç”Ÿæ­»é”ã€‚</p>
<h3 id="Javaå…³é”®å­—volatileä¿®é¥°å˜é‡"><a href="#Javaå…³é”®å­—volatileä¿®é¥°å˜é‡" class="headerlink" title="Javaå…³é”®å­—volatileä¿®é¥°å˜é‡"></a>Javaå…³é”®å­—volatileä¿®é¥°å˜é‡</h3><p>â€‹        Javaå…³é”®å­—volatileä¿®é¥°å˜é‡ï¼Œä»è¡¨é¢æ„æ€ä¸Šæ˜¯è¯´è¿™ä¸ªå˜é‡æ˜¯æ˜“å˜çš„ï¼Œä¸ç¨³å®šçš„ï¼Œäº‹å®ä¸Šï¼Œç¡®å®å¦‚æ­¤ï¼Œè¿™ä¸ªå…³é”®å­—çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå‡¡æ˜¯è¢«è¯¥å…³é”®å­—å£°æ˜çš„å˜é‡éƒ½æ˜¯æ˜“å˜çš„ã€ä¸ç¨³å®šçš„ã€‚æ‰€ä»¥ä¸è¦è¯•å›¾å¯¹è¯¥å˜é‡ä½¿ç”¨ç¼“å­˜ç­‰ä¼˜åŒ–æœºåˆ¶ï¼Œè€Œåº”å½“æ¯æ¬¡éƒ½ä»å®ƒçš„å†…å­˜åœ°å€ä¸­å»è¯»å–å€¼ã€‚ä½¿ç”¨volatile æ ‡è®°çš„å˜é‡åœ¨è¯»å–æˆ–å†™å…¥æ—¶ä¸éœ€è¦ä½¿ç”¨é”ï¼Œè¿™å°†å‡å°‘äº§ç”Ÿæ­»é”çš„æ¦‚ç‡ï¼Œä½¿ä»£ç ä¿æŒç®€æ´ã€‚<br>â€‹        è¯·æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯è¯´æ¯æ¬¡è¯»å–volatileçš„å˜é‡æ—¶éƒ½è¦ä»å®ƒçš„å†…å­˜åœ°å€ä¸­è¯»å–ï¼Œå¹¶æ²¡æœ‰è¯´æ¯æ¬¡ä¿®æ”¹å®Œvolatile çš„å˜é‡åéƒ½è¦ç«‹åˆ»å°†å®ƒçš„å€¼å†™å›å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´volatile åªæä¾›äº†å†…å­˜å¯è§æ€§ï¼Œè€Œæ²¡æœ‰æä¾›åŸå­æ€§ã€‚æ‰€ä»¥è¯´å¦‚æœç”¨è¿™ä¸ªå…³é”®å­—åšé«˜å¹¶å‘çš„å®‰å…¨æœºåˆ¶çš„è¯æ˜¯ä¸å¯é çš„ã€‚<br>â€‹        volatileçš„ç”¨æ³•å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹        åœ¨å£°æ˜å˜é‡çš„æ—¶å€™å¸¦ä¸Švolatile å…³é”®å­—å³å¯ã€‚ä»€ä¹ˆæ—¶å€™ä½¿ç”¨volatile å…³é”®å­—?å½“æˆ‘ä»¬çŸ¥é“äº†volatileçš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå°±çŸ¥é“äº†å®ƒåº”è¯¥ç”¨åœ¨å“ªäº›åœ°æ–¹ã€‚å¾ˆæ˜¾ç„¶ï¼Œæœ€å¥½æ˜¯é‚£ç§åªæœ‰ä¸€ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å˜é‡ï¼Œå¤šä¸ªçº¿ç¨‹è¯»å–è¯¥å˜é‡çš„åœ°æ–¹ã€‚ä¹Ÿå°±æ˜¯å¯¹å†…å­˜å¯è§æ€§è¦æ±‚é«˜ï¼Œè€Œå¯¹åŸå­æ€§è¦æ±‚ä½çš„åœ°æ–¹ã€‚<br>â€‹        volatileä¸åŠ é”æœºåˆ¶çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼šåŠ é”æœºåˆ¶æ—¢å¯ä»¥ç¡®ä¿å¯è§æ€§åˆå¯ä»¥ç¡®ä¿åŸå­æ€§ï¼Œè€Œvolatileå˜é‡åªæœ‰ç¡®ä¿å¯è§æ€§ã€‚</p>
<h3 id="åŸå­æ“ä½œ-atomic"><a href="#åŸå­æ“ä½œ-atomic" class="headerlink" title="åŸå­æ“ä½œ : atomic"></a>åŸå­æ“ä½œ : atomic</h3><p>â€‹        <code>atomic</code>  æ˜¯ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼ˆæˆ–è€…è¯´åªæ˜¯åœ¨ç¡¬ä»¶çº§åˆ«ä¸Šé˜»å¡äº†ï¼‰ï¼Œçº¿ç¨‹å®‰å…¨çš„åŠ å¼ºç‰ˆçš„ <code>volatile</code> åŸå­æ“ä½œã€‚<code>java.util.concurrent.atomic</code>åŒ…é‡Œï¼Œå¤šäº†ä¸€æ‰¹åŸå­å¤„ç†ç±»ï¼Œä¸»è¦ç”¨äºåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„é«˜æ•ˆç¨‹åºå¤„ç†ã€‚</p>
<p>è¿™äº›å¤„ç†ç±»ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§: <strong>12</strong></p>
<ul>
<li>åŸºæœ¬ç±»ï¼š<code>AtomicInteger</code>ã€ <code>AtomicLong</code>ã€<code>AtomicBoolean</code>. </li>
<li>å¼•ç”¨ç±»å‹ï¼š<code>AtomicReference</code>ã€<code>AtomicReference</code> çš„ABAå®ä¾‹ã€<code>AtomicStampedReference</code>ã€<code>AtomicMarkableReference</code>.</li>
<li>æ•°ç»„ç±»å‹ï¼š<code>AtomicIntegerArray</code>ã€<code>AtomicLongArray</code>ã€<code>AtomicReferenceArray</code>.</li>
<li>å±æ€§åŸå­ä¿®æ”¹å™¨( Updater )ï¼š<code>AtomicIntegerFieldUpdater</code>ã€<code>AtomicLongFieldUpdater</code>ã€<br><code>AtomicReferenceFieldUpdater</code>.</li>
</ul>
<p>â€‹        æˆ‘ä»¬ä»¥å…¶ä¸­ä¸€ä¸ªä¸ºä½¿ç”¨ä¾‹å­<code>AtomicInteger</code>.å…¶ä½™çš„æ–¹æ³•å’Œä½¿ç”¨éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œç›¸å…³çš„ç±»ä¼šä»‹ç»å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Œåœ¨ä½¿ç”¨ä¸­éœ€è¦æ³¨æ„çš„åœ°æ–¹å³å¯ã€‚è€Œ<code>AtomicInteger</code>è¿™ä¸ªç±»ï¼Œç‰¹åˆ«é€‚ç”¨äºé«˜å¹¶å‘è®¿é—®ã€‚<br>â€‹        AtomicIntegerçš„ä¸»è¦æ–¹æ³•æœ‰ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è·å–å½“å‰çš„å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> getAndSet <span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span>
<span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> getAndIncrement <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> getAndDecrement <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> getAndAdd <span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span>
<span class="token comment">//å¦‚æœå½“å‰å€¼==é¢„æœŸå€¼ï¼Œåˆ™è‡ªåŠ¨å°†å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<h4 id="No7-AtomicUseDemo-java"><a href="#No7-AtomicUseDemo-java" class="headerlink" title="No7_AtomicUseDemo.java"></a>No7_AtomicUseDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadsecurity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No7_AtomicUseDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AtomicInteger</span> ai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºçš„ç»“æœä¸ºï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">0</span>
<span class="token number">0</span>
<span class="token number">5</span>
<span class="token number">6</span>
<span class="token number">5</span>
<span class="token number">15</span>
<span class="token boolean">true</span>
<span class="token number">20</span>
<span class="token boolean">false</span>
<span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        åŸå­æ“ä½œ<code>atomic</code>çš„å®ç°åŸç†ï¼Œæ˜¯åˆ©ç”¨CPUçš„æ¯”è¾ƒå¹¶äº¤æ¢(å³<code>CAS:Compare and Swap</code>)å’Œéé˜»å¡ç®—æ³•( <code>nonblocking algorithms</code>)å¦‚æœæŸ¥çœ‹<code>AtormicInteger</code>çš„æºç çš„è¯ä¼šå‘ç°æœ‰äº›æ˜¯é€šè¿‡è°ƒç”¨JNIçš„ä»£ç å®ç°çš„ã€‚<code>JNI (Java Native Interface)</code> ä¸ºJAVAæœ¬åœ°è°ƒç”¨ï¼Œå…è®¸Java è°ƒç”¨å…¶ä»–è¯­è¨€ã€‚è€Œ<code>compareAndSwapInt</code>å°±æ˜¯å€ŸåŠ©Cæ¥è°ƒç”¨CPUåº•å±‚æŒ‡ä»¤å®ç°çš„ã€‚åŸºäº<code>JAVA CAS</code>åŸç†æ·±åº¦åˆ†æè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæˆ‘ä»¬Javaç¨‹åºå‘˜äº†è§£ä¸€äº›å°±è¡Œäº†ã€‚</p>
<h2 id="çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»"><a href="#çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»" class="headerlink" title="çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»"></a>çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»</h2><p>çŸ¥è¯†æ˜¯å­¦å‡ºæ¥çš„.èƒ½åŠ›æ˜¯ç»ƒå‡ºæ¥çš„ã€‚</p>
<p><img src="/image/Concurrent/Concurrent15.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent15.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸€èµ·çœ‹ä¸€ä¸‹Javaä¸­å¸¸ç”¨çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»æœ‰å“ªäº›,å¹¶ä¸”æ¥ä¸€èµ·è®¤è¯†å®ƒã€‚</p>
<h3 id="java-util-Hashtable"><a href="#java-util-Hashtable" class="headerlink" title="java.util.Hashtable"></a>java.util.Hashtable</h3><p>â€‹        <code>Hashtable</code> å’Œ <code>HashMap</code>ä¸€æ ·ï¼Œ<code>Hashtable</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œå®ƒå­˜å‚¨çš„å†…å®¹æ˜¯é”®å€¼å¯¹(<code>key-value</code>)æ˜ å°„ã€‚<br>â€‹        <code>Hashtable</code>ç»§æ‰¿äº<code>Dictionary</code>ï¼Œå®ƒå®ç°äº†<code>Map</code>ã€<code>Cloneable</code>ã€<code>java.io.Serializable</code>æ¥å£ã€‚<br>â€‹        <code>Hashtable</code>çš„å®ä¾‹æœ‰ä¸¤ä¸ªå‚æ•°å½±å“å…¶æ€§èƒ½ï¼šåˆå§‹å®¹é‡å’ŒåŠ è½½å› å­ã€‚å®¹é‡æ˜¯å“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡ï¼Œåˆå§‹å®¹é‡å°±æ˜¯å“ˆå¸Œè¡¨åˆ›å»ºæ—¶çš„å®¹é‡ã€‚æ³¨æ„ï¼Œå“ˆå¸Œè¡¨çš„çŠ¶æ€ä¸º <strong>open</strong>ã€‚åœ¨å‘ç”Ÿâ€œ<strong>å“ˆå¸Œå†²çª</strong>â€çš„æƒ…å†µä¸‹ï¼Œå•ä¸ªæ¡¶ä¼šå­˜å‚¨å¤šä¸ªæ¡ç›®ï¼Œè¿™äº›æ¡ç›®å¿…é¡»æŒ‰é¡ºåºæœç´¢ã€‚åŠ è½½å› å­æ˜¯å¯¹å“ˆå¸Œè¡¨åœ¨å…¶å®¹é‡è‡ªåŠ¨å¢åŠ ä¹‹å‰å¯ä»¥è¾¾åˆ°å¤šæ»¡çš„ä¸€ä¸ªå°ºåº¦ã€‚åˆå§‹å®¹é‡å’ŒåŠ è½½å› å­è¿™ä¸¤ä¸ªå‚æ•°åªæ˜¯å¯¹è¯¥å®ç°çš„æç¤ºã€‚å…³äºä½•æ—¶ä»¥åŠæ˜¯å¦è°ƒç”¨<code>rehash</code>æ–¹æ³•çš„å…·ä½“ç»†èŠ‚åˆ™ä¾èµ–äºè¯¥å®ç°ã€‚<br>â€‹        é€šå¸¸ï¼Œé»˜è®¤<strong>åŠ è½½å› å­</strong>æ˜¯<strong>0.75</strong>ï¼Œè¿™æ˜¯åœ¨æ—¶é—´å’Œç©ºé—´æˆæœ¬ä¸Šå¯»æ±‚ä¸€ç§æŠ˜ä¸­ã€‚åŠ è½½å› å­è¿‡é«˜è™½ç„¶å‡å°‘äº†ç©ºé—´å¼€é”€ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†æŸ¥æ‰¾æŸä¸ªæ¡ç›®çš„æ—¶é—´(åœ¨å¤§å¤šæ•° <code>Hashtable</code>æ“ä½œä¸­ï¼ŒåŒ…æ‹¬ <code>get</code>å’Œ<code>put</code>æ“ä½œï¼Œéƒ½åæ˜ äº†è¿™ä¸€ç‚¹)ã€‚<br>â€‹        <code>Hashtable</code> çš„<strong>å‡½æ•°éƒ½æ˜¯åŒæ­¥çš„</strong>ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ã€‚å®ƒçš„ <code>keyã€value</code>éƒ½<strong>ä¸å¯ä»¥ä¸ºnull</strong>ã€‚æ­¤å¤–ï¼Œ**<code>Hashtable</code>ä¸­çš„æ˜ å°„ä¸æ˜¯æœ‰åºçš„**ã€‚</p>
<p>â€‹        <strong>é‚£ä¹ˆHashtable å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨æ€§çš„å‘¢?ä¸‹é¢æ˜¯ Hashtableçš„æºç :</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token keyword">extends</span> <span class="token class-name">Dictionary</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">,</span><span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span>
        <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

		<span class="token keyword">public</span> <span class="token keyword">synchronized</span> v get <span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Entry</span> tab<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>table<span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„çœç•¥,å…·ä½“çš„å®ç°è°å‚è€ƒjdk å®ç°</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> v <span class="token function">put</span><span class="token punctuation">(</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span>v value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token operator">--</span><span class="token operator">-</span><span class="token comment">//å…·ä½“å®ç°çœç•¥,è¯·å‚è€ƒjdkå®ç°</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> v <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token operator">--</span><span class="token operator">-</span><span class="token comment">//å…·ä½“å®ç°çœç•¥,è¯·å‚è€ƒjdkå®ç°</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span> <span class="token punctuation">></span></span> t<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span>e<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                put <span class="token punctuation">(</span>e<span class="token punctuation">.</span>getKey0<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getvalue</span><span class="token punctuation">(</span><span class="token class-name">O</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token operator">--</span><span class="token operator">-</span><span class="token comment">//å…·ä½“å®ç°çœç•¥,è¯·å‚è€ƒjdkå®ç° </span>
        <span class="token punctuation">&#125;</span>
                <span class="token comment">//---</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä¸Šé¢æ˜¯ <code>Hashtable</code>æä¾›çš„å‡ ä¸ªä¸»è¦æ–¹æ³•,åŒ…æ‹¬ <code>get()</code>ã€<code>put()</code>ã€<code>remove()</code>ç­‰ã€‚æ³¨æ„åˆ°æ¯ä¸ªæ–¹æ³•æœ¬èº«éƒ½æ˜¯ <code>synchronized</code> çš„,ä¸ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„æƒ…å†µï¼Œå› æ­¤ä¿è¯äº†çº¿ç¨‹å®‰å…¨æ€§ã€‚<br>â€‹        <code>Hashtable</code>çš„ä¸»è¦å¯¹å¤–æ¥å£ï¼š</p>
<ul>
<li><code>clear()</code>çš„ä½œç”¨æ˜¯æ¸…ç©º<code>Hashtable</code>ã€‚å®ƒæ˜¯å°†<code>Hashtable</code>çš„ <code>table</code>æ•°ç»„çš„å€¼å…¨éƒ¨è®¾ä¸º<code>null</code>.</li>
<li><code>contains()</code>å’Œ<code>containsValue()</code>çš„ä½œç”¨éƒ½æ˜¯åˆ¤æ–­<code>Hashtable</code>æ˜¯å¦åŒ…å«â€œå€¼(<code>value</code>)â€.</li>
<li><code>containsKey()</code> çš„ä½œç”¨æ˜¯åˆ¤æ–­<code>Hashtable</code>æ˜¯å¦åŒ…å«<code>key</code>.</li>
<li><code>elements()</code>çš„ä½œç”¨æ˜¯è¿”å›â€œæ‰€æœ‰<code>value</code>â€çš„æšä¸¾å¯¹è±¡.</li>
<li><code>Enumerator</code>çš„ä½œç”¨æ˜¯æä¾›äº†â€œé€šè¿‡<code>elements()</code>éå†<code>Hashtable</code>çš„æ¥å£â€ã€‚å› ä¸ºï¼Œå®ƒåŒæ—¶å®ç°äº†â€œ<code>Enumerator</code>æ¥å£â€å’Œâ€œ<code>Iterator</code>æ¥å£â€.</li>
<li><code>entrySet()</code>ã€<code>keySet()</code>ã€<code>keys()</code>ã€<code>values()</code>çš„å®ç°æ–¹æ³•å’Œ<code>elements()</code>å·®ä¸å¤šï¼Œè€Œä¸”æºç ä¸­å·²ç»æ˜ç¡®åœ°ç»™å‡ºäº†æ³¨é‡Šã€‚è¿™é‡Œå°±ä¸å†åšè¿‡å¤šè¯´æ˜äº†.</li>
<li><code>get()</code>çš„ä½œç”¨å°±æ˜¯è·å–<code>key</code>å¯¹åº”çš„ <code>value</code>ï¼Œæ²¡æœ‰çš„è¯è¿”å›<code>null</code>.</li>
<li><code>put()</code>çš„ä½œç”¨æ˜¯å¯¹å¤–æä¾›æ¥å£ï¼Œè®© <code>Hashtable</code>å¯¹è±¡å¯ä»¥é€šè¿‡ <code>put()</code>å°†â€œ<code>key-value</code>â€æ·»åŠ åˆ°<code>Hashtable</code>ä¸­</li>
<li><code>putAll()</code>çš„ä½œç”¨æ˜¯å°†â€œ<code>Map(t)</code>â€ä¸­çš„å…¨éƒ¨å…ƒç´ é€ä¸€æ·»åŠ åˆ°<code>Hashtable</code>ä¸­.</li>
<li><code>remove()</code>çš„ä½œç”¨å°±æ˜¯åˆ é™¤<code>Hashtable</code>ä¸­é”®ä¸ºkeyçš„å…ƒç´ .</li>
</ul>
<p>â€‹        <code>Hashtable</code>å®ç°çš„<code>Cloneable</code>æ¥å£ï¼Œå³å®ç°äº†<code>clone()</code>æ–¹æ³•ã€‚<code>clone()</code>æ–¹æ³•çš„ä½œç”¨å¾ˆç®€å•ï¼Œå°±æ˜¯å…‹éš†ä¸€ä¸ª <code>Hashtable</code>å¯¹è±¡å¹¶è¿”å›ã€‚<br>â€‹        <code>Hashtable</code> å®ç°çš„<code>Serializable</code>æ¥å£åˆ†åˆ«å®ç°äº†ä¸²è¡Œè¯»å–ã€å†™å…¥åŠŸèƒ½ã€‚</p>
<p>â€‹        <code>Hashtable</code>çš„ä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š</p>
<h4 id="No1-HashtableDemo-java"><a href="#No1-HashtableDemo-java" class="headerlink" title="No1_HashtableDemo.java"></a>No1_HashtableDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread_safe_collection_class</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_HashtableDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> numbers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numbers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numbers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numbers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> n <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"two ="</span> <span class="token operator">+</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="java-util-concurrent-ConcurrentHashMap"><a href="#java-util-concurrent-ConcurrentHashMap" class="headerlink" title="java.util.concurrent.ConcurrentHashMap"></a>java.util.concurrent.ConcurrentHashMap</h3><p>â€‹        <code>ConcurrentHashMap</code>ç»§æ‰¿äº<code>AbstractMap</code>ï¼Œå®ç°äº†<code>Map</code>ã€<code>java.io.Serializable</code>æ¥å£ã€‚<br>â€‹        <code>Concurrent.ConcurrentHashMap</code>æ˜¯<strong>å¹¶å‘ç¼–ç¨‹å¤§å¸ˆ Doug Lea</strong> çš„ä½œå“ã€‚è¿™æ˜¯ <code>HashMap</code> çš„çº¿ç¨‹å®‰å…¨ç‰ˆï¼ŒåŒ <code>Hashtable</code>ç›¸æ¯”ï¼Œ<code>ConcurrentHashMap</code>ä¸ä»…ä¿è¯äº†è®¿é—®çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œè€Œä¸”åœ¨æ•ˆç‡ä¸Šä¸<code>Hashtable</code>ç›¸æ¯”ï¼Œæœ‰è¾ƒå¤§çš„æé«˜ã€‚<code>ConcurrentHashMap</code> å…è®¸å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶å‘è¿›è¡Œï¼Œå…¶å…³é”®åœ¨äºä½¿ç”¨äº†é”åˆ†ç¦»æŠ€æœ¯,å³ä»£ç å—é”ï¼Œè€Œä¸æ˜¯æ–¹æ³•é”ã€‚å®ƒä½¿ç”¨äº†å¤šä¸ªé”æ¥æ§åˆ¶å¯¹hash è¡¨çš„ä¸åŒéƒ¨åˆ†è¿›è¡Œçš„ä¿®æ”¹ã€‚<code>ConcurrentHashMap</code>å†…éƒ¨ä½¿ç”¨æ®µ(<code>Segment</code>)æ¥è¡¨ç¤ºè¿™äº›ä¸åŒçš„éƒ¨åˆ†ï¼Œæ¯ä¸ªæ®µå…¶å®å°±æ˜¯ä¸€ä¸ªå°çš„<code>hash table</code>ï¼Œå®ƒä»¬æœ‰è‡ªå·±çš„é”(ç”±<code>ReentrantLock</code>æ¥å®ç°çš„)ã€‚åªè¦å¤šä¸ªä¿®æ”¹æ“ä½œå‘ç”Ÿåœ¨ä¸åŒçš„æ®µä¸Šï¼Œå®ƒä»¬å°±å¯ä»¥å¹¶å‘è¿›è¡Œã€‚<br>â€‹        <code>ConcurrentHashMap</code>çš„éƒ¨åˆ†æºç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
	<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">2249069246763182397L</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span>
        <span class="token class-name">Segment</span><span class="token punctuation">(</span><span class="token keyword">float</span> lf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> lf<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <code>ConcurrentHashMap</code>å¸¸ç”¨çš„ä¸»è¦å¯¹å¤–æ¥å£ï¼š</p>
<ul>
<li><p><code>clear()</code>çš„ä½œç”¨æ˜¯æ¸…ç©º<code>ConcurrentHashMap</code>ã€‚</p>
</li>
<li><p><code>contains()</code>å’Œ<code>containsValue()</code>çš„ä½œç”¨éƒ½æ˜¯åˆ¤æ–­<code>ConcurrentHashMap</code>æ˜¯å¦åŒ…å«â€œ**å€¼(<code>value</code>)**â€ã€‚</p>
</li>
<li><p><code>containsKey()</code>çš„ä½œç”¨æ˜¯åˆ¤æ–­<code>ConcurrentHashMap</code>æ˜¯å¦åŒ…å«keyã€‚</p>
</li>
<li><p><code>elements()</code>çš„ä½œç”¨æ˜¯è¿”å›â€œ<strong>æ‰€æœ‰value</strong>â€çš„æšä¸¾å¯¹è±¡ã€‚</p>
</li>
<li><p><code>Enumerator</code> çš„ä½œç”¨æ˜¯æä¾›äº†â€œé€šè¿‡<code>elements()</code>éå†<code>Hashtable</code>çš„æ¥å£â€å’Œâ€œé€šè¿‡<code>entrySet()</code>éå†<code>ConcurrentHashMap</code>çš„æ¥å£â€ã€‚<strong>å› ä¸ºï¼Œå®ƒåŒæ—¶å®ç°äº†â€œ<code>Enumeratoræ¥å£</code>â€å’Œâ€œ<code>Iteratoræ¥å£</code>â€ã€‚</strong></p>
</li>
<li><p><code>entrySet()</code>ã€<code>keySet()</code>ã€<code>keys()</code>ã€ <code>values()</code>çš„å®ç°æ–¹æ³•å’Œ<code>elements()</code>å·®ä¸å¤šï¼Œè€Œä¸”æºç ä¸­å·²ç»æ˜ç¡®åœ°ç»™å‡ºäº†æ³¨é‡Š,è¿™é‡Œå°±ä¸å†åšè¿‡å¤šè¯´æ˜äº†ã€‚</p>
</li>
<li><p><code>get()</code>çš„ä½œç”¨å°±æ˜¯è·å–<strong>key</strong>å¯¹åº”çš„ <strong>value</strong>ï¼Œæ²¡æœ‰çš„è¯è¿”å›<strong>null</strong>ã€‚</p>
</li>
<li><p><code>put()</code>çš„ä½œç”¨æ˜¯å¯¹å¤–æä¾›æ¥å£ï¼Œè®© <code>ConcurrentHashMap</code>å¯¹è±¡å¯ä»¥é€šè¿‡<code>put()</code>å°†â€œ<code>key-value</code>â€æ·»åŠ åˆ° <code>ConcurrentHashMap</code>ä¸­ã€‚</p>
</li>
<li><p><code>putAll()</code>çš„ä½œç”¨æ˜¯å°†â€œ<code>Map(t)</code>â€ä¸­çš„<strong>å…¨éƒ¨å…ƒç´ </strong>é€ä¸€æ·»åŠ åˆ°<code>ConcurrentHashMap</code>ä¸­ã€‚</p>
</li>
<li><p><code>remove()</code>çš„ä½œç”¨å°±æ˜¯<strong>åˆ é™¤</strong><code>ConcurrentHashMap</code>ä¸­é”®ä¸º<strong>key</strong> çš„å…ƒç´ ã€‚</p>
<p><code>ConcurrentHashMap</code> å®ç°çš„<code>Serializable</code>æ¥å£åˆ†åˆ«å®ç°äº†<strong>ä¸²è¡Œè¯»å–ã€å†™å…¥</strong>åŠŸèƒ½ã€‚</p>
<p><code>ConcurrentHashMap</code>ä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<h4 id="No2-ConcurrentHashMapDemo-java"><a href="#No2-ConcurrentHashMapDemo-java" class="headerlink" title="No2_ConcurrentHashMapDemo.java"></a>No2_ConcurrentHashMapDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread_safe_collection_class</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_ConcurrentHashMapDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="java-util-concurrent-CopyOnWriteArrayList"><a href="#java-util-concurrent-CopyOnWriteArrayList" class="headerlink" title="java.util.concurrent.CopyOnWriteArrayList"></a>java.util.concurrent.CopyOnWriteArrayList</h3><p>â€‹        <code>CopyOnWriteArrayList</code> ä¸­çš„<code>set</code>ã€<code>add</code>ã€<code>remove</code>ç­‰æ–¹æ³•ï¼Œéƒ½ä½¿ç”¨äº†<code>ReentrantLock</code> çš„ <code>lock()</code>æ¥åŠ é”ï¼Œ<code>unlock()</code>æ¥è§£é”ã€‚å½“å¢åŠ å…ƒç´ çš„æ—¶å€™ä½¿ç”¨<code>Arrays.copyOf()</code>æ¥<strong>æ‹·è´</strong>å‰¯æœ¬ï¼Œåœ¨å‰¯æœ¬ä¸Šå¢åŠ å…ƒç´ ï¼Œç„¶åæ”¹å˜åŸå¼•ç”¨æŒ‡å‘å‰¯æœ¬ã€‚è¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼Œè€Œå†™æ“ä½œç±»å®ç°ä¸­å¯¹å…¶è¿›è¡Œäº†åŠ é”ã€‚å› æ­¤ï¼Œ<code>CopyOnWriteArrayList</code> ç±»æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ <code>List</code>æ¥å£çš„å®ç°ï¼Œè¿™å¯¹äºè¯»æ“ä½œè¿œè¿œå¤šäºå†™æ“ä½œçš„åº”ç”¨éå¸¸é€‚åˆã€‚ç‰¹åˆ«æ˜¯åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯ä»¥æä¾›é«˜æ€§èƒ½çš„å¹¶å‘è¯»å–ï¼Œå¹¶ä¸”ä¿è¯è¯»å–çš„å†…å®¹ä¸€å®šæ˜¯æ­£ç¡®çš„,ä¸å—å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜å½±å“çš„ã€‚<br>â€‹        ä¸”çœ‹<code>CopyOnWriteArrayList</code>éƒ¨åˆ†æºç ,å…¶ä¸­çš„ä¸€ä¸ªç®€å•<code>add</code>æ–¹æ³•çš„å®ç°:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
    
    	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span><span class="token comment">//åŠ é”çš„å®‰å…¨æœºåˆ¶</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//finally é‡Œé¢é‡Šæ”¾é”</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    
        <span class="token comment">//getæ–¹æ³•æ²¡æœ‰åŠ é”</span>
        <span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> a<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>â€‹        <code>CopyOnWriteArrayList</code>ä¸»è¦çš„å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š</p>
<ul>
<li><code>boolean add(E e)</code>ï¼Œåœ¨<code>list</code>æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>void add(int indexï¼ŒE element)</code>ï¼Œåœ¨æŒ‡å®šä½ç½®æ·»åŠ å…ƒç´ ã€‚</li>
<li><code>boolean addAll(Collection&lt;? extends E&gt;c)</code>ï¼Œåœ¨å°¾éƒ¨å¢åŠ æ•´ä¸ª <code>Collection</code>å¯¹è±¡ã€‚</li>
<li><code>boolean addAll(int indexï¼Œ Collection&lt;? extends E&gt; c)</code>ï¼Œåœ¨ç´¢å¼•æŒ‡å®šçš„ä½ç½®æ’å…¥<code>Collection</code>å¯¹è±¡å¹¶ç§»åŠ¨åŸä½ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰çš„å¯¹è±¡ã€‚</li>
<li><code>void clear()</code>ï¼Œæ¸…ç©º<code>list</code>é›†åˆã€‚</li>
<li><code>Object clone()</code>ï¼Œç”±äºå®ç°äº†<code>Cloneable</code>æ¥å£ï¼Œæ‰€ä»¥æ”¯æŒå…‹éš†ã€‚</li>
<li><code>boolean contains(Object o)</code>ï¼Œæ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ ã€‚</li>
<li><code>E get(int index)</code>ï¼Œè·å¾—æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</li>
<li><code>boolean isEmpty()</code>ï¼ŒåŠæ®µé›†åˆæ˜¯å¦æ˜¯ç©ºçš„ã€‚</li>
<li><code>Iterator&lt;E&gt; iterator()</code>çš„ä½œç”¨æ˜¯æä¾›äº†â€œé€šè¿‡ <code>elements()</code>éå†ã€‚å› ä¸ºï¼Œå®ƒåŒæ—¶å®ç°äº†â€œ<code>Enumerator</code>æ¥å£â€å’Œâ€œ<code>Iterator</code>æ¥å£â€ã€‚</li>
<li><code>ListIterator&lt;E&gt; listIterator()</code>çš„ä½œç”¨æ˜¯æä¾›äº†â€œé€šè¿‡<code>elements()</code>éå†ã€‚å› ä¸ºï¼Œå®ƒåŒæ—¶å®ç°äº†â€œ<code>Enumerator</code>æ¥å£â€å’Œâ€œ<code>Iterator</code>æ¥å£â€ã€‚</li>
<li><code>E remove(int index)</code>ï¼Œåˆ é™¤æŒ‡å®šå…ƒç´ ã€‚</li>
<li><code>&lt;T&gt; T[] toArray(T a[])</code>ï¼Œå°†é›†åˆè½¬æ¢æˆæ•°ç»„ã€‚</li>
</ul>
<p><code>CopyOnWriteArrayList</code>ç®€å•çš„ä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š</p>
<h4 id="No3-CopyOnWriteArrayListDemo-java"><a href="#No3-CopyOnWriteArrayListDemo-java" class="headerlink" title="No3_CopyOnWriteArrayListDemo.java"></a>No3_CopyOnWriteArrayListDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread_safe_collection_class</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CopyOnWriteArrayList</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_CopyOnWriteArrayListDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//listä¸‹æ ‡æ˜¯ä»é›¶å¼€å§‹çš„</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">two
one
two
three<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="java-util-concurrent-CopyOnWriteArraySet"><a href="#java-util-concurrent-CopyOnWriteArraySet" class="headerlink" title="java.util.concurrent.CopyOnWriteArraySet"></a>java.util.concurrent.CopyOnWriteArraySet</h3><p>â€‹        <code>CopyOnWriteArraySet</code> æ˜¯åœ¨ <code>CopyOnWriteArrayList</code> çš„åŸºç¡€ä¸Šä½¿ç”¨äº†<code>Java</code>çš„<strong>è£…é¥°æ¨¡å¼</strong>ï¼Œå¾ˆå¤šæ–¹æ³•å¦‚ï¼šå‚¨å­˜ä»‹è´¨ä½¿ç”¨äº†<code>CopyOnWriteArrayList</code> æ¥å­˜å‚¨æ•°æ®, <code>remove</code>æ–¹æ³•è°ƒç”¨<code>CopyOnWriteArrayList</code>çš„<code>remove</code>æ–¹æ³•ï¼Œ<code>add</code>æ–¹æ³•è°ƒç”¨äº†<code>CopyOnWriteArrayList</code> çš„ <code>addIfAbsent</code> æ–¹æ³•ã€‚æ‰€ä»¥<code>CopyOnWriteArrayList</code> çš„å®ç°åŸç†é€‚ç”¨<code>CopyOnWriteArraySet</code>ã€‚<br>â€‹        ä¸”çœ‹<code>CopyOnWriteArraySet</code>çš„ä¸€æ®µæºç :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//çœ‹çš„å‡ºæ¥å¤§éƒ¨åˆ†éƒ½æ˜¯è°ƒç”¨Copy0nwriteArrayListçš„API å®ç°çš„</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> al<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        al <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        al<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> al<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> al<span class="token punctuation">.</span><span class="token function">addIfAbsent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    â€¦<span class="token comment">//å¤§éƒ¨åˆ†ä»£ç çš†æ˜¯å¦‚æ­¤</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <code>CopyOnWriteArraySet</code>ä¸»è¦çš„å¸¸ç”¨æ–¹æ³•æœ‰:</p>
<ul>
<li><code>boolean add(E e)</code>ï¼Œåœ¨ <code>list</code>æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>boolean addAll(Collection&lt;? extends E&gt; c)</code>ï¼Œåœ¨å°¾éƒ¨å¢åŠ æ•´ä¸ª<code>Collection</code>å¯¹è±¡ã€‚</li>
<li><code>void clear()</code>ï¼Œæ¸…ç©º<code>list</code>é›†åˆã€‚</li>
<li><code>boolean contains(Object o)</code>ï¼Œæ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ ã€‚</li>
<li><code>boolean isEmpty()</code>ï¼Œåˆ¤æ–­é›†åˆæ˜¯å¦ç©ºçš„ã€‚</li>
<li><code>Iterator&lt;E&gt; iterator()</code>çš„ä½œç”¨æ˜¯æä¾›äº†å¯¹<code>elements()</code>éå†ã€‚å› ä¸ºï¼Œå®ƒåŒæ—¶å®ç°äº†â€œ<code>Enumerator</code>æ¥å£â€å’Œâ€œ<code>Iterator</code>æ¥å£â€ã€‚</li>
<li><code>E remove(int index)</code>ï¼Œåˆ é™¤æŒ‡å®šå…ƒç´ ã€‚</li>
<li><code>&lt;T&gt; T[] toArray(T a[])</code>ï¼Œå°†é›†åˆè½¬æ¢æˆæ•°ç»„ã€‚</li>
</ul>
<p>â€‹        <code>CopyOnWriteArraySet</code>ç®€å•çš„ä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š</p>
<h4 id="No4-CopyOnWriteArraySetDemo-java"><a href="#No4-CopyOnWriteArraySetDemo-java" class="headerlink" title="No4_CopyOnWriteArraySetDemo.java"></a>No4_CopyOnWriteArraySetDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread_safe_collection_class</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CopyOnWriteArraySet</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_CopyOnWriteArraySetDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>set<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> set<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <strong>Java</strong>é‡Œé¢<code>List</code>å’Œ<code>Set</code>çš„ç›¸åŒå’ŒåŒºåˆ«åŒæ ·é€‚ç”¨äº<code>CopyOnWriteArrayList</code>å’Œ<code>CopyOnWriteArraySet</code> <strong>ä¸åŒä¹‹å¤„æ˜¯åä¸¤è€…æ˜¯çº¿ç¨‹å®‰å…¨æœºåˆ¶ã€‚</strong></p>
<h3 id="CopyOnWriteæœºåˆ¶ä»‹ç»"><a href="#CopyOnWriteæœºåˆ¶ä»‹ç»" class="headerlink" title="CopyOnWriteæœºåˆ¶ä»‹ç»"></a>CopyOnWriteæœºåˆ¶ä»‹ç»</h3><p>â€‹        <code>CopyOnWrite</code>å®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚é€šä¿—çš„ç†è§£æ˜¯å½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨è¿›è¡Œ<strong>Copy</strong>ï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶åæ–°çš„å®¹å™¨é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´ ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹<code>CopyOnWrite</code>å®¹å™¨è¿›è¡Œå¹¶å‘åœ°è¯»ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥<code>CopyOnWrite</code>å®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨ã€‚<br>â€‹        æˆ‘ä»¬ä» <code>CopyOnWriteArrayList</code>ä¹‹å‰çš„åˆ†æå’Œæºç ä¸­å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œ<code>ArrayList</code>é‡Œæ·»åŠ å…ƒç´ ,å¯ä»¥å‘ç°åœ¨æ·»åŠ çš„æ—¶å€™æ˜¯éœ€è¦åŠ é”çš„ï¼Œå¦åˆ™å¤šçº¿ç¨‹å†™çš„æ—¶å€™ä¼š<code>Copy</code>å‡º<strong>N</strong>ä¸ªå‰¯æœ¬å‡ºæ¥ã€‚<br>â€‹        è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œå¦‚æœè¯»çš„æ—¶å€™æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨å‘<code>ArrayList</code>æ·»åŠ æ•°æ®ï¼Œè¿˜æ˜¯ä¼šè¯»åˆ°æ—§çš„æ•°æ®,å› ä¸ºå†™çš„æ—¶å€™ä¸ä¼šé”ä½æ—§çš„<code>ArrayList</code>ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> get <span class="token punctuation">(</span>getArray o<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        JDKä¸­å¹¶æ²¡æœ‰æä¾›<code>CopyOnWriteMap</code>ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ<code>CopyOnWriteArrayList</code> æ¥å®ç°ä¸€ä¸ªï¼ŒåŸºæœ¬ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>internalMap<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">CopyOnWriteMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		internalMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">public</span> v <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> v value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span>v<span class="token punctuation">></span></span> newMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>internalMap<span class="token punctuation">)</span> <span class="token punctuation">;</span>
			<span class="token class-name">V</span> val <span class="token operator">=</span> newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			internalMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
			<span class="token keyword">return</span> val<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">public</span> v get <span class="token punctuation">(</span><span class="token number">0</span>bject key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> internalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> extendo v<span class="token punctuation">></span></span> nowData<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>internalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
			newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>newData<span class="token punctuation">)</span><span class="token punctuation">;</span>
			internalMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>â€‹        å®ç°å¾ˆç®€å•ï¼Œåªè¦äº†è§£äº†<code>CopyOnWrite</code>æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å„ç§<code>CopyOnWrite</code>å®¹å™¨ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­ä½¿ç”¨ã€‚<br>â€‹        <code>CopyOnWrite</code>çš„åº”ç”¨åœºæ™¯ï¼š<code>CopyOnWrite</code>å¹¶å‘å®¹å™¨ç”¨äºè¯»å¤šå†™å°‘çš„å¹¶å‘åœºæ™¯ï¼Œæ¯”å¦‚ç™½åå•ï¼Œé»‘åå•ï¼Œå•†å“ç±»ç›®çš„è®¿é—®å’Œæ›´æ–°ç­‰ç­‰åœºæ™¯ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæœç´¢ç½‘ç«™ï¼Œç”¨æˆ·åœ¨è¿™ä¸ªç½‘ç«™çš„æœç´¢æ¡†ä¸­ï¼Œè¾“å…¥å…³é”®å­—æœç´¢å†…å®¹ï¼Œä½†æ˜¯æŸäº›å…³é”®å­—ä¸å…è®¸è¢«æœç´¢ã€‚è¿™äº›ä¸èƒ½è¢«æœç´¢çš„å…³é”®å­—ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªé»‘åå•å½“ä¸­ï¼Œé»‘åå•æ¯å¤©æ™šä¸Šæ›´æ–°ä¸€æ¬¡ã€‚å½“ç”¨æˆ·æœç´¢æ—¶ï¼Œä¼šæ£€æŸ¥å½“å‰å…³é”®å­—åœ¨ä¸åœ¨é»‘åå•å½“ä¸­,å¦‚æœåœ¨,åˆ™æç¤ºä¸èƒ½æœç´¢ã€‚<br>â€‹        ä»£ç å¾ˆç®€å•ï¼Œä½†æ˜¯ä½¿ç”¨<code>CopyOnWriteMap</code>éœ€è¦æ³¨æ„ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>å‡å°‘æ‰©å®¹å¼€é”€ã€‚æ ¹æ®å®é™…éœ€è¦ï¼Œåˆå§‹åŒ– <code>CopyOnWriteMap</code>çš„å¤§å°ï¼Œé¿å…å†™æ—¶<code>CopyOnWriteMap</code>æ‰©å®¹çš„å¼€é”€ã€‚</li>
<li>ä½¿ç”¨æ‰¹é‡æ·»åŠ ã€‚å› ä¸ºæ¯æ¬¡æ·»åŠ ,å®¹å™¨æ¯æ¬¡éƒ½ä¼šè¿›è¡Œå¤åˆ¶ï¼Œæ‰€ä»¥å‡å°‘æ·»åŠ æ¬¡æ•°ï¼Œå¯ä»¥å‡å°‘å®¹å™¨çš„å¤åˆ¶æ¬¡æ•°ã€‚å¦‚ä½¿ç”¨ä¸Šé¢ä»£ç é‡Œçš„<code>addBlackList</code>æ–¹æ³•ã€‚</li>
</ul>
<p>â€‹        <code>CopyOnWrite</code>çš„ç¼ºç‚¹:<br>â€‹        (1)å†…å­˜å ç”¨é—®é¢˜ã€‚å› ä¸º<code>CopyOnWrite</code>çš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå†…å­˜é‡Œä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜ï¼Œæ—§çš„å¯¹è±¡å’Œæ–°å†™å…¥çš„å¯¹è±¡ï¼ˆæ³¨æ„ï¼šåœ¨å¤åˆ¶çš„æ—¶å€™åªæ˜¯å¤åˆ¶å®¹å™¨é‡Œçš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨å†™çš„æ—¶å€™ä¼šåˆ›å»ºæ–°å¯¹è±¡æ·»åŠ åˆ°æ–°å®¹å™¨é‡Œï¼Œè€Œæ—§å®¹å™¨çš„å¯¹è±¡è¿˜åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰ä¸¤ä»½å¯¹è±¡å†…å­˜)ã€‚å¦‚æœè¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚è¯´200MB å·¦å³ï¼Œé‚£ä¹ˆå†å†™å…¥100MB æ•°æ®è¿›å»ï¼Œå†…å­˜å°±ä¼šå ç”¨300MBï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¾ˆæœ‰å¯èƒ½é€ æˆé¢‘ç¹çš„<code>Yong GC</code>å’Œ<code>Full GC</code>ã€‚ä¹‹å‰æˆ‘ä»¬ç³»ç»Ÿä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœåŠ¡ç”±äºæ¯æ™šä½¿ç”¨<code>CopyOnWrite</code>æœºåˆ¶æ›´æ–°å¤§å¯¹è±¡ï¼Œé€ æˆäº†<strong>æ¯æ™š15s</strong>çš„<code>Full GC</code>,åº”ç”¨å“åº”æ—¶é—´ä¹Ÿéšä¹‹å˜é•¿ã€‚é’ˆå¯¹å†…å­˜å ç”¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‹ç¼©å®¹å™¨ä¸­çš„å…ƒç´ çš„æ–¹æ³•æ¥å‡å°‘å¤§å¯¹è±¡çš„å†…å­˜æ¶ˆè€—ã€‚<br>â€‹        (2ï¼‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚<code>CopyOnWrite</code>å®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„æ•°æ®é©¬ä¸Šèƒ½è¯»åˆ°,è¯·ä¸è¦ä½¿ç”¨<code>CopyOnWrite</code>å®¹å™¨ã€‚</p>
<h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><p>â€‹        <code>Vector</code>æ˜¯çŸ¢é‡é˜Ÿåˆ—,é€šè¿‡æ•°ç»„ä¿å­˜æ•°æ®ã€‚å®ƒç»§æ‰¿äº<code>AbstractList</code>ï¼Œå®ç°äº†<code>List</code>ã€<code>RandomAccess</code>ã€<code>Cloneable</code>è¿™äº›æ¥å£ã€‚<br>â€‹        <code>Vector</code> ç»§æ‰¿äº†<code>AbstractList</code>ï¼Œå®ç°äº†<code>List</code>ï¼›æ‰€ä»¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ”¯æŒç›¸å…³çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€éå†ç­‰åŠŸèƒ½ã€‚<br>â€‹        <code>Vector</code> å®ç°äº†<code>RandmoAccess</code> æ¥å£ï¼Œ<strong>å³æä¾›äº†éšæœºè®¿é—®åŠŸèƒ½</strong>ã€‚<code>RandmoAccess</code> æ˜¯ <code>Java</code>ä¸­ç”¨æ¥è¢«<code>List</code>å®ç°ï¼Œä¸º<code>List</code>æä¾›å¿«é€Ÿè®¿é—®åŠŸèƒ½çš„ã€‚åœ¨<code>Vector</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡,è¿™å°±æ˜¯å¿«é€Ÿéšæœºè®¿é—®ã€‚<br>â€‹        <code>Vector</code>å®ç°äº†<code>Cloneable</code>æ¥å£,å³å®ç°<code>clone()</code>å‡½æ•°ã€‚å®ƒèƒ½è¢«å…‹éš†ã€‚<br>â€‹        å’Œ<code>ArrayList</code>ä¸åŒï¼Œ<code>Vector</code> ä¸­çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒæ˜¯<strong>åˆ©ç”¨<code>synchronized</code>åŒæ­¥æ˜¾ç¤ºé”</strong>çš„æ–¹æ³•é”çš„æœºåˆ¶å®ç°ï¼Œå®ç°å®‰å…¨æœºåˆ¶ç±»ä¼¼<code>Hashtable</code> ã€‚<br>â€‹        ä¸‹é¢çœ‹ä¸€ä¸‹çš„ <code>Vector</code> çš„æºç ,æ³¨æ„æ–¹æ³•é”ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">protected</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elementData<span class="token punctuation">;</span>
	
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addElement</span><span class="token punctuation">(</span><span class="token class-name">E</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        modCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">ensureCapacityHelper</span><span class="token punctuation">(</span>elementCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elementData<span class="token punctuation">[</span>elementCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">removeElement</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        modCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">removeElementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//åŒæ­¥æ–¹æ³•é”</span>
	<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> elementCount<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArrayIndexOutOfBoundsException</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">elementData</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä¸Šé¢æ˜¯<code>Vector</code> æä¾›çš„å‡ ä¸ªä¸»è¦æ–¹æ³•ï¼ŒåŒ…æ‹¬<code>addElement()</code>ã€<code>removeElement()</code>ã€<code>get()</code>ç­‰ã€‚æ³¨æ„åˆ°æ¯ä¸ªæ–¹æ³•æœ¬èº«éƒ½æ˜¯<code>synchronized</code>çš„ï¼Œä¸ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„æƒ…å†µï¼Œå› æ­¤ä¿è¯äº†çº¿ç¨‹å®‰å…¨æ€§ã€‚<br>â€‹        <code>Vector</code>å¸¸ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼Œä¸å…¶ä»–é›†åˆç±»çš„æ–¹æ³•å¤§åŒå°å¼‚ï¼Œæˆ‘ä»¬å°±çœ‹å‡ ä¸ªä¾‹å­å§ï¼š</p>
<ul>
<li><code>void addElement(E obj)</code>ï¼Œæ·»åŠ å…ƒç´ ã€‚</li>
<li><code>void clear()</code>ï¼Œæ¸…ç©ºé›†åˆã€‚</li>
<li><code>Object clone()</code>ï¼Œé›†åˆå…‹éš†ã€‚</li>
<li><code>boolean contains(Object o)</code>ï¼Œæ˜¯å¦åŒ…å«æŸä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>E firstElement()</code>ï¼Œè·å¾—ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>int indexOf(Object o)</code>ï¼Œå¾—åˆ°ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ã€‚</li>
<li><code>boolean isEmpty()</code>ï¼Œåˆ¤æ–­é›†åˆæ˜¯å¦ç©ºçš„ã€‚</li>
<li><code>Iterator&lt;E&gt; iterator()</code>ï¼Œè·å¾—<code>iterator</code>é›†åˆå¯¹è±¡ã€‚</li>
<li><code>E lastElement()</code>ï¼Œè·å¾—æœ€åä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>boolean removeElement(Object obj)</code>ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>Object[] toArray()</code>ï¼Œå¾—åˆ°ä¸€ä¸ªæ•°ç»„ç»“æœé›†ã€‚</li>
</ul>
<p><code>Vector</code>çš„ä½¿ç”¨å®ä¾‹ï¼š</p>
<h4 id="No5-VectorDemo-java"><a href="#No5-VectorDemo-java" class="headerlink" title="No5_VectorDemo.java"></a>No5_VectorDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>thread_safe_collection_class</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Vector</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_VectorDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add ä¹Ÿå¯ä»¥</span>
        list<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">removeElement</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="å¸¸ç”¨çš„StringBufferä¸-StringBuilder"><a href="#å¸¸ç”¨çš„StringBufferä¸-StringBuilder" class="headerlink" title="å¸¸ç”¨çš„StringBufferä¸ StringBuilder"></a>å¸¸ç”¨çš„StringBufferä¸ StringBuilder</h3><p>â€‹        <strong>åœ¨ç¼–å†™JAVAä»£ç çš„è¿‡ç¨‹ä¸­æœ‰æ—¶è¦é¢‘ç¹åœ°å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥</strong>ï¼Œå¦‚æœç›´æ¥ç”¨â€œ**+<strong>â€</strong>æ‹¼æ¥<strong>çš„è¯ä¼šå»ºç«‹å¾ˆå¤šçš„ <strong>String</strong> å‹</strong>å¯¹è±¡<strong>ï¼Œ</strong>ä¸¥é‡çš„è¯ä¼šå¯¹æœåŠ¡å™¨èµ„æºå’Œæ€§èƒ½é€ æˆä¸å°çš„å½±å“**ï¼›è€Œä½¿ç”¨ <code>StringBuilder</code>å’Œ<code>StringBuffer</code>èƒ½è§£å†³ä»¥ä¸Šé—®é¢˜ã€‚è€Œ<code>StringBuffer</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œ<code>StringBuilder</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br>â€‹        æ¥çœ‹ä¸€ä¸‹ <code>StringBuffer</code> çš„ä¸€äº›æºç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StringBuffer</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractStringBuilder</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">CharSequence</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">//æ–¹æ³•åŒæ­¥é”</span>
	<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">StringBuffer</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        toStringCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//æ–¹æ³•åŒæ­¥é”</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toStringCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            toStringCache <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>toStringCache<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è€Œ<code>StringBuilder</code>çš„æºç ä¸€éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StringBuilder</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractStringBuilder</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">CharSequence</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Create a copy, don't share the array</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è€Œä¸ä¹‹å¯¹åº”çš„<code>StringBuilder</code>æ˜¯<strong>çº¿ç¨‹ä¸å®‰å…¨</strong>çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŠ  <code>synchronized</code><strong>é”</strong>ã€‚æ‰€ä»¥ä¸éš¾çœ‹å‡ºæˆ‘ä»¬åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸éœ€è¦è€ƒè™‘æ•°æ®å®‰å…¨é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨<code>StringBuffer</code>ï¼Œç”±äºæ²¡æœ‰èµ„æºç­‰å¾…çš„æƒ…å†µè‚¯å®šæ‰§è¡Œæ•ˆç‡å’Œæ€§èƒ½ä¼šé«˜å¾ˆå¤šæ‰€ä»¥æ˜¯ä½¿ç”¨<code>StringBuffer</code>è¿˜æ˜¯ä½¿ç”¨<code>StringBuilder</code>è¦è§†æƒ…å†µè€Œå®šã€‚</p>
<p>â€‹        ä¸‹é¢æˆ‘ä»¬å¯¹çº¿ç¨‹å®‰å…¨åšä¸ªå°ç»“ï¼š<br>â€‹        é€šè¿‡ç¬¬3ç« ã€ç¬¬4ç«   (<strong>ç¬¬3ç« Threadå®‰å…¨ã€ç¬¬4ç« çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»</strong>)  å­¦ä¹ æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œ<strong>åœ¨æŒæ¡äº†çº¿ç¨‹çš„å®‰å…¨åŸç†å’Œé”çš„æœºåˆ¶çš„æƒ…å†µä¸‹å†å»ç†è§£å’ŒæŸ¥çœ‹Javaé‡Œé¢æ‰€æä¾›çš„çº¿ç¨‹çš„å®‰å…¨ç±»ï¼Œæˆ‘ä»¬å°±çŸ¥é“æ€ä¹ˆå›äº‹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—¥å¸¸çš„Webå¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥é€‚å½“åœ°æ ¹æ®åŸç†å’Œä¸šåŠ¡å†™å‡ºè‡ªå·±çš„çº¿ç¨‹å®‰å…¨ç±»</strong>ã€‚</p>
<p>â€‹        æœ€åå…³äºæ‰§è¡Œæ•ˆç‡æ€»ç»“ä¸€å¥ï¼šæœ‰å…³ä»£ç æ‰§è¡Œæ•ˆç‡ï¼Œæ²¡æœ‰åŠ é”çš„ã€ä¸éœ€è¦åŒæ­¥å®‰å…¨çš„ä»£ç    <strong>æ‰§è¡Œæ•ˆç‡æœ€é«˜&gt;æ–¹æ³•å—é”&gt;ç±»é”å’Œæ–¹æ³•é”</strong>ï¼Œ<strong>åŒæ—¶è¦æ³¨æ„è¯»å†™åˆ†ç¦»çš„ä¸šåŠ¡åœºæ™¯</strong>ã€‚çŸ¥è¯†æ˜¯å­¦å‡ºæ¥çš„ï¼Œèƒ½åŠ›æ˜¯ç»ƒå‡ºæ¥çš„,å­¦ä¹ äº†è¦ç†Ÿç»ƒç”¨ä¹‹äºå®è·µã€‚</p>
<h1 id="çº¿ç¨‹å¹¶å‘æ™‹çº§ä¹‹é«˜çº§éƒ¨åˆ†"><a href="#çº¿ç¨‹å¹¶å‘æ™‹çº§ä¹‹é«˜çº§éƒ¨åˆ†" class="headerlink" title="çº¿ç¨‹å¹¶å‘æ™‹çº§ä¹‹é«˜çº§éƒ¨åˆ†"></a>çº¿ç¨‹å¹¶å‘æ™‹çº§ä¹‹é«˜çº§éƒ¨åˆ†</h1><h2 id="å¤šçº¿ç¨‹ä¹‹é—´äº¤äº’-çº¿ç¨‹é˜€"><a href="#å¤šçº¿ç¨‹ä¹‹é—´äº¤äº’-çº¿ç¨‹é˜€" class="headerlink" title="å¤šçº¿ç¨‹ä¹‹é—´äº¤äº’:çº¿ç¨‹é˜€"></a>å¤šçº¿ç¨‹ä¹‹é—´äº¤äº’:çº¿ç¨‹é˜€</h2><p>æŠ•å…¥å¤šå°‘ï¼Œæ”¶è·å¤šå°‘:å‚ä¸å¤šæ·±,é¢†æ‚Ÿå¤šæ·±ã€‚</p>
<p>çº¿ç¨‹é˜€æ˜¯ä¸€ç§çº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´ç›¸äº’åˆ¶çº¦å’Œäº¤äº’çš„æœºåˆ¶ã€‚</p>
<h3 id="é˜»å¡é˜Ÿåˆ—BlockingQueue"><a href="#é˜»å¡é˜Ÿåˆ—BlockingQueue" class="headerlink" title="é˜»å¡é˜Ÿåˆ—BlockingQueue"></a>é˜»å¡é˜Ÿåˆ—BlockingQueue</h3><p>â€‹        å…ˆç†è§£<code>Queue</code>ã€<code>Deque</code>ã€ <code>BlockingQueue</code> çš„æ¦‚å¿µã€‚<br>â€‹        â—<code>Queue </code>(<strong>é˜Ÿåˆ—</strong>)ï¼šç”¨äºä¿å­˜ä¸€ç»„å…ƒç´ ï¼Œä¸è¿‡åœ¨å­˜å–å…ƒç´ çš„æ—¶å€™å¿…é¡»éµå¾ªå…ˆè¿›å…ˆå‡ºåŸåˆ™ã€‚é˜Ÿåˆ—æ˜¯ä¸€ä¸€ç§ç‰¹æ®Šçš„çº¿æ€§è¡¨ï¼Œå®ƒåªå…è®¸åœ¨è¡¨çš„å‰ç«¯(<code>front</code>)è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè€Œåœ¨è¡¨çš„åç«¯(<code>rear</code>)è¿›è¡Œæ’å…¥æ“ä½œã€‚è¿›è¡Œæ’å…¥æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå°¾ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå¤´ã€‚é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œç§°ä¸ºç©ºé˜Ÿåˆ—ã€‚åœ¨é˜Ÿåˆ—è¿™ç§æ•°æ®ç»“æ„ä¸­ï¼Œæœ€å…ˆæ’å…¥çš„å…ƒç´ å°†æ˜¯æœ€å…ˆè¢«åˆ é™¤çš„å…ƒç´ ï¼›åä¹‹æœ€åæ’å…¥çš„å…ƒç´ å°†æ˜¯æœ€åè¢«åˆ é™¤çš„å…ƒç´ ï¼Œå› æ­¤é˜Ÿåˆ—åˆç§°ä¸ºâ€œ<strong>å…ˆè¿›å…ˆå‡º</strong>â€(<code>FIFO- first in first out</code>)çš„<strong>çº¿æ€§è¡¨</strong>ã€‚<br>â€‹        â—<code>Deque</code> (<strong>åŒç«¯é˜Ÿåˆ—</strong>)ï¼šä¸¤ç«¯éƒ½å¯ä»¥è¿›å‡ºçš„é˜Ÿåˆ—ã€‚å½“æˆ‘ä»¬çº¦æŸä»é˜Ÿåˆ—çš„ä¸€ç«¯è¿›å‡ºé˜Ÿæ—¶ï¼Œå°±å½¢æˆäº†å¦å¤–ä¸€ç§å­˜å–æ¨¡å¼ï¼Œå®ƒéµå¾ª<strong>å…ˆè¿›åå‡º</strong>åŸåˆ™ï¼Œè¿™å°±æ˜¯æ ˆç»“æ„ã€‚åŒç«¯é˜Ÿåˆ—ä¸»è¦æ˜¯ç”¨äºæ ˆæ“ä½œã€‚ä½¿ç”¨æ ˆç»“æ„è®©æ“ä½œæœ‰å¯è¿½æº¯æ€§(å¦‚<code>Windows</code>çª—å£åœ°å€æ å†…çš„è·¯å¾„å‰è¿›æ ˆã€åé€€æ ˆ)ã€‚</p>
<p>â€‹        é˜»å¡é˜Ÿåˆ—(<code>BlockingQueue</code>)æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©º:å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å–å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å–å…ƒç´ ã€‚é˜»å¡é˜Ÿåˆ—æä¾›äº†4ç§å¤„ç†æ–¹æ³•:</p>
<p><img src="/image/Concurrent/Concurrent16.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent16.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•\å¤„ç†æ–¹å¼</th>
<th>æŠ›å‡ºå¼‚å¸¸</th>
<th>è¿”å›ç‰¹æ®Šå€¼</th>
<th>ä¸€ç›´é˜»å¡</th>
<th>è¶…æ—¶é€€å‡º</th>
</tr>
</thead>
<tbody><tr>
<td>æ’å…¥æ–¹æ³•</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>ç§»é™¤æ–¹æ³•</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>æ£€æŸ¥æ–¹æ³•</td>
<td>element()</td>
<td>peek()</td>
<td>ä¸å¯ç”¨</td>
<td>ä¸å¯ç”¨</td>
</tr>
</tbody></table>
<p>â€‹        â—æŠ›å‡ºå¼‚å¸¸ï¼šæ˜¯æŒ‡å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡º<code>IllegalStateException(&quot;Queue full&quot;)</code>å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ æ—¶ä¼šæŠ›å‡º<code>NoSuchElementException</code>å¼‚å¸¸.<br>â€‹        â—è¿”å›ç‰¹æ®Šå€¼ï¼šæ’å…¥æ–¹æ³•ä¼šè¿”å›æ˜¯å¦æˆåŠŸï¼Œè‹¥æˆåŠŸåˆ™è¿”å›<code>true</code>ã€‚ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›<code>null</code>ã€‚<br>â€‹        â—ä¸€ç›´é˜»å¡ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œ<code>put</code>å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ<code>take</code>å…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚<br>â€‹        â—è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚</p>
<p><strong>æœ€æ–°JDKä¸­æä¾›äº†7ä¸ªé˜»å¡é˜Ÿåˆ—</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent17.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent17.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>JDK7 æä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯</p>
<ul>
<li>ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
<li>LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</li>
</ul>
<p><code>BlockingQueue</code>å¸¸ç”¨çš„æ–¹æ³•æœ‰å¦‚ä¸‹5ç§ï¼Œæ›´å¤šæ–¹æ³•è¯·æŸ¥è¯¢APIã€‚</p>
<p>(1) <code>add(anObject)</code>ï¼šæŠŠ<strong>anObjcct</strong>åŠ åˆ°<code>BlockingQueue</code> é‡Œï¼Œå³å¦‚æœ<code>BlockingQueue</code>å¯ä»¥å®¹çº³ï¼Œåˆ™è¿”å›true,å¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚<br>(2) <code>offer(anOject)</code>ï¼šè¡¨ç¤ºå¦‚æœå¯èƒ½çš„è¯ï¼Œå°†<strong>anObject</strong> åŠ åˆ°<code>BlockingQueue</code> é‡Œï¼Œå³å¦‚æœ<code>BlockingQueue</code>å¯ä»¥å®¹çº³ï¼Œåˆ™è¿”å›<code>true</code>,å¦åˆ™è¿”å›<code>false</code>ã€‚<br>(3) <code>put(aoObject)</code>ï¼šæŠŠ<strong>anObject</strong>åŠ åˆ°<code>BlockingQueue</code>é‡Œï¼Œå¦‚æœ<code>BlockQueue</code>æ²¡æœ‰ç©ºé—´ï¼Œåˆ™è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹è¢«é˜»æ–­ï¼Œç›´åˆ°<code>BlockingQueue</code>é‡Œé¢æœ‰ç©ºé—´æ—¶å†ç»§ç»­ã€‚<br>(4) <code>poll(time)</code>ï¼š å–èµ°<code>BlockingQueue</code> é‡Œæ’åœ¨é¦–ä½çš„å¯¹è±¡ï¼Œè‹¥ä¸èƒ½ç«‹å³å–å‡ºï¼Œåˆ™å¯ä»¥ç­‰<code>time</code>å‚æ•°è§„å®šçš„æ—¶é—´ï¼Œå–ä¸åˆ°æ—¶è¿”å›<code>null</code>ã€‚<br>(5) <code>take()</code>ï¼šå–èµ°<code>BlockingQueue</code>é‡Œæ’åœ¨é¦–ä½çš„å¯¹è±¡ï¼Œè‹¥<code>BlockingQueue</code>ä¸ºç©ºï¼Œé˜»æ–­è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°<code>Blocking</code>æœ‰æ–°çš„å¯¹è±¡è¢«åŠ å…¥ä¸ºæ­¢ã€‚<br>        å…¶ä¸­: <code>BlockingQueue</code> ä¸æ¥å—<strong>null</strong>å…ƒç´ ã€‚è¯•å›¾<code>add</code>ã€<code>put</code>æˆ–<code>offer</code>ä¸€ä¸ª<strong>null</strong>å…ƒç´ æ—¶ï¼ŒæŸäº›å®ç°ä¼šæŠ›å‡º<code>NullPointerException</code>å¼‚å¸¸ã€‚<strong>null</strong>è¢«ç”¨ä½œæŒ‡ç¤º<code>poll</code>æ“ä½œå¤±è´¥çš„è­¦æˆ’å€¼ã€‚</p>
<h3 id="æ•°ç»„é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue"><a href="#æ•°ç»„é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue" class="headerlink" title="æ•°ç»„é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue"></a>æ•°ç»„é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue</h3><p>â€‹        <code>ArrayBlockingQueue</code>æ˜¯ä¸€ä¸€ä¸ªç”±æ•°ç»„æ”¯æŒçš„<strong>æœ‰ç•Œ</strong>çš„é˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰<strong>FIFO</strong> (<strong>å…ˆè¿›å…ˆå‡º</strong>)åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯åœ¨é˜Ÿåˆ—ä¸­å­˜åœ¨æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨æ˜¯åœ¨é˜Ÿåˆ—ä¸­å­˜åœ¨æ—¶é—´æœ€çŸ­çš„å…ƒç´ ã€‚æ–°å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œé˜Ÿåˆ—è·å–æ“ä½œåˆ™æ˜¯ä»é˜Ÿåˆ—å¤´éƒ¨å¼€å§‹è·å¾—å…ƒç´ ã€‚<br>â€‹        è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œæœ‰ç•Œç¼“å­˜åŒºâ€ï¼Œå›ºå®šå¤§å°çš„æ•°ç»„åœ¨å…¶ä¸­ä¿æŒç”Ÿäº§è€…æ’å…¥çš„å…ƒç´ å’Œä½¿ç”¨è€…æå–çš„å…ƒç´ ã€‚ä¸€æ—¦åˆ›å»ºäº†è¿™æ ·çš„ç¼“å­˜åŒºï¼Œå°±ä¸èƒ½å†å¢åŠ å…¶å®¹é‡ã€‚è¯•å›¾å‘å·²æ»¡é˜Ÿåˆ—ä¸­æ”¾å…¥å…ƒç´ ä¼šå¯¼è‡´æ“ä½œå—é˜»å¡;è¯•å›¾ä»ç©ºé˜Ÿåˆ—ä¸­æå–å…ƒç´ å°†å¯¼è‡´ç±»ä¼¼é˜»å¡ã€‚<br>â€‹        æ­¤ç±»æ”¯æŒå¯¹ç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹å’Œä½¿ç”¨è€…çº¿ç¨‹è¿›è¡Œæ’åºçš„å¯é€‰å…¬å¹³ç­–ç•¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¿è¯æ˜¯è¿™ç§æ’åºã€‚ç„¶è€Œï¼Œé€šè¿‡å°†å…¬å¹³æ€§(<code>fairness</code>)è®¾ç½®ä¸º<code>true</code> è€Œæ„é€ çš„é˜Ÿåˆ—å…è®¸æŒ‰ç…§<strong>FIFO</strong>é¡ºåºè®¿é—®çº¿ç¨‹ã€‚é€šå¸¸æƒ…å†µä¸‹ä¸ºäº†ä¿è¯å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†ä¹Ÿå‡å°‘äº†å¯å˜æ€§å’Œé¿å…äº†â€œ<strong>ä¸å¹³è¡¡æ€§</strong>â€ã€‚<br>â€‹        æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>ArrayBlockingQueue</code>çš„éƒ¨åˆ†æºç ï¼Œç†è§£ä¸€ä¸‹ <code>ArrayBlockingQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">/** The queued items æ•°ç»„çš„å‚¨å­˜ç»“æ„ */</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items<span class="token punctuation">;</span>

	<span class="token comment">/** Main lock guarding all access é”é‡‡ç”¨çš„æœºåˆ¶ */</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>

    <span class="token comment">/** Condition for waiting takes */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>

    <span class="token comment">/** Condition for waiting puts */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull<span class="token punctuation">;</span>
    
    <span class="token comment">//è®°å½•ä¸‹ä¸€ä¸ªtakeã€removeã€peekçš„ç´¢å¼•</span>
    <span class="token keyword">int</span> takeIndex<span class="token punctuation">;</span>

    <span class="token comment">//è®°å½•ä¸‹ä¸€ä¸ªputã€offerã€addçš„ç´¢å¼•</span>
    <span class="token keyword">int</span> putIndex<span class="token punctuation">;</span>

    <span class="token comment">//é˜Ÿåˆ—ä¸­å…ƒç´ çš„ä¸ªæ•°</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    
    <span class="token comment">//åªæŒ‡å®šå®¹é‡</span>
	<span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//æŒ‡å®šå®¹é‡å’ŒReentrantLockæ˜¯å¦å…¬å¹³</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//é€šè¿‡å°†å…¬å¹³æ€§(fairness) è®¾ç½®ä¸ºtrueè€Œæ„é€ çš„é˜Ÿåˆ—å…è®¸æŒ‰ç…§FIFOé¡ºåºè®¿é—®çº¿ç¨‹</span>
        lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span>fair<span class="token punctuation">)</span><span class="token punctuation">;</span>
        notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notFull <span class="token operator">=</span>  lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//å°†é›†åˆä¸­çš„å…ƒç´ åˆå§‹åŒ–é˜Ÿåˆ—çš„å…ƒç´ </span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">,</span>
                              <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> fair<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lock only for visibility, not mutual exclusion</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">E</span> e <span class="token operator">:</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    items<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            count <span class="token operator">=</span> i<span class="token punctuation">;</span>
            putIndex <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//æ£€æŸ¥å…ƒç´ æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯ï¼ŒæŠ›å‡ºNullPointerException</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        <span class="token comment">//åŠ é”</span>
        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡ï¼Œç­‰å¾…é˜Ÿåˆ—æˆä¸ºä¸æ»¡çŠ¶æ€</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å°†å…ƒç´ å…¥é˜Ÿ</span>
            <span class="token function">enqueue</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
     <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        <span class="token comment">//é¦–å…ˆåŠ é”</span>
        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œè°ƒç”¨dequeue()å‡ºé˜Ÿ</span>
            <span class="token keyword">return</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//é‡Šæ”¾é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// assert lock.getHoldCount() == 1;</span>
        <span class="token comment">// assert items[putIndex] == null;</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">;</span>
        items<span class="token punctuation">[</span>putIndex<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span><span class="token comment">//é€šè¿‡æ•°ç»„è¿›è¡Œå‚¨å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>putIndex <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            putIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
        notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// assert lock.getHoldCount() == 1;</span>
        <span class="token comment">// assert items[takeIndex] != null;</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token comment">//å–èµ°æ•°æ®</span>
        <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> items<span class="token punctuation">[</span>takeIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//ç½®ä¸ºnullï¼Œä»¥åŠ©gc</span>
        items<span class="token punctuation">[</span>takeIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//å¾ªç¯å–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>takeIndex <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            takeIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        count<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>itrs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            itrs<span class="token punctuation">.</span><span class="token function">elementDequeued</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//é€šçŸ¥å› é˜Ÿåˆ—æ»¡è€Œé˜»å¡çš„çº¿ç¨‹</span>
        notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®ä¾‹å¦‚ä¸‹ï¼š</p>
<h4 id="No1-ArrayBlockingQueueDemo-java"><a href="#No1-ArrayBlockingQueueDemo-java" class="headerlink" title="No1_ArrayBlockingQueueDemo.java"></a>No1_ArrayBlockingQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * ç°æœ‰çš„ç¨‹åºä»£ç æ¨¡æ‹Ÿäº§ç”Ÿäº†16ä¸ªæ—¥å¿—å¯¹è±¡ï¼Œå¹¶ä¸”éœ€è¦è¿è¡Œ16ç§’æ‰èƒ½æ‰“å°å®Œè¿™äº›æ—¥å¿—ï¼Œ
 * è¯·åœ¨ç¨‹åºä¸­å¢åŠ 4ä¸ªçº¿ç¨‹å»è°ƒç”¨ parseLog() æ–¹æ³•æ¥åˆ†å¤´æ‰“å°è¿™16ä¸ªæ—¥å¿—å¯¹è±¡ï¼Œ
 * ç¨‹åºåªéœ€è¦è¿è¡Œ4ç§’å³å¯æ‰“å°å®Œè¿™äº›æ—¥å¿—å¯¹è±¡ã€‚
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_ArrayBlockingQueueDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// æ–°å»ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</span>
        <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å››ä¸ªçº¿ç¨‹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> bq<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">parseLog</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" -->  "</span><span class="token punctuation">;</span>
            bq<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æ•°æ®å­˜åˆ°é˜Ÿåˆ—é‡Œï¼</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// parseLogæ–¹æ³•å†…éƒ¨çš„ä»£ç ä¸èƒ½æ”¹åŠ¨</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">parseLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>log <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="é“¾è¡¨é˜»å¡é˜Ÿåˆ—-LinkedBlockingQueue"><a href="#é“¾è¡¨é˜»å¡é˜Ÿåˆ—-LinkedBlockingQueue" class="headerlink" title="é“¾è¡¨é˜»å¡é˜Ÿåˆ— LinkedBlockingQueue"></a>é“¾è¡¨é˜»å¡é˜Ÿåˆ— LinkedBlockingQueue</h3><p>â€‹        <code>LinkedBlockingQueue</code>æ˜¯åŸºäº<strong>é“¾è¡¨</strong>çš„é˜»å¡é˜Ÿåˆ—ï¼ŒåŒ<code>ArrayListBlockingQueue</code>ç±»ä¼¼ï¼Œå…¶å†…éƒ¨ä¹Ÿç»´æŒç€ä¸€ä¸ªæ•°æ®ç¼“å†²é˜Ÿåˆ—(è¯¥é˜Ÿåˆ—ç”±ä¸€ä¸ªé“¾è¡¨æ„æˆ)ï¼Œå½“ç”Ÿäº§è€…å¾€é˜Ÿåˆ—ä¸­æ”¾å…¥ä¸€ä¸€ä¸ªæ•°æ®æ—¶ï¼Œé˜Ÿåˆ—ä¼šä»ç”Ÿäº§è€…æ‰‹ä¸­è·å–æ•°æ®ï¼Œå¹¶ç¼“å­˜åœ¨é˜Ÿåˆ—å†…éƒ¨ï¼Œè€Œç”Ÿäº§è€…ç«‹å³è¿”å›ã€‚åªæœ‰å½“é˜Ÿåˆ—ç¼“å†²åŒºè¾¾åˆ°æœ€å¤§å€¼ç¼“å­˜å®¹é‡æ—¶(<code>LinkedBlockingQueue </code>å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šè¯¥å€¼)ï¼Œæ‰ä¼šé˜»å¡ç”Ÿäº§è€…é˜Ÿåˆ—ï¼Œç›´åˆ°æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ‰ä¸€ä»½æ•°æ®ï¼Œ ç”Ÿäº§è€…çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚åä¹‹ï¼Œå¯¹äºæ¶ˆè´¹è€…è¿™ç«¯çš„å¤„ç†ä¹ŸåŸºäºåŒæ ·çš„åŸç†ã€‚è€ŒLinkedBlockingQueueä¹‹æ‰€ä»¥èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¹¶å‘æ•°æ®ï¼Œè¿˜å› ä¸ºå…¶å¯¹äºç”Ÿäº§è€…ç«¯å’Œæ¶ˆè´¹è€…ç«¯åˆ†åˆ«é‡‡ç”¨äº†ç‹¬ç«‹çš„é”æ¥æ§åˆ¶æ•°æ®åŒæ­¥ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥å¹¶è¡Œåœ°æ“ä½œé˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œä»¥æ­¤æ¥æé«˜æ•´ä¸ªé˜Ÿåˆ—çš„å¹¶å‘æ€§èƒ½ã€‚<br>â€‹        ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ„é€ ä¸€ä¸€ä¸ª<code>LinkedBlockingQueue</code>å¯¹è±¡ï¼Œè€Œ**æ²¡æœ‰æŒ‡å®šå…¶å®¹é‡å¤§å°ï¼ŒLinkedBlockingQueueä¼šé»˜è®¤-ä¸€ä¸ªç±»ä¼¼æ— é™å¤§å°çš„å®¹é‡(Integer.MAX_ VALUE)**ï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœç”Ÿäº§è€…çš„é€Ÿåº¦ä¸€æ—¦å¤§äºæ¶ˆè´¹è€…çš„é€Ÿåº¦ï¼Œä¹Ÿè®¸è¿˜æ²¡æœ‰ç­‰åˆ°é˜Ÿåˆ—æ»¡é˜»å¡äº§ç”Ÿï¼Œç³»ç»Ÿå†…å­˜å°±æœ‰å¯èƒ½å·²è¢«æ¶ˆè€—æ®†å°½äº†ã€‚<br>â€‹        æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>LinkedBlockingDeque</code>çš„éƒ¨åˆ†æºç ï¼Œç†è§£ä¸€ä¸‹ <code>ArrayBlockingQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">//å®¹é‡ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œè¯¥å€¼ä¸ºInteger.MAX_VALUE;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>

    <span class="token comment">//å½“å‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ </span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼Œå§‹ç»ˆæ»¡è¶³head.item==null</span>
    <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> head<span class="token punctuation">;</span>

    <span class="token comment">//é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œå§‹ç»ˆæ»¡è¶³last.next==null</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> last<span class="token punctuation">;</span>

    <span class="token comment">//ç”¨äºå‡ºé˜Ÿçš„é”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¿å­˜æ‰§è¡Œå‡ºé˜Ÿçš„çº¿ç¨‹</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> takeLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//ç”¨äºå…¥é˜Ÿçš„é”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¿å­˜æ‰§è¡Œå…¥é˜Ÿçš„çº¿ç¨‹</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> putLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å½“è°ƒç”¨æ— å‚çš„æ„é€ æ–¹æ³•æ—¶ï¼Œå®¹é‡æ˜¯intçš„æœ€å¤§å€¼</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
        last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//lastå’Œheadåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶éƒ½å­˜åœ¨ï¼Œæ‰€ä»¥é˜Ÿåˆ—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Never contended, but necessary for visibility</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">E</span> e <span class="token operator">:</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//ä¸æ”¯æŒnullå…ƒç´ </span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> capacity<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Queue full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>n<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            count<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//ä¸å…è®¸å…ƒç´ ä¸ºnull</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//ä»¥å½“å‰å…ƒç´ æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
        <span class="token comment">//è·å¾—å…¥é˜Ÿçš„é”</span>
        putLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">//å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œé‚£ä¹ˆå°†è¯¥çº¿ç¨‹åŠ å…¥åˆ°Conditionçš„ç­‰å¾…é˜Ÿåˆ—ä¸­</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//å°†èŠ‚ç‚¹å…¥é˜Ÿ</span>
            <span class="token function">enqueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¾—åˆ°æ’å…¥ä¹‹å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœè¿˜å¯ä»¥æ’å…¥å…ƒç´ ï¼Œé‚£ä¹ˆé‡Šæ”¾ç­‰å¾…çš„å…¥é˜Ÿçº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span>
                notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//è§£é”</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//é€šçŸ¥å‡ºé˜Ÿçº¿ç¨‹é˜Ÿåˆ—éç©º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span>
        <span class="token comment">//è·å–takeLock</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//é‡Šæ”¾notEmptyæ¡ä»¶é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">E</span> x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span>
        <span class="token comment">//è·å–takeLocké”</span>
        takeLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆåŠ å…¥åˆ°notEmptyæ¡ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ä¸­</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//å¾—åˆ°é˜Ÿå¤´å…ƒç´ </span>
            x <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¾—åˆ°å–èµ°ä¸€ä¸ªå…ƒç´ ä¹‹å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°</span>
            c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®å¯å–ï¼Œé‡Šæ”¾notEmptyæ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//å¦‚æœé˜Ÿåˆ—ä¸­çš„å…ƒç´ ä»æ»¡åˆ°éæ»¡ï¼Œé€šçŸ¥putçº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> capacity<span class="token punctuation">)</span>
            <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
     <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span>
        putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//å› ä¸ºé˜Ÿåˆ—ä¸åŒ…å«nullå…ƒç´ ï¼Œè¿”å›false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–ä¸¤æŠŠé”</span>
        <span class="token function">fullyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//ä»å¤´çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹éå†</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> trail <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> trail<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                 p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                 trail <span class="token operator">=</span> p<span class="token punctuation">,</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                 <span class="token comment">//å¦‚æœåŒ¹é…ï¼Œé‚£ä¹ˆå°†èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œtrailè¡¨ç¤ºå‰é©±èŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">unlink</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> trail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//é‡Šæ”¾ä¸¤æŠŠé”</span>
            <span class="token function">fullyUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>è¿™é‡Œä½¿ç”¨å®ä¾‹ä¸ä¸Šä¸€èŠ‚ä¸­<code>ArrayBlockingQueue</code>çš„ä¾‹å­ä¸€æ ·ã€‚ä¸åŒçš„æ˜¯,å°†<code>ArrayBlockingQueue</code>çš„ä¾‹å­æ¢æˆ<code>LinkedBlockingQueue</code>å³å¯ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">></span></span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ¢æˆ:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="No2-LinkedBlockingQueueDemo-java"><a href="#No2-LinkedBlockingQueueDemo-java" class="headerlink" title="No2_LinkedBlockingQueueDemo.java"></a>No2_LinkedBlockingQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_LinkedBlockingQueueDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// æ–°å»ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</span>
        <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å››ä¸ªçº¿ç¨‹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> bq<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">parseLog</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" -->  "</span><span class="token punctuation">;</span>
            bq<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æ•°æ®å­˜åˆ°é˜Ÿåˆ—é‡Œï¼</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// parseLogæ–¹æ³•å†…éƒ¨çš„ä»£ç ä¸èƒ½æ”¹åŠ¨</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">parseLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>log <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="ä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—-PriorityBlockingQueue"><a href="#ä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—-PriorityBlockingQueue" class="headerlink" title="ä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ— PriorityBlockingQueue"></a>ä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ— PriorityBlockingQueue</h3><p>â€‹        <code>PriorityBlockingQueue</code>æ˜¯ä¸€ä¸ª<strong>æ”¯æŒä¼˜å…ˆçº§æ’åº</strong>çš„<strong>æ— ç•Œé˜»å¡é˜Ÿåˆ—</strong>ï¼ˆä¼˜å…ˆçº§çš„åˆ¤æ–­é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥çš„<code>Compator</code>å¯¹è±¡æ¥å†³å®š),ä½†éœ€è¦æ³¨æ„çš„æ˜¯<code>PriorityBlockingQueue</code>å¹¶ä¸ä¼šé˜»å¡æ•°æ®ç”Ÿäº§è€…ï¼Œè€Œåªä¼šåœ¨æ²¡æœ‰å¯æ¶ˆè´¹çš„æ•°æ®æ—¶ï¼Œé˜»å¡æ•°æ®çš„æ¶ˆè´¹è€…ã€‚å› æ­¤ä½¿ç”¨çš„æ—¶å€™è¦ç‰¹åˆ«æ³¨æ„ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ•°æ®çš„é€Ÿåº¦ç»å¯¹ä¸èƒ½å¿«äºæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®çš„é€Ÿåº¦ï¼Œå¦åˆ™æ—¶é—´ä¸€é•¿ï¼Œä¼šæœ€ç»ˆè€—å°½æ‰€æœ‰çš„å¯ç”¨å †å†…å­˜ç©ºé—´ã€‚åœ¨å®ç°<code>PriorityBlockingQueue</code>æ—¶ï¼Œå†…éƒ¨æ§åˆ¶çº¿ç¨‹åŒæ­¥çš„é”é‡‡ç”¨çš„æ˜¯å…¬å¹³é”ã€‚<br>â€‹        å…ˆçœ‹ä¸€ä¸‹<code>PriorityBlockingQueue</code>çš„éƒ¨åˆ†æºç ,ç†è§£ä¸€ä¸‹ <code>PriorityBlockingQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
     *  é»˜è®¤çš„æ•°ç»„å®¹é‡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  æœ€å¤§çš„æ•°ç»„å®¹é‡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_ARRAY_SIZE <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * ä¼˜å…ˆé˜Ÿåˆ—æ•°ç»„
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> queue<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ€»æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  å…ƒç´ æ¯”è¾ƒå™¨ï¼Œå¦‚æœæŒ‰ç…§è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œåˆ™ä¸º null
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> comparator<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  æ§åˆ¶è®¿é—®çš„å¯é‡å…¥äº’æ–¥é”
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œç›®æ ‡çº¿ç¨‹å°†åœ¨éç©ºæ¡ä»¶é˜»å¡ç­‰å¾…
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     *  åˆå§‹0ä¸ºå¯è·å–çŠ¶æ€ï¼Œç”¨äºæ§åˆ¶æ‰©å®¹æ“ä½œ
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> allocationSpinLock<span class="token punctuation">;</span>
    
        <span class="token comment">/**
     *  åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º 11ï¼ŒæŒ‰ç…§è‡ªç„¶é¡ºåºæ’åºçš„ PriorityBlockingQueue å®ä¾‹
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">/**
     *  åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º initialCapacityï¼ŒæŒ‰ç…§è‡ªç„¶é¡ºåºæ’åºçš„ PriorityBlockingQueue å®ä¾‹
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">/**
     *  åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º initialCapacityï¼ŒæŒ‰ç…§è‡ªç„¶é¡ºåºæ’åºçš„ comparator å®ä¾‹
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span>
            <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> comparator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>comparator <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>initialCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/**
     *  å°†ç›®æ ‡å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œç”±äºæ˜¯æ— ç•Œçš„ï¼Œä¸ä¼šè¢«é˜»å¡
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// never need to block</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * nï¼šlength
         * capï¼šcapacity
         */</span>
        <span class="token keyword">int</span> n<span class="token punctuation">,</span> cap<span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
        <span class="token comment">// å…ƒç´ ä¸ªæ•°è¶…å‡ºé˜Ÿåˆ—é•¿åº¦ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token punctuation">(</span>array <span class="token operator">=</span> queue<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">tryGrow</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> cmp <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// è‡ªç„¶é¡ºåºçš„æ’å…¥</span>
                <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span><span class="token function">siftUpComparable</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// ä½¿ç”¨æŒ‡å®šæ¯”è¾ƒå™¨çš„æ’å…¥</span>
                <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span><span class="token function">siftUpUsingComparator</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> array<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            size <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// å”¤é†’åœ¨éç©ºæ¡ä»¶ä¸Šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryGrow</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> oldCap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// must release and then re-acquire main lock</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newArray <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// å½“å‰æ²¡æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ &amp;&amp; åŸå­æ›´æ–°æ‰©å®¹æ ‡è¯†ä¸º 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allocationSpinLock <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span>ALLOCATIONSPINLOCK<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/**
                 * 1ï¼‰æ—§å®¹é‡å°äº 64ï¼Œæ‰§è¡Œã€åŒå€+2ã€‘æ‰©å®¹
                 * 2ï¼‰æ—§å®¹é‡å¤§äºç­‰äº 64ï¼Œæ‰§è¡Œ1.5å€å‘ä¸‹å–æ•´æ‰©å®¹
                 */</span>
                <span class="token keyword">int</span> newCap <span class="token operator">=</span> oldCap <span class="token operator">+</span> <span class="token punctuation">(</span>oldCap <span class="token operator">&lt;</span> <span class="token number">64</span> <span class="token operator">?</span>
                        oldCap <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token comment">// grow faster if small</span>
                            oldCap <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ–°å®¹é‡è¶…å‡ºæœ€å¤§å®¹é‡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span>MAX_ARRAY_SIZE <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// possible overflow</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> minCap <span class="token operator">=</span> oldCap <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token comment">// å¦‚æœå·²ç»æº¢å‡ºï¼Œåˆ™æŠ›å‡º OutOfMemoryError å¼‚å¸¸</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>minCap <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> minCap <span class="token operator">></span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span>MAX_ARRAY_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OutOfMemoryError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">// å†™å…¥æœ€å¤§å®¹é‡</span>
                    newCap <span class="token operator">=</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span>MAX_ARRAY_SIZE<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// åˆ›å»ºæ–°çš„å¯¹è±¡æ•°ç»„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newCap <span class="token operator">></span> oldCap <span class="token operator">&amp;&amp;</span> queue <span class="token operator">==</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    newArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// é‡ç½®æ‰©å®¹æ ‡è®°</span>
                allocationSpinLock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// è¯´æ˜å·²ç»æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹ï¼Œåˆ™ç­‰å¾…å…¶æ‰©å®¹å®Œæˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newArray <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newArray <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> queue <span class="token operator">==</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// æ‰©å®¹æˆåŠŸçš„çº¿ç¨‹ä¼šå°†å…ƒç´ ä»æ—§æ•°ç»„æ‹·è´åˆ°æ–°æ•°ç»„ä¸­</span>
            queue <span class="token operator">=</span> newArray<span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * è¿™é‡Œä¸»è¦å°±æ˜¯å‘å †ä¸­æ’å…¥å…ƒç´ ï¼Œå¹¶ä¸”æ’å…¥çš„åŒæ—¶è¦è°ƒæ•´å †ï¼Œä¿æŒæœ€å°å †çŠ¶æ€
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">siftUpComparable</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> x<span class="token punctuation">;</span>
        <span class="token comment">// æ’å…¥å…ƒç´ çš„ç›®æ ‡ç´¢å¼•</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// è®¡ç®—çˆ¶èŠ‚ç‚¹ç´¢å¼•</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> parent <span class="token operator">=</span> k <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// è¯»å–çˆ¶èŠ‚ç‚¹å€¼</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> e <span class="token operator">=</span> array<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// æ–°å¢å…ƒç´ å·²ç» >= å½“å‰èŠ‚ç‚¹ï¼Œåˆ™æ— éœ€ä¸Šç§»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// çˆ¶èŠ‚ç‚¹å…ƒç´ ä¸‹ç§»</span>
            array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token comment">// é€’å½’æ¯”è¾ƒç¥–çˆ¶èŠ‚ç‚¹</span>
            k <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// æ’å…¥ç›®æ ‡å…ƒç´ </span>
        array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">/**
     *  å®ç°é€»è¾‘å’Œ siftUpComparable ä¸€è‡´
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">siftUpUsingComparator</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span>
            <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> cmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> parent <span class="token operator">=</span> k <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> e <span class="token operator">=</span> array<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            k <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
        <span class="token comment">/**
     *  å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ç­‰å¾…æœ‰å¯ç”¨å…ƒç´ åé‡è¯•ï¼Œå¦åˆ™ç§»é™¤å¹¶è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ 
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">E</span> result<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// å°è¯•ç§»é™¤å¹¶è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ </span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// å½“å‰çº¿ç¨‹åœ¨éç©ºæ¡ä»¶ä¸Šé˜»å¡ç­‰å¾…ï¼Œè¢«å”¤é†’åé‡è¯•</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// è®¡ç®—å°¾éƒ¨å…ƒç´ ç´¢å¼•</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> n <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> queue<span class="token punctuation">;</span>
            <span class="token comment">// è¯»å–ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ </span>
            <span class="token keyword">final</span> <span class="token class-name">E</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// è¯»å–å°¾éƒ¨å…ƒç´ </span>
            <span class="token keyword">final</span> <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¸…ç©ºå°¾éƒ¨å…ƒç´ </span>
            array<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> cmp <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span><span class="token function">siftDownComparable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> array<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">.</span><span class="token function">siftDownUsingComparator</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            size <span class="token operator">=</span> n<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">/**
     * Inserts item x at position k, maintaining heap invariant by
     * demoting x down the tree repeatedly until it is less than or
     * equal to its children or is a leaf.
     *
     * @param k éœ€è¦å¡«å……çš„ç›®æ ‡ç´¢å¼•
     * @param x éœ€è¦æ’å…¥çš„ç›®æ ‡å…ƒç´ 
     * @param array æŒæœ‰å¯¹è±¡çš„æ•°ç»„
     * @param n å †å¤§å°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">siftDownComparable</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span>
            <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
            <span class="token comment">// è®¡ç®—äºŒåˆ†ç´¢å¼•</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> half <span class="token operator">=</span> n <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>           <span class="token comment">// loop while a non-leaf</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> half<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// è®¡ç®—å·¦å­èŠ‚ç‚¹ç´¢å¼•</span>
                <span class="token keyword">int</span> child <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// assume left child is least</span>
                <span class="token comment">// è¯»å–èŠ‚ç‚¹å€¼</span>
                <span class="token class-name">Object</span> c <span class="token operator">=</span> array<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// è®¡ç®—å³å­èŠ‚ç‚¹ç´¢å¼•</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> right <span class="token operator">=</span> child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">/**
                 *  å³å­èŠ‚ç‚¹ç´¢å¼•å°äºç›®æ ‡å †å¤§å° &amp;&amp;
                 *  å·¦å­èŠ‚ç‚¹å€¼ > å³å­èŠ‚ç‚¹å€¼
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// è¯»å–å³å­èŠ‚ç‚¹å€¼ï¼Œæ›´æ–°æŸ¥æ‰¾èŠ‚ç‚¹ç´¢å¼•</span>
                    c <span class="token operator">=</span> array<span class="token punctuation">[</span>child <span class="token operator">=</span> right<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// ç›®æ ‡é”®å·²ç»å°äºæŸ¥æ‰¾èŠ‚ç‚¹ï¼Œåˆ™å¯ä»¥ç›´æ¥æ’å…¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// å¦åˆ™ï¼Œæå‡å­èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹</span>
                array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
                <span class="token comment">// è¿­ä»£å¤„ç†å­èŠ‚ç‚¹</span>
                k <span class="token operator">=</span> child<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// æ’å…¥ç›®æ ‡å€¼</span>
            array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">siftDownUsingComparator</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span>
            <span class="token keyword">int</span> n<span class="token punctuation">,</span>
            <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> cmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> half <span class="token operator">=</span> n <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> half<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">int</span> child <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token class-name">Object</span> c <span class="token operator">=</span> array<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> right <span class="token operator">=</span> child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> cmp<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> c<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        c <span class="token operator">=</span> array<span class="token punctuation">[</span>child <span class="token operator">=</span> right<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
                    k <span class="token operator">=</span> child<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                array<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="No3-PriorityBlockingQueueDemo-java"><a href="#No3-PriorityBlockingQueueDemo-java" class="headerlink" title="No3_PriorityBlockingQueueDemo.java"></a>No3_PriorityBlockingQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_PriorityBlockingQueueDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> pbq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pbq<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"person3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å®¹å™¨ä¸ºï¼š"</span> <span class="token operator">+</span> pbq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pbq<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"person2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å®¹å™¨ä¸ºï¼š"</span> <span class="token operator">+</span> pbq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pbq<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"person1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å®¹å™¨ä¸ºï¼š"</span> <span class="token operator">+</span> pbq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pbq<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"person4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å®¹å™¨ä¸ºï¼š"</span> <span class="token operator">+</span> pbq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"åˆ†å‰²çº¿----------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"è·å–å…ƒç´  "</span> <span class="token operator">+</span> pbq<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å®¹å™¨ä¸ºï¼š"</span> <span class="token operator">+</span> pbq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"åˆ†å‰²çº¿----------------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºä¸ºï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person3<span class="token punctuation">]</span>
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person2<span class="token punctuation">,</span> person3<span class="token punctuation">]</span>
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person1<span class="token punctuation">,</span> person3<span class="token punctuation">,</span> person2<span class="token punctuation">]</span>
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person1<span class="token punctuation">,</span> person3<span class="token punctuation">,</span> person2<span class="token punctuation">,</span> person4<span class="token punctuation">]</span>
åˆ†å‰²çº¿<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
è·å–å…ƒç´  person1
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person2<span class="token punctuation">,</span> person3<span class="token punctuation">,</span> person4<span class="token punctuation">]</span>
åˆ†å‰²çº¿<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
è·å–å…ƒç´  person2
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person3<span class="token punctuation">,</span> person4<span class="token punctuation">]</span>
åˆ†å‰²çº¿<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
è·å–å…ƒç´  person3
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span>person4<span class="token punctuation">]</span>
åˆ†å‰²çº¿<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
è·å–å…ƒç´  person4
å®¹å™¨ä¸ºï¼š<span class="token punctuation">[</span><span class="token punctuation">]</span>
åˆ†å‰²çº¿<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="å»¶æ—¶é˜Ÿåˆ—DelayQueue"><a href="#å»¶æ—¶é˜Ÿåˆ—DelayQueue" class="headerlink" title="å»¶æ—¶é˜Ÿåˆ—DelayQueue"></a>å»¶æ—¶é˜Ÿåˆ—DelayQueue</h3><p>â€‹        <code>DelayQueue</code>æ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç° <code>Delayed</code>æ¥å£å’Œ <code>Comparable</code>æ¥å£,ä¹Ÿå°±æ˜¯è¯´<code>DelayQueue</code>é‡Œé¢çš„å…ƒç´ å¿…é¡»æœ‰<code>public int compareTo(To)</code>å’Œ <code>long getDelay(TimeUnit unit)</code>æ–¹æ³•å­˜åœ¨åœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥å°†<code>DelayQueue</code>è¿ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ä¸­:</p>
<ul>
<li>ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ã€‚å¯ä»¥ç”¨ <code>DelayQueue</code>ä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸ,ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢<br><code>DelayQueue</code>ï¼Œä¸€æ—¦èƒ½ä» <code>DelayQueue</code>ä¸­è·å–å…ƒç´ æ—¶,è¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚</li>
<li>å®šæ—¶ä»»åŠ¡è°ƒåº¦ä½¿ç”¨<code>DelayQueue</code>ä¿å­˜å½“å¤©å°†ä¼šæ‰§è¡Œçš„ä»»åŠ¡å’Œæ‰§è¡Œæ—¶é—´ä¸€æ—¦ä» <code>DelayQueue</code>ä¸­è·å–åˆ°ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œ,æ¯”å¦‚<code>TimerQueue</code> å°±æ˜¯ä½¿ç”¨ <code>DelayQueue</code>å®ç°çš„ã€‚</li>
</ul>
<p>â€‹        æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>DelayQueue</code>çš„æºç ï¼Œæ¥ç†è§£ä¸€ä¸‹ <code>DelayQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// ä¿è¯çº¿ç¨‹å®‰å…¨çš„é”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¼˜å…ˆé˜Ÿåˆ—</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ‡è®°å–å…ƒç´ æ—¶æ˜¯å¦æœ‰çº¿ç¨‹åœ¨æ’é˜Ÿ</span>
    <span class="token keyword">private</span> <span class="token class-name">Thread</span> leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// æ˜¯å¦å¯å–çš„æ¡ä»¶å˜é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> available <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥æ­¤å»¶è¿Ÿé˜Ÿåˆ—</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
   		<span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    	lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          		<span class="token comment">// å †é¡¶å…ƒç´ </span>
            	<span class="token class-name">E</span> first <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          		<span class="token comment">// ä¸ºç©ºï¼Œç­‰å¾…è¢«å”¤é†’</span>
            	<span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                	available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          		<span class="token comment">// å †é¡¶ä¸ä¸ºç©º</span>
            	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              		<span class="token comment">// è·å–å…ƒç´ çš„è¶…æ—¶æ—¶é—´</span>
                	<span class="token keyword">long</span> delay <span class="token operator">=</span> first<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
              		<span class="token comment">// å·²è¿‡æœŸå°±å–èµ°</span>
                	<span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æ²¡è¿‡æœŸå¾€ä¸‹èµ°</span>
                    <span class="token comment">// è¿™é‡Œè®¾ç½®ä¸º null æ˜¯æ”¾åœ¨è¿˜æœ‰åˆ«çš„çº¿ç¨‹æŒæœ‰æ²¡æœ‰é‡Šæ”¾å¯¼è‡´å†…å­˜æ³„æ¼</span>
                    first <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// don't retain ref while waiting</span>
                    <span class="token comment">// æ ¡éªŒæ˜¯å¦æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œæœ‰å°±ç­‰å¾…leaderçº¿ç¨‹å–å®Œæˆ–æœ‰æ–°åŠ å…¥çš„å…ƒç´ å”¤é†’å®ƒ</span>
                	<span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    	available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              		<span class="token comment">// æ²¡æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±æŠŠè‡ªå·±è®¾ç½®ä¸ºç­‰å¾…çº¿ç¨‹ï¼Œç„¶åç­‰å¾…è¶…æ—¶æ—¶é—´å”¤é†’é‡è¯•</span>
                	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    	<span class="token class-name">Thread</span> thisThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    	leader <span class="token operator">=</span> thisThread<span class="token punctuation">;</span>
                    	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        	available<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                      		<span class="token comment">// å”¤é†’åå°±æŠŠ leader ç½®ç©º</span>
                        	<span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> thisThread<span class="token punctuation">)</span>
                            leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    	<span class="token punctuation">&#125;</span>
                	<span class="token punctuation">&#125;</span>
            	<span class="token punctuation">&#125;</span>
        	<span class="token punctuation">&#125;</span>
    	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
      		<span class="token comment">// æ²¡æœ‰ç­‰å¾…çº¿ç¨‹å¹¶ä¸”é˜Ÿåˆ—è¿˜æœ‰æ•°æ®ï¼Œå°±å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹æ¥å–</span>
        	<span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            	available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        		lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">E</span> first <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æ£€æŸ¥å †é¡¶å…ƒç´ ï¼Œå¦‚æœä¸ºç©ºæˆ–è€…è¿˜æ²¡åˆ°æœŸå‘¢ï¼Œè¿”å› null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> first<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token comment">//å¦åˆ™è¿”å›å–å‡ºå †é¡¶å…ƒç´ </span>
                <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>â€‹        æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ DelayQueueçš„ä½¿ç”¨å®ä¾‹ï¼š<br>â€‹        (1ï¼‰å®ç°ä¸€ä¸ª Studentå¯¹è±¡ä½œä¸ºDelayQueueçš„å…ƒç´ å¿…é¡»å®ç° Delayedæ¥å£çš„ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Delayed</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¿…é¡»å®ç°Delayedæ¥å£</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> submitTime<span class="token punctuation">;</span><span class="token comment">// äº¤å·æ—¶é—´</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> workTime<span class="token punctuation">;</span><span class="token comment">// è€ƒè¯•æ—¶é—´</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" äº¤å·,ç”¨æ—¶"</span> <span class="token operator">+</span> workTime<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> submitTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>workTime <span class="token operator">=</span> submitTime<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>submitTime <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>submitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" äº¤å·,ç”¨æ—¶"</span> <span class="token operator">+</span> workTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//å¿…é¡»å®ç°getDelayæ–¹æ³•</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//		è¿”å›ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´</span>
            <span class="token keyword">return</span> unit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>submitTime <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//å¿…é¡»å®ç°compareToæ–¹æ³•</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Delayed</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//æ¯”è¾ƒçš„æ–¹æ³•</span>
            <span class="token class-name">Student</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">return</span> submitTime <span class="token operator">></span> that<span class="token punctuation">.</span>submitTime <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>submitTime <span class="token operator">&lt;</span> that<span class="token punctuation">.</span>submitTime <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œè¿è¡Œç±»</p>
<pre class="line-numbers language-none"><code class="language-none">public static void main(String[] args) &#123;

        &#x2F;&#x2F;ä¸åˆæ³•çš„æ„é€ å‡½æ•°
        &#x2F;&#x2F;ç¼–è¯‘æ—¶é”™è¯¯ï¼šæ„é€ å‡½æ•° SingleObject() æ˜¯ä¸å¯è§çš„
        &#x2F;&#x2F;SingleObject object &#x3D; new SingleObject();

        &#x2F;&#x2F;è·å–å”¯ä¸€å¯ç”¨çš„å¯¹è±¡
        Singleton object0 &#x3D; Singleton.getInstance();

        &#x2F;&#x2F;è·å–å”¯ä¸€å¯ç”¨çš„å¯¹è±¡
        Singleton object1 &#x3D; Singleton.getInstance();

    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="No4-DelayQueueDemo-java"><a href="#No4-DelayQueueDemo-java" class="headerlink" title="No4_DelayQueueDemo.java"></a>No4_DelayQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">DelayQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Delayed</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_DelayQueueDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Delayed</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¿…é¡»å®ç°Delayedæ¥å£</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> submitTime<span class="token punctuation">;</span><span class="token comment">// äº¤å·æ—¶é—´</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> workTime<span class="token punctuation">;</span><span class="token comment">// è€ƒè¯•æ—¶é—´</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" äº¤å·,ç”¨æ—¶"</span> <span class="token operator">+</span> workTime<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> submitTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>workTime <span class="token operator">=</span> submitTime<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>submitTime <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>submitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" äº¤å·,ç”¨æ—¶"</span> <span class="token operator">+</span> workTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//å¿…é¡»å®ç°getDelayæ–¹æ³•</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//		è¿”å›ä¸€ä¸ªå»¶è¿Ÿæ—¶é—´</span>
            <span class="token keyword">return</span> unit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>submitTime <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//å¿…é¡»å®ç°compareToæ–¹æ³•</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Delayed</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//æ¯”è¾ƒçš„æ–¹æ³•</span>
            <span class="token class-name">Student</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">return</span> submitTime <span class="token operator">></span> that<span class="token punctuation">.</span>submitTime <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>submitTime <span class="token operator">&lt;</span> that<span class="token punctuation">.</span>submitTime <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// æ–°å»ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</span>
        <span class="token keyword">final</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span> bq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"å­¦ç”Ÿ"</span><span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bq<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æ•°æ®å­˜åˆ°é˜Ÿåˆ—é‡Œï¼</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//è·å–ä½†ä¸ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´éƒ¨ï¼›å¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"bq.peek()"</span><span class="token operator">+</span>bq<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œåœ¨å¯ä»æ­¤é˜Ÿåˆ—è·å¾—åˆ°æœŸå»¶è¿Ÿçš„å…ƒç´ ï¼Œæˆ–è€…åˆ°è¾¾æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´ç­‰å¾…ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰ã€‚</span>
        <span class="token comment">//poll(long timeout, TimeUnit unit) å¤§å®¶å¯ä»¥è¯•ä¸€è¯•è¿™ä¸ªæ–¹æ³•</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹:æ¯æ¬¡è¿è¡Œç»“æœéƒ½ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬è·å¾—æ°¸è¿œæ˜¯é˜Ÿåˆ—é‡Œé¢çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">å­¦ç”Ÿ<span class="token number">0</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">5</span>
å­¦ç”Ÿ<span class="token number">1</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">3</span>
å­¦ç”Ÿ<span class="token number">2</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">5</span>
å­¦ç”Ÿ<span class="token number">3</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">9</span>
å­¦ç”Ÿ<span class="token number">4</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">10</span>
bq<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span>å­¦ç”Ÿ<span class="token number">1</span> äº¤å·<span class="token punctuation">,</span>ç”¨æ—¶<span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯»è€…å¯ä»¥æ…¢æ…¢åœ°åœ¨ä»¥åçš„å·¥ä½œå½“ä¸­ä½“ä¼š DelayQueueçš„ç”¨æ³•ã€‚</p>
<h3 id="åŒæ­¥é˜Ÿåˆ—SynchronousQueue"><a href="#åŒæ­¥é˜Ÿåˆ—SynchronousQueue" class="headerlink" title="åŒæ­¥é˜Ÿåˆ—SynchronousQueue"></a>åŒæ­¥é˜Ÿåˆ—SynchronousQueue</h3><p>â€‹        <code>SynchronousQueue</code>æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ª<code>put</code>æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ª<code>take</code>æ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚<code>SynchronousQueue</code>å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¼ çƒæ‰‹ï¼Œè´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆäºä¼ é€’æ€§åœºæ™¯ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®ï¼Œä¼ é€’ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œ<code>SynchronousQueue</code>çš„ååé‡é«˜äº<code>LinkedBlockingQueue</code>å’Œ <code>ArrayBlockingQueue</code>ã€‚<br>â€‹        å£°æ˜ä¸€ä¸ª<code>SynchronousQueue</code>æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ç€ä¸å¤ªä¸€æ ·çš„è¡Œä¸ºã€‚å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼çš„åŒºåˆ«ï¼šå¦‚æœé‡‡ç”¨å…¬å¹³æ¨¡å¼ï¼Œ<code>SynchronousQueue</code>ä¼šé‡‡ç”¨å…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ª <code>FIFO</code> é˜Ÿåˆ—æ¥é˜»å¡å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä»è€Œä½“ç³»æ•´ä½“çš„å…¬å¹³ç­–ç•¥ï¼›ä½†å¦‚æœæ˜¯éå…¬å¹³æ¨¡å¼(<code>SynchronousQueue</code>é»˜è®¤) ,<code>SynchronousQueue</code>é‡‡ç”¨éå…¬å¹³é”ï¼ŒåŒæ—¶é…åˆä¸€ä¸ª <code>LIFO</code>é˜Ÿåˆ—æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…,è€Œåä¸€ç§æ¨¡å¼ï¼Œå¦‚æœç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦æœ‰å·®è·,åˆ™å¾ˆå®¹æ˜“å‡ºç°é¥¥æ¸´çš„æƒ…å†µï¼Œå³å¯èƒ½æœ‰æŸäº›ç”Ÿäº§è€…æˆ–è€…æ˜¯æ¶ˆè´¹è€…çš„æ•°æ®æ°¸è¿œéƒ½å¾—ä¸åˆ°å¤„ç†ã€‚<br>â€‹        æ¥çœ‹éƒ¨åˆ†<code>SynchronousQueue</code>çš„æºç ï¼Œç†è§£ä¸€ä¸‹<code>SynchronousQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ï¼š</p>
<p>â€‹        å› ä¸º<code>SynchronousQueue</code>æ²¡æœ‰å†…éƒ¨å®¹é‡ï¼Œæ‰€ä»¥åªæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li><code>isEmpty()</code>ï¼šå§‹ç»ˆè¿”å› trueã€‚</li>
<li><code>size()</code>ï¼šå§‹ç»ˆè¿”å›0ã€‚</li>
<li><code>remainingCapacity()</code>ï¼šå§‹ç»ˆè¿”å›0ã€‚</li>
<li><code>clear()</code>ï¼šä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</li>
<li><code>remove(Object o)</code>ï¼šå§‹ç»ˆè¿”å›falseã€‚</li>
<li><code>containsAll(Collection&lt;?&gt;c)</code>ï¼šé™¤éç»™å®š<code>collection</code>ä¸ºç©ºï¼Œå¦åˆ™è¿”å›falseã€‚</li>
<li><code>removeAll(Collection&lt;?&gt;c)</code>ï¼šå§‹ç»ˆè¿”å›falseã€‚</li>
<li><code>retainAll(Collection&lt;?&gt;C)</code>ï¼šå§‹ç»ˆè¿”å›falseã€‚</li>
<li><code>peek(O)</code>ï¼šå§‹ç»ˆè¿”å›nullã€‚</li>
<li><code>iterator()</code>ï¼šè¿”å›ä¸€ä¸ªç©ºè¿­ä»£å™¨,å…¶ä¸­hasNextå§‹ç»ˆè¿”å›falseã€‚</li>
<li><code>toArray()</code>ï¼šè¿”å›ä¸€ä¸ª0é•¿åº¦çš„æ•°ç»„ã€‚</li>
</ul>
<p>SynchronousQueueç®€å•çš„ä½¿ç”¨å®ä¾‹å¦‚ä¸‹:</p>
<h4 id="No5-SynchronousQueueDemo-java"><a href="#No5-SynchronousQueueDemo-java" class="headerlink" title="No5_SynchronousQueueDemo.java"></a>No5_SynchronousQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">SynchronousQueue</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * ç°æˆç¨‹åºä¸­çš„Test1ç±»ä¸­çš„ä»£ç åœ¨ä¸æ–­åœ°äº§ç”Ÿæ•°æ®ï¼Œ
 * ç„¶åäº¤ç»™TestDo.doSome()æ–¹æ³•å»å¤„ç†ï¼Œ
 * å°±å¥½åƒç”Ÿäº§è€…åœ¨ä¸æ–­åœ°äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹è€…åœ¨ä¸æ–­æ¶ˆè´¹æ•°æ®ã€‚
 *
 * è¯·å°†ç¨‹åºæ”¹é€ æˆæœ‰10ä¸ªçº¿ç¨‹æ¥æ¶ˆè´¹ç”Ÿæˆè€…äº§ç”Ÿçš„æ•°æ®ï¼Œè¿™äº›æ¶ˆè´¹è€…éƒ½è°ƒç”¨TestDo.doSome()æ–¹æ³•å»è¿›è¡Œå¤„ç†ï¼Œ
 * æ•…æ¯ä¸ªæ¶ˆè´¹è€…éƒ½éœ€è¦ä¸€ç§’æ‰èƒ½å¤„ç†å®Œï¼Œç¨‹åºåº”ä¿è¯è¿™äº›æ¶ˆè´¹è€…çº¿ç¨‹ä¾æ¬¡æœ‰åºåœ°æ¶ˆè´¹æ•°æ®ï¼Œåªæœ‰ä¸Šä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å®Œåï¼Œ
 * ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹æ•°æ®ï¼Œä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…æ˜¯è°éƒ½å¯ä»¥ï¼Œä½†è¦ä¿è¯è¿™äº›æ¶ˆè´¹è€…çº¿ç¨‹æ‹¿åˆ°çš„æ•°æ®æ˜¯æœ‰é¡ºåºçš„ã€‚
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_SynchronousQueueDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// ä¸èƒ½æ”¹åŠ¨æ­¤TestDoç±»</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestDo</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">doSome</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">String</span> output <span class="token operator">=</span> input <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> output<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"begin:"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å®šä¹‰ä¸€ä¸ªSynchronous</span>
        <span class="token keyword">final</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> sq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å®šä¹‰ä¸€ä¸ªæ•°é‡ä¸º1çš„ä¿¡å·é‡ï¼Œå…¶ä½œç”¨ç›¸å½“äºä¸€ä¸ªäº’æ–¥é”</span>
        <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> sem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        sem<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> input <span class="token operator">=</span> sq<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> output <span class="token operator">=</span> <span class="token class-name">TestDo</span><span class="token punctuation">.</span><span class="token function">doSome</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sem<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// è¿™è¡Œä¸èƒ½æ”¹åŠ¨</span>
            <span class="token class-name">String</span> input <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span> <span class="token comment">// è¿™è¡Œä¸èƒ½æ”¹åŠ¨</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                sq<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="é“¾è¡¨åŒå‘é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque"><a href="#é“¾è¡¨åŒå‘é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque" class="headerlink" title="é“¾è¡¨åŒå‘é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque"></a>é“¾è¡¨åŒå‘é˜»å¡é˜Ÿåˆ—<code>LinkedBlockingDeque</code></h3><p>â€‹        <code>LinkedBlockingDeque</code>æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„ä½ å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒç«¯é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚ ç›¸æ¯”å…¶ä»–çš„é˜»å¡é˜Ÿåˆ—ï¼Œ<code>LinkedBlockingDeque</code>å¤šäº†<code>addFirst</code>ã€<code>addLast</code>ã€<code>offerFirst</code>ã€<code>offerLast</code>ã€<code>peekFirst</code>ã€<code>peekLast</code> ç­‰æ–¹æ³•ï¼Œä»¥<code>First</code>å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ã€è·å–(<code>peek</code>) æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬-ä¸€ä¸ªå…ƒç´ ã€‚ä»¥<code>Last</code>å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æ’å…¥æ–¹æ³•<code>add</code>ç­‰åŒäº<code>addLast</code>ï¼Œç§»é™¤æ–¹æ³•<code>remove</code>ç­‰æ•ˆäº<code>removeFirst</code>.<br>â€‹        åœ¨åˆå§‹åŒ–LinkedBlockingDequeæ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡æ¸¡è†¨èƒ€ã€‚å¦å¤–ï¼ŒåŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨â€œå·¥ä½œçªƒå–â€æ¨¡å¼ä¸­ï¼Œæœ‰ç‚¹å’ŒLinkedBlockingQueueç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">public</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
 
	<span class="token keyword">public</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span> <span class="token comment">// æŒ‡å®šé˜Ÿåˆ—åˆå§‹å®¹é‡</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨äº†addLastæ–¹æ³•</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addFirst</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨äº†addFirstæ–¹æ³•</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">offerFirst</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Deque full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">// é˜Ÿåˆ—å·²æ»¡ï¼ŒæŠ›å¼‚å¸¸</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">offerLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Deque full"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">// é˜Ÿåˆ—å·²æ»¡ï¼ŒæŠ›å¼‚å¸¸</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">offerLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offerFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å…ƒç´ èŠ‚ç‚¹</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">linkFirst</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨æ’å…¥åŒç«¯é˜Ÿåˆ—å¤´éƒ¨æ–¹æ³•</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">linkFirst</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// assert lock.isHeldByCurrentThread();</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">>=</span> capacity<span class="token punctuation">)</span> <span class="token comment">// å¦‚æœé˜Ÿåˆ—å®¹é‡å·²æ»¡,è¿”å›false</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> f <span class="token operator">=</span> first<span class="token punctuation">;</span> <span class="token comment">// ä¸´æ—¶å­˜å‚¨é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ </span>
        node<span class="token punctuation">.</span>next <span class="token operator">=</span> f<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ—§å¤´éƒ¨å…ƒç´ ä½œä¸ºæ–°å…ƒç´ çš„nextèŠ‚ç‚¹</span>
        first <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ–°å…ƒç´ ä½œä¸ºå¤´éƒ¨èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// åˆ¤æ–­é˜Ÿåˆ—å°¾éƒ¨å…ƒç´ æ˜¯å¦ä¸ºç©º</span>
            last <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            f<span class="token punctuation">.</span>prev <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ—§å¤´éƒ¨å…ƒç´ çš„prevæŒ‡å‘æ–°èŠ‚ç‚¹</span>
        <span class="token operator">++</span>count<span class="token punctuation">;</span> <span class="token comment">// ç´¯è®¡é˜Ÿåˆ—æ•°é‡</span>
        notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// è¿”å›true</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offerLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å…ƒç´ èŠ‚ç‚¹</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">linkLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨æ’å…¥é˜Ÿåˆ—å°¾éƒ¨æ–¹æ³•</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">linkLast</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// assert lock.isHeldByCurrentThread();</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">>=</span> capacity<span class="token punctuation">)</span> <span class="token comment">// åˆ¤æ–­å®¹é‡æ˜¯å¦å·²æ»¡, å·²æ»¡è¿”å›false</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> l <span class="token operator">=</span> last<span class="token punctuation">;</span> <span class="token comment">// ä¸´æ—¶å­˜å‚¨é˜Ÿåˆ—å°¾éƒ¨èŠ‚ç‚¹</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> l<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ–°å…ƒç´ èŠ‚ç‚¹çš„prevæŒ‡å‘é˜Ÿåˆ—æ—§å°¾éƒ¨èŠ‚ç‚¹</span>
        last <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ–°å…ƒç´ èŠ‚ç‚¹ä½œä¸ºé˜Ÿåˆ—å°¾éƒ¨èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// åˆ¤æ–­é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ æ˜¯å¦ä¸ºç©º</span>
            first <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            l<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// æŠŠæ—§å°¾éƒ¨èŠ‚ç‚¹çš„nextæŒ‡å‘æ–°å…ƒç´ èŠ‚ç‚¹</span>
        <span class="token operator">++</span>count<span class="token punctuation">;</span> <span class="token comment">// ç´¯è®¡é˜Ÿåˆ—æ•°é‡</span>
        notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// è¿”å›false</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token function">putLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å…ƒç´ èŠ‚ç‚¹</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">linkFirst</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// åˆ¤æ–­å…ƒç´ æ˜¯å¦å·²æ’å…¥æˆåŠŸï¼Œå¦‚æœªæˆåŠŸï¼Œåˆ™ä¸€ç›´é˜»å¡</span>
                notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°å…ƒç´ èŠ‚ç‚¹</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">linkLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœªæ’å…¥æˆåŠŸï¼Œåˆ™ä¸€ç›´é˜»å¡ï¼Œç­‰å¾…æ’å…¥</span>
                notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">takeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">takeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">E</span> x<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token function">unlinkFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="é“¾è¡¨ä¼ è¾“é˜Ÿåˆ—-LinkedTransferQueue"><a href="#é“¾è¡¨ä¼ è¾“é˜Ÿåˆ—-LinkedTransferQueue" class="headerlink" title="é“¾è¡¨ä¼ è¾“é˜Ÿåˆ— LinkedTransferQueue"></a>é“¾è¡¨ä¼ è¾“é˜Ÿåˆ— LinkedTransferQueue</h3><p>â€‹        <code>LinkedTransferQueue</code>æ˜¯ä¸€ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œä¼ è¾“é˜»å¡é˜Ÿåˆ—ã€‚<code>TransferQueue</code>æ˜¯ä¸€ä¸ªç»§æ‰¿äº†<code>BlockingQueue</code> çš„æ¥å£ï¼Œå¹¶ä¸”å¢åŠ è‹¥å¹²æ–°çš„æ–¹æ³•ã€‚<code>LinkedTransferQueue</code>æ˜¯å®ç°ç±»ï¼Œå…¶å®šä¹‰ä¸ºä¸€ä¸ªæ— ç•Œçš„é˜Ÿåˆ—ï¼Œä¸€æ ·å…·æœ‰å…ˆè¿›å…ˆå‡º(<strong>FIFO : first-in-first-out</strong>)çš„ç‰¹æ€§ã€‚Doug Leaè¿™æ ·è¯„ä»·å®ƒ: <code>TransferQueue</code> æ˜¯ä¸€ä¸ªèªæ˜çš„é˜Ÿåˆ—ï¼Œå®ƒæ˜¯<code>ConcurrentLinkedQueue</code>ã€<code>SynchronousQueue</code> (åœ¨å…¬å¹³æ¨¡å¼ä¸‹)ã€æ— ç•Œçš„<code>LinkedBlockingQueue</code>ç­‰çš„è¶…é›†ï¼Œæ˜¯LinkedBlockingQueueã€SynchronousQueueï¼ˆå…¬å¹³æ¨¡å¼ï¼‰ã€ConcurrentLinkedQueueä¸‰è€…çš„é›†åˆä½“ï¼Œå®ƒç»¼åˆäº†è¿™ä¸‰è€…çš„æ–¹æ³•ï¼Œå¹¶ä¸”æä¾›äº†æ›´åŠ é«˜æ•ˆçš„å®ç°æ–¹å¼ã€‚æ˜¾ç„¶æ˜“è§ï¼Œæ··åˆäº†è‹¥å¹²é«˜çº§ç‰¹æ€§ï¼Œå¹¶ä¸”å…·æœ‰é«˜æ€§èƒ½çš„ä¸€ä¸€ä¸ªç»„åˆä½“ï¼Œä¸€ä¸ªå¤šé¢æ‰‹ã€‚å•çº¯ä»é˜Ÿåˆ—æ¥çœ‹ï¼Œ<code>TransferQueue </code>æ¥å£å¢åŠ äº†ä¸€äº›å¾ˆå®ç”¨çš„æ–°ç‰¹æ€§ã€‚</p>
<p>â€‹        <code>transfer ç®—æ³•æ¯”è¾ƒå¤æ‚</code>ï¼Œå®ç°å¾ˆéš¾çœ‹æ˜ç™½ã€‚å¤§è‡´çš„ç†è§£æ˜¯é‡‡ç”¨æ‰€è°“<strong>åŒé‡æ•°æ®ç»“æ„</strong>(dual data structures) ã€‚ä¹‹æ‰€ä»¥å«åŒé‡ï¼Œå…¶åŸå› æ˜¯æ–¹æ³•éƒ½æ˜¯é€šè¿‡ä¸¤ä¸ªæ­¥éª¤å®Œæˆï¼šä¿ç•™ä¸å®Œæˆã€‚æ¯”å¦‚ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä»ä¸€ä¸ªé˜Ÿåˆ—ä¸­å–å…ƒç´ ï¼Œå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œå®ƒå°±ç”Ÿæˆä¸€ä¸ªç©ºå…ƒç´ æ”¾å…¥é˜Ÿåˆ—ï¼Œæ‰€è°“ç©ºå…ƒç´ å°±æ˜¯æ•°æ®é¡¹å­—æ®µä¸ºç©ºã€‚ç„¶åæ¶ˆè´¹è€…çº¿ç¨‹åœ¨è¿™ä¸ªå­—æ®µä¸Šç»§ç»­ç­‰å¾…ï¼Œè¿™å«ä¿ç•™ã€‚ç›´åˆ°ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹æ„æ¬²å‘é˜Ÿåˆ—ä¸­æ”¾å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè¿™é‡Œå®ƒå‘ç°æœ€å‰é¢çš„å…ƒç´ çš„æ•°æ®é¡¹å­—æ®µä¸ºNULLï¼Œå®ƒå°±ç›´æ¥æŠŠè‡ªå·±æ•°æ®å¡«å……åˆ°è¿™ä¸ªå…ƒç´ ä¸­ï¼Œå³å®Œæˆäº†å…ƒç´ çš„ä¼ é€ã€‚å¤§ä½“æ˜¯è¿™ä¸ªæ„æ€ï¼Œè¿™ç§æ–¹å¼ä¼˜ç¾åœ°å®Œæˆäº†çº¿ç¨‹ä¹‹é—´çš„é«˜æ•ˆåä½œã€‚å…¶<code>tansfer</code>æ–¹æ³•æä¾›äº†çº¿ç¨‹ä¹‹é—´ç›´æ¥äº¤æ¢å¯¹è±¡çš„æ·å¾„çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€è¿°ï¼š</p>
<ul>
<li>(1) <code>transfer(E e)</code>ï¼Œè‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾… è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå³ç«‹åˆ»ç§»äº¤ä¹‹ï¼›å¦åˆ™ï¼Œä¼šæ’å…¥å½“å‰å…ƒç´ eåˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶ä¸”ç­‰å¾…è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ¶ˆè´¹è€…çº¿ç¨‹å–èµ°è¯¥å…ƒç´ ã€‚</li>
<li>(2) <code>tryTransfer(E e)</code>ï¼Œè‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹(ä½¿ç”¨<code>take()</code>æˆ–è€…<code>poll()</code>å‡½æ•°)ï¼Œä½¿ç”¨è¯¥æ–¹æ³•ä¼šå³åˆ»è½¬ç§»&#x2F;ä¼ è¾“å¯¹è±¡å…ƒç´ ï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›<strong>false</strong>ï¼Œå¹¶ä¸”ä¸è¿›å…¥é˜Ÿåˆ—ã€‚è¿™æ˜¯ä¸ª<strong>ä¸é˜»å¡</strong>çš„æ“ä½œã€‚</li>
<li>(3) <code>tryTransfer(E e, long timeout, TimeUnit unit)</code>ï¼Œè‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¼šç«‹å³ä¼ è¾“ç»™å®ƒï¼›å¦åˆ™å°†æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶ä¸”ç­‰å¾…è¢«æ¶ˆè´¹è€…çº¿ç¨‹è·å–æ¶ˆè´¹æ‰ã€‚è‹¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…å…ƒç´ eæ— æ³•è¢«æ¶ˆè´¹è€…çº¿ç¨‹è·å–ï¼Œåˆ™è¿”å›<strong>false</strong>ï¼ŒåŒæ—¶è¯¥å…ƒç´ <strong>è¢«ç§»é™¤</strong>ã€‚</li>
<li>(4) <code>hasWaitingConsumer()</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç»ˆç«¯æ¶ˆè´¹è€…çº¿ç¨‹ã€‚</li>
<li>(5) <code>getWaitingConsumerCount()</code>ï¼Œå­—é¢æ„æ€å¾ˆæ˜ç™½ï¼Œè·å–ç»ˆç«¯æ‰€æœ‰ç­‰å¾…è·å–å…ƒç´ çš„æ¶ˆè´¹çº¿ç¨‹æ•°é‡ã€‚</li>
<li>(6) <code>size()</code>ï¼Œ å› ä¸ºé˜Ÿåˆ—çš„å¼‚æ­¥ç‰¹æ€§ï¼Œæ£€æµ‹å½“å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°éœ€è¦é€ä¸€è¿­ä»£ï¼Œ å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªä¸å¤ªå‡†ç¡®çš„ç»“æœï¼Œå°¤å…¶æ˜¯åœ¨éå†æ—¶æœ‰å¯èƒ½é˜Ÿåˆ—å‘ç”Ÿæ›´æ”¹ã€‚</li>
</ul>
<p>æ‰¹é‡æ“ä½œç±»ä¼¼äº<code>addAll</code>ã€ <code>removeAll</code>ã€<code>retainAll</code>ã€<code>containsAll </code>ã€<code>equals</code>ã€ <code>toArray</code> ç­‰æ–¹æ³•ï¼Œ<strong>API</strong>ä¸èƒ½ä¿è¯ä¸€å®šä¼šç«‹åˆ»æ‰§è¡Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½æœ‰æ‰€æœŸå¾…ï¼Œè¿™æ˜¯ä¸€ä¸ªå…·æœ‰å¼‚æ­¥ç‰¹æ€§çš„é˜Ÿåˆ—ã€‚</p>
<p>æ³¨æ„äº‹é¡¹:<br>        â—æ— è®ºæ˜¯<code>transfer</code>è¿˜æ˜¯<code>tryTransfer</code>æ–¹æ³•ï¼Œåœ¨&gt;&#x3D;1ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…è·å–å…ƒç´ æ—¶(<strong>æ­¤æ—¶é˜Ÿåˆ—ä¸ºç©º</strong>)ï¼Œéƒ½ä¼šç«‹åˆ»è½¬äº¤ï¼Œè¿™å±äºçº¿ç¨‹ä¹‹é—´çš„å…ƒç´ äº¤æ¢ã€‚æ³¨æ„ï¼Œè¿™æ—¶å…ƒç´ å¹¶æ²¡æœ‰è¿›å…¥é˜Ÿåˆ—ã€‚<br>        â—åœ¨é˜Ÿåˆ—ä¸­å·²æœ‰æ•°æ®æƒ…å†µä¸‹ï¼Œ<code>transfer</code> å°†éœ€è¦ç­‰å¾…å‰é¢æ•°æ®è¢«æ¶ˆè´¹æ‰ï¼Œç›´åˆ°ä¼ é€’çš„å…ƒç´ <strong>e</strong>è¢«æ¶ˆè´¹çº¿ç¨‹å–èµ°ä¸ºæ­¢ã€‚<br>        â—ä½¿ç”¨<code>transfer</code> æ–¹æ³•ï¼Œå·¥ä½œè€…çº¿ç¨‹å¯èƒ½ä¼šè¢«é˜»å¡åˆ°ç”Ÿäº§çš„å…ƒç´ è¢«æ¶ˆè´¹æ‰ä¸ºæ­¢ã€‚æ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…ä¸ºé›¶çš„æƒ…å†µä¸‹ï¼Œå„è‡ªçš„å¤„ç†å…ƒç´ å…¥é˜Ÿä¸å¦æƒ…å†µæœ‰æ‰€ä¸åŒã€‚<br>        â—<code>size()</code>æ–¹æ³•ï¼Œéœ€è¦è¿­ä»£ï¼Œ<strong>å¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œå°½é‡ä¸è¦è°ƒç”¨</strong>ã€‚</p>
<p>æ¥çœ‹éƒ¨åˆ†<code>LinkedTransferQueue</code>çš„æºç ï¼Œç†è§£ä¸€ä¸‹ <code>LinkedTransferQueue</code>çš„å®ç°åŸç†å’Œæœºåˆ¶ï¼š</p>
<p><code>LinkedTransferQueue</code>ç®€å•çš„ä½¿ç”¨å®ä¾‹å¦‚ä¸‹,æ¥æ…¢æ…¢ä½“ä¼šä¸€ä¸‹:</p>
<h4 id="No7-LinkedTransferQueueDemo-java"><a href="#No7-LinkedTransferQueueDemo-java" class="headerlink" title="No7_LinkedTransferQueueDemo.java"></a>No7_LinkedTransferQueueDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>blockingqueue</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedTransferQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TransferQueue</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No7_LinkedTransferQueueDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" Consumer "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">" your lucky number "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">hasWaitingConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        queue<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ç”Ÿäº§è€…ç¡çœ ä¸€ç§’é’Ÿ,è¿™æ ·å¯ä»¥çœ‹å‡ºç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedTransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹ä½¿å¾—çº¿ç¨‹æ‰§è¡Œç»“æŸåç¨‹åºè‡ªåŠ¨ç»“æŸè¿è¡Œ</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// æ¶ˆè´¹è€…è¿›ç¨‹ä¼‘çœ ä¸€ç§’é’Ÿï¼Œä»¥ä¾¿ä»¥ä¾¿ç”Ÿäº§è€…è·å¾—CPUï¼Œä»è€Œç”Ÿäº§äº§å“</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span> your lucky number <span class="token number">2</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span> your lucky number <span class="token number">55</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span> your lucky number <span class="token number">86</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">4</span> your lucky number <span class="token number">54</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">5</span> your lucky number <span class="token number">8</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">6</span> your lucky number <span class="token number">30</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">7</span> your lucky number <span class="token number">54</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">8</span> your lucky number <span class="token number">8</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">9</span> your lucky number <span class="token number">69</span>
<span class="token class-name">Consumer</span> <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">10</span> your lucky number <span class="token number">14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æ€»ä¹‹ï¼Œ<code>BlockingQueue</code>ä½œä¸ºçº¿ç¨‹å®¹å™¨ï¼Œå¯ä»¥ä¸ºçº¿ç¨‹åŒæ­¥æä¾›æœ‰åŠ›çš„ä¿éšœã€‚<code>BlockingQueue</code>åœ¨çº¿ç¨‹æ± é‡Œé¢æœ‰é‡è¦åº”ç”¨,æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¿…é¡»äº¤ä»£æ¸…æ¥šã€‚</p>
<h3 id="åŒæ­¥è®¡æ•°å™¨CountDownLatch"><a href="#åŒæ­¥è®¡æ•°å™¨CountDownLatch" class="headerlink" title="åŒæ­¥è®¡æ•°å™¨CountDownLatch"></a>åŒæ­¥è®¡æ•°å™¨CountDownLatch</h3><p>â€‹        <code>CountDownLatch</code> æ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯å€’è®¡æ•°(<code>CountDown</code>)é—¨é—©(<code>Latch</code>) ã€‚å€’è®¡æ•°ä¸ç”¨è¯´ï¼Œé—¨é—¨çš„æ„æ€é¡¾åæ€ä¹‰å°±æ˜¯é˜»æ­¢å‰è¿›ã€‚åœ¨å®Œæˆä¸€ç»„æ­£åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œä¹‹å‰ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ã€‚ ç”¨ç»™å®šçš„è®¡æ•°åˆå§‹åŒ–<code>CountDownLatch</code>ã€‚ ç”±äºè°ƒç”¨äº†<code>countDown()</code>æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨å½“å‰è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ï¼Œ<code>await() </code>æ–¹æ³•ä¼šç›´å—é˜»å¡ã€‚ ä¹‹åï¼Œä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œ<code>await() </code> çš„æ‰€æœ‰åç»­è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ã€‚<strong>è¿™ç§ç°è±¡åªå‡ºç°ä¸€æ¬¡â€“è®¡æ•°æ— æ³•è¢«é‡ç½®</strong>ã€‚</p>
<p>â€‹        ä¸»è¦çš„æ–¹æ³•æœ‰:</p>
<ul>
<li><p><code>CountDownLatch(int count)</code>æ„é€ ä¸€ä¸ªç”¨ç»™å®šè®¡æ•°åˆå§‹åŒ–çš„<code>CountDownLatch</code>ã€‚</p>
</li>
<li><p><code>void await()</code>å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é—©é”å€’æ•°ä¸ºé›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ã€‚</p>
</li>
<li><p><code>boolean await(long timeout, TimeUnit unit)</code> å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é”å­˜å™¨å€’æ•°ä¸ºé›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ï¼Œæˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡äº†ã€‚</p>
</li>
<li><p><code>countDown()</code>é€’å‡é”å­˜å™¨çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°åˆ°è¾¾é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
</li>
<li><p><code>long getCount()</code>è¿”å›å½“å‰è®¡æ•°ã€‚</p>
</li>
</ul>
<p> <code>CountDownLatch</code>çš„å®ç°åŸç†ï¼š<br>        æ¥çœ‹ä¸€ä¸‹<code>CountDownLatch</code> çš„éƒ¨åˆ†æºç ï¼Œç†è§£ä¸€ä¸‹<code>CountDownLatch</code> çš„å®ç°åŸç†å’Œæœºåˆ¶ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1663210842526248944&wfr=spider&for=pc">Javaå¹¶å‘å·¥å…·ä¸‰å‰‘å®¢ä¹‹CountDownLatchæºç è§£æ (baidu.com)</a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatch</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Synchronization control For CountDownLatch.
     * Uses AQS state to represent count.
     åŒæ­¥æ§åˆ¶çš„CountDownLatchã€‚ä½¿ç”¨AQSçŠ¶æ€è¡¨ç¤ºè®¡æ•°ã€‚  å¯ä»¥çœ‹å‡ºï¼ŒCountDownLatchçš„åŠŸèƒ½è¿˜æ˜¯é€šè¿‡AQSæ¥å®ç°çš„ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">4982264981922014374L</span><span class="token punctuation">;</span>

        <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Decrement count; signal when transition to zero é€’å‡è®¡æ•°;ä¿¡å·æ—¶è¿‡æ¸¡åˆ°é›¶</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">//CAS </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>
    
    <span class="token comment">//æ„é€ ä¸€ä¸ªç”¨ç»™å®šè®¡æ•°åˆå§‹åŒ–çš„CountDownLatchã€‚ count -åœ¨çº¿ç¨‹é€šè¿‡awaitä¹‹å‰å¿…é¡»è°ƒç”¨countDownçš„æ¬¡æ•°</span>
    <span class="token keyword">public</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"count &lt; 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¯ä»¥çœ‹å‡ºè¦ä½¿ç”¨CountDownLatchå°±éœ€è¦æŒ‡å®šcountå€¼ï¼Œä¸”å¿…é¡»å¤§äº0ï¼Œè€Œè¿™ä¸ªcountå€¼æœ€ç»ˆæ˜¯èµ‹å€¼ç»™äº†AQSçš„stateï¼Œå¯ä»¥çœ‹ä¸‹é¢ new Sync(count)çš„æºç ï¼Œå®ƒå®é™…ä¸Šæ˜¯setçš„stateå€¼ï¼Œè€Œè¿™ä¸ªstateæ˜¯AQSä¸­çš„å±æ€§</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/** 
    	å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é—©é”å€’æ•°ä¸ºé›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­
    	å¦‚æœå½“å‰è®¡æ•°ä¸ºé›¶ï¼Œåˆ™æ­¤æ–¹æ³•ç«‹å³è¿”å›ã€‚
		
		å¦‚æœå½“å‰è®¡æ•°å¤§äº0ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œä»¥å®ç°çº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼š
		1ã€ç”±äºè°ƒç”¨countDownæ–¹æ³•ï¼Œè®¡æ•°è¾¾åˆ°é›¶;
		2ã€æˆ–å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚
		
		å¦‚æœå½“å‰çº¿ç¨‹:
			åœ¨è¿›å…¥è¯¥æ–¹æ³•æ—¶è®¾ç½®äº†ä¸­æ–­çŠ¶æ€;
			æˆ–åœ¨ç­‰å¾…æ—¶è¢«æ‰“æ–­
		
		ç„¶åæŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚
		æŠ›å‡º: InterruptedExceptionâ€”â€”å¦‚æœå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­
	*/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
    	å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°é”å­˜å™¨å€’æ•°ä¸ºé›¶ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ï¼Œæˆ–æŒ‡å®šçš„ç­‰å¾…æ—¶é—´è¿‡äº†ã€‚
		å¦‚æœå½“å‰è®¡æ•°ä¸ºé›¶ï¼Œåˆ™è¯¥æ–¹æ³•ç«‹å³è¿”å›å€¼ä¸ºtrueã€‚
		å¦‚æœå½“å‰è®¡æ•°å¤§äº0ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°†è¢«ç¦ç”¨ï¼Œä»¥å®ç°çº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€:
			1ã€ç”±äºè°ƒç”¨countDownæ–¹æ³•ï¼Œè®¡æ•°è¾¾åˆ°é›¶;
			2ã€æˆ–å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹;
			3ã€æˆ–ç­‰å¾…æ—¶é—´è¿‡äº†ã€‚
		å¦‚æœè®¡æ•°ä¸ºé›¶ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å›å€¼ä¸ºtrueã€‚
		å¦‚æœå½“å‰çº¿ç¨‹:åœ¨è¿›å…¥è¯¥æ–¹æ³•æ—¶è®¾ç½®äº†ä¸­æ–­çŠ¶æ€;æˆ–åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚
		å¦‚æœç»è¿‡äº†æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œåˆ™è¿”å›å€¼falseã€‚å¦‚æœæ—¶é—´å°äºæˆ–ç­‰äºé›¶ï¼Œåˆ™è¯¥æ–¹æ³•æ ¹æœ¬ä¸ä¼šç­‰å¾…ã€‚
		å‚æ•°:timeoutâ€”ç­‰å¾…çš„æœ€å¤§æ—¶é—´å•ä½â€”timeoutå‚æ•°çš„æ—¶é—´å•ä½
		è¿”å›:å¦‚æœè®¡æ•°ä¸º0åˆ™è¿”å›trueï¼Œå¦‚æœç­‰å¾…æ—¶é—´ç»è¿‡båˆ™è¿”å›false
		æŠ›å‡º: InterruptedExceptionâ€”â€”å¦‚æœå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireSharedNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
    	é€’å‡é”å­˜çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°ä¸ºé›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚
		å¦‚æœå½“å‰è®¡æ•°å¤§äºé›¶ï¼Œåˆ™é€’å‡ã€‚å¦‚æœæ–°çš„è®¡æ•°ä¸º0ï¼Œé‚£ä¹ˆæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹éƒ½å°†é‡æ–°å¯ç”¨ï¼Œä»¥å®ç°çº¿ç¨‹è°ƒåº¦ç›®çš„ã€‚
		å¦‚æœå½“å‰è®¡æ•°ç­‰äºé›¶ï¼Œé‚£ä¹ˆä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
        public final boolean releaseShared(int arg) &#123;
            if (tryReleaseShared(arg)) &#123;
                doReleaseShared();
                return true;
            &#125;
            return false;
    	&#125;
    	
    	private void doReleaseShared() &#123;
            for (;;) &#123;
                Node h = head;
                if (h != null &amp;&amp; h != tail) &#123;
                    int ws = h.waitStatus;
                    if (ws == Node.SIGNAL) &#123;
                        if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                            continue;            // loop to recheck cases
                        unparkSuccessor(h);
                    &#125;
                    else if (ws == 0 &amp;&amp;
                             !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))
                        continue;                // loop on failed CAS
                &#125;
                if (h == head)                   // loop if head changed
                    break;
            &#125;
   		 &#125;
        */</span>
        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
    è¿”å›å½“å‰è®¡æ•°ã€‚
    æ­¤æ–¹æ³•é€šå¸¸ç”¨äºè°ƒè¯•å’Œæµ‹è¯•ç›®çš„ã€‚
    è¿”å›:å½“å‰è®¡æ•°
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"[Count = "</span> <span class="token operator">+</span> sync<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>â€‹        å…¶å®æˆ‘ä»¬çœ‹åˆ° <code>CountDownLatch</code> æºç ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åˆ©ç”¨<code>AbstractQueuedSynchronizer</code>æ¥å®ç°ã€‚è€Œ <code>AbstractQueuedSynchronizer</code>å…¶å®ä¸éš¾å‘ç°ï¼Œæˆ‘ä»¬å¦‚æœå»æŸ¥çœ‹ä¸€ä¸‹<code>ReentrantLock</code>ã€<code>CountDownLatch</code>ã€<code>Semaphore</code>ã€<code>FutureTask</code>ã€<code>ThreadPoolExecutor</code> çš„æºç çš„è¯ï¼Œéƒ½ä¼šå‘ç°æœ‰ä¸ªåå« <code>Sync</code> çš„<strong>é™æ€å†…éƒ¨ç±»</strong>ï¼Œç»§æ‰¿è‡ª<code>AbstractQueuedSynchronizer</code> ã€‚<code>AbstractQueuedSynchronizer</code>æ˜¯ <code>java.util.concurrent</code> çš„<strong>æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€</strong>ï¼Œ<strong>å®ƒä¸ºå¹¶å‘åŒ…ä¸­çš„å…¶ä»–synchronizersæä¾›äº†ä¸€ç»„å…¬å…±çš„åŸºç¡€è®¾æ–½</strong>ã€‚</p>
<p>â€‹        <strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<p>â€‹        åœ¨ä¸€äº›åº”ç”¨åœºåˆä¸­ï¼Œéœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶è¾¾åˆ°è¦æ±‚åæ‰èƒ½åšåé¢çš„äº‹æƒ…ï¼šåŒæ—¶å½“çº¿ç¨‹éƒ½å®Œæˆå<br>ä¹Ÿä¼šè§¦å‘äº‹ä»¶ï¼Œä»¥ä¾¿è¿›è¡Œåé¢çš„æ“ä½œã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨<code>CountDownLatch</code>ã€‚ <code>CountDownLatch</code><br>æœ€é‡è¦çš„æ–¹æ³•æ˜¯<code>countDown()</code>å’Œ<code>await()</code>ï¼Œå‰è€…ä¸»è¦æ˜¯å€’æ•°ä¸€æ¬¡ï¼Œ åè€…æ˜¯ç­‰å¾…å€’æ•°åˆ°0ï¼Œå¦‚æœæ²¡æœ‰åˆ°<br>è¾¾<strong>0</strong>ï¼Œå°±åªæœ‰<strong>é˜»å¡ç­‰å¾…</strong>äº†ã€‚æ¯”å¦‚ï¼Œä¸‹é¢ä¸¤ç§å®é™…åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>åº”ç”¨åœºæ™¯1ï¼šå¼€5ä¸ªå¤šçº¿ç¨‹å»ä¸‹è½½ï¼Œå½“5ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œäº†æ‰ç®—ä¸‹è½½æˆåŠŸ!</li>
<li>åº”ç”¨åœºæ™¯2ï¼šå½“ç”¨æˆ·å¤šæ–‡ä»¶ä¸Šä¼ çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å¤šçº¿ç¨‹ä¸Šä¼ ï¼Œå½“å¤šä¸ªæ–‡ä»¶éƒ½ä¸Šä¼ æˆåŠŸçš„<br>æ—¶å€™æ‰ç®—çœŸæ­£çš„ä¸Šä¼ æˆåŠŸã€‚</li>
</ul>
<p>ä¸¾ä¾‹:æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œåªæœ‰ä¸‰ä¸ªç¨‹åºéƒ½å¹²å®Œæ´»äº†ï¼Œæ‰ç®—é¡¹ç›®å®Œæˆã€‚å®ä¾‹å¦‚ä¸‹:</p>
<h4 id="No1-CountDownLatchDemoOne-java"><a href="#No1-CountDownLatchDemoOne-java" class="headerlink" title="No1_CountDownLatchDemoOne.java"></a>No1_CountDownLatchDemoOne.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_CountDownLatchDemoOne</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Worker</span> worker1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">"ç¨‹åºå‘˜1"</span><span class="token punctuation">,</span>latch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Worker</span> worker2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">"ç¨‹åºå‘˜2"</span><span class="token punctuation">,</span>latch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Worker</span> worker3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">"ç¨‹åºå‘˜3"</span><span class="token punctuation">,</span>latch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å½“å‰çº¿ç¨‹ç­‰å¾…</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Main thread end!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> workerName<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">String</span> workerName<span class="token punctuation">,</span><span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>workerName <span class="token operator">=</span> workerName<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> latch<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Worker:"</span><span class="token operator">+</span>workerName <span class="token operator">+</span><span class="token string">" is begin."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä¼‘çœ ä¸€ç§’é’Ÿï¼Œä»¥ä¾¿ç­‰å¾…å…¶ä»–çº¿ç¨‹è°ƒç”¨begin</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Worker:"</span><span class="token operator">+</span>workerName <span class="token operator">+</span><span class="token string">" is end."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// TODO Auto-generated catch block</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token comment">//æ¨¡ä»¿å¹²æ´»ï¼›</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€’å‡é”å­˜å™¨çš„è®¡æ•°</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡º</p>
<pre class="line-numbers language-none"><code class="language-none">Worker:ç¨‹åºå‘˜1 is begin.
Worker:ç¨‹åºå‘˜3 is begin.
Worker:ç¨‹åºå‘˜2 is begin.
Worker:ç¨‹åºå‘˜3 is end.
Worker:ç¨‹åºå‘˜2 is end.
Worker:ç¨‹åºå‘˜1 is end.
Main thread end!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>â€‹       </p>
<p>â€‹        ä»ç»“æœä¸Šå¯ä»¥çœ‹å¾—å‡ºæ¥ä¸åƒæˆ‘ä»¬ä¹‹å‰çš„å®ä¾‹ï¼ŒMainThreadä¹‹åç­‰ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶å®Œæˆçš„æ—¶å€™æ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹ç±»ä¸­æ³¨é‡Šçš„æ”¹å†™çš„ä¾‹å­</p>
<h4 id="No1-CountDownLatchDemoTwo-java"><a href="#No1-CountDownLatchDemoTwo-java" class="headerlink" title="No1_CountDownLatchDemoTwo.java"></a>No1_CountDownLatchDemoTwo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_CountDownLatchDemoTwo</span>  <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Driver</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">CountDownLatch</span> startSignal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CountDownLatch</span> doneSignal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// create and start threads åˆ›å»ºå’Œå¯åŠ¨çº¿ç¨‹</span>
                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>startSignal<span class="token punctuation">,</span> doneSignal<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// don't let run yet</span>
            startSignal<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// let all threads proceed  è®©æ‰€æœ‰çš„çº¿ç¨‹ç»§ç»­</span>
            <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            doneSignal<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// wait for all to finish  ç­‰ä¸€åˆ‡éƒ½ç»“æŸ</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"wait for all to finish"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">void</span> <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"doSomethingElse "</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss:SSS"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> startSignal<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> startSignal<span class="token punctuation">,</span> <span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>startSignal <span class="token operator">=</span> startSignal<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>doneSignal <span class="token operator">=</span> doneSignal<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                startSignal<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">doWork</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                doneSignal<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// return;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" WorkerRunnable "</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Driver2</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">CountDownLatch</span> doneSignal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ExecutorService</span> e <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// create and start threads  è®©æ‰€æœ‰çš„çº¿ç¨‹ç»§ç»­</span>
                e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WorkerRunnable</span><span class="token punctuation">(</span>doneSignal<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            doneSignal<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// wait for all to finish  ç­‰ä¸€åˆ‡éƒ½ç»“æŸ</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"wait for all to finish"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WorkerRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token class-name">WorkerRunnable</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>doneSignal <span class="token operator">=</span> doneSignal<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">doWork</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            doneSignal<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" WorkerRunnable "</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"InterruptedException"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        try &#123;</span>
<span class="token comment">//            new Driver2().main();</span>
<span class="token comment">//        &#125;catch (InterruptedException e)&#123;</span>
<span class="token comment">//            System.out.println("InterruptedException");</span>
<span class="token comment">//            e.printStackTrace();</span>
<span class="token comment">//        &#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="æŠ½è±¡é˜Ÿåˆ—åŒ–åŒæ­¥å™¨AbstractQueuedSynchronizer"><a href="#æŠ½è±¡é˜Ÿåˆ—åŒ–åŒæ­¥å™¨AbstractQueuedSynchronizer" class="headerlink" title="æŠ½è±¡é˜Ÿåˆ—åŒ–åŒæ­¥å™¨AbstractQueuedSynchronizer"></a>æŠ½è±¡é˜Ÿåˆ—åŒ–åŒæ­¥å™¨AbstractQueuedSynchronizer</h3><p>â€‹        <code>AbstractQueuedSynchronizer</code> æ˜¯<code>java.util.concurrent</code> çš„<strong>æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€</strong>,å®ƒæä¾›äº†ä¸€ä¸ªåŸºäº<code>FIFO</code>é˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–ç›¸å…³åŒæ­¥è£…ç½®çš„åŸºç¡€æ¡†æ¶ã€‚<strong>è¯¥ç±»åˆ©ç”¨äº†ä¸€ä¸ªintæ¥è¡¨ç¤ºçŠ¶æ€ï¼ŒæœŸæœ›å®ƒèƒ½å¤Ÿæˆä¸ºå®ç°å¤§éƒ¨åˆ†åŒæ­¥éœ€æ±‚çš„åŸºç¡€</strong>ã€‚<strong>ä½¿ç”¨çš„æ–¹æ³•æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨å¹¶éœ€è¦å®ç°å®ƒçš„æ–¹æ³•æ¥ç®¡ç†å…¶çŠ¶æ€ï¼Œç®¡ç†çš„æ–¹å¼å°±æ˜¯é€šè¿‡ç±»ä¼¼acquireå’Œ releaseçš„æ–¹å¼æ¥æ“çºµçŠ¶æ€ã€‚</strong>ç„¶è€Œï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯¹çŠ¶æ€çš„æ“çºµå¿…é¡»ç¡®ä¿åŸå­æ€§ï¼Œå› æ­¤å­ç±»å¯¹äºçŠ¶æ€çš„æŠŠæ¡,éœ€è¦ä½¿ç”¨è¿™ä¸ªåŒæ­¥å™¨æä¾›çš„ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•å¯¹çŠ¶æ€è¿›è¡Œæ“ä½œï¼š</p>
<ul>
<li><code>AbstractQueuedSynchronizer.getState()</code></li>
<li><code>AbstractQueuedSynchronizer.setState()</code></li>
<li><code>AbstractQueuedSynchronizer.compareAndSetState()</code></li>
</ul>
<p>â€‹        å­ç±»æ¨èè¢«å®šä¹‰ä¸ºè‡ªå®šä¹‰åŒæ­¥è£…ç½®çš„å†…éƒ¨ç±»ï¼Œå°±åƒ<code>CountDownLatch</code>é‡Œé¢ä¸€æ ·ï¼ŒåŒæ­¥å™¨è‡ªèº«æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œå®ƒä»…ä»…æ˜¯ä¸ºå®šä¹‰äº†è‹¥å¹²<code>acquire</code> (è¯‘æ–‡ï¼šè·å–)ä¹‹ç±»çš„æ–¹æ³•æä¾›ä½¿ç”¨ã€‚<strong>è¯¥åŒæ­¥å™¨æ—¢å¯ä»¥ä½œä¸ºæ’ä»–æ¨¡å¼ä¹Ÿå¯ä»¥ä½œä¸ºå…±äº«æ¨¡å¼</strong>ã€‚å½“å®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªæ’ä»–æ¨¡å¼æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯¹å®ƒçš„è·å–å°±è¢«é˜»æ­¢ï¼Œè€Œå…±äº«æ¨¡å¼å¯¹äºå¤šä¸ªçº¿ç¨‹è·å–éƒ½å¯ä»¥æˆåŠŸã€‚<br>â€‹        <code>AbstractQueuedSynchronizer</code> <strong>æä¾›äº†ä¸¤ç§æœºåˆ¶ï¼šæ’ä»–æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ä¸¤ç§æ¨¡å¼å…±å­˜</strong>ã€‚<strong>å¤„äºæ’ä»–æ¨¡å¼æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è¯•å›¾è·å–è¯¥é”å°†æ— æ³•å–å¾—æˆåŠŸã€‚åœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹è·å–æŸä¸ªé”å¯èƒ½ï¼ˆä½†ä¸æ˜¯ä¸€å®š)ä¼šè·å¾—æˆåŠŸã€‚</strong>æ­¤ç±»å¹¶ä¸â€œäº†è§£â€è¿™äº›ä¸åŒï¼Œé™¤äº†æœºæ¢°åœ°æ„è¯†åˆ°å½“åœ¨å…±äº«æ¨¡å¼ä¸‹æˆåŠŸè·å–æŸä¸€é”æ—¶ï¼Œä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹(å¦‚æœå­˜åœ¨ï¼‰ä¹Ÿå¿…é¡»ç¡®å®šè‡ªå·±æ˜¯å¦å¯ä»¥æˆåŠŸè·å–è¯¥é”ã€‚å¤„äºä¸åŒæ¨¡å¼ä¸‹çš„ç­‰å¾…çº¿ç¨‹å¯ä»¥å…±äº«ç›¸åŒçš„<code>FIFO</code> é˜Ÿåˆ—ã€‚é€šå¸¸ï¼Œå®ç°å­ç±»åªæ”¯æŒå…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œä½†ä¸¤ç§æ¨¡å¼éƒ½å¯ä»¥åœ¨(ä¾‹å¦‚)<code>ReadWriteLock</code>ä¸­å‘æŒ¥ä½œç”¨ã€‚<strong>åªæ”¯æŒæ’ä»–æ¨¡å¼æˆ–è€…åªæ”¯æŒå…±äº«æ¨¡å¼çš„å­ç±»ä¸å¿…å®šä¹‰æ”¯æŒæœªä½¿ç”¨æ¨¡å¼çš„æ–¹æ³•</strong>ã€‚<br>â€‹        æ­¤ç±»é€šè¿‡æ”¯æŒæ’ä»–æ¨¡å¼çš„å­ç±»å®šä¹‰äº†ä¸€ä¸ªåµŒå¥—çš„<code>AbstractQueuedSynchronizer.ConditionObject</code>ç±»ï¼Œå¯ä»¥å°†è¿™ä¸ªç±»ç”¨ä½œ<code>Condition</code>å®ç°ã€‚<code>isHeldExclusively()</code>æ–¹æ³•å°†æŠ¥å‘ŠåŒæ­¥å¯¹äºå½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯æ’ä»–çš„ï¼›ä½¿ç”¨å½“å‰<code>getState()</code>å€¼è°ƒç”¨<code>release(int)</code>æ–¹æ³•åˆ™å¯ä»¥å®Œå…¨é‡Šæ”¾æ­¤å¯¹è±¡ï¼›å¦‚æœç»™å®šä¿å­˜çš„çŠ¶æ€å€¼ï¼Œé‚£ä¹ˆ<code>acquire(int)</code>æ–¹æ³•å¯ä»¥å°†æ­¤å¯¹è±¡æœ€ç»ˆæ¢å¤ä¸ºå®ƒä»¥å‰è·å–çš„çŠ¶æ€ã€‚æ²¡æœ‰åˆ«çš„<code>AbstractQueuedSynchronizer</code>æ–¹æ³•åˆ›å»ºè¿™æ ·çš„æ¡ä»¶ï¼Œå› æ­¤ï¼Œå¦‚æœæ— æ³•æ»¡è¶³æ­¤çº¦æŸï¼Œåˆ™ä¸è¦ä½¿ç”¨å®ƒã€‚<code>AbstractQueuedSynchronizer.ConditionObject</code> çš„è¡Œä¸ºå½“ç„¶å–å†³äºå…¶åŒæ­¥å™¨å®ç°çš„è¯­ä¹‰ã€‚<br>â€‹        æ­¤ç±»ä¸ºå†…éƒ¨é˜Ÿåˆ—æä¾›äº†æ£€æŸ¥ã€æ£€æµ‹å’Œç›‘è§†æ–¹æ³•ï¼Œè¿˜ä¸º <code>condition</code>å¯¹è±¡æä¾›äº†ç±»ä¼¼æ–¹æ³•ã€‚å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨ï¼Œå¯ä»¥ä½¿å…¶åœ¨åŒæ­¥æœºåˆ¶çš„<code>AbstractQueuedSynchronizer</code> çš„å­ç±»ä¸­å¼•ç”¨è¿™äº›æ–¹æ³•ã€‚æ­¤ç±»çš„åºåˆ—åŒ–åªå­˜å‚¨ç»´æŠ¤çŠ¶æ€çš„åŸºç¡€åŸå­æ•´æ•°ï¼Œå› æ­¤å·²åºåˆ—åŒ–çš„å¯¹è±¡æ‹¥æœ‰ç©ºçš„çº¿ç¨‹é˜Ÿåˆ—ã€‚éœ€è¦å¯åºåˆ—åŒ–çš„å…¸å‹å­ç±»å°†å®šä¹‰ä¸€ä¸ª<code>readObject</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ååºåˆ—åŒ–æ—¶å°†æ­¤å¯¹è±¡æ¢å¤åˆ°æŸä¸ªå·²çŸ¥åˆå§‹çŠ¶æ€ã€‚<br>â€‹        æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ï¼š</p>
<p>â€‹        å®šä¹‰ä¸€ä¸ªå­ç±»å¯ä»¥é€‚å½“åœ°é‡æ–°å®šä¹‰ <code>tryAcquire(int)</code>è¯•å›¾åœ¨æ’ä»–æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œ<code>tryRelease(int)</code>è¯•å›¾è®¾ç½®çŠ¶æ€æ¥åæ˜ æ’ä»–æ¨¡å¼ä¸‹çš„ä¸€ä¸ªé‡Šæ”¾ï¼Œ<code>tryAcquireShared(int)</code>è¯•å›¾åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œ<code>tryReleaseShared(int)</code>è¯•å›¾è®¾ç½®çŠ¶æ€æ¥åæ˜ å…±äº«æ¨¡å¼ä¸‹çš„ä¸€ä¸ªé‡Šæ”¾ï¼Œ<code>isHeldExclusively()</code>è¡¨ç¤ºå¦‚æœå¯¹äºå½“å‰(æ­£è°ƒç”¨çš„)çº¿ç¨‹ï¼ŒåŒæ­¥æ˜¯ä»¥æ’ä»–æ–¹å¼è¿›è¡Œçš„ï¼Œåˆ™è¿”å› <code>true</code>,ç­‰ç­‰è¿™äº›æ–¹æ³•ã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨ <code>getState()</code>ã€<code>setState(int) </code> å’Œ&#x2F;æˆ– <code>compareAndSetState(int, int)</code>æ–¹æ³•æ¥æ£€æŸ¥ å’Œ&#x2F;æˆ– ä¿®æ”¹åŒæ­¥çŠ¶æ€æ¥å®ç°çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º <code>UnsupportedOperationException</code>(<strong>ä¸æ”¯æŒæ“ä½œå¼‚å¸¸</strong>)ã€‚è¿™äº›æ–¹æ³•çš„å®ç°<strong>åœ¨å†…éƒ¨å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼Œé€šå¸¸åº”è¯¥å¾ˆçŸ­å¹¶ä¸”ä¸è¢«é˜»å¡ã€‚<strong>å®šä¹‰è¿™äº›æ–¹æ³•æ˜¯ä½¿ç”¨æ­¤ç±»çš„å”¯ä¸€å—æ”¯æŒçš„æ–¹å¼ã€‚</strong>å…¶ä»–æ‰€æœ‰æ–¹æ³•éƒ½è¢«å£°æ˜ä¸º <code>final</code>ï¼Œå› ä¸ºå®ƒä»¬æ— æ³•æ˜¯å„ä¸ç›¸åŒçš„ã€‚<code>AbstractQueuedSynchronizer</code> å†…ç½®ä¸€ä¸ª <code>state</code> å­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºæŸç§æ„ä¹‰â€”â€”å½“<code>ReentrantLock</code>ä½¿ç”¨<code>AQS</code>çš„æ—¶å€™ï¼Œ<code>state</code> è¢«ç”¨æ¥è¡¨ç¤ºé”è¢«é‡å…¥çš„æ¬¡æ•°ï¼›å½“<code>Semaphore</code>ä½¿ç”¨<code>AQS</code>çš„æ—¶å€™ï¼Œ<code>state</code> åˆ™è¢«ç”¨æ¥è¡¨ç¤ºå½“å‰è¿˜æœ‰å¤šå°‘ä¿¡å·é‡å¯è¢«è·å–ã€‚<code>AbstractQueuedSynchronizer</code> æ”¯æŒçš„ä¸¤ç§æ¨¡å¼ï¼šæ’ä»–å¼å’Œå…±äº«å¼ï¼Œä¸¤è€…è¿›è¡Œè·å–å’Œé‡Šæ”¾åŠ¨ä½œçš„æ€è·¯éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚<br>â€‹        è·å–åŒæ­¥å™¨çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>å°è¯•è·å–æˆåŠŸ<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span>ã€‚
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
	åŠ å…¥ç­‰å¾…é˜Ÿåˆ—<span class="token punctuation">;</span> parkè‡ªå·±
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é‡Šæ”¾åŒæ­¥å™¨çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>å°è¯•é‡Šæ”¾æˆåŠŸ<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	unparkç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å¯¹æ¦‚å¿µæœ‰äº†åŸºæœ¬çš„ç†è§£ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®˜æ–¹çš„<strong>demo</strong>ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰é”äº†ã€‚å¦‚ä¸‹ï¼š</p>
<h4 id="No2-MutexDemo-java"><a href="#No2-MutexDemo-java" class="headerlink" title="No2_MutexDemo.java"></a>No2_MutexDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span><span class="token punctuation">;</span>

<span class="token comment">/**
 è¿™é‡Œæœ‰ä¸€ä¸ªä¸å¯é‡å…¥çš„äº’æ–¥é”ç±»ï¼Œå®ƒä½¿ç”¨å€¼0è¡¨ç¤ºæœªè§£é”çŠ¶æ€ï¼Œ1è¡¨ç¤ºé”å®šçŠ¶æ€ã€‚
 è™½ç„¶ä¸å¯é‡å…¥é”å¹¶ä¸ä¸¥æ ¼è¦æ±‚è®°å½•å½“å‰æ‰€æœ‰è€…çº¿ç¨‹ï¼Œä½†è¿™ä¸ªç±»æ— è®ºå¦‚ä½•éƒ½è¦è¿™æ ·åšï¼Œä»¥ä½¿ä½¿ç”¨æ›´å®¹æ˜“ç›‘æ§ã€‚
 å®ƒè¿˜æ”¯æŒæ¡ä»¶ï¼Œå¹¶å…¬å¼€äº†ä¸€ç§æµ‹é‡æ–¹æ³•:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_MutexDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// Our internal helper class å†…éƒ¨ç±»ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Reports whether in locked state æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Acquires the lock if state is zero å½“çŠ¶æ€ä¸º0çš„æ—¶å€™è·å–é”</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">assert</span> acquires <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Otherwise unused å¦åˆ™æœªä½¿ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Releases the lock by setting state to zero é‡Šæ”¾é”ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸º0</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">assert</span> releases <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Otherwise unused å¦åˆ™æœªä½¿ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Provides a Condition  è¿”å›ä¸€ä¸ªConditionï¼Œæ¯ä¸ªconditionéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—</span>
        <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConditionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

        <span class="token comment">// Deserializes properly ååºåˆ—åŒ–æ­£ç¡®</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> s<span class="token punctuation">)</span>
                <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            s<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset to unlocked state é‡ç½®ä¸ºè§£é”çŠ¶æ€</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// The sync object does all the hard work. We just forward to it.</span>
    <span class="token comment">//åˆ©ç”¨å†…éƒ¨ç±»ï¼Œå£°æ˜ä¸€ä¸ªAbstractQueuedSynchronizerå­ç±»ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨å†…éƒ¨ç±»é‡Œé¢ä½¿ç”¨çš„</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span> sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">&#123;</span> sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">hasQueuedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        </p>
<h4 id="No2-BooleanLatchDemo-java"><a href="#No2-BooleanLatchDemo-java" class="headerlink" title="No2_BooleanLatchDemo.java"></a>No2_BooleanLatchDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">;</span>

<span class="token comment">/**
è¿™é‡Œæœ‰ä¸€ä¸ªé”å­˜ç±»ï¼Œå®ƒç±»ä¼¼äºCountDownLatchï¼Œåªä¸è¿‡å®ƒåªéœ€è¦ä¸€ä¸ªä¿¡å·æ¥è§¦å‘ã€‚å› ä¸ºé—¨é—©æ˜¯éç‹¬å çš„ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨å…±äº«çš„è·å–å’Œé‡Šæ”¾æ–¹æ³•ã€‚
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_BooleanLatchDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">&#123;</span> sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æœ€åï¼Œ<code>AbstractQueuedSynchronizer</code>å­ç±»ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨å†…éƒ¨ç±»é‡Œé¢ä½¿ç”¨çš„ï¼Œä¸åŒçš„åŒæ­¥æœºåˆ¶å’Œé˜»å¡æœºåˆ¶ï¼Œé‡Šæ”¾é”å’ŒåŠ é”çš„é€»è¾‘å¯èƒ½éƒ½ä¸ä¸€æ ·ï¼Œ<code>AbstractQueuedSynchronizer</code> åªæ˜¯æä¾›äº†ä¸€ç§åŸºäº<code>FIFO</code> é˜Ÿåˆ—çš„ã€å¯ä»¥ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–ç›¸å…³åŒæ­¥è£…ç½®çš„åŸºç¡€æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆä¸Šé¢çš„<code>CountDownLatch</code>å’Œä¸‹ä¸€èŠ‚å°†è¦è®²è¿°çš„<code>Semaphore</code>å†åšä¸€ä¸‹ç†è§£ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractOwnableSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="åŒæ­¥è®¡æ•°å™¨Semaphore"><a href="#åŒæ­¥è®¡æ•°å™¨Semaphore" class="headerlink" title="åŒæ­¥è®¡æ•°å™¨Semaphore"></a>åŒæ­¥è®¡æ•°å™¨Semaphore</h3><p>â€‹        <code>Semaphore</code>æ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œä¿¡å·é‡ç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†åˆã€‚å¦‚æœ‰å¿…è¦ï¼Œåœ¨è®¸å¯å¯ç”¨å‰ä¼šé˜»å¡æ¯ä¸€ä¸ª <code>acquire()</code>ï¼Œç„¶åå†è·å–è¯¥è®¸å¯ã€‚æ¯ä¸ª <code>release()</code>æ·»åŠ ä¸€ä¸ªè®¸å¯ï¼Œä»è€Œå¯èƒ½é‡Šæ”¾ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„è·å–è€…ã€‚å°±åƒæ’é˜Ÿè¿›å…¥ä¸Šæµ·åšç‰©é¦†ä¸€æ ·ï¼Œå…ˆæ”¾å‡ ä¸ªäººè¿›å»ï¼Œç­‰è¿™å‡ ä¸ªäººèµ°äº†ï¼Œç„¶åå†æ”¾å‡ ä¸ªäººè¿›å…¥,å°±åƒæ˜¯ä¸€ç§æ’é˜Ÿæœºåˆ¶ã€‚</p>
<p>â€‹        <code>Semaphore</code> ä¸»è¦çš„ã€å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š</p>
<ol>
<li><code>Semaphore(int permits)</code>ï¼Œåˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œç»™å®šçš„éå…¬å¹³çš„å…¬å¹³è®¾ç½®çš„<br>Semaphoreæ•°é‡ã€‚</li>
<li><code>Semaphore(int permits, boolean fair)</code>ï¼Œåˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œç»™å®šçš„å…¬å¹³è®¾ç½®çš„Semaphoreæ•°é‡ã€‚<br>æ‰€è°“å…¬å¹³æ€§å°±æ˜¯æ˜¯å¦å…ˆè¿›æ¥çš„å…ˆé‡Šæ”¾ï¼Œé»˜è®¤æ˜¯å¦çš„ã€‚</li>
<li><code>void acquire()</code>ï¼Œä»æ­¤ä¿¡å·é‡è·å–ä¸€ä¸ªè®¸å¯ï¼Œåœ¨æä¾›ä¸€ä¸ªè®¸å¯å‰ä¸€ ç›´å°†çº¿ç¨‹é˜³å¡ï¼Œå¦åˆ™çº¿ç¨‹è¢«ä¸­æ–­ã€‚</li>
<li><code>int availablePermits()</code>ï¼Œè¿”å›æ­¤ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯æ•°ã€‚</li>
<li><code>int drainPermits()</code>ï¼Œè·å–å¹¶è¿”å›ç«‹å³å¯ç”¨çš„æ‰€æœ‰è®¸å¯ã€‚</li>
<li><code>int getQueueLength()</code>ï¼Œ è¿”å›æ­£åœ¨ç­‰å¾…è·å–çš„çº¿ç¨‹çš„ä¼°è®¡æ•°ç›®ã€‚</li>
<li><code>boolean hasQueuedThreads()</code>ï¼Œ æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–ã€‚</li>
<li><code>boolean isFair()</code>ï¼Œå¦‚æœæ­¤ä¿¡å·é‡çš„å…¬å¹³è®¾ç½®ä¸ºtrue, åˆ™è¿”å›trueã€‚</li>
<li><code>void reducePermits(int reductions)</code>ï¼Œæ ¹æ®æŒ‡å®šçš„ç¼©å‡é‡å‡å°å¯ç”¨è®¸å¯çš„æ•°ç›®ã€‚</li>
<li><code>void release()</code>ï¼Œé‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œå°†å…¶è¿”å›ç»™ä¿¡å·é‡ã€‚</li>
<li><code>void release(int permits)</code>ï¼Œé‡Šæ”¾ç»™å®šæ•°ç›®çš„è®¸å¯ï¼Œå°†å…¶è¿”å›åˆ°ä¿¡å·é‡ã€‚</li>
<li><code>boolean tryAcquire()</code>ï¼Œä»…åœ¨è°ƒç”¨æ—¶æ­¤ä¿¡å·é‡å­˜åœ¨ä¸€ä¸ªå¯ç”¨è®¸å¯ï¼Œæ‰ä»ä¿¡å·é‡è·å–è®¸å¯ã€‚</li>
</ol>
<p>â€‹        ä½¿ç”¨åœºæ™¯ï¼š<br>â€‹        æ’é˜Ÿåœºæ™¯ï¼Œèµ„æºæœ‰é™çš„æˆ¿é—´ï¼Œèµ„æºæœ‰é™çš„ç¾¤ç­‰ç­‰ã€‚å¸¸è§çš„å®é™…åº”ç”¨åœºæ™¯åŒ…æ‹¬çº¿ç¨‹æ± ã€è¿æ¥æ± ç­‰ã€‚<br>â€‹        å®ä¾‹:<br>â€‹        å‡è®¾ä¸€ä¸ªæœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œåªå…è®¸åŒæ—¶3ä¸ªäººè¿›è¡Œè®¿é—®ï¼Œä¸€å…±æ¥äº†10ä¸ªäººçš„åœºæ™¯ã€‚</p>
<h4 id="No3-SemaphoreDemo-java"><a href="#No3-SemaphoreDemo-java" class="headerlink" title="No3_SemaphoreDemo.java"></a>No3_SemaphoreDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_SemaphoreDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸€æ¬¡åªè¿è¡Œ3ä¸ªäººè¿›è¡Œè®¿é—®</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> no <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token class-name">Runnable</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·"</span> <span class="token operator">+</span> no <span class="token operator">+</span> <span class="token string">"è¿æ¥ä¸Šäº†:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–æ¥ä¸‹å»æ‰§è¡Œçš„è®¸å¯</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·"</span> <span class="token operator">+</span> no <span class="token operator">+</span> <span class="token string">"å¼€å§‹è®¿é—®åå°ç¨‹åº..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡ä»¿ç”¨æˆ·è®¿é—®æœåŠ¡è¿‡ç¨‹</span>
                        semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡Šæ”¾å…è®¸ä¸‹ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¿›å…¥åå°</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·"</span> <span class="token operator">+</span> no <span class="token operator">+</span> <span class="token string">"è®¿é—®ç»“æŸã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Main thread end!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="åŒæ­¥è®¡æ•°å™¨CyclicBarrier"><a href="#åŒæ­¥è®¡æ•°å™¨CyclicBarrier" class="headerlink" title="åŒæ­¥è®¡æ•°å™¨CyclicBarrier"></a>åŒæ­¥è®¡æ•°å™¨CyclicBarrier</h3><p>â€‹        <code>CyclicBarrier</code> æ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œç¿»è¯‘è¿‡æ¥å«å¾ªç¯æ …æ ã€å¾ªç¯å±éšœã€‚å®ƒå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹<code>(common barrier point</code>)ï¼Œç„¶åæ‰€æœ‰çš„è¿™ç»„çº¿ç¨‹å†åŒæ­¥å¾€åé¢æ‰§è¡Œã€‚åœ¨æ¶‰åŠä¸€ç»„å›ºå®šå¤§å°çš„çº¿ç¨‹çš„ç¨‹åºä¸­ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»ä¸æ—¶åœ°äº’ç›¸ç­‰å¾…ï¼Œæ­¤æ—¶CyclicBarrier å¾ˆæœ‰ç”¨ã€‚ä¸è¦é”™è¯¯ç†è§£äº†ï¼Œä¸æ˜¯çº¿ç¨‹å±éšœå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œè€Œæ˜¯å¤šä¸ªçº¿ç¨‹éƒ½åƒå¤šä¸ªå¾ªç¯ä¸€æ ·ï¼Œéƒ½å¾ªç¯åˆ°è¿™ä¸ªç‚¹äº†ï¼Œå†ä¸€èµ·å¼€å§‹å¾€åé¢æ‰§è¡Œã€‚<br>â€‹        ä¸»è¦çš„æ–¹æ³•æœ‰:</p>
<ol>
<li><code>CyclicBarrier(int parties)</code>ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>CyclicBarrier</code>ï¼Œå®ƒå°†åœ¨ç»™å®šæ•°é‡çš„å‚ä¸è€…(çº¿ç¨‹)å¤„äºç­‰å¾…çŠ¶æ€æ—¶å¯åŠ¨ï¼Œä½†å®ƒä¸ä¼šåœ¨å¯åŠ¨<code>barrier</code> æ—¶æ‰§è¡Œé¢„å®šä¹‰çš„æ“ä½œã€‚</li>
<li><code>CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„<code>CyclicBarrier</code>ï¼Œå®ƒå°†åœ¨ç»™å®šæ•°é‡çš„å‚ä¸è€…(çº¿ç¨‹)å¤„äºç­‰å¾…çŠ¶æ€æ—¶å¯åŠ¨ï¼Œå¹¶åœ¨å¯åŠ¨<code>barrier</code> æ—¶æ‰§è¡Œç»™å®šçš„å±éšœæ“ä½œï¼Œè¯¥æ“ä½œç”±æœ€åä¸€ä¸ªè¿›å…¥<code>barrier</code> çš„çº¿ç¨‹æ‰§è¡Œã€‚</li>
<li><code>int await()</code>ï¼Œåœ¨æ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»åœ¨æ­¤<code>barrier</code> ä¸Šè°ƒç”¨<code>await</code> æ–¹æ³•ä¹‹å‰ï¼Œå°†ä¸€ç›´ç­‰å¾…ã€‚</li>
<li><code>int await(long timeout, TimeUnit unit)</code>ï¼Œåœ¨æ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»åœ¨æ­¤å±éšœä¸Šè°ƒç”¨<code>await</code> æ–¹æ³•ä¹‹å‰å°†ä¸€ç›´ç­‰å¾…ï¼Œ æˆ–è€…è¶…å‡ºäº†æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ã€‚</li>
<li><code>int getNumberWaiting()</code>ï¼Œè¿”å›å½“å‰åœ¨å±éšœå¤„ç­‰å¾…çš„å‚ä¸è€…æ•°ç›®ã€‚</li>
<li><code>int getParties()</code>ï¼Œè¿”å›è¦æ±‚å¯åŠ¨æ­¤<code>barrier</code>çš„å‚ä¸è€…æ•°ç›®ã€‚</li>
<li><code>boolean isBroken()</code>ï¼ŒæŸ¥è¯¢æ­¤å±éšœæ˜¯å¦å¤„äºæŸåçŠ¶æ€ã€‚</li>
<li><code>void reset()</code>ï¼Œå°†å±éšœé‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ã€‚</li>
</ol>
<p>â€‹     ä½¿ç”¨åœºæ™¯:<br>â€‹    å¤§æ•°æ®è¿ç®—éœ€è¦æ‹†åˆ†æˆå¤šæ­¥éª¤çš„æ—¶å€™ã€‚æ¯”å¦‚è¿™ä¹ˆä¸€ä¸ªå®é™…åº”ç”¨åœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦ç»Ÿè®¡å…¨å›½çš„ä¸šåŠ¡æ•°æ®ï¼Œå…¶ä¸­å„çœçš„æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‰çœåˆ†åº“ï¼Œå¹¶ä¸”ç»Ÿè®¡çš„æ•°æ®é‡å¾ˆå¤§ï¼Œç»Ÿè®¡è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒæ…¢ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå¿«é€Ÿè®¡ç®—ï¼Œæˆ‘ä»¬é‡‡å–å¹¶å‘çš„æ–¹å¼ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¡ç®—å„çœæ•°æ®ï¼Œæ¯ä¸ªçœä¸‹é¢åˆç”¨å¤šçº¿ç¨‹ï¼Œæœ€åå†æ±‡æ€»ç»Ÿè®¡ã€‚</p>
<p>â€‹    å®ä¾‹ï¼š</p>
<h4 id="No4-CyclicBarrierDemo-java"><a href="#No4-CyclicBarrierDemo-java" class="headerlink" title="No4_CyclicBarrierDemo.java"></a>No4_CyclicBarrierDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>semaphore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BrokenBarrierException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CyclicBarrier</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_CyclicBarrierDemo</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">CyclicBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TotalTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BillTask</span> worker1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillTask</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">,</span>barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BillTask</span> worker2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillTask</span><span class="token punctuation">(</span><span class="token string">"222"</span><span class="token punctuation">,</span>barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BillTask</span> worker3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillTask</span><span class="token punctuation">(</span><span class="token string">"333"</span><span class="token punctuation">,</span>barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Main thread end!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TotalTask</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ‰€æœ‰å­ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œå°±å¼€å§‹æ‰§è¡Œä¸»ä»»åŠ¡äº†ã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BillTask</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> billName<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">CyclicBarrier</span> barrier<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">BillTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> workerName<span class="token punctuation">,</span><span class="token class-name">CyclicBarrier</span> barrier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>billName <span class="token operator">=</span> workerName<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>barrier <span class="token operator">=</span> barrier<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¸‚åŒº:"</span><span class="token operator">+</span>billName <span class="token operator">+</span><span class="token string">"è¿ç®—å¼€å§‹ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡ä»¿ç¬¬ä¸€æ¬¡è¿ç®—ï¼›</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¸‚åŒº:"</span><span class="token operator">+</span>billName <span class="token operator">+</span><span class="token string">"è¿ç®—å®Œæˆï¼Œç­‰å¾…ä¸­..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å‡è®¾ä¸€æ¬¡è¿ç®—ä¸å®Œï¼Œç¬¬äºŒæ¬¡è¦ä¾èµ–ç¬¬ä¸€æ¬¡çš„è¿ç®—ç»“æœã€‚éƒ½åˆ°è¾¾è¿™ä¸ªèŠ‚ç‚¹ä¹‹ååé¢æ‰ä¼šç»§ç»­æ‰§è¡Œï¼›</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å…¨éƒ¨éƒ½ç»“æŸï¼Œå¸‚åŒº"</span><span class="token operator">+</span>billName <span class="token operator">+</span><span class="token string">"æ‰å¼€å§‹åé¢çš„å·¥ä½œã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>â€‹        ä»è¿è¡Œç»“æœä¸Šé¢ä»”ç»†ä½“ä¼šä¸CountDownLatchçš„åŒºåˆ«ã€‚</p>
<p>â€‹        â—CountDownLatchï¼šä¸€ä¸ªçº¿ç¨‹(æˆ–è€…å¤šä¸ª)ï¼Œç­‰å¾…å¦å¤–N ä¸ªçº¿ç¨‹å®ŒæˆæŸä¸ªäº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œã€‚</p>
<p>â€‹		â—CyclicBarrierï¼šNä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¹‹å‰ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚<br>â€‹        è¿™æ ·æ¯”å¯¹ä¸€ä¸‹åº”è¯¥å°±æ¸…æ¥šäº†ï¼Œ å¯¹äºCountDownlachæ¥è¯´ï¼Œé‡ç‚¹æ˜¯é‚£ä¸ªâ€œä¸€ä¸ªçº¿ç¨‹â€ï¼Œæ˜¯å®ƒåœ¨ç­‰å¾…è€Œå¦å¤–é‚£Nçš„çº¿ç¨‹åœ¨æŠŠâ€œæŸä¸ªäº‹æƒ…â€åšå®Œä¹‹åå¯ä»¥ç»§ç»­ç­‰å¾…ï¼Œå¯ä»¥ç»ˆæ­¢ï¼›è€Œå¯¹äº<code>CyclicBarrier</code>æ¥è¯´ï¼Œé‡ç‚¹æ˜¯é‚£Nä¸ªçº¿ç¨‹ï¼Œå®ƒä»¬ä¹‹é—´ä»»ä½•ä¸€ä¸ªæ²¡æœ‰å®Œæˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚</p>
<p>â€‹        <code>CyclicBarrier</code>çš„å®ç°åŸç†æ˜¯ï¼Œåˆ©ç”¨<code>ReentrantIock</code>åšçº¿ç¨‹å®‰å…¨é”ï¼Œå®ç°çº¿ç¨‹å®‰å…¨ç­‰å¾…ã€‚<br>æ¥çœ‹ä¸€ä¸‹<strong>CyclicBarrier</strong>çš„æºç ä½“ä¼šä¸‹ã€‚</p>
<p>â€‹        æ€»ä¹‹ï¼Œè¿™ä¸€ç« é‡ç‚¹è®²è§£äº†çº¿ç¨‹çš„é˜Ÿåˆ—æœºåˆ¶å’Œçº¿ç¨‹äº¤äº’ç­‰å¾…æœºåˆ¶ï¼Œä¸¾ä¾‹è¯´æ˜äº†æˆ‘ä»¬å¹³æ—¶å·¥ä½œä¸­å¸¸ç”¨çš„ä¸€äº›ç±»ã€‚ ä½œè€…è®²è§£çš„å†…å®¹èµ·åˆ°æŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œç»™è¯»è€…ä¸€ç§åˆ†æé—®é¢˜çš„æ€è·¯å’Œæ–¹æ³•ï¼Œ å¸Œæœ›æˆ‘ä»¬å·¥ä½œä¸­æ³¨æ„è§‚å¯Ÿå’Œåˆ†æï¼Œå¯ä»¥ä½“ä¼šåˆ°å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„è§„å¾‹ï¼Œä¸‡å˜ä¸ç¦»å…¶å®—ï¼ŒæŒæ¡å¥½åŸºç¡€ï¼Œé“ç†éƒ½æ˜¯ç›¸é€šçš„ã€‚</p>
<h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><blockquote>
<p> <strong>éªéª¥ä¸€è·ƒï¼Œä¸èƒ½åæ­¥ï¼›é©½é©¬åé©¾ï¼ŒåŠŸåœ¨ä¸èˆã€‚</strong></p>
</blockquote>
<p><img src="/image/Concurrent/Concurrent18.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent18.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        çº¿ç¨‹æ± ï¼Œç‰¹åˆ«æ˜¯é«˜å¹¶å‘é¡¹ç›®ï¼Œäº’è”ç½‘é¡¹ç›®å¿…é¡»ä¼šç”¨çš„ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± "><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± " class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± "></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± </h3><p>â€‹        åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œåˆ›å»ºå’Œé”€æ¯å¯¹è±¡æ˜¯å¾ˆè´¹æ—¶é—´çš„ï¼Œå› ä¸ºåˆ›å»ºä¸€ä¸ªå¯¹è±¡è¦è·å–å†…å­˜èµ„æºæˆ–è€…å…¶ä»–æ›´å¤šèµ„æºã€‚åœ¨Javaä¸­æ›´æ˜¯å¦‚æ­¤ï¼Œè™šæ‹Ÿæœºå°†è¯•å›¾è·Ÿè¸ªæ¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨å¯¹è±¡é”€æ¯åè¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥<strong>æé«˜æœåŠ¡ç¨‹åºæ•ˆç‡çš„ä¸€ä¸ªæ‰‹æ®µå°±æ˜¯å°½å¯èƒ½å‡å°‘åˆ›å»ºå’Œé”€æ¯å¯¹è±¡çš„æ¬¡æ•°ï¼Œç‰¹åˆ«æ˜¯-äº›å¾ˆè€—è´¹èµ„æºçš„å¯¹è±¡åˆ›å»ºå’Œé”€æ¯</strong>ã€‚å¦‚ä½•åˆ©ç”¨å·²æœ‰å¯¹è±¡æ¥æœåŠ¡å°±æ˜¯ä¸€ä¸ªéœ€è¦è§£å†³çš„å…³é”®é—®é¢˜ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€äº›â€œæ± åŒ–èµ„æºâ€æŠ€æœ¯äº§ç”Ÿçš„åŸå› ã€‚æ¯”å¦‚å¤§å®¶æ‰€ç†Ÿæ‚‰çš„æ•°æ®åº“è¿æ¥æ± ï¼Œæ­£æ˜¯éµå¾ªè¿™ä¸€æ€æƒ³è€Œäº§ç”Ÿçš„ã€‚<br>â€‹        <strong>Javaçº¿ç¨‹æ± å®ç°äº†ä¸€ä¸ªJavaé«˜å¹¶å‘çš„ã€Javaå¤šçº¿ç¨‹çš„ã€å¯ç®¡ç†çš„ç»Ÿä¸€è°ƒåº¦å™¨</strong>ã€‚åŸç†å’Œå·¥ä½œæœºåˆ¶å…ˆä¸è¯´äº†ï¼Œæˆ‘ä»¬å¯¹å®ƒæœ‰ä¸ªå¤§ä½“çš„è®¤è¯†ï¼Œç¨åå†æ…¢æ…¢å­¦ä¹ ã€‚å…ˆæ¥è®¤è¯†ä¸€ä¸‹<code>java.util.concurrent.Executors</code>å·¥ä½œä¸­æœ€å¸¸ç”¨çš„å’Œç†ŸçŸ¥çš„ã€‚<br>â€‹        <code>Executors</code>æ˜¯ä¸ªçº¿ç¨‹çš„å·¥å‚ç±»ï¼Œæ–¹ä¾¿å¿«é€Ÿåœ°åˆ›å»ºå¾ˆå¤šçº¿ç¨‹æ± ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± çš„å·¥å…·ç±»ã€‚é…ç½®ä¸€ä¸ªçº¿ç¨‹æ± æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå°¤å…¶æ˜¯å¯¹äºçº¿ç¨‹æ± çš„åŸç†ä¸æ˜¯å¾ˆæ¸…æ¥šçš„æƒ…å†µä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½é…ç½®çš„çº¿ç¨‹æ± ä¸æ˜¯æœ€ä¼˜çš„ã€‚å› æ­¤ï¼Œåœ¨<code>Executors</code>ç±»é‡Œé¢æä¾›äº†ä¸€äº›é™æ€å·¥å‚ï¼Œç”Ÿæˆä¸€äº›å¸¸ç”¨çš„çº¿ç¨‹æ± ã€‚</p>
<p>â€‹        å¸¸ç”¨çš„æ–¹æ³•æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ul>
<li><strong><code>newSingleThreadExecutor</code><strong>ï¼š</strong>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± </strong>ã€‚</li>
<li><strong><code>newFixedThreadPool</code><strong>ï¼š</strong>åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± </strong>ã€‚</li>
<li><strong><code>newCachedThreadPool</code><strong>ï¼š</strong>åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± </strong>ã€‚</li>
</ul>
<p>â€‹        æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€è§£æã€‚</p>
<h3 id="newSingleThreadExecutorçš„ä½¿ç”¨"><a href="#newSingleThreadExecutorçš„ä½¿ç”¨" class="headerlink" title="newSingleThreadExecutorçš„ä½¿ç”¨"></a>newSingleThreadExecutorçš„ä½¿ç”¨</h3><p>â€‹        åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è¿™ä¸ªçº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚å¦‚æœè¿™ä¸ªå”¯ä¸€çš„çº¿ç¨‹å› ä¸ºå¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ›¿ä»£å®ƒã€‚æ­¤çº¿ç¨‹æ± ä¿è¯æ‰€æœ‰ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæŒ‰ç…§ä»»åŠ¡çš„æäº¤é¡ºåºæ‰§è¡Œã€‚<br>â€‹        å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­:</p>
<h4 id="No1-NewSingleThreadExecutorDemo-java"><a href="#No1-NewSingleThreadExecutorDemo-java" class="headerlink" title="No1_NewSingleThreadExecutorDemo.java"></a>No1_NewSingleThreadExecutorDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_NewSingleThreadExecutorDemo</span> <span class="token punctuation">&#123;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–¹ä¾¿ç›‘æ§å·¥å…·èƒ½æ•è·åˆ°</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> no <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"into"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span> <span class="token class-name">Main</span> <span class="token class-name">End</span><span class="token operator">!</span>
into0
end0
into1
end1
into2
end2
into3
end3
into4
end4
into5
end5
into6
end6
into7
end7
into8
end8
into9
end9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ç»“æœä¸Šé¢çœ‹æ˜¯ä¸€æ¡ä¸€æ¡åœ°åœ¨æ‰§è¡Œã€‚ä»ç›‘æ§å·¥å…·ä¸Šé¢çœ‹:</p>
<p>(1) <strong>main</strong>çº¿ç¨‹æ—©å°±ç»“æŸäº†ï¼Œè€Œçº¿ç¨‹æ± é‡Œé¢æ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥<strong>10</strong>ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é—´ä¹Ÿæœ€é•¿,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent19.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent19.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>(2ï¼‰çº¿ç¨‹æ•°é‡æ°¸è¿œä¸å˜,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent20.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent20.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>(3ï¼‰ä½¿ç”¨çš„ <strong>dump</strong>å†…å­˜åŸºæœ¬ä¸Šå¤„äºç¨³å®šé˜¶æ®µ,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent21.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent21.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>çœ‹ä¸€ä¸‹**<code>Executors.newSingleThreadExecutor()</code>**çš„å®ç°æ–¹æ³•:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä¸€ä¸ªExecutorï¼Œè¯¥Executorä½¿ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ“ä½œä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>
            <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                    <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢ä»£ç æ ¹æ®<code>ThreadPoolExecutor</code>åˆ›å»ºä¸€ä¸ª <code>LinkedBlockingQueue</code>çš„ä¸€ä¸ªå¤§å°çš„çº¿ç¨‹æ± ï¼Œé‡‡ç”¨é»˜è®¤çš„å¼‚å¸¸ç­–ç•¥ã€‚</p>
<h3 id="newCachedThreadPoolçš„ä½¿ç”¨"><a href="#newCachedThreadPoolçš„ä½¿ç”¨" class="headerlink" title="newCachedThreadPoolçš„ä½¿ç”¨"></a>newCachedThreadPoolçš„ä½¿ç”¨</h3><p>â€‹        åˆ›å»ºä¸€ä¸ªç¼“å­˜æ± å¤§å°å¯æ ¹æ®éœ€è¦ä¼¸ç¼©çš„çº¿ç¨‹æ± ï¼Œä½†æ˜¯åœ¨ä»¥å‰æ„é€ çš„çº¿ç¨‹å¯ç”¨æ—¶å°†é‡ç”¨å®ƒä»¬ã€‚å¯¹äºæ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„ç¨‹åºè€Œè¨€ï¼Œè¿™äº›çº¿ç¨‹æ± é€šå¸¸å¯æé«˜ç¨‹åºæ€§èƒ½ã€‚è°ƒç”¨**<code>execute</code>** å°†é‡ç”¨ä»¥å‰æ„é€ çš„çº¿ç¨‹(å¦‚æœçº¿ç¨‹å¯ç”¨)ã€‚å¦‚æœç°æœ‰çº¿ç¨‹æ²¡æœ‰å¯ç”¨çš„ï¼Œåˆ™åˆ›å»ºä¸€ä¸€ä¸ªæ–°çº¿ç¨‹å¹¶æ·»åŠ åˆ°æ± ä¸­ã€‚ç»ˆæ­¢å¹¶ä»ç¼“å­˜ä¸­ç§»é™¤é‚£äº›å·²æœ‰60sæœªè¢«ä½¿ç”¨çš„çº¿ç¨‹ã€‚å› æ­¤ï¼Œé•¿æ—¶é—´ä¿æŒç©ºé—²çš„çº¿ç¨‹æ± ä¸ä¼šä½¿ç”¨ä»»ä½•èµ„æºã€‚<br>â€‹        å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­:</p>
<h4 id="No2-NewCachedThreadPoolDemo-java"><a href="#No2-NewCachedThreadPoolDemo-java" class="headerlink" title="No2_NewCachedThreadPoolDemo.java"></a>No2_NewCachedThreadPoolDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_NewCachedThreadPoolDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–¹ä¾¿ç›‘æ§å·¥å…·èƒ½æ•è·åˆ°</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> no <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"into"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¾“å‡ºï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">into0
into2
into3
into4
into1
<span class="token class-name">Thread</span> <span class="token class-name">Main</span> <span class="token class-name">End</span><span class="token operator">!</span>
into5
into6
into7
into8
into9
into10
into11
into12
into13
into14
into15
into16
into17
into18
into19
end16
end13
end12
end11
end19
end17
end1
end18
end2
end4
end3
end0
end7
end15
end8
end9
end10
end5
end6
end14<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»ç»“æœä¸Šé¢çœ‹ï¼Œä¸€ä¸‹å­æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¼€å§‹æ‰§è¡Œï¼Œéƒ½åœ¨äº’ç›¸çš„äº‰æŠ¢ CPUèµ„æºã€‚<br>â€‹        ä»ç›‘æ§å·¥å…·ç§å¯ä»¥çœ‹å‡ºæ¥:<br>â€‹        (1) <strong><code>main</code><strong>çº¿ç¨‹ä¸€è®©å‡ºèµ„æºï¼Œ çº¿ç¨‹æ± é‡Œé¢æœ‰</strong>20</strong>ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚è¿™æ—¶å€™æ‰§è¡Œæ—¶é—´ä¹Ÿæœ€çŸ­ï¼Œå¦‚æœCPUå…è®¸æ‰§è¡Œï¼Œä¹Ÿæ˜¯æœ€å¿«çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent22.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent22.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        (2)çº¿ç¨‹æ•°é‡æ€¥å‰§ä¸Šå‡ã€‚çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡æ²¡æœ‰ä¸‹é™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent23.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent23.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        (3)ä½¿ç”¨çš„**<code>dump</code>**å†…å­˜åŸºæœ¬ä¸Šå¤„äºæ€¥å‰§ä¸Šå‡é˜¶æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent24.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent24.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        çœ‹ä¸€ä¸‹**<code>Executors.newCachedThreadPool()</code>**çš„å®ç°:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä½†å°†åœ¨ä»¥å‰æ„é€ çš„çº¿ç¨‹å¯ç”¨æ—¶é‡ç”¨å®ƒä»¬ã€‚   </span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>
                                      <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                                      <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ± ã€‚çº¿ç¨‹ä¸ºé›¶ï¼Œæ¥ä¸€ä¸ªçº¿ç¨‹å°±åœ¨çº¿ç¨‹æ± é‡Œé¢åˆ›å»ºä¸€ä¸ªçš„<br><strong><code>SynchronousQueue</code></strong>.</p>
<p><strong>ç¼ºç‚¹ï¼šä¸€èˆ¬ä¸ç”¨ï¼Œæ˜¯å› ä¸ºnewCachedThreadPool å¯ä»¥æ— é™çš„æ–°å»ºçº¿ç¨‹ï¼Œå®¹æ˜“é€ æˆå †å¤–å†…å­˜æº¢å‡ºï¼Œå› ä¸ºå®ƒçš„æœ€å¤§å€¼æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ä¸º Integer.MAX_VALUEï¼Œä¸€èˆ¬æ¥è¯´æœºå™¨éƒ½æ²¡é‚£ä¹ˆå¤§å†…å­˜ç»™å®ƒä¸æ–­ä½¿ç”¨ã€‚å½“ç„¶çŸ¥é“å¯èƒ½å‡ºé—®é¢˜çš„ç‚¹ï¼Œå°±å¯ä»¥å»é‡å†™ä¸€ä¸ªæ–¹æ³•é™åˆ¶ä¸€ä¸‹è¿™ä¸ªæœ€å¤§å€¼</strong>ã€‚</p>
<h3 id="newFixedThreadPoolçš„ä½¿ç”¨"><a href="#newFixedThreadPoolçš„ä½¿ç”¨" class="headerlink" title="newFixedThreadPoolçš„ä½¿ç”¨"></a>newFixedThreadPoolçš„ä½¿ç”¨</h3><p>â€‹        åˆ›å»ºä¸€ä¸ªå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œä»¥å…±äº«çš„æ— ç•Œé˜Ÿåˆ—æ–¹å¼æ¥è¿è¡Œè¿™äº›çº¿ç¨‹ã€‚åœ¨ä»»æ„ç‚¹ï¼Œåœ¨å¤§å¤šæ•° <strong>nThreads</strong> çº¿ç¨‹ä¼šå¤„äºå¤„ç†ä»»åŠ¡çš„æ´»åŠ¨çŠ¶æ€ã€‚å¦‚æœåœ¨æ‰€æœ‰çº¿ç¨‹å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶æäº¤é™„åŠ ä»»åŠ¡ï¼Œåˆ™åœ¨æœ‰å¯ç”¨çº¿ç¨‹ä¹‹å‰ï¼Œé™„åŠ ä»»åŠ¡å°†åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚å¦‚æœåœ¨å…³é—­å‰çš„æ‰§è¡ŒæœŸé—´ç”±äºå¤±è´¥è€Œå¯¼è‡´ä»»ä½•çº¿ç¨‹ç»ˆæ­¢ï¼Œé‚£ä¹ˆä¸€ä¸ªæ–°çº¿ç¨‹å°†ä»£æ›¿å®ƒæ‰§è¡Œåç»­çš„ä»»åŠ¡(å¦‚æœéœ€è¦)ã€‚åœ¨æŸä¸ªçº¿ç¨‹è¢«æ˜¾å¼åœ°å…³é—­ä¹‹å‰ï¼Œæ± ä¸­çš„çº¿ç¨‹å°†ä¸€ç›´å­˜åœ¨ã€‚<br>â€‹        å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<h4 id="No3-NewFixedThreadPoolDemo-java"><a href="#No3-NewFixedThreadPoolDemo-java" class="headerlink" title="No3_NewFixedThreadPoolDemo.java"></a>No3_NewFixedThreadPoolDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_NewFixedThreadPoolDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–¹ä¾¿ç›‘æ§å·¥å…·èƒ½æ•è·åˆ°</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> no <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"into"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span> <span class="token operator">+</span> no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">into2
end3
end1
end2
end0
into7
end4
into8
into9
into5
into6
end5
end7
into10
end8
end9
end6
into12
into14
into11
into13
end11
end13
end14
into16
end10
into17
into18
end12
into19
into15
end15
end18
end17
end19
end16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»ç»“æœä¸Šé¢çœ‹ï¼Œä¸€ä¸‹å­åªæœ‰5ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œï¼Œç„¶åç»“æŸ-ä¸ªå†æ‰§è¡Œä¸€ä¸ªã€‚<br>çœ‹ä¸€ä¸‹ç›‘æ§å·¥å…·å¦‚ä¸‹:<br>â€‹        (1) mainçº¿ç¨‹è®©å‡ºèµ„æºï¼Œçº¿ç¨‹æ± é‡Œé¢æ°¸è¿œæœ‰5ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ—¶å€™æ‰§<br>è¡Œæ—¶é—´ä¸ºä¸­ç­‰ã€‚</p>
<p><img src="/image/Concurrent/Concurrent25.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent25.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        (2)çº¿ç¨‹æ•°é‡ä¸Šå‡åˆ°ä¸€å®šæ•°é‡ä¹‹åå°±ä¸å˜äº†ï¼Œç„¶åæ‰§è¡Œå®Œä¹‹åé€æ¸é‡Šæ”¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent26.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent26.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        (3)ä½¿ç”¨çš„**<code>dump</code>**å†…å­˜ä¸Šå‡åˆ°çº¿ç¨‹æ± çš„æŒ‡å®šå¤§å°ï¼ŒåŸºæœ¬ä¸Šå¤„äºç¨³å®šé˜¶æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent27.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent27.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        çœ‹ä¸€ä¸‹Executors.newFixedThreadPool()çš„å®ç°ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± é‡ç”¨å›ºå®šæ•°é‡çš„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åœ¨ä¸€ä¸ªå…±äº«çš„æ— è¾¹ç•Œé˜Ÿåˆ—ä¸Šæ“ä½œã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œå¤§å¤šæ•°nThreadsçº¿ç¨‹éƒ½æ˜¯æ´»åŠ¨çš„å¤„ç†ä»»åŠ¡ã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                      <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                      <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="newScheduledThreadPoolçš„ä½¿ç”¨"><a href="#newScheduledThreadPoolçš„ä½¿ç”¨" class="headerlink" title="newScheduledThreadPoolçš„ä½¿ç”¨"></a>newScheduledThreadPoolçš„ä½¿ç”¨</h3><p>â€‹        åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ,å¯ä»¥è°ƒåº¦å‘½ä»¤æ¥è¿è¡Œä¸€ä¸ªç»™å®šçš„å»¶è¿Ÿå,æˆ–å®šæœŸæ‰§è¡Œã€‚</p>
<h4 id="No4-NewScheduledThreadPoolDemo-java"><a href="#No4-NewScheduledThreadPoolDemo-java" class="headerlink" title="No4_NewScheduledThreadPoolDemo.java"></a>No4_NewScheduledThreadPoolDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ScheduledExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No4_NewScheduledThreadPoolDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–¹ä¾¿ç›‘æ§å·¥å…·èƒ½æ•è·åˆ°</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ·»åŠ ä»»åŠ¡ï¼Œæ—¶é—´ï¼š"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> no <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"into"</span> <span class="token operator">+</span> no<span class="token operator">+</span><span class="token string">" =========> "</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"into"</span> <span class="token operator">+</span> no<span class="token operator">+</span><span class="token string">" =========> "</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            scheduledExecutorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">æ·»åŠ ä»»åŠ¡ï¼Œæ—¶é—´ï¼š<span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">46</span> CST <span class="token number">2021</span>
into0 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">47</span> CST <span class="token number">2021</span>
into1 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">48</span> CST <span class="token number">2021</span>
into2 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">49</span> CST <span class="token number">2021</span>
into0 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">49</span> CST <span class="token number">2021</span>
into1 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">50</span> CST <span class="token number">2021</span>
into3 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">50</span> CST <span class="token number">2021</span>
into2 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">51</span> CST <span class="token number">2021</span>
into4 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">51</span> CST <span class="token number">2021</span>
into3 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">52</span> CST <span class="token number">2021</span>
into5 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">52</span> CST <span class="token number">2021</span>
into4 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">53</span> CST <span class="token number">2021</span>
into6 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">53</span> CST <span class="token number">2021</span>
into7 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">54</span> CST <span class="token number">2021</span>
into5 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">54</span> CST <span class="token number">2021</span>
into8 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">55</span> CST <span class="token number">2021</span>
into6 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">55</span> CST <span class="token number">2021</span>
into7 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">56</span> CST <span class="token number">2021</span>
into9 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">56</span> CST <span class="token number">2021</span>
<span class="token class-name">Thread</span> <span class="token class-name">Main</span> <span class="token class-name">End</span><span class="token operator">!</span>
into8 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">57</span> CST <span class="token number">2021</span>
into9 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token class-name">Wed</span> <span class="token class-name">Nov</span> <span class="token number">10</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">58</span> CST <span class="token number">2021</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p> çœ‹ä¸€ä¸‹**<code>Executors.newScheduledThreadPool(int corePoolSize)</code>**çš„å®ç°:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ,å¯ä»¥è°ƒåº¦å‘½ä»¤æ¥è¿è¡Œä¸€ä¸ªç»™å®šçš„å»¶è¿Ÿå,æˆ–å®šæœŸæ‰§è¡Œã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">==</span><span class="token operator">></span>
    <span class="token keyword">public</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NANOSECONDS<span class="token punctuation">,</span>
              <span class="token keyword">new</span> <span class="token class-name">DelayedWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ•°ä¸ºcorePoolSizeï¼Œæ¥ä¸€ä¸ªçº¿ç¨‹å°±åœ¨çº¿ç¨‹æ± é‡Œé¢åˆ›å»ºä¸€ä¸ªçš„ä¸“é—¨çš„å»¶è¿Ÿé˜Ÿåˆ—ã€‚å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚</p>
<h3 id="çº¿ç¨‹æ± çš„å¥½å¤„"><a href="#çº¿ç¨‹æ± çš„å¥½å¤„" class="headerlink" title="çº¿ç¨‹æ± çš„å¥½å¤„"></a>çº¿ç¨‹æ± çš„å¥½å¤„</h3><h4 id="1-åˆç†åˆ©ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥4ä¸ªå¥½å¤„"><a href="#1-åˆç†åˆ©ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥4ä¸ªå¥½å¤„" class="headerlink" title="1.åˆç†åˆ©ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥4ä¸ªå¥½å¤„"></a>1.åˆç†åˆ©ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥4ä¸ªå¥½å¤„</h4><ol>
<li><strong>é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œé™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚</strong></li>
<li><strong>æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</strong></li>
<li><strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶åœ°åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ã€ è°ƒä¼˜å’Œç›‘æ§ã€‚ä½†æ˜¯è¦åšåˆ°åˆç†åœ°åˆ©ç”¨çº¿ç¨‹æ± ï¼Œå¿…é¡»å¯¹å…¶åŸç†äº†å¦‚æŒ‡æŒã€‚</strong></li>
<li><strong>é˜²æ­¢æœåŠ¡å™¨è¿‡è½½ï¼Œå½¢æˆå†…å­˜æº¢å‡ºï¼Œæˆ–è€…CPUè€—å°½ã€‚</strong></li>
</ol>
<h4 id="2-çº¿ç¨‹æ± æŠ€æœ¯å¦‚ä½•æé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½"><a href="#2-çº¿ç¨‹æ± æŠ€æœ¯å¦‚ä½•æé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½" class="headerlink" title="2.çº¿ç¨‹æ± æŠ€æœ¯å¦‚ä½•æé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½"></a>2.çº¿ç¨‹æ± æŠ€æœ¯å¦‚ä½•æé«˜æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½</h4><p>â€‹        è¿™é‡Œæ‰€æåˆ°æœåŠ¡å™¨ç¨‹åºæ˜¯æŒ‡èƒ½å¤Ÿæ¥å—å®¢æˆ·è¯·æ±‚å¹¶èƒ½å¤„ç†è¯·æ±‚çš„ç¨‹åºï¼Œè€Œä¸åªæ˜¯æŒ‡é‚£äº›æ¥å—ç½‘ç»œå®¢æˆ·è¯·æ±‚çš„ç½‘ç»œæœåŠ¡å™¨ç¨‹åºã€‚å¤šçº¿ç¨‹æŠ€æœ¯ä¸»è¦è§£å†³å¤„ç†å™¨å•å…ƒå†…å¤šä¸ªçº¿ç¨‹æ‰§è¡Œçš„é—®é¢˜ï¼Œå®ƒå¯ä»¥æ˜¾è‘—å‡å°‘å¤„ç†å™¨å•å…ƒçš„é—²ç½®æ—¶é—´ï¼Œå¢åŠ å¤„ç†å™¨å•å…ƒçš„ååèƒ½åŠ›ã€‚ä½†å¦‚æœå¯¹å¤šçº¿ç¨‹åº”ç”¨ä¸å½“ï¼Œä¼šå¢åŠ å¯¹å•ä¸ªä»»åŠ¡çš„å¤„ç†æ—¶é—´ã€‚</p>
<h4 id="3-å¯ä»¥ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­"><a href="#3-å¯ä»¥ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­" class="headerlink" title="3.å¯ä»¥ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a>3.å¯ä»¥ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­</h4><p>â€‹        å‡è®¾åœ¨ä¸€å°æœåŠ¡å™¨å®Œæˆä¸€é¡¹ä»»åŠ¡çš„æ—¶é—´ä¸º T,å¹¶å‡è®¾ï¼š<br>â—T1ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ—¶é—´ã€‚<br>â—T2ï¼Œåœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ï¼ŒåŒ…æ‹¬çº¿ç¨‹é—´åŒæ­¥æ‰€éœ€æ—¶é—´ã€‚<br>â—T3ï¼Œçº¿ç¨‹é”€æ¯çš„æ—¶é—´ã€‚</p>
<p>â€‹        æ˜¾ç„¶T &#x3D; T1+T2+T3ã€‚æ³¨æ„è¿™æ˜¯ä¸€-ä¸€ä¸ªæåº¦ç®€åŒ–çš„å‡è®¾ã€‚<br>â€‹        å¯ä»¥çœ‹å‡ºT1ã€T3æ˜¯å¤šçº¿ç¨‹æœ¬èº«çš„å¸¦æ¥çš„å¼€é”€ï¼Œæˆ‘ä»¬æ¸´æœ›å‡å°‘TIã€T3 æ‰€ç”¨çš„æ—¶é—´ï¼Œä»è€Œå‡å°‘ T çš„æ—¶é—´ã€‚ä½†ä¸€äº›çº¿ç¨‹çš„ä½¿ç”¨è€…å¹¶æ²¡æœ‰æ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥åœ¨ç¨‹åºä¸­é¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯çº¿ç¨‹ï¼Œè¿™å¯¼è‡´TIå’ŒT3åœ¨Tä¸­å æœ‰ç›¸å½“æ¯”ä¾‹ã€‚æ˜¾ç„¶è¿™æ˜¯çªå‡ºäº†çº¿ç¨‹çš„å¼±ç‚¹(TI, T3)ï¼Œè€Œä¸æ˜¯ä¼˜ç‚¹(å¹¶å‘æ€§)ã€‚<br>â€‹        çº¿ç¨‹æ± æŠ€æœ¯æ­£æ˜¯å…³æ³¨å¦‚ä½•ç¼©çŸ­æˆ–è°ƒæ•´TIã€T3æ—¶é—´çš„æŠ€æœ¯ï¼Œä»è€Œæé«˜æœåŠ¡å™¨ç¨‹åºæ€§èƒ½çš„ã€‚å®ƒæŠŠT1ã€T3åˆ†åˆ«å®‰æ’åœ¨æœåŠ¡å™¨ç¨‹åºçš„å¯åŠ¨å’Œç»“æŸçš„æ—¶é—´æ®µæˆ–è€…ä¸€äº›ç©ºé—²çš„æ—¶é—´æ®µï¼Œ è¿™æ ·åœ¨æœåŠ¡å™¨ç¨‹åºå¤„ç†å®¢æˆ·è¯·æ±‚æ—¶ï¼Œä¸ä¼šæœ‰TIã€T3çš„å¼€é”€äº†ã€‚</p>
<p>â€‹        çº¿ç¨‹æ± ä¸ä»…è°ƒæ•´T1ã€T3äº§ç”Ÿçš„æ—¶é—´æ®µï¼Œè€Œä¸”å®ƒè¿˜æ˜¾è‘—å‡å°‘äº†åˆ›å»ºçº¿ç¨‹çš„æ•°ç›®ã€‚å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š<br>â€‹        å‡è®¾ä¸€ä¸ªæœåŠ¡å™¨ä¸€å¤©è¦å¤„ç†50000ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”æ¯ä¸ªè¯·æ±‚éœ€è¦ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å®Œæˆã€‚æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹åˆ©ç”¨çº¿ç¨‹æ± æŠ€æœ¯å’Œä¸åˆ©ç”¨çº¿ç¨‹æ± æŠ€æœ¯çš„æœåŠ¡å™¨å¤„ç†è¿™äº›è¯·æ±‚æ—¶æ‰€äº§ç”Ÿçš„çº¿ç¨‹æ€»æ•°ã€‚åœ¨çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹æ•°ä¸€èˆ¬æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥äº§ç”Ÿçº¿ç¨‹æ€»æ•°ä¸ä¼šè¶…è¿‡çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°ç›®æˆ–è€…ä¸Šé™(ä»¥ä¸‹ç®€ç§°çº¿ç¨‹æ± å°ºå¯¸)ï¼Œè€Œå¦‚æœæœåŠ¡å™¨ä¸åˆ©ç”¨çº¿ç¨‹æ± æ¥å¤„ç†è¿™äº›è¯·æ±‚åˆ™çº¿ç¨‹æ€»æ•°ä¸º<strong>50000</strong>ï¼Œä¸€èˆ¬çº¿ç¨‹æ± å°ºå¯¸æ˜¯è¿œå°äº<strong>50000</strong>ã€‚æ‰€ä»¥åˆ©ç”¨çº¿ç¨‹æ± çš„æœåŠ¡å™¨ç¨‹åºä¸ä¼šä¸ºäº†åˆ›å»º<strong>50000</strong>è€Œåœ¨å¤„ç†è¯·æ±‚æ—¶æµªè´¹æ—¶é—´ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚</p>
<h4 id="4-çº¿ç¨‹æ± çš„åº”ç”¨èŒƒå›´"><a href="#4-çº¿ç¨‹æ± çš„åº”ç”¨èŒƒå›´" class="headerlink" title="4.çº¿ç¨‹æ± çš„åº”ç”¨èŒƒå›´"></a>4.çº¿ç¨‹æ± çš„åº”ç”¨èŒƒå›´</h4><ol>
<li>éœ€è¦å¤§é‡çš„çº¿ç¨‹æ¥å®Œæˆä»»åŠ¡ï¼Œä¸”å®Œæˆä»»åŠ¡çš„æ—¶é—´æ¯”è¾ƒçŸ­ã€‚**<code>Web</code><strong>æœåŠ¡å™¨å®Œæˆç½‘é¡µè¯·æ±‚è¿™æ ·çš„ä»»åŠ¡ï¼Œä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ˜¯éå¸¸åˆé€‚çš„ã€‚å› ä¸ºå•ä¸ªä»»åŠ¡å°ï¼Œè€Œä»»åŠ¡æ•°é‡å·¨å¤§ï¼Œä½ å¯ä»¥æƒ³è±¡ä¸€ä¸ªçƒ­é—¨ç½‘ç«™çš„ç‚¹å‡»æ¬¡æ•°ã€‚ä½†å¯¹äºé•¿æ—¶é—´çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ä¸€ä¸ª</strong>Telnet<strong>è¿æ¥è¯·æ±‚ï¼Œçº¿ç¨‹æ± çš„ä¼˜ç‚¹å°±ä¸æ˜æ˜¾äº†ã€‚å› ä¸º</strong>Telnet**ä¼šè¯æ—¶é—´æ¯”çº¿ç¨‹çš„åˆ›å»ºæ—¶é—´å¤§å¤šäº†ã€‚</li>
<li>å¯¹æ€§èƒ½è¦æ±‚è‹›åˆ»çš„åº”ç”¨ï¼Œæ¯”å¦‚è¦æ±‚æœåŠ¡å™¨è¿…é€Ÿå“åº”å®¢æˆ·è¯·æ±‚ã€‚</li>
<li>æ¥å—çªå‘æ€§çš„å¤§é‡è¯·æ±‚ï¼Œä½†ä¸è‡³äºä½¿æœåŠ¡å™¨å› æ­¤äº§ç”Ÿå¤§é‡çº¿ç¨‹çš„åº”ç”¨ã€‚çªå‘æ€§å¤§é‡å®¢æˆ·è¯·æ±‚ï¼Œåœ¨æ²¡æœ‰çº¿ç¨‹æ± æƒ…å†µä¸‹ï¼Œå°†äº§ç”Ÿå¤§é‡çº¿ç¨‹ï¼Œè™½ç„¶ç†è®ºä¸Šå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°ç›®æœ€å¤§å€¼ä¸æ˜¯é—®é¢˜ï¼ŒçŸ­æ—¶é—´å†…äº§ç”Ÿå¤§é‡çº¿ç¨‹å¯èƒ½ä½¿å†…å­˜åˆ°è¾¾æé™ï¼Œå¹¶å‡ºç°**<code>OutOfMemory</code>**çš„é”™è¯¯ã€‚</li>
</ol>
<h3 id="çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶åŠå…¶åŸç†"><a href="#çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶åŠå…¶åŸç†" class="headerlink" title="çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶åŠå…¶åŸç†"></a>çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶åŠå…¶åŸç†</h3><h4 id="çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„ä¸¤ä¸ªé˜Ÿåˆ—"><a href="#çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„ä¸¤ä¸ªé˜Ÿåˆ—" class="headerlink" title="çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„ä¸¤ä¸ªé˜Ÿåˆ—:"></a>çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„ä¸¤ä¸ªé˜Ÿåˆ—:</h4><ul>
<li>çº¿ç¨‹ç­‰å¾…æ± ï¼Œå³çº¿ç¨‹é˜Ÿåˆ—**<code>BlockingQueue</code>.**</li>
<li>ä»»åŠ¡å¤„ç†æ± (<strong><code>PoolWorker</code></strong>)ï¼Œå³æ­£åœ¨å·¥ä½œçš„**<code>Thread</code>**åˆ—è¡¨( <strong><code>HashSet&lt;Worker&gt; </code></strong>)ã€‚</li>
</ul>
<h4 id="çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„å‚æ•°"><a href="#çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„å‚æ•°" class="headerlink" title="çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„å‚æ•°:"></a>çº¿ç¨‹æ± çš„æ ¸å¿ƒçš„å‚æ•°:</h4><ul>
<li><p>æ ¸å¿ƒæ± å¤§å°(<strong><code>corePolSize</code></strong>)ï¼Œå³å›ºå®šå¤§å°ï¼Œè®¾å®šå¥½ä¹‹åï¼Œçº¿ç¨‹æ± çš„ç¨³å®šå³°å€¼ï¼Œè¾¾åˆ°è¿™ä¸ªå€¼ä¹‹åæ± çš„çº¿ç¨‹æ•°å¤§å°ä¸ä¼šé‡Šæ”¾çš„ã€‚</p>
</li>
<li><p>æœ€å¤§å¤„ç†çº¿ç¨‹æ± æ•°(<strong><code>maximumPoolSize</code></strong>)ï¼Œå½“çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹æ•°è¶…è¿‡**<code>corePoolSize</code><strong>ï¼Œå°äº</strong><code>maximumPoolSize</code>**æ—¶ä¼šåŠ¨æ€åˆ›å»ºä¸å›æ”¶çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹çš„èµ„æºã€‚</p>
</li>
</ul>
<h4 id="çº¿ç¨‹æ± çš„è¿è¡Œæœºåˆ¶"><a href="#çº¿ç¨‹æ± çš„è¿è¡Œæœºåˆ¶" class="headerlink" title="çº¿ç¨‹æ± çš„è¿è¡Œæœºåˆ¶:"></a>çº¿ç¨‹æ± çš„è¿è¡Œæœºåˆ¶:</h4><p>â€‹        æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚å‡å¦‚æœ‰ä¸€ä¸ªå·¥å‚ï¼Œå·¥å‚é‡Œé¢æœ‰<strong>10</strong>ä¸ªå·¥äººï¼Œæ¯ä¸ªå·¥äººåŒæ—¶åªèƒ½åšä»¶ä»»åŠ¡ã€‚å› æ­¤åªè¦å½“<strong>10</strong>ä¸ªå·¥äººä¸­æœ‰å·¥äººæ˜¯ç©ºé—²çš„ï¼Œæ¥äº†ä»»åŠ¡å°±åˆ†é…ç»™ç©ºé—²çš„å·¥äººåšï¼›å½“<strong>10</strong>ä¸ªå·¥äººéƒ½æœ‰ä»»åŠ¡åœ¨åšæ—¶ï¼Œå¦‚æœè¿˜æ¥äº†ä»»åŠ¡ï¼Œå°±æŠŠä»»åŠ¡è¿›è¡Œæ’é˜Ÿç­‰å¾…ã€‚</p>
<p>â€‹        å¦‚æœè¯´æ–°ä»»åŠ¡æ•°ç›®å¢é•¿çš„é€Ÿåº¦è¿œè¿œå¤§äºå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦ï¼Œé‚£ä¹ˆæ­¤æ—¶å·¥å‚ä¸»ç®¡å¯èƒ½ä¼šæƒ³è¡¥æ•‘æªæ–½ï¼Œæ¯”å¦‚é‡æ–°æ‹›<strong>4</strong>ä¸ªä¸´æ—¶å·¥äººè¿›æ¥ï¼šç„¶åå°±å°†ä»»åŠ¡ä¹Ÿåˆ†é…ç»™è¿™<strong>4</strong>ä¸ªä¸´æ—¶å·¥äººåšã€‚<br>å¦‚æœè¯´è¿™<strong>14</strong>ä¸ªå·¥äººåšä»»åŠ¡çš„é€Ÿåº¦è¿˜æ˜¯ä¸å¤Ÿï¼Œæ­¤æ—¶å·¥å‚ä¸»ç®¡å¯èƒ½å°±è¦è€ƒè™‘ä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡æˆ–è€…æŠ›å¼ƒå‰é¢çš„ä¸€äº›ä»»åŠ¡äº†ã€‚ å½“è¿™<strong>14</strong>ä¸ªå·¥äººå½“ä¸­æœ‰äººç©ºé—²æ—¶ï¼Œè€Œæ–°ä»»åŠ¡å¢é•¿çš„é€Ÿåº¦åˆæ¯”è¾ƒç¼“æ…¢ï¼Œå·¥å‚ä¸»ç®¡å¯èƒ½å°±è€ƒè™‘è¾æ‰4ä¸ªä¸´æ—¶å·¥äº†ï¼Œåªä¿æŒåŸæ¥çš„<strong>10</strong>ä¸ªå·¥äººï¼Œæ¯•ç«è¯·é¢å¤–çš„å·¥äººæ˜¯è¦èŠ±é’±çš„ã€‚<br>â€‹        <strong>è¿™ä¸ªä¾‹å­ä¸­æ°¸è¿œç­‰å¾…å¹²æ´»çš„</strong> <strong>10</strong>ä¸ªå·¥äººæœºåˆ¶å°±æ˜¯**<code>workerQueue</code><strong>.è¿™ä¸ªä¾‹å­ä¸­çš„</strong><code>corePoolSize</code><strong>å°±æ˜¯</strong>10<strong>ï¼Œè€Œ</strong><code>maximumPoolSize</code><strong>å°±æ˜¯14 (10+4) ã€‚ä¹Ÿå°±æ˜¯è¯´</strong><code>corePoolSize </code><strong>å°±æ˜¯çº¿ç¨‹æ± å¤§å°ï¼Œ</strong><code>maximumPoolSize</code><strong>åœ¨æˆ‘çœ‹æ¥æ˜¯çº¿ç¨‹æ± çš„ä¸€ç§è¡¥æ•‘æªæ–½ï¼Œ</strong>å³ä»»åŠ¡é‡çªç„¶è¿‡å¤§æ—¶çš„ä¸€ç§è¡¥æ•‘æªæ–½<strong>ã€‚å†çœ‹çœ‹ä¸‹å›¾å¥½å¥½ç†è§£ä¸€ä¸‹ã€‚ å·¥äººæ°¸è¿œåœ¨ç­‰å¾…å¹²æ´»ï¼Œå°±åƒ</strong><code>workerQueue</code>**æ°¸è¿œåœ¨å¾ªç¯å¹²æ´»ä¸€æ ·ï¼Œé™¤éï¼Œæ•´ä¸ªçº¿ç¨‹æ± åœæ­¢äº†ã€‚</p>
<p><img src="/image/Concurrent/Concurrent28.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent28.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="/image/Concurrent/Concurrent29.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent29.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<h3 id="è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸ExecutorService"><a href="#è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸ExecutorService" class="headerlink" title="è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸ExecutorService"></a>è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸ExecutorService</h3><p>â€‹        è‡ªå®šä¹‰çº¿ç¨‹æ± éœ€è¦ç”¨åˆ°**<code>ThreadFactory</code><strong>ï¼Œæœ¬èŠ‚å°†é€šè¿‡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„ä¾‹å­å¯¹</strong><code>ExecutorService</code>**åŠå…¶å‚æ•°è¿›è¡Œè¯¦ç»†è®²è§£ã€‚</p>
<h4 id="1-è®¤è¯†ä¸€ä¸‹ExecutorServiceçš„å®¶æ—"><a href="#1-è®¤è¯†ä¸€ä¸‹ExecutorServiceçš„å®¶æ—" class="headerlink" title="1.è®¤è¯†ä¸€ä¸‹ExecutorServiceçš„å®¶æ—"></a>1.è®¤è¯†ä¸€ä¸‹ExecutorServiceçš„å®¶æ—</h4><p>**<code>ExecutorService</code>**ç±»çš„å®¶æ—æˆå‘˜å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent30.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent30.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸Šå›¾ä¸­ä¸»è¦å…ƒç´ è¯´æ˜å¦‚ä¸‹:</p>
<ul>
<li>**<code>Executor</code><strong>ï¼šçº¿ç¨‹æ± çš„é¡¶çº§æ¥å£ï¼Œä½†æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šè®²</strong><code>Executor</code>**å¹¶ä¸æ˜¯ä¸€ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè€Œåªæ˜¯ä¸€ ä¸ªæ‰§è¡Œçº¿ç¨‹çš„å·¥å…·ã€‚</li>
<li>**<code>ExecutorService</code><strong>ï¼šçœŸæ­£çš„çº¿ç¨‹æ± æ¥å£ã€‚è¿™ä¸ªæ¥å£ç»§æ‰¿äº†</strong><code>Executor</code><strong>æ¥å£ï¼Œå¹¶å£°æ˜äº†ä¸€äº›æ–¹æ³•ï¼š<br><strong><code>submit \ invokeAll \ invokeAny</code></strong> ä»¥åŠ</strong><code>shutDown</code>**ç­‰ã€‚</li>
<li>**<code>AbstractExecutorService</code><strong>å®ç°äº†</strong><code>ExecutorService</code><strong>æ¥å£,åŸºæœ¬å®ç°äº†</strong><code>ExecutorService</code>**ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ã€‚</li>
<li><strong><code>ThreadPoolExecutor</code></strong>: <strong><code>ExecutorService</code></strong> çš„é»˜è®¤å®ç°ï¼Œç»§æ‰¿äº†ç±»**<code>AbstractExecutorService</code>**ã€‚</li>
<li>**<code>ScheduledExecutorService</code>**ï¼šä¸Timer&#x2F;TimerTaskç±»ä¼¼ï¼Œè§£å†³é‚£äº›éœ€è¦ä»»åŠ¡é‡å¤æ‰§è¡Œçš„é—®é¢˜ã€‚</li>
<li>**<code>ScheduledThreadPoolExecutor</code><strong>ï¼šç»§æ‰¿ThreadPoolExcutorçš„</strong><code>ScheduledExecutorService</code>**æ¥å£å®ç°ï¼Œå‘¨æœŸæ€§ä»»åŠ¡è°ƒåº¦çš„ç±»å®ç°ã€‚</li>
<li>**<code>Executors</code>**æ˜¯ä¸ªçº¿ç¨‹çš„å·¥å‚ç±»ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ›å»ºå¾ˆå¤šçº¿ç¨‹æ± ã€‚</li>
</ul>
<h4 id="2-åˆ©ç”¨ThreadFactoryåˆ›å»ºä¸€ä¸ªçº¿ç¨‹"><a href="#2-åˆ©ç”¨ThreadFactoryåˆ›å»ºä¸€ä¸ªçº¿ç¨‹" class="headerlink" title="2.åˆ©ç”¨ThreadFactoryåˆ›å»ºä¸€ä¸ªçº¿ç¨‹"></a>2.åˆ©ç”¨ThreadFactoryåˆ›å»ºä¸€ä¸ªçº¿ç¨‹</h4><p>â€‹        <strong><code>java.concurrent.ThreadFactory</code><strong>æä¾›äº†ä¸€ä¸ªåˆ›å»ºçº¿ç¨‹å·¥å‚çš„æ¥å£ã€‚å·¥å‚æ¨¡å¼æ˜¯æˆ‘ä»¬å­¦ä¹ ç¼–ç¨‹æ—¶ï¼Œæ¥è§¦åˆ°çš„ç¬¬-ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œä¹Ÿæ˜¯æœ€ç®€å•ã€æœ€å¸¸ç”¨çš„ä¸€ä¸ªè®¾è®¡æ¨¡å¼ã€‚ åœ¨JDKçš„æºç ä¸­ï¼Œå¤§é‡ä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œ</strong><code>ThreadFactory</code></strong> å°±æ˜¯å…¶ä¸­ä¸€ç§ã€‚<br>â€‹        å‰é¢æˆ‘ä»¬ä»‹ç»äº†ä¸‰ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å†ä»‹ç»ä¸€ç§ï¼Œé€šè¿‡çº¿ç¨‹å·¥å‚ç›´æ¥åˆ›å»ºçº¿ç¨‹ã€‚è®¾æƒ³è¿™æ ·ä¸€ç§åœºæ™¯ï¼Œ æˆ‘ä»¬éœ€è¦ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œ å¹¶ä¸”å¯¹äºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯¹è±¡ï¼Œèµ‹äºˆç»Ÿä¸€çš„çº¿ç¨‹ä¼˜å…ˆçº§ã€ç»Ÿä¸€çš„åç§°ã€ç”šè‡³è¿›è¡Œç»Ÿä¸€çš„ä¸šåŠ¡å¤„ç†æˆ–å’Œä¸šåŠ¡æ–¹é¢çš„åˆå§‹åŒ–å·¥ä½œï¼Œè¿™æ—¶å·¥å‚æ–¹æ³•å°±æ˜¯æœ€å¥½ç”¨çš„æ–¹æ³•äº†ã€‚<br>â€‹        <strong><code>ThreadFactory</code></strong> çš„æ¥å£å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨   <strong><code>ThreadFactory</code></strong> ä¸­ï¼Œåªæœ‰ä¸€ä¸ª**<code>newThread</code>**æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ¥æ”¶ä¸€ä¸ª **<code>Runnable</code><strong>å¯¹è±¡ï¼Œå¹¶å°†å…¶å°è£…åˆ°</strong><code>Thread</code>**å¯¹è±¡ä¸­ï¼Œè¿›è¡Œæ‰§è¡Œã€‚<br>â€‹        æˆ‘ä»¬å¯ä»¥å®ç°ä¸Šè¿°æ¥å£ï¼Œåš-ä¸€ä¸ªæœ€ç®€å•çš„çº¿ç¨‹å·¥å‚å‡ºæ¥ï¼Œæºç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SimpleThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä¸Šè¿°çº¿ç¨‹å·¥å‚ï¼Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå…¶ä»–ä»€ä¹ˆéƒ½æ²¡å¹²ã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬ä¸ä¼šåˆ›å»ºè¿™ä¹ˆç®€å•çš„çº¿ç¨‹å·¥å‚ã€‚<br>â€‹        æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹JDKæä¾›çš„é»˜è®¤çº¿ç¨‹å·¥å‚ç±»çº¿ç¨‹æ± é‡Œé¢ç”¨åˆ°çš„å¾ˆå¤šã€‚åœ¨**<code>Executors</code>**å·¥å…·ç±»ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadFactory</span> <span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> poolNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadGroup</span> group<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix<span class="token punctuation">;</span>

        <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">SecurityManager</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            group <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                                  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            namePrefix <span class="token operator">=</span> <span class="token string">"pool-"</span> <span class="token operator">+</span>
                          poolNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                         <span class="token string">"-thread-"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> r<span class="token punctuation">,</span>
                                  namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span>
                t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹çš„åç§°ï¼Œéƒ½æ˜¯è¿™é‡Œæ¥çš„å“¦ï¼Œå¦‚æœæƒ³è‡ªå®šä¹‰ï¼Œæ‰©å±•å³å¯ã€‚</p>
<h4 id="3-ç†è§£RejectedExecutionHandler"><a href="#3-ç†è§£RejectedExecutionHandler" class="headerlink" title="3.ç†è§£RejectedExecutionHandler"></a>3.ç†è§£RejectedExecutionHandler</h4><p>â€‹        å¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹å·²ç»é¥±å’Œï¼Œå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿå·²æ»¡ï¼Œé‚£ä¹ˆå°±éœ€è¦åšä¸¢å¼ƒå¤„ç†ï¼Œ<br>**<code>RejectedExecutionHandler</code>**è¿™ä¸ªç±»å°±æ˜¯ç”¨æ¥å¤„ç†è¢«ä¸¢å¼ƒçš„çº¿ç¨‹çš„å¼‚å¸¸å¤„ç†æ¥å£ã€‚<br>â€‹        æ¥å£å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//æ–¹æ³•åœ¨æ‰§è¡Œæ—¶å¯èƒ½è¢«ThreadPoolExecutorè°ƒç”¨ï¼Œä½†ä¸èƒ½æ¥å—ä»»åŠ¡ã€‚è¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨ç”±äºè¶…å‡ºäº†çº¿ç¨‹æˆ–é˜Ÿåˆ—æ§½çš„è¾¹ç•Œè€Œæ²¡æœ‰æ›´å¤šçº¿ç¨‹æˆ–é˜Ÿåˆ—æ§½å¯ç”¨æ—¶ï¼Œæˆ–è€…åœ¨Executorå…³é—­æ—¶ã€‚</span>
	<span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å¯ä»¥è‡ªå·±å®ç°è¿™ä¸ªæ¥å£å®ç°è‡ª å·±çš„çº¿ç¨‹ä¸¢å¼ƒå¤„ç†ç±»ï¼Œç®€å•çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No5_RejectedExecutionHandlerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" çº¿ç¨‹ä¿¡æ¯:â€+ r.toString() +â€ è¢«é—å¼ƒçš„çº¿ç¨‹æ± : "</span><span class="token operator">+</span>executor<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        JDKé‡Œé¢**<code>RejectedExecutionHandler</code><strong>æä¾›äº†</strong>4<strong>ç§æ–¹å¼æ¥å¤„ç†ä»»åŠ¡</strong>æ‹’ç»ç­–ç•¥**ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent31.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent31.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â—**<code>AbortPolicy</code><strong>: ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚<br>â—</strong><code>CallerRunsPolicy</code><strong>: åªç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡ã€‚<br>â—</strong><code>DiscardOldestPolicy</code><strong>: ä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚<br>â—</strong><code>DiscardPolicy</code>**: ä¸å¤„ç†ï¼Œä¸¢å¼ƒæ‰ã€‚</p>
<p>å¤§å®¶å»çœ‹å‡ ä¸ªç±»çš„æºç ä¹Ÿéå¸¸ç®€å•ï¼Œç°åœ¨ä¸¾æ¥ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* Predefined RejectedExecutionHandlers */</span>

    <span class="token comment">/**è¢«æ‹’ç»ä»»åŠ¡çš„å¤„ç†ç¨‹åºï¼Œå®ƒç›´æ¥åœ¨executeæ–¹æ³•çš„è°ƒç”¨çº¿ç¨‹ä¸­è¿è¡Œè¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œé™¤éæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä»»åŠ¡å°†è¢«ä¸¢å¼ƒã€‚
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CallerRunsPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
         * åˆ›å»ºä¸€ä¸ªCallerRunsPolicyã€‚
         */</span>
        <span class="token keyword">public</span> <span class="token class-name">CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * åœ¨è°ƒç”¨è€…çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡rï¼Œé™¤éæ‰§è¡Œå™¨è¢«å…³é—­ï¼Œå¦åˆ™ä»»åŠ¡å°†è¢«ä¸¢å¼ƒã€‚
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * æŠ›å‡ºRejectedExecutionExceptionçš„è¢«æ‹’ç»ä»»åŠ¡çš„å¤„ç†ç¨‹åºã€‚
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AbortPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
         * åˆ›å»ºä¸€ä¸ªAbortPolicyã€‚
         */</span>
        <span class="token keyword">public</span> <span class="token class-name">AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * ç›´æ¥æŠ›å‡º RejectedExecutionException.
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         * @throws RejectedExecutionException always
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">"Task "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                                 <span class="token string">" rejected from "</span> <span class="token operator">+</span>
                                                 e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * ä¸€ä¸ªè¢«æ‹’ç»ä»»åŠ¡çš„å¤„ç†ç¨‹åºï¼Œå®ƒé™é»˜åœ°ä¸¢å¼ƒè¢«æ‹’ç»çš„ä»»åŠ¡ã€‚
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
         * åˆ›å»ºä¸€ä¸ªDiscardPolicyã€‚
         */</span>
        <span class="token keyword">public</span> <span class="token class-name">DiscardPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * ä»€ä¹ˆéƒ½ä¸åšï¼Œæœ‰ä¸¢å¼ƒä»»åŠ¡rçš„æ•ˆæœã€‚
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * è¢«æ‹’ç»ä»»åŠ¡çš„å¤„ç†ç¨‹åºï¼Œå®ƒä¸¢å¼ƒæœ€è€çš„æœªå¤„ç†è¯·æ±‚ï¼Œç„¶åé‡è¯•æ‰§è¡Œï¼Œé™¤éæ‰§è¡Œç¨‹åºå…³é—­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä»»åŠ¡å°†è¢«ä¸¢å¼ƒ
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardOldestPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
         * ä¸ºç»™å®šçš„æ‰§è¡Œå™¨åˆ›å»ºä¸€ä¸ªDiscardOldestPolicyã€‚
         */</span>
        <span class="token keyword">public</span> <span class="token class-name">DiscardOldestPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * è·å–å¹¶å¿½ç•¥æ‰§è¡Œå™¨å°†æ‰§è¡Œçš„ä¸‹ä¸€ä¸ªä»»åŠ¡(å¦‚æœæœ‰ä¸€ä¸ªä»»åŠ¡ç«‹å³å¯ç”¨)ï¼Œç„¶åé‡è¯•ä»»åŠ¡rçš„æ‰§è¡Œï¼Œé™¤éæ‰§è¡Œå™¨è¢«å…³é—­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä»»åŠ¡rå°†è¢«ä¸¢å¼ƒã€‚
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        <strong>ä¸ºä»€ä¹ˆæœ‰ä»»åŠ¡æ‹’ç»çš„æƒ…å†µå‘ç”Ÿï¼š</strong><br>â€‹        è¿™é‡Œå…ˆå‡è®¾ä¸€ä¸ªå‰æ: çº¿ç¨‹æ± æœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºç¼“å­˜æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œæ­£åœ¨å¤„ç†çš„ä»»åŠ¡å°†ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚å› æ­¤ï¼Œåœ¨ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå‡ºç°æ–°ä»»åŠ¡çš„æ‹’ç»å¤„ç†é—®é¢˜ï¼Œéœ€è¦æœ‰ä¸€ç§ç­–ç•¥æ¥å¤„ç†è¿™ç§åº”è¯¥åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—å´å› ä¸ºé˜Ÿåˆ—å·²æ»¡æ— æ³•åŠ å…¥çš„æƒ…å†µã€‚ å¦å¤–ï¼Œåœ¨çº¿ç¨‹æ± å…³é—­çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦å¯¹ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—æ“ä½œè¿›è¡Œé¢å¤–çš„åè°ƒå¤„ç†ã€‚</p>
<h4 id="4-ThreadPoolExecutorè¯¦è§£"><a href="#4-ThreadPoolExecutorè¯¦è§£" class="headerlink" title="4.ThreadPoolExecutorè¯¦è§£"></a>4.ThreadPoolExecutorè¯¦è§£</h4><p>â€‹        **<code>ThreadPoolExecutor</code><strong>ç±»æ˜¯çº¿ç¨‹æ± ä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªç±»ï¼Œå› æ­¤å¦‚æœè¦é€å½»åœ°äº†è§£Javaä¸­çš„çº¿ç¨‹æ± ï¼Œé¡»å…ˆäº†è§£è¿™ä¸ªç±»ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ ä¸‹</strong><code>ThreadPoolExecutor</code>**ç±»çš„å…·ä½“å®ç°æºç ã€‚<br>â€‹        4ç§æ„é€ æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**ä½¿ç”¨ç»™å®šçš„åˆå§‹å‚æ•°å’Œé»˜è®¤çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorï¼Œå¹¶æ‹’ç»æ‰§è¡Œå¤„ç†ç¨‹åºã€‚ä½¿ç”¨æŸä¸ªexecutorå·¥å‚æ–¹æ³•å¯èƒ½æ¯”ä½¿ç”¨è¿™ä¸ªé€šç”¨æ„é€ å‡½æ•°æ›´æ–¹ä¾¿ã€‚

å‚æ•°:corePoolSizeâ€”æ± ä¸­ä¿ç•™çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬æ˜¯ç©ºé—²çš„ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut
	maximumPoolSizeâ€”æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
	keepAliveTimeâ€”å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚
	unitâ€”keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½
	workQueueâ€”ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œå‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—å°†åªä¿å­˜ç”±executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚*/</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span>
             <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


<span class="token comment">/**ä½¿ç”¨ç»™å®šçš„åˆå§‹å‚æ•°å’Œé»˜è®¤æ‹’ç»çš„æ‰§è¡Œå¤„ç†ç¨‹åºåˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚

å‚æ•°:corePoolSizeâ€”æ± ä¸­ä¿ç•™çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬æ˜¯ç©ºé—²çš„ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut
	maximumPoolSizeâ€”æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
	keepAliveTimeâ€”å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚
	unitâ€”keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½
	workQueueâ€”ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œå‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—å°†åªä¿å­˜ç”±executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚
	threadFactoryâ€”æ‰§è¡Œç¨‹åºåˆ›å»ºæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚ã€‚*/</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>
                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span>
             threadFactory<span class="token punctuation">,</span> defaultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">/**ä½¿ç”¨ç»™å®šçš„åˆå§‹å‚æ•°å’Œé»˜è®¤çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚

å‚æ•°:corePoolSizeâ€”æ± ä¸­ä¿ç•™çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬æ˜¯ç©ºé—²çš„ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut
	maximumPoolSizeâ€”æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
	keepAliveTimeâ€”å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚
	unitâ€”keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½
	workQueueâ€”ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œå‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—å°†åªä¿å­˜ç”±executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚
	handlerâ€”å½“æ‰§è¡Œè¢«é˜»å¡æ—¶ä½¿ç”¨çš„å¤„ç†ç¨‹åºï¼Œå› ä¸ºçº¿ç¨‹è¾¹ç•Œå’Œé˜Ÿåˆ—å®¹é‡å·²ç»è¾¾åˆ°
*/</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>
                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span>
             <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


<span class="token comment">/**ä½¿ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚

å‚æ•°:corePoolSizeâ€”æ± ä¸­ä¿ç•™çš„çº¿ç¨‹æ•°ï¼Œå³ä½¿å®ƒä»¬æ˜¯ç©ºé—²çš„ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut
	maximumPoolSizeâ€”æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
	keepAliveTimeâ€”å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢ä¹‹å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€å¤§æ—¶é—´ã€‚
	unitâ€”keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½
	workQueueâ€”ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œå‰ä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—å°†åªä¿å­˜ç”±executeæ–¹æ³•æäº¤çš„Runnableä»»åŠ¡ã€‚
	threadFactoryâ€”æ‰§è¡Œç¨‹åºåˆ›å»ºæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚ã€‚
	handlerâ€”å½“æ‰§è¡Œè¢«é˜»å¡æ—¶ä½¿ç”¨çš„å¤„ç†ç¨‹åºï¼Œå› ä¸ºçº¿ç¨‹è¾¹ç•Œå’Œé˜Ÿåˆ—å®¹é‡å·²ç»è¾¾åˆ°*/</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>
                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
            keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                <span class="token keyword">null</span> <span class="token operator">:</span>
                <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é€šè¿‡è§‚å¯Ÿæ¯ä¸ªæ„é€ å™¨çš„æºç çš„å…·ä½“å®ç°ï¼Œå‘ç°å‰é¢ä¸‰ä¸ªæ„é€ å™¨éƒ½æ˜¯è°ƒç”¨ç¬¬4ä¸ªæ„é€ å™¨è¿›è¡Œçš„åˆå§‹åŒ–å·¥ä½œã€‚ä¹Ÿå¯ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬è¯¦ç»†è¯´æ˜ä¸€ä¸‹é‡Œé¢çš„å‚æ•°:</p>
<ol>
<li>**<code>int corePoolSize</code><strong>ï¼šæ ¸å¿ƒæ± çš„å¤§å°ï¼Œè¿™ä¸ªå‚æ•°è·Ÿåé¢è®²è¿°çš„çº¿ç¨‹æ± çš„å®ç°åŸç†æœ‰éå¸¸å¤§çš„å…³ç³»ã€‚åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä¸­å¹¶æ²¡æœ‰ä»»ä½•çº¿ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰ä»»åŠ¡åˆ°æ¥æ‰åˆ›å»ºçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œé™¤éè°ƒç”¨äº†<code>pestartAllCoreThreads()</code>æˆ–è€…<code>pestartCoreThread()</code>æ–¹æ³•ï¼Œä»è¿™2ä¸ªæ–¹æ³•çš„åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œæ˜¯é¢„åˆ›å»ºçº¿ç¨‹çš„æ„æ€ï¼Œå³åœ¨æ²¡æœ‰ä»»åŠ¡åˆ°æ¥ä¹‹å‰å°±åˆ›å»º</strong><code>corePoolSize</code><strong>ä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º0ï¼Œå½“æœ‰ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œ å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°</strong><code>corePolsise</code>**åï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ã€‚</li>
<li><strong><code>int maximumolsize</code><strong>ï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œå®ƒè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­æœ€å¤šèƒ½åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹ï¼›åœ¨</strong><code>corePoolSize</code><strong>å’Œ</strong><code>maximumPoolSize</code><strong>çš„çº¿ç¨‹æ•°</strong>ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾</strong>ã€‚è€Œå°äº**<code>corePoolSize</code>**çš„ä¸ä¼šã€‚</li>
<li><strong><code>long kepAliveTime</code><strong>è¡¨ç¤ºçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶æœ€å¤šä¿æŒå¤šä¹…æ—¶é—´ä¼šç»ˆæ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº</strong><code>corePoolSize</code><strong>æ—¶ï¼Œ</strong><code>keepaliveTime </code><strong>æ‰ä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº</strong><code>corePoolSize</code><strong>å³å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº</strong><code>corePoolSize</code><strong>æ—¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç©ºé—²çš„æ—¶é—´è¾¾åˆ°</strong><code>keepAliveTime</code><strong>ï¼Œåˆ™ä¼šç»ˆæ­¢ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸è¶…è¿‡</strong><code>corePoolSize</code></strong> ï¼Œä½†æ˜¯å¦‚æœè°ƒç”¨äº†<br><strong><code>allowCoreThreadTimeOut(boolean)</code><strong>æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº</strong><code>corePoolSize</code></strong> æ—¶ï¼Œ<br><strong><code>keepaliveTime </code><strong>å‚æ•°ä¹Ÿä¼šèµ·ä½œç”¨ï¼Œ</strong>ç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º0</strong>ã€‚</li>
<li>**<code>TimeUnit unit</code><strong>ï¼šå‚æ•°</strong><code>keepAliveTime</code>**çš„æ—¶é—´å•ä½ï¼Œä¸€ä¸ªJDKé‡Œé¢çš„æ—¶é—´å•ä½æšä¸¾ç±»ã€‚</li>
<li>**<code>BlockingQueue workQueue</code><strong>ï¼šä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™ä¸ªå‚æ•°çš„é€‰æ‹©ä¹Ÿå¾ˆé‡è¦ï¼Œä¼šå¯¹çº¿ç¨‹æ± çš„è¿è¡Œè¿‡ç¨‹äº§ç”Ÿé‡å¤§å½±å“ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ è¿™é‡Œçš„é˜»å¡é˜Ÿåˆ—å°±æ˜¯æˆ‘ä»¬å‰é¢è®²è¿‡çš„å‡ ç§é€‰æ‹©</strong>(ArrayBlockingQueue;LinkedBlockingQueue;SynchronousQueue;)**ã€‚</li>
<li>**<code>ThreadFactory threadFactory</code><strong>ï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼šå¯ä»¥æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤å°±æ˜¯æˆ‘ä»¬å‰é¢è®²çš„</strong><code>Executors. defaultThreadFactory()</code>**ã€‚ç”¨æ¥åœ¨çº¿ç¨‹æ± é‡Œé¢åˆ›å»ºçº¿ç¨‹ã€‚</li>
<li><strong><code>RejectedExecutionHandler handler</code><strong>ï¼šè¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œä¹Ÿæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œé»˜è®¤ä¹Ÿæ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„</strong>4</strong>ç§å–å€¼ï¼š</li>
</ol>
<ul>
<li><strong><code>ThreadPoolExecutor.AbortPolicy (é»˜è®¤çš„)</code></strong></li>
<li><strong><code>ThreadPoolExecutor DiscardPolicy</code></strong></li>
<li><strong><code>ThreadPoolExecutor.DiscardOldestPolicy</code></strong></li>
<li><strong><code>ThreadPoolExecutor.CallerRunsPolicy</code></strong><br>    æ‰€ä»¥æƒ³è‡ªå®šä¹‰çº¿ç¨‹æ± å°±ä»ä»¥ä¸Šå‡ ä¸ªå‚æ•°å…¥æ‰‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹**<code>ThreadPoolExecutor</code>**é‡Œé¢çš„ä¸€äº›å…·ä½“æºç ï¼Œç¨å¾®ç†è§£ä¸€ä¸‹é‡Œé¢çš„å®ç°åŸç†ï¼š</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * The default rejected execution handler
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RejectedExecutionHandler</span> defaultHandler <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Set containing all worker threads in pool. Accessed only when
 * holding mainLock.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">></span></span> workers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">;</span>

<span class="token comment">/**
 * If false (default), core threads stay alive even when idle.
 * If true, core threads use keepAliveTime to time out waiting
 * for work.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> allowCoreThreadTimeOut<span class="token punctuation">;</span>


<span class="token comment">/**
 * Core pool size is the minimum number of workers to keep alive
 * (and not allow to time out etc) unless allowCoreThreadTimeOut
 * is set, in which case the minimum is zero.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>

<span class="token comment">/**
 * Maximum pool size. Note that the actual maximum is internally
 * bounded by CAPACITY.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>

<span class="token comment">/**
 * Handler called when saturated or shutdown in execute.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»“åˆæˆ‘ä»¬ä»¥å‰è®²çš„åŸç†æˆ‘ç›¸ä¿¡é€šè¿‡ä»¥ä¸Šçš„å‡ ä¸ªå‚æ•°å¤§æ¦‚å°±èƒ½çŒœçš„å‡ºæ¥é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„äº†ã€‚</p>
<h4 id="5-è‡ªå®šä¹‰å®ç°ä¸€ä¸ªç®€å•çš„Webè¯·æ±‚çº¿ç¨‹æ± "><a href="#5-è‡ªå®šä¹‰å®ç°ä¸€ä¸ªç®€å•çš„Webè¯·æ±‚çº¿ç¨‹æ± " class="headerlink" title="5.è‡ªå®šä¹‰å®ç°ä¸€ä¸ªç®€å•çš„Webè¯·æ±‚çº¿ç¨‹æ± "></a>5.è‡ªå®šä¹‰å®ç°ä¸€ä¸ªç®€å•çš„Webè¯·æ±‚çº¿ç¨‹æ± </h4><p>æˆ‘ä»¬æ¥è‡ªå®šä¹‰å®ç°ä¸€ä¸ªç®€å•çš„Webè¯·æ±‚çº¿ç¨‹æ± ã€‚æ¨¡ä»¿WebæœåŠ¡çš„éœ€æ±‚åœºæ™¯è¯´æ˜å¦‚ä¸‹:</p>
<ul>
<li><strong>æœåŠ¡å™¨å¯å®¹çº³çš„æœ€å°è¯·æ±‚æ•°æ˜¯å¤šå°‘ã€‚</strong></li>
<li><strong>å¯ä»¥åŠ¨æ€æ‰©å……çš„è¯·æ±‚æ•°å¤§å°æ˜¯å¤šå°‘ã€‚</strong></li>
<li><strong>å¤šä¹…å›æ”¶å¤šä½™çº¿ç¨‹æ•°å³è¯·æ±‚æ•°ã€‚</strong></li>
<li><strong>ç”¨æˆ·è®¿é—®é‡å¤§äº†æ€ä¹ˆå¤„ç†ã€‚</strong></li>
<li><strong>çº¿ç¨‹é˜Ÿåˆ—æœºåˆ¶é‡‡å–æœ‰ä¼˜å…ˆçº§çš„æ’é˜Ÿçš„æ‰§è¡Œæœºåˆ¶ã€‚</strong></li>
</ul>
<p>æ ¹æ®ä¸Šé¢å®šä¹‰çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªè‡ªå®šä¹‰çº¿ç¨‹æ± è¯¥å¦‚ä½•å†™ï¼Ÿä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ©ç”¨é»˜è®¤çº¿ç¨‹å·¥å‚å’ŒPriorityBlockingQueueé˜Ÿåˆ—æœºåˆ¶ã€å½“ç„¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ†åˆ«å®ç°å·¥å‚ç±»å’Œç»§æ‰¿queueè¿›è¡Œè‡ªå®šå’Œæ‰©å±•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newMyWebThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> minSpareThreads<span class="token punctuation">,</span> <span class="token keyword">int</span> maxThreads<span class="token punctuation">,</span> <span class="token keyword">int</span> maxIdleTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>minSpareThreads<span class="token punctuation">,</span> maxThreads<span class="token punctuation">,</span> maxIdleTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“ç„¶äº†æˆ‘ä»¬å¯èƒ½åªæ˜¯ç®€å•åœ°åšäº†ä¸€äº›è‡ªå®š ä¹‰çš„å®ç°ï¼Œå¤§å®¶å¯ä»¥ä»”ç»†ä½“ä¼šä¸€ä¸‹ï¼Œ åé¢æˆ‘ä»¬ä¼šè¯¦ç»†è¯´æ˜ä¸€ä¸‹çœŸæ­£çš„Tomcaté‡Œé¢çš„çº¿ç¨‹æ± æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<h3 id="çº¿ç¨‹æ± åœ¨å·¥ä½œä¸­çš„é”™è¯¯ä½¿ç”¨"><a href="#çº¿ç¨‹æ± åœ¨å·¥ä½œä¸­çš„é”™è¯¯ä½¿ç”¨" class="headerlink" title="çº¿ç¨‹æ± åœ¨å·¥ä½œä¸­çš„é”™è¯¯ä½¿ç”¨"></a>çº¿ç¨‹æ± åœ¨å·¥ä½œä¸­çš„é”™è¯¯ä½¿ç”¨</h3><p>(1) <strong>åˆ†ä¸æ¸…æ¥šçº¿ç¨‹æ± æ˜¯å•ä¾‹è¿˜æ˜¯å¤šå¯¹è±¡</strong>ã€‚å…ˆé—®å„ä½åŒå­¦ä¸€ä¸ªé—®é¢˜ï¼Œ çº¿ç¨‹æ± åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ˜¯å•ä¾‹çš„è¿˜æ˜¯å¤šä¾‹çš„?çº¿ç¨‹æ± ä¸€å®šè¦åœ¨åˆç†çš„å•ä¾‹æ¨¡å¼ä¸‹æ‰æœ‰æ•ˆï¼Œå·¥ä½œä¸­æˆ‘å‘ç°æœ‰äº›åŒå­¦å°†çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹æ³•æ”¾åœ¨services æ–¹æ³•é‡Œé¢å»åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ˜¯ä¸å¯ä»¥çš„ï¼Œå› ä¸ºæ¯å½“è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ä¸æ˜¯åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹çš„é—®é¢˜äº†ï¼Œè€Œæ˜¯åˆ›å»ºå‡ºæ¥äº†ä¸€å¤§å †çº¿ç¨‹æ± !<br>(2) <strong>çº¿ç¨‹æ± æ•°é‡è®¾ç½®å¾ˆå¤§ï¼Œè¯·æ±‚è¿‡è½½</strong>ã€‚è¿™æ ·å°±å‘æŒ¥ä¸äº†çº¿ç¨‹æ± çš„å¦å¤–ä¸€ä¸ªä¼˜ç‚¹äº†ã€‚ä»…ä»…æ˜¯è¯·æ±‚å°±å‹å®äº†æœåŠ¡å™¨ï¼Œè¿™ç§æƒ…å†µæ˜¯å¯èƒ½çš„ã€‚åœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸æƒ³å°†æ¯ä¸ªåˆ°æ¥çš„è¯·æ±‚éƒ½åˆ°æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œå› ä¸ºæ’åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡å¯èƒ½ä¼šæ¶ˆè€—å¤ªå¤šçš„ç³»ç»Ÿèµ„æºå¹¶å¼•èµ·èµ„æºç¼ºä¹ã€‚åœ¨è¿™ç§æƒ…å½¢ä¸‹å†³å®šå¦‚ä½•åšå–å†³äºä½ è‡ªå·±ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç®€å•åœ°æŠ›å¼ƒè¯·æ±‚ï¼Œä¾é æ›´é«˜çº§åˆ«çš„åè®®ç¨åé‡è¯•è¯·æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªæŒ‡å‡ºæœåŠ¡å™¨æš‚æ—¶å¾ˆå¿™çš„å“åº”æ¥æ‹’ç»è¯·æ±‚ã€‚<br>(3) <strong>æ³¨æ„æ­»é•œé—®é¢˜ã€‚ä»»ä½•å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºéƒ½æœ‰æ­»é”é£é™©</strong>ã€‚å½“ç»„è¿›ç¨‹æˆ–çº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªéƒ½åœ¨ç­‰å¾…ä¸€ä¸ªåªæœ‰è¯¥ç»„ä¸­å¦ä¸€ä¸ªè¿›ç¨‹æ‰èƒ½å¼•èµ·çš„äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¿™ç»„è¿›ç¨‹æˆ–çº¿ç¨‹æ­»é”äº†ã€‚æ­»é”çš„æœ€ç®€å•æƒ…å½¢æ˜¯ï¼šçº¿ç¨‹AæŒæœ‰å¯¹è±¡Xçš„ç‹¬å é”ï¼Œå¹¶ä¸”åœ¨ç­‰å¾…å¯¹è±¡Yçš„é”ï¼Œè€Œçº¿ç¨‹BæŒæœ‰å¯¹è±¡Yçš„ç‹¬å é”ï¼Œå´åœ¨ç­‰å¾…å¯¹è±¡Xçš„é”ã€‚é™¤éæœ‰æŸç§æ–¹æ³•æ¥æ‰“ç ´å¯¹é”çš„ç­‰å¾…(Java é”å®šä¸æ”¯æŒè¿™ç§æ–¹æ³•)ï¼Œå¦åˆ™æ­»é”çš„çº¿ç¨‹å°†æ°¸è¿œç­‰ä¸‹å»ã€‚</p>
<h3 id="Executors-çº¿ç¨‹æ± åˆ›å»ºæ€»ç»“"><a href="#Executors-çº¿ç¨‹æ± åˆ›å»ºæ€»ç»“" class="headerlink" title="Executors çº¿ç¨‹æ± åˆ›å»ºæ€»ç»“"></a><strong>Executors çº¿ç¨‹æ± åˆ›å»ºæ€»ç»“</strong></h3><p><strong>1ã€Executors.newCachedThreadPool();</strong><br><strong>è¯´æ˜:</strong></p>
<p>ã€€ã€€ åˆ›å»ºçš„çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹0 ï¼Œ æœ€å¤§çº¿ç¨‹æ˜¯Integer.MaxValueã€‚ çº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´1åˆ†é’Ÿã€‚ é»˜è®¤å¼‚å¸¸æ‹’ç»ç­–ç•¥ï¼Œä½¿ç”¨SynchronousQueueé˜Ÿ</p>
<p><strong>ç‰¹ç‚¹:</strong></p>
<p>ã€€ã€€æ¯æ¬¡æ·»åŠ ä»»åŠ¡å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹å°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œã€‚<br>ã€€ã€€SynchronousQueueæ˜¯é˜»å¡é˜Ÿåˆ—ï¼ŒåŠ å…¥ä»»åŠ¡çš„çº¿ç¨‹ä¼šé˜»å¡ä½ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹ä»ä¸­å–èµ°ä»»åŠ¡æ‰ä¼šç»“æŸé˜»å¡<br>ã€€ã€€çº¿ç¨‹åˆ›å»ºä¸Šé™è¿‘ä¹æ— é™</p>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<p>ã€€ã€€æ‰€ä»¥å®ƒé€‚ç”¨äºä»»åŠ¡åŠ å…¥æ¯”è¾ƒç¨³å½“ä¸”åŠ å…¥é—´éš”çŸ­çš„åœºæ™¯</p>
<p><strong>å®ç°ï¼š</strong></p>
<p>ã€€ã€€new ThreadPoolExecutor(0,Integer.MAX_VALUE,60L,TimeUnit.SECONDS,new SynchronousQueue());</p>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ã€€ã€€ä»»åŠ¡é˜Ÿåˆ—æ˜¯SynchronousQueueï¼Œçº¿ç¨‹æ± å¯¹ä»»åŠ¡æ¥ç€ä¸æ‹’ï¼Œçº¿ç¨‹ä¸å¤Ÿç”¨å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>ã€€ã€€å¦‚æœåŒä¸€æ—¶åˆ»åº”ç”¨çš„æ¥äº†å¤§é‡çš„ä»»åŠ¡ï¼Œ è¿™ä¸ªçº¿ç¨‹æ± å¾ˆå®¹æ˜“å°±åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹, å®¹æ˜“å¯¼è‡´åº”ç”¨å¡é¡¿æˆ–è€…ç›´æ¥OOM</p>
<p><strong>2ã€Executors.newFixedThreadPool(int);</strong><br><strong>è¯´æ˜:</strong> </p>
<p>ã€€ã€€æ ¸å¿ƒçº¿ç¨‹å’Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ä½ ä¼ å…¥çš„å‚æ•°ã€‚ å…¶ä»–å‚æ•°å’Œ Executors.newSingleThreadExecutorä¸€æ ·</p>
<p><strong>å®ç°ï¼š</strong></p>
<p>ã€€ã€€new ThreadPoolExecutor(nThreads, nThreads,0L,TimeUnit.MILLISECONDS,new LinkedBlockingQueue());</p>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ã€€ã€€è¿™ä¸ªå®šæ­»äº†çº¿ç¨‹æ•°é‡ï¼Œ æ‰€ä»¥çº¿ç¨‹æ•°é‡æ˜¯ä¸ä¼šè¶…å‡ºçš„ï¼Œä½†æ˜¯å®ƒçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„LinkedBlockingQueue</p>
<p>ã€€ã€€åŠ è¿›æ¥çš„ä»»åŠ¡å¤„ç†ä¸è¿‡æ¥å°±ä¼šå­˜å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œ å¹¶ä¸”æ— é™åˆ¶çš„å­˜å…¥é˜Ÿåˆ—ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´OOMã€‚</p>
<p><strong>3ã€Executors.newSingleThreadExecutor();</strong><br><strong>è¯´æ˜:</strong></p>
<p>ã€€ã€€åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚</p>
<p><strong>ç‰¹ç‚¹:</strong></p>
<p>ã€€ã€€åªæœ‰ä¸€ä¸ªçº¿ç¨‹</p>
<p>ã€€ã€€è¿‘ä¹å¯ä»¥æ¥æ”¶æ— é™ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œ å¯ä»¥å †ç§¯å¤§é‡ä»»åŠ¡</p>
<p>ã€€ã€€é€‚ç”¨äºä»»åŠ¡æŒç»­åŠ å…¥ä½†æ˜¯ä»»åŠ¡æ•°å¹¶ä¸å¤šçš„åœºæ™¯</p>
<p><strong>å®ç°ï¼š</strong></p>
<p>ã€€ã€€new ThreadPoolExecutor(1,1,0L,TimeUnit.MILLISECONDS,new LinkedBlockingQueue())</p>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ã€€ã€€ä»»åŠ¡é˜Ÿåˆ—å’Œä¸Šé¢ä¸€æ ·ï¼Œ æ²¡æœ‰é™åˆ¶ï¼Œ å¾ˆå®¹æ˜“å°±ä½¿ç”¨ä¸å½“å¯¼è‡´OOM</p>
<p><strong>4ã€Executors.newScheduledThreadPool(int);</strong><br><strong>è¯´æ˜:</strong></p>
<p>ã€€ã€€åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<p>ã€€ã€€æ ¸å¿ƒçº¿ç¨‹æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ˜¯intä¸Šçº¿ï¼Œ é»˜è®¤å­˜æ´»æ—¶é—´æ˜¯10æ¯«ç§’ï¼Œ ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨è‡ªå·±å®ç°çš„DelayedWorkQueueï¼Œ æ‹’ç»ç­–ç•¥å¼‚å¸¸ç­–ç•¥</p>
<p>ã€€ã€€åŠ å…¥ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šæŠŠä»»åŠ¡å’Œå®šæ—¶æ—¶é—´æ„å»ºä¸€ä¸ªRunnableScheduledFutureå¯¹è±¡ï¼Œå†æŠŠè¿™ä¸ªå¯¹è±¡æ”¾å…¥DelayedWorkQueueé˜Ÿåˆ—ä¸­ï¼Œ</p>
<p>ã€€ã€€DelayedWorkQueueæ˜¯ä¸€ä¸ªæœ‰åºé˜Ÿåˆ—ï¼Œ ä»–ä¼šæ ¹æ®å†…éƒ¨çš„RunnableScheduledFutureçš„è¿è¡Œæ—¶é—´æ’åºå†…éƒ¨å¯¹è±¡ã€‚</p>
<p>ã€€ã€€ä»»åŠ¡åŠ å…¥åå°±ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚ è¿™ä¸ªçº¿ç¨‹ä¼šä»DelayedWorkQueueä¸­è·å–ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<p>ã€€ã€€DelayedWorkQueueå†…éƒ¨æ˜¯æŒ‰ç…§æ—¶é—´ä»å‰å®Œåè·å–ä»»åŠ¡çš„ã€‚å¦‚æœä»»åŠ¡çš„ä¸­çš„æ—¶é—´è¿˜æ²¡æœ‰åˆ°ã€‚ è·å–çš„å°±æ˜¯nullã€‚ è·å–ä»»åŠ¡ç»“æŸï¼Œçº¿ç¨‹ä¼šä¼‘çœ 10æ¯«ç§’ã€‚æ‰€ä»¥è¿™ä¸ªå®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæœ€å°é—´éš”æ˜¯10æ¯«ç§’çš„ã€‚</p>
<p><strong>å†…éƒ¨å®ç°</strong>ï¼š</p>
<p>ã€€ã€€new ScheduledThreadPoolExecutor(corePoolSize)</p>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ã€€ã€€è¿™ä¸ªæ˜¯å®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œ æ²¡æœ‰å®šä¹‰çº¿ç¨‹åˆ›å»ºæ•°é‡çš„ä¸Šçº¿ï¼Œ åŒæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ²¡æœ‰å®šä¹‰ä¸Šé™ï¼Œ å¦‚æœå‰ä¸€æ¬¡å®šæ—¶ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œ åä¸€ä¸ªå®šæ—¶ä»»åŠ¡çš„è¿è¡Œæ—¶é—´åˆ°äº†ï¼Œ å®ƒä¹Ÿä¼šè¿è¡Œï¼Œ çº¿ç¨‹ä¸å¤Ÿå°±åˆ›å»ºã€‚</p>
<p>ã€€ã€€è¿™æ ·å¦‚æœå®šæ—¶ä»»åŠ¡è¿è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œ å°±ä¼šå¯¼è‡´å‰åä¸¤ä¸ªå®šæ—¶ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¦‚æœä»–ä»¬ä¹‹é—´æœ‰é”ï¼Œè¿˜æœ‰å¯èƒ½å‡ºç°æ­»é”ã€‚</p>
<blockquote>
<p><strong>æ­£å› ä¸ºä»¥ä¸Šé—®é¢˜</strong></p>
<p><strong><code>é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ</code>ä¸­æ˜ç¡®æŒ‡å‡ºï¼Œè€Œä¸”ç”¨çš„è¯æ˜¯ã€ä¸å…è®¸ã€ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± </strong> </p>
<p>è¯¦è§å¹¶å‘å¤„ç†</p>
<ol start="4">
<li>ã€å¼ºåˆ¶ã€‘çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ <code>Executors</code> å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ <code>ThreadPoolExecutor</code> çš„æ–¹å¼ï¼Œè¿™æ ·</li>
</ol>
<p>çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚</p>
<p>è¯´æ˜ï¼š<code>Executors</code> è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š </p>
<p>1ï¼‰<code>FixedThreadPool</code> å’Œ <code>SingleThreadPool</code>:</p>
<p>å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º <strong>Integer.MAX_VALUE</strong>ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ <strong>OOM</strong>ã€‚ </p>
<p>2ï¼‰<code>CachedThreadPool</code> å’Œ <code>ScheduledThreadPool</code>:</p>
<p>å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º <strong>Integer.MAX_VALUE</strong>ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ <strong>OOM</strong>ã€‚</p>
</blockquote>
<p>è‡ªå®šä¹‰</p>
<h2 id="JDK7æ–°å¢çš„Fork-x2F-Join"><a href="#JDK7æ–°å¢çš„Fork-x2F-Join" class="headerlink" title="JDK7æ–°å¢çš„Fork&#x2F;Join"></a>JDK7æ–°å¢çš„Fork&#x2F;Join</h2><blockquote>
<p> <strong>å“è¶Šæ˜¯æ–¹å‘,æˆå°±åœ¨è·¯ä¸Šã€‚</strong></p>
</blockquote>
<p><img src="/image/Concurrent/Concurrent32.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent32.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        <strong>åŒ–ç¹ä¸ºç®€ï¼Œåˆ†è€Œæ²»ä¹‹ã€‚é€’å½’çš„åˆ†è§£å’Œåˆå¹¶ï¼Œç›´åˆ°ä»»åŠ¡å°åˆ°å¯ä»¥æ¥å—çš„ç¨‹åº¦ã€‚</strong></p>
<h3 id="è®¤è¯†-Futureä»»åŠ¡æœºåˆ¶å’ŒFutureTask"><a href="#è®¤è¯†-Futureä»»åŠ¡æœºåˆ¶å’ŒFutureTask" class="headerlink" title="è®¤è¯† Futureä»»åŠ¡æœºåˆ¶å’ŒFutureTask"></a>è®¤è¯† Futureä»»åŠ¡æœºåˆ¶å’ŒFutureTask</h3><p>â€‹        æœ¬èŠ‚æˆ‘ä»¬ä»‹ç»<code>Future</code>ç±»ã€‚å‰é¢æˆ‘ä»¬æåˆ°äº†<code>thread</code> çš„ä¸‰ç§åˆ›å»ºæ–¹å¼ï¼Œä¸€ç§æ˜¯è¿”å›ç»“æœçš„å°±æ˜¯è¦ç° <code>Callable</code>æ¥å£ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£æºç :</p>
<pre class="line-numbers language-none"><code class="language-none">public interface Callable&lt;V&gt; &#123;
    &#x2F;**
     * Computes a result, or throws an exception if unable to do so.
     * åªæœ‰ä¸€ä¸ªè·å¾—è¿”å›ç»“æœçš„æ–¹æ³•,å®ç°è¿™ä¸ªæ–¹æ³•å³è®¢ã€‚
     * @return computed result
     * @throws Exception if unable to compute a result
     *&#x2F;
    V call() throws Exception;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>â€‹        <code>Future</code>ç±»å°±æ˜¯å¯¹äºå…·ä½“çš„ <code>Runnable</code>æˆ–è€…<code>Callable</code>ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœã€‚å¿…è¦æ—¶å¯ä»¥é€šè¿‡<code>get</code>æ–¹æ³•è·å–æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡è¿”å›ç»“æœã€‚<code>Future</code>ç±»ä½äº<code>java.util.concurrent</code>åŒ…ä¸‹ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A &#123;@code Future&#125; represents the result of an asynchronous
 * computation.  Methods are provided to check if the computation is
 * complete, to wait for its completion, and to retrieve the result of
 * the computation.  The result can only be retrieved using method
 * &#123;@code get&#125; when the computation has completed, blocking if
 * necessary until it is ready.  Cancellation is performed by the
 * &#123;@code cancel&#125; method.  Additional methods are provided to
 * determine if the task completed normally or was cancelled. Once a
 * computation has completed, the computation cannot be cancelled.
 * If you would like to use a &#123;@code Future&#125; for the sake
 * of cancellability but not provide a usable result, you can
 * declare types of the form &#123;@code Future&lt;?>&#125; and
 * return &#123;@code null&#125; as a result of the underlying task.
 
 ç¤ºä¾‹ç”¨æ³•(æ³¨æ„ï¼Œä¸‹é¢çš„ç±»éƒ½æ˜¯ç»„æˆçš„ã€‚)
 Sample Usage (Note that the following classes are all made-up.)
 interface ArchiveSearcher &#123; String search(String target); &#125;
 class App &#123;
   ExecutorService executor = ...
   ArchiveSearcher searcher = ...
   void showSearch(final String target)
       throws InterruptedException &#123;
     Future&lt;String> future
       = executor.submit(new Callable&lt;String>() &#123;
         public String call() &#123;
             return searcher.search(target);
         &#125;&#125;);
     displayOtherThings(); // do other things while searching
     try &#123;
       displayText(future.get()); // use future
     &#125; catch (ExecutionException ex) &#123; cleanup(); return; &#125;
   &#125;
 &#125;
 
 FutureTaskç±»æ˜¯å®ç°äº†Runnableçš„Futureçš„å®ç°ï¼Œå› æ­¤å¯ä»¥ç”±Executoræ‰§è¡Œã€‚
 ä¾‹å¦‚ï¼Œä¸Šè¿°å¸¦æœ‰submitçš„ç»“æ„å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼ä»£æ›¿:
 
 The FutureTask class is an implementation of Future that implements Runnable, and so may be executed by an Executor. For example, the above construction with submit could be replaced by:
 
  FutureTask&lt;String> future =
   new FutureTask&lt;String>(new Callable&lt;String>() &#123;
     public String call() &#123;
       return searcher.search(target);
   &#125;&#125;);
 executor.execute(future);
 
 
 * &lt;p>Memory consistency effects: Actions taken by the asynchronous computation
 * &lt;a href="package-summary.html#MemoryVisibility"> &lt;i>happen-before&lt;/i>&lt;/a>
 * actions following the corresponding &#123;@code Future.get()&#125; in another thread.
 * å†…å­˜ä¸€è‡´æ€§æ•ˆæœ:å¼‚æ­¥è®¡ç®—æ‰€é‡‡å–çš„åŠ¨ä½œå‘ç”Ÿåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ç›¸åº”Future.get()ä¹‹åçš„åŠ¨ä½œä¹‹å‰ã€‚
 * @see FutureTask
 * @see Executor
 * @since 1.5
 * @author Doug Lea
 * @param &lt;V> The result type returned by this Future's &#123;@code get&#125; method
 */</span>
 <span class="token comment">/**
 Futureè¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚æä¾›çš„æ–¹æ³•ç”¨äºæ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆã€ç­‰å¾…è®¡ç®—å®Œæˆå’Œæ£€ç´¢è®¡ç®—ç»“æœã€‚åªæœ‰å½“è®¡ç®—å®Œæˆæ—¶ï¼Œæ‰èƒ½ä½¿ç”¨getæ–¹æ³•æ£€ç´¢ç»“æœï¼Œå¿…è¦æ—¶å°†é˜»å¡ï¼Œç›´åˆ°å®ƒå‡†å¤‡å°±ç»ªã€‚å–æ¶ˆç”±cancelæ–¹æ³•æ‰§è¡Œã€‚æä¾›äº†å…¶ä»–æ–¹æ³•æ¥ç¡®å®šä»»åŠ¡æ˜¯æ­£å¸¸å®Œæˆè¿˜æ˜¯è¢«å–æ¶ˆã€‚ä¸€æ—¦è®¡ç®—å®Œæˆï¼Œè®¡ç®—å°±ä¸èƒ½è¢«å–æ¶ˆã€‚å¦‚æœä¸ºäº†å¯å–æ¶ˆæ€§è€Œä½¿ç”¨Futureï¼Œä½†ä¸æä¾›å¯ç”¨çš„ç»“æœï¼Œåˆ™å¯ä»¥å£°æ˜Future&lt;?>å¹¶è¿”å›nullä½œä¸ºåº•å±‚ä»»åŠ¡çš„ç»“æœã€‚
 
 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * è¯•å›¾å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦‚æœä»»åŠ¡å·²å®Œæˆã€å·²è¢«å–æ¶ˆæˆ–ç”±äºå…¶ä»–åŸå› æ— æ³•å–æ¶ˆï¼Œåˆ™æ­¤å°è¯•å°†å¤±è´¥ã€‚å¦‚æœæˆåŠŸï¼Œä¸”åœ¨è°ƒç”¨cancelæ—¶è¯¥ä»»åŠ¡å°šæœªå¯åŠ¨ï¼Œåˆ™è¯¥ä»»åŠ¡æ°¸è¿œä¸åº”è¿è¡Œã€‚å¦‚æœä»»åŠ¡å·²ç»å¯åŠ¨ï¼Œé‚£ä¹ˆmayInterruptIfRunningå‚æ•°å°†ç¡®å®šåœ¨è¯•å›¾åœæ­¢ä»»åŠ¡æ—¶æ˜¯å¦åº”è¯¥ä¸­æ–­æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹ã€‚
    è¯¥æ–¹æ³•è¿”å›åï¼Œå¯¹isDoneçš„åç»­è°ƒç”¨æ€»æ˜¯è¿”å›trueã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œå¯¹isCancelledçš„åç»­è°ƒç”¨å°†å§‹ç»ˆè¿”å›trueã€‚
    å¦‚æœæ‰§è¡Œæ­¤ä»»åŠ¡çš„çº¿ç¨‹åº”è¯¥è¢«ä¸­æ–­ï¼Œåˆ™ä¸ºtrue;å¦åˆ™ï¼Œå…è®¸æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å®Œæˆ
	å¦‚æœä»»åŠ¡ä¸èƒ½è¢«å–æ¶ˆï¼Œè¿”å›falseï¼Œé€šå¸¸æ˜¯å› ä¸ºå®ƒå·²ç»æ­£å¸¸å®Œæˆ;true åä¹‹
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     *  å¦‚æœè¯¥ä»»åŠ¡åœ¨æ­£å¸¸å®Œæˆä¹‹å‰è¢«å–æ¶ˆï¼Œåˆ™è¿”å›trueã€‚
		å¦‚æœä»»åŠ¡åœ¨å®Œæˆä¹‹å‰è¢«å–æ¶ˆï¼Œåˆ™è¿”å›true
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     *	å¦‚æœä»»åŠ¡å®Œæˆï¼Œè¿”å›trueã€‚å®Œæˆå¯èƒ½æ˜¯ç”±äºæ­£å¸¸ç»ˆæ­¢ã€å¼‚å¸¸æˆ–å–æ¶ˆâ€”â€”åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•å°†è¿”å›trueã€‚
		å¦‚æœä»»åŠ¡å®Œæˆï¼Œè¿”å›true
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * åœ¨å¿…è¦æ—¶ç­‰å¾…è®¡ç®—å®Œæˆï¼Œç„¶åæ£€ç´¢å…¶ç»“æœã€‚
		è¿”å›:è®¡ç®—ç»“æœ
     *
     Throws:
        CancellationExceptionâ€”â€”å¦‚æœè®¡ç®—è¢«å–æ¶ˆ
        ExecutionExceptionâ€”â€”å¦‚æœè®¡ç®—æŠ›å‡ºå¼‚å¸¸
        InterruptedExceptionâ€”â€”å¦‚æœå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­
     */</span>
    <span class="token comment">//ç”¨æ¥è·å–æ‰§è¡Œç»“æœï¼Œè¿™ä¸ªæ–¹æ³•ä¼šäº§ç”Ÿé˜»å¡,ä¼šä¸€ç›´ç­‰åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰è¿”å›ã€‚</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * å¦‚æœæœ‰å¿…è¦ï¼Œæœ€å¤šç­‰å¾…ç»™å®šçš„æ—¶é—´æ¥å®Œæˆè®¡ç®—ï¼Œç„¶åæ£€ç´¢å…¶ç»“æœ(å¦‚æœå¯ç”¨)ã€‚
     *
     * å‚æ•°:timeoutâ€”ç­‰å¾…çš„æœ€å¤§æ—¶é—´å•ä½â€”timeoutå‚æ•°çš„æ—¶é—´å•ä½
		è¿”å›:è®¡ç®—ç»“æœ
     * throws:
             CancellationExceptionâ€”â€”å¦‚æœè®¡ç®—è¢«å–æ¶ˆ
             ExecutionExceptionâ€”â€”å¦‚æœè®¡ç®—æŠ›å‡ºå¼‚å¸¸
             InterruptedExceptionâ€”â€”å¦‚æœå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­
             TimeoutException -å¦‚æœç­‰å¾…è¶…æ—¶
     */</span>
    <span class="token comment">//ç”¨æ¥è·å–æ‰§è¡Œç»“æœ,å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…,è¿˜æ²¡è·å–åˆ°ç»“æœ,å°±ç›´æ¥è¿”å›null</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä¹Ÿå°±æ˜¯è¯´<code>Future</code>æä¾›äº†ä¸‰ç§åŠŸèƒ½ï¼š</p>
<ul>
<li>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚</li>
<li>èƒ½å¤Ÿä¸­æ–­ä»»åŠ¡ã€‚</li>
<li>èƒ½å¤Ÿè·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</li>
</ul>
<p>â€‹        å› ä¸º <code>Future</code>åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥æ˜¯æ— æ³•ç›´æ¥ç”¨æ¥åˆ›å»ºå¯¹è±¡ä½¿ç”¨çš„ï¼Œå› æ­¤å°±æœ‰äº†ä¸‹é¢çš„<code>FutureTask</code>ã€‚<code>FutureTask</code>ç›®å‰æ˜¯<code>Future</code>æ¥å£çš„ä¸€ä¸ªå”¯ä¸€å®ç°ç±»ã€‚<br>â€‹        æˆ‘ä»¬å…ˆç®€å•åœ°æ¥çœ‹ä¸€ä¸‹<code>FutureTask</code>ç±»:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹        <code>FutureTask</code>ç±»å®ç°äº†<code>RunnableFuture</code>æ¥å£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>RunnableFuture</code>æ¥å£çš„å®ç°ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Sets this Future to the result of its computation
     * unless it has been cancelled.
     å°†è¿™ä¸ªFutureè®¾ç½®ä¸ºå…¶è®¡ç®—çš„ç»“æœï¼Œé™¤éå®ƒå·²è¢«å–æ¶ˆ
     */</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å¯ä»¥çœ‹å‡º <code>RunnableFuture</code>ç»§æ‰¿äº†<code>Runnable</code>æ¥å£å’Œ <code>Future</code>æ¥å£ï¼Œè€Œ <code>FutureTask</code>å®ç°äº†<code>RunnableFuture</code>æ¥å£ã€‚æ‰€ä»¥å®ƒæ—¢å¯ä»¥ä½œä¸º<code>Runnable</code>è¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸º<code>Future</code>å¾—åˆ°<code>Callable</code>çš„è¿”å›å€¼ã€‚<br>â€‹        <code>FutureTask</code>æä¾›äº†2ä¸ªæ„é€ å™¨:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**åˆ›å»ºFutureTaskï¼Œåœ¨è¿è¡Œæ—¶æ‰§è¡Œç»™å®šçš„Callableã€‚
Params: callableâ€”å¯è°ƒç”¨ä»»åŠ¡
æŠ›å‡º:
NullPointerExceptionâ€”â€”å¦‚æœå¯è°ƒç”¨å¯¹è±¡ä¸ºç©º*/</span>
<span class="token keyword">public</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> callable<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> NEW<span class="token punctuation">;</span>       <span class="token comment">// ensure visibility of callable ç¡®ä¿å¯è°ƒç”¨å¯¹è±¡çš„å¯è§æ€§</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**
åˆ›å»ºä¸€ä¸ªFutureTaskï¼Œåœ¨è¿è¡Œæ—¶æ‰§è¡Œç»™å®šçš„Runnableï¼Œå¹¶åœ¨æˆåŠŸå®Œæˆæ—¶å®‰æ’getè¿”å›ç»™å®šçš„ç»“æœã€‚
Params: runnable -å¯è¿è¡Œçš„ä»»åŠ¡ç»“æœ-æˆåŠŸå®Œæˆåè¿”å›çš„ç»“æœã€‚å¦‚æœä¸éœ€è¦ç‰¹å®šçš„ç»“æœï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„ç»“æ„:Future&lt;?> f = new FutureTask&lt;Void>(runnable, null)
æŠ›å‡º:
NullPointerExceptionâ€”â€”å¦‚æœå¯è¿è¡Œå¯¹è±¡ä¸ºç©º*/</span>
<span class="token keyword">public</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">callable</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> NEW<span class="token punctuation">;</span>       <span class="token comment">// ensure visibility of callable ç¡®ä¿å¯è°ƒç”¨å¯¹è±¡çš„å¯è§æ€§</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä½¿ç”¨åœºæ™¯ï¼š<br>â€‹        å®é™…å·¥ä½œä¸­ï¼Œå¯èƒ½éœ€è¦ç»Ÿè®¡å„ç§ç±»å‹çš„æŠ¥è¡¨å‘ˆç°ç»“æœï¼Œå¯èƒ½ä¸€ä¸ªå¤§çš„æŠ¥è¡¨è¦ä¾èµ–iå—çš„è¿ç®—ç»“æœï¼Œä¸€ä¸ªçº¿ç¨‹åšå¯èƒ½åˆæ¯”è¾ƒæ…¢,å°±å¯ä»¥æ‹†åˆ†æˆNå¤šä¸ªå°çº¿ç¨‹,ç„¶åå°†å…¶ç»“ä½œä¸ºå¤§çš„æŠ¥è¡¨å‘ˆç°ç»“æœã€‚è€Œæ¥ä¸‹æ¥çš„Fork&#x2F;Joinå°±æ˜¯åŸºäºFutureå®ç°çš„ã€‚<br>â€‹        çœ‹ä¸‹é¢çš„å®ä¾‹å…ˆæ¥ä½“éªŒä¸€ä¸‹ï¼š</p>
<h4 id="No1-FutureTaskDemo-java"><a href="#No1-FutureTaskDemo-java" class="headerlink" title="No1_FutureTaskDemo.java"></a>No1_FutureTaskDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>future</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Callable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">FutureTask</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No1_FutureTaskDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SonTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SonTask</span><span class="token punctuation">(</span><span class="token string">"Thread Son1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> futureTask1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>futureTask1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªæœ‰å¾—åˆ°è¿”å›ç»“æœåæ‰ä¼šå¾€ä¸‹æ‰§è¡Œ</span>

        <span class="token comment">//æ‰§è¡Œå®ŒæŒ‡å®šçº¿ç¨‹è¿”å›æŒ‡å®šç»“æœ</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> futureTask2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token operator">+</span>futureTask2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªæœ‰å¾—åˆ°è¿”å›ç»“æœåæ‰ä¼šå¾€ä¸‹æ‰§è¡Œ</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">SonTask</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token class-name">SonTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token operator">+</span><span class="token string">"ä»»åŠ¡è®¡ç®—å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"name"</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">MyRun</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡æ‹Ÿå¹²æ´»</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç‰¹å®šçº¿ç¨‹2å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span> <span class="token class-name">Son1</span>ä»»åŠ¡è®¡ç®—å®Œæˆ
nameThread<span class="token operator">-</span><span class="token number">0</span>
ç‰¹å®šçº¿ç¨‹<span class="token number">2</span>å®Œæˆ
result22<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä»ç»“æœä¸Šå¯ä»¥çœ‹åˆ°æ˜¯æŒ‰ç…§é¢„æƒ³ç»“æœ,æŒ‰é¡ºåº,æŒ‰æ­¥éª¤åœ°æ‰§è¡Œã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯Fork-x2F-Joinæ¡†æ¶"><a href="#ä»€ä¹ˆæ˜¯Fork-x2F-Joinæ¡†æ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯Fork&#x2F;Joinæ¡†æ¶"></a>ä»€ä¹ˆæ˜¯Fork&#x2F;Joinæ¡†æ¶</h3><p>â€‹        <code>Fork/Join</code>æ¡†æ¶æ˜¯Java 7æä¾›çš„ä¸€ä¸ªç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶ã€‚<br>â€‹        æˆ‘ä»¬å†é€šè¿‡<code>Fork</code>å’Œ<code>Join</code>è¿™ä¸¤ä¸ªå•è¯æ¥ç†è§£ä¸‹<code>Fork/Join</code>æ¡†æ¶ï¼Œ<code>Fork</code>å°±æ˜¯æŠŠä¸€ä¸ªå¤§ä»»åŠ¡åˆ‡åˆ†ä¸ºè‹¥å¹²å­ä»»åŠ¡å¹¶è¡Œåœ°æ‰§è¡Œï¼Œ<code>Join</code> å°±æ˜¯åˆå¹¶è¿™äº›å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œæœ€åå¾—åˆ°è¿™ä¸ªå¤§ä»»åŠ¡çš„ç»“æœã€‚æ¯”å¦‚è®¡ç®—1+2+â€¦+10000ï¼Œå¯ä»¥åˆ†å‰²æˆ10ä¸ªå­ä»»åŠ¡ï¼Œæ¯ä¸ªå­ä»»åŠ¡åˆ†åˆ«å¯¹1000ä¸ªæ•°è¿›è¡Œæ±‚å’Œï¼Œæœ€ç»ˆæ±‡æ€»è¿™10ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚<code>Fork/Join</code>çš„è¿è¡Œæµç¨‹å›¾å¦‚ä¸‹:<img src="/image/Concurrent/Concurrent33.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent33.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„éœ€æ±‚æ¥ä½“éªŒä¸€ä¸‹ä»€ä¹ˆæ˜¯<code>Fork /Join</code>æ¡†æ¶ï¼Œéœ€æ±‚æ˜¯ï¼šè®¡ç®—1+2+3+4çš„ç»“æœã€‚<br>â€‹        ä½¿ç”¨<code>Fork /Join</code>æ¡†æ¶é¦–å…ˆè¦è€ƒè™‘åˆ°çš„æ˜¯å¦‚ä½•åˆ†å‰²ä»»åŠ¡ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªå­ä»»åŠ¡æœ€å¤šæ‰§è¡Œä¸¤ä¸ªæ•°çš„ç›¸åŠ ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¾ç½®åˆ†å‰²çš„é˜ˆå€¼æ˜¯2ï¼Œç”±äºæ˜¯4ä¸ªæ•°å­—ç›¸åŠ ï¼Œæ‰€ä»¥<code>Fork / Join</code>æ¡†æ¶ä¼šæŠŠè¿™ä¸ªä»»åŠ¡<code>fork</code>æˆä¸¤ä¸ªå­ä»»åŠ¡ï¼Œå­ä»»åŠ¡ä¸€è´Ÿè´£è®¡ç®—1+2ï¼Œå­ä»»åŠ¡äºŒè´Ÿè´£è®¡ç®—3+4ï¼Œç„¶åå†<code>join</code>ä¸¤ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚<br>â€‹        å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ä½“ä¼šä¸€ä¸‹å¦‚ä¸‹ï¼š</p>
<h4 id="No2-ForkJoinTaskDemo-java"><a href="#No2-ForkJoinTaskDemo-java" class="headerlink" title="No2_ForkJoinTaskDemo.java"></a>No2_ForkJoinTaskDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>future</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Future</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RecursiveTask</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No2_ForkJoinTaskDemo</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CountTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1-5æœ€ç»ˆç›¸åŠ çš„ç»“æœï¼š"</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CountTask</span> task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> result2 <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1-100æœ€ç»ˆç›¸åŠ çš„ç»“æœï¼š"</span> <span class="token operator">+</span> result2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">CountTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">3336021432713606929L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> splitSize <span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">//å¦‚æœä»»åŠ¡å·²ç»ä¸éœ€è¦å†æ‹†åˆ†äº†å°±å¼€å§‹è®¡ç®—</span>
        <span class="token keyword">boolean</span> canCompute<span class="token operator">=</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token operator">&lt;=</span>splitSize<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>canCompute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>start<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>end<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                sum<span class="token operator">=</span>sum<span class="token operator">+</span>i<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//æ‹†åˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡</span>
            <span class="token keyword">int</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>start<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token class-name">CountTask</span> fistTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>middle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CountTask</span> secondTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span>middle<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fistTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¼€å§‹æ‰§è¡Œ</span>
            secondTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
            <span class="token comment">//è·å¾—ç¬¬ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœï¼Œå¾—ä¸åˆ°ç»“æœï¼Œæ­¤çº¿ç¨‹ä¸ä¼šå¾€ä¸‹é¢æ‰§è¡Œã€‚</span>
            <span class="token keyword">int</span> firstResult <span class="token operator">=</span> fistTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> secondResult <span class="token operator">=</span> secondTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//åˆå¹¶ä¸¤ä¸ªå„¿å­çš„æ‰§è¡Œç»“æœã€‚</span>
            sum <span class="token operator">=</span> firstResult<span class="token operator">+</span> secondResult<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>æœ€ç»ˆç›¸åŠ çš„ç»“æœï¼š<span class="token number">15</span>
<span class="token number">1</span><span class="token operator">-</span><span class="token number">100</span>æœ€ç»ˆç›¸åŠ çš„ç»“æœï¼š<span class="token number">5050</span>
<span class="token class-name">Thread</span> <span class="token class-name">Main</span> <span class="token class-name">End</span><span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é€šè¿‡è¿™ä¸ªä¾‹å­è®©æˆ‘ä»¬å†æ¥è¿›ä¸€æ­¥äº†è§£ä¸€ä¸‹<code>ForkJoinTask</code>, <code>ForkJoinTask</code> ä¸ä¸€èˆ¬çš„ä»•åŠ¡çš„ç‹è¦åŒºåœ¨äºå®ƒéœ€è¦å®ç°<code>compute</code>æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œ,é¦–å…ˆéœ€è¦åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¶³å¤Ÿå°ï¼Œå¦‚æœè¶³å¤Ÿå°å°±æ°”æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœä¸è¶³å¤Ÿå°ï¼Œå°±å¿…é¡»åˆ†å‰²æˆä¸¤ä¸ªå­ä»»åŠ¡,æ¯ä¸ªå­ä»»åŠ¡åœ¨è°ƒç”¨<code>fork</code>æ–¹æ³•æ—¶ï¼Œåˆä¼šè¿›å…¥ <code>compute</code>æ–¹æ³•ï¼Œçœ‹çœ‹å½“å‰å­ä»»åŠ¡æ˜¯å¦éœ€è¦ç»§ç»­åˆ†å‰²æˆå­™ä»»åŠ¡ï¼Œå¦‚æœä¸éœ€è¦ç»§ç»­åˆ†å‰²ï¼Œåˆ™æ‰§è¡Œå½“å‰å­ä»»åŠ¡å¹¶è¿”å›ç»“æœã€‚ä½¿ç”¨<code>join</code>æ–¹æ³•ä¼šç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶å¾—åˆ°å…¶ç»“æœã€‚</p>
<h3 id="è®¤è¯†Fork-x2F-Joinçš„JDKé‡Œé¢çš„å®¶æ—"><a href="#è®¤è¯†Fork-x2F-Joinçš„JDKé‡Œé¢çš„å®¶æ—" class="headerlink" title="è®¤è¯†Fork&#x2F;Joinçš„JDKé‡Œé¢çš„å®¶æ—"></a>è®¤è¯†Fork&#x2F;Joinçš„JDKé‡Œé¢çš„å®¶æ—</h3><p>æœ¬èŠ‚æˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹Fork&#x2F;Joinå®¶æ—æˆå‘˜,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent34.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent34.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        å…ˆæ¥çœ‹ä¸€ä¸‹<code>ForkJoinTask</code>ï¼Œå®ƒæ˜¯å®ç°<code>Future</code>çš„å¦ä¸€ç§æœ‰è¿”å›ç»“æœçš„å®ç°æ–¹æ³•ï¼Œæ¯”<code>Future</code>å¤šäº†ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•:</p>
<ul>
<li><code>fork ()</code>ï¼Œè¿™ä¸ªæ–¹æ³•å†³å®šäº†<code>ForkJoinTask</code>çš„å¼‚æ­¥æ‰§è¡Œï¼Œå‡­å€Ÿè¿™ä¸ªæ–¹æ³•å¯ä»¥åˆ›å»ºæ–°çš„ä»»åŠ¡ã€‚</li>
<li><code>join()</code>ï¼Œè¯¥æ–¹æ³•è´Ÿè´£åœ¨è®¡ç®—å®Œæˆåè¿”å›ç»“æœï¼Œå› æ­¤å…è®¸ä¸€ä¸ªä»»åŠ¡ç­‰å¾…å¦ä¸€ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<p><code>Fork /join</code>çš„å®Œæ•´è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/image/Concurrent/Concurrent35.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent35.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<ul>
<li><code>RecursiveAction</code>ï¼šç»§æ‰¿ForkJoinTask,ç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚</li>
<li><code>RecursiveTask</code>ï¼šç»§æ‰¿<code>ForkJoinTask</code>ï¼Œç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚</li>
<li><code>ForkJoinPool</code>ï¼šå’Œçº¿ç¨‹æ± ThreadPoolExecutorä¸€æ ·éƒ½æ˜¯å®ç°çš„Executoræ¥å£ã€‚</li>
</ul>
<p>â€‹       <code>ForkJoinPool</code>æä¾›äº†ä¸‰ä¸ªæ–¹æ³•æ¥è°ƒåº¦å­ä»»åŠ¡:</p>
<ul>
<li><code>execute</code>å¼‚æ­¥æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚</li>
<li><code>invoke</code>å’Œ<code>invokeAll</code>æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ï¼Œç­‰å¾…å®Œæˆ,è¿”å›ç»“æœã€‚</li>
<li><code>submit</code>å¼‚æ­¥æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡,å¹¶ç«‹å³è¿”å›ä¸€ä¸ª <code>Future</code>å¯¹è±¡ã€‚</li>
</ul>
<p>â€‹       æˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥š <code>Fork/Join</code>æ¡†æ¶çš„éœ€æ±‚äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœè®©æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ª<code>Fork/Join</code>æ¡†æ¶,è¯¥å¦‚ä½•è®¾è®¡?è¿™ä¸ªæ€è€ƒæœ‰åŠ©äºä½ ç†è§£<code>Fork/Join</code>æ¡†æ¶çš„è®¾è®¡ã€‚</p>
<p>â€‹       ç¬¬ä¸€æ­¥åˆ†å‰²ä»»åŠ¡ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ª<code>fork</code>ç±»æ¥æŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆå­ä»»åŠ¡ï¼Œæœ‰å¯èƒ½å­ä»»åŠ¡è¿˜æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸åœåœ°åˆ†å‰²ï¼Œç›´åˆ°åˆ†å‰²å‡ºçš„å­ä»»åŠ¡è¶³å¤Ÿå°ã€‚<br>â€‹       ç¬¬äºŒæ­¥æ‰§è¡Œä»»åŠ¡å¹¶åˆå¹¶ç»“æœã€‚åˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åœ¨åŒç«¯é˜Ÿåˆ—é‡Œï¼Œç„¶åå‡ ä¸ªå¯åŠ¨çº¿ç¨‹åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œæ‹¿æ•°æ®,ç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚</p>
<p>â€‹       <code>Fork/Join</code>ä½¿ç”¨ä¸¤ä¸ªç±»æ¥å®Œæˆä»¥ä¸Šä¸¤ä»¶äº‹æƒ…:</p>
<ul>
<li><code>ForkJoinTask</code>ï¼šæˆ‘ä»¬å¦‚æœè¦ä½¿ç”¨<code>ForkJoin</code>æ¡†æ¶ï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>ForkJoin</code>ä»»åŠ¡ã€‚å®ƒæä¾›åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œ<code>fork()</code>å’Œ <code>join()</code>æ“ä½œçš„æœºåˆ¶,é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç»§æ‰¿<code>ForkJoinTas</code>kç±»ï¼Œè€Œåªéœ€è¦ç»§æ‰¿å®ƒçš„å­ç±»ï¼Œé‡è½½<code>protected void compute()</code>æ–¹æ³•ã€‚ <code>Fork/Join</code>æ¡†æ¶æä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªå­ç±»ï¼š<br>    <code>RecursiveAction</code>ï¼šç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚<br>      <code>RecursiveTask</code>ï¼šç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚</li>
<li><code>ForkJoinPool</code>ï¼š <code>ForkJoinTask</code>éœ€è¦é€šè¿‡<code>ForkJoinPool</code>æ¥æ‰§è¡Œï¼Œä»»åŠ¡åˆ†å‰²å‡ºçš„å­ä»»åŠ¡ä¼šæ·»åŠ åˆ°å½“å‰å·¥ä½œçº¿ç¨‹æ‰€ç»´æŠ¤çš„åŒç«¯é˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—é‡Œæš‚æ—¶æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šéšæœºä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—çš„å°¾éƒ¨è·å–ä¸€ä¸ªä»»åŠ¡ã€‚</li>
</ul>
<h3 id="Fork-x2F-Joinæ¡†æ¶çš„å®ç°åŸç†"><a href="#Fork-x2F-Joinæ¡†æ¶çš„å®ç°åŸç†" class="headerlink" title="Fork&#x2F;Joinæ¡†æ¶çš„å®ç°åŸç†"></a>Fork&#x2F;Joinæ¡†æ¶çš„å®ç°åŸç†</h3><p>â€‹       <code>Fork/Join</code> (åˆ†å‰&#x2F;ç»“åˆ)æ¡†æ¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„çº¿ç¨‹æ± æ¡†æ¶ï¼Œä¸“ç”¨äºéœ€è¦å°†ä¸€ä¸ªä»»åŠ¡ä¸æ–­åˆ†è§£æˆå­ä»»åŠ¡(åˆ†å‰)ï¼Œå†ä¸æ–­è¿›è¡Œæ±‡æ€»å¾—åˆ°æœ€ç»ˆç»“æœ(ç»“åˆ)çš„è®¡ç®—è¿‡ç¨‹ã€‚æ¯”èµ·ä¼ ç»Ÿçš„çº¿ç¨‹æ± ç±»<code>ThreadPoolExecutor</code>,<code>ForkJoinPool</code>å®ç°äº†å·¥ä½œçªƒå–ç®—æ³•ï¼Œä½¿å¾—ç©ºé—²çº¿ç¨‹èƒ½å¤Ÿä¸»åŠ¨åˆ†æ‹…ä»åˆ«çš„çº¿ç¨‹åˆ†è§£å‡ºæ¥çš„å­ä»»åŠ¡ï¼Œä»è€Œè®©æ‰€æœ‰çš„çº¿ç¨‹éƒ½å°½å¯èƒ½å¤„äºé¥±æ»¡çš„å·¥ä½œçŠ¶æ€ï¼Œå¹¶å› æ­¤æé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚<br>â€‹       å·¥ä½œçªƒå–(<code>work-stealing</code>) ç®—æ³•æ˜¯æŒ‡æŸä¸ªçº¿ç¨‹ä»å…¶ä»–é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚å·¥ä½œçªƒå–çš„è¿è¡Œ<br>æµç¨‹å›¾å¦‚ä¸‹:</p>
<p><img src="/image/Concurrent/Concurrent36.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent36.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹       é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•å‘¢?å‡å¦‚æˆ‘ä»¬éœ€è¦åšä¸€ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ª<br>ä»»åŠ¡åˆ†å‰²ä¸ºè‹¥åƒäº’ä¸ä¾èµ–çš„å­ä»»åŠ¡ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼Œäºæ˜¯æŠŠè¿™äº›å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„<br>é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸ºæ¯ä¸ªé˜Ÿåˆ—åˆ›å»ºä¸€ä¸€ä¸ª å•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—ä¸€- -å¯¹åº”ï¼Œæ¯”å¦‚A<br>çº¿ç¨‹è´Ÿè´£å¤„ç†Aé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯æœ‰çš„çº¿ç¨‹ä¼šå…ˆæŠŠè‡ªå·±é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹²å®Œï¼Œè€Œå…¶ä»–çº¿ç¨‹å¯¹åº”çš„<br>é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ç­‰å¾…å¤„ç†ã€‚å¹²å®Œæ´»çš„çº¿ç¨‹ä¸å…¶ç­‰ç€ï¼Œä¸å¦‚å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œäºæ˜¯å®ƒå°±å»å…¶ä»–çº¿<br>ç¨‹çš„é˜Ÿåˆ—é‡Œçªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œåœ¨è¿™æ—¶ï¼Œå®ƒä»¬ä¼šè®¿é—®åŒä¸€ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘çªƒå–ä»»åŠ¡çº¿<br>ç¨‹å’Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€šå¸¸ä¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨<br>æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚<br>â€‹       å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå¹¶å‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ï¼Œå…¶ç¼ºç‚¹æ˜¯åœ¨æŸ<br>äº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”æ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›<br>å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚</p>
<p>â€‹       <code>ForkJoinPool</code>ç”±<code>ForkJoinTask</code>æ•°ç»„å’Œ<code>ForkJoinWorkerThread</code>æ•°ç»„ç»„æˆï¼Œ<code>ForkJoinTask</code> æ•°ç»„è´Ÿè´£<br>å­˜æ”¾ç¨‹åºæäº¤ç»™<code>ForkJoinPool</code>çš„ä»»åŠ¡ï¼Œè€Œ<code>ForkJoinWorkerThread</code>æ•°ç»„è´Ÿè´£æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚<code>ForkJoinTask</code>çš„<code>fork</code>æ–¹æ³•å®ç°åŸç†ã€‚å½“æˆ‘ä»¬è°ƒç”¨<code>ForkJoinTask</code>çš„<code>fork</code>æ–¹æ³•æ—¶ç¨‹åºä¼šè°ƒç”¨<code>push</code>æ–¹æ³•å¼‚æ­¥åœ°æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œç„¶åç«‹å³è¿”å›ç»“æœã€‚ä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹       <code>push</code>æ–¹æ³•æŠŠå½“å‰ä»»åŠ¡å­˜æ”¾åœ¨<code>ForkJoinPool</code>æ•°ç»„<code>WorkQueue</code>é‡Œã€‚<br>â€‹       <code>ForkJoinPool</code>é‡Œé¢çš„ä¸€äº›å˜é‡å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">WorkQueue</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> workQueues<span class="token punctuation">;</span>		<span class="token comment">//å·¥ä½œé˜Ÿåˆ—</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹       è€Œ<code>WorkQueue</code>åˆåšäº†ä¸Šé¢æˆ‘ä»¬è¯´çš„é˜Ÿåˆ—ç®—æ³•ï¼Œä¸€äº›å˜é‡å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@sun.misc.Contended</span>
 <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WorkQueue</span> <span class="token punctuation">&#123;</span>
     <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>   <span class="token comment">// the elements (initially unallocated)</span>
     <span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">;</span>   <span class="token comment">// the containing pool (may be null)</span>
     <span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThread</span> owner<span class="token punctuation">;</span> <span class="token comment">// owning thread or null if shared</span>
     <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> parker<span class="token punctuation">;</span>    <span class="token comment">// == owner during call to park; else null</span>
     <span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> currentJoin<span class="token punctuation">;</span>  <span class="token comment">// task being joined in awaitJoin</span>
     <span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> currentSteal<span class="token punctuation">;</span> <span class="token comment">// mainly used by helpStealer</span>
     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹       <code>ForkJoinTask</code>çš„<code>join</code>æ–¹æ³•å®ç°åŸç†ã€‚<code>Join</code> æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è·å–ç»“æœã€‚<br>è®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹<code>ForkJoinTask</code>çš„<code>join</code>æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token comment">//å½“è®¡ç®—å®Œæˆæ—¶è¿”å›è®¡ç®—ç»“æœã€‚æ­¤æ–¹æ³•ä¸get()çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå¼‚å¸¸å®Œæˆä¼šå¯¼è‡´RuntimeExceptionæˆ–Errorï¼Œè€Œä¸æ˜¯ExecutionExceptionï¼Œå¹¶ä¸”è°ƒç”¨çº¿ç¨‹çš„ä¸­æ–­ä¸ä¼šé€šè¿‡æŠ›å‡ºInterruptedExceptionå¯¼è‡´æ–¹æ³•çªç„¶è¿”å›ã€‚</span>
<span class="token comment">//è¿”å›:è®¡ç®—ç»“æœ å¦‚æœæœªå®Œæˆåˆ™è¿”å›null</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> s<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> DONE_MASK<span class="token punctuation">)</span> <span class="token operator">!=</span> NORMAL<span class="token punctuation">)</span>
           <span class="token function">reportException</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token function">getRawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹       é¦–å…ˆï¼Œå®ƒè°ƒç”¨äº†<code>doJoin()</code>æ–¹æ³•ï¼Œé€šè¿‡<code>doJoin()</code>æ–¹æ³•å¾—åˆ°å½“å‰ä»»åŠ¡çš„çŠ¶æ€æ¥åˆ¤æ–­è¿”å›ä»€ä¹ˆç»“æœï¼Œ<br>ä»»åŠ¡çŠ¶æ€æœ‰4ç§:å·²å®Œæˆ(<strong>NORMAL</strong>)ï¼Œè¢«å–æ¶ˆ(<strong>CANCELLED</strong>) ï¼Œä¿¡å·(<strong>SIGNAL</strong>) å’Œå‡ºç°å¼‚å¸¸(<strong>EXCEPTIONAL</strong>)ã€‚</p>
<p>â€‹       â—å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯å·²å®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ä»»åŠ¡ç»“æœã€‚<br>â€‹       â—å¦‚æœä»» åŠ¡çŠ¶æ€æ˜¯è¢«å–æ¶ˆï¼Œåˆ™ç›´æ¥æŠ›å‡ºCancellationExceptionã€‚<br>â€‹       â—å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯æŠ›å‡º å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¯¹åº”çš„å¼‚å¸¸ã€‚</p>
<p>â€‹       è®©æˆ‘ä»¬å†æ¥åˆ†æä¸‹<code>doJoin()</code>æ–¹æ³•çš„å®ç°ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span> <span class="token class-name">ForkJoinPool<span class="token punctuation">.</span>WorkQueue</span> w<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> s <span class="token operator">:</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span>w <span class="token operator">=</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">tryUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> s <span class="token operator">:</span>
        wt<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">awaitJoin</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹       åœ¨<code>doJoin()</code>æ–¹æ³•é‡Œï¼Œé¦–å…ˆé€šè¿‡æŸ¥çœ‹ä»»åŠ¡çš„çŠ¶æ€ï¼Œçœ‹ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œäº†ï¼Œå¦‚æœæ‰§è¡Œå®Œäº†ï¼Œåˆ™ç›´æ¥è¿”å›ä»»åŠ¡çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œï¼Œåˆ™ä»ä»»åŠ¡æ•°ç»„é‡Œå–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œã€‚å¦‚æœä»»åŠ¡é¡ºåˆ©æ‰§è¡Œå®Œæˆäº†ï¼Œåˆ™è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸º<strong>NORMAL</strong>, å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™è®°å½•å¼‚å¸¸ï¼Œå¹¶å°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º<strong>EXCEPTIONAL</strong> ã€‚<br>â€‹       å¦‚æœå†å¾€ä¸‹é¢çœ‹ï¼Œä½ ä¼šå‘ç°é‡Œé¢ç”¨äº†åŒæ­¥ä»£ç å—é”çš„æœºåˆ¶å’Œçº¿ç¨‹<code>interrupt</code>é˜»å¡æœºåˆ¶ï¼Œä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token comment">// try helping</span>
                 <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span>
                     <span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                 <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">else</span>
                            <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="å¼‚å¸¸å¤„ç†æœºåˆ¶å’ŒåŠæ³•"><a href="#å¼‚å¸¸å¤„ç†æœºåˆ¶å’ŒåŠæ³•" class="headerlink" title="å¼‚å¸¸å¤„ç†æœºåˆ¶å’ŒåŠæ³•"></a>å¼‚å¸¸å¤„ç†æœºåˆ¶å’ŒåŠæ³•</h3><p>â€‹       <code>ForkJoinTask</code>åœ¨æ‰§è¡Œçš„æ—¶å€™å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡åŠæ³•åœ¨ä¸»çº¿ç¨‹é‡Œç›´æ¥æ•è·å¼‚å¸¸ï¼Œæ‰€ä»¥<code>ForkJoinTask</code>æä¾›äº†<code>isCompletedAbnormally()</code>æ–¹æ³•æ¥æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»æŠ›å‡ºå¼‚å¸¸æˆ–å·²ç»è¢«å–æ¶ˆ<br>äº†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡<code>ForkJoinTask</code>çš„<code>getException</code>æ–¹æ³•è·å–å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹: </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//å¦‚æœæ­¤ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æˆ–è¢«å–æ¶ˆï¼Œåˆ™è¿”å›trueã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isCompletedAbnormally</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> status <span class="token operator">&lt;</span> NORMAL<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//è¿”å›åŸºå€¼è®¡ç®—æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦‚æœè¢«å–æ¶ˆåˆ™è¿”å›CancellationExceptionï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nullï¼Œæˆ–è€…å¦‚æœæ–¹æ³•å°šæœªå®Œæˆåˆ™è¿”å›nullã€‚</span>
<span class="token comment">//è¿”å›:å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›null</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Throwable</span> <span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> s <span class="token operator">=</span> status <span class="token operator">&amp;</span> DONE_MASK<span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">>=</span> NORMAL<span class="token punctuation">)</span>    <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span>
               <span class="token punctuation">(</span>s <span class="token operator">==</span> CANCELLED<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
               <span class="token function">getThrowableException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>subTask<span class="token punctuation">.</span><span class="token function">isCompletedAbnormally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subTask<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹       <code>getException</code>æ–¹æ³•è¿”å›<code>Throwable</code>å¯¹è±¡ï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆäº†ï¼Œåˆ™è¿”å›<code>CancellationException</code>ã€‚å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆæˆ–è€…æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è¿”å›nullã€‚</p>
<h3 id="Fork-x2F-Joinæ¨¡å¼ä¼˜ç¼ºç‚¹åŠå…¶å®é™…åº”ç”¨åœºæ™¯"><a href="#Fork-x2F-Joinæ¨¡å¼ä¼˜ç¼ºç‚¹åŠå…¶å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="Fork&#x2F;Joinæ¨¡å¼ä¼˜ç¼ºç‚¹åŠå…¶å®é™…åº”ç”¨åœºæ™¯"></a>Fork&#x2F;Joinæ¨¡å¼ä¼˜ç¼ºç‚¹åŠå…¶å®é™…åº”ç”¨åœºæ™¯</h3><p>â€‹       é€šè¿‡ä½¿ç”¨<code>Fork/Join</code>æ¨¡å¼ï¼Œè½¯ä»¶å¼€å‘äººå‘˜èƒ½å¤Ÿæ–¹ä¾¿åœ°åˆ©ç”¨å¤šæ ¸å¹³å°çš„è®¡ç®—èƒ½åŠ›ï¼Œè½»æ¾åœ°å®ç°å¹¶å‘ç¨‹åºçš„ä»»åŠ¡æ‹†åˆ†ã€‚å°½ç®¡è¿˜æ²¡æœ‰åšåˆ°å¯¹è½¯ä»¶å¼€å‘äººå‘˜å®Œå…¨é€æ˜ï¼Œ<code>Fork/Join</code> æ¨¡å¼å·²ç»æå¤§åœ°ç®€åŒ–äº†ç¼–å†™å¹¶å‘ç¨‹åºçš„çç¢å·¥ä½œã€‚å¯¹äºç¬¦åˆ<code>Fork/Join</code> æ¨¡å¼çš„åº”ç”¨ï¼Œè½¯ä»¶å¼€å‘äººå‘˜ä¸å†éœ€è¦å¤„ç†å„ç§å¹¶è¡Œç›¸å…³äº‹åŠ¡ï¼Œä¾‹å¦‚åŒæ­¥ã€é€šä¿¡ç­‰ï¼Œä»¥éš¾ä»¥è°ƒè¯•è€Œé—»åçš„**æ­»é”å’Œdata race(æ•°æ®ç«äº‰)**ç­‰é”™è¯¯ä¹Ÿå°±ä¸ä¼šå‡ºç°ï¼Œæå‡äº†æ€è€ƒé—®é¢˜çš„å±‚æ¬¡ã€‚å¹¶è¡Œåˆ†å‘ç­–ç•¥ï¼Œä»…ä»…å…³æ³¨å¦‚ä½•åˆ’åˆ†ä»»åŠ¡å’Œç»„åˆä¸­é—´ç»“æœï¼Œå°†å‰©ä¸‹çš„äº‹æƒ…ä¸¢ç»™Fork&#x2F;Join æ¡†æ¶å®Œæˆå³å¯ã€‚<br>â€‹       å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœæ‹†åˆ†çš„å¯¹è±¡è¿‡å¤šæ—¶ï¼Œå°å¿ƒä¸€ä¸‹å­æŠŠå†…å­˜æ’‘æ»¡ã€‚ç­‰å¾…çº¿ç¨‹çš„CPUèµ„æºé‡Šæ”¾äº†ï¼Œä½†æ˜¯çº¿ç¨‹å¯¹è±¡ç­‰å¾…æ—¶ä¸ä¼šè¢«åƒåœ¾æœºåˆ¶å›æ”¶ã€‚<br>â€‹       æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>Fork/Join</code> æ¨¡å¼çš„å®é™…åº”ç”¨åœºæ™¯ã€‚å¯¹äºæ ‘å½¢ç»“æ„ç±»å‹çš„æ•°æ®çš„å¤„ç†å’Œéå†éå¸¸é€‚åˆã€‚æ¯”å¦‚:æˆ‘ä»¬è¦å¯¹ä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨çš„å›¾ç‰‡æ–‡ä»¶ç›®å½•æ ‘è¿›è¡Œéå†å’Œåˆ†æçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é€’å½’åœ°ç»Ÿè®¡æ¯ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡ï¼Œæœ€åæ±‡æ€»ï¼Œéå¸¸é€‚åˆç”¨åˆ†å‰&#x2F;ç»“åˆæ¡†æ¶æ¥å¤„ç†ã€‚å®ä¾‹ä»£ç å¦‚ä¸‹:</p>
<h4 id="No3-RecursiveTaskDemo-java"><a href="#No3-RecursiveTaskDemo-java" class="headerlink" title="No3_RecursiveTaskDemo.java"></a>No3_RecursiveTaskDemo.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>future</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">DirectoryStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">LinkOption</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Paths</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RecursiveTask</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">No3_RecursiveTaskDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountingTask</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"D:\\image"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"D:ç›˜imageä¸‹é¢æ€»æ–‡ä»¶æ•°é‡ï¼š"</span><span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread Main End!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// å¤„ç†å•ä¸ªç›®å½•çš„ä»»åŠ¡</span>
<span class="token keyword">class</span> <span class="token class-name">CountingTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Path</span> dir<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">CountingTask</span><span class="token punctuation">(</span><span class="token class-name">Path</span> dir<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dir <span class="token operator">=</span> dir<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CountingTask</span><span class="token punctuation">></span></span> subTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CountingTask</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯»å–ç›®å½• dir çš„å­è·¯å¾„ã€‚</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DirectoryStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">></span></span> ds <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newDirectoryStream</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Path</span> subPath <span class="token operator">:</span> ds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span>subPath<span class="token punctuation">,</span> <span class="token class-name">LinkOption</span><span class="token punctuation">.</span>NOFOLLOW_LINKS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// å¯¹æ¯ä¸ªå­ç›®å½•éƒ½æ–°å»ºä¸€ä¸ªå­ä»»åŠ¡ã€‚</span>
                    subTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountingTask</span><span class="token punctuation">(</span>subPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// é‡åˆ°æ–‡ä»¶ï¼Œåˆ™è®¡æ•°å™¨å¢åŠ  1ã€‚</span>
                    count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subTasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// åœ¨å½“å‰çš„ ForkJoinPool ä¸Šè°ƒåº¦æ‰€æœ‰çš„å­ä»»åŠ¡ã€‚</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CountingTask</span> subTask <span class="token operator">:</span> <span class="token function">invokeAll</span><span class="token punctuation">(</span>subTasks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>subTask<span class="token punctuation">.</span><span class="token function">isCompletedAbnormally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subTask<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    count <span class="token operator">+=</span> subTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿ç®—ç»“æœå¦‚ä¸‹ï¼Œè¿ç®—çš„é€Ÿåº¦è¿˜æ˜¯éå¸¸å¿«çš„ï¼Œä½†æ˜¯ä¸€æ—¦æ–‡ä»¶å¤šäº†ï¼Œä¹Ÿæ˜¯éå¸¸è€—èµ„æºçš„ï¼Œç”µè„‘å°±ä¼šå‡ºç°å¡é¡¿çš„æƒ…å†µã€‚</p>
<h1 id="å®é™…çš„ä½¿ç”¨ã€ç›‘æ§ä¸æ‹“å±•"><a href="#å®é™…çš„ä½¿ç”¨ã€ç›‘æ§ä¸æ‹“å±•" class="headerlink" title="å®é™…çš„ä½¿ç”¨ã€ç›‘æ§ä¸æ‹“å±•"></a>å®é™…çš„ä½¿ç”¨ã€ç›‘æ§ä¸æ‹“å±•</h1><h2 id="çº¿ç¨‹ã€çº¿ç¨‹æ± åœ¨å®é™…äº’è”ç½‘é¡¶ç›®å¼€å‘ä¸­çš„åº”ç”¨"><a href="#çº¿ç¨‹ã€çº¿ç¨‹æ± åœ¨å®é™…äº’è”ç½‘é¡¶ç›®å¼€å‘ä¸­çš„åº”ç”¨" class="headerlink" title="çº¿ç¨‹ã€çº¿ç¨‹æ± åœ¨å®é™…äº’è”ç½‘é¡¶ç›®å¼€å‘ä¸­çš„åº”ç”¨"></a>çº¿ç¨‹ã€çº¿ç¨‹æ± åœ¨å®é™…äº’è”ç½‘é¡¶ç›®å¼€å‘ä¸­çš„åº”ç”¨</h2><blockquote>
<p> <strong>ä¸ç™»é«˜å±±ï¼Œä¸çŸ¥å±±ä¹‹é«˜ã€‚ä¸ä¸´æ·±æ¸Šï¼Œä¸çŸ¥åœ°ä¹‹åšä¹Ÿã€‚</strong></p>
</blockquote>
<p><img src="/image/Concurrent/Concurrent37.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent37.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"><br>è®¤è¯†å®é™…å¼€å‘è¿‡ç¨‹ä¸­çš„çº¿ç¨‹å’Œçº¿ç¨‹æ± çš„ç›¸å…³çŸ¥è¯†ä¸å®æˆ˜ã€‚</p>
<h3 id="Servletçº¿ç¨‹çš„è®¾è®¡"><a href="#Servletçº¿ç¨‹çš„è®¾è®¡" class="headerlink" title="Servletçº¿ç¨‹çš„è®¾è®¡"></a>Servletçº¿ç¨‹çš„è®¾è®¡</h3><p>â€‹        ä¸€ä¸ªå®¢æˆ·ç«¯çš„æµè§ˆå™¨è¯·æ±‚,å°±æ˜¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚<br>â€‹        <code> Server</code>ç«¯çš„æœåŠ¡å™¨å¼•æ“éƒ½ä¼šå»ºç«‹ä¸€ä¸ª <code>socket</code> è¿æ¥ç›‘å¬æµè§ˆå™¨å‘å›æ¥çš„ç”¨æˆ·è¯·æ±‚ï¼Œç„¶åå°±æŠŠæ¯ä¸ªè¯·æ±‚å½“æˆä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†ã€‚<br>â€‹        <code>Servlet</code>ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent38.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent38.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        é˜¶æ®µ1ï¼šåˆå§‹åŒ–é˜¶æ®µè°ƒç”¨<code>init()</code>æ–¹æ³•ã€‚<code>Servlet</code>åœ¨ä¸‹åˆ—æ—¶åˆ»è¿›è¡Œåˆå§‹åŒ–é˜¶æ®µã€‚</p>
<blockquote>
<ul>
<li><strong><code>Servlet</code>å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è£…è½½æŸäº› <code>Servlet</code>ï¼Œå®ç°å®ƒåªéœ€è¦åœ¨<code>web.XML</code>æ–‡ä»¶ä¸­çš„<code>&lt;Servlet&gt;&lt;/Servlet&gt;</code>ä¹‹é—´æ·»åŠ ä¸€è¡Œï¼š<code>&lt;loadon-startup&gt;1&lt;/loadon-startup&gt;</code>ã€‚</strong></li>
<li><strong>åœ¨<code>Servlet</code>å®¹å™¨å¯åŠ¨åï¼Œå®¢æˆ·é¦–æ¬¡å‘<code>Servlet</code>å‘é€è¯·æ±‚ã€‚</strong></li>
<li><strong><code>Servlet</code>ç±»æ–‡ä»¶è¢«æ›´æ–°åï¼Œé‡æ–°è£…è½½<code>Servlet</code>ï¼Œ<code>Servlet</code>è¢«è£…è½½åï¼Œ<code>Servlet</code>å®¹å™¨åˆ›å»ºä¸€ä¸ª <code>Servlet</code>å®ä¾‹å¹¶ä¸”è°ƒç”¨<code>Servlet</code>çš„ <code>init()</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨<code>Servlet</code>çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œ<code>init()</code>æ–¹æ³•åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</strong></li>
</ul>
</blockquote>
<p>â€‹        é˜¶æ®µ2ï¼šå“åº”å®¢æˆ·è¯·æ±‚é˜¶æ®µ,è°ƒç”¨<code>service()</code>æ–¹æ³•ã€‚<br>â€‹        é˜¶æ®µ3ï¼šç»ˆæ­¢é˜¶æ®µã€‚å½“æœåŠ¡å™¨å…³é—­çš„æ—¶å€™ï¼Œè°ƒç”¨<code>destroy()</code>æ–¹æ³•ã€‚<br>â€‹        å¯è§ <code>Servlet</code>åœ¨æ•´ä¸ª<strong>Tomcat</strong>æˆ–è€…å°±<strong>Jetty</strong> çš„æœåŠ¡å™¨ä¸­æ˜¯å•ä¾‹çš„ã€‚æ‰€ä»¥ï¼Œåœ¨å…±äº«å˜é‡çš„æ—¶å€™æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„,å¤§å®¶ä½¿ç”¨çš„æ—¶å€™è¦å°å¿ƒä¸€ç‚¹ã€‚ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆç›¸å¯¹äºæ¯ä¸ªè¯·æ±‚æ¥è¯´åˆæ˜¯çº¿ç¨‹å®‰å…¨çš„å‘¢?<br>â€‹        å…ˆçœ‹å¦‚ä¸‹<code>Servlet</code>æºç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Servlet</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ServletConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServletConfig</span> <span class="token function">getServletConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getServletInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æˆ‘ä»¬çœ‹åˆ°åªæœ‰<code>service</code>æ–¹æ³•å¯ä»¥å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæ¯ä¸€æ¬¡ç”¨æˆ·çš„è¯·æ±‚éƒ½ä¼šåˆ›å»º<code>ServletRequest</code> çš„ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥<code>ServletRequest</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚ç”±ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œï¼Œæ‰€ä»¥<code>ServletResquest</code> åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¢«è®¿é—®ï¼Œè€Œä¸”å®ƒåªåœ¨<code>service()</code>æ–¹æ³•å†…æ˜¯æœ‰æ•ˆçš„ã€‚<br>â€‹        æœ€åï¼Œæ—¢ç„¶æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå‘èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°æˆ‘ä»¬ä¹‹å‰è¯´çš„å¤šçº¿ç¨‹å¹¶å‘çš„é—®é¢˜ï¼Œè€Œæˆ‘ä»¬å·¥ä½œä¸­å‘¢ï¼Œåˆæ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿå…¶å®ä¸è®º<code>Tomcat</code>ã€<code>Jetty</code>ï¼Œè¿˜æ˜¯<code>Nginx</code>ï¼Œéƒ½æœ‰ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¯¦ç»†çœ‹çœ‹ã€‚</p>
<h3 id="çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾è®¡å’Œé…ç½®"><a href="#çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾è®¡å’Œé…ç½®" class="headerlink" title="çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾è®¡å’Œé…ç½®"></a>çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾è®¡å’Œé…ç½®</h3><p>â€‹        æ—¢ç„¶æœ‰äº†çº¿ç¨‹æ± ï¼Œé‚£æ€ä¹ˆæ ·æ‰ç®—é…ç½®è®¾ç½®åˆç†å‘¢ï¼Ÿæ€»ç»“èµ·æ¥å°±æ˜¯ä¸€å¥è¯ï¼Œ<strong>æœ€å¤§é™åº¦åœ°å‘æŒ¥å•å°ç‰©ç†serveræœºå™¨çš„æœ€å¤§å¹¶å‘é‡(å³ï¼šçº¿ç¨‹æ•°)ï¼Œä½†åˆä¸è‡³äºæœåŠ¡å™¨å®•æœºï¼Œåœæ­¢å“åº”ï¼Œè€Œå¼•èµ·è¿é”ååº”å½¢æˆç³»ç»Ÿå´©æºƒ</strong>ã€‚é‚£ä¹ˆå°±å¿…é¡»çŸ¥é“ä¸¤ä¸ªå‚æ•°äº†ï¼šæœ¬å°<strong>server</strong>çš„æœ€å¤§å¯å“åº”çš„å¹¶å‘é‡æ˜¯å¤šå°‘ï¼Ÿæé™å¹¶å‘é‡æ˜¯å¤šå°‘ï¼Ÿæ¥ä¸‹æ¥,æˆ‘ä»¬å°†è®²è¿°ä¸¤ç§æµ‹å‡ºæœ€å¤§å¹¶å‘çº¿ç¨‹çš„æ–¹æ³•ã€‚<br>â€‹        (1)ç¬¬1ç« ä¸­æˆ‘ä»¬è®²åˆ°ï¼Œå¦‚ä½•è®¡ç®—ä¸€ä¸ªè®¡ç®—æœº(ç‰©ç†æœº)çš„æœ€å¤§å¹¶å‘é‡ï¼Œè¿™ä¸ªæœ€å¤§å¹¶å‘é‡å…¶å®å°±æ˜¯è¿™ä¸ª<strong>server</strong> çš„æœ€å°å¹¶å‘é‡ã€‚è€Œæˆ‘ä»¬åœ¨ç¬¬1ç« ä¹Ÿè¯´äº†<strong>CPU</strong>çš„çº¿ç¨‹å·¥ä½œæœºåˆ¶åŠå…¶å’Œå†…å­˜çš„å…³ç³»ï¼Œ<strong>çŸ¥é“æ ¹æ®è¯·æ±‚çš„å¤§å°å’ŒCPUçš„è¿è¡Œæœºåˆ¶å’Œæ‰§è¡Œæ—¶é—´,å°±å¯ä»¥ç®—å‡ºä¸€ä¸ªå¤§æ¦‚çš„æœ€å¤§å¹¶å‘é‡</strong>ã€‚æ ¹æ®çš„å‚æ•°æœ‰ï¼šå†…å­˜å¤§å°å’Œå“åº”å¤§å°å¯¹åº”ã€å®½å¸¦å’Œè¯·æ±‚å¤§å°å¯¹åº”ã€å•å°IOçš„è¿è¡Œæ—¶é—´ã€CPUåˆ‡æ¢æ—¶é—´å’ŒçœŸæ­£çš„ç¨‹åºæ‰§è¡Œæ—¶é—´å¯¹åº”ã€æœ‰æ²¡æœ‰æ•°æ®åº“å¤„ç†ä¸Šçš„ç­‰å¾…ã€‚<br>â€‹        (2)é€šè¿‡æ—¥å¿—ç›‘æ§ï¼Œçœ‹çœ‹ç”¨æˆ·éƒ½è®¿é—®äº†å“ªäº›è¯·æ±‚é¡µé¢ï¼Œå‘é€äº†å“ªäº›å‚æ•°ï¼Œç„¶åæ‰¾ä¸€ä¸ªå’ŒæœåŠ¡å™¨ä¸€æ ·é…ç½®çš„æœºå™¨åšä¸€ä¸‹å‹åŠ›æµ‹è¯•å°±å¯ä»¥å¾—å‡ºæœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘å’ŒæŠ—å‹èƒ½åŠ›äº†ã€‚æ¯”å¦‚ï¼šæºç¨‹çš„æœç´¢æœåŠ¡å™¨çº¿ä¸Šä¸€å…±æ˜¯å››å°åšçš„è´Ÿè½½å‡è¡¡ï¼Œè€Œé€šè¿‡å‹åŠ›æµ‹è¯•æˆ‘ä»¬å‘ç°æ¯ä¸ª<strong>server</strong>çš„æœ€å¤§å¹¶å‘é‡æ˜¯300ä¸ªçº¿ç¨‹ã€‚<br>â€‹        çŸ¥é“äº†è¿™äº›ä¿¡æ¯ä¹‹å,å°±å¯ä»¥é€šè¿‡æˆ‘ä»¬å‰é¢è®²çš„çº¿ç¨‹æ± çš„è®¾ç½®å‚æ•°**<code>int corePoolSizeã€int maximumPoolSize</code>**ï¼Œè®¾ç½®ä¸€ä¸ªåˆç†çš„å¤§å°å°±å¯ä»¥äº†ã€‚</p>
<h3 id="Tomcatä¸­çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾ç½®"><a href="#Tomcatä¸­çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾ç½®" class="headerlink" title="Tomcatä¸­çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾ç½®"></a>Tomcatä¸­çº¿ç¨‹æ± å¦‚ä½•åˆç†è®¾ç½®</h3><p>â€‹       (1ï¼‰å…ˆæ¥çœ‹Tomcaté‡Œé¢å¦‚ä½•é…ç½®çº¿ç¨‹æ± ã€‚<br>â€‹       é¦–å…ˆï¼Œæ‰“å¼€<code>/conf/server.xml</code>,å¢åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Executor</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tomcatThreadPool<span class="token punctuation">"</span></span> <span class="token attr-name">namePrefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>catalina-exec-<span class="token punctuation">"</span></span>
	<span class="token attr-name">maxThreads</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span> <span class="token attr-name">minSpareThreads</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>25<span class="token punctuation">"</span></span> <span class="token attr-name">maxIdleTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>â€‹       æœ€å¤§çº¿ç¨‹200ï¼Œæœ€å°ç©ºé—²çº¿ç¨‹æ•°25ï¼Œçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´60sã€‚</p>
<p>â€‹       ç„¶å,ä¿®æ”¹<code>&lt;Connector ...&gt;</code>èŠ‚ç‚¹ï¼Œå¢åŠ <strong>executor</strong>å±æ€§,ä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connector</span> <span class="token attr-name">executor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tomcatThreadPool<span class="token punctuation">"</span></span>
	<span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span>
	<span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span>
	<span class="token attr-name">keepAliveTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>15000<span class="token punctuation">"</span></span>
	<span class="token attr-name">maxKeepAliveRequests</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
	<span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span>
	<span class="token attr-name">.....</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹       tomcatThreadPoolä¸ºä¸Šé¢çº¿ç¨‹æ± çš„åå­—ã€‚</p>
<blockquote>
<p><strong>æç¤ºï¼šå¯ä»¥å¤šä¸ªconnector å…±ç”¨1ä¸ªçº¿ç¨‹æ± ã€‚</strong></p>
</blockquote>
<p>â€‹       (2ï¼‰æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ <strong>Executor</strong> çš„å‚æ•°æœ‰å“ªäº›,å¦‚ä¸‹è¡¨æ‰€ç¤º:. </p>
<p><img src="/image/Concurrent/Concurrent39.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent39.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹       ç”±äºæˆ‘ä»¬æœ¬ä¹¦ä¸»è¦è®²è§£çº¿ç¨‹æ± ï¼Œ<strong>Connector</strong>çš„å‚æ•°æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œä¸€ä¸€è¯´æ˜äº†(è¯¦ç»†å†…å®¹è¯·å‚çœ‹é™„å½•4ï¼‰ã€‚<br>â€‹       (3)<strong>Tomcat</strong>çš„çº¿ç¨‹æ±  <strong>Executor</strong>å®ç°åŸç†ã€‚<br>â€‹       æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<strong>Tomcat</strong>å®¹å™¨é‡Œé¢<code>org.apache.catalina.Executor</code>çš„æºç :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Executor</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Executor</span><span class="token punctuation">,</span> <span class="token class-name">Lifecycle</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * åœ¨å°†æ¥çš„æŸä¸ªæ—¶å€™æ‰§è¡Œç»™å®šçš„å‘½ä»¤ã€‚å‘½ä»¤å¯ä»¥åœ¨æ–°çº¿ç¨‹ã€æ± åŒ–çº¿ç¨‹æˆ–è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œç”±Executorå®ç°è‡ªè¡Œå†³å®šã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚å¦‚æœå·¥ä½œé˜Ÿåˆ—å·²æ»¡ï¼Œç³»ç»Ÿå°†ç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼Œç›´åˆ°æŠ›å‡ºRejectedExecutionException
     *
     å‚æ•°	å‘½ä»¤â€”å¯è¿è¡Œçš„ä»»åŠ¡
    	 è¶…æ—¶-ç­‰å¾…ä»»åŠ¡å®Œæˆçš„æ—¶é—´é•¿åº¦
		 å•ä½-è¡¨ç¤ºè¶…æ—¶çš„å•ä½
     *
     * @throws java.util.concurrent.RejectedExecutionException if this task
     * cannot be accepted for execution - the queue is full
     * @throws NullPointerException if command or unit is null
     */</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰€ä»¥åªè¦å®ç°<strong>Excecutor</strong>æ¥å£å°±å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± äº†ã€‚</p>
<p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹é»˜è®¤<code>org.apache.catalina.core.StandardThreadExecutor</code>çš„æºç :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RejectedExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span></span><span class="token class-name">Executor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span></span><span class="token class-name">LifecycleException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span></span><span class="token class-name">LifecycleState</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LifecycleMBeanBase</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>res<span class="token punctuation">.</span></span><span class="token class-name">StringManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">ResizableExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">TaskQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">TaskThreadFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StandardThreadExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">LifecycleMBeanBase</span>
        <span class="token keyword">implements</span> <span class="token class-name">Executor</span><span class="token punctuation">,</span> <span class="token class-name">ResizableExecutor</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">StringManager</span> sm <span class="token operator">=</span>
            <span class="token class-name">StringManager</span><span class="token punctuation">.</span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>Package</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ---------------------------------------------- Properties</span>
    <span class="token comment">/**
     * Default thread priority
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> threadPriority <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Run threads in daemon or non-daemon state
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> daemon <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Default name prefix for the thread name
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> namePrefix <span class="token operator">=</span> <span class="token string">"tomcat-exec-"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * max number of threads
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> maxThreads <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * min number of threads
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> minSpareThreads <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * idle time in milliseconds
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> maxIdleTime <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The executor we use for this component
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * the name of this thread pool
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/**
     * prestart threads?
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> prestartminSpareThreads <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The maximum number of elements that can queue up before we reject them
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> maxQueueSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>

    <span class="token comment">/**
     * After a context is stopped, threads in the pool are renewed. To avoid
     * renewing all threads at the same time, this delay is observed between 2
     * threads being renewed.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> threadRenewalDelay <span class="token operator">=</span>
        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span>Constants</span><span class="token punctuation">.</span>DEFAULT_THREAD_RENEWAL_DELAY<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">TaskQueue</span> taskqueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ---------------------------------------------- Constructors</span>
    <span class="token keyword">public</span> <span class="token class-name">StandardThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//empty constructor for the digester</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">// ---------------------------------------------- Public Methods</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">/**
     * Start the component and implement the requirements
     * of &#123;@link org.apache.catalina.util.LifecycleBase#startInternal()&#125;.
     *
     * @exception LifecycleException if this component detects a fatal error
     *  that prevents this component from being used
     */</span>
     <span class="token comment">//åˆ©ç”¨Lifecycleçš„å¾ªç¯æœºåˆ¶å¼€å§‹æ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">&#123;</span>
    	<span class="token comment">//æˆ‘ä»¬å‰é¢è®²çš„queueæœºåˆ¶,å¾€ä¸‹çœ‹çš„è¯æ˜¯ç”¨çš„ LinkedBlockingQueue</span>
    	<span class="token comment">//public class TaskQueue extends LinkedBlockingQueue&lt;Runnable></span>
        taskqueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span>maxQueueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿™é‡Œç”¨äº†æˆ‘ä»¬å‰é¢è®²çš„è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚å¹¿æ–¹æ³•ã€‚</span>
        <span class="token class-name">TaskThreadFactory</span> tf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskThreadFactory</span><span class="token punctuation">(</span>namePrefix<span class="token punctuation">,</span>daemon<span class="token punctuation">,</span><span class="token function">getThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åœ¨è¿™é‡Œç”¨åˆ°äº†æˆ‘ä»¬å‰é¢è®²çš„è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± ,è¿™é‡Œå°±å¯ä»¥å¾ˆå¥½çš„è§£é‡Šäº†æˆ‘ä»¬å‰é¢çš„</span>
äº›å‚æ•°çš„æ„æ€å’Œç”¨æ„äº†ã€‚
        executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token function">getMinSpareThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMaxThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxIdleTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>taskqueue<span class="token punctuation">,</span> tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadRenewalDelay</span><span class="token punctuation">(</span>threadRenewalDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prestartminSpareThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">prestartAllCoreThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        taskqueue<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">LifecycleState</span><span class="token punctuation">.</span>STARTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">/**
     * åœæ­¢ç»„ä»¶å¹¶å®ç°org.apache.catalina.util.LifecycleBase.stopInternal()çš„éœ€æ±‚ã€‚
     *
     * @exception LifecycleException if this component detects a fatal error
     *  that needs to be reported
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">stopInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">&#123;</span>

        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">LifecycleState</span><span class="token punctuation">.</span>STOPPING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        taskqueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">destroyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">LifecycleException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">destroyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span>timeout<span class="token punctuation">,</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"standardThreadExecutor.notStarted"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> rx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//there could have been contention around the queue</span>
                <span class="token comment">//é˜Ÿåˆ—å‘¨å›´å¯èƒ½å‘ç”Ÿäº†äº‰æ‰§</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">)</span> executor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"standardThreadExecutor.queueFull"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"standardThreadExecutor.notStarted"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextStopping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">contextStopping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> threadPriority<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> daemon<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNamePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> namePrefix<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> maxIdleTime<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> maxThreads<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMinSpareThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> minSpareThreads<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPrestartminSpareThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> prestartminSpareThreads<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThreadPriority</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadPriority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadPriority <span class="token operator">=</span> threadPriority<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> daemon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>daemon <span class="token operator">=</span> daemon<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNamePrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span> namePrefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>namePrefix <span class="token operator">=</span> namePrefix<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxIdleTime</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxIdleTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxIdleTime <span class="token operator">=</span> maxIdleTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">setKeepAliveTime</span><span class="token punctuation">(</span>maxIdleTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxThreads <span class="token operator">=</span> maxThreads<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span>maxThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMinSpareThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> minSpareThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>minSpareThreads <span class="token operator">=</span> minSpareThreads<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>minSpareThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrestartminSpareThreads</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> prestartminSpareThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>prestartminSpareThreads <span class="token operator">=</span> prestartminSpareThreads<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxQueueSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxQueueSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> maxQueueSize<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getThreadRenewalDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> threadRenewalDelay<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThreadRenewalDelay</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadRenewalDelay<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadRenewalDelay <span class="token operator">=</span> threadRenewalDelay<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executor<span class="token punctuation">.</span><span class="token function">setThreadRenewalDelay</span><span class="token punctuation">(</span>threadRenewalDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Statistics from the thread pool æ¥è‡ªçº¿ç¨‹æ± çš„ç»Ÿè®¡ä¿¡æ¯</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getQueueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> executor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">resizePool</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span>maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">resizeQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getDomainInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// No way to navigate to Engine. Needs to have domain set.</span>
        <span class="token comment">//æ²¡æœ‰åŠæ³•å¯¼èˆªåˆ°å¼•æ“ã€‚éœ€è¦æœ‰åŸŸé›†ã€‚</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getObjectNameKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">StringBuilder</span> name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"type=Executor,name="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        name<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">AccessController</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">PrivilegedAction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">PrivilegedSetTccl</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Simple task thread factory to use to create threads for an executor
 * implementation.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadGroup</span> group<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> daemon<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadPriority<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TaskThreadFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namePrefix<span class="token punctuation">,</span> <span class="token keyword">boolean</span> daemon<span class="token punctuation">,</span> <span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SecurityManager</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        group <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>namePrefix <span class="token operator">=</span> namePrefix<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>daemon <span class="token operator">=</span> daemon<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadPriority <span class="token operator">=</span> priority<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TaskThread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskThread</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> r<span class="token punctuation">,</span> namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span>daemon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>threadPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the context class loader of newly created threads to be the class</span>
        <span class="token comment">// loader that loaded this factory. This avoids retaining references to</span>
        <span class="token comment">// web application class loaders and similar.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>IS_SECURITY_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> pa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivilegedSetTccl</span><span class="token punctuation">(</span>
                    t<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            t<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RejectedExecutionException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>res<span class="token punctuation">.</span></span><span class="token class-name">StringManager</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * As task queue specifically designed to run with a thread pool executor. The
 * task queue is optimised to properly utilize threads within a thread pool
 * executor. If you use a normal queue, the executor will spawn threads when
 * there are idle threads and you wont be able to force items onto the queue
 * itself.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskQueue</span> <span class="token keyword">extends</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">StringManager</span> sm <span class="token operator">=</span> <span class="token class-name">StringManager</span>
            <span class="token punctuation">.</span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token string">"org.apache.tomcat.util.threads.res"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">ThreadPoolExecutor</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// No need to be volatile. This is written and read in a single thread</span>
    <span class="token comment">// (when stopping a context and firing the  listeners)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> forcedRemainingCapacity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParent</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> tp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        parent <span class="token operator">=</span> tp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">force</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> parent<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"taskQueue.notRunning"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//forces the item onto the queue, to be used if the task is rejected</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">force</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> parent<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"taskQueue.notRunning"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>timeout<span class="token punctuation">,</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//forces the item onto the queue, to be used if the task is rejected</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//we can't do any checks</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//we are maxed out on threads, simply queue the object</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> parent<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//we have idle threads, just add it to the queue</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getSubmittedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//if we have less threads than maximum force creation of a new thread</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>parent<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//if we reached here, we need to add it to the queue</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Runnable</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runnable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// the poll timed out, it gives an opportunity to stop the current</span>
            <span class="token comment">// thread if needed to avoid memory leaks.</span>
            parent<span class="token punctuation">.</span><span class="token function">stopCurrentThreadIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Runnable</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span><span class="token function">currentThreadShouldBeStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">poll</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// yes, this may return null (in case of timeout) which normally</span>
            <span class="token comment">// does not occur with take()</span>
            <span class="token comment">// but the ThreadPoolExecutor implementation allows this</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forcedRemainingCapacity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// ThreadPoolExecutor.setCorePoolSize checks that</span>
            <span class="token comment">// remainingCapacity==0 to allow to interrupt idle threads</span>
            <span class="token comment">// I don't see why, but this hack allows to conform to this</span>
            <span class="token comment">// "requirement"</span>
            <span class="token keyword">return</span> forcedRemainingCapacity<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setForcedRemainingCapacity</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> forcedRemainingCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>forcedRemainingCapacity <span class="token operator">=</span> forcedRemainingCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="Nginxçº¿ç¨‹æ± "><a href="#Nginxçº¿ç¨‹æ± " class="headerlink" title="Nginxçº¿ç¨‹æ± "></a>Nginxçº¿ç¨‹æ± </h3><p>â€‹        <code>Nginx</code> çš„æœ€å¤§ä½œç”¨å°±æ˜¯åšè´Ÿè½½å‡è¡¡ï¼Œè¿›è¡Œè¯·æ±‚çš„åˆ†å‘ï¼Œä¸è¦åšIOï¼Œä¸è¦åšå…¶ä»–ä»»ä½•åˆ†å CPUå’Œå†…å­˜çš„äº‹æƒ…ï¼Œåªåšè´Ÿè½½åˆ†å‘ï¼Œ<code>Nginx</code>æœ¬èº«è®¾è®¡å¾—ä¹Ÿå¾ˆå¥½ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ¥è¿‘CPUåŸç”Ÿçš„çº¿ç¨‹å¹¶å‘å³°å€¼ï¼Œå¥½çš„æœåŠ¡å™¨é…ç½®å¥½çš„è¯ï¼Œåº”è¯¥3ç§’å†…å¹¶å‘ä¸ªå‡ åƒæ²¡ä»€ä¹ˆé—®é¢˜ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸€ä¸‹<code>Nginx</code>çš„å¸¸ç”¨çš„é…ç½®ï¼Œä»¥åŠå¦‚ä½•è®¾ç½®å¹¶å‘?<br>å…¶å®Nginxé‡Œé¢æ²¡æœ‰ç»™å®šçº¿ç¨‹æ± çš„ç›¸å…³æ¦‚å¿µå’Œé…ç½®,ä½†æ˜¯å¦‚æœä¸ºäº†ä»¥é˜²ä¸‡ä¸€çš„è¯ï¼Œå¯ä»¥æ³¨æ„å¦‚ä¸‹å‚æ•°:<br>â€‹        (1ï¼‰<code>ngx_http_limit_req_module</code>æ¨¡å—ï¼ˆ0.7.21) å¯ä»¥é€šè¿‡å®šä¹‰çš„é”®å€¼æ¥é™åˆ¶è¯·æ±‚å¤„ç†çš„é¢‘ç‡ã€‚ç‰¹åˆ«åœ°ï¼Œå®ƒå¯ä»¥é™åˆ¶æ¥è‡ªå•ä¸ª<strong>IP</strong>åœ°å€çš„è¯·æ±‚å¤„ç†é¢‘ç‡ã€‚é™åˆ¶çš„æ–¹æ³•æ˜¯é€šè¿‡ä¸€ç§â€œ<strong>æ¼æ¡¶</strong>â€çš„æ–¹æ³•<strong>â€”â€”</strong>å›ºå®šæ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°ï¼Œæ¨è¿Ÿè¿‡å¤šçš„è¯·æ±‚å¤„ç†ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">è¯­æ³•<span class="token operator">:</span>limit_req zone<span class="token operator">=</span>name <span class="token punctuation">[</span>burst<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>nodelay<span class="token punctuation">]</span><span class="token punctuation">;</span>
é»˜è®¤å€¼<span class="token operator">:</span><span class="token operator">-</span>
ä¸Šä¸‹æ–‡<span class="token operator">:</span>http<span class="token punctuation">,</span> server<span class="token punctuation">,</span> location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        è®¾ç½®å¯¹åº”çš„å…±äº«å†…å­˜é™åˆ¶åŸŸå’Œå…è®¸è¢«å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é˜ˆå€¼ã€‚å¦‚æœè¯·æ±‚çš„é¢‘ç‡è¶…è¿‡äº†é™åˆ¶åŸŸé…ç½®çš„å€¼ï¼Œè¯·æ±‚å¤„ç†ä¼šè¢«å»¶è¿Ÿï¼Œæ‰€ä»¥ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯ä»¥å®šä¹‰çš„é¢‘ç‡è¢«å¤„ç†çš„ã€‚è¶…è¿‡é¢‘ç‡é™åˆ¶çš„è¯·æ±‚ä¼šè¢«å»¶è¿Ÿ,ç›´åˆ°è¢«å»¶è¿Ÿçš„è¯·æ±‚æ•°è¶…è¿‡äº†å®šä¹‰çš„é˜ˆå€¼ï¼Œè¿™æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šè¢«ç»ˆæ­¢,å¹¶è¿”å›503(Service Temporarily Unavailableï¼‰é”™è¯¯ã€‚è¿™ä¸ªé˜ˆå€¼çš„é»˜è®¤å€¼ç­‰äº0ã€‚æ¯”å¦‚ä¸‹é¢è¿™äº›æŒ‡ä»¤:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">limit_req_zone $binary_remote_addr zone<span class="token operator">=</span>one<span class="token operator">:</span><span class="token number">10</span>m rate<span class="token operator">=</span><span class="token number">3000</span>r<span class="token operator">/</span>s<span class="token punctuation">;</span>
server <span class="token punctuation">&#123;</span>
    location <span class="token operator">/</span>search<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    	limit_req zone<span class="token operator">=</span>one burst<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é™åˆ¶å¹³å‡æ¯ç§’ä¸è¶…è¿‡3000ä¸€ä¸ªè¯·æ±‚ï¼ŒåŒæ—¶å…è®¸è¶…è¿‡é¢‘ç‡é™åˆ¶çš„è¯·æ±‚æ•°ä¸å¤šäº100ä¸ªã€‚</p>
<p>â€‹        å¦‚æœä¸å¸Œæœ›è¶…è¿‡çš„è¯·æ±‚è¢«å»¶è¿Ÿï¼Œå¯ä»¥ç”¨<code>nodelay</code>å‚æ•°:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">limit_req zone<span class="token operator">=</span>one burst<span class="token operator">=</span><span class="token number">100</span> nodelay<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>â€‹        (2) <code>ngx_http_limit_conn_module</code>æ¨¡å—å¯ä»¥æŒ‰ç…§å®šä¹‰çš„é”®é™å®šæ¯ä¸ªé”®å€¼çš„è¿æ¥æ•°ã€‚ç‰¹åˆ«åœ°ï¼Œå¯ä»¥è®¾å®šå•ä¸€<strong>IP</strong>æ¥æºçš„è¿æ¥æ•°ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„è¿æ¥éƒ½ä¼šè¢«æ¨¡å—è®¡æ•°ï¼Œåªæœ‰é‚£äº›æ­£åœ¨è¢«å¤„ç†çš„è¯·æ±‚(è¿™äº›è¯·æ±‚çš„å¤´ä¿¡æ¯å·²è¢«å®Œå…¨è¯»å…¥ï¼‰æ‰€åœ¨çš„è¿æ¥æ‰ä¼šè¢«è®¡æ•°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">è¯­æ³•<span class="token operator">:</span>limit_conn zone number<span class="token punctuation">;</span>
é»˜è®¤å€¼<span class="token operator">:</span><span class="token operator">-</span>
ä¸Šä¸‹æ–‡<span class="token operator">:</span>http<span class="token punctuation">,</span> server<span class="token punctuation">,</span> location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        æŒ‡å®šä¸€å—å·²ç»è®¾å®šçš„å…±äº«å†…å­˜ç©ºé—´ï¼Œä»¥åŠæ¯ä¸ªç»™å®šé”®å€¼çš„æœ€å¤§è¿æ¥æ•°ã€‚å½“è¿æ¥æ•°è¶…è¿‡æœ€å¤§è¿æ¥æ•°æ—¶ï¼ŒæœåŠ¡å™¨å°†ä¼šè¿”å›<code>503(Service Temporarily Unavailable)</code>é”™è¯¯ã€‚æ¯”å¦‚ï¼Œä¸‹é¢é…ç½®ä¸ä»…ä¼šé™åˆ¶å•ä¸€<strong>IP</strong>æ¥æºçš„è¿æ¥æ•°ï¼ŒåŒæ—¶ä¹Ÿä¼šé™åˆ¶å•ä¸€è™šæ‹ŸæœåŠ¡å™¨çš„æ€»è¿æ¥æ•°:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">limit_conn_zone $binary_remote_addr zone<span class="token operator">=</span>perip<span class="token operator">:</span><span class="token number">10</span>m<span class="token punctuation">;</span>
limit_conn_zone $server_name zone<span class="token operator">=</span>perserver<span class="token operator">:</span><span class="token number">10</span>m<span class="token punctuation">;</span>
server <span class="token punctuation">&#123;</span>
	<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
    limit conn perip <span class="token number">10</span><span class="token punctuation">;</span>
    limit_conn perserver <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        ä¸Šé¢è¿™ä¸ªé…ç½®è¡¨ç¤º,åŒä¸€PåŒä¸€æ—¶é—´åªå…è®¸æœ‰<strong>10</strong>ä¸ªè¿æ¥ã€‚å•ä¸€è™šæ‹ŸæœåŠ¡å™¨çš„æ€»è¿æ¥æ•°<strong>200</strong>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ç§çº¿ç¨‹æ± çš„å±€é™æ€§ã€‚çº¿ç¨‹æ± é…ç½®å¥½ä»¥åï¼Œç°åœ¨çš„å¹¶å‘è¯·æ±‚å±€é™å°±æ˜¯<strong>Nginx</strong>æœåŠ¡å™¨äº†ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬æ€ä¹ˆåšåˆ°æ·˜å®ã€äº¬ä¸œã€æºç¨‹é‚£ç§å¤§å¹¶å‘çš„æ•°é‡çº§åˆ«å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ä¸‹é¢ä¸¤ç§åšæ³•:<br>â€‹        ç¬¬ä¸€ç§ï¼šé«˜å¯Œå¸…çš„ç©æ³•ï¼Œå°±æ˜¯æœ€å¸¸è§çš„æŠ•å…¥æˆæœ¬ï¼Œè§æ•ˆå¿«ï¼Œè¿ç»´ç®€å•çš„A10ã€F5çš„ç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨ï¼Œç›´æ¥è¿›è¡Œè¯·æ±‚è½¬å‘ã€‚è¿™æ—¶å€™åŸºæœ¬ä¸Šä¸éœ€è¦<strong>Nginx</strong>ï¼Œç›´æ¥åˆ°åå°<strong>Server</strong>äº†ã€‚å½“ç„¶äº†åŠ <strong>Nginx</strong>æ›´å¥½ï¼Œå¯ä»¥å†æ‰©å¤§<strong>Nå€</strong>ã€‚<br>â€‹        ç¬¬äºŒç§ï¼šå±ä¸çº§çš„ç©æ³•ï¼Œå°±æ˜¯é€šè¿‡åŸŸåè§£æï¼Œå»ºç«‹å¾ˆå¤šå­åŸŸåï¼Œä¸åŒçš„ä¸šåŠ¡æ¨¡å—ç”±åŸŸååˆ†å‘åˆ°ä¸åŒçš„<strong>Nginx</strong>çš„æœåŠ¡å™¨ä¸Šé¢å»ï¼Œæ¯ä¸ª <strong>Nginx</strong>å†éƒ½é…ç½®ä¸Šå†…å®¹åˆ†å‘ç½‘ç»œ(<strong>CDN</strong>),å®è¡Œé™æ€åˆ†ç¦»,å°½é‡ç»™<strong>Nginx</strong>æœåŠ¡å™¨å‡å°‘è´Ÿæ‹…ã€‚è¿™ç§é…ç½®åŸºæœ¬ä¸Šå¯ä»¥è§£å†³å¾ˆå¤šä¸­å°å‹å…¬å¸çš„é—®é¢˜ã€‚</p>
<h3 id="æ•°æ®åº“è¿æ¥æ± "><a href="#æ•°æ®åº“è¿æ¥æ± " class="headerlink" title="æ•°æ®åº“è¿æ¥æ± "></a>æ•°æ®åº“è¿æ¥æ± </h3><p>â€‹        å…¶å®æˆ‘ä»¬è¯´äº†è¿™ä¹ˆå¤šçš„çº¿ç¨‹å’Œçº¿ç¨‹æ± ,æ•°æ®åº“è¿æ¥æ± ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>â€‹        <strong>(1ï¼‰ä»€ä¹ˆæ˜¯è¿æ¥</strong><br>â€‹        è¿æ¥ï¼Œæ˜¯æˆ‘ä»¬çš„ç¼–ç¨‹è¯­è¨€ä¸æ•°æ®åº“äº¤äº’çš„ä¸€ç§æ–¹å¼ã€‚æˆ‘ä»¬ç»å¸¸ä¼šå¬åˆ°è¿™ä¹ˆä¸€å¥è¯â€œ<strong>æ•°æ®åº“è¿æ¥å¾ˆæ˜‚è´µ</strong>â€ã€‚æœ‰äººæ¥å—è¿™ç§è¯´æ³•ï¼Œå´ä¸çŸ¥é“å®ƒçš„çœŸæ­£å«ä¹‰ã€‚å› æ­¤ï¼Œä¸‹é¢æˆ‘å°†è§£é‡Šå®ƒç©¶ç«Ÿæ˜¯ä»€ä¹ˆ(å¦‚æœä½ å·²ç»çŸ¥é“äº†ï¼Œä½ å¯ä»¥è·³åˆ°å®ƒçš„å·¥ä½œåŸç†éƒ¨åˆ†ï¼‰ã€‚<br>â€‹        <strong>(2ï¼‰åˆ›å»ºè¿æ¥çš„ä»£ç ç‰‡æ®µ:</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">string connUrl <span class="token operator">=</span> <span class="token string">"jdbc:mysql://your.database.domain/yourDBname"</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span>getConnection <span class="token punctuation">(</span>connUrl<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>â€‹        å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <strong>Connection</strong>å¯¹è±¡,å®ƒåœ¨å†…éƒ¨éƒ½æ‰§è¡Œäº†ä»€ä¹ˆï¼š</p>
<ul>
<li><strong>DriverManager</strong>æ£€æŸ¥å¹¶æ³¨å†Œé©±åŠ¨ç¨‹åºã€‚</li>
<li><code>com.mysql.jdbc.Driver</code>å°±æ˜¯æˆ‘ä»¬æ³¨å†Œäº†çš„é©±åŠ¨ç¨‹åºï¼Œå®ƒä¼šåœ¨é©±åŠ¨ç¨‹åºç±»ä¸­è°ƒç”¨<code>connect(url..)</code>æ–¹æ³•ã€‚</li>
<li><code>com.mysql.jdbc.Driver</code>çš„ <code>connect</code>æ–¹æ³•æ ¹æ®æˆ‘ä»¬è¯·æ±‚çš„<strong>connUrl</strong>ï¼Œåˆ›å»ºä¸€ä¸ª <strong>Socket</strong>è¿æ¥ï¼Œè¿æ¥åˆ°<strong>IP</strong>ä¸º<code>your.database.domain</code>ï¼Œé»˜è®¤ç«¯å£<strong>3306</strong>çš„æ•°æ®åº“ã€‚</li>
<li>åˆ›å»ºçš„<strong>Socket</strong>è¿æ¥å°†è¢«ç”¨æ¥æŸ¥è¯¢æˆ‘ä»¬æŒ‡å®šçš„æ•°æ®åº“ï¼Œå¹¶æœ€ç»ˆè®©ç¨‹åºè¿”å›å¾—åˆ°ä¸€ä¸ªç»“æœã€‚</li>
</ul>
<p>â€‹        <strong>(3ï¼‰ä¸ºä»€ä¹ˆæ˜‚è´µ</strong><br>â€‹        ç°åœ¨è®©æˆ‘ä»¬è°ˆè°ˆä¸ºä»€ä¹ˆè¯´å®ƒâ€œ<strong>æ˜‚è´µ</strong>â€ã€‚å¦‚æœåˆ›å»º<strong>Socket</strong>è¿æ¥èŠ±è´¹çš„æ—¶é—´æ¯”å®é™…çš„æ‰§è¡ŒæŸ¥è¯¢çš„æ“ä½œæ‰€èŠ±è´¹çš„æ—¶é—´è¿˜è¦æ›´é•¿ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„â€œ<strong>æ•°æ®åº“è¿æ¥å¾ˆæ˜‚è´µ</strong>â€ï¼Œå› ä¸ºè¿æ¥èµ„æºæ•°æ˜¯<strong>1</strong>ï¼Œå®ƒéœ€è¦æ¯æ¬¡åˆ›å»ºä¸€ä¸ª<strong>Socket</strong>è¿æ¥æ¥è®¿é—®<strong>DB</strong>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿æ¥æ± ã€‚è¿æ¥æ± åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€å®šæ•°é‡çš„è¿æ¥ï¼Œç„¶åä»è¿æ¥æ± ä¸­é‡ç”¨è¿æ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</p>
<p>â€‹        <strong>(4ï¼‰ä¸ºä»€ä¹ˆåœ¨è¿æ¥æ•°æ®åº“æ—¶è¦ä½¿ç”¨è¿æ¥æ± </strong><br>â€‹        <strong>æ•°æ®åº“è¿æ¥æ˜¯ä¸€ç§å…³é”®çš„ã€æœ‰é™çš„æ˜‚è´µèµ„æºï¼Œè¿™ä¸€ç‚¹åœ¨å¤šç”¨æˆ·çš„ç½‘é¡µåº”ç”¨ç¨‹åºä¸­ä½“ç°å¾—å°¤ä¸ºçªå‡º</strong>ã€‚ä¸€ä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡å‡å¯¹åº”ä¸€ä¸ªç‰©ç†æ•°æ®åº“è¿æ¥ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ‰“å¼€ä¸€ä¸ªç‰©ç†è¿æ¥ï¼Œä½¿ç”¨å®Œéƒ½å…³é—­è¿æ¥ï¼Œè¿™æ ·é€ æˆç³»ç»Ÿçš„æ€§èƒ½ä½ä¸‹ã€‚æ•°æ®åº“è¿æ¥æ± çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å»ºç«‹è¶³å¤Ÿçš„æ•°æ®åº“è¿æ¥ï¼Œå¹¶æŠŠè¿™äº›è¿æ¥ç»„æˆä¸€ä¸ªè¿æ¥æ± (ç®€å•è¯´å°±æ˜¯åœ¨ä¸€ä¸ªâ€œ<strong>æ± </strong>â€é‡Œæ”¾äº†å¥½å¤šåŠæˆå“çš„æ•°æ®åº“è”æ¥å¯¹è±¡ï¼‰ï¼Œç”±åº”ç”¨ç¨‹åºåŠ¨æ€åœ°å¯¹æ± ä¸­çš„è¿æ¥è¿›è¡Œç”³è¯·ã€ä½¿ç”¨å’Œé‡Šæ”¾ã€‚å¯¹äºå¤šäºè¿æ¥æ± ä¸­è¿æ¥æ•°çš„å¹¶å‘è¯·æ±‚,åº”è¯¥åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…ã€‚å¹¶ä¸”åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®æ± ä¸­è¿æ¥çš„ä½¿ç”¨ç‡ï¼ŒåŠ¨æ€å¢åŠ æˆ–å‡å°‘æ± ä¸­çš„è¿æ¥æ•°ã€‚è¿æ¥æ± æŠ€æœ¯å°½å¯èƒ½å¤šåœ°é‡ç”¨äº†æ¶ˆè€—å†…å­˜çš„èµ„æºï¼Œå¤§å¤§èŠ‚çœäº†å†…å­˜ï¼Œæé«˜äº†æœåŠ¡å™¨çš„æœåŠ¡æ•ˆç‡ï¼Œèƒ½å¤Ÿæ”¯æŒæ›´å¤šçš„å®¢æˆ·æœåŠ¡ã€‚é€šè¿‡ä½¿ç”¨è¿æ¥æ± ï¼Œå°†å¤§å¤§æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶è‡ªèº«çš„ç®¡ç†æœºåˆ¶æ¥ç›‘è§†æ•°æ®åº“è¿æ¥çš„æ•°é‡ã€ä½¿ç”¨æƒ…å†µç­‰ã€‚<br>â€‹        <strong>(5ï¼‰æ•°æ®åº“è¿æ¥æ± çš„åŸºæœ¬åŸç†</strong><br>â€‹        æ•°æ®åº“è¿æ¥æ± çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸ºæ•°æ®åº“è¿æ¥å»ºç«‹ä¸€ä¸ªâ€œ<strong>ç¼“å†²æ± </strong>â€ã€‚é¢„å…ˆåœ¨ç¼“å†²æ± ä¸­æ”¾å…¥ä¸€å®šæ•°é‡çš„è¿æ¥ï¼Œå½“éœ€è¦å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶ï¼Œåªéœ€ä»â€œ<strong>ç¼“å†²æ± </strong>â€ä¸­å–å‡ºä¸€ä¸ªï¼Œä½¿ç”¨å®Œæ¯•ä¹‹åå†æ”¾å›å»ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾å®šè¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼Œæ¥é˜²æ­¢ç³»ç»Ÿæ— å°½åœ°ä¸æ•°æ®åº“è¿æ¥ã€‚æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿æ¥æ± çš„ç®¡ç†æœºåˆ¶ç›‘è§†æ•°æ®åº“çš„è¿æ¥æ•°é‡ã€ä½¿ç”¨æƒ…å†µï¼Œä¸ºç³»ç»Ÿå¼€å‘ã€æµ‹è¯•åŠæ€§èƒ½è°ƒæ•´æä¾›ä¾æ®ã€‚<br>â€‹        <strong>(6)è¿æ¥æ± çš„å·¥ä½œåŸç†ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆåˆ†åˆ«ä¸ºè¿æ¥æ± çš„å»ºç«‹ã€è¿æ¥æ± ä¸­è¿æ¥çš„ä½¿ç”¨ç®¡ç†ã€è¿æ¥æ± çš„å…³é—­ã€‚</strong></p>
<p>â€‹         ç¬¬ä¸€ï¼Œè¿æ¥æ± çš„å»ºç«‹ã€‚ä¸€èˆ¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œè¿æ¥æ± ä¼šæ ¹æ®ç³»ç»Ÿé…ç½®å»ºç«‹ï¼Œå¹¶åœ¨æ± ä¸­åˆ›å»ºäº†å‡ ä¸ªè¿æ¥å¯¹è±¡ï¼Œä»¥ä¾¿ä½¿ç”¨æ—¶èƒ½ä»è¿æ¥æ± ä¸­è·å–ã€‚è¿æ¥æ± ä¸­çš„è¿æ¥ä¸èƒ½éšæ„åˆ›å»ºå’Œå…³é—­ï¼Œè¿™æ ·é¿å…äº†è¿æ¥éšæ„å»ºç«‹å’Œå…³é—­é€ æˆçš„ç³»ç»Ÿå¼€é”€ã€‚Javaä¸­æä¾›äº†å¾ˆå¤šå®¹å™¨ç±»å¯ä»¥æ–¹ä¾¿åœ°æ„å»ºè¿æ¥æ± ï¼Œä¾‹å¦‚<code>Vector</code>ã€<code>Stack</code>ç­‰ã€‚<br>â€‹        ç¬¬äºŒï¼Œè¿æ¥æ± çš„ç®¡ç†ã€‚è¿æ¥æ± ç®¡ç†ç­–ç•¥æ˜¯è¿æ¥æ± æœºåˆ¶çš„æ ¸å¿ƒï¼Œè¿æ¥æ± å†…è¿æ¥çš„åˆ†é…å’Œé‡Šæ”¾å¯¹ç³»ç»Ÿçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚å…¶ç®¡ç†ç­–ç•¥æ˜¯ï¼šå½“å®¢æˆ·è¯·æ±‚æ•°æ®åº“è¿æ¥æ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹è¿æ¥æ± ä¸­æ˜¯å¦æœ‰ç©ºé—²è¿æ¥ï¼Œå¦‚æœå­˜åœ¨ç©ºé—²è¿æ¥ï¼Œåˆ™å°†è¿æ¥åˆ†é…ç»™å®¢æˆ·ä½¿ç”¨ï¼›å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œåˆ™æŸ¥çœ‹å½“å‰æ‰€å¼€çš„è¿æ¥æ•°æ˜¯å¦å·²ç»è¾¾åˆ°æœ€å¤§è¿æ¥æ•°ï¼Œå¦‚æœæ²¡è¾¾åˆ°å°±é‡æ–°åˆ›å»ºä¸€ä¸ªè¿æ¥ç»™è¯·æ±‚çš„å®¢æˆ·ï¼›å¦‚æœè¾¾åˆ°å°±æŒ‰è®¾å®šçš„æœ€å¤§ç­‰å¾…æ—¶é—´è¿›è¡Œç­‰å¾…ï¼Œå¦‚æœè¶…å‡ºæœ€å¤§ç­‰å¾…æ—¶é—´,åˆ™æŠ›å‡ºå¼‚å¸¸ç»™å®¢æˆ·ã€‚<br>â€‹        å½“å®¢æˆ·é‡Šæ”¾æ•°æ®åº“è¿æ¥æ—¶ï¼Œå…ˆåˆ¤æ–­è¯¥è¿æ¥çš„å¼•ç”¨æ¬¡æ•°æ˜¯å¦è¶…è¿‡äº†è§„å®šå€¼ï¼Œå¦‚æœè¶…è¿‡å°±ä»è¿æ¥æ± ä¸­åˆ é™¤è¯¥è¿æ¥ï¼Œå¦åˆ™ä¿ç•™ä¸ºå…¶ä»–å®¢æˆ·æœåŠ¡ã€‚<br>â€‹        è¯¥ç­–ç•¥ä¿è¯äº†æ•°æ®åº“è¿æ¥çš„æœ‰æ•ˆå¤ç”¨ï¼Œé¿å…é¢‘ç¹åœ°å»ºç«‹ã€é‡Šæ”¾è¿æ¥æ‰€å¸¦æ¥çš„ç³»ç»Ÿèµ„æºå¼€é”€ã€‚<br>â€‹        ç¬¬ä¸‰ï¼Œè¿æ¥æ± çš„å…³é—­ã€‚å½“åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ï¼Œå…³é—­è¿æ¥æ± ä¸­æ‰€æœ‰çš„è¿æ¥ï¼Œé‡Šæ”¾è¿æ¥æ± ç›¸å…³çš„èµ„æº,è¯¥è¿‡ç¨‹æ­£å¥½ä¸åˆ›å»ºç›¸åã€‚</p>
<p>â€‹         (7ï¼‰å¾ˆå¤šå›½å†…Javaå¼€å‘äººå‘˜éƒ½æ¨èä½¿ç”¨<strong>Alibaba</strong>é›†å›¢å¼€å‘äººå‘˜å¼€å‘çš„å¼€æºé¡¹ç›®<strong>Druid</strong>ï¼Œå®˜æ–¹è¯´æ˜¯<strong>Java</strong>è¯­è¨€ä¸­æœ€å¥½çš„æ•°æ®åº“è¿æ¥æ± ã€‚<strong>Druid</strong> èƒ½å¤Ÿæä¾›å¼ºå¤§çš„ç›‘æ§å’Œæ‰©å±•åŠŸèƒ½ã€‚<br>â€‹        ä»¥ä¸‹æ˜¯ä¸€ä¸ªé…ç½®**_DruidDataSource**å‚è€ƒçš„è¿æ¥æ± é…ç½®ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;bean id&#x3D;&quot;dataSource&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method&#x3D;&quot;init&quot; destroy-method&#x3D;&quot;close&quot;&gt; 
	 &lt;!--åŸºæœ¬å±æ€§url,userã€ password--&gt;
    &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;jdbc_url&#125;&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;jdbc_user&#125;&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;jdbc_password&#125;&quot; &#x2F;&gt;

 &lt;!--é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filters --&gt;
    &lt;property name&#x3D;&quot;filters&quot; value&#x3D;&quot;stat&quot; &#x2F;&gt;

 &lt;--é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§--&gt;
    &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;1&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;1&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;20&quot; &#x2F;&gt;
    &lt;!--é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´--&gt;
    &lt;property name&#x3D;&quot;maxWait&quot; value&#x3D;&quot;6000&quot; &#x2F;&gt;

 &lt;!--é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯ms--&gt;
    &lt;property name&#x3D;&quot;timeBetweenEvictionRunsMillis&quot; value&#x3D;&quot;60000&quot; &#x2F;&gt;
    &lt;!-- é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´,å•ä½æ˜¯ms --&gt;
    &lt;property name&#x3D;&quot;minEvictableIdleTimeMillis&quot; value&#x3D;&quot;300000&quot; &#x2F;&gt;

    &lt;property name&#x3D;&quot;testWhileIdle&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;testOnBorrow&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;testOnReturn&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;

 &lt;!--æ‰“å¼€ PSCache,å¹¶ä¸”æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°--&gt;
    &lt;property name&#x3D;&quot;poolPreparedStatements&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;
    &lt;property name&#x3D;&quot;maxOpenPreparedStatements&quot; value&#x3D;&quot;20&quot; &#x2F;&gt;

    &lt;property name&#x3D;&quot;asyncInit&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;
&lt;&#x2F;bean&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>â€‹        é€šå¸¸æ¥è¯´ï¼Œåªéœ€è¦ä¿®æ”¹<code>initialSize</code>ã€<code>minldle</code>ã€<code>maxActive</code>ã€‚<br>â€‹        å¦‚æœç”¨<strong>Oracle</strong>ï¼Œåˆ™æŠŠ <code>poolPreparedStatements</code> é…ç½®ä¸º<strong>true</strong>ï¼Œ<strong>MySQL</strong>å¯ä»¥é…ç½®ä¸º <strong>false</strong>ã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šçš„æ•°æ®åº“,å»ºè®®é…ç½®ä¸º <strong>false</strong>ã€‚<br>â€‹        (8ï¼‰æˆ‘ä»¬å¦‚æœæŸ¥çœ‹ä¸€ä¸‹<code>com.alibaba.druid.pool.DruidDataSource</code>çš„æºç çš„è¯,ç‰›äººä»¬ä¹Ÿä¸å¤–ä¹ä½¿ç”¨äº†<code>CountDownLatch</code>åšçº¿ç¨‹é˜€ï¼Œ<code>AtomicLong</code>çš„é«˜å¹¶å‘åŸå­å˜é‡ï¼Œ<code>ReentrantLock</code>æ˜¾ç¤ºå—çŠ¶ çº¿ç¨‹é”ï¼Œ<code>volatile</code>å…³é”®å­—åšé«˜å¹¶å‘çš„å¯è¯»å˜é‡ï¼Œ<code>DruidConnectionHolder[] connections</code>å‚¨å­˜è¿æ¥é˜Ÿåˆ—ï¼Œ<code>ThreadLocal</code> åšçº¿ç¨‹å®‰å…¨çš„å‰¯æœ¬ã€‚</p>
<h3 id="å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°é«˜å¹¶å‘"><a href="#å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°é«˜å¹¶å‘" class="headerlink" title="å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°é«˜å¹¶å‘"></a>å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°é«˜å¹¶å‘</h3><p>â€‹        åœ¨å·¥ä½œä¸­ï¼Œå¦‚ä½•åˆ†å¸ƒç³»ç»Ÿï¼Œå¦‚ä½•å®ç°é«˜å¹¶å‘ç³»ç»Ÿçš„å‰ææ¡ä»¶å°±æ˜¯:</p>
<ul>
<li><strong>äº†è§£ä½ çš„ç‰©ç†æœºå™¨</strong></li>
<li><strong>äº†è§£ä½ çš„ä¸šåŠ¡</strong></li>
<li><strong>äº†è§£ä½ çš„ç¨‹åº</strong></li>
</ul>
<p>â€‹        è¯´åˆ°æœ€åå°±æ˜¯ä¸€å¥<strong>æ‹†åˆ†ï¼Œå†æ‹†åˆ†</strong>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è®²ä¸€äº›<strong>æ‹†åˆ†çš„åŸåˆ™</strong>ã€‚é¦–å…ˆåˆ†æä»»åŠ¡ç‰¹æ€§ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥è¿›è¡Œåˆ†æ:</p>
<ol>
<li><strong>ä»»åŠ¡çš„æ€§è´¨ï¼šCPU(è®¡ç®—å¯†é›†å‹)ä»»åŠ¡ï¼ŒIO(ç½‘ç»œIOï¼ŒDBï¼Œç£ç›˜IOç­‰ï¼‰å¯†é›†å‹ä»»åŠ¡,å†…å­˜æ¶ˆè€—æ€§ã€‚</strong></li>
<li><strong>ä»»åŠ¡çš„å¹¶å‘æ•°é‡ï¼šè¶…çº§å¤§å¹¶å‘ï¼Œå¤§å¹¶å‘ï¼Œä¸­ç­‰é‡ï¼Œå¾ˆå°‘äººè®¿é—®ç­‰ã€‚</strong></li>
<li><strong>ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼šé•¿ï¼Œä¸­ï¼ŒçŸ­ã€‚</strong></li>
<li><strong>ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼šé«˜ï¼Œä¸­ï¼Œä½ã€‚</strong></li>
<li><strong>ä»»åŠ¡çš„ä¾èµ–æ€§ï¼šæ˜¯å¦ä¾èµ–å…¶ä»–ç³»ç»Ÿèµ„æºï¼Œå¦‚æ•°æ®åº“è¿æ¥ï¼Œä¸šåŠ¡æµç¨‹ä¹‹é—´æ˜¯å¦äº’ç›¸ä¾èµ–ç­‰ã€‚</strong></li>
<li><strong>æŒ‰ç…§èµ„æºæ€§è´¨ï¼šé™æ€èµ„æºï¼ŒåŠ¨æ€èµ„æºã€‚</strong></li>
<li><strong>ä¸šåŠ¡ä¹‹é—´çš„è€¦åˆæ€§ï¼šè€¦åˆåº¦é«˜ï¼Œå¯è§£è€¦ï¼Œæ²¡æœ‰è€¦åˆã€‚</strong></li>
</ol>
<p>â€‹        å½“æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„ä¸šåŠ¡å’Œä»»åŠ¡æœ‰äº†å…¨é¢çš„è®¤è¯†ä¹‹åï¼Œå°±å¯ä»¥åˆç†åœ°é…ç½®çº¿ç¨‹æ± ï¼Œä»è€Œå®ç°é«˜å¯ç”¨ã€é«˜å¹¶å‘,åŸåˆ™å¦‚ä¸‹ï¼š</p>
<p>â€‹        (1)  ä»»åŠ¡æ€§è´¨ä¸åŒçš„ä»»åŠ¡å¯ä»¥ç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± åˆ†å¼€å¤„ç†ã€‚CPU å¯†é›†å‹ä»»åŠ¡é…ç½®å°½å¯èƒ½å°çš„çº¿ç¨‹ï¼Œå¦‚é…ç½®<code>N cpu+1</code>ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚IOå¯†é›†å‹ä»»åŠ¡åˆ™ç”±äºçº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡,åˆ™é…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚<code>2*Ncpu</code>ã€‚æ··åˆå‹çš„ä»»åŠ¡ï¼Œå¦‚æœå¯ä»¥æ‹†åˆ†ï¼Œåˆ™å°†å…¶æ‹†åˆ†æˆä¸€ä¸ªCPUå¯†é›†å‹ä»»åŠ¡å’Œä¸€ä¸ªIOå¯†é›†å‹ä»»åŠ¡ï¼Œåªè¦è¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ç›¸å·®ä¸æ˜¯å¤ªå¤§ï¼Œé‚£ä¹ˆåˆ†è§£åæ‰§è¡Œçš„ååç‡è¦é«˜äºä¸²è¡Œæ‰§è¡Œçš„ååç‡ï¼Œå¦‚æœè¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›¸å·®å¤ªå¤§ï¼Œåˆ™æ²¡å¿…è¦è¿›è¡Œåˆ†è§£ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Runtime.getRuntime().availableProcessors()</code>æ–¹æ³•è·å¾—å½“å‰è®¾å¤‡çš„CPUä¸ªæ•°ã€‚<br>â€‹        (2ï¼‰ä¼˜å…ˆçº§ä¸åŒçš„ä»»åŠ¡å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ— <code>PriorityBlockingQueue</code>æ¥å¤„ç†ã€‚å®ƒå¯ä»¥è®©ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡å…ˆå¾—åˆ°æ‰§è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ç›´æœ‰ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—é‡Œï¼Œé‚£ä¹ˆä¼˜å…ˆçº§ä½çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œã€‚<br>â€‹        (3ï¼‰æ‰§è¡Œæ—¶é—´ä¸åŒçš„ä»»åŠ¡å¯ä»¥äº¤ç»™ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—,è®©æ‰§è¡Œæ—¶é—´çŸ­çš„ä»»åŠ¡å…ˆæ‰§è¡Œã€‚<br>â€‹        (4ï¼‰ä¾èµ–æ•°æ®åº“è¿æ¥æ± çš„ä»»åŠ¡ï¼Œå› ä¸ºçº¿ç¨‹æäº¤SQLåéœ€è¦ç­‰å¾…æ•°æ®åº“è¿”å›ç»“æœ,å¦‚æœç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼ŒCPUç©ºé—²æ—¶é—´å°±è¶Šé•¿ï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°åº”è¯¥è®¾ç½®è¶Šå¤§ï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½åœ°åˆ©ç”¨CPU.<br>â€‹        (5ï¼‰å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—,æœ‰ç•Œé˜Ÿåˆ—èƒ½å¢åŠ ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œé¢„è­¦èƒ½åŠ›,å¯ä»¥æ ¹æ®éœ€è¦è®¾å¤§ä¸€ç‚¹ï¼Œæ¯”å¦‚å‡ åƒã€‚æœ‰ä¸€æ¬¡æˆ‘ä»¬ç»„ä½¿ç”¨çš„åå°ä»»åŠ¡çº¿ç¨‹æ± çš„é˜Ÿåˆ—å’Œçº¿ç¨‹æ± å…¨æ»¡äº†ï¼Œä¸æ–­åœ°æŠ›å‡ºæŠ›å¼ƒä»»åŠ¡çš„å¼‚å¸¸ï¼Œé€šè¿‡æ’æŸ¥å‘ç°æ˜¯æ•°æ®åº“å‡ºç°äº†é—®é¢˜ï¼Œå¯¼è‡´æ‰§è¡Œ<strong>SQL</strong>å˜å¾—éå¸¸ç¼“æ…¢ï¼Œå› ä¸ºåå°ä»»åŠ¡çº¿ç¨‹æ± é‡Œçš„ä»»åŠ¡å…¨æ˜¯éœ€è¦å‘æ•°æ®åº“æŸ¥è¯¢å’Œæ’å…¥æ•°æ®çš„ï¼Œæ‰€ä»¥å¯¼è‡´çº¿ç¨‹æ± é‡Œçš„å·¥ä½œçº¿ç¨‹å…¨éƒ¨é˜»å¡ä½ï¼Œä»»åŠ¡ç§¯å‹åœ¨çº¿ç¨‹æ± é‡Œã€‚å¦‚æœå½“æ—¶æˆ‘ä»¬è®¾ç½®æˆæ— ç•Œé˜Ÿåˆ—ï¼Œçº¿ç¨‹æ± çš„é˜Ÿåˆ—å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œæœ‰å¯èƒ½ä¼šæ’‘æ»¡å†…å­˜ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ï¼Œè€Œä¸åªæ˜¯åå°ä»»åŠ¡å‡ºç°é—®é¢˜ã€‚å½“ç„¶æˆ‘ä»¬çš„ç³»ç»Ÿæ‰€æœ‰çš„ä»»åŠ¡æ˜¯ç”¨çš„å•ç‹¬çš„æœåŠ¡å™¨éƒ¨ç½²çš„ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± è·‘ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œä½†æ˜¯å‡ºç°è¿™æ ·é—®é¢˜æ—¶ä¹Ÿä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡ã€‚<br>â€‹        å¯¹æœåŠ¡çš„å†…å®¹ï¼Œè¿›è¡Œåˆ†æå®Œäº†ä¹‹åï¼Œå°±åº”è¯¥åŠæ—¶è¿›è¡Œéƒ¨ç½²åˆ†ç¦»ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ï¼Œéƒ¨ç½²åˆ†ç¦»çš„ä¸€äº›åŸåˆ™æœ‰:</p>
<ol>
<li><strong>æ¸ é“åˆ†ç¦»ï¼šå¦‚æ— çº¿å®¢æˆ·ç«¯ï¼ŒPCç«¯ï¼ŒAPIæ¥å£ç­‰ã€‚</strong></li>
<li><strong>è¿è¥å•†çš„åˆ†ç¦»ï¼šå¦‚ç”µä¿¡ï¼Œè”é€šï¼Œæ•™è‚²ï¼Œæµ·å¤–æœåŠ¡å™¨ç­‰ã€‚</strong></li>
<li><strong>æœåŠ¡å†…å®¹åˆ’åˆ†ï¼šå¦‚æ–‡å­—æ€§çš„ï¼Œå›¾ç‰‡ï¼Œè§†é¢‘ï¼Œä¸‹è½½ç­‰æœåŠ¡çš„å†…å®¹ã€‚</strong></li>
<li><strong>æŒ‰ç…§è®¿é—®å¯†é›†å‹æ€§åˆ’åˆ†ï¼šå¦‚é«˜å¹¶å‘çš„å’Œä½å¹¶å‘çš„å¯ä»¥åˆ†å¼€éƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ã€‚</strong></li>
<li><strong>æŒ‰ç…§ä¸åŒä¸šåŠ¡çº¿è¿›è¡Œåˆ’åˆ†ï¼šå¦‚å‰å°é¡¹ç›®ï¼ŒBBSï¼Œåå°ç®¡ç†é¡¹ç›®ç­‰ã€‚</strong></li>
</ol>
<p>â€‹        æœ€åï¼Œåœ¨ä½ å…¨é¢äº†è§£ä½ çš„ä¸šåŠ¡ï¼Œä½ çš„<strong>Server</strong>ï¼Œä½ çš„ç¨‹åºçš„åŸºç¡€ä¸Šé€šè¿‡åˆ†å‘é…ç½®ï¼Œè¿˜æœ‰çº¿ç¨‹æ± çš„è¿‡è½½æœºåˆ¶é…ç½®ï¼Œè¿™ä¸ªæ—¶å€™ä½ å°±å¯ä»¥åšåˆ°æ³°å±±å´©äºå‰è€Œè‰²ä¸å˜ï¼Œéº‹é¹¿å…´äºå·¦è€Œç›®ä¸ç¬äº†ã€‚</p>
<h2 id="çº¿ç¨‹çš„ç›‘æ§åŠå…¶æ—¥å¸¸å·¥ä½œä¸­å¦‚ä½•åˆ†æ"><a href="#çº¿ç¨‹çš„ç›‘æ§åŠå…¶æ—¥å¸¸å·¥ä½œä¸­å¦‚ä½•åˆ†æ" class="headerlink" title="çº¿ç¨‹çš„ç›‘æ§åŠå…¶æ—¥å¸¸å·¥ä½œä¸­å¦‚ä½•åˆ†æ"></a>çº¿ç¨‹çš„ç›‘æ§åŠå…¶æ—¥å¸¸å·¥ä½œä¸­å¦‚ä½•åˆ†æ</h2><blockquote>
<p><strong>é¸Ÿæ¬²é«˜é£å…ˆæŒ¯ç¿…,äººæ±‚ä¸Šè¿›å…ˆè¯»ä¹¦ã€‚</strong></p>
</blockquote>
<p><img src="/image/Concurrent/Concurrent40.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent40.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        çœ‹ä¸åˆ°ä¸ç­‰äºä¸å­˜åœ¨!è®©æˆ‘ä»¬æ¥çœ‹çœ‹å·¥ä½œä¸­æ˜¯å¦‚ä½•æ‰¾é—®é¢˜è§£å†³é—®é¢˜çš„ã€‚</p>
<h3 id="Javaçº¿ç¨‹æ± çš„ç›‘æ§"><a href="#Javaçº¿ç¨‹æ± çš„ç›‘æ§" class="headerlink" title="Javaçº¿ç¨‹æ± çš„ç›‘æ§"></a>Javaçº¿ç¨‹æ± çš„ç›‘æ§</h3><p>â€‹        å¦‚æœæƒ³å®ç°çº¿ç¨‹æ± çš„ç›‘æ§ï¼Œéœ€è¦è‡ªå®šä¹‰çº¿ç¨‹æ± ç»§æ‰¿<code>ThreadPoolExecutor</code>ç±»ï¼Œå¹¶ä¸”å®ç°<code>beforeExecute</code>ã€<code>afterExecute</code>å’Œ <code>terminated</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå‰ã€æ‰§è¡Œåå’Œçº¿ç¨‹æ± å…³é—­å‰å¹²ä¸€äº›äº‹æƒ…ã€‚æ¯”å¦‚ï¼Œç›‘æ§ä»»åŠ¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´ï¼Œæœ€å¤§æ‰§è¡Œæ—¶é—´å’Œæœ€å°æ‰§è¡Œæ—¶é—´ç­‰ã€‚è¿™å‡ ä¸ªæ–¹æ³•åœ¨çº¿ç¨‹æ± é‡Œæ˜¯ç©ºæ–¹æ³•ã€‚è¯·çœ‹ä¸‹é¢ä»£ç :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//æ¯æ‰§è¡Œä¸€ä¸ªå·¥ä½œä»»åŠ¡çº¿ç¨‹ä¹‹å‰éƒ½ä¼šæ‰§è¡Œæ­¤å®ç°çš„æ–¹æ³•</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> beforeExecute <span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//t-æ”¾åœ¨çº¿ç¨‹æ± é‡Œé¢è¦æ‰§è¡Œçš„çº¿ç¨‹ã€‚</span>
    <span class="token comment">//r-å°†è¦æ‰§è¡Œè¿™ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± é‡Œé¢çš„å·¥ä½œçº¿ç¨‹ã€‚</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//æ¯æ‰§è¡Œä¸€ä¸ªå·¥ä½œä»»åŠ¡çº¿ç¨‹ä¹‹åéƒ½ä¼šæ‰§è¡Œçš„æ–¹æ³•</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> afterExecute <span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//r -å·²ç»è¿è¡Œç»“æŸçš„å·¥ä½œçº¿ç¨‹ã€‚</span>
    <span class="token comment">//t-è¿è¡Œå¼‚å¸¸ã€‚</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//çº¿ç¨‹æ± å…³é—­ä¹‹å‰å¯ä»¥å¹²ä¸€äº›äº‹æƒ…ã€‚</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">terminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çº¿ç¨‹æ± é‡Œæœ‰ä¸€äº›å±æ€§åœ¨ç›‘æ§çº¿ç¨‹æ± çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼š</p>
<ul>
<li><code>taskCount</code>ï¼šçº¿ç¨‹æ± éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚</li>
<li><code>completedTaskCount</code>ï¼šçº¿ç¨‹æ± åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ã€‚å°äºæˆ–ç­‰äº<code>taskCount</code>ã€‚</li>
<li><code>largestPoolSize</code>ï¼šçº¿ç¨‹æ± æ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡è¿™ä¸ªæ•°æ®å¯ä»¥çŸ¥é“çº¿ç¨‹æ± æ˜¯å¦æ»¡è¿‡ã€‚å¦‚ç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°,åˆ™è¡¨ç¤ºçº¿ç¨‹æ± æ›¾ç»æ»¡äº†ã€‚</li>
<li><code>getPoolSize</code>ï¼šçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ã€‚å¦‚æœçº¿ç¨‹æ± ä¸é”€æ¯çš„è¯ï¼Œæ± é‡Œçš„çº¿ç¨‹ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å°åªå¢ä¸å‡ã€‚</li>
<li><code>getActiveCount</code>ï¼šè·å–æ´»åŠ¨çš„çº¿ç¨‹æ•°ã€‚</li>
</ul>
<p>å¤§å®¶æƒ³ä¸€æƒ³å¦‚æœä½ æ¥å†™çš„è¯å¦‚ä½•å»å†™,æä¾›å®ä¾‹ <strong>demo</strong> å¦‚ä¸‹,æ…¢æ…¢ä½“ä¼šä¸€ä¸‹ï¼š</p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span> <span class="token class-name">Main</span> <span class="token class-name">End</span><span class="token operator">!</span>
work_task before<span class="token operator">:</span>pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span>
work_task before<span class="token operator">:</span>pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span>
work_task before<span class="token operator">:</span>pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span>
work_task after worker thread is <span class="token operator">:</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool<span class="token punctuation">.</span></span>MonitorThreadPoolExecutorDemo</span>$<span class="token number">1</span><span class="token annotation punctuation">@1f80458e</span>
work_task after worker thread is <span class="token operator">:</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool<span class="token punctuation">.</span></span>MonitorThreadPoolExecutorDemo</span>$<span class="token number">1</span><span class="token annotation punctuation">@3888163e</span>
work_task after worker thread is <span class="token operator">:</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrl<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>threadpool<span class="token punctuation">.</span></span>MonitorThreadPoolExecutorDemo</span>$<span class="token number">1</span><span class="token annotation punctuation">@671c4961</span>
terminated getCorePoolSize<span class="token operator">:</span><span class="token number">5</span>ï¼›getPoolSize<span class="token operator">:</span><span class="token number">0</span>ï¼›getTaskCount<span class="token operator">:</span><span class="token number">3</span>ï¼›getCompletedTaskCount<span class="token operator">:</span><span class="token number">3</span>ï¼›getLargestPoolSize<span class="token operator">:</span><span class="token number">3</span>ï¼›getActiveCount<span class="token operator">:</span><span class="token number">0</span>
<span class="token class-name">ThreadPoolExecutor</span> terminated<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="ForkJoinå¦‚ä½•ç›‘æ§"><a href="#ForkJoinå¦‚ä½•ç›‘æ§" class="headerlink" title="ForkJoinå¦‚ä½•ç›‘æ§"></a>ForkJoinå¦‚ä½•ç›‘æ§</h3><p>â€‹        å…¶å® <code>ForkJoin</code>çš„ç›‘æ§ä¸åƒ <code>ThreadPoolExecutor</code>é‚£æ ·æä¾›äº†<code>before</code>å’Œ <code>after</code>çš„æ–¹æ³•ï¼Œåªæ˜¯<code>ForkJoinPool</code>æä¾›äº†ä¸€äº›å¯ä»¥æŸ¥é˜…å…¶çŠ¶æ€ä¿¡æ¯çš„æ–¹æ³•,å¦‚ä¸‹:</p>
<ul>
<li><code>getPoolSize()</code>ï¼šæ­¤æ–¹æ³•è¿”å›<strong>int</strong>å€¼å®ƒæ˜¯<code>ForkJoinPool</code>å†…éƒ¨çº¿ç¨‹æ± çš„<code>worker </code>çº¿ç¨‹ä»¬çš„æ•°é‡ã€‚</li>
<li><code>getParallelism()</code>ï¼šæ­¤æ–¹æ³•è¿”å›æ± çš„å¹¶è¡Œçš„çº§åˆ«ã€‚</li>
<li><code>getActiveThreadCount()</code>ï¼šæ­¤æ–¹æ³•è¿”å›å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹çš„æ•°é‡ã€‚</li>
<li><code>getRunningThreadCount()</code>ï¼šæ­¤æ–¹æ³•è¿”å›æ²¡æœ‰è¢«ä»»ä½•åŒæ­¥æœºåˆ¶é˜»å¡çš„æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹ã€‚</li>
<li><code>getQueuedSubmissionCount()</code>ï¼šæ­¤æ–¹æ³•è¿”å›å·²ç»æäº¤ç»™æ± è¿˜æ²¡æœ‰å¼€å§‹ä»–ä»¬çš„æ‰§è¡Œçš„ä»»åŠ¡æ•°ã€‚</li>
<li><code>getQueuedTaskCount()</code>ï¼šæ­¤æ–¹æ³•è¿”å›å·²ç»æäº¤ç»™æ± å·²ç»å¼€å§‹å®ƒä»¬çš„æ‰§è¡Œçš„ä»»åŠ¡æ•°ã€‚</li>
<li><code>hasQueuedSubmissions()</code>ï¼šæ­¤æ–¹æ³•è¿”å›<strong>Boolean</strong>å€¼ï¼Œè¡¨æ˜è¿™ä¸ªæ± æ˜¯å¦æœ‰<code>queued</code>ä»»åŠ¡è¿˜æ²¡æœ‰å¼€å§‹å®ƒä»¬çš„æ‰§è¡Œã€‚</li>
<li><code>getStealCount()</code>ï¼šæ­¤æ–¹æ³•è¿”å› <strong>long</strong> å€¼ï¼Œ<code>worker</code> çº¿ç¨‹å·²ç»ä»å¦ä¸€ä¸ªçº¿ç¨‹å·å–åˆ°çš„æ—¶é—´æ•°ã€‚</li>
<li><code>isTerminated()</code>ï¼šæ­¤æ–¹æ³•è¿”å› <strong>Boolean</strong>å€¼ï¼Œè¡¨æ˜ <code>fork/join</code>æ± æ˜¯å¦å·²ç»å®Œæˆæ‰§è¡Œã€‚<br>    ä»¥ä¸Šæ–¹æ³•æ›´æœ‰åŠ©äºæˆ‘ä»¬å¼€å‘è¿‡ç¨‹ä¸­æ›´åŠ äº†è§£ä½ çš„<code>forkjoin</code>çš„è®¾è®¡æ˜¯å¦åˆç†ã€‚<br>    å…¶å®ï¼Œå®ç°è¿™æ ·çš„ç›‘æ§æ¯”è¾ƒç®€å•äº†ï¼Œå¤§å®¶å†™ä¸€ä¸ªè¯•è¯•ã€‚ç®€å•æ¥çœ‹ä¸€ä¸‹ <strong>Demo</strong>ï¼Œæˆ‘ä»¬å°†ForkJoinTaskDemo ä¾‹å­ä¿®æ”¹å¦‚ä¸‹ï¼Œå¢åŠ ä¸€ä¸ª<code>showLog</code>æ–¹æ³•ç”¨æ¥æ˜¾ç¤ºç›‘æ§çš„ä¿¡æ¯:</li>
</ul>
<p>è¿è¡Œç»“æœå¦‚ä¸‹:</p>
<h3 id="Javaå†…å­˜ç»“æ„"><a href="#Javaå†…å­˜ç»“æ„" class="headerlink" title="Javaå†…å­˜ç»“æ„"></a>Javaå†…å­˜ç»“æ„</h3><p>â€‹        åé¢æˆ‘ä»¬ä¼šè®²åˆ°çº¿ç¨‹<strong>Dump</strong> çš„åˆ†æï¼Œé‚£å°±ä¸å¾—ä¸å¯¹<strong>Java</strong>é‡Œé¢çš„<strong>å†…å­˜ç»“æ„</strong>æœ‰ä¸€å®šçš„äº†è§£ã€‚å…¶å®å¯¹äºJavaç¨‹åºå‘˜æ¥è¯´ï¼Œ<strong>åœ¨è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶(è¿™ç§æœºåˆ¶åˆç§°ä¸ºåƒåœ¾å›æ”¶æœºåˆ¶ã€garbagecollectorã€GC)çš„å¸®åŠ©ä¸‹ï¼Œä¸å†éœ€è¦æ˜¾å¼åœ°ä¸ºæ¯ä¸€ä¸ªnewæ“ä½œå»åˆ†é…å†…å­˜ï¼Œå›æ”¶å†…å­˜ï¼Œè€Œä¸”é€šå¸¸æƒ…å†µä¸å®¹æ˜“å‡ºç°å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºé—®é¢˜ï¼Œçœ‹èµ·æ¥ç”±è™šæ‹Ÿæœºç®¡ç†å†…å­˜ä¸€åˆ‡éƒ½å¾ˆç¾å¥½</strong>ã€‚ä¸è¿‡ï¼Œåœ¨é«˜å¹¶å‘çš„å¼€å‘æ¨¡å¼ä¸‹ï¼Œä¸çŸ¥ä¸è§‰å°±ä¼šæµªè´¹å¾ˆå¤šå†…å­˜ï¼Œå¯¼è‡´çš„åæœå°±æ˜¯<strong>GC</strong>å›æ”¶æ‰§è¡Œæ—¶é—´å¤ªé¢‘ç¹ï¼Œå†…å­˜æ³„éœ²ï¼Œè¿›è€Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºJavaç¨‹åºå‘˜æŠŠå†…å­˜æ§åˆ¶çš„æƒåŠ›äº¤ç»™äº†Javaè™šæ‹Ÿæœºï¼Œä¸€æ—¦å‡ºç°å†…å­˜æ³„æ¼å’Œæº¢å‡ºæ–¹é¢çš„é—®é¢˜ï¼Œå¦‚æœä¸äº†è§£è™šæ‹Ÿæœºæ˜¯æ€æ ·ä½¿ç”¨å†…å­˜çš„ï¼Œé‚£æ’æŸ¥é”™è¯¯å°†ä¼šæˆä¸ºä¸€é¡¹å¼‚å¸¸è‰°éš¾çš„å·¥ä½œã€‚</p>
<h4 id="1-JVMçš„å†…å­˜ç»“æ„"><a href="#1-JVMçš„å†…å­˜ç»“æ„" class="headerlink" title="1.JVMçš„å†…å­˜ç»“æ„"></a>1.JVMçš„å†…å­˜ç»“æ„</h4><p>â€‹        <strong>JVM çš„å†…å­˜ç»“æ„å…¶å®å¤§ä½“ä¸Šåˆ†æˆäº†è¿™ä¹ˆå‡ ä¸ªéƒ¨åˆ†ï¼šç¨‹åºè®¡æ•°å™¨ã€JVMæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€å…±äº«å †ã€æ–¹æ³•åŒºã€‚</strong>å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/image/Concurrent/Concurrent41.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent41.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>â€‹        (1ï¼‰ç¨‹åºè®¡æ•°å™¨ï¼šæ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå…¶ä½œç”¨å¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨å­—èŠ‚ç è§£æå™¨å·¥ä½œæ—¶,é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚Javaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´ç‰‡æ¥å®ç°ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹æŒ‡ä»¤ï¼Œå› æ­¤ï¼Œä¸ºäº†ç¡®ä¿çº¿ç¨‹åˆ‡æ¢ä¹‹åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå› æ­¤ï¼Œç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰çš„å†…å­˜ã€‚ç¨‹åºè®¡æ•°å™¨æ˜¯Javaè™šæ‹Ÿæœºä¸­å”¯ä¸€ä¸€ä¸ªæ²¡æœ‰è§„å®šä»»ä½•å†…å­˜æº¢å‡º<code>OutOfMemoryError</code>çš„å†…å­˜åŒºåŸŸã€‚<br>â€‹        (2ï¼‰<strong>JVM</strong>æ ˆï¼šJavaè™šæ‹Ÿæœºæ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹:æ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶éƒ½ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥å’Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆè¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚Javaè™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘å™¨å¯çŸ¥çš„8ç§JavaåŸºæœ¬ç±»å‹æ•°æ®ã€å¯¹è±¡å¼•ç”¨(æ³¨æ„ä¸æ˜¯å¯¹è±¡å®ä¾‹æœ¬èº«)ã€æ–¹æ³•è¿”å›åœ°å€<code>returnAddress</code>ã€‚å±€éƒ¨å˜é‡è¡¨æ‰€éœ€å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æœŸé—´å®Œæˆåˆ†é…ï¼Œå½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•éœ€è¦åœ¨å¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚Javaè™šæ‹Ÿæœºæ ˆæœ‰ä¸¤ç§å¼‚å¸¸çŠ¶å†µ:å¦‚æœå•çº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦æ—¶ï¼ŒæŠ›å‡º <code>StackOverflowError</code> å¼‚å¸¸;å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•,å½“æ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜æ—¶ä¼šæŠ›å‡º <code>OutOfMemoryError</code> å¼‚å¸¸ã€‚<br>â€‹        (3ï¼‰æœ¬åœ°æ–¹æ³•æ ˆ:æœ¬åœ°æ–¹æ³•æ ˆä¸Javaè™šæ‹Ÿæœºæ ˆä½œç”¨éå¸¸ç±»ä¼¼ï¼Œå…¶åŒºåˆ«æ˜¯: java è™šæ‹Ÿæœºæ ˆæ˜¯ä¸ºè™šæ‹Ÿæœºæ‰§è¡Œjavaæ–¹æ³•æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºè™šæ‹Ÿæœºè°ƒç”¨çš„æ“ä½œç³»ç»Ÿæœ¬åœ°æ–¹æ³•æœåŠ¡ã€‚Javaè™šæ‹Ÿæœºè§„èŒƒæ²¡æœ‰å¯¹æœ¬åœ°æ–¹æ³•æ ˆçš„å®ç°å’Œæ•°æ®ç»“æ„åšå¼ºåˆ¶è§„å®šï¼Œ<code>Sun HotSpot</code>è™šæ‹Ÿæœºç›´æ¥æŠŠJavaè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆåˆäºŒä¸ºä¸€ã€‚<br>â€‹        (4)å…±äº«å †:å †æ˜¯ javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜åŒºåŸŸä¸­æœ€å¤§ä¸€å—ï¼ŒJavaå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹æ‰€å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸ,åœ¨Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå †å†…å­˜çš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ã€‚å‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨å †åˆ†é…å†…å­˜ã€‚Javaå †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œä»åƒåœ¾å›æ”¶çš„è§’åº¦çœ‹ï¼Œç”±äºç°åœ¨çš„åƒåœ¾æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨çš„æ˜¯åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œå› æ­¤Javaå †è¿˜å¯ä»¥åˆæ­¥ç»†åˆ†ä¸ºæ–°ç”Ÿä»£å’Œå¹´è€ä»£ã€‚Javaè™šæ‹Ÿæœºè§„èŒƒè§„å®šï¼Œå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯ã€‚åœ¨å®ç°ä¸Šæ—¢å¯ä»¥æ˜¯å›ºå®šå¤§å°çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯åŠ¨æ€æ‰©å±•çš„ã€‚å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…,å¹¶ä¸”å †å¤§å°ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶,å°†ä¼šæŠ›å‡º<code>OutOfMemoryError</code> å¼‚å¸¸ã€‚<br>â€‹        (5)æ–¹æ³•åŒº:æ–¹æ³•åŒºä¸å †ä¸€æ ·ï¼Œæ˜¯è¢«å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚è™½ç„¶ Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯æ–¹æ³•åŒºå´æœ‰ä¸€ä¸ªåˆ«åå«<code>Non-Heap</code>(éå †)ã€‚<br>â€‹        <strong>Sun HotSpotè™šæ‹Ÿæœº</strong>æŠŠæ–¹æ³•åŒºå«<strong>æ°¸ä¹…ä»£</strong>(<code>Permanent Generation</code>)ï¼Œæ–¹æ³•åŒºä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ã€‚Classæ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢å˜é‡ã€ç¬¦å·å¼•ç”¨ã€ç›´æ¥å¼•ç”¨ç­‰ï¼Œè¿™äº›å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­,å¦å¤–åœ¨è¿è¡ŒæœŸé—´ä¹Ÿå¯ä»¥å°†æ–°çš„å¸¸é‡å­˜æ”¾åˆ°å¸¸é‡æ± ä¸­ã€‚<br>â€‹        å…¶å®ï¼Œæˆ‘æ›´æ„¿æ„å°†å®ƒåˆ†ä¸ºå †å’Œæ ˆä¸¤éƒ¨åˆ†æ¥çœ‹å¾…ã€‚Javaè™šæ‹Ÿæœºå†…å­˜ç»“æ„ä¸­çš„ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆè¿™ä¸‰ä¸ªåŒºåŸŸéšçº¿ç¨‹åˆ›å»ºè€Œç”Ÿï¼Œéšçº¿ç¨‹é”€æ¯è€Œç­ï¼Œå› æ­¤è¿™ä¸‰ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶æ˜¯ç¡®å®šçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œè€ŒJavaè™šæ‹Ÿæœºçš„å †å†…å­˜å’Œæ–¹æ³•åŒºå†…å­˜æ˜¯é€šè¿‡åƒåœ¾å›æ”¶æœºåˆ¶ä¸‰ä»£å…³ç³»æ¥å®Œæˆçš„,æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´ä¸€ä¸‹ã€‚</p>
<h4 id="2-JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#2-JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="2.JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶"></a>2.JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶</h4><p>â€‹        é’ˆå¯¹åƒåœ¾å›æ”¶ç®—æ³•å°†<strong>JVM</strong>ä¸­å †å’Œéå †ç©ºé—´åˆ’åˆ†ä¸ºä¸‰ä¸ªä»£ï¼š<strong>å¹´è½»ä»£(Young Generation)ã€å¹´è€ä»£(Old Generation)å’Œæ°¸ä¹…ä»£(Permanent Generation)<strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</strong>å¹´è½»ä»£å’Œè€å¹´ä»£å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„å…±äº«å †</strong>,<strong>å¹´è½»å¸¦ä¸»è¦æ˜¯åŠ¨æ€çš„å­˜å‚¨ï¼Œå¹´è½»å¸¦ä¸»è¦å‚¨å­˜æ–°äº§ç”Ÿçš„å¯¹è±¡ï¼›å¹´è€ä»£å‚¨å­˜å¹´é¾„å¤§äº›çš„å¯¹è±¡ï¼›æ°¸ä¹…å¸¦å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„æ–¹æ³•åŒºï¼Œä¸»è¦å­˜å‚¨çš„æ˜¯Javaçš„ç±»ä¿¡æ¯ï¼ŒåŒ…æ‹¬è§£æå¾—åˆ°çš„æ–¹æ³•ã€å±æ€§ã€å­—æ®µç­‰ï¼Œæ°¸ä¹…å¸¦åŸºæœ¬ä¸å‚ä¸åƒåœ¾å›æ”¶ã€‚</strong>æ‰€ä»¥æˆ‘ä»¬è¯´çš„åƒåœ¾å›æ”¶ä¸»è¦æ˜¯é’ˆå¯¹å¹´è½»ä»£å’Œå¹´è€ä»£ã€‚<br>â€‹        å¹´è½»ä»£åˆåˆ†æˆ3ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ª<strong>eden</strong>åŒºå’Œä¸¤ä¸ªç›¸åŒçš„<strong>survivor</strong> åŒºã€‚åˆšå¼€å§‹åˆ›å»ºçš„å¯¹è±¡éƒ½æ˜¯æ”¾ç½®åœ¨<strong>eden</strong>åŒºçš„ã€‚åˆ†æˆè¿™æ ·3ä¸ªéƒ¨åˆ†ï¼Œ<strong>ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡å°½é‡ç•™åœ¨å¹´è½»å¸¦</strong>ã€‚å½“<strong>eden</strong>åŒºç”³è¯·ä¸åˆ°ç©ºé—´çš„æ—¶å€™ï¼Œè¿›è¡Œ<strong>minorGC</strong>,æŠŠå­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ° <strong>survivor</strong>ã€‚</p>
<p><img src="/image/Concurrent/Concurrent42.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent42.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¹´è€ä»£ä¸»è¦å­˜æ”¾ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿çš„å¯¹è±¡ï¼Œæ¯”å¦‚ç¼“å­˜å¯¹è±¡ã€‚</p>
<h4 id="3-JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹"><a href="#3-JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹" class="headerlink" title="3.JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹"></a>3.JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹</h4><p>â€‹        <strong>JVM</strong>å†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹æè¿°å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¹è±¡åœ¨<strong>Eden</strong> åŒºå®Œæˆå†…å­˜åˆ†é…ã€‚</li>
<li>å½“ <strong>Eden</strong>åŒºæ»¡äº†ï¼Œå†åˆ›å»ºå¯¹è±¡ï¼Œä¼šå› ä¸ºç”³è¯·ä¸åˆ°ç©ºé—´ï¼Œè§¦å‘<strong>minorGC</strong>ï¼Œè¿›è¡Œ **young( eden+1survivor)**åŒºçš„åƒåœ¾å›æ”¶ã€‚</li>
<li><strong>minorGC</strong> æ—¶ï¼Œ<strong>Eden</strong>ä¸èƒ½è¢«å›æ”¶çš„å¯¹è±¡è¢«æ”¾å…¥åˆ°ç©ºçš„ <strong>survivor</strong> (<strong>Eden</strong>è‚¯å®šä¼šè¢«æ¸…ç©º)ï¼Œå¦ä¸€ä¸ª<strong>survivor</strong>é‡Œä¸èƒ½è¢«<strong>GC</strong>å›æ”¶çš„å¯¹è±¡ä¹Ÿä¼šè¢«æ”¾å…¥è¿™ä¸ª<strong>survivor</strong>ï¼Œå§‹ç»ˆä¿è¯ä¸€ä¸ª<strong>survivor</strong>æ˜¯ç©ºçš„</li>
<li>å½“åšç¬¬3æ­¥çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°<strong>survivor</strong>æ»¡äº†ï¼Œåˆ™è¿™äº›å¯¹è±¡è¢«<strong>copy</strong>åˆ°<strong>old</strong> åŒºï¼Œæˆ–è€…<strong>survivor</strong>å¹¶æ²¡æœ‰æ»¡ï¼Œä½†æ˜¯æœ‰äº›å¯¹è±¡å·²ç»è¶³å¤Ÿ<strong>Old</strong>ï¼Œä¹Ÿè¢«æ”¾å…¥<strong>Old</strong> åŒº **<code>XX:MaxTenuringThreshold</code>**ã€‚</li>
<li>å½“<strong>Old</strong>åŒºè¢«æ”¾æ»¡ä¹‹åï¼Œè¿›è¡Œ<strong>fullGC</strong>ã€‚</li>
</ol>
<p>ä¸‹é¢å¯¹minorGCã€MajorGCã€FullGCåšä¸ªè¡¥å……è¯´æ˜ï¼š</p>
<ul>
<li><strong>MinorGC</strong>ï¼šå¹´è½»ä»£æ‰€è¿›è¡Œçš„åƒåœ¾å›æ”¶ï¼Œéå¸¸é¢‘ç¹,ä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚</li>
<li><strong>MajorGC</strong>ï¼šè€å¹´ä»£è¿›è¡Œçš„åƒåœ¾å›æ”¶ï¼Œå‘ç”Ÿä¸€æ¬¡ <strong>MajorGC</strong>è‡³å°‘ä¼´éšä¸€æ¬¡<strong>MinorGC</strong>ï¼Œä¸€èˆ¬æ¯”<strong>MinorGC</strong>é€Ÿåº¦æ…¢åå€ä»¥ä¸Šã€‚</li>
<li><strong>FullGC</strong>ï¼šæ•´ä¸ªå †å†…å­˜è¿›è¡Œçš„åƒåœ¾å›æ”¶ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯<strong>MajorGC</strong>.</li>
</ul>
<p>â€‹        <strong>MajorGC</strong>å’Œ<strong>FullGC</strong>æ˜¯æœ€è€—<strong>CPU</strong>çš„ï¼Œä¼šå½±å“ç¨‹åºçš„å“åº”ï¼Œæ‰€<strong>ä»¥è¦æ ¹æ®ç›¸åº”åŸåˆ™åˆç†è®¾ç½®å¹´è½»ä»£å’Œè€å¹´ä»£çš„å¤§å°ã€‚</strong>æ‰€ä»¥ç›‘æ§çš„æ—¶å€™å°±ä¼šå‘ç°å¹´è½»ä»£ä¼šæœ‰é¢‘ç¹çš„å›æ”¶ï¼Œè€Œ<strong>FullGC</strong>æ‰§è¡Œæ¬¡æ•°å¾ˆå°‘ã€‚<strong>ä¸€æ—¦FullGCé¢‘ç¹å‘ç”Ÿçš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå°±å¿«è¦å†…å­˜æº¢å‡ºäº†ã€‚</strong></p>
<h4 id="4-JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­å¯¹è±¡åˆ†é…çš„åŸåˆ™"><a href="#4-JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­å¯¹è±¡åˆ†é…çš„åŸåˆ™" class="headerlink" title="4.JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­å¯¹è±¡åˆ†é…çš„åŸåˆ™"></a>4.JVMå†…å­˜åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­å¯¹è±¡åˆ†é…çš„åŸåˆ™</h4><ol>
<li>å¯¹è±¡ä¼˜å…ˆåˆ†é…åœ¨<strong>Eden</strong>åŒºï¼Œå¦‚æœ<strong>Eden</strong>åŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ—¶ï¼Œè™šæ‹Ÿæœºæ‰§è¡Œä¸€æ¬¡<strong>Minor GC</strong>.</li>
<li>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£(å¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡)ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…åœ¨<strong>Eden</strong> åŒºå’Œä¸¤ä¸ª<strong>Survivor</strong>åŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜æ‹·è´ï¼ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•æ”¶é›†å†…å­˜)ã€‚</li>
<li>é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ã€‚<strong>è™šæ‹Ÿæœºä¸ºæ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨</strong>ï¼Œå¦‚æœå¯¹è±¡ç»è¿‡äº†<strong>1</strong>æ¬¡<strong>Minor GC</strong>ï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šè¿›å…¥<strong>Survivor</strong>åŒºï¼›ä¹‹åæ¯ç»è¿‡ä¸€æ¬¡<strong>Minor GC</strong>ï¼Œé‚£ä¹ˆå¯¹è±¡çš„å¹´é¾„åŠ <strong>1</strong>ï¼Œ<strong>ç›´åˆ°è¾¾åˆ°é˜€å€¼å¯¹è±¡è¿›å…¥è€å¹´åŒºã€‚</strong></li>
<li>åŠ¨æ€åˆ¤æ–­å¯¹è±¡çš„å¹´é¾„ã€‚å¦‚æœ <strong>Survivor</strong>åŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äº<strong>Survivor</strong>ç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£</li>
<li>ç©ºé—´åˆ†é…æ‹…ä¿ã€‚æ¯æ¬¡è¿›è¡Œ<strong>Minor GC</strong>æ—¶ï¼Œ<strong>JVM</strong>ä¼šè®¡ç®—<strong>Survivor</strong>åŒºç§»è‡³è€å¹´åŒºçš„å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœè¿™ä¸ªå€¼å¤§äºè€å¹´åŒºçš„å‰©ä½™å€¼å¤§å°ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡<strong>FullGC</strong>ï¼›å¦‚æœå°äºæ£€æŸ¥<strong>HandlePromotionFailure</strong>è®¾ç½®ï¼Œæ˜¯<strong>true</strong>åˆ™åªè¿›è¡Œ<strong>Minor GC</strong>ï¼Œæ˜¯ <strong>false</strong>åˆ™è¿›è¡Œ<strong>Full GC</strong>ã€‚</li>
</ol>
<h4 id="5-JVMå†…å­˜åƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦æœ‰ä¸‰ç§"><a href="#5-JVMå†…å­˜åƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦æœ‰ä¸‰ç§" class="headerlink" title="5.JVMå†…å­˜åƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦æœ‰ä¸‰ç§"></a>5.JVMå†…å­˜åƒåœ¾å›æ”¶æœºåˆ¶ä¸»è¦æœ‰ä¸‰ç§</h4><ul>
<li><strong>ä¸²è¡Œæ”¶é›†å™¨</strong>ï¼šä½¿ç”¨å•çº¿ç¨‹å¤„ç†æ‰€æœ‰åƒåœ¾å›æ”¶å·¥ä½œï¼Œå› ä¸ºæ— é¡»å¤šçº¿ç¨‹äº¤äº’,æ‰€ä»¥æ•ˆç‡æ¯”è¾ƒé«˜ã€‚</li>
<li><strong>å¹¶è¡Œæ”¶é›†å™¨</strong>ï¼šå¯¹å¹´è½»ä»£è¿›è¡Œå¹¶è¡Œåƒåœ¾å›æ”¶ï¼Œå› æ­¤å¯ä»¥å‡å°‘åƒåœ¾å›æ”¶æ—¶é—´ã€‚ä¸€èˆ¬åœ¨å¤šçº¿ç¨‹å¤šå¤„ç†å™¨æœºå™¨ä¸Šä½¿ç”¨ã€‚</li>
<li><strong>å¹¶å‘æ”¶é›†å™¨</strong>ï¼šå¯ä»¥ä¿è¯å¤§éƒ¨åˆ†å·¥ä½œéƒ½å¹¶å‘è¿›è¡Œ(åº”ç”¨ä¸åœæ­¢)ï¼Œåƒåœ¾å›æ”¶åªæš‚åœå¾ˆå°‘çš„æ—¶é—´,æ­¤æ”¶é›†å™¨é€‚åˆå¯¹å“åº”æ—¶é—´è¦æ±‚æ¯”è¾ƒé«˜çš„ä¸­ã€å¤§è§„æ¨¡åº”ç”¨ã€‚</li>
</ul>
<h4 id="6-å¸¸è§çš„å†…å­˜æº¢å‡ºçš„ä¸‰ç§æƒ…å†µ"><a href="#6-å¸¸è§çš„å†…å­˜æº¢å‡ºçš„ä¸‰ç§æƒ…å†µ" class="headerlink" title="6.å¸¸è§çš„å†…å­˜æº¢å‡ºçš„ä¸‰ç§æƒ…å†µ"></a>6.å¸¸è§çš„å†…å­˜æº¢å‡ºçš„ä¸‰ç§æƒ…å†µ</h4><ol>
<li><p><strong>JVM Heap(å †ï¼‰æº¢å‡º</strong>ï¼š<code>java.lang.OutOfMemoryError</code>: <strong>Java heap space</strong>.<br><strong>JVM</strong>åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è®¾ç½®<strong>JVM Heap</strong> çš„å€¼ï¼Œå¯ä»¥åˆ©ç”¨<strong>JVM</strong>æä¾›çš„<code>-Xmn</code> <code>-Xms</code> <code>-Xmx</code>ç­‰é€‰é¡¹è¿›è¡Œè®¾ç½®ã€‚<strong>Heap</strong>çš„å¤§å°æ˜¯<strong>Young Generation</strong>å’Œ<strong>Tenured Generaion</strong>ä¹‹å’Œã€‚åœ¨<strong>JVM</strong>ä¸­å¦‚æœ98%çš„æ—¶é—´æ˜¯ç”¨äº<strong>GC</strong>ï¼Œä¸”å¯ç”¨çš„<strong>Heap size</strong>ä¸è¶³**2%**çš„æ—¶å€™å°†æŠ›å‡ºæ­¤å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<blockquote>
<p><strong>è§£å†³æ–¹æ³•ï¼šæ‰‹åŠ¨è®¾ç½®JVM Heapï¼ˆå †)çš„å¤§å°ã€‚</strong></p>
</blockquote>
</li>
<li><p><strong>PermGen spaceæº¢å‡º</strong>ï¼š<code>java.lang.OutOfMemoryError</code>: <strong>PermGen space</strong>.<br><strong>PermGen space</strong>çš„å…¨ç§°æ˜¯<strong>Permanent Generation space</strong>ï¼Œæ˜¯æŒ‡å†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåŸŸã€‚ä¸ºä»€ä¹ˆä¼šå†…å­˜æº¢å‡ºï¼Œè¿™æ˜¯ç”±äºè¿™å—å†…å­˜ä¸»è¦æ˜¯è¢«<strong>JVM</strong>å­˜æ”¾<strong>Class</strong>å’Œ <strong>Meta</strong>ä¿¡æ¯çš„ï¼Œ<strong>Class</strong> åœ¨è¢«<strong>Load</strong>çš„æ—¶å€™è¢«æ”¾å…¥ <strong>PermGen space</strong>åŒºåŸŸï¼Œå®ƒå’Œå­˜æ”¾<strong>Instance</strong>çš„<strong>Heap</strong>åŒºåŸŸä¸åŒï¼Œ<strong>sun</strong>çš„<strong>GC</strong>ä¸ä¼šåœ¨ä¸»ç¨‹åºè¿è¡ŒæœŸå¯¹<strong>PermGen space</strong>è¿›è¡Œæ¸…ç†ï¼Œæ‰€ä»¥å¦‚æœä½ çš„APPä¼šè½½å…¥å¾ˆå¤šCLASSçš„è¯ï¼Œå°±å¾ˆå¯èƒ½å‡ºç°<strong>PermGen space</strong>æº¢å‡ºã€‚ä¸€èˆ¬å‘ç”Ÿåœ¨ç¨‹åºçš„å¯åŠ¨é˜¶æ®µã€‚</p>
<blockquote>
<p><strong>è§£å†³æ–¹æ³•ï¼šé€šè¿‡-XX:PermSizeå’Œ-XX:MaxPermSizeè®¾ç½®æ°¸ä¹…ä»£å¤§å°å³å¯ã€‚</strong> </p>
</blockquote>
</li>
<li><p><strong>æ ˆæº¢å‡º</strong>ï¼š<code>java.lang.StackOverflowError</code> : <strong>Thread Stack space</strong>ã€‚<br>æ ˆæº¢å‡ºäº†ï¼Œ<strong>JVM</strong>ä¾ç„¶æ˜¯é‡‡ç”¨æ ˆå¼çš„è™šæ‹Ÿæœºï¼Œè¿™ä¸ªå’ŒCå’Œ Pascaléƒ½æ˜¯ä¸€æ ·çš„ã€‚å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹éƒ½ä½“ç°åœ¨å †æ ˆå’Œé€€æ ˆä¸Šäº†ã€‚è°ƒç”¨æ„é€ å‡½æ•°çš„â€å±‚â€å¤ªå¤šäº†ï¼Œä»¥è‡´äºæŠŠæ ˆåŒºæº¢å‡ºäº†ã€‚é€šå¸¸æ¥è®²ï¼Œä¸€èˆ¬æ ˆåŒºè¿œè¿œå°äºå †åŒºçš„ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨è¿‡ç¨‹å¾€å¾€ä¸ä¼šå¤šäºä¸Šåƒå±‚ï¼Œè€Œå³ä¾¿æ¯ä¸ªå‡½æ•°è°ƒç”¨éœ€è¦<strong>1KB</strong>çš„ç©ºé—´(è¿™ä¸ªå¤§çº¦ç›¸å½“äºåœ¨ä¸€ä¸ªCå‡½æ•°å†…å£°æ˜äº†256ä¸ª<strong>int</strong>ç±»å‹çš„å˜é‡)ï¼Œé‚£ä¹ˆæ ˆåŒºä¹Ÿä¸è¿‡æ˜¯éœ€è¦<strong>1MB</strong>çš„ç©ºé—´ã€‚<strong>é€šå¸¸æ ˆçš„å¤§å°æ˜¯1~2MBçš„</strong>ã€‚é€šä¿—ä¸€ç‚¹è®²å°±æ˜¯å•çº¿ç¨‹çš„ç¨‹åºéœ€è¦çš„å†…å­˜å¤ªå¤§äº†ã€‚é€šå¸¸é€’å½’ä¹Ÿä¸è¦é€’å½’çš„å±‚æ¬¡è¿‡å¤šï¼Œå¾ˆå®¹æ˜“æº¢å‡ºã€‚</p>
<blockquote>
<p> <strong>è§£å†³æ–¹æ³•ï¼šä¿®æ”¹ç¨‹åºï¼Œæˆ–è€…é€šè¿‡-Xssæ¥è®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„Stackå¤§å°å³å¯ã€‚</strong> </p>
</blockquote>
</li>
<li><p>æ‰€ä»¥ <strong>Server</strong> å®¹å™¨å¯åŠ¨çš„æ—¶å€™æˆ‘ä»¬ç»å¸¸å…³å¿ƒå’Œè®¾ç½®<strong>JVM</strong>çš„å‡ ä¸ªå‚æ•°å¦‚ä¸‹(è¯¦ç»†çš„<strong>JVM</strong>å‚æ•°è¯·å‚çœ‹é™„å½•3):</p>
<ul>
<li><p>-<code>Xms</code>ï¼š<strong>java Heap</strong>åˆå§‹å¤§å°ï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1&#x2F;64ã€‚</p>
</li>
<li><p><code>-Xmx</code>ï¼š<strong>java Heap</strong>æœ€å¤§å€¼ï¼Œä¸å¯è¶…è¿‡ç‰©ç†å†…å­˜ã€‚</p>
</li>
<li><p><code>-Xmn</code>ï¼š <strong>young generation</strong>çš„ <strong>heap</strong> å¤§å°ï¼Œä¸€èˆ¬è®¾ç½®ä¸º<code>Xmx</code>çš„ä¸‰å››åˆ†ä¹‹ä¸€ã€‚å¢å¤§å¹´è½»ä»£åï¼Œå°†ä¼šå‡å°å¹´è€ä»£å¤§å°ï¼Œå¯ä»¥æ ¹æ®ç›‘æ§åˆç†è®¾ç½®ã€‚</p>
</li>
<li><p><code>-Xss</code>ï¼šæ¯ä¸ªçº¿ç¨‹çš„<strong>Stack</strong> å¤§å°ï¼Œè€Œæœ€ä½³å€¼åº”è¯¥æ˜¯<strong>128KB</strong>ï¼Œé»˜è®¤å€¼å¥½åƒæ˜¯<strong>512KB</strong></p>
</li>
<li><p><code>-XX:PermSize</code>ï¼šè®¾å®šå†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåˆå§‹å¤§å°ï¼Œç¼ºçœå€¼ä¸º<strong>64MB</strong>ã€‚</p>
</li>
<li><p><code>-XX:MaxPermSize</code>ï¼šè®¾å®šå†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºæœ€å¤§å¤§å°ï¼Œç¼ºçœå€¼ä¸º<strong>64MB</strong>ã€‚</p>
</li>
<li><p><code>-XX:SurvivorRatio</code>ï¼š <strong>Eden</strong> åŒºä¸<strong>Survivor</strong> åŒºçš„å¤§å°æ¯”å€¼ï¼Œè®¾ç½®ä¸º<strong>8</strong>ï¼Œåˆ™ä¸¤ä¸ª<strong>Survivor</strong>åŒºä¸ä¸€ä¸ª<strong>Eden</strong>åŒºçš„æ¯”å€¼ä¸º<strong>2:8</strong>ï¼Œä¸€ä¸ª <strong>Survivor</strong>åŒºå æ•´ä¸ªå¹´è½»ä»£çš„<strong>1&#x2F;10</strong>ã€‚</p>
</li>
<li><p><code>-XX:+UseParallelGC</code>ï¼š <strong>F</strong> å¹´è½»ä»£ä½¿ç”¨å¹¶å‘æ”¶é›†ï¼Œè€Œå¹´è€ä»£ä»æ—§ä½¿ç”¨ä¸²è¡Œæ”¶é›†ã€‚</p>
</li>
<li><p><code>-XX:+UseParNewGC</code>ï¼šè®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†ï¼Œ<strong>JDK5.0</strong>ä»¥ä¸Šï¼Œ<strong>JVM</strong>ä¼šæ ¹æ®ç³»ç»Ÿé…ç½®è‡ªè¡Œè®¾ç½®ï¼Œè€Œæ— é¡»å†è®¾ç½®æ­¤å€¼ã€‚</p>
</li>
<li><p><code>-XX:ParallelGCThreads</code>ï¼šå¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ï¼Œå€¼æœ€å¥½é…ç½®ä¸å¤„ç†å™¨æ•°ç›®ç›¸ç­‰ï¼ŒåŒæ ·é€‚ç”¨äº<strong>CMS</strong>ã€‚</p>
</li>
<li><p><code>-XX:+UseParallelOldGC</code>ï¼šå¹´è€ä»£åƒåœ¾æ”¶é›†æ–¹å¼ä¸ºå¹¶è¡Œæ”¶é›†( <strong>Parallel Compacting</strong> ) ã€‚</p>
</li>
<li><p><code>-XX:MaxGCPauseMillis</code>ï¼šæ¯æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶çš„æœ€é•¿æ—¶é—´(æœ€å¤§æš‚åœæ—¶é—´)ï¼Œå¦‚æœæ— æ³•æ»¡è¶³æ­¤æ—¶é—´ï¼Œ<strong>JVM</strong>ä¼šè‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£å¤§å°ï¼Œä»¥æ»¡è¶³æ­¤å€¼ã€‚</p>
</li>
<li><p><code>-XX:+ScavengeBeforeFullGC</code>ï¼š<strong>Full GC</strong>å‰è°ƒç”¨<strong>YGC</strong>ï¼Œé»˜è®¤æ˜¯<strong>true</strong>.</p>
<ul>
<li><p>å®ä¾‹å¦‚ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">JAVA_OPTS<span class="token operator">=</span><span class="token string">"-Xms4g -Xmx4g -Xmn1024m -XX:PermSize=320M -XX:MaxPermSize=320m -XX:SurvivorRatio=6"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="å¯è§†åŒ–ç›‘æ§å·¥å…·çš„ä½¿ç”¨"><a href="#å¯è§†åŒ–ç›‘æ§å·¥å…·çš„ä½¿ç”¨" class="headerlink" title="å¯è§†åŒ–ç›‘æ§å·¥å…·çš„ä½¿ç”¨"></a>å¯è§†åŒ–ç›‘æ§å·¥å…·çš„ä½¿ç”¨</h3><ul>
<li><strong>VisualVM</strong> åœ¨ <code>%JAVA_HOME%\bin\jvisualvm.exe</code> ï¼Œç‚¹å‡»å°±å¯ä»¥å¯åŠ¨<strong>VisualVM</strong>ã€‚</li>
<li><strong>JConsole</strong> åœ¨<code>%JAVA_HOME%\bin\jconsole.exe</code>ï¼Œç‚¹å‡»å°±å¯ä»¥å¯åŠ¨<strong>JConsole</strong>ã€‚</li>
<li><strong>Oracle Java Mission Control</strong> åœ¨<code>%JAVA_HOME%\bin\jmc.exe</code>ï¼Œç‚¹å‡»å°±å¯ä»¥å¯åŠ¨<strong>Oracle Java Mission Control</strong></li>
</ul>
<h3 id="å¦‚ä½•é€šè¿‡å‹åŠ›æµ‹è¯•æ¥æµ‹è¯•æœåŠ¡å™¨çš„æŠ—å‹èƒ½åŠ›"><a href="#å¦‚ä½•é€šè¿‡å‹åŠ›æµ‹è¯•æ¥æµ‹è¯•æœåŠ¡å™¨çš„æŠ—å‹èƒ½åŠ›" class="headerlink" title="å¦‚ä½•é€šè¿‡å‹åŠ›æµ‹è¯•æ¥æµ‹è¯•æœåŠ¡å™¨çš„æŠ—å‹èƒ½åŠ›"></a>å¦‚ä½•é€šè¿‡å‹åŠ›æµ‹è¯•æ¥æµ‹è¯•æœåŠ¡å™¨çš„æŠ—å‹èƒ½åŠ›</h3><ul>
<li><strong>JMeter</strong></li>
</ul>
<h3 id="MultithreadedTCæµ‹è¯•å¹¶å‘ä»‹ç»"><a href="#MultithreadedTCæµ‹è¯•å¹¶å‘ä»‹ç»" class="headerlink" title="MultithreadedTCæµ‹è¯•å¹¶å‘ä»‹ç»"></a>MultithreadedTCæµ‹è¯•å¹¶å‘ä»‹ç»</h3><p>â€‹        <strong>MultithreadedTC</strong>æ˜¯ä¸€ä¸ªJavaåº“ï¼Œç”¨æ¥æµ‹è¯•å¹¶å‘åº”ç”¨ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³å¹¶å‘åº”ç”¨çš„ä¸ç¡®å®šé—®é¢˜ï¼Œä½ ä¸èƒ½æ§åˆ¶å®ƒä»¬çš„æ‰§è¡Œé¡ºåºã€‚ä¸ºäº†è¿™ä¸ªç›®çš„ï¼Œå®ƒåŒ…å«äº†å†…éƒ¨èŠ‚æ‹å™¨æ¥æ§åˆ¶åº”ç”¨çš„ä¸åŒçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚è¿™äº›æµ‹è¯•çº¿ç¨‹ä½œä¸ºç±»çš„æ–¹æ³•æ¥å®ç°çš„ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸åšè¯¦ç»†è¯´æ˜ï¼Œåªæ˜¯å‘Šè¯‰å¤§å®¶æœ‰è¿™ä¸ªæµ‹è¯•åº“ï¼Œæ–¹ä¾¿å¤§å®¶ä»¥åå­¦ä¹ ä½¿ç”¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸ªä½¿ç”¨ <strong>MultithreadedTC</strong>åº“æ¥ä¸º<code>LinkedTransferQueue</code>å®ç°ä¸€ä¸ªæµ‹è¯•ã€‚<br>â€‹        è¿™ä¸ªåº“ä¾èµ–<code>junit-4.10.jar</code>å’Œ <code>MultithreadedTC-1.01.jar</code>ä¸¤ä¸ªjaråŒ…åº“ã€‚</p>
<p>â€‹        <strong>ProducerConsumerTest</strong>çš„ä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;1.   åˆ›å»ºä¸€ä¸ªç±»ï¼Œåä¸º ProducerConsumerTestï¼Œæ‰©å±• MultithreadedTestCase ç±»ã€‚
public class ProducerConsumerTest extends MultithreadedTestCase &#123;

&#x2F;&#x2F;2.   å£°æ˜ä¸€ä¸ªç§æœ‰ LinkedTransferQueue å±æ€§ï¼Œç”¨ String ç±»ä¸ºå‚æ•°ï¼Œåä¸º queueã€‚
private LinkedTransferQueue&lt;String&gt; queue;

&#x2F;&#x2F;3.   å®ç° initialize() æ–¹æ³•ã€‚æ­¤æ–¹æ³•ä¸æ¥æ”¶ä»»ä½•å‚æ•°ï¼Œä¹Ÿä¸è¿”å›ä»»ä½•å€¼ã€‚å®ƒè°ƒç”¨çˆ¶ç±»çš„ initialize() æ–¹æ³•ï¼Œç„¶ååˆå§‹åŒ– queue å±æ€§ã€‚
@Override
public void initialize() &#123;
	super.initialize();
	queue&#x3D;new LinkedTransferQueue&lt;String&gt;();
	System.out.printf(&quot;Test: The test has been initialized\n&quot;);
&#125;

&#x2F;&#x2F;4.   å®ç° thread1() æ–¹æ³•ã€‚å®ƒå°†å®ç°çš„é€»è¾‘æ˜¯ç¬¬ä¸€ä¸ªconsumerã€‚è°ƒç”¨ queue çš„ take() æ–¹æ³•ï¼Œç„¶åæŠŠè¿”å›å€¼å†™å…¥æ“æ§å°ã€‚
public void thread1() throws InterruptedException &#123;
	String ret&#x3D;queue.take();
	System.out.printf(&quot;Thread 1: %s\n&quot;,ret);
&#125;

&#x2F;&#x2F;5.   å®ç° thread2() æ–¹æ³•ã€‚å®ƒå°†å®ç°çš„é€»è¾‘æ˜¯ç¬¬äºŒä¸ªconsumerã€‚é¦–å…ˆï¼Œä½¿ç”¨ waitForTick() æ–¹æ³•ï¼Œä¸€ç›´ç­‰åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨ take() æ–¹æ³•ä¸­è¿›å…¥ä¼‘çœ ã€‚ç„¶åï¼Œè°ƒç”¨queueçš„ take() æ–¹æ³•ï¼Œå¹¶æŠŠè¿”å›å€¼å†™å…¥æ“æ§å°ã€‚
public void thread2() throws InterruptedException &#123;
	waitForTick(1);
	String ret&#x3D;queue.take();
	System.out.printf(&quot;Thread 2: %s\n&quot;,ret);
&#125;

&#x2F;&#x2F;6.   å®ç° thread3() æ–¹æ³•ã€‚å®ƒå°†å®ç°çš„é€»è¾‘æ˜¯producerã€‚ é¦–å…ˆï¼Œä½¿ç”¨ waitForTick() ä¸¤æ¬¡ä¸€ç›´ç­‰åˆ°2ä¸ªconsumersè¢«é˜»å¡ã€‚ç„¶åï¼Œè°ƒç”¨ queueçš„ put() æ–¹æ³•æ’å…¥2ä¸ªString åˆ°queueä¸­ã€‚
public void thread3() &#123;
	waitForTick(1);
	waitForTick(2);
	queue.put(&quot;Event 1&quot;);
	queue.put(&quot;Event 2&quot;);
	System.out.printf(&quot;Thread 3: Inserted two elements\n&quot;);
&#125;

&#x2F;&#x2F;7.	æœ€åï¼Œå®ç° finish() æ–¹æ³•ã€‚å†™ä¿¡æ¯åˆ°æ“æ§å°è¡¨æ˜æµ‹è¯•ç»“æŸæ‰§è¡Œã€‚ä½¿ç”¨assertEquals() æ–¹æ³•æ£€æŸ¥2ä¸ªäº‹ä»¶å·²ç»è¢«consumedï¼ˆqueueçš„å¤§å°ä¸º0ï¼‰ã€‚
public void finish() &#123;
	super.finish();
	System.out.printf(&quot;Test: End\n&quot;);
	assertEquals(true, queue.size()&#x3D;&#x3D;0);
	System.out.printf(&quot;Test: Result: The queue is empty\n&quot;);
&#125;

&#x2F;&#x2F;8.   åˆ›å»ºä¾‹å­çš„ä¸»ç±»é€šè¿‡åˆ›å»ºä¸€ä¸ªç±»ï¼Œåä¸º Main å¹¶æ·»åŠ  main()æ–¹æ³•ã€‚
public class Main &#123;

public static void main(String[] args) throws Throwable &#123;

&#x2F;&#x2F;9.   åˆ›å»º ProducerConsumerTest å¯¹è±¡ï¼Œåä¸º testã€‚
ProducerConsumerTest test&#x3D;new ProducerConsumerTest();

&#x2F;&#x2F;10. ä½¿ç”¨ TestFramework ç±»çš„ runOnce()æ–¹æ³•æ¥æ‰§è¡Œæµ‹è¯•ã€‚
System.out.printf(&quot;Main: Starting the test\n&quot;);
TestFramework.runOnce(test);
System.out.printf(&quot;Main: The test has finished\n&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>LinkedTransferQueue ç±»å®ç°äº†ä¸€ä¸ªæµ‹è¯•ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº“å’Œå®ƒçš„èŠ‚æ‹å™¨ä¸ºä»»ä½•å¹¶å‘åº”ç”¨æˆ–è€…ç±»å®ç°æµ‹è¯•ã€‚åœ¨ä¾‹å­ä¸­ï¼Œä½ å®ç°ç»å…¸çš„ producer&#x2F; consumer é—®é¢˜ï¼Œ2ä¸ªconsumers å’Œä¸€ä¸ªproducerã€‚ ä½ æƒ³è¦æµ‹è¯•çš„æ˜¯ åœ¨bufferé‡Œçš„ç¬¬ä¸€ä¸ªä»‹ç»çš„ String å¯¹è±¡ä¼šè¢«ç¬¬ä¸€ä¸ªconsumer æ¶ˆè€—ï¼Œå’Œåœ¨bufferé‡Œç¬¬äºŒä¸ªä»‹ç»çš„Stringå¯¹è±¡ä¼šè¢«ç¬¬äºŒä¸ªåˆ°è¾¾çš„consumeræ¶ˆè€—ã€‚</p>
<p>MultithreadedTCåº“æ˜¯åŸºäºJUnit åº“çš„ã€‚JUnitåº“æ˜¯åœ¨Javaä¸­æœ€ç»å¸¸ç”¨æ¥å®ç°unitæµ‹è¯•æ—¶ä½¿ç”¨çš„åº“ã€‚ä½¿ç”¨ MultithreadedTC åº“æ¥å®ç°ä¸€ä¸ªåŸºæœ¬æµ‹è¯•ï¼Œä½ å¿…é¡»æ‰©å±• MultithreadedTestCase ç±»ã€‚è¿™ä¸ªç±»æ‰©å±•äº† junit.framework.AssertJUnit ç±»ï¼ŒåŒ…å«äº†å…¨éƒ¨æ£€æŸ¥æµ‹è¯•ç»“æœçš„æ–¹æ³•ã€‚å®ƒå¹¶æ²¡æœ‰æ‰©å±• junit.framework.TestCase ç±»ï¼Œä½¿ç”¨ä½ ä¸èƒ½åœ¨å…¶ä»– JUnit æµ‹è¯•ä¸­å¯¼å…¥MultithreadedTCæµ‹è¯•ã€‚</p>
<p>ç„¶åï¼Œä½ å®ç°äº†ä»¥ä¸‹è¿™äº›æ–¹æ³•ï¼š</p>
<p>initialize(): æ­¤æ–¹æ³•çš„å®ç°æ˜¯å¯é€‰çš„ã€‚å½“ä½ å¼€å§‹æµ‹è¯•æ—¶ï¼Œå®ƒå°±ä¼šæ‰§è¡Œï¼Œä¸ºäº†åˆå§‹åŒ–æµ‹è¯•ä¸­ä½¿ç”¨çš„å¯¹è±¡è€Œä½¿ç”¨å®ƒã€‚<br>finish(): æ­¤æ–¹æ³•çš„å®ç°æ˜¯å¯é€‰çš„ã€‚å½“æµ‹è¯•ç»“æŸæ—¶ï¼Œå®ƒå°±ä¼šæ‰§è¡Œã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒåœ¨æµ‹è¯•æˆ–è€…æ£€æŸ¥æµ‹è¯•ç»“æœæœŸé—´æ¥å…³é—­æˆ–è€…é‡Šæ”¾èµ„æºã€‚<br>å®ç°æµ‹è¯•çš„æ–¹æ³•ï¼šè¿™äº›æ–¹æ³•çš„ä¸»è¦é€»è¾‘å°±æ˜¯æµ‹è¯•ä½ çš„å®ç°ã€‚ä»–ä»¬ç”¨threadä½œä¸ºå§‹å…³é”®è¯è¿æ¥ç€å­—ç¬¦ä¸² ä¾‹å¦‚, thread1()ã€‚</p>
<p>ä½¿ç”¨ waitForTick() æ–¹æ³•æ¥æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚æ­¤æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ•´æ•°typeä½œä¸ºå‚æ•°ï¼ŒæŠŠæ­£åœ¨æ‰§è¡Œçš„threadæ”¾å…¥ä¼‘çœ ç›´åˆ°å…¨éƒ¨åœ¨æµ‹è¯•é‡Œè¿è¡Œçš„çº¿ç¨‹éƒ½è¢«é˜»å¡ã€‚ç­‰ä»–ä»¬è¢«é˜»å¡æ—¶ï¼Œ MultithreadedTC åº“è°ƒç”¨ waitForTick() æ–¹æ³• æ¢å¤è¢«é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<p>ä¼ é€’ç»™ waitForTick() æ–¹æ³•ä½œä¸ºå‚æ•°çš„æ•´æ•°æ˜¯ç”¨æ¥æ§åˆ¶æ‰§è¡Œé¡ºåºçš„ã€‚MultithreadedTC åº“çš„èŠ‚æ‹å™¨æœ‰ä¸ªå†…éƒ¨è®¡æ•°å™¨ã€‚å½“å…¨éƒ¨çº¿ç¨‹è¢«é˜»å¡æ—¶ï¼Œåº“å¢åŠ è®¡æ•°å™¨åˆ°ä¸‹ä¸ªåœ¨ waitForTick() è°ƒç”¨ä¸­çš„æ•°å­—ï¼Œé‚£ä¹ˆè¢«é˜»å¡çš„ã€‚</p>
<p>ä»å†…éƒ¨æ¥è¯´ï¼Œå½“ MultithreadedTC åº“ æ‰§è¡Œæµ‹è¯•ï¼Œé¦–å…ˆå®ƒæ‰§è¡Œ æ–¹æ³•ã€‚ç„¶åï¼Œå®ƒåˆ›å»ºæ¯ä¸ªç”¨threadä½œä¸ºå…³é”®è¯å¼€å¤´çš„æ–¹æ³•çš„çº¿ç¨‹ï¼ˆä¾‹å­ä¸­æ˜¯ï¼Œæ–¹æ³• thread1(), thread2(), å’Œ thread3()ï¼‰ï¼Œå½“å…¨éƒ¨çº¿ç¨‹éƒ½ç»“æŸè¿è¡Œåï¼Œå°±æ‰§è¡Œ finish() æ–¹æ³•ã€‚ä¸ºäº†è¿è¡Œæµ‹è¯•ï¼Œä½ è¦ä½¿ç”¨ TestFramework ç±»çš„ runOnce() æ–¹æ³•ã€‚</p>
<p>æ›´å¤šâ€¦</p>
<p>å¦‚æœ MultithreadedTC library æ£€æµ‹çš„å…¨éƒ¨çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªæ˜¯è¢« waitForTick() æ–¹æ³•é˜»å¡çš„ï¼Œé‚£ä¹ˆæµ‹è¯•å°±ä¼šè¢«è®¤ä¸ºåœ¨deadlockçŠ¶æ€ï¼Œå¹¶æŠ›å‡º java.lang.IllegalStateException å¼‚å¸¸ã€‚</p>
<h1 id="JAVAå†…å­˜æ¨¡å‹"><a href="#JAVAå†…å­˜æ¨¡å‹" class="headerlink" title="JAVAå†…å­˜æ¨¡å‹"></a>JAVAå†…å­˜æ¨¡å‹</h1><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/profile/1C70A577591245/publish">ç¨‹æ™“æ˜ - InfoQ</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/news/ftf-java-volatile">èŠèŠå¹¶å‘ï¼ˆä¸€ï¼‰â€”â€”æ·±å…¥åˆ†æVolatileçš„å®ç°åŸç†-InfoQ</a></p>
<p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/a3e40b17eb9eb3a799c32e46b">æ¿€åŠ¨ï¼é˜¿é‡ŒæŠ€æœ¯å®˜çº¯æ‰‹æ‰“ï¼Œ1263é¡µå¹¶å‘ç¼–ç¨‹å…¨ç³»ç¬”è®°ï¼Œé™æ—¶å¼€æº - InfoQ å†™ä½œå¹³å°</a></p>
<p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/4862293d3862488cc0133dc25">ä¸šç•Œæ–°æ ‡æ†ï¼é˜¿é‡Œå¼€æºè‡ªç ”é«˜å¹¶å‘ç¼–ç¨‹æ ¸å¿ƒç¬”è®°ï¼ˆ2021æœ€æ–°ç‰ˆï¼‰ - InfoQ å†™ä½œå¹³å°</a></p>
<h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»"><a href="#å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»" class="headerlink" title="å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»"></a>å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»</h3><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šçº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡åŠçº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼ˆè¿™é‡Œçš„çº¿ç¨‹æ˜¯æŒ‡å¹¶å‘æ‰§è¡Œçš„æ´»åŠ¨å®ä½“ï¼‰ã€‚é€šä¿¡æ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´ä»¥ä½•ç§æœºåˆ¶æ¥äº¤æ¢ä¿¡æ¯ã€‚åœ¨å‘½ä»¤å¼ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶æœ‰ä¸¤ç§ï¼šå…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’ã€‚</p>
<p>åœ¨å…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´é€šè¿‡å†™ - è¯»å†…å­˜ä¸­çš„å…¬å…±çŠ¶æ€æ¥éšå¼è¿›è¡Œé€šä¿¡ã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´æ²¡æœ‰å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´å¿…é¡»é€šè¿‡æ˜ç¡®çš„å‘é€æ¶ˆæ¯æ¥æ˜¾å¼è¿›è¡Œé€šä¿¡ã€‚</p>
<p>åŒæ­¥æ˜¯æŒ‡ç¨‹åºç”¨äºæ§åˆ¶ä¸åŒçº¿ç¨‹ä¹‹é—´æ“ä½œå‘ç”Ÿç›¸å¯¹é¡ºåºçš„æœºåˆ¶ã€‚åœ¨å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹é‡Œï¼ŒåŒæ­¥æ˜¯æ˜¾å¼è¿›è¡Œçš„ã€‚ç¨‹åºå‘˜å¿…é¡»æ˜¾å¼æŒ‡å®šæŸä¸ªæ–¹æ³•æˆ–æŸæ®µä»£ç éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´äº’æ–¥æ‰§è¡Œã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œç”±äºæ¶ˆæ¯çš„å‘é€å¿…é¡»åœ¨æ¶ˆæ¯çš„æ¥æ”¶ä¹‹å‰ï¼Œå› æ­¤åŒæ­¥æ˜¯éšå¼è¿›è¡Œçš„ã€‚</p>
<p>Java çš„å¹¶å‘é‡‡ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¨¡å‹ï¼ŒJava çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ€»æ˜¯éšå¼è¿›è¡Œï¼Œæ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¯¹ç¨‹åºå‘˜å®Œå…¨é€æ˜ã€‚å¦‚æœç¼–å†™å¤šçº¿ç¨‹ç¨‹åºçš„ Java ç¨‹åºå‘˜ä¸ç†è§£éšå¼è¿›è¡Œçš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„å·¥ä½œæœºåˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°å„ç§å¥‡æ€ªçš„å†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯JMMï¼Ÿ</strong></p>
<blockquote>
<p><code>JMM</code>ï¼šJavaçº¿ç¨‹å…±äº«å†…å­˜æ¨¡å‹ï¼Œä¸å­˜åœ¨çš„ä¸œè¥¿ï¼Œæ¦‚å¿µï¼çº¦å®šï¼</p>
</blockquote>
<p><strong>ä»JDK5å¼€å§‹ï¼ŒJavaä½¿ç”¨æ–°çš„å†…å­˜æ¨¡å‹ï¼Œæ–°å†…å­˜æ¨¡å‹å®Œå…¨æŠ›å¼ƒäº†æ—§å†…å­˜æ¨¡å‹çš„ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„æ¦‚å¿µï¼Œä¹ŸæŠ›å¼ƒäº†æ—§å†…å­˜æ¨¡å‹çš„8ä¸ªå†…å­˜æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–°å†…å­˜æ¨¡å‹å®Œå…¨æ˜¯é‡æ–°è®¾è®¡çš„â€ï¼Œè¿™é‡Œè¯´çš„8ä¸ªå†…å­˜æ“ä½œï¼ŒæŒ‡çš„æ˜¯read ã€load ã€use ã€assign ã€store ã€write ã€lock ã€unlockå§</strong></p>
<p><strong>å…³äºJMMçš„ä¸€äº›åŒæ­¥çš„çº¦å®šï¼š</strong></p>
<p>1ã€çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡<strong>ç«‹åˆ»</strong>åˆ·æ–°å›ä¸»ç‰©ç†å†…å­˜ã€‚</p>
<p>2ã€çº¿ç¨‹åŠ é”å‰ï¼Œå¿…é¡»è¯»å–ä¸»ç‰©ç†å†…å­˜ä¸­çš„æœ€æ–°çš„å€¼åˆ°å·¥ä½œå†…å­˜ä¸­ã€‚</p>
<p>3ã€åŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”ã€‚</p>
<blockquote>
<p><strong>Javaå…±äº«å†…å­˜æ¨¡å‹çš„8ç§æ“ä½œ</strong></p>
</blockquote>
<p><img src="/image/Concurrent/Concurrent43.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent43.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€‚å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­çš„å®ç°ç»†èŠ‚ã€‚javaå†…å­˜æ¨¡å‹å®šä¹‰äº†8ç§æ“ä½œæ¥å®Œæˆã€‚<strong>è¿™8ç§æ“ä½œæ¯ä¸€ç§éƒ½æ˜¯åŸå­æ“ä½œ</strong>ã€‚8ç§æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>lock(é”å®š)ï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡æ ‡è®°ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çŠ¶æ€ï¼›</strong></li>
<li><strong>read(è¯»å–)ï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå®ƒæŠŠå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ é€åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ï¼›</strong></li>
<li><strong>load(è½½å…¥)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå®ƒæŠŠreadæ“ä½œçš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬ä¸­ï¼›</strong></li>
<li><strong>use(ä½¿ç”¨)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨è¿™ä¸ªå˜é‡çš„æŒ‡ä»¤æ—¶å€™ï¼Œå°†ä¼šæ‰§è¡Œè¿™ä¸ªåŠ¨ä½œï¼›</strong></li>
<li><strong>assign(èµ‹å€¼)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå®ƒæŠŠä»æ‰§è¡Œå¼•æ“è·å–çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„æŒ‡ä»¤æ—¶å€™ï¼Œæ‰§è¡Œè¯¥æ“ä½œï¼›</strong></li>
<li><strong>store(å­˜å‚¨)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡ä¼ é€ç»™ä¸»å†…å­˜ä¸­ï¼Œä»¥å¤‡éšåçš„writeæ“ä½œä½¿ç”¨ï¼›</strong></li>
<li><strong>write(å†™å…¥)ï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå®ƒæŠŠstoreä¼ é€å€¼æ”¾åˆ°ä¸»å†…å­˜ä¸­çš„å˜é‡ä¸­ã€‚</strong></li>
<li><strong>unlock(è§£é”)ï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå®ƒå°†ä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰èƒ½å¤Ÿè¢«å…¶ä»–çº¿ç¨‹é”å®šï¼›</strong></li>
</ul>
<p>Javaå†…å­˜æ¨¡å‹è¿˜è§„å®šäº†æ‰§è¡Œä¸Šè¿°8ç§åŸºæœ¬æ“ä½œæ—¶å¿…é¡»æ»¡è¶³å¦‚ä¸‹è§„åˆ™:</p>
<ul>
<li><strong>ä¸å…è®¸readå’Œloadã€storeå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼ˆå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å­˜è¯»å–äº†ä½†æ˜¯å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…ä»å·¥ä½œå†…å­˜å‘èµ·ä¼šå†™äº†ä½†æ˜¯ä¸»å­˜ä¸æ¥å—çš„æƒ…å†µï¼‰ï¼Œä»¥ä¸Šä¸¤ä¸ªæ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†æ²¡æœ‰ä¿è¯å¿…é¡»è¿ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œreadä¸loadä¹‹é—´ã€storeä¸writeä¹‹é—´æ˜¯å¯æ’å…¥å…¶ä»–æŒ‡ä»¤çš„ã€‚</strong></li>
<li><strong>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒçš„æœ€è¿‘çš„assignæ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚</strong></li>
<li><strong>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½•assignæ“ä½œï¼‰æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</strong></li>
<li><strong>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½ä»ä¸»å†…å­˜ä¸­â€œè¯ç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆloadæˆ–assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½useå’Œstoreæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº†assignå’Œloadæ“ä½œã€‚</strong></li>
<li><strong>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶æ‰§è¡Œlockæ“ä½œï¼Œä½†lockæ“ä½œå¯ä»¥è¢«åŒä¸€ä¸ªæ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œlockåï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„unlockæ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚</strong></li>
<li><strong>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œlockæ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œloadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚</strong></li>
<li><strong>å¦‚æœä¸€ä¸ªå˜é‡å®ç°æ²¡æœ‰è¢«lockæ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œunlockæ“ä½œï¼Œä¹Ÿä¸å…è®¸å»unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡ã€‚</strong></li>
<li><strong>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ï¼ˆæ‰§è¡Œstoreå’Œwriteæ“ä½œï¼‰ã€‚</strong></li>
</ul>
<h3 id="Java-å†…å­˜æ¨¡å‹çš„æŠ½è±¡"><a href="#Java-å†…å­˜æ¨¡å‹çš„æŠ½è±¡" class="headerlink" title="Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡"></a>Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡</h3><p>åœ¨ java ä¸­ï¼Œæ‰€æœ‰å®ä¾‹åŸŸã€é™æ€åŸŸå’Œæ•°ç»„å…ƒç´ å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼ˆæœ¬æ–‡ä½¿ç”¨â€œå…±äº«å˜é‡â€è¿™ä¸ªæœ¯è¯­ä»£æŒ‡å®ä¾‹åŸŸï¼Œé™æ€åŸŸå’Œæ•°ç»„å…ƒç´ ï¼‰ã€‚å±€éƒ¨å˜é‡ï¼ˆLocal variablesï¼‰ï¼Œæ–¹æ³•å®šä¹‰å‚æ•°ï¼ˆjava è¯­è¨€è§„èŒƒç§°ä¹‹ä¸º formal method parametersï¼‰å’Œå¼‚å¸¸å¤„ç†å™¨å‚æ•°ï¼ˆexception handler parametersï¼‰ä¸ä¼šåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œå®ƒä»¬ä¸ä¼šæœ‰å†…å­˜å¯è§æ€§é—®é¢˜ï¼Œä¹Ÿä¸å—å†…å­˜æ¨¡å‹çš„å½±å“ã€‚</p>
<p>Java çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç”± Java å†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡ç®€ç§°ä¸º JMMï¼‰æ§åˆ¶ï¼ŒJMM å†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼ŒJMM å®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆmain memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆlocal memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯» &#x2F; å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ï¼Œå†™ç¼“å†²åŒºï¼Œå¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent44.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent44.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä»ä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹ A ä¸çº¿ç¨‹ B ä¹‹é—´å¦‚è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œçº¿ç¨‹ A æŠŠæœ¬åœ°å†…å­˜ A ä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚</li>
<li>ç„¶åï¼Œçº¿ç¨‹ B åˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹ A ä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡ã€‚</li>
</ol>
<p>ä¸‹é¢é€šè¿‡ç¤ºæ„å›¾æ¥è¯´æ˜è¿™ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<p><img src="/image/Concurrent/Concurrent45.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent45.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ¬åœ°å†…å­˜ A å’Œ B æœ‰ä¸»å†…å­˜ä¸­å…±äº«å˜é‡ x çš„å‰¯æœ¬ã€‚å‡è®¾åˆå§‹æ—¶ï¼Œè¿™ä¸‰ä¸ªå†…å­˜ä¸­çš„ x å€¼éƒ½ä¸º 0ã€‚çº¿ç¨‹ A åœ¨æ‰§è¡Œæ—¶ï¼ŒæŠŠæ›´æ–°åçš„ x å€¼ï¼ˆå‡è®¾å€¼ä¸º 1ï¼‰ä¸´æ—¶å­˜æ”¾åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜ A ä¸­ã€‚å½“çº¿ç¨‹ A å’Œçº¿ç¨‹ B éœ€è¦é€šä¿¡æ—¶ï¼Œçº¿ç¨‹ A é¦–å…ˆä¼šæŠŠè‡ªå·±æœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹åçš„ x å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¸»å†…å­˜ä¸­çš„ x å€¼å˜ä¸ºäº† 1ã€‚éšåï¼Œçº¿ç¨‹ B åˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹ A æ›´æ–°åçš„ x å€¼ï¼Œæ­¤æ—¶çº¿ç¨‹ B çš„æœ¬åœ°å†…å­˜çš„ x å€¼ä¹Ÿå˜ä¸ºäº† 1ã€‚</p>
<p>ä»æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å®è´¨ä¸Šæ˜¯çº¿ç¨‹ A åœ¨å‘çº¿ç¨‹ B å‘é€æ¶ˆæ¯ï¼Œè€Œä¸”è¿™ä¸ªé€šä¿¡è¿‡ç¨‹å¿…é¡»è¦ç»è¿‡ä¸»å†…å­˜ã€‚JMM é€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥ä¸º java ç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<h3 id="é‡æ’åº"><a href="#é‡æ’åº" class="headerlink" title="é‡æ’åº"></a>é‡æ’åº</h3><p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†ä¸‰ç§ç±»å‹ï¼š</p>
<ol>
<li>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» &#x2F; å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚</li>
</ol>
<p>ä» java æºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š</p>
<p><img src="/image/Concurrent/Concurrent46.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent46.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸Šè¿°çš„ 1 å±äºç¼–è¯‘å™¨é‡æ’åºï¼Œ2 å’Œ 3 å±äºå¤„ç†å™¨é‡æ’åºã€‚è¿™äº›é‡æ’åºéƒ½å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å¯¹äºç¼–è¯‘å™¨ï¼ŒJMM çš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMM çš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ java ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆmemory barriersï¼Œintel ç§°ä¹‹ä¸º memory fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚</p>
<p>JMM å±äºè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒç¡®ä¿åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œä¸ºç¨‹åºå‘˜æä¾›ä¸€è‡´çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<h3 id="å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤"><a href="#å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤"></a>å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤</h3><p>ç°ä»£çš„å¤„ç†å™¨ä½¿ç”¨å†™ç¼“å†²åŒºæ¥ä¸´æ—¶ä¿å­˜å‘å†…å­˜å†™å…¥çš„æ•°æ®ã€‚å†™ç¼“å†²åŒºå¯ä»¥ä¿è¯æŒ‡ä»¤æµæ°´çº¿æŒç»­è¿è¡Œï¼Œå®ƒå¯ä»¥é¿å…ç”±äºå¤„ç†å™¨åœé¡¿ä¸‹æ¥ç­‰å¾…å‘å†…å­˜å†™å…¥æ•°æ®è€Œäº§ç”Ÿçš„å»¶è¿Ÿã€‚åŒæ—¶ï¼Œé€šè¿‡ä»¥æ‰¹å¤„ç†çš„æ–¹å¼åˆ·æ–°å†™ç¼“å†²åŒºï¼Œä»¥åŠåˆå¹¶å†™ç¼“å†²åŒºä¸­å¯¹åŒä¸€å†…å­˜åœ°å€çš„å¤šæ¬¡å†™ï¼Œå¯ä»¥å‡å°‘å¯¹å†…å­˜æ€»çº¿çš„å ç”¨ã€‚è™½ç„¶å†™ç¼“å†²åŒºæœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œä½†æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„å†™ç¼“å†²åŒºï¼Œä»…ä»…å¯¹å®ƒæ‰€åœ¨çš„å¤„ç†å™¨å¯è§ã€‚è¿™ä¸ªç‰¹æ€§ä¼šå¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºäº§ç”Ÿé‡è¦çš„å½±å“ï¼šå¤„ç†å™¨å¯¹å†…å­˜çš„è¯» &#x2F; å†™æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œä¸ä¸€å®šä¸å†…å­˜å®é™…å‘ç”Ÿçš„è¯» &#x2F; å†™æ“ä½œé¡ºåºä¸€è‡´ï¼ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">Processor A Processor B 

a &#x3D; 1; &#x2F;&#x2F;A1
x &#x3D; b; &#x2F;&#x2F;A2 

b &#x3D; 2; &#x2F;&#x2F;B1
y &#x3D; a; &#x2F;&#x2F;B2 åˆå§‹çŠ¶æ€ï¼ša &#x3D; b &#x3D; 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>å¤„ç†å™¨å…è®¸æ‰§è¡Œåå¾—åˆ°ç»“æœï¼šx &#x3D; y &#x3D; 0 å‡è®¾å¤„ç†å™¨ A å’Œå¤„ç†å™¨ B æŒ‰ç¨‹åºçš„é¡ºåºå¹¶è¡Œæ‰§è¡Œå†…å­˜è®¿é—®ï¼Œæœ€ç»ˆå´å¯èƒ½å¾—åˆ° x &#x3D; y &#x3D; 0 çš„ç»“æœã€‚å…·ä½“çš„åŸå› å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent47.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent47.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>è¿™é‡Œå¤„ç†å™¨ A å’Œå¤„ç†å™¨ B å¯ä»¥åŒæ—¶æŠŠå…±äº«å˜é‡å†™å…¥è‡ªå·±çš„å†™ç¼“å†²åŒºï¼ˆA1ï¼ŒB1ï¼‰ï¼Œç„¶åä»å†…å­˜ä¸­è¯»å–å¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆA2ï¼ŒB2ï¼‰ï¼Œæœ€åæ‰æŠŠè‡ªå·±å†™ç¼“å­˜åŒºä¸­ä¿å­˜çš„è„æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼ˆA3ï¼ŒB3ï¼‰ã€‚å½“ä»¥è¿™ç§æ—¶åºæ‰§è¡Œæ—¶ï¼Œç¨‹åºå°±å¯ä»¥å¾—åˆ° x &#x3D; y &#x3D; 0 çš„ç»“æœã€‚</p>
<p>ä»å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºæ¥çœ‹ï¼Œç›´åˆ°å¤„ç†å™¨ A æ‰§è¡Œ A3 æ¥åˆ·æ–°è‡ªå·±çš„å†™ç¼“å­˜åŒºï¼Œå†™æ“ä½œ A1 æ‰ç®—çœŸæ­£æ‰§è¡Œäº†ã€‚è™½ç„¶å¤„ç†å™¨ A æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºä¸ºï¼šA1-&gt;A2ï¼Œä½†å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºå´æ˜¯ï¼šA2-&gt;A1ã€‚æ­¤æ—¶ï¼Œå¤„ç†å™¨ A çš„å†…å­˜æ“ä½œé¡ºåºè¢«é‡æ’åºäº†ï¼ˆå¤„ç†å™¨ B çš„æƒ…å†µå’Œå¤„ç†å™¨ A ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼‰ã€‚</p>
<p>è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œç”±äºå†™ç¼“å†²åŒºä»…å¯¹è‡ªå·±çš„å¤„ç†å™¨å¯è§ï¼Œå®ƒä¼šå¯¼è‡´å¤„ç†å™¨æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºå¯èƒ½ä¼šä¸å†…å­˜å®é™…çš„æ“ä½œæ‰§è¡Œé¡ºåºä¸ä¸€è‡´ã€‚ç”±äºç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šä½¿ç”¨å†™ç¼“å†²åŒºï¼Œå› æ­¤ç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šå…è®¸å¯¹å†™ - è¯»æ“åšé‡æ’åºã€‚</p>
<p>ä¸ºäº†ä¿è¯å†…å­˜å¯è§æ€§ï¼Œjava ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—çš„é€‚å½“ä½ç½®ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚JMM æŠŠå†…å­˜å±éšœæŒ‡ä»¤åˆ†ä¸ºä¸‹åˆ—å››ç±»ï¼š</p>
<p>ä¸‹é¢æ˜¯å¸¸è§å¤„ç†å™¨å…è®¸çš„é‡æ’åºç±»å‹çš„åˆ—è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>å±éšœç±»å‹</th>
<th>æŒ‡ä»¤ç¤ºä¾‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>LoadLoad  Barriers</td>
<td>Load1; LoadLoad; Load2</td>
<td>ç¡®ä¿Load1æ•°æ®çš„è£…è½½ï¼Œä¹‹å‰äºLoad2åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚</td>
</tr>
<tr>
<td>StoreStore  Barriers</td>
<td>Store1; StoreStore; Store2</td>
<td>ç¡®ä¿Store1æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼ˆåˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äºStore2åŠæ‰€æœ‰åç»­å­˜å‚¨æŒ‡ä»¤çš„å­˜å‚¨ã€‚</td>
</tr>
<tr>
<td>LoadStore Barriers</td>
<td>Load1; LoadStore; Store2</td>
<td>ç¡®ä¿Load1æ•°æ®è£…è½½ï¼Œä¹‹å‰äºStore2åŠæ‰€æœ‰åç»­çš„å­˜å‚¨æŒ‡ä»¤åˆ·æ–°åˆ°å†…å­˜ã€‚</td>
</tr>
<tr>
<td>StoreLoad Barriers</td>
<td>Store1; StoreLoad; Load2</td>
<td>ç¡®ä¿Store1æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å˜å¾—å¯è§ï¼ˆæŒ‡åˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äºLoad2åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚StoreLoad Barriersä¼šä½¿è¯¥å±éšœä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆå­˜å‚¨å’Œè£…è½½æŒ‡ä»¤ï¼‰å®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œè¯¥å±éšœä¹‹åçš„å†…å­˜è®¿é—®æŒ‡ä»¤ã€‚</td>
</tr>
</tbody></table>
<h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h3><p>ä» JDK5 å¼€å§‹ï¼Œjava ä½¿ç”¨æ–°çš„ JSR -133 å†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡é™¤éç‰¹åˆ«è¯´æ˜ï¼Œé’ˆå¯¹çš„éƒ½æ˜¯ JSR- 133 å†…å­˜æ¨¡å‹ï¼‰ã€‚<strong>JSR-133 æå‡ºäº† happens-before çš„æ¦‚å¿µï¼Œé€šè¿‡è¿™ä¸ªæ¦‚å¿µæ¥é˜è¿°æ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§</strong>ã€‚å¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»å­˜åœ¨ <strong>happens-before</strong> å…³ç³»ã€‚è¿™é‡Œæåˆ°çš„ä¸¤ä¸ªæ“ä½œæ—¢å¯ä»¥æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ã€‚ ä¸ç¨‹åºå‘˜å¯†åˆ‡ç›¸å…³çš„ <strong>happens-before</strong> è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens- before äºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</strong></li>
<li><strong>ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªç›‘è§†å™¨é”çš„è§£é”ï¼Œhappens- before äºéšåå¯¹è¿™ä¸ªç›‘è§†å™¨é”çš„åŠ é”ã€‚</strong></li>
<li><strong>volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens- before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚</strong></li>
<li><strong>ä¼ é€’æ€§ï¼šå¦‚æœ A happens- before Bï¼Œä¸” B happens- before Cï¼Œé‚£ä¹ˆ A happens- before Cã€‚</strong></li>
<li><strong>start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚</strong></li>
<li><strong>join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œhappens-beforeäºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚</strong></li>
<li><strong>çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interruptæ–¹æ³•çš„è°ƒç”¨happens-beforeäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ</strong></li>
</ul>
<p>æ³¨æ„ï¼Œä¸¤ä¸ªæ“ä½œä¹‹é—´å…·æœ‰ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œï¼happens-before ä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ï¼ˆthe first is visible to and ordered before the secondï¼‰ã€‚happens- before çš„å®šä¹‰å¾ˆå¾®å¦™ï¼Œåæ–‡ä¼šå…·ä½“è¯´æ˜ happens-before ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®šä¹‰ã€‚</p>
<p>happens-before ä¸ JMM çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent48.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent48.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ª happens-before è§„åˆ™é€šå¸¸å¯¹åº”äºå¤šä¸ªç¼–è¯‘å™¨é‡æ’åºè§„åˆ™å’Œå¤„ç†å™¨é‡æ’åºè§„åˆ™ã€‚å¯¹äº java ç¨‹åºå‘˜æ¥è¯´ï¼Œhappens-before è§„åˆ™ç®€å•æ˜“æ‡‚ï¼Œå®ƒé¿å…ç¨‹åºå‘˜ä¸ºäº†ç†è§£ JMM æä¾›çš„å†…å­˜å¯è§æ€§ä¿è¯è€Œå»å­¦ä¹ å¤æ‚çš„é‡æ’åºè§„åˆ™ä»¥åŠè¿™äº›è§„åˆ™çš„å…·ä½“å®ç°ã€‚</p>
<h2 id="é‡æ’åº-1"><a href="#é‡æ’åº-1" class="headerlink" title="é‡æ’åº"></a>é‡æ’åº</h2><h3 id="æ•°æ®ä¾èµ–æ€§"><a href="#æ•°æ®ä¾èµ–æ€§" class="headerlink" title="æ•°æ®ä¾èµ–æ€§"></a>æ•°æ®ä¾èµ–æ€§</h3><p>å¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸”è¿™ä¸¤ä¸ªæ“ä½œä¸­æœ‰ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚æ•°æ®ä¾èµ–åˆ†ä¸‹åˆ—ä¸‰ç§ç±»å‹ï¼š</p>
<p>åç§° ä»£ç ç¤ºä¾‹ è¯´æ˜ å†™åè¯» a &#x3D; 1;b &#x3D; a; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†è¯»è¿™ä¸ªä½ç½®ã€‚ å†™åå†™ a &#x3D; 1;a &#x3D; 2; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚ è¯»åå†™ a &#x3D; b;b &#x3D; 1; è¯»ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚ä¸Šé¢ä¸‰ç§æƒ…å†µï¼Œåªè¦é‡æ’åºä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœå°†ä¼šè¢«æ”¹å˜ã€‚</p>
<p>å‰é¢æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æ“ä½œåšé‡æ’åºã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨é‡æ’åºæ—¶ï¼Œä¼šéµå®ˆæ•°æ®ä¾èµ–æ€§ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šæ”¹å˜å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„æ•°æ®ä¾èµ–æ€§ä»…é’ˆå¯¹å•ä¸ªå¤„ç†å™¨ä¸­æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å’Œå•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´å’Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ä¸è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è€ƒè™‘ã€‚</p>
<h3 id="as-if-serial-è¯­ä¹‰"><a href="#as-if-serial-è¯­ä¹‰" class="headerlink" title="as-if-serial è¯­ä¹‰"></a>as-if-serial è¯­ä¹‰</h3><p>as-if-serial è¯­ä¹‰çš„æ„æ€æŒ‡ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼ˆç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼‰ï¼Œï¼ˆå•çº¿ç¨‹ï¼‰ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆ as-if-serial è¯­ä¹‰ã€‚</p>
<p>ä¸ºäº†éµå®ˆ as-if-serial è¯­ä¹‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢è®¡ç®—åœ†é¢ç§¯çš„ä»£ç ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">double</span> pi  <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>    <span class="token comment">//A</span>
<span class="token keyword">double</span> r   <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>     <span class="token comment">//B</span>
<span class="token keyword">double</span> area <span class="token operator">=</span> pi <span class="token operator">*</span> r <span class="token operator">*</span> r<span class="token punctuation">;</span> <span class="token comment">//C</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢ä¸‰ä¸ªæ“ä½œçš„æ•°æ®ä¾èµ–å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent49.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent49.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒA å’Œ C ä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶ B å’Œ C ä¹‹é—´ä¹Ÿå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ã€‚å› æ­¤åœ¨æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ä¸­ï¼ŒC ä¸èƒ½è¢«é‡æ’åºåˆ° A å’Œ B çš„å‰é¢ï¼ˆC æ’åˆ° A å’Œ B çš„å‰é¢ï¼Œç¨‹åºçš„ç»“æœå°†ä¼šè¢«æ”¹å˜ï¼‰ã€‚ä½† A å’Œ B ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥é‡æ’åº A å’Œ B ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾æ˜¯è¯¥ç¨‹åºçš„ä¸¤ç§æ‰§è¡Œé¡ºåºï¼š</p>
<p><img src="/image/Concurrent/Concurrent50.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent50.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>as-if-serial è¯­ä¹‰æŠŠå•çº¿ç¨‹ç¨‹åºä¿æŠ¤äº†èµ·æ¥ï¼Œéµå®ˆ as-if-serial è¯­ä¹‰çš„ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨å…±åŒä¸ºç¼–å†™å•çº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜åˆ›å»ºäº†ä¸€ä¸ªå¹»è§‰ï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚as-if-serial è¯­ä¹‰ä½¿å•çº¿ç¨‹ç¨‹åºå‘˜æ— éœ€æ‹…å¿ƒé‡æ’åºä¼šå¹²æ‰°ä»–ä»¬ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒå†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<h3 id="ç¨‹åºé¡ºåºè§„åˆ™"><a href="#ç¨‹åºé¡ºåºè§„åˆ™" class="headerlink" title="ç¨‹åºé¡ºåºè§„åˆ™"></a>ç¨‹åºé¡ºåºè§„åˆ™</h3><p>æ ¹æ® happens- before çš„ç¨‹åºé¡ºåºè§„åˆ™ï¼Œä¸Šé¢è®¡ç®—åœ†çš„é¢ç§¯çš„ç¤ºä¾‹ä»£ç å­˜åœ¨ä¸‰ä¸ª happens- before å…³ç³»ï¼š</p>
<ol>
<li>A happens- before Bï¼›</li>
<li>B happens- before Cï¼›</li>
<li>A happens- before Cï¼›</li>
</ol>
<p>è¿™é‡Œçš„ç¬¬ 3 ä¸ª happens- before å…³ç³»ï¼Œæ˜¯æ ¹æ® happens- before çš„ä¼ é€’æ€§æ¨å¯¼å‡ºæ¥çš„ã€‚</p>
<p>è¿™é‡Œ A happens- before Bï¼Œä½†å®é™…æ‰§è¡Œæ—¶ B å´å¯ä»¥æ’åœ¨ A ä¹‹å‰æ‰§è¡Œï¼ˆçœ‹ä¸Šé¢çš„é‡æ’åºåçš„æ‰§è¡Œé¡ºåºï¼‰ã€‚åœ¨ç¬¬ä¸€ç« æåˆ°è¿‡ï¼Œå¦‚æœ A happens- before Bï¼ŒJMM å¹¶ä¸è¦æ±‚ A ä¸€å®šè¦åœ¨ B ä¹‹å‰æ‰§è¡Œã€‚JMM ä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚è¿™é‡Œæ“ä½œ A çš„æ‰§è¡Œç»“æœä¸éœ€è¦å¯¹æ“ä½œ B å¯è§ï¼›è€Œä¸”é‡æ’åºæ“ä½œ A å’Œæ“ä½œ B åçš„æ‰§è¡Œç»“æœï¼Œä¸æ“ä½œ A å’Œæ“ä½œ B æŒ‰ happens- before é¡ºåºæ‰§è¡Œçš„ç»“æœä¸€è‡´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJMM ä¼šè®¤ä¸ºè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆnot illegalï¼‰ï¼ŒJMM å…è®¸è¿™ç§é‡æ’åºã€‚</p>
<p>åœ¨è®¡ç®—æœºä¸­ï¼Œè½¯ä»¶æŠ€æœ¯å’Œç¡¬ä»¶æŠ€æœ¯æœ‰ä¸€ä¸ªå…±åŒçš„ç›®æ ‡ï¼šåœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½çš„å¼€å‘å¹¶è¡Œåº¦ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨éµä»è¿™ä¸€ç›®æ ‡ï¼Œä» happens- before çš„å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒJMM åŒæ ·éµä»è¿™ä¸€ç›®æ ‡ã€‚</p>
<h3 id="é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“"><a href="#é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“" class="headerlink" title="é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“"></a>é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“</h3><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œé‡æ’åºæ˜¯å¦ä¼šæ”¹å˜å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ReorderExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//1</span>
       flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>             <span class="token comment">//2</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Public</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//3</span>
           <span class="token keyword">int</span> i <span class="token operator">=</span>  a <span class="token operator">*</span> a<span class="token punctuation">;</span>        <span class="token comment">//4</span>
           â€¦â€¦
       <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag å˜é‡æ˜¯ä¸ªæ ‡è®°ï¼Œç”¨æ¥æ ‡è¯†å˜é‡ a æ˜¯å¦å·²è¢«å†™å…¥ã€‚è¿™é‡Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ Bï¼ŒA é¦–å…ˆæ‰§è¡Œ writer() æ–¹æ³•ï¼Œéšå B çº¿ç¨‹æ¥ç€æ‰§è¡Œ reader() æ–¹æ³•ã€‚çº¿ç¨‹ B åœ¨æ‰§è¡Œæ“ä½œ 4 æ—¶ï¼Œèƒ½å¦çœ‹åˆ°çº¿ç¨‹ A åœ¨æ“ä½œ 1 å¯¹å…±äº«å˜é‡ a çš„å†™å…¥ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šä¸ä¸€å®šèƒ½çœ‹åˆ°ã€‚</p>
<p>ç”±äºæ“ä½œ 1 å’Œæ“ä½œ 2 æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºï¼›åŒæ ·ï¼Œæ“ä½œ 3 å’Œæ“ä½œ 4 æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¹Ÿå¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œé‡æ’åºã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œå½“æ“ä½œ 1 å’Œæ“ä½œ 2 é‡æ’åºæ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä»€ä¹ˆæ•ˆæœï¼Ÿè¯·çœ‹ä¸‹é¢çš„ç¨‹åºæ‰§è¡Œæ—¶åºå›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent51.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent51.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ“ä½œ 1 å’Œæ“ä½œ 2 åšäº†é‡æ’åºã€‚ç¨‹åºæ‰§è¡Œæ—¶ï¼Œçº¿ç¨‹ A é¦–å…ˆå†™æ ‡è®°å˜é‡ flagï¼Œéšåçº¿ç¨‹ B è¯»è¿™ä¸ªå˜é‡ã€‚ç”±äºæ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œçº¿ç¨‹ B å°†è¯»å–å˜é‡ aã€‚æ­¤æ—¶ï¼Œå˜é‡ a è¿˜æ ¹æœ¬æ²¡æœ‰è¢«çº¿ç¨‹ A å†™å…¥ï¼Œåœ¨è¿™é‡Œå¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰è¢«é‡æ’åºç ´åäº†ï¼</p>
<p>â€»æ³¨ï¼šæœ¬æ–‡ç»Ÿä¸€ç”¨çº¢è‰²çš„è™šç®­çº¿è¡¨ç¤ºé”™è¯¯çš„è¯»æ“ä½œï¼Œç”¨ç»¿è‰²çš„è™šç®­çº¿è¡¨ç¤ºæ­£ç¡®çš„è¯»æ“ä½œã€‚</p>
<p>ä¸‹é¢å†è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œå½“æ“ä½œ 3 å’Œæ“ä½œ 4 é‡æ’åºæ—¶ä¼šäº§ç”Ÿä»€ä¹ˆæ•ˆæœï¼ˆå€ŸåŠ©è¿™ä¸ªé‡æ’åºï¼Œå¯ä»¥é¡ºä¾¿è¯´æ˜æ§åˆ¶ä¾èµ–æ€§ï¼‰ã€‚ä¸‹é¢æ˜¯æ“ä½œ 3 å’Œæ“ä½œ 4 é‡æ’åºåï¼Œç¨‹åºçš„æ‰§è¡Œæ—¶åºå›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent52.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent52.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ç¨‹åºä¸­ï¼Œæ“ä½œ 3 å’Œæ“ä½œ 4 å­˜åœ¨æ§åˆ¶ä¾èµ–å…³ç³»ã€‚å½“ä»£ç ä¸­å­˜åœ¨æ§åˆ¶ä¾èµ–æ€§æ—¶ï¼Œä¼šå½±å“æŒ‡ä»¤åºåˆ—æ‰§è¡Œçš„å¹¶è¡Œåº¦ã€‚ä¸ºæ­¤ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šé‡‡ç”¨çŒœæµ‹ï¼ˆSpeculationï¼‰æ‰§è¡Œæ¥å…‹æœæ§åˆ¶ç›¸å…³æ€§å¯¹å¹¶è¡Œåº¦çš„å½±å“ã€‚ä»¥å¤„ç†å™¨çš„çŒœæµ‹æ‰§è¡Œä¸ºä¾‹ï¼Œæ‰§è¡Œçº¿ç¨‹ B çš„å¤„ç†å™¨å¯ä»¥æå‰è¯»å–å¹¶è®¡ç®— a*aï¼Œç„¶åæŠŠè®¡ç®—ç»“æœä¸´æ—¶ä¿å­˜åˆ°ä¸€ä¸ªåä¸ºé‡æ’åºç¼“å†²ï¼ˆreorder buffer ROBï¼‰çš„ç¡¬ä»¶ç¼“å­˜ä¸­ã€‚å½“æ¥ä¸‹æ¥æ“ä½œ 3 çš„æ¡ä»¶åˆ¤æ–­ä¸ºçœŸæ—¶ï¼Œå°±æŠŠè¯¥è®¡ç®—ç»“æœå†™å…¥å˜é‡ i ä¸­ã€‚</p>
<p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒçŒœæµ‹æ‰§è¡Œå®è´¨ä¸Šå¯¹æ“ä½œ 3 å’Œ 4 åšäº†é‡æ’åºã€‚é‡æ’åºåœ¨è¿™é‡Œç ´åäº†å¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰ï¼</p>
<p>åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œä¸ä¼šæ”¹å˜æ‰§è¡Œç»“æœï¼ˆè¿™ä¹Ÿæ˜¯ as-if-serial è¯­ä¹‰å…è®¸å¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œåšé‡æ’åºçš„åŸå› ï¼‰ï¼›ä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå¯¹å­˜åœ¨æ§åˆ¶ä¾èµ–çš„æ“ä½œé‡æ’åºï¼Œå¯èƒ½ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚</p>
<h2 id="é¡ºåºä¸€è‡´æ€§"><a href="#é¡ºåºä¸€è‡´æ€§" class="headerlink" title="é¡ºåºä¸€è‡´æ€§"></a>é¡ºåºä¸€è‡´æ€§</h2><h3 id="æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§ä¿è¯"><a href="#æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§ä¿è¯" class="headerlink" title="æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§ä¿è¯"></a>æ•°æ®ç«äº‰ä¸é¡ºåºä¸€è‡´æ€§ä¿è¯</h3><p>å½“ç¨‹åºæœªæ­£ç¡®åŒæ­¥æ—¶ï¼Œå°±ä¼šå­˜åœ¨æ•°æ®ç«äº‰ã€‚java å†…å­˜æ¨¡å‹è§„èŒƒå¯¹æ•°æ®ç«äº‰çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å†™ä¸€ä¸ªå˜é‡ï¼Œ</li>
<li>åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¯»åŒä¸€ä¸ªå˜é‡ï¼Œ</li>
<li>è€Œä¸”å†™å’Œè¯»æ²¡æœ‰é€šè¿‡åŒæ­¥æ¥æ’åºã€‚</li>
</ul>
<p>å½“ä»£ç ä¸­åŒ…å«æ•°æ®ç«äº‰æ—¶ï¼Œç¨‹åºçš„æ‰§è¡Œå¾€å¾€äº§ç”Ÿè¿åç›´è§‰çš„ç»“æœï¼ˆå‰ä¸€ç« çš„ç¤ºä¾‹æ­£æ˜¯å¦‚æ­¤ï¼‰ã€‚å¦‚æœä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºèƒ½æ­£ç¡®åŒæ­¥ï¼Œè¿™ä¸ªç¨‹åºå°†æ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç«äº‰çš„ç¨‹åºã€‚</p>
<p>JMM å¯¹æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„å†…å­˜ä¸€è‡´æ€§åšäº†å¦‚ä¸‹ä¿è¯ï¼š</p>
<ul>
<li>å¦‚æœç¨‹åºæ˜¯æ­£ç¡®åŒæ­¥çš„ï¼Œç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰é¡ºåºä¸€è‡´æ€§ï¼ˆsequentially consistentï¼‰â€“å³ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒï¼ˆé©¬ä¸Šæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ï¼Œè¿™å¯¹äºç¨‹åºå‘˜æ¥è¯´æ˜¯ä¸€ä¸ªæå¼ºçš„ä¿è¯ï¼‰ã€‚è¿™é‡Œçš„åŒæ­¥æ˜¯æŒ‡å¹¿ä¹‰ä¸Šçš„åŒæ­¥ï¼ŒåŒ…æ‹¬å¯¹å¸¸ç”¨åŒæ­¥åŸè¯­ï¼ˆlockï¼Œvolatile å’Œ finalï¼‰çš„æ­£ç¡®ä½¿ç”¨ã€‚</li>
</ul>
<h3 id="é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹"><a href="#é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹" class="headerlink" title="é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹"></a>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹</h3><p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªè¢«è®¡ç®—æœºç§‘å­¦å®¶ç†æƒ³åŒ–äº†çš„ç†è®ºå‚è€ƒæ¨¡å‹ï¼Œå®ƒä¸ºç¨‹åºå‘˜æä¾›äº†æå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æœ‰ä¸¤å¤§ç‰¹æ€§ï¼š</p>
<ul>
<li>ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œå¿…é¡»æŒ‰ç…§ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œã€‚</li>
<li>ï¼ˆä¸ç®¡ç¨‹åºæ˜¯å¦åŒæ­¥ï¼‰æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªå•ä¸€çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚åœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªæ“ä½œéƒ½å¿…é¡»åŸå­æ‰§è¡Œä¸”ç«‹åˆ»å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ã€‚</li>
</ul>
<p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸ºç¨‹åºå‘˜æä¾›çš„è§†å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent53.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent53.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨æ¦‚å¿µä¸Šï¼Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹æœ‰ä¸€ä¸ªå•ä¸€çš„å…¨å±€å†…å­˜ï¼Œè¿™ä¸ªå†…å­˜é€šè¿‡ä¸€ä¸ªå·¦å³æ‘†åŠ¨çš„å¼€å…³å¯ä»¥è¿æ¥åˆ°ä»»æ„ä¸€ä¸ªçº¿ç¨‹ã€‚åŒæ—¶ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¿…é¡»æŒ‰ç¨‹åºçš„é¡ºåºæ¥æ‰§è¡Œå†…å­˜è¯» &#x2F; å†™æ“ä½œã€‚ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ä»»æ„æ—¶é—´ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿æ¥åˆ°å†…å­˜ã€‚å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå›¾ä¸­çš„å¼€å…³è£…ç½®èƒ½æŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜è¯» &#x2F; å†™æ“ä½œä¸²è¡ŒåŒ–ã€‚</p>
<p>ä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªç¤ºæ„å›¾æ¥å¯¹é¡ºåºä¸€è‡´æ€§æ¨¡å‹çš„ç‰¹æ€§åšè¿›ä¸€æ­¥çš„è¯´æ˜ã€‚</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ B å¹¶å‘æ‰§è¡Œã€‚å…¶ä¸­ A çº¿ç¨‹æœ‰ä¸‰ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼šA1-&gt;A2-&gt;A3ã€‚B çº¿ç¨‹ä¹Ÿæœ‰ä¸‰ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨ç¨‹åºä¸­çš„é¡ºåºæ˜¯ï¼šB1-&gt;B2-&gt;B3ã€‚</p>
<p>å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨ç›‘è§†å™¨æ¥æ­£ç¡®åŒæ­¥ï¼šA çº¿ç¨‹çš„ä¸‰ä¸ªæ“ä½œæ‰§è¡Œåé‡Šæ”¾ç›‘è§†å™¨ï¼Œéšå B çº¿ç¨‹è·å–åŒä¸€ä¸ªç›‘è§†å™¨ã€‚é‚£ä¹ˆç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œæ•ˆæœå°†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent54.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent54.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ç°åœ¨æˆ‘ä»¬å†å‡è®¾è¿™ä¸¤ä¸ªçº¿ç¨‹æ²¡æœ‰åšåŒæ­¥ï¼Œä¸‹é¢æ˜¯è¿™ä¸ªæœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent55.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent55.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>æœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­è™½ç„¶æ•´ä½“æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œä½†æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æ•´ä½“æ‰§è¡Œé¡ºåºã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œçº¿ç¨‹ A å’Œ B çœ‹åˆ°çš„æ‰§è¡Œé¡ºåºéƒ½æ˜¯ï¼šB1-&gt;A1-&gt;A2-&gt;B2-&gt;A3-&gt;B3ã€‚ä¹‹æ‰€ä»¥èƒ½å¾—åˆ°è¿™ä¸ªä¿è¯æ˜¯å› ä¸ºé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ¯ä¸ªæ“ä½œå¿…é¡»ç«‹å³å¯¹ä»»æ„çº¿ç¨‹å¯è§ã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨ JMM ä¸­å°±æ²¡æœ‰è¿™ä¸ªä¿è¯ã€‚æœªåŒæ­¥ç¨‹åºåœ¨ JMM ä¸­ä¸ä½†æ•´ä½“çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œè€Œä¸”æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºä¹Ÿå¯èƒ½ä¸ä¸€è‡´ã€‚æ¯”å¦‚ï¼Œåœ¨å½“å‰çº¿ç¨‹æŠŠå†™è¿‡çš„æ•°æ®ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œä¸”è¿˜æ²¡æœ‰åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹å‰ï¼Œè¿™ä¸ªå†™æ“ä½œä»…å¯¹å½“å‰çº¿ç¨‹å¯è§ï¼›ä»å…¶ä»–çº¿ç¨‹çš„è§’åº¦æ¥è§‚å¯Ÿï¼Œä¼šè®¤ä¸ºè¿™ä¸ªå†™æ“ä½œæ ¹æœ¬è¿˜æ²¡æœ‰è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚åªæœ‰å½“å‰çº¿ç¨‹æŠŠæœ¬åœ°å†…å­˜ä¸­å†™è¿‡çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹åï¼Œè¿™ä¸ªå†™æ“ä½œæ‰èƒ½å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å‰çº¿ç¨‹å’Œå…¶å®ƒçº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºå°†ä¸ä¸€è‡´ã€‚</p>
<h3 id="åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ"><a href="#åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ" class="headerlink" title="åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ"></a>åŒæ­¥ç¨‹åºçš„é¡ºåºä¸€è‡´æ€§æ•ˆæœ</h3><p>ä¸‹é¢æˆ‘ä»¬å¯¹å‰é¢çš„ç¤ºä¾‹ç¨‹åº ReorderExample ç”¨ç›‘è§†å™¨æ¥åŒæ­¥ï¼Œçœ‹çœ‹æ­£ç¡®åŒæ­¥çš„ç¨‹åºå¦‚ä½•å…·æœ‰é¡ºåºä¸€è‡´æ€§ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SynchronizedExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
       flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">;</span>
           â€¦â€¦
       <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢ç¤ºä¾‹ä»£ç ä¸­ï¼Œå‡è®¾ A çº¿ç¨‹æ‰§è¡Œ writer() æ–¹æ³•åï¼ŒB çº¿ç¨‹æ‰§è¡Œ reader() æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚æ ¹æ® JMM è§„èŒƒï¼Œè¯¥ç¨‹åºçš„æ‰§è¡Œç»“æœå°†ä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚ä¸‹é¢æ˜¯è¯¥ç¨‹åºåœ¨ä¸¤ä¸ªå†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œæ—¶åºå¯¹æ¯”å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent56.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent56.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰æ“ä½œå®Œå…¨æŒ‰ç¨‹åºçš„é¡ºåºä¸²è¡Œæ‰§è¡Œã€‚è€Œåœ¨ JMM ä¸­ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯ä»¥é‡æ’åºï¼ˆä½† JMM ä¸å…è®¸ä¸´ç•ŒåŒºå†…çš„ä»£ç â€œé€¸å‡ºâ€åˆ°ä¸´ç•ŒåŒºä¹‹å¤–ï¼Œé‚£æ ·ä¼šç ´åç›‘è§†å™¨çš„è¯­ä¹‰ï¼‰ã€‚JMM ä¼šåœ¨é€€å‡ºç›‘è§†å™¨å’Œè¿›å…¥ç›‘è§†å™¨è¿™ä¸¤ä¸ªå…³é”®æ—¶é—´ç‚¹åšä¸€äº›ç‰¹åˆ«å¤„ç†ï¼Œä½¿å¾—çº¿ç¨‹åœ¨è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹å…·æœ‰ä¸é¡ºåºä¸€è‡´æ€§æ¨¡å‹ç›¸åŒçš„å†…å­˜è§†å›¾ï¼ˆå…·ä½“ç»†èŠ‚åæ–‡ä¼šè¯´æ˜ï¼‰ã€‚è™½ç„¶çº¿ç¨‹ A åœ¨ä¸´ç•ŒåŒºå†…åšäº†é‡æ’åºï¼Œä½†ç”±äºç›‘è§†å™¨çš„äº’æ–¥æ‰§è¡Œçš„ç‰¹æ€§ï¼Œè¿™é‡Œçš„çº¿ç¨‹ B æ ¹æœ¬æ— æ³•â€œè§‚å¯Ÿâ€åˆ°çº¿ç¨‹ A åœ¨ä¸´ç•ŒåŒºå†…çš„é‡æ’åºã€‚è¿™ç§é‡æ’åºæ—¢æé«˜äº†æ‰§è¡Œæ•ˆç‡ï¼Œåˆæ²¡æœ‰æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚</p>
<p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JMM åœ¨å…·ä½“å®ç°ä¸Šçš„åŸºæœ¬æ–¹é’ˆï¼šåœ¨ä¸æ”¹å˜ï¼ˆæ­£ç¡®åŒæ­¥çš„ï¼‰ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½çš„ä¸ºç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–æ‰“å¼€æ–¹ä¾¿ä¹‹é—¨ã€‚</p>
<h3 id="æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§"><a href="#æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§" class="headerlink" title="æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§"></a>æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç‰¹æ€§</h3><p>å¯¹äºæœªåŒæ­¥æˆ–æœªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºï¼ŒJMM åªæä¾›æœ€å°å®‰å…¨æ€§ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶è¯»å–åˆ°çš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¹‹å‰æŸä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ï¼Œè¦ä¹ˆæ˜¯é»˜è®¤å€¼ï¼ˆ0ï¼Œnullï¼Œfalseï¼‰ï¼ŒJMM ä¿è¯çº¿ç¨‹è¯»æ“ä½œè¯»å–åˆ°çš„å€¼ä¸ä¼šæ— ä¸­ç”Ÿæœ‰ï¼ˆout of thin airï¼‰çš„å†’å‡ºæ¥ã€‚ä¸ºäº†å®ç°æœ€å°å®‰å…¨æ€§ï¼ŒJVM åœ¨å †ä¸Šåˆ†é…å¯¹è±¡æ—¶ï¼Œé¦–å…ˆä¼šæ¸…é›¶å†…å­˜ç©ºé—´ï¼Œç„¶åæ‰ä¼šåœ¨ä¸Šé¢åˆ†é…å¯¹è±¡ï¼ˆJVM å†…éƒ¨ä¼šåŒæ­¥è¿™ä¸¤ä¸ªæ“ä½œï¼‰ã€‚å› æ­¤ï¼Œåœ¨ä»¥æ¸…é›¶çš„å†…å­˜ç©ºé—´ï¼ˆpre-zeroed memoryï¼‰åˆ†é…å¯¹è±¡æ—¶ï¼ŒåŸŸçš„é»˜è®¤åˆå§‹åŒ–å·²ç»å®Œæˆäº†ã€‚</p>
<p>JMM ä¸ä¿è¯æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´ã€‚å› ä¸ºæœªåŒæ­¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­æ‰§è¡Œæ—¶ï¼Œæ•´ä½“ä¸Šæ˜¯æ— åºçš„ï¼Œå…¶æ‰§è¡Œç»“æœæ— æ³•é¢„çŸ¥ã€‚ä¿è¯æœªåŒæ­¥ç¨‹åºåœ¨ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´æ¯«æ— æ„ä¹‰ã€‚</p>
<p>å’Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸€æ ·ï¼ŒæœªåŒæ­¥ç¨‹åºåœ¨ JMM ä¸­çš„æ‰§è¡Œæ—¶ï¼Œæ•´ä½“ä¸Šä¹Ÿæ˜¯æ— åºçš„ï¼Œå…¶æ‰§è¡Œç»“æœä¹Ÿæ— æ³•é¢„çŸ¥ã€‚åŒæ—¶ï¼ŒæœªåŒæ­¥ç¨‹åºåœ¨è¿™ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç‰¹æ€§æœ‰ä¸‹é¢å‡ ä¸ªå·®å¼‚ï¼š</p>
<ol>
<li>é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼Œè€Œ JMM ä¸ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼ˆæ¯”å¦‚ä¸Šé¢æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºåœ¨ä¸´ç•ŒåŒºå†…çš„é‡æ’åºï¼‰ã€‚è¿™ä¸€ç‚¹å‰é¢å·²ç»è®²è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</li>
<li>é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯æ‰€æœ‰çº¿ç¨‹åªèƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºï¼Œè€Œ JMM ä¸ä¿è¯æ‰€æœ‰çº¿ç¨‹èƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚è¿™ä¸€ç‚¹å‰é¢ä¹Ÿå·²ç»è®²è¿‡ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</li>
<li>JMM ä¸ä¿è¯å¯¹ 64 ä½çš„ long å‹å’Œ double å‹å˜é‡çš„è¯» &#x2F; å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œè€Œé¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯å¯¹æ‰€æœ‰çš„å†…å­˜è¯» &#x2F; å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ã€‚</li>
</ol>
<p>ç¬¬ 3 ä¸ªå·®å¼‚ä¸å¤„ç†å™¨æ€»çº¿çš„å·¥ä½œæœºåˆ¶å¯†åˆ‡ç›¸å…³ã€‚åœ¨è®¡ç®—æœºä¸­ï¼Œæ•°æ®é€šè¿‡æ€»çº¿åœ¨å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´ä¼ é€’ã€‚æ¯æ¬¡å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®ä¼ é€’éƒ½æ˜¯é€šè¿‡ä¸€ç³»åˆ—æ­¥éª¤æ¥å®Œæˆçš„ï¼Œè¿™ä¸€ç³»åˆ—æ­¥éª¤ç§°ä¹‹ä¸ºæ€»çº¿äº‹åŠ¡ï¼ˆbus transactionï¼‰ã€‚æ€»çº¿äº‹åŠ¡åŒ…æ‹¬è¯»äº‹åŠ¡ï¼ˆread transactionï¼‰å’Œå†™äº‹åŠ¡ï¼ˆwrite transactionï¼‰ã€‚è¯»äº‹åŠ¡ä»å†…å­˜ä¼ é€æ•°æ®åˆ°å¤„ç†å™¨ï¼Œå†™äº‹åŠ¡ä»å¤„ç†å™¨ä¼ é€æ•°æ®åˆ°å†…å­˜ï¼Œæ¯ä¸ªäº‹åŠ¡ä¼šè¯» &#x2F; å†™å†…å­˜ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªç‰©ç†ä¸Šè¿ç»­çš„å­—ã€‚è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œæ€»çº¿ä¼šåŒæ­¥è¯•å›¾å¹¶å‘ä½¿ç”¨æ€»çº¿çš„äº‹åŠ¡ã€‚åœ¨ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œæ€»çº¿äº‹åŠ¡æœŸé—´ï¼Œæ€»çº¿ä¼šç¦æ­¢å…¶å®ƒæ‰€æœ‰çš„å¤„ç†å™¨å’Œ I&#x2F;O è®¾å¤‡æ‰§è¡Œå†…å­˜çš„è¯» &#x2F; å†™ã€‚ä¸‹é¢è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºæ„å›¾æ¥è¯´æ˜æ€»çº¿çš„å·¥ä½œæœºåˆ¶ï¼š</p>
<p><img src="/image/Concurrent/Concurrent57.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent57.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾å¤„ç†å™¨ Aï¼ŒB å’Œ C åŒæ—¶å‘æ€»çº¿å‘èµ·æ€»çº¿äº‹åŠ¡ï¼Œè¿™æ—¶æ€»çº¿ä»²è£ï¼ˆbus arbitrationï¼‰ä¼šå¯¹ç«äº‰ä½œå‡ºè£å†³ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾æ€»çº¿åœ¨ä»²è£ååˆ¤å®šå¤„ç†å™¨ A åœ¨ç«äº‰ä¸­è·èƒœï¼ˆæ€»çº¿ä»²è£ä¼šç¡®ä¿æ‰€æœ‰å¤„ç†å™¨éƒ½èƒ½å…¬å¹³çš„è®¿é—®å†…å­˜ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨ A ç»§ç»­å®ƒçš„æ€»çº¿äº‹åŠ¡ï¼Œè€Œå…¶å®ƒä¸¤ä¸ªå¤„ç†å™¨åˆ™è¦ç­‰å¾…å¤„ç†å™¨ A çš„æ€»çº¿äº‹åŠ¡å®Œæˆåæ‰èƒ½å¼€å§‹å†æ¬¡æ‰§è¡Œå†…å­˜è®¿é—®ã€‚å‡è®¾åœ¨å¤„ç†å™¨ A æ‰§è¡Œæ€»çº¿äº‹åŠ¡æœŸé—´ï¼ˆä¸ç®¡è¿™ä¸ªæ€»çº¿äº‹åŠ¡æ˜¯è¯»äº‹åŠ¡è¿˜æ˜¯å†™äº‹åŠ¡ï¼‰ï¼Œå¤„ç†å™¨ D å‘æ€»çº¿å‘èµ·äº†æ€»çº¿äº‹åŠ¡ï¼Œæ­¤æ—¶å¤„ç†å™¨ D çš„è¿™ä¸ªè¯·æ±‚ä¼šè¢«æ€»çº¿ç¦æ­¢ã€‚</p>
<p>æ€»çº¿çš„è¿™äº›å·¥ä½œæœºåˆ¶å¯ä»¥æŠŠæ‰€æœ‰å¤„ç†å™¨å¯¹å†…å­˜çš„è®¿é—®ä»¥ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡Œï¼›åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªå¤„ç†å™¨èƒ½è®¿é—®å†…å­˜ã€‚è¿™ä¸ªç‰¹æ€§ç¡®ä¿äº†å•ä¸ªæ€»çº¿äº‹åŠ¡ä¹‹ä¸­çš„å†…å­˜è¯» &#x2F; å†™æ“ä½œå…·æœ‰åŸå­æ€§ã€‚</p>
<p>åœ¨ä¸€äº› 32 ä½çš„å¤„ç†å™¨ä¸Šï¼Œå¦‚æœè¦æ±‚å¯¹ 64 ä½æ•°æ®çš„è¯» &#x2F; å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œä¼šæœ‰æ¯”è¾ƒå¤§çš„å¼€é”€ã€‚ä¸ºäº†ç…§é¡¾è¿™ç§å¤„ç†å™¨ï¼Œjava è¯­è¨€è§„èŒƒé¼“åŠ±ä½†ä¸å¼ºæ±‚ JVM å¯¹ 64 ä½çš„ long å‹å˜é‡å’Œ double å‹å˜é‡çš„è¯» &#x2F; å†™å…·æœ‰åŸå­æ€§ã€‚å½“ JVM åœ¨è¿™ç§å¤„ç†å™¨ä¸Šè¿è¡Œæ—¶ï¼Œä¼šæŠŠä¸€ä¸ª 64 ä½ long&#x2F; double å‹å˜é‡çš„è¯» &#x2F; å†™æ“ä½œæ‹†åˆ†ä¸ºä¸¤ä¸ª 32 ä½çš„è¯» &#x2F; å†™æ“ä½œæ¥æ‰§è¡Œã€‚è¿™ä¸¤ä¸ª 32 ä½çš„è¯» &#x2F; å†™æ“ä½œå¯èƒ½ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„æ€»çº¿äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œæ­¤æ—¶å¯¹è¿™ä¸ª 64 ä½å˜é‡çš„è¯» &#x2F; å†™å°†ä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<p>å½“å•ä¸ªå†…å­˜æ“ä½œä¸å…·æœ‰åŸå­æ€§ï¼Œå°†å¯èƒ½ä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°åæœã€‚è¯·çœ‹ä¸‹é¢ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent58.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent58.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾å¤„ç†å™¨ A å†™ä¸€ä¸ª long å‹å˜é‡ï¼ŒåŒæ—¶å¤„ç†å™¨ B è¦è¯»è¿™ä¸ª long å‹å˜é‡ã€‚å¤„ç†å™¨ A ä¸­ 64 ä½çš„å†™æ“ä½œè¢«æ‹†åˆ†ä¸ºä¸¤ä¸ª 32 ä½çš„å†™æ“ä½œï¼Œä¸”è¿™ä¸¤ä¸ª 32 ä½çš„å†™æ“ä½œè¢«åˆ†é…åˆ°ä¸åŒçš„å†™äº‹åŠ¡ä¸­æ‰§è¡Œã€‚åŒæ—¶å¤„ç†å™¨ B ä¸­ 64 ä½çš„è¯»æ“ä½œè¢«æ‹†åˆ†ä¸ºä¸¤ä¸ª 32 ä½çš„è¯»æ“ä½œï¼Œä¸”è¿™ä¸¤ä¸ª 32 ä½çš„è¯»æ“ä½œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªçš„è¯»äº‹åŠ¡ä¸­æ‰§è¡Œã€‚å½“å¤„ç†å™¨ A å’Œ B æŒ‰ä¸Šå›¾çš„æ—¶åºæ¥æ‰§è¡Œæ—¶ï¼Œå¤„ç†å™¨ B å°†çœ‹åˆ°ä»…ä»…è¢«å¤„ç†å™¨ Aâ€œå†™äº†ä¸€åŠâ€œçš„æ— æ•ˆå€¼ã€‚</p>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><h3 id="volatile-çš„ç‰¹æ€§"><a href="#volatile-çš„ç‰¹æ€§" class="headerlink" title="volatile çš„ç‰¹æ€§"></a>volatile çš„ç‰¹æ€§</h3><p>å½“æˆ‘ä»¬å£°æ˜å…±äº«å˜é‡ä¸º volatile åï¼Œå¯¹è¿™ä¸ªå˜é‡çš„è¯» &#x2F; å†™å°†ä¼šå¾ˆç‰¹åˆ«ã€‚ç†è§£ volatile ç‰¹æ€§çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯ï¼šæŠŠå¯¹ volatile å˜é‡çš„å•ä¸ªè¯» &#x2F; å†™ï¼Œçœ‹æˆæ˜¯ä½¿ç”¨åŒä¸€ä¸ªç›‘è§†å™¨é”å¯¹è¿™äº›å•ä¸ªè¯» &#x2F; å†™æ“ä½œåšäº†åŒæ­¥ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡å…·ä½“çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">VolatileFeaturesExample</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">volatile</span> <span class="token keyword">long</span> vl <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>  <span class="token comment">// ä½¿ç”¨ volatile å£°æ˜ 64 ä½çš„ long å‹å˜é‡</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       vl <span class="token operator">=</span> l<span class="token punctuation">;</span>   <span class="token comment">// å•ä¸ª volatile å˜é‡çš„å†™</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> getAndIncrement <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       vl<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">// å¤åˆï¼ˆå¤šä¸ªï¼‰volatile å˜é‡çš„è¯» / å†™</span>
   <span class="token punctuation">&#125;</span>


   <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> vl<span class="token punctuation">;</span>   <span class="token comment">// å•ä¸ª volatile å˜é‡çš„è¯»</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡è®¾æœ‰å¤šä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨ä¸Šé¢ç¨‹åºçš„ä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªç¨‹åºåœ¨è¯­æ„ä¸Šå’Œä¸‹é¢ç¨‹åºç­‰ä»·ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">VolatileFeaturesExample</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">long</span> vl <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>               <span class="token comment">// 64 ä½çš„ long å‹æ™®é€šå˜é‡</span>

   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// å¯¹å•ä¸ªçš„æ™®é€š å˜é‡çš„å†™ç”¨åŒä¸€ä¸ªç›‘è§†å™¨åŒæ­¥</span>
       vl <span class="token operator">=</span> l<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> getAndIncrement <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ™®é€šæ–¹æ³•è°ƒç”¨</span>
       <span class="token keyword">long</span> temp <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// è°ƒç”¨å·²åŒæ­¥çš„è¯»æ–¹æ³•</span>
       temp <span class="token operator">+=</span> <span class="token number">1L</span><span class="token punctuation">;</span>                  <span class="token comment">// æ™®é€šå†™æ“ä½œ</span>
       <span class="token function">set</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// è°ƒç”¨å·²åŒæ­¥çš„å†™æ–¹æ³•</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
   <span class="token comment">// å¯¹å•ä¸ªçš„æ™®é€šå˜é‡çš„è¯»ç”¨åŒä¸€ä¸ªç›‘è§†å™¨åŒæ­¥</span>
       <span class="token keyword">return</span> vl<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸Šé¢ç¤ºä¾‹ç¨‹åºæ‰€ç¤ºï¼Œå¯¹ä¸€ä¸ª volatile å˜é‡çš„å•ä¸ªè¯» &#x2F; å†™æ“ä½œï¼Œä¸å¯¹ä¸€ä¸ªæ™®é€šå˜é‡çš„è¯» &#x2F; å†™æ“ä½œä½¿ç”¨åŒä¸€ä¸ªç›‘è§†å™¨é”æ¥åŒæ­¥ï¼Œå®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œæ•ˆæœç›¸åŒã€‚</p>
<p>ç›‘è§†å™¨é”çš„ happens-before è§„åˆ™ä¿è¯é‡Šæ”¾ç›‘è§†å™¨å’Œè·å–ç›‘è§†å™¨çš„ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œè¿™æ„å‘³ç€å¯¹ä¸€ä¸ª volatile å˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ª volatile å˜é‡æœ€åçš„å†™å…¥ã€‚</p>
<p>ç›‘è§†å™¨é”çš„è¯­ä¹‰å†³å®šäº†ä¸´ç•ŒåŒºä»£ç çš„æ‰§è¡Œå…·æœ‰åŸå­æ€§ã€‚è¿™æ„å‘³ç€å³ä½¿æ˜¯ 64 ä½çš„ long å‹å’Œ double å‹å˜é‡ï¼Œåªè¦å®ƒæ˜¯ volatile å˜é‡ï¼Œå¯¹è¯¥å˜é‡çš„è¯»å†™å°±å°†å…·æœ‰åŸå­æ€§ã€‚å¦‚æœæ˜¯å¤šä¸ª volatile æ“ä½œæˆ–ç±»ä¼¼äº volatile++ è¿™ç§å¤åˆæ“ä½œï¼Œè¿™äº›æ“ä½œæ•´ä½“ä¸Šä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œvolatile å˜é‡è‡ªèº«å…·æœ‰ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯è§æ€§ã€‚å¯¹ä¸€ä¸ª volatile å˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ª volatile å˜é‡æœ€åçš„å†™å…¥ã€‚</li>
<li>åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ª volatile å˜é‡çš„è¯» &#x2F; å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äº volatile++ è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚</li>
</ul>
<h3 id="volatile-å†™-è¯»å»ºç«‹çš„-happens-before-å…³ç³»"><a href="#volatile-å†™-è¯»å»ºç«‹çš„-happens-before-å…³ç³»" class="headerlink" title="volatile å†™ - è¯»å»ºç«‹çš„ happens before å…³ç³»"></a>volatile å†™ - è¯»å»ºç«‹çš„ happens before å…³ç³»</h3><p>ä¸Šé¢è®²çš„æ˜¯ volatile å˜é‡è‡ªèº«çš„ç‰¹æ€§ï¼Œå¯¹ç¨‹åºå‘˜æ¥è¯´ï¼Œvolatile å¯¹çº¿ç¨‹çš„å†…å­˜å¯è§æ€§çš„å½±å“æ¯” volatile è‡ªèº«çš„ç‰¹æ€§æ›´ä¸ºé‡è¦ï¼Œä¹Ÿæ›´éœ€è¦æˆ‘ä»¬å»å…³æ³¨ã€‚</p>
<p>ä» JSR-133 å¼€å§‹ï¼Œvolatile å˜é‡çš„å†™ - è¯»å¯ä»¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>ä»å†…å­˜è¯­ä¹‰çš„è§’åº¦æ¥è¯´ï¼Œvolatile ä¸ç›‘è§†å™¨é”æœ‰ç›¸åŒçš„æ•ˆæœï¼švolatile å†™å’Œç›‘è§†å™¨çš„é‡Šæ”¾æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ï¼›volatile è¯»ä¸ç›‘è§†å™¨çš„è·å–æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢ä½¿ç”¨ volatile å˜é‡çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">VolatileExample</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//1</span>
       flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>               <span class="token comment">//2</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//3</span>
           <span class="token keyword">int</span> i <span class="token operator">=</span>  a<span class="token punctuation">;</span>           <span class="token comment">//4</span>
           â€¦â€¦
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡è®¾çº¿ç¨‹ A æ‰§è¡Œ writer() æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹ B æ‰§è¡Œ reader() æ–¹æ³•ã€‚æ ¹æ® happens before è§„åˆ™ï¼Œè¿™ä¸ªè¿‡ç¨‹å»ºç«‹çš„ happens before å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ol>
<li>æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens before 2; 3 happens before 4ã€‚</li>
<li>æ ¹æ® volatile è§„åˆ™ï¼Œ2 happens before 3ã€‚</li>
<li>æ ¹æ® happens before çš„ä¼ é€’æ€§è§„åˆ™ï¼Œ1 happens before 4ã€‚</li>
</ol>
<p>ä¸Šè¿° happens before å…³ç³»çš„å›¾å½¢åŒ–è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent59.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent59.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œæ¯ä¸€ä¸ªç®­å¤´é“¾æ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä»£è¡¨äº†ä¸€ä¸ª happens before å…³ç³»ã€‚é»‘è‰²ç®­å¤´è¡¨ç¤ºç¨‹åºé¡ºåºè§„åˆ™ï¼›æ©™è‰²ç®­å¤´è¡¨ç¤º volatile è§„åˆ™ï¼›è“è‰²ç®­å¤´è¡¨ç¤ºç»„åˆè¿™äº›è§„åˆ™åæä¾›çš„ happens before ä¿è¯ã€‚</p>
<p>è¿™é‡Œ A çº¿ç¨‹å†™ä¸€ä¸ª volatile å˜é‡åï¼ŒB çº¿ç¨‹è¯»åŒä¸€ä¸ª volatile å˜é‡ã€‚A çº¿ç¨‹åœ¨å†™ volatile å˜é‡ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨ B çº¿ç¨‹è¯»åŒä¸€ä¸ª volatile å˜é‡åï¼Œå°†ç«‹å³å˜å¾—å¯¹ B çº¿ç¨‹å¯è§ã€‚</p>
<h3 id="volatile-å†™-è¯»çš„å†…å­˜è¯­ä¹‰"><a href="#volatile-å†™-è¯»çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="volatile å†™ - è¯»çš„å†…å­˜è¯­ä¹‰"></a>volatile å†™ - è¯»çš„å†…å­˜è¯­ä¹‰</h3><p>volatile å†™çš„å†…å­˜è¯­ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“å†™ä¸€ä¸ª volatile å˜é‡æ—¶ï¼ŒJMM ä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚</li>
</ul>
<p>ä»¥ä¸Šé¢ç¤ºä¾‹ç¨‹åº VolatileExample ä¸ºä¾‹ï¼Œå‡è®¾çº¿ç¨‹ A é¦–å…ˆæ‰§è¡Œ writer() æ–¹æ³•ï¼Œéšåçº¿ç¨‹ B æ‰§è¡Œ reader() æ–¹æ³•ï¼Œåˆå§‹æ—¶ä¸¤ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¸­çš„ flag å’Œ a éƒ½æ˜¯åˆå§‹çŠ¶æ€ã€‚ä¸‹å›¾æ˜¯çº¿ç¨‹ A æ‰§è¡Œ volatile å†™åï¼Œå…±äº«å˜é‡çš„çŠ¶æ€ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent60.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent60.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A åœ¨å†™ flag å˜é‡åï¼Œæœ¬åœ°å†…å­˜ A ä¸­è¢«çº¿ç¨‹ A æ›´æ–°è¿‡çš„ä¸¤ä¸ªå…±äº«å˜é‡çš„å€¼è¢«åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚æ­¤æ—¶ï¼Œæœ¬åœ°å†…å­˜ A å’Œä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>volatile è¯»çš„å†…å­˜è¯­ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“è¯»ä¸€ä¸ª volatile å˜é‡æ—¶ï¼ŒJMM ä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚çº¿ç¨‹æ¥ä¸‹æ¥å°†ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯çº¿ç¨‹ B è¯»åŒä¸€ä¸ª volatile å˜é‡åï¼Œå…±äº«å˜é‡çš„çŠ¶æ€ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent61.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent61.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è¯» flag å˜é‡åï¼Œæœ¬åœ°å†…å­˜ B å·²ç»è¢«ç½®ä¸ºæ— æ•ˆã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹ B å¿…é¡»ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚çº¿ç¨‹ B çš„è¯»å–æ“ä½œå°†å¯¼è‡´æœ¬åœ°å†…å­˜ B ä¸ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡çš„å€¼ä¹Ÿå˜æˆä¸€è‡´çš„äº†ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æŠŠ volatile å†™å’Œ volatile è¯»è¿™ä¸¤ä¸ªæ­¥éª¤ç»¼åˆèµ·æ¥çœ‹çš„è¯ï¼Œåœ¨è¯»çº¿ç¨‹ B è¯»ä¸€ä¸ª volatile å˜é‡åï¼Œå†™çº¿ç¨‹ A åœ¨å†™è¿™ä¸ª volatile å˜é‡ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡çš„å€¼éƒ½å°†ç«‹å³å˜å¾—å¯¹è¯»çº¿ç¨‹ B å¯è§ã€‚</p>
<p>ä¸‹é¢å¯¹ volatile å†™å’Œ volatile è¯»çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ï¼š</p>
<ul>
<li>çº¿ç¨‹ A å†™ä¸€ä¸ª volatile å˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ A å‘æ¥ä¸‹æ¥å°†è¦è¯»è¿™ä¸ª volatile å˜é‡çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆå…¶å¯¹å…±äº«å˜é‡æ‰€åœ¨ä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</li>
<li>çº¿ç¨‹ B è¯»ä¸€ä¸ª volatile å˜é‡ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ B æ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨å†™è¿™ä¸ª volatile å˜é‡ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</li>
<li>çº¿ç¨‹ A å†™ä¸€ä¸ª volatile å˜é‡ï¼Œéšåçº¿ç¨‹ B è¯»è¿™ä¸ª volatile å˜é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹ A é€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹ B å‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="volatile-å†…å­˜è¯­ä¹‰çš„å®ç°"><a href="#volatile-å†…å­˜è¯­ä¹‰çš„å®ç°" class="headerlink" title="volatile å†…å­˜è¯­ä¹‰çš„å®ç°"></a>volatile å†…å­˜è¯­ä¹‰çš„å®ç°</h3><p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ JMM å¦‚ä½•å®ç° volatile å†™ &#x2F; è¯»çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>å‰æ–‡æˆ‘ä»¬æåˆ°è¿‡é‡æ’åºåˆ†ä¸ºç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºã€‚ä¸ºäº†å®ç° volatile å†…å­˜è¯­ä¹‰ï¼ŒJMM ä¼šåˆ†åˆ«é™åˆ¶è¿™ä¸¤ç§ç±»å‹çš„é‡æ’åºç±»å‹ã€‚ä¸‹é¢æ˜¯ JMM é’ˆå¯¹ç¼–è¯‘å™¨åˆ¶å®šçš„ volatile é‡æ’åºè§„åˆ™è¡¨ï¼š</p>
<p>æ˜¯å¦èƒ½é‡æ’åº ç¬¬äºŒä¸ªæ“ä½œ ç¬¬ä¸€ä¸ªæ“ä½œ æ™®é€šè¯» &#x2F; å†™ volatile è¯» volatile å†™ æ™®é€šè¯» &#x2F; å†™ NO volatile è¯» NO NO NO volatile å†™ NO NO ä¸¾ä¾‹æ¥è¯´ï¼Œç¬¬ä¸‰è¡Œæœ€åä¸€ä¸ªå•å…ƒæ ¼çš„æ„æ€æ˜¯ï¼šåœ¨ç¨‹åºé¡ºåºä¸­ï¼Œå½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºæ™®é€šå˜é‡çš„è¯»æˆ–å†™æ—¶ï¼Œå¦‚æœç¬¬äºŒä¸ªæ“ä½œä¸º volatile å†™ï¼Œåˆ™ç¼–è¯‘å™¨ä¸èƒ½é‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚</p>
<p>ä»ä¸Šè¡¨æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯ volatile å†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿ volatile å†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ° volatile å†™ä¹‹åã€‚</li>
<li>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ volatile è¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿ volatile è¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ° volatile è¯»ä¹‹å‰ã€‚</li>
<li>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ volatile å†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯ volatile è¯»æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚</li>
</ul>
<p>ä¸ºäº†å®ç° volatile çš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå‘ç°ä¸€ä¸ªæœ€ä¼˜å¸ƒç½®æ¥æœ€å°åŒ–æ’å…¥å±éšœçš„æ€»æ•°å‡ ä¹ä¸å¯èƒ½ï¼Œä¸ºæ­¤ï¼ŒJMM é‡‡å–ä¿å®ˆç­–ç•¥ã€‚ä¸‹é¢æ˜¯åŸºäºä¿å®ˆç­–ç•¥çš„ JMM å†…å­˜å±éšœæ’å…¥ç­–ç•¥ï¼š</p>
<ul>
<li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª StoreStore å±éšœã€‚</li>
<li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚</li>
<li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœã€‚</li>
<li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadStore å±éšœã€‚</li>
</ul>
<p>ä¸Šè¿°å†…å­˜å±éšœæ’å…¥ç­–ç•¥éå¸¸ä¿å®ˆï¼Œä½†å®ƒå¯ä»¥ä¿è¯åœ¨ä»»æ„å¤„ç†å™¨å¹³å°ï¼Œä»»æ„çš„ç¨‹åºä¸­éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„ volatile å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¿å®ˆç­–ç•¥ä¸‹ï¼Œvolatile å†™æ’å…¥å†…å­˜å±éšœåç”Ÿæˆçš„æŒ‡ä»¤åºåˆ—ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent62.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent62.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸Šå›¾ä¸­çš„ StoreStore å±éšœå¯ä»¥ä¿è¯åœ¨ volatile å†™ä¹‹å‰ï¼Œå…¶å‰é¢çš„æ‰€æœ‰æ™®é€šå†™æ“ä½œå·²ç»å¯¹ä»»æ„å¤„ç†å™¨å¯è§äº†ã€‚è¿™æ˜¯å› ä¸º StoreStore å±éšœå°†ä¿éšœä¸Šé¢æ‰€æœ‰çš„æ™®é€šå†™åœ¨ volatile å†™ä¹‹å‰åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚</p>
<p>è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ volatile å†™åé¢çš„ StoreLoad å±éšœã€‚è¿™ä¸ªå±éšœçš„ä½œç”¨æ˜¯é¿å… volatile å†™ä¸åé¢å¯èƒ½æœ‰çš„ volatile è¯» &#x2F; å†™æ“ä½œé‡æ’åºã€‚å› ä¸ºç¼–è¯‘å™¨å¸¸å¸¸æ— æ³•å‡†ç¡®åˆ¤æ–­åœ¨ä¸€ä¸ª volatile å†™çš„åé¢ï¼Œæ˜¯å¦éœ€è¦æ’å…¥ä¸€ä¸ª StoreLoad å±éšœï¼ˆæ¯”å¦‚ï¼Œä¸€ä¸ª volatile å†™ä¹‹åæ–¹æ³•ç«‹å³ returnï¼‰ã€‚ä¸ºäº†ä¿è¯èƒ½æ­£ç¡®å®ç° volatile çš„å†…å­˜è¯­ä¹‰ï¼ŒJMM åœ¨è¿™é‡Œé‡‡å–äº†ä¿å®ˆç­–ç•¥ï¼šåœ¨æ¯ä¸ª volatile å†™çš„åé¢æˆ–åœ¨æ¯ä¸ª volatile è¯»çš„å‰é¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚ä»æ•´ä½“æ‰§è¡Œæ•ˆç‡çš„è§’åº¦è€ƒè™‘ï¼ŒJMM é€‰æ‹©äº†åœ¨æ¯ä¸ª volatile å†™çš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚å› ä¸º volatile å†™ - è¯»å†…å­˜è¯­ä¹‰çš„å¸¸è§ä½¿ç”¨æ¨¡å¼æ˜¯ï¼šä¸€ä¸ªå†™çº¿ç¨‹å†™ volatile å˜é‡ï¼Œå¤šä¸ªè¯»çº¿ç¨‹è¯»åŒä¸€ä¸ª volatile å˜é‡ã€‚å½“è¯»çº¿ç¨‹çš„æ•°é‡å¤§å¤§è¶…è¿‡å†™çº¿ç¨‹æ—¶ï¼Œé€‰æ‹©åœ¨ volatile å†™ä¹‹åæ’å…¥ StoreLoad å±éšœå°†å¸¦æ¥å¯è§‚çš„æ‰§è¡Œæ•ˆç‡çš„æå‡ã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JMM åœ¨å®ç°ä¸Šçš„ä¸€ä¸ªç‰¹ç‚¹ï¼šé¦–å…ˆç¡®ä¿æ­£ç¡®æ€§ï¼Œç„¶åå†å»è¿½æ±‚æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>ä¸‹é¢æ˜¯åœ¨ä¿å®ˆç­–ç•¥ä¸‹ï¼Œvolatile è¯»æ’å…¥å†…å­˜å±éšœåç”Ÿæˆçš„æŒ‡ä»¤åºåˆ—ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent63.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent63.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸Šå›¾ä¸­çš„ LoadLoad å±éšœç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŠŠä¸Šé¢çš„ volatile è¯»ä¸ä¸‹é¢çš„æ™®é€šè¯»é‡æ’åºã€‚LoadStore å±éšœç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŠŠä¸Šé¢çš„ volatile è¯»ä¸ä¸‹é¢çš„æ™®é€šå†™é‡æ’åºã€‚</p>
<p>ä¸Šè¿° volatile å†™å’Œ volatile è¯»çš„å†…å­˜å±éšœæ’å…¥ç­–ç•¥éå¸¸ä¿å®ˆã€‚åœ¨å®é™…æ‰§è¡Œæ—¶ï¼Œåªè¦ä¸æ”¹å˜ volatile å†™ - è¯»çš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µçœç•¥ä¸å¿…è¦çš„å±éšœã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡å…·ä½“çš„ç¤ºä¾‹ä»£ç æ¥è¯´æ˜ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">VolatileBarrierExample</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">int</span> a<span class="token punctuation">;</span>
   <span class="token keyword">volatile</span> <span class="token keyword">int</span> v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">volatile</span> <span class="token keyword">int</span> v2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">readAndWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> i <span class="token operator">=</span> v1<span class="token punctuation">;</span>           <span class="token comment">// ç¬¬ä¸€ä¸ª volatile è¯»</span>
       <span class="token keyword">int</span> j <span class="token operator">=</span> v2<span class="token punctuation">;</span>           <span class="token comment">// ç¬¬äºŒä¸ª volatile è¯»</span>
       a <span class="token operator">=</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>            <span class="token comment">// æ™®é€šå†™</span>
       v1 <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// ç¬¬ä¸€ä¸ª volatile å†™</span>
       v2 <span class="token operator">=</span> j <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// ç¬¬äºŒä¸ª volatile å†™</span>
   <span class="token punctuation">&#125;</span>

   â€¦                    <span class="token comment">// å…¶ä»–æ–¹æ³•</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é’ˆå¯¹ readAndWrite() æ–¹æ³•ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶å¯ä»¥åšå¦‚ä¸‹çš„ä¼˜åŒ–ï¼š</p>
<p><img src="/image/Concurrent/Concurrent64.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent64.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>æ³¨æ„ï¼Œæœ€åçš„ StoreLoad å±éšœä¸èƒ½çœç•¥ã€‚å› ä¸ºç¬¬äºŒä¸ª volatile å†™ä¹‹åï¼Œæ–¹æ³•ç«‹å³ returnã€‚æ­¤æ—¶ç¼–è¯‘å™¨å¯èƒ½æ— æ³•å‡†ç¡®æ–­å®šåé¢æ˜¯å¦ä¼šæœ‰ volatile è¯»æˆ–å†™ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œç¼–è¯‘å™¨å¸¸å¸¸ä¼šåœ¨è¿™é‡Œæ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚</p>
<p>ä¸Šé¢çš„ä¼˜åŒ–æ˜¯é’ˆå¯¹ä»»æ„å¤„ç†å™¨å¹³å°ï¼Œç”±äºä¸åŒçš„å¤„ç†å™¨æœ‰ä¸åŒâ€œæ¾ç´§åº¦â€çš„å¤„ç†å™¨å†…å­˜æ¨¡å‹ï¼Œå†…å­˜å±éšœçš„æ’å…¥è¿˜å¯ä»¥æ ¹æ®å…·ä½“çš„å¤„ç†å™¨å†…å­˜æ¨¡å‹ç»§ç»­ä¼˜åŒ–ã€‚ä»¥ x86 å¤„ç†å™¨ä¸ºä¾‹ï¼Œä¸Šå›¾ä¸­é™¤æœ€åçš„ StoreLoad å±éšœå¤–ï¼Œå…¶å®ƒçš„å±éšœéƒ½ä¼šè¢«çœç•¥ã€‚</p>
<p>å‰é¢ä¿å®ˆç­–ç•¥ä¸‹çš„ volatile è¯»å’Œå†™ï¼Œåœ¨ x86 å¤„ç†å™¨å¹³å°å¯ä»¥ä¼˜åŒ–æˆï¼š</p>
<p><img src="/image/Concurrent/Concurrent65.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent65.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å‰æ–‡æåˆ°è¿‡ï¼Œx86 å¤„ç†å™¨ä»…ä¼šå¯¹å†™ - è¯»æ“ä½œåšé‡æ’åºã€‚X86 ä¸ä¼šå¯¹è¯» - è¯»ï¼Œè¯» - å†™å’Œå†™ - å†™æ“ä½œåšé‡æ’åºï¼Œå› æ­¤åœ¨ x86 å¤„ç†å™¨ä¸­ä¼šçœç•¥æ‰è¿™ä¸‰ç§æ“ä½œç±»å‹å¯¹åº”çš„å†…å­˜å±éšœã€‚åœ¨ x86 ä¸­ï¼ŒJMM ä»…éœ€åœ¨ volatile å†™åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœå³å¯æ­£ç¡®å®ç° volatile å†™ - è¯»çš„å†…å­˜è¯­ä¹‰ã€‚è¿™æ„å‘³ç€åœ¨ x86 å¤„ç†å™¨ä¸­ï¼Œvolatile å†™çš„å¼€é”€æ¯” volatile è¯»çš„å¼€é”€ä¼šå¤§å¾ˆå¤šï¼ˆå› ä¸ºæ‰§è¡Œ StoreLoad å±éšœå¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼‰ã€‚</p>
<h3 id="JSR-133-ä¸ºä»€ä¹ˆè¦å¢å¼º-volatile-çš„å†…å­˜è¯­ä¹‰"><a href="#JSR-133-ä¸ºä»€ä¹ˆè¦å¢å¼º-volatile-çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="JSR-133 ä¸ºä»€ä¹ˆè¦å¢å¼º volatile çš„å†…å­˜è¯­ä¹‰"></a>JSR-133 ä¸ºä»€ä¹ˆè¦å¢å¼º volatile çš„å†…å­˜è¯­ä¹‰</h3><p>åœ¨ JSR-133 ä¹‹å‰çš„æ—§ Java å†…å­˜æ¨¡å‹ä¸­ï¼Œè™½ç„¶ä¸å…è®¸ volatile å˜é‡ä¹‹é—´é‡æ’åºï¼Œä½†æ—§çš„ Java å†…å­˜æ¨¡å‹å…è®¸ volatile å˜é‡ä¸æ™®é€šå˜é‡ä¹‹é—´é‡æ’åºã€‚åœ¨æ—§çš„å†…å­˜æ¨¡å‹ä¸­ï¼ŒVolatileExample ç¤ºä¾‹ç¨‹åºå¯èƒ½è¢«é‡æ’åºæˆä¸‹åˆ—æ—¶åºæ¥æ‰§è¡Œï¼š</p>
<p><img src="/image/Concurrent/Concurrent66.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent66.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨æ—§çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œå½“ 1 å’Œ 2 ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»æ—¶ï¼Œ1 å’Œ 2 ä¹‹é—´å°±å¯èƒ½è¢«é‡æ’åºï¼ˆ3 å’Œ 4 ç±»ä¼¼ï¼‰ã€‚å…¶ç»“æœå°±æ˜¯ï¼šè¯»çº¿ç¨‹ B æ‰§è¡Œ 4 æ—¶ï¼Œä¸ä¸€å®šèƒ½çœ‹åˆ°å†™çº¿ç¨‹ A åœ¨æ‰§è¡Œ 1 æ—¶å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ã€‚</p>
<p>å› æ­¤åœ¨æ—§çš„å†…å­˜æ¨¡å‹ä¸­ ï¼Œvolatile çš„å†™ - è¯»æ²¡æœ‰ç›‘è§†å™¨çš„é‡Šæ”¾ - è·æ‰€å…·æœ‰çš„å†…å­˜è¯­ä¹‰ã€‚ä¸ºäº†æä¾›ä¸€ç§æ¯”ç›‘è§†å™¨é”æ›´è½»é‡çº§çš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æœºåˆ¶ï¼ŒJSR-133 ä¸“å®¶ç»„å†³å®šå¢å¼º volatile çš„å†…å­˜è¯­ä¹‰ï¼šä¸¥æ ¼é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹ volatile å˜é‡ä¸æ™®é€šå˜é‡çš„é‡æ’åºï¼Œç¡®ä¿ volatile çš„å†™ - è¯»å’Œç›‘è§†å™¨çš„é‡Šæ”¾ - è·å–ä¸€æ ·ï¼Œå…·æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚ä»ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™å’Œå¤„ç†å™¨å†…å­˜å±éšœæ’å…¥ç­–ç•¥æ¥çœ‹ï¼Œåªè¦ volatile å˜é‡ä¸æ™®é€šå˜é‡ä¹‹é—´çš„é‡æ’åºå¯èƒ½ä¼šç ´å volatile çš„å†…å­˜è¯­æ„ï¼Œè¿™ç§é‡æ’åºå°±ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™å’Œå¤„ç†å™¨å†…å­˜å±éšœæ’å…¥ç­–ç•¥ç¦æ­¢ã€‚</p>
<p>ç”±äº volatile ä»…ä»…ä¿è¯å¯¹å•ä¸ª volatile å˜é‡çš„è¯» &#x2F; å†™å…·æœ‰åŸå­æ€§ï¼Œè€Œç›‘è§†å™¨é”çš„äº’æ–¥æ‰§è¡Œçš„ç‰¹æ€§å¯ä»¥ç¡®ä¿å¯¹æ•´ä¸ªä¸´ç•ŒåŒºä»£ç çš„æ‰§è¡Œå…·æœ‰åŸå­æ€§ã€‚åœ¨åŠŸèƒ½ä¸Šï¼Œç›‘è§†å™¨é”æ¯” volatile æ›´å¼ºå¤§ï¼›åœ¨å¯ä¼¸ç¼©æ€§å’Œæ‰§è¡Œæ€§èƒ½ä¸Šï¼Œvolatile æ›´æœ‰ä¼˜åŠ¿ã€‚å¦‚æœè¯»è€…æƒ³åœ¨ç¨‹åºä¸­ç”¨ volatile ä»£æ›¿ç›‘è§†å™¨é”ï¼Œè¯·ä¸€å®šè°¨æ…ã€‚</p>
<h2 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h2><h3 id="é”çš„é‡Šæ”¾-è·å–å»ºç«‹çš„-happens-before-å…³ç³»"><a href="#é”çš„é‡Šæ”¾-è·å–å»ºç«‹çš„-happens-before-å…³ç³»" class="headerlink" title="é”çš„é‡Šæ”¾ - è·å–å»ºç«‹çš„ happens before å…³ç³»"></a>é”çš„é‡Šæ”¾ - è·å–å»ºç«‹çš„ happens before å…³ç³»</h3><p>é”æ˜¯ java å¹¶å‘ç¼–ç¨‹ä¸­æœ€é‡è¦çš„åŒæ­¥æœºåˆ¶ã€‚é”é™¤äº†è®©ä¸´ç•ŒåŒºäº’æ–¥æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥è®©é‡Šæ”¾é”çš„çº¿ç¨‹å‘è·å–åŒä¸€ä¸ªé”çš„çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚</p>
<p>ä¸‹é¢æ˜¯é”é‡Šæ”¾ - è·å–çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> 
<span class="token keyword">class</span> <span class="token class-name">MonitorExample</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//1</span>
       a<span class="token operator">++</span><span class="token punctuation">;</span>                             <span class="token comment">//2</span>
   <span class="token punctuation">&#125;</span>                                    <span class="token comment">//3</span>
 
   <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//4</span>
       <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">;</span>                       <span class="token comment">//5</span>
       â€¦â€¦
   <span class="token punctuation">&#125;</span>                                    <span class="token comment">//6</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡è®¾çº¿ç¨‹ A æ‰§è¡Œ writer() æ–¹æ³•ï¼Œéšåçº¿ç¨‹ B æ‰§è¡Œ reader() æ–¹æ³•ã€‚æ ¹æ® happens before è§„åˆ™ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«çš„ happens before å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ol>
<li>æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens before 2, 2 happens before 3; 4 happens before 5, 5 happens before 6ã€‚</li>
<li>æ ¹æ®ç›‘è§†å™¨é”è§„åˆ™ï¼Œ3 happens before 4ã€‚</li>
<li>æ ¹æ® happens before çš„ä¼ é€’æ€§ï¼Œ2 happens before 5ã€‚</li>
</ol>
<p>ä¸Šè¿° happens before å…³ç³»çš„å›¾å½¢åŒ–è¡¨ç°å½¢å¼å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent67.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent67.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œæ¯ä¸€ä¸ªç®­å¤´é“¾æ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä»£è¡¨äº†ä¸€ä¸ª happens before å…³ç³»ã€‚é»‘è‰²ç®­å¤´è¡¨ç¤ºç¨‹åºé¡ºåºè§„åˆ™ï¼›æ©™è‰²ç®­å¤´è¡¨ç¤ºç›‘è§†å™¨é”è§„åˆ™ï¼›è“è‰²ç®­å¤´è¡¨ç¤ºç»„åˆè¿™äº›è§„åˆ™åæä¾›çš„ happens before ä¿è¯ã€‚</p>
<p>ä¸Šå›¾è¡¨ç¤ºåœ¨çº¿ç¨‹ A é‡Šæ”¾äº†é”ä¹‹åï¼Œéšåçº¿ç¨‹ B è·å–åŒä¸€ä¸ªé”ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œ2 happens before 5ã€‚å› æ­¤ï¼Œçº¿ç¨‹ A åœ¨é‡Šæ”¾é”ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨çº¿ç¨‹ B è·å–åŒä¸€ä¸ªé”ä¹‹åï¼Œå°†ç«‹åˆ»å˜å¾—å¯¹ B çº¿ç¨‹å¯è§ã€‚</p>
<h3 id="é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰"><a href="#é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰"></a>é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰</h3><p>å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼ŒJMM ä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚ä»¥ä¸Šé¢çš„ MonitorExample ç¨‹åºä¸ºä¾‹ï¼ŒA çº¿ç¨‹é‡Šæ”¾é”åï¼Œå…±äº«æ•°æ®çš„çŠ¶æ€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent68.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent68.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å½“çº¿ç¨‹è·å–é”æ—¶ï¼ŒJMM ä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚ä»è€Œä½¿å¾—è¢«ç›‘è§†å™¨ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç å¿…é¡»è¦ä»ä¸»å†…å­˜ä¸­å»è¯»å–å…±äº«å˜é‡ã€‚ä¸‹é¢æ˜¯é”è·å–çš„çŠ¶æ€ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent69.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent69.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¯¹æ¯”é”é‡Šæ”¾ - è·å–çš„å†…å­˜è¯­ä¹‰ä¸ volatile å†™ - è¯»çš„å†…å­˜è¯­ä¹‰ï¼Œå¯ä»¥çœ‹å‡ºï¼šé”é‡Šæ”¾ä¸ volatile å†™æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ï¼›é”è·å–ä¸ volatile è¯»æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ä¸‹é¢å¯¹é”é‡Šæ”¾å’Œé”è·å–çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ï¼š</p>
<ul>
<li>çº¿ç¨‹ A é‡Šæ”¾ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ A å‘æ¥ä¸‹æ¥å°†è¦è·å–è¿™ä¸ªé”çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆçº¿ç¨‹ A å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</li>
<li>çº¿ç¨‹ B è·å–ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹ B æ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨é‡Šæ”¾è¿™ä¸ªé”ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</li>
<li>çº¿ç¨‹ A é‡Šæ”¾é”ï¼Œéšåçº¿ç¨‹ B è·å–è¿™ä¸ªé”ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹ A é€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹ B å‘é€æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="é”å†…å­˜è¯­ä¹‰çš„å®ç°"><a href="#é”å†…å­˜è¯­ä¹‰çš„å®ç°" class="headerlink" title="é”å†…å­˜è¯­ä¹‰çš„å®ç°"></a>é”å†…å­˜è¯­ä¹‰çš„å®ç°</h3><p>æœ¬æ–‡å°†å€ŸåŠ© ReentrantLock çš„æºä»£ç ï¼Œæ¥åˆ†æé”å†…å­˜è¯­ä¹‰çš„å…·ä½“å®ç°æœºåˆ¶ã€‚</p>
<p>è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">ReentrantLockExample</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// è·å–é”</span>
   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
       a<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
       lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// é‡Šæ”¾é”</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> reader <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è·å–é”</span>
   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">;</span>
       â€¦â€¦
   <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
       lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// é‡Šæ”¾é”</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ ReentrantLock ä¸­ï¼Œè°ƒç”¨ lock() æ–¹æ³•è·å–é”ï¼›è°ƒç”¨ unlock() æ–¹æ³•é‡Šæ”¾é”ã€‚</p>
<p>ReentrantLock çš„å®ç°ä¾èµ–äº java åŒæ­¥å™¨æ¡†æ¶ AbstractQueuedSynchronizerï¼ˆæœ¬æ–‡ç®€ç§°ä¹‹ä¸º AQSï¼‰ã€‚AQS ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ volatile å˜é‡ï¼ˆå‘½åä¸º stateï¼‰æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œé©¬ä¸Šæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œè¿™ä¸ª volatile å˜é‡æ˜¯ ReentrantLock å†…å­˜è¯­ä¹‰å®ç°çš„å…³é”®ã€‚ ä¸‹é¢æ˜¯ ReentrantLock çš„ç±»å›¾ï¼ˆä»…ç”»å‡ºä¸æœ¬æ–‡ç›¸å…³çš„éƒ¨åˆ†ï¼‰ï¼š</p>
<p><img src="/image/Concurrent/Concurrent70.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent70.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ReentrantLock åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æå…¬å¹³é”ã€‚</p>
<p>ä½¿ç”¨å…¬å¹³é”æ—¶ï¼ŒåŠ é”æ–¹æ³• lock() çš„æ–¹æ³•è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ReentrantLock : lock()</li>
<li>FairSync : lock()</li>
<li>AbstractQueuedSynchronizer : acquire(int arg)</li>
<li>ReentrantLock : tryAcquire(int acquires)</li>
</ol>
<p>åœ¨ç¬¬ 4 æ­¥çœŸæ­£å¼€å§‹åŠ é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// è·å–é”çš„å¼€å§‹ï¼Œé¦–å…ˆè¯» volatile å˜é‡ state</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFirst</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
           <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢æºä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒåŠ é”æ–¹æ³•é¦–å…ˆè¯» volatile å˜é‡ stateã€‚</p>
<p>åœ¨ä½¿ç”¨å…¬å¹³é”æ—¶ï¼Œè§£é”æ–¹æ³• unlock() çš„æ–¹æ³•è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ReentrantLock : unlock()</li>
<li>AbstractQueuedSynchronizer : release(int arg)</li>
<li>Sync : tryRelease(int releases)</li>
</ol>
<p>åœ¨ç¬¬ 3 æ­¥çœŸæ­£å¼€å§‹é‡Šæ”¾é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// é‡Šæ”¾é”çš„æœ€åï¼Œå†™ volatile å˜é‡ state</span>
   <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢çš„æºä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨é‡Šæ”¾é”çš„æœ€åå†™ volatile å˜é‡ stateã€‚</p>
<p>å…¬å¹³é”åœ¨é‡Šæ”¾é”çš„æœ€åå†™ volatile å˜é‡ stateï¼›åœ¨è·å–é”æ—¶é¦–å…ˆè¯»è¿™ä¸ª volatile å˜é‡ã€‚æ ¹æ® volatile çš„ happens-before è§„åˆ™ï¼Œé‡Šæ”¾é”çš„çº¿ç¨‹åœ¨å†™ volatile å˜é‡ä¹‹å‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨è·å–é”çš„çº¿ç¨‹è¯»å–åŒä¸€ä¸ª volatile å˜é‡åå°†ç«‹å³å˜çš„å¯¹è·å–é”çš„çº¿ç¨‹å¯è§ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬åˆ†æéå…¬å¹³é”çš„å†…å­˜è¯­ä¹‰çš„å®ç°ã€‚</p>
<p>éå…¬å¹³é”çš„é‡Šæ”¾å’Œå…¬å¹³é”å®Œå…¨ä¸€æ ·ï¼Œæ‰€ä»¥è¿™é‡Œä»…ä»…åˆ†æéå…¬å¹³é”çš„è·å–ã€‚</p>
<p>ä½¿ç”¨å…¬å¹³é”æ—¶ï¼ŒåŠ é”æ–¹æ³• lock() çš„æ–¹æ³•è°ƒç”¨è½¨è¿¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ReentrantLock : lock()</li>
<li>NonfairSync : lock()</li>
<li>AbstractQueuedSynchronizer : compareAndSetState(int expect, int update)</li>
</ol>
<p>åœ¨ç¬¬ 3 æ­¥çœŸæ­£å¼€å§‹åŠ é”ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„æºä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥æ–¹æ³•ä»¥åŸå­æ“ä½œçš„æ–¹å¼æ›´æ–° state å˜é‡ï¼Œæœ¬æ–‡æŠŠ java çš„ compareAndSet() æ–¹æ³•è°ƒç”¨ç®€ç§°ä¸º CASã€‚JDK æ–‡æ¡£å¯¹è¯¥æ–¹æ³•çš„è¯´æ˜å¦‚ä¸‹ï¼šå¦‚æœå½“å‰çŠ¶æ€å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†åŒæ­¥çŠ¶æ€è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚æ­¤æ“ä½œå…·æœ‰ volatile è¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬åˆ†åˆ«ä»ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„è§’åº¦æ¥åˆ†æ,CAS å¦‚ä½•åŒæ—¶å…·æœ‰ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>å‰æ–‡æˆ‘ä»¬æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨ä¸ä¼šå¯¹ volatile è¯»ä¸ volatile è¯»åé¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºï¼›ç¼–è¯‘å™¨ä¸ä¼šå¯¹ volatile å†™ä¸ volatile å†™å‰é¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚ç»„åˆè¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œæ„å‘³ç€ä¸ºäº†åŒæ—¶å®ç° volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨ä¸èƒ½å¯¹ CAS ä¸ CAS å‰é¢å’Œåé¢çš„ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æåœ¨å¸¸è§çš„ intel x86 å¤„ç†å™¨ä¸­ï¼ŒCAS æ˜¯å¦‚ä½•åŒæ—¶å…·æœ‰ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯ sun.misc.Unsafe ç±»çš„ compareAndSwapInt() æ–¹æ³•çš„æºä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>
                                             <span class="token keyword">int</span> expected<span class="token punctuation">,</span>
                                             <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸ªæœ¬åœ°æ–¹æ³•è°ƒç”¨ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•åœ¨ openjdk ä¸­ä¾æ¬¡è°ƒç”¨çš„ c++ ä»£ç ä¸ºï¼šunsafe.cppï¼Œatomic.cpp å’Œ atomic_windows_x86.inline.hppã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•çš„æœ€ç»ˆå®ç°åœ¨ openjdk çš„å¦‚ä¸‹ä½ç½®ï¼šopenjdk-7-fcs-src-b147-27_jun_2011\openjdk\hotspot\src\os_cpu\windows_x86\vm\ atomic_windows_x86.inline.hppï¼ˆå¯¹åº”äº windows æ“ä½œç³»ç»Ÿï¼ŒX86 å¤„ç†å™¨ï¼‰ã€‚ä¸‹é¢æ˜¯å¯¹åº”äº intel x86 å¤„ç†å™¨çš„æºä»£ç çš„ç‰‡æ®µï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">
&#x2F;&#x2F; Adding a lock prefix to an instruction on MP machine
&#x2F;&#x2F; VC++ doesn&#39;t like the lock prefix to be on a single line
&#x2F;&#x2F; so we can&#39;t insert a label after the lock prefix.
&#x2F;&#x2F; By emitting a lock prefix, we can define a label after it.
#define LOCK_IF_MP(mp) __asm cmp mp, 0  \
                      __asm je L0      \
                      __asm _emit 0xF0 \
                      __asm L0:

inline jint     Atomic::cmpxchg    (jint     exchange_value, volatile jint*     dest, jint     compare_value) &#123;
 &#x2F;&#x2F; alternative for InterlockedCompareExchange
 int mp &#x3D; os::is_MP();
 __asm &#123;
   mov edx, dest
   mov ecx, exchange_value
   mov eax, compare_value
   LOCK_IF_MP(mp)
   cmpxchg dword ptr [edx], ecx
 &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸Šé¢æºä»£ç æ‰€ç¤ºï¼Œç¨‹åºä¼šæ ¹æ®å½“å‰å¤„ç†å™¨çš„ç±»å‹æ¥å†³å®šæ˜¯å¦ä¸º cmpxchg æŒ‡ä»¤æ·»åŠ  lock å‰ç¼€ã€‚å¦‚æœç¨‹åºæ˜¯åœ¨å¤šå¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå°±ä¸º cmpxchg æŒ‡ä»¤åŠ ä¸Š lock å‰ç¼€ï¼ˆlock cmpxchgï¼‰ã€‚åä¹‹ï¼Œå¦‚æœç¨‹åºæ˜¯åœ¨å•å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå°±çœç•¥ lock å‰ç¼€ï¼ˆå•å¤„ç†å™¨è‡ªèº«ä¼šç»´æŠ¤å•å¤„ç†å™¨å†…çš„é¡ºåºä¸€è‡´æ€§ï¼Œä¸éœ€è¦ lock å‰ç¼€æä¾›çš„å†…å­˜å±éšœæ•ˆæœï¼‰ã€‚</p>
<p>intel çš„æ‰‹å†Œå¯¹ lock å‰ç¼€çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¡®ä¿å¯¹å†…å­˜çš„è¯» - æ”¹ - å†™æ“ä½œåŸå­æ‰§è¡Œã€‚åœ¨ Pentium åŠ Pentium ä¹‹å‰çš„å¤„ç†å™¨ä¸­ï¼Œå¸¦æœ‰ lock å‰ç¼€çš„æŒ‡ä»¤åœ¨æ‰§è¡ŒæœŸé—´ä¼šé”ä½æ€»çº¿ï¼Œä½¿å¾—å…¶ä»–å¤„ç†å™¨æš‚æ—¶æ— æ³•é€šè¿‡æ€»çº¿è®¿é—®å†…å­˜ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¼šå¸¦æ¥æ˜‚è´µçš„å¼€é”€ã€‚ä» Pentium 4ï¼ŒIntel Xeon åŠ P6 å¤„ç†å™¨å¼€å§‹ï¼Œintel åœ¨åŸæœ‰æ€»çº¿é”çš„åŸºç¡€ä¸Šåšäº†ä¸€ä¸ªå¾ˆæœ‰æ„ä¹‰çš„ä¼˜åŒ–ï¼šå¦‚æœè¦è®¿é—®çš„å†…å­˜åŒºåŸŸï¼ˆarea of memoryï¼‰åœ¨ lock å‰ç¼€æŒ‡ä»¤æ‰§è¡ŒæœŸé—´å·²ç»åœ¨å¤„ç†å™¨å†…éƒ¨çš„ç¼“å­˜ä¸­è¢«é”å®šï¼ˆå³åŒ…å«è¯¥å†…å­˜åŒºåŸŸçš„ç¼“å­˜è¡Œå½“å‰å¤„äºç‹¬å æˆ–ä»¥ä¿®æ”¹çŠ¶æ€ï¼‰ï¼Œå¹¶ä¸”è¯¥å†…å­˜åŒºåŸŸè¢«å®Œå…¨åŒ…å«åœ¨å•ä¸ªç¼“å­˜è¡Œï¼ˆcache lineï¼‰ä¸­ï¼Œé‚£ä¹ˆå¤„ç†å™¨å°†ç›´æ¥æ‰§è¡Œè¯¥æŒ‡ä»¤ã€‚ç”±äºåœ¨æŒ‡ä»¤æ‰§è¡ŒæœŸé—´è¯¥ç¼“å­˜è¡Œä¼šä¸€ç›´è¢«é”å®šï¼Œå…¶å®ƒå¤„ç†å™¨æ— æ³•è¯» &#x2F; å†™è¯¥æŒ‡ä»¤è¦è®¿é—®çš„å†…å­˜åŒºåŸŸï¼Œå› æ­¤èƒ½ä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ã€‚è¿™ä¸ªæ“ä½œè¿‡ç¨‹å«åšç¼“å­˜é”å®šï¼ˆcache lockingï¼‰ï¼Œç¼“å­˜é”å®šå°†å¤§å¤§é™ä½ lock å‰ç¼€æŒ‡ä»¤çš„æ‰§è¡Œå¼€é”€ï¼Œä½†æ˜¯å½“å¤šå¤„ç†å™¨ä¹‹é—´çš„ç«äº‰ç¨‹åº¦å¾ˆé«˜æˆ–è€…æŒ‡ä»¤è®¿é—®çš„å†…å­˜åœ°å€æœªå¯¹é½æ—¶ï¼Œä»ç„¶ä¼šé”ä½æ€»çº¿ã€‚</li>
<li>ç¦æ­¢è¯¥æŒ‡ä»¤ä¸ä¹‹å‰å’Œä¹‹åçš„è¯»å’Œå†™æŒ‡ä»¤é‡æ’åºã€‚</li>
<li>æŠŠå†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚</li>
</ol>
<p>ä¸Šé¢çš„ç¬¬ 2 ç‚¹å’Œç¬¬ 3 ç‚¹æ‰€å…·æœ‰çš„å†…å­˜å±éšœæ•ˆæœï¼Œè¶³ä»¥åŒæ—¶å®ç° volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ç»è¿‡ä¸Šé¢çš„è¿™äº›åˆ†æï¼Œç°åœ¨æˆ‘ä»¬ç»ˆäºèƒ½æ˜ç™½ä¸ºä»€ä¹ˆ JDK æ–‡æ¡£è¯´ CAS åŒæ—¶å…·æœ‰ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰äº†ã€‚</p>
<p>ç°åœ¨å¯¹å…¬å¹³é”å’Œéå…¬å¹³é”çš„å†…å­˜è¯­ä¹‰åšä¸ªæ€»ç»“ï¼š</p>
<ul>
<li>å…¬å¹³é”å’Œéå…¬å¹³é”é‡Šæ”¾æ—¶ï¼Œæœ€åéƒ½è¦å†™ä¸€ä¸ª volatile å˜é‡ stateã€‚</li>
<li>å…¬å¹³é”è·å–æ—¶ï¼Œé¦–å…ˆä¼šå»è¯»è¿™ä¸ª volatile å˜é‡ã€‚</li>
<li>éå…¬å¹³é”è·å–æ—¶ï¼Œé¦–å…ˆä¼šç”¨ CAS æ›´æ–°è¿™ä¸ª volatile å˜é‡, è¿™ä¸ªæ“ä½œåŒæ—¶å…·æœ‰ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ã€‚</li>
</ul>
<p>ä»æœ¬æ–‡å¯¹ ReentrantLock çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œé”é‡Šæ”¾ - è·å–çš„å†…å­˜è¯­ä¹‰çš„å®ç°è‡³å°‘æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>åˆ©ç”¨ volatile å˜é‡çš„å†™ - è¯»æ‰€å…·æœ‰çš„å†…å­˜è¯­ä¹‰ã€‚</li>
<li>åˆ©ç”¨ CAS æ‰€é™„å¸¦çš„ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ã€‚</li>
</ol>
<h3 id="concurrent-åŒ…çš„å®ç°"><a href="#concurrent-åŒ…çš„å®ç°" class="headerlink" title="concurrent åŒ…çš„å®ç°"></a>concurrent åŒ…çš„å®ç°</h3><p>ç”±äº java çš„ CAS åŒæ—¶å…·æœ‰ volatile è¯»å’Œ volatile å†™çš„å†…å­˜è¯­ä¹‰ï¼Œå› æ­¤ Java çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç°åœ¨æœ‰äº†ä¸‹é¢å››ç§æ–¹å¼ï¼š</p>
<ol>
<li>A çº¿ç¨‹å†™ volatile å˜é‡ï¼Œéšå B çº¿ç¨‹è¯»è¿™ä¸ª volatile å˜é‡ã€‚</li>
<li>A çº¿ç¨‹å†™ volatile å˜é‡ï¼Œéšå B çº¿ç¨‹ç”¨ CAS æ›´æ–°è¿™ä¸ª volatile å˜é‡ã€‚</li>
<li>A çº¿ç¨‹ç”¨ CAS æ›´æ–°ä¸€ä¸ª volatile å˜é‡ï¼Œéšå B çº¿ç¨‹ç”¨ CAS æ›´æ–°è¿™ä¸ª volatile å˜é‡ã€‚</li>
<li>A çº¿ç¨‹ç”¨ CAS æ›´æ–°ä¸€ä¸ª volatile å˜é‡ï¼Œéšå B çº¿ç¨‹è¯»è¿™ä¸ª volatile å˜é‡ã€‚</li>
</ol>
<p>Java çš„ CAS ä¼šä½¿ç”¨ç°ä»£å¤„ç†å™¨ä¸Šæä¾›çš„é«˜æ•ˆæœºå™¨çº§åˆ«åŸå­æŒ‡ä»¤ï¼Œè¿™äº›åŸå­æŒ‡ä»¤ä»¥åŸå­æ–¹å¼å¯¹å†…å­˜æ‰§è¡Œè¯» - æ”¹ - å†™æ“ä½œï¼Œè¿™æ˜¯åœ¨å¤šå¤„ç†å™¨ä¸­å®ç°åŒæ­¥çš„å…³é”®ï¼ˆä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œèƒ½å¤Ÿæ”¯æŒåŸå­æ€§è¯» - æ”¹ - å†™æŒ‡ä»¤çš„è®¡ç®—æœºå™¨ï¼Œæ˜¯é¡ºåºè®¡ç®—å›¾çµæœºçš„å¼‚æ­¥ç­‰ä»·æœºå™¨ï¼Œå› æ­¤ä»»ä½•ç°ä»£çš„å¤šå¤„ç†å™¨éƒ½ä¼šå»æ”¯æŒæŸç§èƒ½å¯¹å†…å­˜æ‰§è¡ŒåŸå­æ€§è¯» - æ”¹ - å†™æ“ä½œçš„åŸå­æŒ‡ä»¤ï¼‰ã€‚åŒæ—¶ï¼Œvolatile å˜é‡çš„è¯» &#x2F; å†™å’Œ CAS å¯ä»¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚æŠŠè¿™äº›ç‰¹æ€§æ•´åˆåœ¨ä¸€èµ·ï¼Œå°±å½¢æˆäº†æ•´ä¸ª concurrent åŒ…å¾—ä»¥å®ç°çš„åŸºçŸ³ã€‚å¦‚æœæˆ‘ä»¬ä»”ç»†åˆ†æ concurrent åŒ…çš„æºä»£ç å®ç°ï¼Œä¼šå‘ç°ä¸€ä¸ªé€šç”¨åŒ–çš„å®ç°æ¨¡å¼ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œå£°æ˜å…±äº«å˜é‡ä¸º volatileï¼›</li>
<li>ç„¶åï¼Œä½¿ç”¨ CAS çš„åŸå­æ¡ä»¶æ›´æ–°æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼›</li>
<li>åŒæ—¶ï¼Œé…åˆä»¥ volatile çš„è¯» &#x2F; å†™å’Œ CAS æ‰€å…·æœ‰çš„ volatile è¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</li>
</ol>
<p>AQSï¼Œéé˜»å¡æ•°æ®ç»“æ„å’ŒåŸå­å˜é‡ç±»ï¼ˆjava.util.concurrent.atomic åŒ…ä¸­çš„ç±»ï¼‰ï¼Œè¿™äº› concurrent åŒ…ä¸­çš„åŸºç¡€ç±»éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ¨¡å¼æ¥å®ç°çš„ï¼Œè€Œ concurrent åŒ…ä¸­çš„é«˜å±‚ç±»åˆæ˜¯ä¾èµ–äºè¿™äº›åŸºç¡€ç±»æ¥å®ç°çš„ã€‚ä»æ•´ä½“æ¥çœ‹ï¼Œconcurrent åŒ…çš„å®ç°ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/image/Concurrent/Concurrent71.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent71.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä¸å‰é¢ä»‹ç»çš„é”å’Œ volatile ç›¸æ¯”è¾ƒï¼Œå¯¹ final åŸŸçš„è¯»å’Œå†™æ›´åƒæ˜¯æ™®é€šçš„å˜é‡è®¿é—®ã€‚å¯¹äº final åŸŸï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¦éµå®ˆä¸¤ä¸ªé‡æ’åºè§„åˆ™ï¼š</p>
<ol>
<li>åœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ª final åŸŸçš„å†™å…¥ï¼Œä¸éšåæŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</li>
<li>åˆæ¬¡è¯»ä¸€ä¸ªåŒ…å« final åŸŸçš„å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸éšååˆæ¬¡è¯»è¿™ä¸ª final åŸŸï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</li>
</ol>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€äº›ç¤ºä¾‹æ€§çš„ä»£ç æ¥åˆ†åˆ«è¯´æ˜è¿™ä¸¤ä¸ªè§„åˆ™ï¼š</p>
<p>î™¶å¤åˆ¶ä»£ç </p>
<pre class="line-numbers language-none"><code class="language-none"> 
public class FinalExample &#123;
   int i;                            &#x2F;&#x2F; æ™®é€šå˜é‡
   final int j;                      &#x2F;&#x2F;final å˜é‡
   static FinalExample obj;
 
   public void FinalExample () &#123;     &#x2F;&#x2F; æ„é€ å‡½æ•°
       i &#x3D; 1;                        &#x2F;&#x2F; å†™æ™®é€šåŸŸ
       j &#x3D; 2;                        &#x2F;&#x2F; å†™ final åŸŸ
   &#125;
 
   public static void writer () &#123;    &#x2F;&#x2F; å†™çº¿ç¨‹ A æ‰§è¡Œ
       obj &#x3D; new FinalExample ();
   &#125;
 
   public static void reader () &#123;       &#x2F;&#x2F; è¯»çº¿ç¨‹ B æ‰§è¡Œ
       FinalExample object &#x3D; obj;       &#x2F;&#x2F; è¯»å¯¹è±¡å¼•ç”¨
       int a &#x3D; object.i;                &#x2F;&#x2F; è¯»æ™®é€šåŸŸ
       int b &#x3D; object.j;                &#x2F;&#x2F; è¯» final åŸŸ
   &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œå‡è®¾ä¸€ä¸ªçº¿ç¨‹ A æ‰§è¡Œ writer () æ–¹æ³•ï¼Œéšåå¦ä¸€ä¸ªçº¿ç¨‹ B æ‰§è¡Œ reader () æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡è¿™ä¸¤ä¸ªçº¿ç¨‹çš„äº¤äº’æ¥è¯´æ˜è¿™ä¸¤ä¸ªè§„åˆ™ã€‚</p>
<h2 id="final"><a href="#final" class="headerlink" title="final"></a>final</h2><h3 id="å†™-final-åŸŸçš„é‡æ’åºè§„åˆ™"><a href="#å†™-final-åŸŸçš„é‡æ’åºè§„åˆ™" class="headerlink" title="å†™ final åŸŸçš„é‡æ’åºè§„åˆ™"></a>å†™ final åŸŸçš„é‡æ’åºè§„åˆ™</h3><p>å†™ final åŸŸçš„é‡æ’åºè§„åˆ™ç¦æ­¢æŠŠ final åŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚è¿™ä¸ªè§„åˆ™çš„å®ç°åŒ…å«ä¸‹é¢ 2 ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>JMM ç¦æ­¢ç¼–è¯‘å™¨æŠŠ final åŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚</li>
<li>ç¼–è¯‘å™¨ä¼šåœ¨ final åŸŸçš„å†™ä¹‹åï¼Œæ„é€ å‡½æ•° return ä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ª StoreStore å±éšœã€‚è¿™ä¸ªå±éšœç¦æ­¢å¤„ç†å™¨æŠŠ final åŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚</li>
</ul>
<p>ç°åœ¨è®©æˆ‘ä»¬åˆ†æ writer () æ–¹æ³•ã€‚writer () æ–¹æ³•åªåŒ…å«ä¸€è¡Œä»£ç ï¼šfinalExample &#x3D; new FinalExample ()ã€‚è¿™è¡Œä»£ç åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ„é€ ä¸€ä¸ª FinalExample ç±»å‹çš„å¯¹è±¡ï¼›</li>
<li>æŠŠè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™å¼•ç”¨å˜é‡ objã€‚</li>
</ol>
<p>å‡è®¾çº¿ç¨‹ B è¯»å¯¹è±¡å¼•ç”¨ä¸è¯»å¯¹è±¡çš„æˆå‘˜åŸŸä¹‹é—´æ²¡æœ‰é‡æ’åºï¼ˆé©¬ä¸Šä¼šè¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå‡è®¾ï¼‰ï¼Œä¸‹å›¾æ˜¯ä¸€ç§å¯èƒ½çš„æ‰§è¡Œæ—¶åºï¼š</p>
<p><img src="/image/Concurrent/Concurrent72.jpg" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent72.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œå†™æ™®é€šåŸŸçš„æ“ä½œè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°äº†æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œè¯»çº¿ç¨‹ B é”™è¯¯çš„è¯»å–äº†æ™®é€šå˜é‡ i åˆå§‹åŒ–ä¹‹å‰çš„å€¼ã€‚è€Œå†™ final åŸŸçš„æ“ä½œï¼Œè¢«å†™ final åŸŸçš„é‡æ’åºè§„åˆ™â€œé™å®šâ€åœ¨äº†æ„é€ å‡½æ•°ä¹‹å†…ï¼Œè¯»çº¿ç¨‹ B æ­£ç¡®çš„è¯»å–äº† final å˜é‡åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<p>å†™ final åŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¯¹è±¡å¼•ç”¨ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œå¯¹è±¡çš„ final åŸŸå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ï¼Œè€Œæ™®é€šåŸŸä¸å…·æœ‰è¿™ä¸ªä¿éšœã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œåœ¨è¯»çº¿ç¨‹ Bâ€œçœ‹åˆ°â€å¯¹è±¡å¼•ç”¨ obj æ—¶ï¼Œå¾ˆå¯èƒ½ obj å¯¹è±¡è¿˜æ²¡æœ‰æ„é€ å®Œæˆï¼ˆå¯¹æ™®é€šåŸŸ i çš„å†™æ“ä½œè¢«é‡æ’åºåˆ°æ„é€ å‡½æ•°å¤–ï¼Œæ­¤æ—¶åˆå§‹å€¼ 2 è¿˜æ²¡æœ‰å†™å…¥æ™®é€šåŸŸ iï¼‰ã€‚</p>
<h3 id="è¯»-final-åŸŸçš„é‡æ’åºè§„åˆ™"><a href="#è¯»-final-åŸŸçš„é‡æ’åºè§„åˆ™" class="headerlink" title="è¯» final åŸŸçš„é‡æ’åºè§„åˆ™"></a>è¯» final åŸŸçš„é‡æ’åºè§„åˆ™</h3><p>è¯» final åŸŸçš„é‡æ’åºè§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆæ¬¡è¯»å¯¹è±¡å¼•ç”¨ä¸åˆæ¬¡è¯»è¯¥å¯¹è±¡åŒ…å«çš„ final åŸŸï¼ŒJMM ç¦æ­¢å¤„ç†å™¨é‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªè§„åˆ™ä»…ä»…é’ˆå¯¹å¤„ç†å™¨ï¼‰ã€‚ç¼–è¯‘å™¨ä¼šåœ¨è¯» final åŸŸæ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœã€‚</li>
</ul>
<p>åˆæ¬¡è¯»å¯¹è±¡å¼•ç”¨ä¸åˆæ¬¡è¯»è¯¥å¯¹è±¡åŒ…å«çš„ final åŸŸï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨é—´æ¥ä¾èµ–å…³ç³»ã€‚ç”±äºç¼–è¯‘å™¨éµå®ˆé—´æ¥ä¾èµ–å…³ç³»ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¸ä¼šé‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚å¤§å¤šæ•°å¤„ç†å™¨ä¹Ÿä¼šéµå®ˆé—´æ¥ä¾èµ–ï¼Œå¤§å¤šæ•°å¤„ç†å™¨ä¹Ÿä¸ä¼šé‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚ä½†æœ‰å°‘æ•°å¤„ç†å™¨å…è®¸å¯¹å­˜åœ¨é—´æ¥ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼ˆæ¯”å¦‚ alpha å¤„ç†å™¨ï¼‰ï¼Œè¿™ä¸ªè§„åˆ™å°±æ˜¯ä¸“é—¨ç”¨æ¥é’ˆå¯¹è¿™ç§å¤„ç†å™¨ã€‚</p>
<p>reader() æ–¹æ³•åŒ…å«ä¸‰ä¸ªæ“ä½œï¼š</p>
<ol>
<li>åˆæ¬¡è¯»å¼•ç”¨å˜é‡ obj;</li>
<li>åˆæ¬¡è¯»å¼•ç”¨å˜é‡ obj æŒ‡å‘å¯¹è±¡çš„æ™®é€šåŸŸ jã€‚</li>
<li>åˆæ¬¡è¯»å¼•ç”¨å˜é‡ obj æŒ‡å‘å¯¹è±¡çš„ final åŸŸ iã€‚</li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬å‡è®¾å†™çº¿ç¨‹ A æ²¡æœ‰å‘ç”Ÿä»»ä½•é‡æ’åºï¼ŒåŒæ—¶ç¨‹åºåœ¨ä¸éµå®ˆé—´æ¥ä¾èµ–çš„å¤„ç†å™¨ä¸Šæ‰§è¡Œï¼Œä¸‹é¢æ˜¯ä¸€ç§å¯èƒ½çš„æ‰§è¡Œæ—¶åºï¼š</p>
<p><img src="/image/Concurrent/Concurrent73.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent73.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œè¯»å¯¹è±¡çš„æ™®é€šåŸŸçš„æ“ä½œè¢«å¤„ç†å™¨é‡æ’åºåˆ°è¯»å¯¹è±¡å¼•ç”¨ä¹‹å‰ã€‚è¯»æ™®é€šåŸŸæ—¶ï¼Œè¯¥åŸŸè¿˜æ²¡æœ‰è¢«å†™çº¿ç¨‹ A å†™å…¥ï¼Œè¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„è¯»å–æ“ä½œã€‚è€Œè¯» final åŸŸçš„é‡æ’åºè§„åˆ™ä¼šæŠŠè¯»å¯¹è±¡ final åŸŸçš„æ“ä½œâ€œé™å®šâ€åœ¨è¯»å¯¹è±¡å¼•ç”¨ä¹‹åï¼Œæ­¤æ—¶è¯¥ final åŸŸå·²ç»è¢« A çº¿ç¨‹åˆå§‹åŒ–è¿‡äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªæ­£ç¡®çš„è¯»å–æ“ä½œã€‚</p>
<p>è¯» final åŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨è¯»ä¸€ä¸ªå¯¹è±¡çš„ final åŸŸä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆè¯»åŒ…å«è¿™ä¸ª final åŸŸçš„å¯¹è±¡çš„å¼•ç”¨ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ç¨‹åºä¸­ï¼Œå¦‚æœè¯¥å¼•ç”¨ä¸ä¸º nullï¼Œé‚£ä¹ˆå¼•ç”¨å¯¹è±¡çš„ final åŸŸä¸€å®šå·²ç»è¢« A çº¿ç¨‹åˆå§‹åŒ–è¿‡äº†ã€‚</p>
<h3 id="å¦‚æœ-final-åŸŸæ˜¯å¼•ç”¨ç±»å‹"><a href="#å¦‚æœ-final-åŸŸæ˜¯å¼•ç”¨ç±»å‹" class="headerlink" title="å¦‚æœ final åŸŸæ˜¯å¼•ç”¨ç±»å‹"></a>å¦‚æœ final åŸŸæ˜¯å¼•ç”¨ç±»å‹</h3><p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ final åŸŸæ˜¯åŸºç¡€æ•°æ®ç±»å‹ï¼Œä¸‹é¢è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœ final åŸŸæ˜¯å¼•ç”¨ç±»å‹ï¼Œå°†ä¼šæœ‰ä»€ä¹ˆæ•ˆæœï¼Ÿ</p>
<p>è¯·çœ‹ä¸‹åˆ—ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> intArray<span class="token punctuation">;</span>                     <span class="token comment">//final æ˜¯å¼•ç”¨ç±»å‹</span>
    <span class="token keyword">static</span> <span class="token class-name">FinalReferenceExample</span> obj<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// æ„é€ å‡½æ•°</span>
       intArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">//1</span>
       intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//2</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> writerOne <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// å†™çº¿ç¨‹ A æ‰§è¡Œ</span>
       obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//3</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> writerTwo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// å†™çº¿ç¨‹ B æ‰§è¡Œ</span>
       obj<span class="token punctuation">.</span>intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                 <span class="token comment">//4</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> reader <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token comment">// è¯»çº¿ç¨‹ C æ‰§è¡Œ</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">//5</span>
           <span class="token keyword">int</span> temp1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//6</span>
       <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œ final åŸŸä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ª int å‹çš„æ•°ç»„å¯¹è±¡ã€‚å¯¹äºå¼•ç”¨ç±»å‹ï¼Œå†™ final åŸŸçš„é‡æ’åºè§„åˆ™å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¢åŠ äº†å¦‚ä¸‹çº¦æŸï¼š</p>
<ol>
<li>åœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ª final å¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œä¸éšååœ¨æ„é€ å‡½æ•°å¤–æŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</li>
</ol>
<p>å¯¹ä¸Šé¢çš„ç¤ºä¾‹ç¨‹åºï¼Œæˆ‘ä»¬å‡è®¾é¦–å…ˆçº¿ç¨‹ A æ‰§è¡Œ writerOne() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåçº¿ç¨‹ B æ‰§è¡Œ writerTwo() æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåçº¿ç¨‹ C æ‰§è¡Œ reader () æ–¹æ³•ã€‚ä¸‹é¢æ˜¯ä¸€ç§å¯èƒ½çš„çº¿ç¨‹æ‰§è¡Œæ—¶åºï¼š</p>
<p><img src="/image/Concurrent/Concurrent74.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent74.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œ1 æ˜¯å¯¹ final åŸŸçš„å†™å…¥ï¼Œ2 æ˜¯å¯¹è¿™ä¸ª final åŸŸå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œ3 æ˜¯æŠŠè¢«æ„é€ çš„å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™æŸä¸ªå¼•ç”¨å˜é‡ã€‚è¿™é‡Œé™¤äº†å‰é¢æåˆ°çš„ 1 ä¸èƒ½å’Œ 3 é‡æ’åºå¤–ï¼Œ2 å’Œ 3 ä¹Ÿä¸èƒ½é‡æ’åºã€‚</p>
<p>JMM å¯ä»¥ç¡®ä¿è¯»çº¿ç¨‹ C è‡³å°‘èƒ½çœ‹åˆ°å†™çº¿ç¨‹ A åœ¨æ„é€ å‡½æ•°ä¸­å¯¹ final å¼•ç”¨å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ã€‚å³ C è‡³å°‘èƒ½çœ‹åˆ°æ•°ç»„ä¸‹æ ‡ 0 çš„å€¼ä¸º 1ã€‚è€Œå†™çº¿ç¨‹ B å¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥ï¼Œè¯»çº¿ç¨‹ C å¯èƒ½çœ‹çš„åˆ°ï¼Œä¹Ÿå¯èƒ½çœ‹ä¸åˆ°ã€‚JMM ä¸ä¿è¯çº¿ç¨‹ B çš„å†™å…¥å¯¹è¯»çº¿ç¨‹ C å¯è§ï¼Œå› ä¸ºå†™çº¿ç¨‹ B å’Œè¯»çº¿ç¨‹ C ä¹‹é—´å­˜åœ¨æ•°æ®ç«äº‰ï¼Œæ­¤æ—¶çš„æ‰§è¡Œç»“æœä¸å¯é¢„çŸ¥ã€‚</p>
<p>å¦‚æœæƒ³è¦ç¡®ä¿è¯»çº¿ç¨‹ C çœ‹åˆ°å†™çº¿ç¨‹ B å¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥ï¼Œå†™çº¿ç¨‹ B å’Œè¯»çº¿ç¨‹ C ä¹‹é—´éœ€è¦ä½¿ç”¨åŒæ­¥åŸè¯­ï¼ˆlock æˆ– volatileï¼‰æ¥ç¡®ä¿å†…å­˜å¯è§æ€§ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆ-final-å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œé€¸å‡ºâ€"><a href="#ä¸ºä»€ä¹ˆ-final-å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œé€¸å‡ºâ€" class="headerlink" title="ä¸ºä»€ä¹ˆ final å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œé€¸å‡ºâ€"></a>ä¸ºä»€ä¹ˆ final å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œé€¸å‡ºâ€</h3><p>å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œå†™ final åŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¼•ç”¨å˜é‡ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œè¯¥å¼•ç”¨å˜é‡æŒ‡å‘çš„å¯¹è±¡çš„ final åŸŸå·²ç»åœ¨æ„é€ å‡½æ•°ä¸­è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ã€‚å…¶å®è¦å¾—åˆ°è¿™ä¸ªæ•ˆæœï¼Œè¿˜éœ€è¦ä¸€ä¸ªä¿è¯ï¼šåœ¨æ„é€ å‡½æ•°å†…éƒ¨ï¼Œä¸èƒ½è®©è¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨ä¸ºå…¶ä»–çº¿ç¨‹å¯è§ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡å¼•ç”¨ä¸èƒ½åœ¨æ„é€ å‡½æ•°ä¸­â€œé€¸å‡ºâ€ã€‚ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹é¢ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">FinalReferenceEscapeExample</span> obj<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                              <span class="token comment">//1 å†™ final åŸŸ</span>
       obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>                          <span class="token comment">//2 this å¼•ç”¨åœ¨æ­¤â€œé€¸å‡ºâ€</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">new</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> reader <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                     <span class="token comment">//3</span>
           <span class="token keyword">int</span> temp <span class="token operator">=</span> obj<span class="token punctuation">.</span>i<span class="token punctuation">;</span>                 <span class="token comment">//4</span>
       <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡è®¾ä¸€ä¸ªçº¿ç¨‹ A æ‰§è¡Œ writer() æ–¹æ³•ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ B æ‰§è¡Œ reader() æ–¹æ³•ã€‚è¿™é‡Œçš„æ“ä½œ 2 ä½¿å¾—å¯¹è±¡è¿˜æœªå®Œæˆæ„é€ å‰å°±ä¸ºçº¿ç¨‹ B å¯è§ã€‚å³ä½¿è¿™é‡Œçš„æ“ä½œ 2 æ˜¯æ„é€ å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œä¸”å³ä½¿åœ¨ç¨‹åºä¸­æ“ä½œ 2 æ’åœ¨æ“ä½œ 1 åé¢ï¼Œæ‰§è¡Œ read() æ–¹æ³•çš„çº¿ç¨‹ä»ç„¶å¯èƒ½æ— æ³•çœ‹åˆ° final åŸŸè¢«åˆå§‹åŒ–åçš„å€¼ï¼Œå› ä¸ºè¿™é‡Œçš„æ“ä½œ 1 å’Œæ“ä½œ 2 ä¹‹é—´å¯èƒ½è¢«é‡æ’åºã€‚å®é™…çš„æ‰§è¡Œæ—¶åºå¯èƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/image/Concurrent/Concurrent75.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent75.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šåœ¨æ„é€ å‡½æ•°è¿”å›å‰ï¼Œè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨ä¸èƒ½ä¸ºå…¶ä»–çº¿ç¨‹å¯è§ï¼Œå› ä¸ºæ­¤æ—¶çš„ final åŸŸå¯èƒ½è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚åœ¨æ„é€ å‡½æ•°è¿”å›åï¼Œä»»æ„çº¿ç¨‹éƒ½å°†ä¿è¯èƒ½çœ‹åˆ° final åŸŸæ­£ç¡®åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<h3 id="final-è¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°"><a href="#final-è¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°" class="headerlink" title="final è¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°"></a>final è¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å®ç°</h3><p>ç°åœ¨æˆ‘ä»¬ä»¥ x86 å¤„ç†å™¨ä¸ºä¾‹ï¼Œè¯´æ˜ final è¯­ä¹‰åœ¨å¤„ç†å™¨ä¸­çš„å…·ä½“å®ç°ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬æåˆ°ï¼Œå†™ final åŸŸçš„é‡æ’åºè§„åˆ™ä¼šè¦æ±‚è¯‘ç¼–å™¨åœ¨ final åŸŸçš„å†™ä¹‹åï¼Œæ„é€ å‡½æ•° return ä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ª StoreStore éšœå±ã€‚è¯» final åŸŸçš„é‡æ’åºè§„åˆ™è¦æ±‚ç¼–è¯‘å™¨åœ¨è¯» final åŸŸçš„æ“ä½œå‰é¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœã€‚</p>
<p>ç”±äº x86 å¤„ç†å™¨ä¸ä¼šå¯¹å†™ - å†™æ“ä½œåšé‡æ’åºï¼Œæ‰€ä»¥åœ¨ x86 å¤„ç†å™¨ä¸­ï¼Œå†™ final åŸŸéœ€è¦çš„ StoreStore éšœå±ä¼šè¢«çœç•¥æ‰ã€‚åŒæ ·ï¼Œç”±äº x86 å¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨é—´æ¥ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œæ‰€ä»¥åœ¨ x86 å¤„ç†å™¨ä¸­ï¼Œè¯» final åŸŸéœ€è¦çš„ LoadLoad å±éšœä¹Ÿä¼šè¢«çœç•¥æ‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ x86 å¤„ç†å™¨ä¸­ï¼Œfinal åŸŸçš„è¯» &#x2F; å†™ä¸ä¼šæ’å…¥ä»»ä½•å†…å­˜å±éšœï¼</p>
<h3 id="JSR-133-ä¸ºä»€ä¹ˆè¦å¢å¼º-final-çš„è¯­ä¹‰"><a href="#JSR-133-ä¸ºä»€ä¹ˆè¦å¢å¼º-final-çš„è¯­ä¹‰" class="headerlink" title="JSR-133 ä¸ºä»€ä¹ˆè¦å¢å¼º final çš„è¯­ä¹‰"></a>JSR-133 ä¸ºä»€ä¹ˆè¦å¢å¼º final çš„è¯­ä¹‰</h3><p>åœ¨æ—§çš„ Java å†…å­˜æ¨¡å‹ä¸­ ï¼Œæœ€ä¸¥é‡çš„ä¸€ä¸ªç¼ºé™·å°±æ˜¯çº¿ç¨‹å¯èƒ½çœ‹åˆ° final åŸŸçš„å€¼ä¼šæ”¹å˜ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹å½“å‰çœ‹åˆ°ä¸€ä¸ªæ•´å½¢ final åŸŸçš„å€¼ä¸º 0ï¼ˆè¿˜æœªåˆå§‹åŒ–ä¹‹å‰çš„é»˜è®¤å€¼ï¼‰ï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¹‹åè¿™ä¸ªçº¿ç¨‹å†å»è¯»è¿™ä¸ª final åŸŸçš„å€¼æ—¶ï¼Œå´å‘ç°å€¼å˜ä¸ºäº† 1ï¼ˆè¢«æŸä¸ªçº¿ç¨‹åˆå§‹åŒ–ä¹‹åçš„å€¼ï¼‰ã€‚æœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯åœ¨æ—§çš„ Java å†…å­˜æ¨¡å‹ä¸­ï¼ŒString çš„å€¼å¯èƒ½ä¼šæ”¹å˜ï¼ˆå‚è€ƒæ–‡çŒ® 2 ä¸­æœ‰ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œå‚è€ƒï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼‰ã€‚</p>
<p>ä¸ºäº†ä¿®è¡¥è¿™ä¸ªæ¼æ´ï¼ŒJSR-133 ä¸“å®¶ç»„å¢å¼ºäº† final çš„è¯­ä¹‰ã€‚é€šè¿‡ä¸º final åŸŸå¢åŠ å†™å’Œè¯»é‡æ’åºè§„åˆ™ï¼Œå¯ä»¥ä¸º java ç¨‹åºå‘˜æä¾›åˆå§‹åŒ–å®‰å…¨ä¿è¯ï¼šåªè¦å¯¹è±¡æ˜¯æ­£ç¡®æ„é€ çš„ï¼ˆè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨åœ¨æ„é€ å‡½æ•°ä¸­æ²¡æœ‰â€œé€¸å‡ºâ€ï¼‰ï¼Œé‚£ä¹ˆä¸éœ€è¦ä½¿ç”¨åŒæ­¥ï¼ˆæŒ‡ lock å’Œ volatile çš„ä½¿ç”¨ï¼‰ï¼Œå°±å¯ä»¥ä¿è¯ä»»æ„çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°è¿™ä¸ª final åŸŸåœ¨æ„é€ å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="å¤„ç†å™¨å†…å­˜æ¨¡å‹"><a href="#å¤„ç†å™¨å†…å­˜æ¨¡å‹" class="headerlink" title="å¤„ç†å™¨å†…å­˜æ¨¡å‹"></a>å¤„ç†å™¨å†…å­˜æ¨¡å‹</h3><p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªç†è®ºå‚è€ƒæ¨¡å‹ï¼ŒJMM å’Œå¤„ç†å™¨å†…å­˜æ¨¡å‹åœ¨è®¾è®¡æ—¶é€šå¸¸ä¼šæŠŠé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä½œä¸ºå‚ç…§ã€‚JMM å’Œå¤„ç†å™¨å†…å­˜æ¨¡å‹åœ¨è®¾è®¡æ—¶ä¼šå¯¹é¡ºåºä¸€è‡´æ€§æ¨¡å‹åšä¸€äº›æ”¾æ¾ï¼Œå› ä¸ºå¦‚æœå®Œå…¨æŒ‰ç…§é¡ºåºä¸€è‡´æ€§æ¨¡å‹æ¥å®ç°å¤„ç†å™¨å’Œ JMMï¼Œé‚£ä¹ˆå¾ˆå¤šçš„å¤„ç†å™¨å’Œç¼–è¯‘å™¨ä¼˜åŒ–éƒ½è¦è¢«ç¦æ­¢ï¼Œè¿™å¯¹æ‰§è¡Œæ€§èƒ½å°†ä¼šæœ‰å¾ˆå¤§çš„å½±å“ã€‚</p>
<p>æ ¹æ®å¯¹ä¸åŒç±»å‹è¯» &#x2F; å†™æ“ä½œç»„åˆçš„æ‰§è¡Œé¡ºåºçš„æ”¾æ¾ï¼Œå¯ä»¥æŠŠå¸¸è§å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹åˆ’åˆ†ä¸ºä¸‹é¢å‡ ç§ç±»å‹ï¼š</p>
<ol>
<li>æ”¾æ¾ç¨‹åºä¸­å†™ - è¯»æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº† total store ordering å†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸º TSOï¼‰ã€‚</li>
<li>åœ¨å‰é¢ 1 çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¾æ¾ç¨‹åºä¸­å†™ - å†™æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº† partial store order å†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸º PSOï¼‰ã€‚</li>
<li>åœ¨å‰é¢ 1 å’Œ 2 çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¾æ¾ç¨‹åºä¸­è¯» - å†™å’Œè¯» - è¯»æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº† relaxed memory order å†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸º RMOï¼‰å’Œ PowerPC å†…å­˜æ¨¡å‹ã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œè¿™é‡Œå¤„ç†å™¨å¯¹è¯» &#x2F; å†™æ“ä½œçš„æ”¾æ¾ï¼Œæ˜¯ä»¥ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ä¸ºå‰æçš„ï¼ˆå› ä¸ºå¤„ç†å™¨è¦éµå®ˆ as-if-serial è¯­ä¹‰ï¼Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–æ€§çš„ä¸¤ä¸ªå†…å­˜æ“ä½œåšé‡æ’åºï¼‰ã€‚</p>
<p>ç”±äºå¸¸è§çš„å¤„ç†å™¨å†…å­˜æ¨¡å‹æ¯” JMM è¦å¼±ï¼Œjava ç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æ‰§è¡ŒæŒ‡ä»¤åºåˆ—çš„é€‚å½“ä½ç½®æ’å…¥å†…å­˜å±éšœæ¥é™åˆ¶å¤„ç†å™¨çš„é‡æ’åºã€‚åŒæ—¶ï¼Œç”±äºå„ç§å¤„ç†å™¨å†…å­˜æ¨¡å‹çš„å¼ºå¼±å¹¶ä¸ç›¸åŒï¼Œä¸ºäº†åœ¨ä¸åŒçš„å¤„ç†å™¨å¹³å°å‘ç¨‹åºå‘˜å±•ç¤ºä¸€ä¸ªä¸€è‡´çš„å†…å­˜æ¨¡å‹ï¼ŒJMM åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸­éœ€è¦æ’å…¥çš„å†…å­˜å±éšœçš„æ•°é‡å’Œç§ç±»ä¹Ÿä¸ç›¸åŒã€‚ä¸‹å›¾å±•ç¤ºäº† JMM åœ¨ä¸åŒå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸­éœ€è¦æ’å…¥çš„å†…å­˜å±éšœçš„ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent76.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent76.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒJMM å±è”½äº†ä¸åŒå¤„ç†å™¨å†…å­˜æ¨¡å‹çš„å·®å¼‚ï¼Œå®ƒåœ¨ä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šä¸º java ç¨‹åºå‘˜å‘ˆç°äº†ä¸€ä¸ªä¸€è‡´çš„å†…å­˜æ¨¡å‹ã€‚</p>
<h3 id="JMMï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»"><a href="#JMMï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»" class="headerlink" title="JMMï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»"></a>JMMï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»</h3><p>JMM æ˜¯ä¸€ä¸ªè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹æ˜¯ç¡¬ä»¶çº§çš„å†…å­˜æ¨¡å‹ï¼Œé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªç†è®ºå‚è€ƒæ¨¡å‹ã€‚ä¸‹é¢æ˜¯è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹å’Œé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹çš„å¼ºå¼±å¯¹æ¯”ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent77.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent77.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šå¸¸è§çš„ 4 ç§å¤„ç†å™¨å†…å­˜æ¨¡å‹æ¯”å¸¸ç”¨çš„ 3 ä¸­è¯­è¨€å†…å­˜æ¨¡å‹è¦å¼±ï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹å’Œè¯­è¨€å†…å­˜æ¨¡å‹éƒ½æ¯”é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹è¦å¼±ã€‚åŒå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸€æ ·ï¼Œè¶Šæ˜¯è¿½æ±‚æ‰§è¡Œæ€§èƒ½çš„è¯­è¨€ï¼Œå†…å­˜æ¨¡å‹è®¾è®¡çš„ä¼šè¶Šå¼±ã€‚</p>
<h3 id="JMM-çš„è®¾è®¡"><a href="#JMM-çš„è®¾è®¡" class="headerlink" title="JMM çš„è®¾è®¡"></a>JMM çš„è®¾è®¡</h3><p><strong>ä» JMM è®¾è®¡è€…çš„è§’åº¦æ¥è¯´ï¼Œåœ¨è®¾è®¡ JMM æ—¶ï¼Œéœ€è¦è€ƒè™‘ä¸¤ä¸ªå…³é”®å› ç´ ï¼š</strong></p>
<ul>
<li><strong>ç¨‹åºå‘˜å¯¹å†…å­˜æ¨¡å‹çš„ä½¿ç”¨ã€‚ç¨‹åºå‘˜å¸Œæœ›å†…å­˜æ¨¡å‹æ˜“äºç†è§£ï¼Œæ˜“äºç¼–ç¨‹ã€‚ç¨‹åºå‘˜å¸Œæœ›åŸºäºä¸€ä¸ªå¼ºå†…å­˜æ¨¡å‹æ¥ç¼–å†™ä»£ç ã€‚</strong></li>
<li><strong>ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹å†…å­˜æ¨¡å‹çš„å®ç°ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸Œæœ›å†…å­˜æ¨¡å‹å¯¹å®ƒä»¬çš„æŸç¼šè¶Šå°‘è¶Šå¥½ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥åšå°½å¯èƒ½å¤šçš„ä¼˜åŒ–æ¥æé«˜æ€§èƒ½ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸Œæœ›å®ç°ä¸€ä¸ªå¼±å†…å­˜æ¨¡å‹ã€‚</strong></li>
</ul>
<p>ç”±äºè¿™ä¸¤ä¸ªå› ç´ äº’ç›¸çŸ›ç›¾ï¼Œæ‰€ä»¥ JSR-133 ä¸“å®¶ç»„åœ¨è®¾è®¡ JMM æ—¶çš„æ ¸å¿ƒç›®æ ‡å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¥½çš„å¹³è¡¡ç‚¹ï¼šä¸€æ–¹é¢è¦ä¸ºç¨‹åºå‘˜æä¾›è¶³å¤Ÿå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„é™åˆ¶è¦å°½å¯èƒ½çš„æ”¾æ¾ã€‚ä¸‹é¢è®©æˆ‘ä»¬çœ‹çœ‹ JSR-133 æ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç›®æ ‡çš„ã€‚</p>
<p>ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹å‰é¢æåˆ°è¿‡çš„è®¡ç®—åœ†é¢ç§¯çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">double</span> pi  <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>    <span class="token comment">//A</span>
<span class="token keyword">double</span> r   <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>     <span class="token comment">//B</span>
<span class="token keyword">double</span> area <span class="token operator">=</span> pi <span class="token operator">*</span> r <span class="token operator">*</span> r<span class="token punctuation">;</span> <span class="token comment">//C</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢è®¡ç®—åœ†çš„é¢ç§¯çš„ç¤ºä¾‹ä»£ç å­˜åœ¨ä¸‰ä¸ª happens- before å…³ç³»ï¼š</p>
<ol>
<li>A happens- before Bï¼›</li>
<li>B happens- before Cï¼›</li>
<li>A happens- before Cï¼›</li>
</ol>
<p>ç”±äº A happens- before Bï¼Œhappens- before çš„å®šä¹‰ä¼šè¦æ±‚ï¼šA æ“ä½œæ‰§è¡Œçš„ç»“æœè¦å¯¹ B å¯è§ï¼Œä¸” A æ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ B æ“ä½œä¹‹å‰ã€‚ ä½†æ˜¯ä»ç¨‹åºè¯­ä¹‰çš„è§’åº¦æ¥è¯´ï¼Œå¯¹ A å’Œ B åšé‡æ’åºå³ä¸ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œä¹Ÿè¿˜èƒ½æé«˜ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ï¼ˆå…è®¸è¿™ç§é‡æ’åºå‡å°‘äº†å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼˜åŒ–çš„æŸç¼šï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢è¿™ 3 ä¸ª happens- before å…³ç³»ä¸­ï¼Œè™½ç„¶ 2 å’Œ 3 æ˜¯å¿…éœ€è¦çš„ï¼Œä½† 1 æ˜¯ä¸å¿…è¦çš„ã€‚å› æ­¤ï¼ŒJMM æŠŠ happens- before è¦æ±‚ç¦æ­¢çš„é‡æ’åºåˆ†ä¸ºäº†ä¸‹é¢ä¸¤ç±»ï¼š</p>
<ul>
<li>ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºã€‚</li>
<li>ä¸ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºã€‚</li>
</ul>
<p>JMM å¯¹è¿™ä¸¤ç§ä¸åŒæ€§è´¨çš„é‡æ’åºï¼Œé‡‡å–äº†ä¸åŒçš„ç­–ç•¥ï¼š</p>
<ul>
<li>å¯¹äºä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢è¿™ç§é‡æ’åºã€‚</li>
<li>å¯¹äºä¸ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMM å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä½œè¦æ±‚ï¼ˆJMM å…è®¸è¿™ç§é‡æ’åºï¼‰ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ JMM çš„è®¾è®¡ç¤ºæ„å›¾ï¼š</p>
<p><img src="/image/Concurrent/Concurrent78.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent78.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºä¸¤ç‚¹ï¼š</p>
<ul>
<li>JMM å‘ç¨‹åºå‘˜æä¾›çš„ happens- before è§„åˆ™èƒ½æ»¡è¶³ç¨‹åºå‘˜çš„éœ€æ±‚ã€‚JMM çš„ happens- before è§„åˆ™ä¸ä½†ç®€å•æ˜“æ‡‚ï¼Œè€Œä¸”ä¹Ÿå‘ç¨‹åºå‘˜æä¾›äº†è¶³å¤Ÿå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ï¼ˆæœ‰äº›å†…å­˜å¯è§æ€§ä¿è¯å…¶å®å¹¶ä¸ä¸€å®šçœŸå®å­˜åœ¨ï¼Œæ¯”å¦‚ä¸Šé¢çš„ A happens- before Bï¼‰ã€‚</li>
<li>JMM å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„æŸç¼šå·²ç»å°½å¯èƒ½çš„å°‘ã€‚ä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒJMM å…¶å®æ˜¯åœ¨éµå¾ªä¸€ä¸ªåŸºæœ¬åŸåˆ™ï¼šåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼ˆæŒ‡çš„æ˜¯å•çº¿ç¨‹ç¨‹åºå’Œæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºï¼‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆä¼˜åŒ–éƒ½è¡Œã€‚æ¯”å¦‚ï¼Œå¦‚æœç¼–è¯‘å™¨ç»è¿‡ç»†è‡´çš„åˆ†æåï¼Œè®¤å®šä¸€ä¸ªé”åªä¼šè¢«å•ä¸ªçº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å¯ä»¥è¢«æ¶ˆé™¤ã€‚å†æ¯”å¦‚ï¼Œå¦‚æœç¼–è¯‘å™¨ç»è¿‡ç»†è‡´çš„åˆ†æåï¼Œè®¤å®šä¸€ä¸ª volatile å˜é‡ä»…ä»…åªä¼šè¢«å•ä¸ªçº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯ä»¥æŠŠè¿™ä¸ª volatile å˜é‡å½“ä½œä¸€ä¸ªæ™®é€šå˜é‡æ¥å¯¹å¾…ã€‚è¿™äº›ä¼˜åŒ–æ—¢ä¸ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œåˆèƒ½æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</li>
</ul>
<h3 id="JMM-çš„å†…å­˜å¯è§æ€§ä¿è¯"><a href="#JMM-çš„å†…å­˜å¯è§æ€§ä¿è¯" class="headerlink" title="JMM çš„å†…å­˜å¯è§æ€§ä¿è¯"></a>JMM çš„å†…å­˜å¯è§æ€§ä¿è¯</h3><p>Java ç¨‹åºçš„å†…å­˜å¯è§æ€§ä¿è¯æŒ‰ç¨‹åºç±»å‹å¯ä»¥åˆ†ä¸ºä¸‹åˆ—ä¸‰ç±»ï¼š</p>
<ol>
<li>å•çº¿ç¨‹ç¨‹åºã€‚å•çº¿ç¨‹ç¨‹åºä¸ä¼šå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚ç¼–è¯‘å™¨ï¼Œruntime å’Œå¤„ç†å™¨ä¼šå…±åŒç¡®ä¿å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚</li>
<li>æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰é¡ºåºä¸€è‡´æ€§ï¼ˆç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒï¼‰ã€‚è¿™æ˜¯ JMM å…³æ³¨çš„é‡ç‚¹ï¼ŒJMM é€šè¿‡é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„é‡æ’åºæ¥ä¸ºç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</li>
<li>æœªåŒæ­¥ &#x2F; æœªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚JMM ä¸ºå®ƒä»¬æä¾›äº†æœ€å°å®‰å…¨æ€§ä¿éšœï¼šçº¿ç¨‹æ‰§è¡Œæ—¶è¯»å–åˆ°çš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¹‹å‰æŸä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ï¼Œè¦ä¹ˆæ˜¯é»˜è®¤å€¼ï¼ˆ0ï¼Œnullï¼Œfalseï¼‰ã€‚</li>
</ol>
<p>ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸‰ç±»ç¨‹åºåœ¨ JMM ä¸­ä¸åœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœçš„å¼‚åŒï¼š</p>
<p><img src="/image/Concurrent/Concurrent79.png" class="lazyload placeholder" data-srcset="/image/Concurrent/Concurrent79.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg"></p>
<p>åªè¦å¤šçº¿ç¨‹ç¨‹åºæ˜¯æ­£ç¡®åŒæ­¥çš„ï¼ŒJMM ä¿è¯è¯¥ç¨‹åºåœ¨ä»»æ„çš„å¤„ç†å™¨å¹³å°ä¸Šçš„æ‰§è¡Œç»“æœï¼Œä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´ã€‚</p>
<h3 id="JSR-133-å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥"><a href="#JSR-133-å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥" class="headerlink" title="JSR-133 å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥"></a>JSR-133 å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥</h3><p>JSR-133 å¯¹ JDK5 ä¹‹å‰çš„æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥ä¸»è¦æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>å¢å¼º volatile çš„å†…å­˜è¯­ä¹‰ã€‚æ—§å†…å­˜æ¨¡å‹å…è®¸ volatile å˜é‡ä¸æ™®é€šå˜é‡é‡æ’åºã€‚JSR-133 ä¸¥æ ¼é™åˆ¶ volatile å˜é‡ä¸æ™®é€šå˜é‡çš„é‡æ’åºï¼Œä½¿ volatile çš„å†™ - è¯»å’Œé”çš„é‡Šæ”¾ - è·å–å…·æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</li>
<li>å¢å¼º final çš„å†…å­˜è¯­ä¹‰ã€‚åœ¨æ—§å†…å­˜æ¨¡å‹ä¸­ï¼Œå¤šæ¬¡è¯»å–åŒä¸€ä¸ª final å˜é‡çš„å€¼å¯èƒ½ä¼šä¸ç›¸åŒã€‚ä¸ºæ­¤ï¼ŒJSR-133 ä¸º final å¢åŠ äº†ä¸¤ä¸ªé‡æ’åºè§„åˆ™ã€‚ç°åœ¨ï¼Œfinal å…·æœ‰äº†åˆå§‹åŒ–å®‰å…¨æ€§ã€‚</li>
</ul>

      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/Java-Concurrent/" class="">
              Java-Concurrent
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>ä½œè€…:  </strong>ctrl</a>
    </li>
    <li class="post-copyright-link">
    <strong>æ–‡ç« é“¾æ¥:  </strong>
    <a href="/2022/11/23/java-concurrent/" target="_blank" title="Java-Concurrent">http://example.com/2022/11/23/java-concurrent/</a>
    </li>
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜:   </strong>
      æœ¬ç½‘ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–,å‡é‡‡ç”¨ <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„!
    </li>
  </ul>
<div>
      
    </article>
    <!-- ä¸Šä¸€ç¯‡æ–‡ç« å’Œä¸‹ä¸€ç¯‡æ–‡ç«  -->
    
      <!-- æ–‡ç« è¯¦æƒ…é¡µçš„ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µ -->
<div class="post-nav">





  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="/medias/1.jpg" class="lazyload placeholder" data-srcset="/medias/1.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" src="" alt="">
    </div>
    <a href="/2022/11/22/learn-springcloud/" class="post-nav-link">
      <div class="title">
        ä¸‹ä¸€ç¯‡: <i class="fas fa-angle-right"></i>
        <div class="title-text">Learn-SpringCloud</div>
      </div>
      <!-- <div class="content">
        


SpingBoot å¤ä¹ maven
ä¸» pom.xml&lt;?xml version="1.0" encodin
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- æ‰“èµ -->
    
      <div id="appDonate" class="post-donate">
  <div id="donate_board" class="donate_bar center" ref="donate">
    <a id="btn_donate" class="btn_donate" href="javascript:;" title="æ‰“èµ" @click="showDialogDrawer()"></a>
  </div>
  <transition name="fade">
    <div 
      class="donate-box-mask"
      v-cloak 
      v-show="visible"
      @click="cancelDialogDrawer()"
    >
    </div>
  </transition>
  <transition name="bounce">
    <div class="donate-box" v-cloak v-show="visible">
      <div class="donate-box_close">
        <i class="fas fa-times" aria-hidden="true" @click="cancelDialogDrawer" pointer></i>
      </div>
      <div class="donate-box_title">
        <h4>
          ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›
        </h4>
      </div>
      <div class="donate-box_tab">
        <div class="Alipay" pointer :class="{'active': tabActive === 'Alipay'}" @click="changeTabActive('Alipay')">
          æ”¯ä»˜å®
        </div>
        <div class="WeChatpay" pointer :class="{'active': tabActive === 'WeChatpay'}" @click="changeTabActive('WeChatpay')">
          å¾®ä¿¡
        </div>
      </div>
      <div class="donate-box_img">
        <div class="AlipayImg" v-show="tabActive === 'Alipay'">
          <img src="/medias/zfb.jpg" class="lazyload placeholder" data-srcset="/medias/zfb.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="æ”¯ä»˜å®æ‰“èµ" />
        </div> 
        <div class="WeChatpayImg" v-show="tabActive === 'WeChatpay'">
          <img src="/medias/wx.jpg" class="lazyload placeholder" data-srcset="/medias/wx.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="å¾®ä¿¡æ‰“èµ" />
        </div>
      </div>
    </div>
  </transition>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDonate',
    data: {
      visible: false,
      tabActive: 'Alipay',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialogDrawer() {
        this.visible = true;
        // é˜²æ­¢é¡µé¢æ»šåŠ¨ï¼Œåªèƒ½è®©å¼¹æ¡†æ»šåŠ¨
        // function getScroll() {
        //   return {
        //     left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0,
        //     top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
        //   };
        // }
        this.top = $(document).scrollTop() // or getScroll().top
        // console.log('aa', $('.main-content'));
        body.style.cssText = 'overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
      changeTabActive(name) {
        this.tabActive = name;
      }
    },
    created() {}
  })
</script>
    

    <!-- åˆ†äº« -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- æ–‡ç« è¯¦æƒ…é¡µçš„åˆ†äº« -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- è¯„è®º -->
    <!-- è¯„è®º -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- ç›®å½• -->
  <!-- æ–‡ç« è¯¦æƒ…é¡µå³ä¾§ç›®å½• -->

  <div class="toc-aside">
    <div class="toc-main">
      <div class="toc-aside-title">
        <i class="fas fa-list-ul" aria-hidden="true"></i><span>æœ¬æ–‡ç›®å½•</span>
        
          <div class="toc-open-close">æœ¬æ–‡ç›®å½•</div>
        
      </div>
      <div class="toc-content">
        <div class="toc"></div>
      </div>
    </div>
  </div>

  <!-- æ‰‹æœºç«¯ç›®å½•æŒ‰é’® -->
  <div id="toc-mobile-btn">
    <i class="fas fa-list-ul" aria-hidden="true"></i>
  </div>
  <!-- jsåœ¨scriptsç›®å½•ä¸‹çš„çš„toc.ejsé‡Œé¢ -->
  

  <script>
    function openBtnClickFn () {
      let openOrCloseBtn = $('.toc-aside .toc-aside-title .toc-open-close');
      let open = eval('' || 'true');
      openOrCloseBtn.click(function() {
        if (open === true) {
          $(".toc-aside").css({'width': 0, 'padding': 0});
          $(".toc-content").css({'width': 0});
          $(".toc-aside-title span, .toc-aside-title i").css({'display': 'none'});
          $(".main-content").css({'width': '75%', 'margin': '10px auto'});
          open = false;
        } else {
          $(".toc-aside").css({'width': '350px', 'padding': '0 10px'});
          $(".toc-content").css({'width': '350px'});
          $(".toc-aside-title span, .toc-aside-title i").css({'display': 'inline-block'});
          $(".main-content").css({'width': '60%', 'margin-right': '10px', 'margin-left': 'calc(40% - 400px)'});
          open = true;
        }
      });
    };
    openBtnClickFn();
    document.addEventListener('pjax:complete', function () {
      openBtnClickFn();
    })
    
  </script>


  <!-- å›¾ç‰‡æ”¾å¤§ Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- æ–‡ç« è¯¦æƒ…é¡µèƒŒæ™¯å›¾ -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //æ·»åŠ æ–¹æ³•
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '100000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || '';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// éhttp or httpså¼€å¤´
						// æœ¬åœ°æ–‡ä»¶
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // åˆ é™¤ç¬¬ä¸€ä¸ªå­—ç¬¦ '/',å› ä¸º configRootæœ€åä¸€ä¸ªå­—ç¬¦ä¸º /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'default',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- é¡µè„š -->
    
  
  <div class="footer bg-color">

	<div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright Â© 2019 - 2022 <a target="_blank" rel="noopener" href="https://github.com/ctrl-github">ctrl-github</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a> </p>

          </div>
        
      
        
          
            <!-- ä¸è’œå­ç»Ÿè®¡ -->
            <!-- ä¸è’œå­ç»Ÿè®¡ -->
<span id="busuanzi_container_site_pv">
      <i class="fas fa-eye" aria-hidden="true"></i>æœ¬ç«™æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span> æ¬¡
</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv" style='display:none'>
      <i class="fas fa-users" aria-hidden="true"></i>æœ¬ç«™è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span> äºº
</span>

          
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
	<div>
	å¤‡æ¡ˆå·ï¼š<a style="color:#666" target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">	<img class="img" style="border: 0;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAA5z2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTQgNzkuMTUxNDgxLCAyMDEzLzAzLzEzLTEyOjA5OjE1ICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgICAgICAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgICAgICAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICAgICAgICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdG9yVG9vbD5BZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpPC94bXA6Q3JlYXRvclRvb2w+CiAgICAgICAgIDx4bXA6Q3JlYXRlRGF0ZT4yMDE5LTA5LTIzVDEyOjA5OjI4KzA4OjAwPC94bXA6Q3JlYXRlRGF0ZT4KICAgICAgICAgPHhtcDpNZXRhZGF0YURhdGU+MjAxOS0wOS0yM1QxMjowOToyOCswODowMDwveG1wOk1ldGFkYXRhRGF0ZT4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTktMDktMjNUMTI6MDk6MjgrMDg6MDA8L3htcDpNb2RpZnlEYXRlPgogICAgICAgICA8eG1wTU06SW5zdGFuY2VJRD54bXAuaWlkOjg0OTNiNTZlLWM2MmMtY2I0Zi1hMzBmLWM5ZDk3MGNjZTkyMjwveG1wTU06SW5zdGFuY2VJRD4KICAgICAgICAgPHhtcE1NOkRvY3VtZW50SUQ+eG1wLmRpZDo5MmFhMDM0YS1lMDk3LTc3NDktYWI1YS03ZTJiMTI1MTk2ZjY8L3htcE1NOkRvY3VtZW50SUQ+CiAgICAgICAgIDx4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ+eG1wLmRpZDo5MmFhMDM0YS1lMDk3LTc3NDktYWI1YS03ZTJiMTI1MTk2ZjY8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOkhpc3Rvcnk+CiAgICAgICAgICAgIDxyZGY6U2VxPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5jcmVhdGVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6OTJhYTAzNGEtZTA5Ny03NzQ5LWFiNWEtN2UyYjEyNTE5NmY2PC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDE5LTA5LTIzVDEyOjA5OjI4KzA4OjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDo4NDkzYjU2ZS1jNjJjLWNiNGYtYTMwZi1jOWQ5NzBjY2U5MjI8L3N0RXZ0Omluc3RhbmNlSUQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDp3aGVuPjIwMTktMDktMjNUMTI6MDk6MjgrMDg6MDA8L3N0RXZ0OndoZW4+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpzb2Z0d2FyZUFnZW50PkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cyk8L3N0RXZ0OnNvZnR3YXJlQWdlbnQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpjaGFuZ2VkPi88L3N0RXZ0OmNoYW5nZWQ+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICA8L3JkZjpTZXE+CiAgICAgICAgIDwveG1wTU06SGlzdG9yeT4KICAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9wbmc8L2RjOmZvcm1hdD4KICAgICAgICAgPHBob3Rvc2hvcDpDb2xvck1vZGU+MzwvcGhvdG9zaG9wOkNvbG9yTW9kZT4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgICAgPHRpZmY6WFJlc29sdXRpb24+NzIwMDAwLzEwMDAwPC90aWZmOlhSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj43MjAwMDAvMTAwMDA8L3RpZmY6WVJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+NjU1MzU8L2V4aWY6Q29sb3JTcGFjZT4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjIwPC9leGlmOlBpeGVsWERpbWVuc2lvbj4KICAgICAgICAgPGV4aWY6UGl4ZWxZRGltZW5zaW9uPjIyPC9leGlmOlBpeGVsWURpbWVuc2lvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz4jh4n+AAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAATMSURBVHjarNVbbBR1FMfx78zOzs5Od7v3btcuEmgFilyqgNdaBI1cAgUxIWCMikFEjRqJPGh8IRgDLxjReAliFEKMCglJIQSoNcolgjEQAbmUUqC7pbS73XZnd2d3ZmfHB7GKwfji7+08/D/5n+T/P0ewbZv/MxJAme4bRTVQBcZxOvcd4I5FL9YWLp1o/X7fz8+X9LL88GNTtwSnTNl9dtdXicaFS0CuB/pJX9gNQGjcmj/AW2QWsPqLF19vtfVOpaek4gj4Kew894H+Sdt7zY+MbQM+B/b886B4C0zp+Hhrx9Or2pfmileUcR4HK5XrrFZ6eOD+KMH7o9LKVQcfP7B5Qxvg+i8wXjqxfv/7O4ZZvnIsz8az+D49Q/q8RbrLYnjBJyyyTvHatmVs2WVin//sW0D5N7Dx6p63u1oWnGrxN0R5OXyK7h1ZxFF+LM2AUgUh4ufoK0dYqp4g+uBdPLpg78KBw1svAeNvAvNnu5CK+z1t573y8d7pzJuukTuZRbw6jOB34Rq0KB65jnNMCCWnk/ryGEvmGHRcnMj2Q1bMI+TdwTHP3HTDeOWn7zZVBDdIBaq1XrJ94LRMGCwi1KvI0/yI1/LIVEh169QFSyAIZHIiroi0CRgzAl45d/AJI5lsDnhkKLuwYzHCzbXksNEeCGEtj+NZ14T62hTEiErNtDD5ggG2TaxGhcTJWYM9R58bAVVPoDGrmYyNFEEJceCYijS7mvTC0VhJDeHXPIW91zG7h5DXNhN8fSo7t2WAKpomS+S7+ikmuuIjYGWwd2E2IzEprhG/R+aj7VX8sCFB04wYPtVL4UyGSn+J4qkM3uQQp9dfYPM2F9EmP5PrhkklS5iD55pHQFHK+7WsSPXABZbOsSibHsw9fYS+/gWxzokRcVCpkQjPjhHruERqy2nyhoMlrU686U60rITkFZ0jX8+t3t4ujr/cakXrWHGvxqa6CB8lGzF7zhBKdyL63OhnMmgNNSQDMb4R3VDtZ8V9/ZS9cfx3CqiBUXtHQBBr7KxNb5fGpMZu3nljGm+vbWGPNhmyJq2FNEG/yM69XnKoQIA1LynMaOiktxMoFqiUtakjoOQ3ppe9Ucw+k0T/WV5tdrGkvYqOfQXOiVOYO/EiMXeKclsdRkZn1ASVt+Ze5vrRyxRMBSUsI/nlCQCCbduUcsefTB/buEPvMyilTEhcoX5xE66oAlYaKy2R69fxjQnC6BAkUnTvPo/uDeMZ68Fdq+JrWD5TDsz/8U8Qh+B6avD0pg+tou5LHepDqrKpndmINahjFvKIqoISrEKQnaSPdlG2JHzT6zGLpH3jW5bJTrVdDsz/o+VSqgLoyWKfW1eiFV90dgPWcB5Ly4Iq45D9yG4whnLkExmU0SGUeJTSUIFiUrPdo3IY5AgGbjwbB4dxcPjNmru9tc5AjNJwhYolUbEcFAc0sCsY6WFynQMIDicIAsVrKZxukehDsbCsai/IqvbXxHaFZgAszvQe2mgkflshOwpVashFOW+AYOIoDVHWDbwTwjgUB4aeQ6wKIwRqr5al+i2KGnn3phVwIwXglczZ6Dp9eGBeyeyZedvEyMSKJngUvxiU3F60a1x1R/wFqabl5GBXf7t+JXNg9ENU/j4Phf97Sf0+ADr3CMhtMiuNAAAAAElFTkSuQmCC" alt="">
	æ¹˜ICPå¤‡2022006791å·</a>    

	</div>
    
  </div>



    <!-- æ¸²æŸ“æš—é»‘æŒ‰é’® -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>å…³ç¯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- æ¸²æŸ“å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- æ¸²æŸ“å·¦ä¸‹è§’éŸ³ä¹æ’­æ”¾å™¨ -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  font-size: 15px;
  color: #42b983;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="tencent"
  type="playlist"
  id="8062553743"
  fixed='true'
  autoplay='true'
  theme='#42b983'
  loop='all'
  order='random'
  preload='auto'
  volume='0.7'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    

    <!-- å›¾ç‰‡æ”¾å¤§ -->
    
      <script src="/js/fancybox/jquery.fancybox.min.js"></script>
    

    <!-- ç™¾åº¦è§£æ -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- èƒŒæ™¯å½©å¸¦ -->
    
      <script type="text/javascript" size="100" alpha='0.4' zIndex="-1" src="/js/ribbon.min.js"></script>
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js" data-pjax></script>
    
    <!-- æ–‡ç« ç›®å½•æ‰€éœ€js -->
<link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script>

<script>
  var headerEl = 'h1, h2, h3, h4, h5, h6',  //headers 
    content = '.post-detail',//æ–‡ç« å®¹å™¨
    idArr = {};  //æ ‡é¢˜æ•°ç»„ä»¥ç¡®å®šæ˜¯å¦å¢åŠ ç´¢å¼•id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -80,
    headingsOffset: -($(window).height() * 0.4 - 45),
    positionFixedSelector: '.toc-main',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //å»é™¤ç©ºæ ¼ä»¥åŠå¤šä½™æ ‡ç‚¹
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\ï¼š|\ï¼Œ|\ã€‚]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //idå·²ç»å­˜åœ¨
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //idæœªå­˜åœ¨
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 100) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // æ‰‹æœºç«¯tocæŒ‰é’®ç‚¹å‡»å‡ºç°ç›®å½•
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('toc-aside')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // å°äº992pxçš„æ—¶å€™
        mobileToc.close()
      }
    })
  }
</script>

<style>
  .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  }
</style> 

<!-- æ¸²æŸ“issuesæ ‡ç­¾é‡Œçš„å†…å®¹ -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- è¾“å…¥æ¡†æ‰“å­—ç‰¹æ•ˆ -->
<!-- è¾“å…¥æ¡†æ‰“å­—ç‰¹æ•ˆ -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // æ‰“å¼€éšæœºé¢œè‰²ç‰¹æ•ˆ
    POWERMODE.shake = false;    // å…³é—­è¾“å…¥æ¡†æŠ–åŠ¨
    document.body.addEventListener('input', POWERMODE);//ç›‘å¬æ‰“å­—äº‹ä»¶
  </script>


<!-- markdownä»£ç ä¸€é”®å¤åˆ¶åŠŸèƒ½ -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.css">
  <script src="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = 'å¤åˆ¶';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "æˆåŠŸ",
            content: "ä»£ç å·²å¤åˆ¶ï¼Œè¯·éµå®ˆç›¸å…³æˆæƒåè®®ã€‚",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- å›¾ç‰‡æ‡’åŠ è½½ -->
<script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- å¡ç‰‡æ»šåŠ¨åŠ¨ç”» -->
   

<!-- è¯„è®ºæ‰€éœ€js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = 'github-dark';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // åŒ¿åå‡½æ•°ï¼Œé˜²æ­¢æ±¡æŸ“å…¨å±€å˜é‡
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', '')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content æ˜¯è¦æ’å…¥è¯„è®ºçš„åœ°æ–¹
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ -->
<!-- çˆ±å¿ƒç‚¹å‡» -->

  
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 999; pointer-events: none;" ></canvas>
    <script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script src="/js/cursor/explosion.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- æ ·å¼ä½äºï¼šsource/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // æ‹¦æˆªæ­£å¸¸å¸¦é“¾æ¥çš„ a æ ‡ç­¾
      selectors: ["#pjax-container","title"],                                   // æ ¹æ®å®é™…éœ€è¦ç¡®è®¤é‡è½½åŒºåŸŸ
      cacheBust: false,   // url åœ°å€è¿½åŠ æ—¶é—´æˆ³ï¼Œç”¨ä»¥é¿å…æµè§ˆå™¨ç¼“å­˜
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // åˆ·æ–°ä¸ä»é¡¶éƒ¨å¼€å§‹
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>